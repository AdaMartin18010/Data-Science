# PostgreSQLæ‰©å±•ï¼šçŸ¥è¯†å›¾è°±æ•°æ®åº“ï¼ˆApache AGEï¼‰å½¢å¼åŒ–ç†è®ºåˆ†æ

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-01-15
> **ç‰ˆæœ¬**ï¼šv1.0
> **çŠ¶æ€**ï¼šè¿›è¡Œä¸­

---

## ğŸ“‹ ç›®å½•

- [PostgreSQLæ‰©å±•ï¼šçŸ¥è¯†å›¾è°±æ•°æ®åº“ï¼ˆApache AGEï¼‰å½¢å¼åŒ–ç†è®ºåˆ†æ](#postgresqlæ‰©å±•çŸ¥è¯†å›¾è°±æ•°æ®åº“apache-ageå½¢å¼åŒ–ç†è®ºåˆ†æ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1. Apache AGEç®€ä»‹](#11-apache-ageç®€ä»‹)
    - [1.2. çŸ¥è¯†å›¾è°±æ•°æ®åº“çš„é‡è¦æ€§](#12-çŸ¥è¯†å›¾è°±æ•°æ®åº“çš„é‡è¦æ€§)
    - [1.3. Apache AGEåœ¨PostgreSQLä¸­çš„ä½ç½®](#13-apache-ageåœ¨postgresqlä¸­çš„ä½ç½®)
  - [2. Apache AGEçš„å½¢å¼åŒ–å®šä¹‰](#2-apache-ageçš„å½¢å¼åŒ–å®šä¹‰)
    - [2.1. Apache AGEæ¶æ„çš„å½¢å¼åŒ–å®šä¹‰](#21-apache-ageæ¶æ„çš„å½¢å¼åŒ–å®šä¹‰)
      - [2.1.1. AGEå›¾æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰](#211-ageå›¾æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰)
      - [2.1.2. AGEå­˜å‚¨æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰](#212-ageå­˜å‚¨æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰)
      - [2.1.3. AGEæŸ¥è¯¢æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰](#213-ageæŸ¥è¯¢æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰)
    - [2.2. CypheræŸ¥è¯¢è¯­è¨€çš„å½¢å¼åŒ–è¯­ä¹‰](#22-cypheræŸ¥è¯¢è¯­è¨€çš„å½¢å¼åŒ–è¯­ä¹‰)
      - [2.2.1. Cypherè¯­æ³•çš„å½¢å¼åŒ–å®šä¹‰](#221-cypherè¯­æ³•çš„å½¢å¼åŒ–å®šä¹‰)
      - [2.2.2. Cypherè¯­ä¹‰çš„å½¢å¼åŒ–å®šä¹‰](#222-cypherè¯­ä¹‰çš„å½¢å¼åŒ–å®šä¹‰)
      - [2.2.3. CypheræŸ¥è¯¢ä¼˜åŒ–çš„å½¢å¼åŒ–å®šä¹‰](#223-cypheræŸ¥è¯¢ä¼˜åŒ–çš„å½¢å¼åŒ–å®šä¹‰)
    - [2.3. Apache AGEæ€§è´¨çš„å½¢å¼åŒ–è¯æ˜](#23-apache-ageæ€§è´¨çš„å½¢å¼åŒ–è¯æ˜)
      - [2.3.1. AGEå›¾æ“ä½œçš„æ€§è´¨](#231-ageå›¾æ“ä½œçš„æ€§è´¨)
      - [2.3.2. AGEæŸ¥è¯¢çš„æ€§è´¨](#232-ageæŸ¥è¯¢çš„æ€§è´¨)
      - [2.3.3. AGEäº‹åŠ¡çš„æ€§è´¨](#233-ageäº‹åŠ¡çš„æ€§è´¨)
  - [3. å›¾æŸ¥è¯¢ä¼˜åŒ–çš„å½¢å¼åŒ–ç†è®º](#3-å›¾æŸ¥è¯¢ä¼˜åŒ–çš„å½¢å¼åŒ–ç†è®º)
    - [3.1. å›¾æ¨¡å¼åŒ¹é…çš„å½¢å¼åŒ–å®šä¹‰](#31-å›¾æ¨¡å¼åŒ¹é…çš„å½¢å¼åŒ–å®šä¹‰)
    - [3.2. å›¾æŸ¥è¯¢ä¼˜åŒ–çš„å½¢å¼åŒ–å®šä¹‰](#32-å›¾æŸ¥è¯¢ä¼˜åŒ–çš„å½¢å¼åŒ–å®šä¹‰)
    - [3.3. å›¾ç´¢å¼•çš„å½¢å¼åŒ–å®šä¹‰](#33-å›¾ç´¢å¼•çš„å½¢å¼åŒ–å®šä¹‰)
  - [4. Apache AGEä¸å…¶ä»–å›¾æ•°æ®åº“çš„å¯¹æ¯”](#4-apache-ageä¸å…¶ä»–å›¾æ•°æ®åº“çš„å¯¹æ¯”)
    - [4.1. åŠŸèƒ½å¯¹æ¯”çŸ©é˜µ](#41-åŠŸèƒ½å¯¹æ¯”çŸ©é˜µ)
    - [4.2. æ€§èƒ½å¯¹æ¯”çŸ©é˜µ](#42-æ€§èƒ½å¯¹æ¯”çŸ©é˜µ)
    - [4.3. PostgreSQLçŸ¥è¯†å›¾è°±æ•°æ®åº“é€‰æ‹©å†³ç­–æ ‘](#43-postgresqlçŸ¥è¯†å›¾è°±æ•°æ®åº“é€‰æ‹©å†³ç­–æ ‘)
  - [5. åº”ç”¨åœºæ™¯çš„å½¢å¼åŒ–åˆ†æ](#5-åº”ç”¨åœºæ™¯çš„å½¢å¼åŒ–åˆ†æ)
    - [5.1. çŸ¥è¯†æ¨ç†çš„å½¢å¼åŒ–å®šä¹‰](#51-çŸ¥è¯†æ¨ç†çš„å½¢å¼åŒ–å®šä¹‰)
    - [5.2. å…³ç³»åˆ†æçš„å½¢å¼åŒ–å®šä¹‰](#52-å…³ç³»åˆ†æçš„å½¢å¼åŒ–å®šä¹‰)
    - [5.3. è·¯å¾„æŸ¥è¯¢çš„å½¢å¼åŒ–å®šä¹‰](#53-è·¯å¾„æŸ¥è¯¢çš„å½¢å¼åŒ–å®šä¹‰)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)
    - [6.1. ç»å…¸æ–‡çŒ®](#61-ç»å…¸æ–‡çŒ®)
    - [6.2. ç›¸å…³èµ„æº](#62-ç›¸å…³èµ„æº)

---

## 1. æ¦‚è¿°

### 1.1. Apache AGEç®€ä»‹

Apache AGEæ˜¯PostgreSQLçš„å›¾æ•°æ®åº“æ‰©å±•ï¼Œæä¾›ï¼š

- **CypheræŸ¥è¯¢è¯­è¨€**ï¼šNeo4jå…¼å®¹çš„å›¾æŸ¥è¯¢è¯­è¨€
- **å›¾æ•°æ®æ¨¡å‹**ï¼šèŠ‚ç‚¹å’Œè¾¹çš„å±æ€§å›¾æ¨¡å‹
- **PostgreSQLé›†æˆ**ï¼šä¸PostgreSQLå…³ç³»æ¨¡å‹æ— ç¼é›†æˆ
- **ACIDäº‹åŠ¡**ï¼šå®Œæ•´çš„ACIDäº‹åŠ¡æ”¯æŒ

### 1.2. çŸ¥è¯†å›¾è°±æ•°æ®åº“çš„é‡è¦æ€§

çŸ¥è¯†å›¾è°±æ•°æ®åº“åœ¨ç°ä»£åº”ç”¨ä¸­è‡³å…³é‡è¦ï¼š

1. **çŸ¥è¯†æ¨ç†**ï¼šåŸºäºå›¾ç»“æ„çš„é€»è¾‘æ¨ç†
2. **å…³ç³»åˆ†æ**ï¼šå¤æ‚å…³ç³»çš„åˆ†æå’ŒæŸ¥è¯¢
3. **è·¯å¾„æŸ¥è¯¢**ï¼šå¤šè·³è·¯å¾„æŸ¥è¯¢å’Œåˆ†æ
4. **è¯­ä¹‰æœç´¢**ï¼šåŸºäºå›¾ç»“æ„çš„è¯­ä¹‰æœç´¢

### 1.3. Apache AGEåœ¨PostgreSQLä¸­çš„ä½ç½®

Apache AGEæ‰©å±•äº†PostgreSQLçš„å¤šæ¨¡å‹èƒ½åŠ›ï¼š

- **å…³ç³»æ¨¡å‹**ï¼šPostgreSQLåŸç”Ÿæ”¯æŒ
- **å›¾æ¨¡å‹**ï¼šApache AGEæ‰©å±•æ”¯æŒ
- **å‘é‡æ¨¡å‹**ï¼špgvectoræ‰©å±•æ”¯æŒ
- **æ–‡æ¡£æ¨¡å‹**ï¼šJSONBæ‰©å±•æ”¯æŒ

---

## 2. Apache AGEçš„å½¢å¼åŒ–å®šä¹‰

### 2.1. Apache AGEæ¶æ„çš„å½¢å¼åŒ–å®šä¹‰

#### 2.1.1. AGEå›¾æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.1.1ï¼ˆAGEå±æ€§å›¾ï¼‰**ï¼š

Apache AGEçš„å±æ€§å›¾ G_age æ˜¯ä¸€ä¸ªäº”å…ƒç»„ (V, E, L_V, L_E, A)ï¼Œå…¶ä¸­ï¼š

- **V**ï¼šèŠ‚ç‚¹é›†åˆï¼ˆVerticesï¼‰ï¼ŒV = {vâ‚, vâ‚‚, ..., vâ‚™}
- **E**ï¼šè¾¹é›†åˆï¼ˆEdgesï¼‰ï¼ŒE = {eâ‚, eâ‚‚, ..., eâ‚˜}
- **L_V: V â†’ LabelSet**ï¼šèŠ‚ç‚¹æ ‡ç­¾å‡½æ•°
- **L_E: E â†’ LabelSet**ï¼šè¾¹æ ‡ç­¾å‡½æ•°
- **A: (V âˆª E) â†’ AttributeMap**ï¼šå±æ€§å‡½æ•°

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
G_age = (V, E, L_V, L_E, A)
å…¶ä¸­ï¼š
  V = {vâ‚, vâ‚‚, ..., vâ‚™}  ï¼ˆèŠ‚ç‚¹é›†åˆï¼‰
  E = {eâ‚, eâ‚‚, ..., eâ‚˜}  ï¼ˆè¾¹é›†åˆï¼‰
  L_V: V â†’ LabelSet       ï¼ˆèŠ‚ç‚¹æ ‡ç­¾å‡½æ•°ï¼‰
  L_E: E â†’ LabelSet       ï¼ˆè¾¹æ ‡ç­¾å‡½æ•°ï¼‰
  A: (V âˆª E) â†’ AttributeMap  ï¼ˆå±æ€§å‡½æ•°ï¼‰
```

**AGEå›¾çš„æ€§è´¨**ï¼š

**æ€§è´¨2.1.1ï¼ˆAGEå›¾çš„æœ‰å‘æ€§ï¼‰**ï¼š

AGEå›¾æ˜¯æœ‰å‘å›¾ï¼Œè¾¹æœ‰æ–¹å‘ã€‚

**å½¢å¼åŒ–**ï¼š

```text
æœ‰å‘æ€§ âŸº âˆ€e âˆˆ E. e = (v_s, v_t), v_s â‰  v_t
```

**æ€§è´¨2.1.2ï¼ˆAGEå›¾çš„å¤šé‡æ€§ï¼‰**ï¼š

AGEå›¾å…è®¸å¤šé‡è¾¹ï¼Œä¸¤ä¸ªèŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªä¸åŒçš„è¾¹ã€‚

**å½¢å¼åŒ–**ï¼š

```text
å¤šé‡æ€§ âŸº âˆƒvâ‚, vâ‚‚ âˆˆ V. |{e âˆˆ E | e = (vâ‚, vâ‚‚)}| > 1
```

#### 2.1.2. AGEå­˜å‚¨æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.1.2ï¼ˆAGEå­˜å‚¨æ¨¡å‹ï¼‰**ï¼š

Apache AGEå°†å›¾æ•°æ®å­˜å‚¨åœ¨PostgreSQLå…³ç³»è¡¨ä¸­ï¼š

1. **èŠ‚ç‚¹è¡¨**ï¼š`ag_catalog.ag_vertex`

   ```text
   ag_vertex = (graphid, label, properties)
   ```

2. **è¾¹è¡¨**ï¼š`ag_catalog.ag_edge`

   ```text
   ag_edge = (graphid, start_vertex, end_vertex, label, properties)
   ```

**å½¢å¼åŒ–æ˜ å°„**ï¼š

**å®šä¹‰2.1.3ï¼ˆå›¾åˆ°å…³ç³»çš„æ˜ å°„ï¼‰**ï¼š

å›¾ G_age = (V, E, L_V, L_E, A) æ˜ å°„åˆ°å…³ç³»è¡¨ï¼š

```text
æ˜ å°„(G_age) = {
    ag_vertex: {(id(v), L_V(v), A(v)) | v âˆˆ V},
    ag_edge: {(id(e), start(e), end(e), L_E(e), A(e)) | e âˆˆ E}
}
```

#### 2.1.3. AGEæŸ¥è¯¢æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.1.4ï¼ˆAGEæŸ¥è¯¢æ¨¡å‹ï¼‰**ï¼š

Apache AGEæŸ¥è¯¢æ¨¡å‹æ”¯æŒï¼š

1. **CypheræŸ¥è¯¢**ï¼šä½¿ç”¨Cypherè¯­æ³•
2. **SQLæŸ¥è¯¢**ï¼šä½¿ç”¨æ ‡å‡†SQLæŸ¥è¯¢å›¾æ•°æ®
3. **æ··åˆæŸ¥è¯¢**ï¼šç»“åˆCypherå’ŒSQL

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
AGEæŸ¥è¯¢ = CypheræŸ¥è¯¢ | SQLæŸ¥è¯¢ | æ··åˆæŸ¥è¯¢
```

### 2.2. CypheræŸ¥è¯¢è¯­è¨€çš„å½¢å¼åŒ–è¯­ä¹‰

#### 2.2.1. Cypherè¯­æ³•çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.2.1ï¼ˆCypherè¯­æ³•ï¼‰**ï¼š

Cypherè¯­æ³•å®šä¹‰å¦‚ä¸‹ï¼ˆBNFå½¢å¼ï¼‰ï¼š

```text
Query ::= MatchClause [WhereClause] [ReturnClause]
MatchClause ::= MATCH Pattern
Pattern ::= NodePattern [EdgePattern NodePattern]*
NodePattern ::= (Variable [Label] [Properties])
EdgePattern ::= -[Variable [Label] [Properties]]->
WhereClause ::= WHERE Condition
ReturnClause ::= RETURN ProjectionList
```

**è¯­æ³•å…ƒç´ è¯´æ˜**ï¼š

- **MATCH**ï¼šæ¨¡å¼åŒ¹é…
- **WHERE**ï¼šè¿‡æ»¤æ¡ä»¶
- **RETURN**ï¼šè¿”å›ç»“æœ

#### 2.2.2. Cypherè¯­ä¹‰çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.2.2ï¼ˆCypherè¯­ä¹‰ï¼‰**ï¼š

CypheræŸ¥è¯¢çš„è¯­ä¹‰å®šä¹‰ä¸ºï¼š

```text
[[CypherQuery]]_G = {
    binding | binding âˆˆ Match(Pattern, G) âˆ§
              Satisfies(WhereClause, binding)
}
```

å…¶ä¸­ï¼š

- **Match**ï¼šæ¨¡å¼åŒ¹é…å‡½æ•°
- **Satisfies**ï¼šæ¡ä»¶æ»¡è¶³å‡½æ•°

**æ¨¡å¼åŒ¹é…çš„å½¢å¼åŒ–å®šä¹‰**ï¼š

**å®šä¹‰2.2.3ï¼ˆæ¨¡å¼åŒ¹é…ï¼‰**ï¼š

æ¨¡å¼åŒ¹é… Match(Pattern, G) è¿”å›æ‰€æœ‰æ»¡è¶³æ¨¡å¼çš„ç»‘å®šï¼š

```text
Match(Pattern, G) = {
    binding | binding: Variables â†’ (V âˆª E),
              Pattern(binding) âŠ† G
}
```

#### 2.2.3. CypheræŸ¥è¯¢ä¼˜åŒ–çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.2.4ï¼ˆCypheræŸ¥è¯¢ä¼˜åŒ–ï¼‰**ï¼š

CypheræŸ¥è¯¢ä¼˜åŒ–æ˜¯å°†æŸ¥è¯¢è½¬æ¢ä¸ºé«˜æ•ˆçš„æ‰§è¡Œè®¡åˆ’ï¼š

```text
ä¼˜åŒ–(CypherQuery) = æ‰§è¡Œè®¡åˆ’
```

**ä¼˜åŒ–ç­–ç•¥**ï¼š

1. **æ¨¡å¼åŒ¹é…é¡ºåºä¼˜åŒ–**ï¼šé€‰æ‹©æœ€ä¼˜çš„åŒ¹é…é¡ºåº
2. **ç´¢å¼•ä½¿ç”¨ä¼˜åŒ–**ï¼šåˆ©ç”¨ç´¢å¼•åŠ é€ŸæŸ¥è¯¢
3. **è¿æ¥é¡ºåºä¼˜åŒ–**ï¼šä¼˜åŒ–å¤šæ¨¡å¼è¿æ¥çš„é¡ºåº

### 2.3. Apache AGEæ€§è´¨çš„å½¢å¼åŒ–è¯æ˜

#### 2.3.1. AGEå›¾æ“ä½œçš„æ€§è´¨

**æ€§è´¨2.3.1ï¼ˆå›¾æ“ä½œçš„åŸå­æ€§ï¼‰**ï¼š

AGEå›¾æ“ä½œæ˜¯åŸå­çš„ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚

**å½¢å¼åŒ–**ï¼š

```text
åŸå­æ€§ âŸº
  âˆ€æ“ä½œop.
    (æˆåŠŸ(op) â†’ æ‰€æœ‰å­æ“ä½œæˆåŠŸ) âˆ§
    (å¤±è´¥(op) â†’ æ‰€æœ‰å­æ“ä½œå›æ»š)
```

**æ€§è´¨2.3.2ï¼ˆå›¾æ“ä½œçš„ä¸€è‡´æ€§ï¼‰**ï¼š

AGEå›¾æ“ä½œä¿æŒå›¾çš„ä¸€è‡´æ€§çº¦æŸã€‚

**å½¢å¼åŒ–**ï¼š

```text
ä¸€è‡´æ€§ âŸº
  âˆ€æ“ä½œop.
    Invariant(G) â†’ Invariant(op(G))
```

#### 2.3.2. AGEæŸ¥è¯¢çš„æ€§è´¨

**æ€§è´¨2.3.3ï¼ˆæŸ¥è¯¢çš„ç¡®å®šæ€§ï¼‰**ï¼š

AGEæŸ¥è¯¢æ˜¯ç¡®å®šæ€§çš„ï¼Œç›¸åŒæŸ¥è¯¢åœ¨ç›¸åŒå›¾ä¸Šäº§ç”Ÿç›¸åŒç»“æœã€‚

**å½¢å¼åŒ–**ï¼š

```text
ç¡®å®šæ€§ âŸº
  âˆ€æŸ¥è¯¢q, å›¾G.
    [[q]]_G = [[q]]_G
```

#### 2.3.3. AGEäº‹åŠ¡çš„æ€§è´¨

**æ€§è´¨2.3.4ï¼ˆäº‹åŠ¡çš„ACIDæ€§è´¨ï¼‰**ï¼š

AGEäº‹åŠ¡æ»¡è¶³ACIDæ€§è´¨ï¼Œç»§æ‰¿è‡ªPostgreSQLã€‚

**å½¢å¼åŒ–**ï¼š

```text
ACID âŸº
  åŸå­æ€§(AGEäº‹åŠ¡) âˆ§
  ä¸€è‡´æ€§(AGEäº‹åŠ¡) âˆ§
  éš”ç¦»æ€§(AGEäº‹åŠ¡) âˆ§
  æŒä¹…æ€§(AGEäº‹åŠ¡)
```

---

## 3. å›¾æŸ¥è¯¢ä¼˜åŒ–çš„å½¢å¼åŒ–ç†è®º

### 3.1. å›¾æ¨¡å¼åŒ¹é…çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰3.1.1ï¼ˆå›¾æ¨¡å¼åŒ¹é…ï¼‰**ï¼š

å›¾æ¨¡å¼åŒ¹é…æ˜¯åœ¨å›¾ä¸­æ‰¾åˆ°æ‰€æœ‰æ»¡è¶³æ¨¡å¼çš„å­å›¾ï¼š

```text
æ¨¡å¼åŒ¹é…(Pattern, G) = {
    subgraph | subgraph âŠ† G âˆ§
                subgraph åŒæ„äº Pattern
}
```

**æ¨¡å¼åŒ¹é…ç®—æ³•**ï¼š

**ç®—æ³•3.1.1ï¼šå›¾æ¨¡å¼åŒ¹é…ç®—æ³•**

```python
def pattern_match(pattern, graph):
    """
    å›¾æ¨¡å¼åŒ¹é…ç®—æ³•

    å‚æ•°:
        pattern: å›¾æ¨¡å¼
        graph: å›¾æ•°æ®

    è¿”å›:
        æ‰€æœ‰æ»¡è¶³æ¨¡å¼çš„å­å›¾
    """
    # æ­¥éª¤1ï¼šæ‰¾åˆ°åŒ¹é…çš„èµ·å§‹èŠ‚ç‚¹
    start_nodes = find_start_nodes(pattern, graph)

    # æ­¥éª¤2ï¼šä»æ¯ä¸ªèµ·å§‹èŠ‚ç‚¹å¼€å§‹åŒ¹é…
    results = []
    for start_node in start_nodes:
        matches = match_from_node(pattern, start_node, graph)
        results.extend(matches)

    return results

def match_from_node(pattern, start_node, graph):
    """ä»ç»™å®šèŠ‚ç‚¹å¼€å§‹åŒ¹é…æ¨¡å¼"""
    # ä½¿ç”¨å›æº¯ç®—æ³•åŒ¹é…æ¨¡å¼
    matches = []
    backtrack(pattern, start_node, {}, graph, matches)
    return matches

def backtrack(pattern, current_node, binding, graph, matches):
    """å›æº¯ç®—æ³•åŒ¹é…æ¨¡å¼"""
    if complete_match(binding, pattern):
        matches.append(binding.copy())
        return

    # æ‰¾åˆ°ä¸‹ä¸€ä¸ªè¦åŒ¹é…çš„æ¨¡å¼èŠ‚ç‚¹
    next_pattern_node = find_next_pattern_node(pattern, binding)

    # æ‰¾åˆ°å€™é€‰èŠ‚ç‚¹
    candidates = find_candidates(next_pattern_node, current_node, graph)

    for candidate in candidates:
        if is_valid_binding(binding, next_pattern_node, candidate):
            binding[next_pattern_node] = candidate
            backtrack(pattern, candidate, binding, graph, matches)
            binding.pop(next_pattern_node)
```

### 3.2. å›¾æŸ¥è¯¢ä¼˜åŒ–çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰3.2.1ï¼ˆå›¾æŸ¥è¯¢ä¼˜åŒ–ï¼‰**ï¼š

å›¾æŸ¥è¯¢ä¼˜åŒ–æ˜¯å°†å›¾æŸ¥è¯¢è½¬æ¢ä¸ºé«˜æ•ˆçš„æ‰§è¡Œè®¡åˆ’ï¼š

```text
ä¼˜åŒ–(GraphQuery) = æ‰§è¡Œè®¡åˆ’
```

**ä¼˜åŒ–ç›®æ ‡**ï¼š

1. **æœ€å°åŒ–æŸ¥è¯¢æ—¶é—´**
2. **æœ€å°åŒ–å†…å­˜å ç”¨**
3. **æœ€å¤§åŒ–å¹¶è¡Œåº¦**

**ä¼˜åŒ–ç­–ç•¥**ï¼š

**ç­–ç•¥1ï¼šæ¨¡å¼åŒ¹é…é¡ºåºä¼˜åŒ–**

é€‰æ‹©æœ€ä¼˜çš„æ¨¡å¼åŒ¹é…é¡ºåºï¼Œå‡å°‘æœç´¢ç©ºé—´ã€‚

**ç­–ç•¥2ï¼šç´¢å¼•ä½¿ç”¨ä¼˜åŒ–**

åˆ©ç”¨èŠ‚ç‚¹å’Œè¾¹çš„ç´¢å¼•åŠ é€ŸæŸ¥è¯¢ã€‚

**ç­–ç•¥3ï¼šè¿æ¥é¡ºåºä¼˜åŒ–**

ä¼˜åŒ–å¤šä¸ªæ¨¡å¼è¿æ¥çš„é¡ºåºã€‚

### 3.3. å›¾ç´¢å¼•çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰3.3.1ï¼ˆå›¾ç´¢å¼•ï¼‰**ï¼š

å›¾ç´¢å¼• I æ˜¯ä¸€ä¸ªæ˜ å°„å‡½æ•°ï¼š

```text
I: IndexKey â†’ EntitySet
```

å…¶ä¸­ EntitySet æ˜¯èŠ‚ç‚¹æˆ–è¾¹çš„é›†åˆã€‚

**ç´¢å¼•ç±»å‹**ï¼š

1. **èŠ‚ç‚¹æ ‡ç­¾ç´¢å¼•**ï¼šæŒ‰æ ‡ç­¾ç´¢å¼•èŠ‚ç‚¹
2. **è¾¹ç±»å‹ç´¢å¼•**ï¼šæŒ‰ç±»å‹ç´¢å¼•è¾¹
3. **å±æ€§ç´¢å¼•**ï¼šæŒ‰å±æ€§å€¼ç´¢å¼•å®ä½“
4. **è·¯å¾„ç´¢å¼•**ï¼šé¢„è®¡ç®—å¸¸ç”¨è·¯å¾„

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
èŠ‚ç‚¹æ ‡ç­¾ç´¢å¼•: Label â†’ NodeSet
è¾¹ç±»å‹ç´¢å¼•: EdgeType â†’ EdgeSet
å±æ€§ç´¢å¼•: (AttributeName, Value) â†’ EntitySet
è·¯å¾„ç´¢å¼•: PathPattern â†’ PathSet
```

---

## 4. Apache AGEä¸å…¶ä»–å›¾æ•°æ®åº“çš„å¯¹æ¯”

### 4.1. åŠŸèƒ½å¯¹æ¯”çŸ©é˜µ

| åŠŸèƒ½ | Apache AGE | Neo4j | ArangoDB | Amazon Neptune | TigerGraph |
|------|-----------|-------|----------|----------------|------------|
| **CypheræŸ¥è¯¢** | âœ… | âœ… | âŒ | âœ… | âŒ |
| **SQLæŸ¥è¯¢** | âœ… | âŒ | âœ… | âŒ | âŒ |
| **ACIDäº‹åŠ¡** | âœ… | âœ… | âœ… | âœ… | âœ… |
| **PostgreSQLé›†æˆ** | âœ… | âŒ | âŒ | âŒ | âŒ |
| **åˆ†å¸ƒå¼** | âœ… | âœ… | âœ… | âœ… | âœ… |
| **å›¾ç®—æ³•** | âš ï¸ | âœ… | âœ… | âœ… | âœ… |
| **å¯è§†åŒ–** | âš ï¸ | âœ… | âœ… | âœ… | âœ… |

### 4.2. æ€§èƒ½å¯¹æ¯”çŸ©é˜µ

| æ€§èƒ½æŒ‡æ ‡ | Apache AGE | Neo4j | ArangoDB | Amazon Neptune | TigerGraph |
|---------|-----------|-------|----------|----------------|------------|
| **æŸ¥è¯¢å»¶è¿Ÿ** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| **ååé‡** | â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| **å¯æ‰©å±•æ€§** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| **PostgreSQLé›†æˆ** | â­â­â­â­â­ | â­ | â­ | â­ | â­ |

### 4.3. PostgreSQLçŸ¥è¯†å›¾è°±æ•°æ®åº“é€‰æ‹©å†³ç­–æ ‘

```mermaid
flowchart TD
    A[é€‰æ‹©çŸ¥è¯†å›¾è°±æ•°æ®åº“] --> B{éœ€è¦PostgreSQLé›†æˆ?}
    B -->|æ˜¯| C[Apache AGE âœ…]
    B -->|å¦| D{æŸ¥è¯¢è¯­è¨€}

    D -->|Cypher| E{éƒ¨ç½²æ–¹å¼}
    D -->|Gremlin| F[Amazon Neptune]
    D -->|AQL| G[ArangoDB]

    E -->|è‡ªæ‰˜ç®¡| H[Neo4j]
    E -->|æ‰˜ç®¡| I[Neo4j Aura]

    C --> J{æ€§èƒ½è¦æ±‚}
    H --> J
    I --> J
    F --> J
    G --> J

    J -->|æé«˜| K[Neo4j/TigerGraph]
    J -->|é«˜| L[Apache AGE/ArangoDB]
    J -->|ä¸­ç­‰| C

    K --> M[éªŒè¯åŠŸèƒ½éœ€æ±‚]
    L --> M
    C --> M

    M --> N{åŠŸèƒ½æ»¡è¶³?}
    N -->|æ˜¯| O[çŸ¥è¯†å›¾è°±æ•°æ®åº“é€‰æ‹©å®Œæˆ âœ…]
    N -->|å¦| P[è°ƒæ•´é€‰æ‹©]
    P --> B
```

---

## 5. åº”ç”¨åœºæ™¯çš„å½¢å¼åŒ–åˆ†æ

### 5.1. çŸ¥è¯†æ¨ç†çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰5.1.1ï¼ˆçŸ¥è¯†æ¨ç†ï¼‰**ï¼š

çŸ¥è¯†æ¨ç†æ˜¯åŸºäºå›¾ç»“æ„çš„é€»è¾‘æ¨ç†ï¼š

```text
æ¨ç†(è§„åˆ™é›†, çŸ¥è¯†å›¾è°±) = æ–°çŸ¥è¯†
```

**æ¨ç†è§„åˆ™çš„å½¢å¼åŒ–å®šä¹‰**ï¼š

**å®šä¹‰5.1.2ï¼ˆæ¨ç†è§„åˆ™ï¼‰**ï¼š

æ¨ç†è§„åˆ™ Rule æ˜¯ä¸€ä¸ªä¸‰å…ƒç»„ (å‰æ, ç»“è®º, æ¡ä»¶)ï¼š

```text
Rule = (Premise, Conclusion, Condition)
å…¶ä¸­ï¼š
  Premise: å›¾æ¨¡å¼ï¼ˆå‰ææ¨¡å¼ï¼‰
  Conclusion: å›¾æ¨¡å¼ï¼ˆç»“è®ºæ¨¡å¼ï¼‰
  Condition: æ¡ä»¶ï¼ˆå¯é€‰ï¼‰
```

**æ¨ç†çš„å½¢å¼åŒ–å®šä¹‰**ï¼š

**å®šä¹‰5.1.3ï¼ˆæ¨ç†è¿‡ç¨‹ï¼‰**ï¼š

æ¨ç†è¿‡ç¨‹æ˜¯åœ¨çŸ¥è¯†å›¾è°±ä¸­åº”ç”¨æ¨ç†è§„åˆ™ï¼š

```text
æ¨ç†(Rules, KG) =
    KG âˆª {æ–°ä¸‰å…ƒç»„ | è§„åˆ™ âˆˆ Rules,
                    åŒ¹é…(è§„åˆ™.å‰æ, KG),
                    æ»¡è¶³(è§„åˆ™.æ¡ä»¶),
                    æ–°ä¸‰å…ƒç»„ = åº”ç”¨(è§„åˆ™.ç»“è®º)}
```

### 5.2. å…³ç³»åˆ†æçš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰5.2.1ï¼ˆå…³ç³»åˆ†æï¼‰**ï¼š

å…³ç³»åˆ†ææ˜¯åˆ†æå›¾ä¸­å®ä½“é—´çš„å…³ç³»ï¼š

```text
å…³ç³»åˆ†æ(å®ä½“1, å®ä½“2, KG) = {
    è·¯å¾„ | è·¯å¾„è¿æ¥(å®ä½“1, å®ä½“2, KG)
}
```

**è·¯å¾„æŸ¥è¯¢çš„å½¢å¼åŒ–å®šä¹‰**ï¼š

**å®šä¹‰5.2.2ï¼ˆè·¯å¾„æŸ¥è¯¢ï¼‰**ï¼š

è·¯å¾„æŸ¥è¯¢æ‰¾åˆ°è¿æ¥ä¸¤ä¸ªå®ä½“çš„æ‰€æœ‰è·¯å¾„ï¼š

```text
è·¯å¾„æŸ¥è¯¢(vâ‚, vâ‚‚, KG) = {
    è·¯å¾„ | è·¯å¾„ = (vâ‚, eâ‚, vâ‚‚, eâ‚‚, ..., vâ‚™, eâ‚™, vâ‚‚),
          âˆ€eáµ¢ âˆˆ è·¯å¾„. eáµ¢ âˆˆ E(KG)
}
```

### 5.3. è·¯å¾„æŸ¥è¯¢çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰5.3.1ï¼ˆè·¯å¾„æŸ¥è¯¢ï¼‰**ï¼š

è·¯å¾„æŸ¥è¯¢æ˜¯åœ¨å›¾ä¸­æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„è·¯å¾„ï¼š

```text
è·¯å¾„æŸ¥è¯¢(èµ·å§‹èŠ‚ç‚¹, ç»ˆæ­¢èŠ‚ç‚¹, è·¯å¾„æ¨¡å¼, KG) = {
    è·¯å¾„ | è·¯å¾„è¿æ¥(èµ·å§‹èŠ‚ç‚¹, ç»ˆæ­¢èŠ‚ç‚¹, KG),
          è·¯å¾„åŒ¹é…(è·¯å¾„æ¨¡å¼)
}
```

**è·¯å¾„æ¨¡å¼çš„å½¢å¼åŒ–å®šä¹‰**ï¼š

**å®šä¹‰5.3.2ï¼ˆè·¯å¾„æ¨¡å¼ï¼‰**ï¼š

è·¯å¾„æ¨¡å¼ PathPattern å®šä¹‰è·¯å¾„çš„ç»“æ„ï¼š

```text
PathPattern = NodePattern EdgePattern* NodePattern
```

**è·¯å¾„æŸ¥è¯¢ç®—æ³•**ï¼š

**ç®—æ³•5.3.1ï¼šè·¯å¾„æŸ¥è¯¢ç®—æ³•**

```python
def path_query(start_node, end_node, path_pattern, graph):
    """
    è·¯å¾„æŸ¥è¯¢ç®—æ³•

    å‚æ•°:
        start_node: èµ·å§‹èŠ‚ç‚¹
        end_node: ç»ˆæ­¢èŠ‚ç‚¹
        path_pattern: è·¯å¾„æ¨¡å¼
        graph: å›¾æ•°æ®

    è¿”å›:
        æ‰€æœ‰æ»¡è¶³æ¨¡å¼çš„è·¯å¾„
    """
    # ä½¿ç”¨æ·±åº¦ä¼˜å…ˆæœç´¢æˆ–å¹¿åº¦ä¼˜å…ˆæœç´¢
    paths = []
    dfs_path_search(start_node, end_node, path_pattern, graph, [], paths)
    return paths

def dfs_path_search(current, target, pattern, graph, path, results):
    """æ·±åº¦ä¼˜å…ˆæœç´¢è·¯å¾„"""
    if current == target and matches_pattern(path, pattern):
        results.append(path.copy())
        return

    if len(path) > max_depth(pattern):
        return

    # æ¢ç´¢é‚»å±…èŠ‚ç‚¹
    for edge, neighbor in graph.neighbors(current):
        if edge not in path and matches_pattern_so_far(path + [edge], pattern):
            path.append(edge)
            dfs_path_search(neighbor, target, pattern, graph, path, results)
            path.pop()
```

---

## 6. å‚è€ƒèµ„æ–™

### 6.1. ç»å…¸æ–‡çŒ®

- Apache AGEå®˜æ–¹æ–‡æ¡£ï¼š<https://age.apache.org/>
- CypheræŸ¥è¯¢è¯­è¨€è§„èŒƒï¼š<https://neo4j.com/docs/cypher-manual/>
- "Graph Databases" (Robinson et al., 2015)

### 6.2. ç›¸å…³èµ„æº

- [Apache AGE GitHub](https://github.com/apache/age)
- [CypheræŸ¥è¯¢è¯­è¨€](https://neo4j.com/developer/cypher/)
- [å›¾æ•°æ®åº“å¯¹æ¯”](https://db-engines.com/en/ranking/graph+dbms)

---

**æœ€åæ›´æ–°**ï¼š2025-01-15
**ç»´æŠ¤è€…**ï¼šData-Science Team
**çŠ¶æ€**ï¼šè¿›è¡Œä¸­
