# PostgreSQLæ‰©å±•ï¼šå¤šç§Ÿæˆ·æ•°æ®åº“ï¼ˆRLSï¼‰å½¢å¼åŒ–ç†è®ºåˆ†æ

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-01-15
> **ç‰ˆæœ¬**ï¼šv1.0
> **çŠ¶æ€**ï¼šè¿›è¡Œä¸­

---

## ğŸ“‹ ç›®å½•

- [PostgreSQLæ‰©å±•ï¼šå¤šç§Ÿæˆ·æ•°æ®åº“ï¼ˆRLSï¼‰å½¢å¼åŒ–ç†è®ºåˆ†æ](#postgresqlæ‰©å±•å¤šç§Ÿæˆ·æ•°æ®åº“rlså½¢å¼åŒ–ç†è®ºåˆ†æ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1. PostgreSQL RLSç®€ä»‹](#11-postgresql-rlsç®€ä»‹)
    - [1.2. å¤šç§Ÿæˆ·æ•°æ®åº“çš„é‡è¦æ€§](#12-å¤šç§Ÿæˆ·æ•°æ®åº“çš„é‡è¦æ€§)
    - [1.3. RLSåœ¨PostgreSQLä¸­çš„ä½ç½®](#13-rlsåœ¨postgresqlä¸­çš„ä½ç½®)
  - [2. å¤šç§Ÿæˆ·æ•°æ®åº“çš„å½¢å¼åŒ–å®šä¹‰](#2-å¤šç§Ÿæˆ·æ•°æ®åº“çš„å½¢å¼åŒ–å®šä¹‰)
    - [2.1. å¤šç§Ÿæˆ·æ•°æ®æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰](#21-å¤šç§Ÿæˆ·æ•°æ®æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰)
      - [2.1.1. ç§Ÿæˆ·çš„å½¢å¼åŒ–å®šä¹‰](#211-ç§Ÿæˆ·çš„å½¢å¼åŒ–å®šä¹‰)
      - [2.1.2. ç§Ÿæˆ·éš”ç¦»çš„å½¢å¼åŒ–å®šä¹‰](#212-ç§Ÿæˆ·éš”ç¦»çš„å½¢å¼åŒ–å®šä¹‰)
      - [2.1.3. å¤šç§Ÿæˆ·æ•°æ®åº“çš„å½¢å¼åŒ–å®šä¹‰](#213-å¤šç§Ÿæˆ·æ•°æ®åº“çš„å½¢å¼åŒ–å®šä¹‰)
    - [2.2. PostgreSQL RLSçš„å½¢å¼åŒ–è§„èŒƒ](#22-postgresql-rlsçš„å½¢å¼åŒ–è§„èŒƒ)
      - [2.2.1. RLSç­–ç•¥çš„å½¢å¼åŒ–å®šä¹‰](#221-rlsç­–ç•¥çš„å½¢å¼åŒ–å®šä¹‰)
      - [2.2.2. RLSç­–ç•¥ç±»å‹çš„å½¢å¼åŒ–å®šä¹‰](#222-rlsç­–ç•¥ç±»å‹çš„å½¢å¼åŒ–å®šä¹‰)
      - [2.2.3. RLSç­–ç•¥è¯„ä¼°çš„å½¢å¼åŒ–å®šä¹‰](#223-rlsç­–ç•¥è¯„ä¼°çš„å½¢å¼åŒ–å®šä¹‰)
    - [2.3. RLSæ€§è´¨çš„å½¢å¼åŒ–è¯æ˜](#23-rlsæ€§è´¨çš„å½¢å¼åŒ–è¯æ˜)
      - [2.3.1. RLSéš”ç¦»æ€§çš„å½¢å¼åŒ–è¯æ˜](#231-rlséš”ç¦»æ€§çš„å½¢å¼åŒ–è¯æ˜)
      - [2.3.2. RLSå®‰å…¨æ€§çš„å½¢å¼åŒ–è¯æ˜](#232-rlså®‰å…¨æ€§çš„å½¢å¼åŒ–è¯æ˜)
      - [2.3.3. RLSæ€§èƒ½çš„å½¢å¼åŒ–åˆ†æ](#233-rlsæ€§èƒ½çš„å½¢å¼åŒ–åˆ†æ)
  - [3. å¤šç§Ÿæˆ·æ¶æ„çš„å½¢å¼åŒ–ç†è®º](#3-å¤šç§Ÿæˆ·æ¶æ„çš„å½¢å¼åŒ–ç†è®º)
    - [3.1. å¤šç§Ÿæˆ·æ¶æ„æ¨¡å¼çš„å½¢å¼åŒ–å®šä¹‰](#31-å¤šç§Ÿæˆ·æ¶æ„æ¨¡å¼çš„å½¢å¼åŒ–å®šä¹‰)
      - [3.1.1. å…±äº«æ•°æ®åº“å…±äº«Schemaæ¨¡å¼](#311-å…±äº«æ•°æ®åº“å…±äº«schemaæ¨¡å¼)
      - [3.1.2. å…±äº«æ•°æ®åº“ç‹¬ç«‹Schemaæ¨¡å¼](#312-å…±äº«æ•°æ®åº“ç‹¬ç«‹schemaæ¨¡å¼)
      - [3.1.3. ç‹¬ç«‹æ•°æ®åº“æ¨¡å¼](#313-ç‹¬ç«‹æ•°æ®åº“æ¨¡å¼)
    - [3.2. å¤šç§Ÿæˆ·æ¶æ„é€‰æ‹©å†³ç­–æ ‘](#32-å¤šç§Ÿæˆ·æ¶æ„é€‰æ‹©å†³ç­–æ ‘)
    - [3.3. å¤šç§Ÿæˆ·æ¶æ„å¯¹æ¯”çŸ©é˜µ](#33-å¤šç§Ÿæˆ·æ¶æ„å¯¹æ¯”çŸ©é˜µ)
  - [4. PostgreSQL RLSä¸å…¶ä»–å¤šç§Ÿæˆ·æ–¹æ¡ˆçš„å¯¹æ¯”](#4-postgresql-rlsä¸å…¶ä»–å¤šç§Ÿæˆ·æ–¹æ¡ˆçš„å¯¹æ¯”)
    - [4.1. åŠŸèƒ½å¯¹æ¯”çŸ©é˜µ](#41-åŠŸèƒ½å¯¹æ¯”çŸ©é˜µ)
    - [4.2. æ€§èƒ½å¯¹æ¯”çŸ©é˜µ](#42-æ€§èƒ½å¯¹æ¯”çŸ©é˜µ)
    - [4.3. PostgreSQLå¤šç§Ÿæˆ·æ–¹æ¡ˆé€‰æ‹©å†³ç­–æ ‘](#43-postgresqlå¤šç§Ÿæˆ·æ–¹æ¡ˆé€‰æ‹©å†³ç­–æ ‘)
  - [5. åº”ç”¨åœºæ™¯çš„å½¢å¼åŒ–åˆ†æ](#5-åº”ç”¨åœºæ™¯çš„å½¢å¼åŒ–åˆ†æ)
    - [5.1. SaaSåº”ç”¨çš„å½¢å¼åŒ–å®šä¹‰](#51-saasåº”ç”¨çš„å½¢å¼åŒ–å®šä¹‰)
    - [5.2. å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»çš„å½¢å¼åŒ–å®šä¹‰](#52-å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»çš„å½¢å¼åŒ–å®šä¹‰)
    - [5.3. ç§Ÿæˆ·æ•°æ®è¿ç§»çš„å½¢å¼åŒ–å®šä¹‰](#53-ç§Ÿæˆ·æ•°æ®è¿ç§»çš„å½¢å¼åŒ–å®šä¹‰)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)
    - [6.1. ç»å…¸æ–‡çŒ®](#61-ç»å…¸æ–‡çŒ®)
    - [6.2. ç›¸å…³èµ„æº](#62-ç›¸å…³èµ„æº)

---

## 1. æ¦‚è¿°

### 1.1. PostgreSQL RLSç®€ä»‹

PostgreSQLè¡Œçº§å®‰å…¨ï¼ˆRow Level Security, RLSï¼‰æä¾›ï¼š

- **è¡Œçº§è®¿é—®æ§åˆ¶**ï¼šåŸºäºç­–ç•¥çš„è¡Œçº§è®¿é—®æ§åˆ¶
- **ç§Ÿæˆ·éš”ç¦»**ï¼šè‡ªåŠ¨éš”ç¦»ä¸åŒç§Ÿæˆ·çš„æ•°æ®
- **ç­–ç•¥ç®¡ç†**ï¼šçµæ´»çš„ç­–ç•¥å®šä¹‰å’Œç®¡ç†
- **æ€§èƒ½ä¼˜åŒ–**ï¼šç­–ç•¥ä¼˜åŒ–å’Œç´¢å¼•æ”¯æŒ

### 1.2. å¤šç§Ÿæˆ·æ•°æ®åº“çš„é‡è¦æ€§

å¤šç§Ÿæˆ·æ•°æ®åº“åœ¨ç°ä»£SaaSåº”ç”¨ä¸­è‡³å…³é‡è¦ï¼š

1. **SaaSåº”ç”¨**ï¼šå¤šç§Ÿæˆ·SaaSåº”ç”¨çš„æ•°æ®éš”ç¦»
2. **æˆæœ¬æ•ˆç›Š**ï¼šå…±äº«èµ„æºé™ä½æˆæœ¬
3. **æ•°æ®å®‰å…¨**ï¼šä¿è¯ç§Ÿæˆ·æ•°æ®å®‰å…¨éš”ç¦»
4. **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒå¤§é‡ç§Ÿæˆ·

### 1.3. RLSåœ¨PostgreSQLä¸­çš„ä½ç½®

RLSæ˜¯PostgreSQLçš„æ ¸å¿ƒå®‰å…¨ç‰¹æ€§ï¼š

- **è¡¨çº§æƒé™**ï¼šPostgreSQLåŸç”Ÿæ”¯æŒ
- **è¡Œçº§æƒé™**ï¼šRLSæ‰©å±•æ”¯æŒ
- **åˆ—çº§æƒé™**ï¼šPostgreSQLåŸç”Ÿæ”¯æŒ

---

## 2. å¤šç§Ÿæˆ·æ•°æ®åº“çš„å½¢å¼åŒ–å®šä¹‰

### 2.1. å¤šç§Ÿæˆ·æ•°æ®æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰

#### 2.1.1. ç§Ÿæˆ·çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.1.1ï¼ˆç§Ÿæˆ·ï¼‰**ï¼š

ç§Ÿæˆ· Tenant æ˜¯ä¸€ä¸ªä¸‰å…ƒç»„ (tenant_id, data, permissions)ï¼Œå…¶ä¸­ï¼š

- **tenant_id**ï¼šç§Ÿæˆ·æ ‡è¯†ç¬¦
- **data**ï¼šç§Ÿæˆ·æ•°æ®é›†åˆ
- **permissions**ï¼šç§Ÿæˆ·æƒé™é›†åˆ

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
Tenant = (tenant_id, data, permissions)
å…¶ä¸­ï¼š
  tenant_id âˆˆ TenantID
  data âŠ† Database
  permissions âŠ† PermissionSet
```

**ç§Ÿæˆ·çš„æ€§è´¨**ï¼š

**æ€§è´¨2.1.1ï¼ˆç§Ÿæˆ·çš„å”¯ä¸€æ€§ï¼‰**ï¼š

æ¯ä¸ªç§Ÿæˆ·æœ‰å”¯ä¸€çš„æ ‡è¯†ç¬¦ã€‚

**å½¢å¼åŒ–**ï¼š

```text
å”¯ä¸€æ€§ âŸº
  âˆ€Tenantâ‚, Tenantâ‚‚.
    Tenantâ‚.tenant_id = Tenantâ‚‚.tenant_id âŸ¹ Tenantâ‚ = Tenantâ‚‚
```

#### 2.1.2. ç§Ÿæˆ·éš”ç¦»çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.1.2ï¼ˆç§Ÿæˆ·éš”ç¦»ï¼‰**ï¼š

ç§Ÿæˆ·éš”ç¦»è¦æ±‚ä¸åŒç§Ÿæˆ·çš„æ•°æ®ç›¸äº’ä¸å¯è®¿é—®ï¼š

```text
éš”ç¦»æ€§ âŸº
  âˆ€Tenantâ‚, Tenantâ‚‚, tenantâ‚ â‰  tenantâ‚‚.
    Tenantâ‚.data âˆ© Tenantâ‚‚.data = âˆ…
```

**éš”ç¦»æ€§çš„å½¢å¼åŒ–å®šä¹‰**ï¼š

**å®šä¹‰2.1.3ï¼ˆæ•°æ®éš”ç¦»ï¼‰**ï¼š

æ•°æ®éš”ç¦»è¦æ±‚ç§Ÿæˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®ï¼š

```text
æ•°æ®éš”ç¦» âŸº
  âˆ€æŸ¥è¯¢q, ç§Ÿæˆ·t.
    [[q]]_t âŠ† t.data
```

#### 2.1.3. å¤šç§Ÿæˆ·æ•°æ®åº“çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.1.4ï¼ˆå¤šç§Ÿæˆ·æ•°æ®åº“ï¼‰**ï¼š

å¤šç§Ÿæˆ·æ•°æ®åº“ MultiTenantDB æ˜¯ä¸€ä¸ªä¸‰å…ƒç»„ (Tenants, Isolation, AccessControl)ï¼Œå…¶ä¸­ï¼š

- **Tenants**ï¼šç§Ÿæˆ·é›†åˆ
- **Isolation**ï¼šéš”ç¦»æœºåˆ¶
- **AccessControl**ï¼šè®¿é—®æ§åˆ¶æœºåˆ¶

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
MultiTenantDB = (Tenants, Isolation, AccessControl)
å…¶ä¸­ï¼š
  Tenants = {Tenantâ‚, Tenantâ‚‚, ..., Tenantâ‚™}
  Isolation: Tenant â†’ DataIsolation
  AccessControl: Tenant Ã— Resource â†’ Permission
```

### 2.2. PostgreSQL RLSçš„å½¢å¼åŒ–è§„èŒƒ

#### 2.2.1. RLSç­–ç•¥çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.2.1ï¼ˆRLSç­–ç•¥ï¼‰**ï¼š

RLSç­–ç•¥ Policy æ˜¯ä¸€ä¸ªä¸‰å…ƒç»„ (policy_name, policy_type, policy_expression)ï¼Œå…¶ä¸­ï¼š

- **policy_name**ï¼šç­–ç•¥åç§°
- **policy_type**ï¼šç­–ç•¥ç±»å‹ï¼ˆSELECTã€INSERTã€UPDATEã€DELETEã€ALLï¼‰
- **policy_expression**ï¼šç­–ç•¥è¡¨è¾¾å¼ï¼Œè¿”å›å¸ƒå°”å€¼

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
Policy = (policy_name, policy_type, policy_expression)
å…¶ä¸­ï¼š
  policy_name: String
  policy_type âˆˆ {SELECT, INSERT, UPDATE, DELETE, ALL}
  policy_expression: Row â†’ Bool
```

**RLSç­–ç•¥çš„è¯­ä¹‰**ï¼š

**å®šä¹‰2.2.2ï¼ˆRLSç­–ç•¥è¯­ä¹‰ï¼‰**ï¼š

RLSç­–ç•¥çš„è¯­ä¹‰æ˜¯è¿‡æ»¤è¡Œï¼š

```text
[[Policy]]_Table = {
    row | row âˆˆ Table, Policy.policy_expression(row) = True
}
```

#### 2.2.2. RLSç­–ç•¥ç±»å‹çš„å½¢å¼åŒ–å®šä¹‰

**ç±»å‹1ï¼šSELECTç­–ç•¥**ï¼š

**å®šä¹‰2.2.3ï¼ˆSELECTç­–ç•¥ï¼‰**ï¼š

SELECTç­–ç•¥æ§åˆ¶è¡Œçš„å¯è§æ€§ï¼š

```text
SELECTç­–ç•¥(row) âŸº
  policy_expression(row) = True
```

**ç±»å‹2ï¼šINSERTç­–ç•¥**ï¼š

**å®šä¹‰2.2.4ï¼ˆINSERTç­–ç•¥ï¼‰**ï¼š

INSERTç­–ç•¥æ§åˆ¶è¡Œçš„æ’å…¥æƒé™ï¼š

```text
INSERTç­–ç•¥(row) âŸº
  policy_expression(row) = True
```

**ç±»å‹3ï¼šUPDATEç­–ç•¥**ï¼š

**å®šä¹‰2.2.5ï¼ˆUPDATEç­–ç•¥ï¼‰**ï¼š

UPDATEç­–ç•¥æ§åˆ¶è¡Œçš„æ›´æ–°æƒé™ï¼š

```text
UPDATEç­–ç•¥(old_row, new_row) âŸº
  policy_expression(old_row) = True âˆ§
  policy_expression(new_row) = True
```

**ç±»å‹4ï¼šDELETEç­–ç•¥**ï¼š

**å®šä¹‰2.2.6ï¼ˆDELETEç­–ç•¥ï¼‰**ï¼š

DELETEç­–ç•¥æ§åˆ¶è¡Œçš„åˆ é™¤æƒé™ï¼š

```text
DELETEç­–ç•¥(row) âŸº
  policy_expression(row) = True
```

#### 2.2.3. RLSç­–ç•¥è¯„ä¼°çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.2.7ï¼ˆRLSç­–ç•¥è¯„ä¼°ï¼‰**ï¼š

RLSç­–ç•¥è¯„ä¼°æ˜¯åœ¨æŸ¥è¯¢æ‰§è¡Œæ—¶è¯„ä¼°ç­–ç•¥è¡¨è¾¾å¼ï¼š

```text
ç­–ç•¥è¯„ä¼°(Query, Policy, Row) =
    Policy.policy_expression(Row)
```

**ç­–ç•¥è¯„ä¼°çš„æ€§è´¨**ï¼š

**æ€§è´¨2.2.1ï¼ˆç­–ç•¥è¯„ä¼°çš„é€æ˜æ€§ï¼‰**ï¼š

ç­–ç•¥è¯„ä¼°å¯¹ç”¨æˆ·é€æ˜ï¼Œè‡ªåŠ¨åº”ç”¨ã€‚

**å½¢å¼åŒ–**ï¼š

```text
é€æ˜æ€§ âŸº
  âˆ€æŸ¥è¯¢q.
    [[q]]_RLS = {row | row âˆˆ [[q]]_æ— RLS, ç­–ç•¥è¯„ä¼°(q, row) = True}
```

### 2.3. RLSæ€§è´¨çš„å½¢å¼åŒ–è¯æ˜

#### 2.3.1. RLSéš”ç¦»æ€§çš„å½¢å¼åŒ–è¯æ˜

**å®šç†2.3.1ï¼ˆRLSéš”ç¦»æ€§ï¼‰**ï¼š

RLSä¿è¯ç§Ÿæˆ·æ•°æ®çš„å®Œå…¨éš”ç¦»ã€‚

**è¯æ˜**ï¼š

**æ­¥éª¤1**ï¼šå®šä¹‰éš”ç¦»æ€§

éš”ç¦»æ€§è¦æ±‚ç§Ÿæˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®ã€‚

**æ­¥éª¤2**ï¼šéªŒè¯RLSç­–ç•¥

RLSç­–ç•¥é€šè¿‡ç­–ç•¥è¡¨è¾¾å¼è¿‡æ»¤è¡Œï¼Œç¡®ä¿ç§Ÿæˆ·åªèƒ½è®¿é—®æ»¡è¶³æ¡ä»¶çš„è¡Œã€‚

**æ­¥éª¤3**ï¼šç»“è®º

å› æ­¤RLSä¿è¯ç§Ÿæˆ·æ•°æ®çš„å®Œå…¨éš”ç¦» âœ…

#### 2.3.2. RLSå®‰å…¨æ€§çš„å½¢å¼åŒ–è¯æ˜

**å®šç†2.3.2ï¼ˆRLSå®‰å…¨æ€§ï¼‰**ï¼š

RLSç­–ç•¥åœ¨æ•°æ®åº“å±‚é¢å¼ºåˆ¶æ‰§è¡Œï¼Œæ— æ³•ç»•è¿‡ã€‚

**è¯æ˜**ï¼š

**æ­¥éª¤1**ï¼šå®šä¹‰å®‰å…¨æ€§

å®‰å…¨æ€§è¦æ±‚ç­–ç•¥åœ¨æ•°æ®åº“å±‚é¢å¼ºåˆ¶æ‰§è¡Œã€‚

**æ­¥éª¤2**ï¼šéªŒè¯RLSå®ç°

RLSåœ¨æŸ¥è¯¢æ‰§è¡Œæ—¶è‡ªåŠ¨åº”ç”¨ç­–ç•¥ï¼Œæ— æ³•ç»•è¿‡ã€‚

**æ­¥éª¤3**ï¼šç»“è®º

å› æ­¤RLSç­–ç•¥åœ¨æ•°æ®åº“å±‚é¢å¼ºåˆ¶æ‰§è¡Œ âœ…

#### 2.3.3. RLSæ€§èƒ½çš„å½¢å¼åŒ–åˆ†æ

**æ€§è´¨2.3.1ï¼ˆRLSæ€§èƒ½å½±å“ï¼‰**ï¼š

RLSç­–ç•¥è¯„ä¼°ä¼šå¢åŠ æŸ¥è¯¢å¼€é”€ã€‚

**å½¢å¼åŒ–**ï¼š

```text
æ€§èƒ½å½±å“ âŸº
  æŸ¥è¯¢æ—¶é—´(RLS) = æŸ¥è¯¢æ—¶é—´(æ— RLS) + ç­–ç•¥è¯„ä¼°æ—¶é—´
```

**ä¼˜åŒ–ç­–ç•¥**ï¼š

1. **ç´¢å¼•ä¼˜åŒ–**ï¼šåœ¨ç­–ç•¥è¡¨è¾¾å¼ä¸­ä½¿ç”¨çš„åˆ—ä¸Šåˆ›å»ºç´¢å¼•
2. **ç­–ç•¥ç®€åŒ–**ï¼šç®€åŒ–ç­–ç•¥è¡¨è¾¾å¼
3. **ç­–ç•¥ç¼“å­˜**ï¼šç¼“å­˜ç­–ç•¥è¯„ä¼°ç»“æœ

---

## 3. å¤šç§Ÿæˆ·æ¶æ„çš„å½¢å¼åŒ–ç†è®º

### 3.1. å¤šç§Ÿæˆ·æ¶æ„æ¨¡å¼çš„å½¢å¼åŒ–å®šä¹‰

#### 3.1.1. å…±äº«æ•°æ®åº“å…±äº«Schemaæ¨¡å¼

**å®šä¹‰3.1.1ï¼ˆå…±äº«æ•°æ®åº“å…±äº«Schemaæ¨¡å¼ï¼‰**ï¼š

å…±äº«æ•°æ®åº“å…±äº«Schemaæ¨¡å¼ä¸­ï¼Œæ‰€æœ‰ç§Ÿæˆ·å…±äº«åŒä¸€ä¸ªæ•°æ®åº“å’ŒSchemaï¼š

```text
å…±äº«æ¨¡å¼ = {
    Database: å•ä¸ªæ•°æ®åº“,
    Schema: å•ä¸ªSchema,
    éš”ç¦»æœºåˆ¶: RLSç­–ç•¥
}
```

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
å…±äº«æ¨¡å¼ = (DB, Schema, RLS_Policies)
å…¶ä¸­ï¼š
  DB: å•ä¸ªæ•°æ®åº“
  Schema: å•ä¸ªSchema
  RLS_Policies: {Policy | Policyéš”ç¦»ç§Ÿæˆ·æ•°æ®}
```

**æ¨¡å¼çš„æ€§è´¨**ï¼š

**æ€§è´¨3.1.1ï¼ˆå…±äº«æ¨¡å¼çš„ç»æµæ€§ï¼‰**ï¼š

å…±äº«æ¨¡å¼èµ„æºåˆ©ç”¨ç‡é«˜ï¼Œæˆæœ¬ä½ã€‚

**å½¢å¼åŒ–**ï¼š

```text
ç»æµæ€§ âŸº
  èµ„æºåˆ©ç”¨ç‡ = é«˜
  æˆæœ¬ = ä½
```

#### 3.1.2. å…±äº«æ•°æ®åº“ç‹¬ç«‹Schemaæ¨¡å¼

**å®šä¹‰3.1.2ï¼ˆå…±äº«æ•°æ®åº“ç‹¬ç«‹Schemaæ¨¡å¼ï¼‰**ï¼š

å…±äº«æ•°æ®åº“ç‹¬ç«‹Schemaæ¨¡å¼ä¸­ï¼Œæ‰€æœ‰ç§Ÿæˆ·å…±äº«æ•°æ®åº“ä½†ä½¿ç”¨ç‹¬ç«‹Schemaï¼š

```text
ç‹¬ç«‹Schemaæ¨¡å¼ = {
    Database: å•ä¸ªæ•°æ®åº“,
    Schemas: {Schemaâ‚, Schemaâ‚‚, ..., Schemaâ‚™},
    éš”ç¦»æœºåˆ¶: Schemaéš”ç¦»
}
```

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
ç‹¬ç«‹Schemaæ¨¡å¼ = (DB, Schemas, Schema_Isolation)
å…¶ä¸­ï¼š
  DB: å•ä¸ªæ•°æ®åº“
  Schemas = {Schemaâ‚, Schemaâ‚‚, ..., Schemaâ‚™}
  Schema_Isolation: Schema â†’ Tenant
```

#### 3.1.3. ç‹¬ç«‹æ•°æ®åº“æ¨¡å¼

**å®šä¹‰3.1.3ï¼ˆç‹¬ç«‹æ•°æ®åº“æ¨¡å¼ï¼‰**ï¼š

ç‹¬ç«‹æ•°æ®åº“æ¨¡å¼ä¸­ï¼Œæ¯ä¸ªç§Ÿæˆ·ä½¿ç”¨ç‹¬ç«‹æ•°æ®åº“ï¼š

```text
ç‹¬ç«‹æ•°æ®åº“æ¨¡å¼ = {
    Databases: {DBâ‚, DBâ‚‚, ..., DBâ‚™},
    éš”ç¦»æœºåˆ¶: æ•°æ®åº“éš”ç¦»
}
```

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
ç‹¬ç«‹æ•°æ®åº“æ¨¡å¼ = (Databases, DB_Isolation)
å…¶ä¸­ï¼š
  Databases = {DBâ‚, DBâ‚‚, ..., DBâ‚™}
  DB_Isolation: Database â†’ Tenant
```

### 3.2. å¤šç§Ÿæˆ·æ¶æ„é€‰æ‹©å†³ç­–æ ‘

```mermaid
flowchart TD
    A[é€‰æ‹©å¤šç§Ÿæˆ·æ¶æ„] --> B{ç§Ÿæˆ·æ•°é‡}
    B -->|å°‘é‡<100| C[ç‹¬ç«‹æ•°æ®åº“æ¨¡å¼]
    B -->|ä¸­ç­‰100-1000| D{æ•°æ®éš”ç¦»è¦æ±‚}
    B -->|å¤§é‡>1000| E[å…±äº«æ•°æ®åº“å…±äº«Schema+RLS]

    D -->|ä¸¥æ ¼éš”ç¦»| F[å…±äº«æ•°æ®åº“ç‹¬ç«‹Schema]
    D -->|ä¸€èˆ¬éš”ç¦»| E

    C --> G{èµ„æºæˆæœ¬}
    F --> H{ç®¡ç†å¤æ‚åº¦}
    E --> I{æ€§èƒ½è¦æ±‚}

    G -->|æˆæœ¬å¯æ¥å—| J[ç‹¬ç«‹æ•°æ®åº“æ¨¡å¼ âœ…]
    G -->|æˆæœ¬æ•æ„Ÿ| K[å…±äº«æ¨¡å¼]

    H -->|å¯æ¥å—| L[ç‹¬ç«‹Schemaæ¨¡å¼ âœ…]
    H -->|ç®€åŒ–ç®¡ç†| M[å…±äº«Schema+RLS]

    I -->|é«˜æ€§èƒ½| N[ç‹¬ç«‹æ•°æ®åº“/ç‹¬ç«‹Schema]
    I -->|å¹³è¡¡| O[å…±äº«Schema+RLS âœ…]

    J --> P[éªŒè¯éš”ç¦»éœ€æ±‚]
    K --> P
    L --> P
    M --> P
    N --> P
    O --> P

    P --> Q{éš”ç¦»æ»¡è¶³?}
    Q -->|æ˜¯| R[å¤šç§Ÿæˆ·æ¶æ„é€‰æ‹©å®Œæˆ âœ…]
    Q -->|å¦| S[è°ƒæ•´æ¶æ„]
    S --> B
```

### 3.3. å¤šç§Ÿæˆ·æ¶æ„å¯¹æ¯”çŸ©é˜µ

| æ¶æ„æ¨¡å¼ | éš”ç¦»æ€§ | èµ„æºåˆ©ç”¨ç‡ | ç®¡ç†å¤æ‚åº¦ | æˆæœ¬ | æ€§èƒ½ | é€‚ç”¨åœºæ™¯ |
|---------|--------|-----------|-----------|------|------|---------|
| **å…±äº«æ•°æ®åº“å…±äº«Schema+RLS** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | å¤§é‡ç§Ÿæˆ· |
| **å…±äº«æ•°æ®åº“ç‹¬ç«‹Schema** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­â­ | ä¸­ç­‰ç§Ÿæˆ· |
| **ç‹¬ç«‹æ•°æ®åº“** | â­â­â­â­â­ | â­â­ | â­â­ | â­â­ | â­â­â­â­â­ | å°‘é‡ç§Ÿæˆ· |

---

## 4. PostgreSQL RLSä¸å…¶ä»–å¤šç§Ÿæˆ·æ–¹æ¡ˆçš„å¯¹æ¯”

### 4.1. åŠŸèƒ½å¯¹æ¯”çŸ©é˜µ

| åŠŸèƒ½ | PostgreSQL RLS | åº”ç”¨å±‚éš”ç¦» | ç‹¬ç«‹Schema | ç‹¬ç«‹æ•°æ®åº“ |
|------|---------------|-----------|-----------|-----------|
| **æ•°æ®åº“å±‚éš”ç¦»** | âœ… | âŒ | âœ… | âœ… |
| **ç­–ç•¥çµæ´»æ€§** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| **æ€§èƒ½å¼€é”€** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| **ç®¡ç†å¤æ‚åº¦** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | â­â­ |
| **æˆæœ¬** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­ |

### 4.2. æ€§èƒ½å¯¹æ¯”çŸ©é˜µ

| æ€§èƒ½æŒ‡æ ‡ | PostgreSQL RLS | åº”ç”¨å±‚éš”ç¦» | ç‹¬ç«‹Schema | ç‹¬ç«‹æ•°æ®åº“ |
|---------|---------------|-----------|-----------|-----------|
| **æŸ¥è¯¢æ€§èƒ½** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| **éš”ç¦»æ€§èƒ½** | â­â­â­â­â­ | â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| **æ‰©å±•æ€§** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |

### 4.3. PostgreSQLå¤šç§Ÿæˆ·æ–¹æ¡ˆé€‰æ‹©å†³ç­–æ ‘

```mermaid
flowchart TD
    A[é€‰æ‹©å¤šç§Ÿæˆ·æ–¹æ¡ˆ] --> B{ç§Ÿæˆ·æ•°é‡}
    B -->|å°‘é‡<100| C[ç‹¬ç«‹æ•°æ®åº“ âœ…]
    B -->|ä¸­ç­‰100-1000| D{éš”ç¦»è¦æ±‚}
    B -->|å¤§é‡>1000| E[RLSç­–ç•¥ âœ…]

    D -->|ä¸¥æ ¼éš”ç¦»| F[ç‹¬ç«‹Schema]
    D -->|ä¸€èˆ¬éš”ç¦»| E

    C --> G{èµ„æºæˆæœ¬}
    F --> H{ç®¡ç†å¤æ‚åº¦}
    E --> I{æ€§èƒ½è¦æ±‚}

    G -->|æˆæœ¬å¯æ¥å—| J[ç‹¬ç«‹æ•°æ®åº“ âœ…]
    G -->|æˆæœ¬æ•æ„Ÿ| K[RLSç­–ç•¥]

    H -->|å¯æ¥å—| L[ç‹¬ç«‹Schema âœ…]
    H -->|ç®€åŒ–ç®¡ç†| M[RLSç­–ç•¥]

    I -->|é«˜æ€§èƒ½| N[ç‹¬ç«‹æ•°æ®åº“/ç‹¬ç«‹Schema]
    I -->|å¹³è¡¡| O[RLSç­–ç•¥ âœ…]

    J --> P[éªŒè¯éœ€æ±‚]
    K --> P
    L --> P
    M --> P
    N --> P
    O --> P

    P --> Q{éœ€æ±‚æ»¡è¶³?}
    Q -->|æ˜¯| R[å¤šç§Ÿæˆ·æ–¹æ¡ˆé€‰æ‹©å®Œæˆ âœ…]
    Q -->|å¦| S[è°ƒæ•´æ–¹æ¡ˆ]
    S --> B
```

---

## 5. åº”ç”¨åœºæ™¯çš„å½¢å¼åŒ–åˆ†æ

### 5.1. SaaSåº”ç”¨çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰5.1.1ï¼ˆSaaSåº”ç”¨ï¼‰**ï¼š

SaaSåº”ç”¨æ˜¯ä¸€ä¸ªå¤šç§Ÿæˆ·åº”ç”¨ç³»ç»Ÿï¼š

```text
SaaSåº”ç”¨ = (MultiTenantDB, Application, AccessControl)
å…¶ä¸­ï¼š
  MultiTenantDB: å¤šç§Ÿæˆ·æ•°æ®åº“
  Application: åº”ç”¨é€»è¾‘
  AccessControl: è®¿é—®æ§åˆ¶
```

**SaaSæ•°æ®éš”ç¦»çš„å½¢å¼åŒ–å®šä¹‰**ï¼š

**å®šä¹‰5.1.2ï¼ˆSaaSæ•°æ®éš”ç¦»ï¼‰**ï¼š

SaaSåº”ç”¨è¦æ±‚ç§Ÿæˆ·æ•°æ®å®Œå…¨éš”ç¦»ï¼š

```text
SaaSæ•°æ®éš”ç¦» âŸº
  âˆ€ç§Ÿæˆ·tâ‚, tâ‚‚, tâ‚ â‰  tâ‚‚.
    tâ‚.data âˆ© tâ‚‚.data = âˆ…
```

### 5.2. å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰5.2.1ï¼ˆæ•°æ®éš”ç¦»ç­–ç•¥ï¼‰**ï¼š

æ•°æ®éš”ç¦»ç­–ç•¥ IsolationPolicy æ˜¯ä¸€ä¸ªå‡½æ•°ï¼š

```text
IsolationPolicy: Tenant Ã— Row â†’ Bool
```

**éš”ç¦»ç­–ç•¥çš„å½¢å¼åŒ–å®šä¹‰**ï¼š

**å®šä¹‰5.2.2ï¼ˆç§Ÿæˆ·IDéš”ç¦»ç­–ç•¥ï¼‰**ï¼š

ç§Ÿæˆ·IDéš”ç¦»ç­–ç•¥ä½¿ç”¨ç§Ÿæˆ·IDåˆ—è¿›è¡Œéš”ç¦»ï¼š

```text
ç§Ÿæˆ·IDéš”ç¦»ç­–ç•¥(row) âŸº
  row.tenant_id = current_tenant_id()
```

### 5.3. ç§Ÿæˆ·æ•°æ®è¿ç§»çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰5.3.1ï¼ˆç§Ÿæˆ·æ•°æ®è¿ç§»ï¼‰**ï¼š

ç§Ÿæˆ·æ•°æ®è¿ç§»æ˜¯å°†ç§Ÿæˆ·æ•°æ®ä»ä¸€ä¸ªä½ç½®è¿ç§»åˆ°å¦ä¸€ä¸ªä½ç½®ï¼š

```text
æ•°æ®è¿ç§»(Tenant, Source, Target) =
    å¤åˆ¶(Tenant.data, Source) â†’ Target
```

**è¿ç§»çš„å½¢å¼åŒ–å®šä¹‰**ï¼š

**å®šä¹‰5.3.2ï¼ˆè¿ç§»çš„æ­£ç¡®æ€§ï¼‰**ï¼š

è¿ç§»çš„æ­£ç¡®æ€§è¦æ±‚è¿ç§»åæ•°æ®å®Œæ•´ä¸”ä¸€è‡´ï¼š

```text
è¿ç§»æ­£ç¡®æ€§ âŸº
  æ•°æ®å®Œæ•´æ€§(è¿ç§»å) âˆ§
  æ•°æ®ä¸€è‡´æ€§(è¿ç§»å)
```

---

## 6. å‚è€ƒèµ„æ–™

### 6.1. ç»å…¸æ–‡çŒ®

- PostgreSQL RLSå®˜æ–¹æ–‡æ¡£ï¼š<https://www.postgresql.org/docs/current/ddl-rowsecurity.html>
- "Multi-Tenant Data Architecture" (Chong et al., 2006)
- "Row-Level Security in PostgreSQL" (PostgreSQLå®˜æ–¹æ–‡æ¡£)

### 6.2. ç›¸å…³èµ„æº

- [PostgreSQL RLSæ–‡æ¡£](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)
- [å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)
- [SaaSæ•°æ®åº“è®¾è®¡](https://www.citusdata.com/blog/2016/10/25/designing-your-saas-database-for-multi-tenancy/)

---

**æœ€åæ›´æ–°**ï¼š2025-01-15
**ç»´æŠ¤è€…**ï¼šData-Science Team
**çŠ¶æ€**ï¼šè¿›è¡Œä¸­
