# PostgreSQLæ‰©å±•ï¼šSaaSåº”ç”¨åœºæ™¯å½¢å¼åŒ–ç†è®ºåˆ†æ

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-01-15
> **ç‰ˆæœ¬**ï¼šv1.0
> **çŠ¶æ€**ï¼šè¿›è¡Œä¸­

---

## ğŸ“‹ ç›®å½•

- [PostgreSQLæ‰©å±•ï¼šSaaSåº”ç”¨åœºæ™¯å½¢å¼åŒ–ç†è®ºåˆ†æ](#postgresqlæ‰©å±•saasåº”ç”¨åœºæ™¯å½¢å¼åŒ–ç†è®ºåˆ†æ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1. SaaSåº”ç”¨ç®€ä»‹](#11-saasåº”ç”¨ç®€ä»‹)
    - [1.2. SaaSåº”ç”¨çš„é‡è¦æ€§](#12-saasåº”ç”¨çš„é‡è¦æ€§)
    - [1.3. PostgreSQLåœ¨SaaSåº”ç”¨ä¸­çš„ä½ç½®](#13-postgresqlåœ¨saasåº”ç”¨ä¸­çš„ä½ç½®)
  - [2. SaaSåº”ç”¨çš„å½¢å¼åŒ–å®šä¹‰](#2-saasåº”ç”¨çš„å½¢å¼åŒ–å®šä¹‰)
    - [2.1. å¤šç§Ÿæˆ·æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰](#21-å¤šç§Ÿæˆ·æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰)
      - [2.1.1. SaaSç³»ç»Ÿçš„å½¢å¼åŒ–å®šä¹‰](#211-saasç³»ç»Ÿçš„å½¢å¼åŒ–å®šä¹‰)
      - [2.1.2. ç§Ÿæˆ·çš„å½¢å¼åŒ–å®šä¹‰](#212-ç§Ÿæˆ·çš„å½¢å¼åŒ–å®šä¹‰)
      - [2.1.3. ç§Ÿæˆ·éš”ç¦»çš„å½¢å¼åŒ–å®šä¹‰](#213-ç§Ÿæˆ·éš”ç¦»çš„å½¢å¼åŒ–å®šä¹‰)
    - [2.2. å¤šç§Ÿæˆ·æ•°æ®åº“çš„å½¢å¼åŒ–å®šä¹‰](#22-å¤šç§Ÿæˆ·æ•°æ®åº“çš„å½¢å¼åŒ–å®šä¹‰)
      - [2.2.1. RLSç­–ç•¥çš„å½¢å¼åŒ–å®šä¹‰](#221-rlsç­–ç•¥çš„å½¢å¼åŒ–å®šä¹‰)
      - [2.2.2. ç§Ÿæˆ·æ•°æ®çš„å½¢å¼åŒ–å®šä¹‰](#222-ç§Ÿæˆ·æ•°æ®çš„å½¢å¼åŒ–å®šä¹‰)
      - [2.2.3. ç§Ÿæˆ·æŸ¥è¯¢çš„å½¢å¼åŒ–å®šä¹‰](#223-ç§Ÿæˆ·æŸ¥è¯¢çš„å½¢å¼åŒ–å®šä¹‰)
    - [2.3. SaaSåº”ç”¨æ€§è´¨çš„å½¢å¼åŒ–è¯æ˜](#23-saasåº”ç”¨æ€§è´¨çš„å½¢å¼åŒ–è¯æ˜)
      - [2.3.1. ç§Ÿæˆ·éš”ç¦»çš„å½¢å¼åŒ–è¯æ˜](#231-ç§Ÿæˆ·éš”ç¦»çš„å½¢å¼åŒ–è¯æ˜)
      - [2.3.2. æ•°æ®å®‰å…¨çš„å½¢å¼åŒ–è¯æ˜](#232-æ•°æ®å®‰å…¨çš„å½¢å¼åŒ–è¯æ˜)
      - [2.3.3. æ€§èƒ½éš”ç¦»çš„å½¢å¼åŒ–è¯æ˜](#233-æ€§èƒ½éš”ç¦»çš„å½¢å¼åŒ–è¯æ˜)
  - [3. SaaSåº”ç”¨æ¶æ„çš„å½¢å¼åŒ–ç†è®º](#3-saasåº”ç”¨æ¶æ„çš„å½¢å¼åŒ–ç†è®º)
    - [3.1. å¤šç§Ÿæˆ·æ¶æ„çš„å½¢å¼åŒ–å®šä¹‰](#31-å¤šç§Ÿæˆ·æ¶æ„çš„å½¢å¼åŒ–å®šä¹‰)
      - [3.1.1. å…±äº«æ•°æ®åº“å…±äº«Schemaæ¨¡å¼](#311-å…±äº«æ•°æ®åº“å…±äº«schemaæ¨¡å¼)
      - [3.1.2. å…±äº«æ•°æ®åº“ç‹¬ç«‹Schemaæ¨¡å¼](#312-å…±äº«æ•°æ®åº“ç‹¬ç«‹schemaæ¨¡å¼)
      - [3.1.3. ç‹¬ç«‹æ•°æ®åº“æ¨¡å¼](#313-ç‹¬ç«‹æ•°æ®åº“æ¨¡å¼)
    - [3.2. SaaSåº”ç”¨æ¶æ„å¯¹æ¯”çŸ©é˜µ](#32-saasåº”ç”¨æ¶æ„å¯¹æ¯”çŸ©é˜µ)
    - [3.3. SaaSåº”ç”¨æ¶æ„é€‰æ‹©å†³ç­–æ ‘](#33-saasåº”ç”¨æ¶æ„é€‰æ‹©å†³ç­–æ ‘)
  - [4. PostgreSQL SaaSåº”ç”¨æ–¹æ¡ˆä¸å…¶ä»–æ–¹æ¡ˆçš„å¯¹æ¯”](#4-postgresql-saasåº”ç”¨æ–¹æ¡ˆä¸å…¶ä»–æ–¹æ¡ˆçš„å¯¹æ¯”)
    - [4.1. åŠŸèƒ½å¯¹æ¯”çŸ©é˜µ](#41-åŠŸèƒ½å¯¹æ¯”çŸ©é˜µ)
    - [4.2. æ€§èƒ½å¯¹æ¯”çŸ©é˜µ](#42-æ€§èƒ½å¯¹æ¯”çŸ©é˜µ)
    - [4.3. PostgreSQL SaaSåº”ç”¨æ–¹æ¡ˆé€‰æ‹©å†³ç­–æ ‘](#43-postgresql-saasåº”ç”¨æ–¹æ¡ˆé€‰æ‹©å†³ç­–æ ‘)
  - [5. åº”ç”¨åœºæ™¯çš„å½¢å¼åŒ–åˆ†æ](#5-åº”ç”¨åœºæ™¯çš„å½¢å¼åŒ–åˆ†æ)
    - [5.1. å¤šç§Ÿæˆ·SaaSçš„å½¢å¼åŒ–å®šä¹‰](#51-å¤šç§Ÿæˆ·saasçš„å½¢å¼åŒ–å®šä¹‰)
    - [5.2. ç§Ÿæˆ·æ•°æ®è¿ç§»çš„å½¢å¼åŒ–å®šä¹‰](#52-ç§Ÿæˆ·æ•°æ®è¿ç§»çš„å½¢å¼åŒ–å®šä¹‰)
    - [5.3. ç§Ÿæˆ·æ‰©å±•çš„å½¢å¼åŒ–å®šä¹‰](#53-ç§Ÿæˆ·æ‰©å±•çš„å½¢å¼åŒ–å®šä¹‰)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1. SaaSåº”ç”¨ç®€ä»‹

SaaSï¼ˆSoftware as a Serviceï¼‰åº”ç”¨æ˜¯ç°ä»£è½¯ä»¶äº¤ä»˜æ¨¡å¼ï¼Œæä¾›ï¼š

- **å¤šç§Ÿæˆ·æ¶æ„**ï¼šå¤šä¸ªç§Ÿæˆ·å…±äº«åŒä¸€åº”ç”¨å®ä¾‹
- **æ•°æ®éš”ç¦»**ï¼šä¿è¯ç§Ÿæˆ·æ•°æ®å®‰å…¨éš”ç¦»
- **èµ„æºéš”ç¦»**ï¼šä¿è¯ç§Ÿæˆ·èµ„æºéš”ç¦»
- **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒå¤§é‡ç§Ÿæˆ·

### 1.2. SaaSåº”ç”¨çš„é‡è¦æ€§

SaaSåº”ç”¨åœ¨ç°ä»£è½¯ä»¶ä¸­è‡³å…³é‡è¦ï¼š

1. **æˆæœ¬æ•ˆç›Š**ï¼šå…±äº«èµ„æºé™ä½æˆæœ¬
2. **å¿«é€Ÿéƒ¨ç½²**ï¼šå¿«é€Ÿä¸ºç§Ÿæˆ·æä¾›æœåŠ¡
3. **ç»Ÿä¸€ç®¡ç†**ï¼šç»Ÿä¸€ç®¡ç†å’Œç»´æŠ¤
4. **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒå¤§è§„æ¨¡ç§Ÿæˆ·

### 1.3. PostgreSQLåœ¨SaaSåº”ç”¨ä¸­çš„ä½ç½®

PostgreSQLé€šè¿‡RLSæ”¯æŒSaaSåº”ç”¨ï¼š

- **è¡Œçº§å®‰å…¨**ï¼šRLSæä¾›è¡Œçº§è®¿é—®æ§åˆ¶
- **ç§Ÿæˆ·éš”ç¦»**ï¼šè‡ªåŠ¨éš”ç¦»ç§Ÿæˆ·æ•°æ®
- **ACIDäº‹åŠ¡**ï¼šä¿è¯æ•°æ®ä¸€è‡´æ€§
- **SQLæ”¯æŒ**ï¼šæ ‡å‡†SQLæŸ¥è¯¢

---

## 2. SaaSåº”ç”¨çš„å½¢å¼åŒ–å®šä¹‰

### 2.1. å¤šç§Ÿæˆ·æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰

#### 2.1.1. SaaSç³»ç»Ÿçš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.1.1ï¼ˆSaaSç³»ç»Ÿï¼‰**ï¼š

SaaSç³»ç»Ÿ SAASSystem æ˜¯ä¸€ä¸ªå››å…ƒç»„ (Tenants, Application, Database, Isolation)ï¼Œå…¶ä¸­ï¼š

- **Tenants**ï¼šç§Ÿæˆ·é›†åˆï¼ŒTenants = {tâ‚, tâ‚‚, ..., tâ‚™}
- **Application**ï¼šåº”ç”¨å®ä¾‹
- **Database**ï¼šæ•°æ®åº“å®ä¾‹
- **Isolation**ï¼šéš”ç¦»æœºåˆ¶

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
SAASSystem = (Tenants, Application, Database, Isolation)
å…¶ä¸­ï¼š
  Tenants = {tâ‚, tâ‚‚, ..., tâ‚™}
  Application: å…±äº«åº”ç”¨å®ä¾‹
  Database: å…±äº«æ•°æ®åº“å®ä¾‹
  Isolation: ç§Ÿæˆ·éš”ç¦»æœºåˆ¶
```

**SaaSç³»ç»Ÿçš„æ€§è´¨**ï¼š

**æ€§è´¨2.1.1ï¼ˆSaaSç³»ç»Ÿçš„å¤šç§Ÿæˆ·æ€§ï¼‰**ï¼š

SaaSç³»ç»Ÿæ”¯æŒå¤šä¸ªç§Ÿæˆ·å…±äº«åŒä¸€åº”ç”¨å®ä¾‹ã€‚

**å½¢å¼åŒ–**ï¼š

```text
å¤šç§Ÿæˆ·æ€§ âŸº
  |Tenants| > 1 âˆ§
  æ‰€æœ‰ç§Ÿæˆ·å…±äº«Application âˆ§
  æ‰€æœ‰ç§Ÿæˆ·å…±äº«Database
```

#### 2.1.2. ç§Ÿæˆ·çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.1.2ï¼ˆç§Ÿæˆ·ï¼‰**ï¼š

ç§Ÿæˆ· Tenant æ˜¯ä¸€ä¸ªä¸‰å…ƒç»„ (tenant_id, data, permissions)ï¼Œå…¶ä¸­ï¼š

- **tenant_id**ï¼šç§Ÿæˆ·æ ‡è¯†ç¬¦
- **data**ï¼šç§Ÿæˆ·æ•°æ®é›†åˆ
- **permissions**ï¼šç§Ÿæˆ·æƒé™é›†åˆ

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
Tenant = (tenant_id, data, permissions)
å…¶ä¸­ï¼š
  tenant_id âˆˆ TenantID
  data âŠ† Database
  permissions âŠ† PermissionSet
```

#### 2.1.3. ç§Ÿæˆ·éš”ç¦»çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.1.3ï¼ˆç§Ÿæˆ·éš”ç¦»ï¼‰**ï¼š

ç§Ÿæˆ·éš”ç¦» TenantIsolation è¦æ±‚ä¸åŒç§Ÿæˆ·çš„æ•°æ®ç›¸äº’ä¸å¯è®¿é—®ï¼š

```text
ç§Ÿæˆ·éš”ç¦» âŸº
  âˆ€Tenantâ‚, Tenantâ‚‚, tenantâ‚ â‰  tenantâ‚‚.
    Tenantâ‚.data âˆ© Tenantâ‚‚.data = âˆ…
```

### 2.2. å¤šç§Ÿæˆ·æ•°æ®åº“çš„å½¢å¼åŒ–å®šä¹‰

#### 2.2.1. RLSç­–ç•¥çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.2.1ï¼ˆRLSç­–ç•¥ï¼‰**ï¼š

RLSç­–ç•¥ RLSPolicy æ˜¯ä¸€ä¸ªä¸‰å…ƒç»„ (policy_name, policy_type, policy_expression)ï¼Œå…¶ä¸­ï¼š

- **policy_name**ï¼šç­–ç•¥åç§°
- **policy_type**ï¼šç­–ç•¥ç±»å‹ï¼ˆSELECTã€INSERTã€UPDATEã€DELETEã€ALLï¼‰
- **policy_expression**ï¼šç­–ç•¥è¡¨è¾¾å¼ï¼Œè¿”å›å¸ƒå°”å€¼

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
RLSPolicy = (policy_name, policy_type, policy_expression)
å…¶ä¸­ï¼š
  policy_name: String
  policy_type âˆˆ {SELECT, INSERT, UPDATE, DELETE, ALL}
  policy_expression: Row â†’ Bool
```

**RLSç­–ç•¥çš„è¯­ä¹‰**ï¼š

**å®šä¹‰2.2.2ï¼ˆRLSç­–ç•¥è¯­ä¹‰ï¼‰**ï¼š

RLSç­–ç•¥çš„è¯­ä¹‰æ˜¯è¿‡æ»¤è¡Œï¼š

```text
[[RLSPolicy]]_Table = {
    row | row âˆˆ Table,
    RLSPolicy.policy_expression(row) = True
}
```

#### 2.2.2. ç§Ÿæˆ·æ•°æ®çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.2.3ï¼ˆç§Ÿæˆ·æ•°æ®ï¼‰**ï¼š

ç§Ÿæˆ·æ•°æ® TenantData æ˜¯åŒ…å«ç§Ÿæˆ·IDçš„æ•°æ®ï¼š

```text
TenantData = {
    row | row âˆˆ Table,
    row.tenant_id = current_tenant_id()
}
```

#### 2.2.3. ç§Ÿæˆ·æŸ¥è¯¢çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.2.4ï¼ˆç§Ÿæˆ·æŸ¥è¯¢ï¼‰**ï¼š

ç§Ÿæˆ·æŸ¥è¯¢ TenantQuery è‡ªåŠ¨åº”ç”¨RLSç­–ç•¥ï¼š

```text
ç§Ÿæˆ·æŸ¥è¯¢(query) = {
    row | row âˆˆ [[query]]_Table,
    RLSPolicy.policy_expression(row) = True
}
```

### 2.3. SaaSåº”ç”¨æ€§è´¨çš„å½¢å¼åŒ–è¯æ˜

#### 2.3.1. ç§Ÿæˆ·éš”ç¦»çš„å½¢å¼åŒ–è¯æ˜

**å®šç†2.3.1ï¼ˆRLSç§Ÿæˆ·éš”ç¦»æ€§ï¼‰**ï¼š

RLSä¿è¯ç§Ÿæˆ·æ•°æ®çš„å®Œå…¨éš”ç¦»ã€‚

**è¯æ˜**ï¼š

**æ­¥éª¤1**ï¼šå®šä¹‰éš”ç¦»æ€§

éš”ç¦»æ€§è¦æ±‚ç§Ÿæˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®ã€‚

**æ­¥éª¤2**ï¼šéªŒè¯RLSç­–ç•¥

RLSç­–ç•¥é€šè¿‡ç­–ç•¥è¡¨è¾¾å¼è¿‡æ»¤è¡Œï¼Œç¡®ä¿ç§Ÿæˆ·åªèƒ½è®¿é—®æ»¡è¶³æ¡ä»¶çš„è¡Œã€‚

**æ­¥éª¤3**ï¼šç»“è®º

å› æ­¤RLSä¿è¯ç§Ÿæˆ·æ•°æ®çš„å®Œå…¨éš”ç¦» âœ…

#### 2.3.2. æ•°æ®å®‰å…¨çš„å½¢å¼åŒ–è¯æ˜

**å®šç†2.3.2ï¼ˆRLSæ•°æ®å®‰å…¨æ€§ï¼‰**ï¼š

RLSç­–ç•¥åœ¨æ•°æ®åº“å±‚é¢å¼ºåˆ¶æ‰§è¡Œï¼Œæ— æ³•ç»•è¿‡ã€‚

**è¯æ˜**ï¼š

**æ­¥éª¤1**ï¼šå®šä¹‰å®‰å…¨æ€§

å®‰å…¨æ€§è¦æ±‚ç­–ç•¥åœ¨æ•°æ®åº“å±‚é¢å¼ºåˆ¶æ‰§è¡Œã€‚

**æ­¥éª¤2**ï¼šéªŒè¯RLSå®ç°

RLSåœ¨æŸ¥è¯¢æ‰§è¡Œæ—¶è‡ªåŠ¨åº”ç”¨ç­–ç•¥ï¼Œæ— æ³•ç»•è¿‡ã€‚

**æ­¥éª¤3**ï¼šç»“è®º

å› æ­¤RLSç­–ç•¥åœ¨æ•°æ®åº“å±‚é¢å¼ºåˆ¶æ‰§è¡Œ âœ…

#### 2.3.3. æ€§èƒ½éš”ç¦»çš„å½¢å¼åŒ–è¯æ˜

**æ€§è´¨2.3.1ï¼ˆæ€§èƒ½éš”ç¦»ï¼‰**ï¼š

SaaSç³»ç»Ÿåº”è¯¥ä¿è¯ç§Ÿæˆ·ä¹‹é—´çš„æ€§èƒ½éš”ç¦»ã€‚

**å½¢å¼åŒ–**ï¼š

```text
æ€§èƒ½éš”ç¦» âŸº
  âˆ€Tenantâ‚, Tenantâ‚‚, tenantâ‚ â‰  tenantâ‚‚.
    æ€§èƒ½(Tenantâ‚) ä¸å— Tenantâ‚‚ å½±å“
```

---

## 3. SaaSåº”ç”¨æ¶æ„çš„å½¢å¼åŒ–ç†è®º

### 3.1. å¤šç§Ÿæˆ·æ¶æ„çš„å½¢å¼åŒ–å®šä¹‰

#### 3.1.1. å…±äº«æ•°æ®åº“å…±äº«Schemaæ¨¡å¼

**å®šä¹‰3.1.1ï¼ˆå…±äº«æ•°æ®åº“å…±äº«Schemaæ¨¡å¼ï¼‰**ï¼š

å…±äº«æ•°æ®åº“å…±äº«Schemaæ¨¡å¼ SharedDatabaseSharedSchema ä¸­ï¼Œæ‰€æœ‰ç§Ÿæˆ·å…±äº«åŒä¸€ä¸ªæ•°æ®åº“å’ŒSchemaï¼š

```text
å…±äº«æ¨¡å¼ = (DB, Schema, RLS_Policies)
å…¶ä¸­ï¼š
  DB: å•ä¸ªæ•°æ®åº“
  Schema: å•ä¸ªSchema
  RLS_Policies: {Policy | Policyéš”ç¦»ç§Ÿæˆ·æ•°æ®}
```

**æ¨¡å¼çš„æ€§è´¨**ï¼š

**æ€§è´¨3.1.1ï¼ˆå…±äº«æ¨¡å¼çš„ç»æµæ€§ï¼‰**ï¼š

å…±äº«æ¨¡å¼èµ„æºåˆ©ç”¨ç‡é«˜ï¼Œæˆæœ¬ä½ã€‚

**å½¢å¼åŒ–**ï¼š

```text
ç»æµæ€§ âŸº
  èµ„æºåˆ©ç”¨ç‡ = é«˜
  æˆæœ¬ = ä½
```

#### 3.1.2. å…±äº«æ•°æ®åº“ç‹¬ç«‹Schemaæ¨¡å¼

**å®šä¹‰3.1.2ï¼ˆå…±äº«æ•°æ®åº“ç‹¬ç«‹Schemaæ¨¡å¼ï¼‰**ï¼š

å…±äº«æ•°æ®åº“ç‹¬ç«‹Schemaæ¨¡å¼ SharedDatabaseIndependentSchema ä¸­ï¼Œæ‰€æœ‰ç§Ÿæˆ·å…±äº«æ•°æ®åº“ä½†ä½¿ç”¨ç‹¬ç«‹Schemaï¼š

```text
ç‹¬ç«‹Schemaæ¨¡å¼ = (DB, Schemas, Schema_Isolation)
å…¶ä¸­ï¼š
  DB: å•ä¸ªæ•°æ®åº“
  Schemas = {Schemaâ‚, Schemaâ‚‚, ..., Schemaâ‚™}
  Schema_Isolation: Schema â†’ Tenant
```

#### 3.1.3. ç‹¬ç«‹æ•°æ®åº“æ¨¡å¼

**å®šä¹‰3.1.3ï¼ˆç‹¬ç«‹æ•°æ®åº“æ¨¡å¼ï¼‰**ï¼š

ç‹¬ç«‹æ•°æ®åº“æ¨¡å¼ IndependentDatabase ä¸­ï¼Œæ¯ä¸ªç§Ÿæˆ·ä½¿ç”¨ç‹¬ç«‹æ•°æ®åº“ï¼š

```text
ç‹¬ç«‹æ•°æ®åº“æ¨¡å¼ = (Databases, DB_Isolation)
å…¶ä¸­ï¼š
  Databases = {DBâ‚, DBâ‚‚, ..., DBâ‚™}
  DB_Isolation: Database â†’ Tenant
```

### 3.2. SaaSåº”ç”¨æ¶æ„å¯¹æ¯”çŸ©é˜µ

| æ¶æ„æ¨¡å¼ | éš”ç¦»æ€§ | èµ„æºåˆ©ç”¨ç‡ | ç®¡ç†å¤æ‚åº¦ | æˆæœ¬ | æ€§èƒ½ | é€‚ç”¨åœºæ™¯ |
|---------|--------|-----------|-----------|------|------|---------|
| **å…±äº«æ•°æ®åº“å…±äº«Schema+RLS** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | å¤§é‡ç§Ÿæˆ· |
| **å…±äº«æ•°æ®åº“ç‹¬ç«‹Schema** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­â­ | ä¸­ç­‰ç§Ÿæˆ· |
| **ç‹¬ç«‹æ•°æ®åº“** | â­â­â­â­â­ | â­â­ | â­â­ | â­â­ | â­â­â­â­â­ | å°‘é‡ç§Ÿæˆ· |

### 3.3. SaaSåº”ç”¨æ¶æ„é€‰æ‹©å†³ç­–æ ‘

```mermaid
flowchart TD
    A[é€‰æ‹©SaaSåº”ç”¨æ¶æ„] --> B{ç§Ÿæˆ·æ•°é‡}
    B -->|å°‘é‡<100| C[ç‹¬ç«‹æ•°æ®åº“æ¨¡å¼]
    B -->|ä¸­ç­‰100-1000| D{æ•°æ®éš”ç¦»è¦æ±‚}
    B -->|å¤§é‡>1000| E[å…±äº«æ•°æ®åº“å…±äº«Schema+RLS âœ…]

    D -->|ä¸¥æ ¼éš”ç¦»| F[å…±äº«æ•°æ®åº“ç‹¬ç«‹Schema]
    D -->|ä¸€èˆ¬éš”ç¦»| E

    C --> G{èµ„æºæˆæœ¬}
    F --> H{ç®¡ç†å¤æ‚åº¦}
    E --> I{æ€§èƒ½è¦æ±‚}

    G -->|æˆæœ¬å¯æ¥å—| J[ç‹¬ç«‹æ•°æ®åº“æ¨¡å¼ âœ…]
    G -->|æˆæœ¬æ•æ„Ÿ| K[å…±äº«æ¨¡å¼]

    H -->|å¯æ¥å—| L[ç‹¬ç«‹Schemaæ¨¡å¼ âœ…]
    H -->|ç®€åŒ–ç®¡ç†| M[å…±äº«Schema+RLS]

    I -->|é«˜æ€§èƒ½| N[ç‹¬ç«‹æ•°æ®åº“/ç‹¬ç«‹Schema]
    I -->|å¹³è¡¡| O[å…±äº«Schema+RLS âœ…]

    J --> P[éªŒè¯éš”ç¦»éœ€æ±‚]
    K --> P
    L --> P
    M --> P
    N --> P
    O --> P

    P --> Q{éš”ç¦»æ»¡è¶³?}
    Q -->|æ˜¯| R[SaaSåº”ç”¨æ¶æ„é€‰æ‹©å®Œæˆ âœ…]
    Q -->|å¦| S[è°ƒæ•´æ¶æ„]
    S --> B
```

---

## 4. PostgreSQL SaaSåº”ç”¨æ–¹æ¡ˆä¸å…¶ä»–æ–¹æ¡ˆçš„å¯¹æ¯”

### 4.1. åŠŸèƒ½å¯¹æ¯”çŸ©é˜µ

| åŠŸèƒ½ | PostgreSQL+RLS | åº”ç”¨å±‚éš”ç¦» | ç‹¬ç«‹Schema | ç‹¬ç«‹æ•°æ®åº“ |
|------|---------------|-----------|-----------|-----------|
| **æ•°æ®åº“å±‚éš”ç¦»** | âœ… | âŒ | âœ… | âœ… |
| **ç­–ç•¥çµæ´»æ€§** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| **æ€§èƒ½å¼€é”€** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| **ç®¡ç†å¤æ‚åº¦** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | â­â­ |
| **æˆæœ¬** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­ |

### 4.2. æ€§èƒ½å¯¹æ¯”çŸ©é˜µ

| æ€§èƒ½æŒ‡æ ‡ | PostgreSQL+RLS | åº”ç”¨å±‚éš”ç¦» | ç‹¬ç«‹Schema | ç‹¬ç«‹æ•°æ®åº“ |
|---------|---------------|-----------|-----------|-----------|
| **æŸ¥è¯¢æ€§èƒ½** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| **éš”ç¦»æ€§èƒ½** | â­â­â­â­â­ | â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| **æ‰©å±•æ€§** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |

### 4.3. PostgreSQL SaaSåº”ç”¨æ–¹æ¡ˆé€‰æ‹©å†³ç­–æ ‘

```mermaid
flowchart TD
    A[é€‰æ‹©SaaSåº”ç”¨æ–¹æ¡ˆ] --> B{ç§Ÿæˆ·æ•°é‡}
    B -->|å°‘é‡<100| C[ç‹¬ç«‹æ•°æ®åº“ âœ…]
    B -->|ä¸­ç­‰100-1000| D{éš”ç¦»è¦æ±‚}
    B -->|å¤§é‡>1000| E[RLSç­–ç•¥ âœ…]

    D -->|ä¸¥æ ¼éš”ç¦»| F[ç‹¬ç«‹Schema]
    D -->|ä¸€èˆ¬éš”ç¦»| E

    C --> G{èµ„æºæˆæœ¬}
    F --> H{ç®¡ç†å¤æ‚åº¦}
    E --> I{æ€§èƒ½è¦æ±‚}

    G -->|æˆæœ¬å¯æ¥å—| J[ç‹¬ç«‹æ•°æ®åº“ âœ…]
    G -->|æˆæœ¬æ•æ„Ÿ| K[RLSç­–ç•¥]

    H -->|å¯æ¥å—| L[ç‹¬ç«‹Schema âœ…]
    H -->|ç®€åŒ–ç®¡ç†| M[RLSç­–ç•¥]

    I -->|é«˜æ€§èƒ½| N[ç‹¬ç«‹æ•°æ®åº“/ç‹¬ç«‹Schema]
    I -->|å¹³è¡¡| O[RLSç­–ç•¥ âœ…]

    J --> P[éªŒè¯éœ€æ±‚]
    K --> P
    L --> P
    M --> P
    N --> P
    O --> P

    P --> Q{éœ€æ±‚æ»¡è¶³?}
    Q -->|æ˜¯| R[SaaSåº”ç”¨æ–¹æ¡ˆé€‰æ‹©å®Œæˆ âœ…]
    Q -->|å¦| S[è°ƒæ•´æ–¹æ¡ˆ]
    S --> B
```

---

## 5. åº”ç”¨åœºæ™¯çš„å½¢å¼åŒ–åˆ†æ

### 5.1. å¤šç§Ÿæˆ·SaaSçš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰5.1.1ï¼ˆå¤šç§Ÿæˆ·SaaSç³»ç»Ÿï¼‰**ï¼š

å¤šç§Ÿæˆ·SaaSç³»ç»Ÿ MultiTenantSAAS æ˜¯ä¸€ä¸ªå››å…ƒç»„ (Tenants, Application, Database, Isolation)ï¼Œå…¶ä¸­ï¼š

- **Tenants**ï¼šç§Ÿæˆ·é›†åˆ
- **Application**ï¼šå…±äº«åº”ç”¨å®ä¾‹
- **Database**ï¼šå…±äº«æ•°æ®åº“å®ä¾‹
- **Isolation**ï¼šç§Ÿæˆ·éš”ç¦»æœºåˆ¶ï¼ˆRLSï¼‰

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
MultiTenantSAAS = (Tenants, Application, Database, Isolation)
å…¶ä¸­ï¼š
  Tenants = {tâ‚, tâ‚‚, ..., tâ‚™}
  Application: å…±äº«åº”ç”¨å®ä¾‹
  Database: PostgreSQL + RLS
  Isolation: RLSPolicy
```

### 5.2. ç§Ÿæˆ·æ•°æ®è¿ç§»çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰5.2.1ï¼ˆç§Ÿæˆ·æ•°æ®è¿ç§»ï¼‰**ï¼š

ç§Ÿæˆ·æ•°æ®è¿ç§» TenantDataMigration æ˜¯å°†ç§Ÿæˆ·æ•°æ®ä»ä¸€ä¸ªä½ç½®è¿ç§»åˆ°å¦ä¸€ä¸ªä½ç½®ï¼š

```text
ç§Ÿæˆ·æ•°æ®è¿ç§»(Tenant, Source, Target) =
    å¤åˆ¶(Tenant.data, Source) â†’ Target
```

**è¿ç§»çš„æ­£ç¡®æ€§å½¢å¼åŒ–å®šä¹‰**ï¼š

**å®šä¹‰5.2.2ï¼ˆè¿ç§»çš„æ­£ç¡®æ€§ï¼‰**ï¼š

è¿ç§»çš„æ­£ç¡®æ€§è¦æ±‚è¿ç§»åæ•°æ®å®Œæ•´ä¸”ä¸€è‡´ï¼š

```text
è¿ç§»æ­£ç¡®æ€§ âŸº
  æ•°æ®å®Œæ•´æ€§(è¿ç§»å) âˆ§
  æ•°æ®ä¸€è‡´æ€§(è¿ç§»å)
```

### 5.3. ç§Ÿæˆ·æ‰©å±•çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰5.3.1ï¼ˆç§Ÿæˆ·æ‰©å±•ï¼‰**ï¼š

ç§Ÿæˆ·æ‰©å±• TenantScaling æ˜¯æ”¯æŒç§Ÿæˆ·æ•°é‡çš„å¢é•¿ï¼š

```text
ç§Ÿæˆ·æ‰©å±•(SaaSç³»ç»Ÿ, æ–°ç§Ÿæˆ·) =
    SaaSç³»ç»Ÿ âˆª {æ–°ç§Ÿæˆ·}
```

**æ‰©å±•çš„æ€§è´¨**ï¼š

**æ€§è´¨5.3.1ï¼ˆæ‰©å±•çš„é€æ˜æ€§ï¼‰**ï¼š

ç§Ÿæˆ·æ‰©å±•å¯¹ç°æœ‰ç§Ÿæˆ·é€æ˜ã€‚

**å½¢å¼åŒ–**ï¼š

```text
é€æ˜æ€§ âŸº
  âˆ€ç°æœ‰ç§Ÿæˆ·t.
    æ€§èƒ½(t) ä¸å— æ–°ç§Ÿæˆ· å½±å“
```

---

## 6. å‚è€ƒèµ„æ–™

### 6.1. ç»å…¸æ–‡çŒ®

- PostgreSQL RLSå®˜æ–¹æ–‡æ¡£ï¼š<https://www.postgresql.org/docs/current/ddl-rowsecurity.html>
- "Multi-Tenant Data Architecture" (Chong et al., 2006)
- "Row-Level Security in PostgreSQL" (PostgreSQLå®˜æ–¹æ–‡æ¡£)

### 6.2. ç›¸å…³èµ„æº

- [PostgreSQL RLSæ–‡æ¡£](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)
- [å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)
- [SaaSæ•°æ®åº“è®¾è®¡](https://www.citusdata.com/blog/2016/10/25/designing-your-saas-database-for-multi-tenancy/)

---

**æœ€åæ›´æ–°**ï¼š2025-01-15
**ç»´æŠ¤è€…**ï¼šData-Science Team
**çŠ¶æ€**ï¼šè¿›è¡Œä¸­
