# PostgreSQLæ‰©å±•ï¼šå¾®æœåŠ¡åº”ç”¨åœºæ™¯å½¢å¼åŒ–ç†è®ºåˆ†æ

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-01-15
> **ç‰ˆæœ¬**ï¼šv1.0
> **çŠ¶æ€**ï¼šè¿›è¡Œä¸­

---

## ğŸ“‹ ç›®å½•

- [PostgreSQLæ‰©å±•ï¼šå¾®æœåŠ¡åº”ç”¨åœºæ™¯å½¢å¼åŒ–ç†è®ºåˆ†æ](#postgresqlæ‰©å±•å¾®æœåŠ¡åº”ç”¨åœºæ™¯å½¢å¼åŒ–ç†è®ºåˆ†æ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1. å¾®æœåŠ¡åº”ç”¨ç®€ä»‹](#11-å¾®æœåŠ¡åº”ç”¨ç®€ä»‹)
    - [1.2. å¾®æœåŠ¡åº”ç”¨çš„é‡è¦æ€§](#12-å¾®æœåŠ¡åº”ç”¨çš„é‡è¦æ€§)
    - [1.3. PostgreSQLåœ¨å¾®æœåŠ¡åº”ç”¨ä¸­çš„ä½ç½®](#13-postgresqlåœ¨å¾®æœåŠ¡åº”ç”¨ä¸­çš„ä½ç½®)
  - [2. å¾®æœåŠ¡åº”ç”¨çš„å½¢å¼åŒ–å®šä¹‰](#2-å¾®æœåŠ¡åº”ç”¨çš„å½¢å¼åŒ–å®šä¹‰)
    - [2.1. å¾®æœåŠ¡æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰](#21-å¾®æœåŠ¡æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰)
      - [2.1.1. å¾®æœåŠ¡ç³»ç»Ÿçš„å½¢å¼åŒ–å®šä¹‰](#211-å¾®æœåŠ¡ç³»ç»Ÿçš„å½¢å¼åŒ–å®šä¹‰)
      - [2.1.2. æœåŠ¡çš„å½¢å¼åŒ–å®šä¹‰](#212-æœåŠ¡çš„å½¢å¼åŒ–å®šä¹‰)
      - [2.1.3. æœåŠ¡é—´é€šä¿¡çš„å½¢å¼åŒ–å®šä¹‰](#213-æœåŠ¡é—´é€šä¿¡çš„å½¢å¼åŒ–å®šä¹‰)
    - [2.2. æ•°æ®åº“peræœåŠ¡çš„å½¢å¼åŒ–å®šä¹‰](#22-æ•°æ®åº“peræœåŠ¡çš„å½¢å¼åŒ–å®šä¹‰)
      - [2.2.1. æ•°æ®åº“peræœåŠ¡æ¨¡å¼çš„å½¢å¼åŒ–å®šä¹‰](#221-æ•°æ®åº“peræœåŠ¡æ¨¡å¼çš„å½¢å¼åŒ–å®šä¹‰)
      - [2.2.2. æœåŠ¡æ•°æ®çš„å½¢å¼åŒ–å®šä¹‰](#222-æœåŠ¡æ•°æ®çš„å½¢å¼åŒ–å®šä¹‰)
      - [2.2.3. æ•°æ®ä¸€è‡´æ€§çš„å½¢å¼åŒ–å®šä¹‰](#223-æ•°æ®ä¸€è‡´æ€§çš„å½¢å¼åŒ–å®šä¹‰)
    - [2.3. åˆ†å¸ƒå¼äº‹åŠ¡çš„å½¢å¼åŒ–å®šä¹‰](#23-åˆ†å¸ƒå¼äº‹åŠ¡çš„å½¢å¼åŒ–å®šä¹‰)
      - [2.3.1. Sagaæ¨¡å¼çš„å½¢å¼åŒ–å®šä¹‰](#231-sagaæ¨¡å¼çš„å½¢å¼åŒ–å®šä¹‰)
      - [2.3.2. ä¸¤é˜¶æ®µæäº¤çš„å½¢å¼åŒ–å®šä¹‰](#232-ä¸¤é˜¶æ®µæäº¤çš„å½¢å¼åŒ–å®šä¹‰)
      - [2.3.3. æœ€ç»ˆä¸€è‡´æ€§çš„å½¢å¼åŒ–å®šä¹‰](#233-æœ€ç»ˆä¸€è‡´æ€§çš„å½¢å¼åŒ–å®šä¹‰)
  - [3. å¾®æœåŠ¡æ¶æ„çš„å½¢å¼åŒ–ç†è®º](#3-å¾®æœåŠ¡æ¶æ„çš„å½¢å¼åŒ–ç†è®º)
    - [3.1. æ•°æ®åº“peræœåŠ¡æ¶æ„çš„å½¢å¼åŒ–å®šä¹‰](#31-æ•°æ®åº“peræœåŠ¡æ¶æ„çš„å½¢å¼åŒ–å®šä¹‰)
      - [3.1.1. æœåŠ¡æ•°æ®åº“çš„å½¢å¼åŒ–å®šä¹‰](#311-æœåŠ¡æ•°æ®åº“çš„å½¢å¼åŒ–å®šä¹‰)
      - [3.1.2. æ•°æ®æ‰€æœ‰æƒçš„å½¢å¼åŒ–å®šä¹‰](#312-æ•°æ®æ‰€æœ‰æƒçš„å½¢å¼åŒ–å®šä¹‰)
      - [3.1.3. æœåŠ¡ç‹¬ç«‹æ€§çš„å½¢å¼åŒ–å®šä¹‰](#313-æœåŠ¡ç‹¬ç«‹æ€§çš„å½¢å¼åŒ–å®šä¹‰)
    - [3.2. åˆ†å¸ƒå¼äº‹åŠ¡æ¶æ„çš„å½¢å¼åŒ–å®šä¹‰](#32-åˆ†å¸ƒå¼äº‹åŠ¡æ¶æ„çš„å½¢å¼åŒ–å®šä¹‰)
      - [3.2.1. Sagaæ¨¡å¼çš„å½¢å¼åŒ–å®šä¹‰](#321-sagaæ¨¡å¼çš„å½¢å¼åŒ–å®šä¹‰)
      - [3.2.2. è¡¥å¿äº‹åŠ¡çš„å½¢å¼åŒ–å®šä¹‰](#322-è¡¥å¿äº‹åŠ¡çš„å½¢å¼åŒ–å®šä¹‰)
    - [3.3. å¾®æœåŠ¡æ¶æ„å¯¹æ¯”çŸ©é˜µ](#33-å¾®æœåŠ¡æ¶æ„å¯¹æ¯”çŸ©é˜µ)
    - [3.4. å¾®æœåŠ¡æ¶æ„é€‰æ‹©å†³ç­–æ ‘](#34-å¾®æœåŠ¡æ¶æ„é€‰æ‹©å†³ç­–æ ‘)
  - [4. PostgreSQLå¾®æœåŠ¡åº”ç”¨æ–¹æ¡ˆä¸å…¶ä»–æ–¹æ¡ˆçš„å¯¹æ¯”](#4-postgresqlå¾®æœåŠ¡åº”ç”¨æ–¹æ¡ˆä¸å…¶ä»–æ–¹æ¡ˆçš„å¯¹æ¯”)
    - [4.1. åŠŸèƒ½å¯¹æ¯”çŸ©é˜µ](#41-åŠŸèƒ½å¯¹æ¯”çŸ©é˜µ)
    - [4.2. æ€§èƒ½å¯¹æ¯”çŸ©é˜µ](#42-æ€§èƒ½å¯¹æ¯”çŸ©é˜µ)
    - [4.3. PostgreSQLå¾®æœåŠ¡åº”ç”¨æ–¹æ¡ˆé€‰æ‹©å†³ç­–æ ‘](#43-postgresqlå¾®æœåŠ¡åº”ç”¨æ–¹æ¡ˆé€‰æ‹©å†³ç­–æ ‘)
  - [5. PostgreSQLå¾®æœåŠ¡åº”ç”¨çš„å½¢å¼åŒ–ç†è®º](#5-postgresqlå¾®æœåŠ¡åº”ç”¨çš„å½¢å¼åŒ–ç†è®º)
    - [5.1. PostgreSQLæ•°æ®åº“peræœåŠ¡çš„å½¢å¼åŒ–å®šä¹‰](#51-postgresqlæ•°æ®åº“peræœåŠ¡çš„å½¢å¼åŒ–å®šä¹‰)
      - [5.1.1. PostgreSQLæœåŠ¡æ•°æ®åº“çš„å½¢å¼åŒ–å®šä¹‰](#511-postgresqlæœåŠ¡æ•°æ®åº“çš„å½¢å¼åŒ–å®šä¹‰)
      - [5.1.2. PostgreSQLæœåŠ¡æ•°æ®åº“çš„æ€§è´¨](#512-postgresqlæœåŠ¡æ•°æ®åº“çš„æ€§è´¨)
    - [5.2. PostgreSQLåˆ†å¸ƒå¼äº‹åŠ¡çš„å½¢å¼åŒ–å®šä¹‰](#52-postgresqlåˆ†å¸ƒå¼äº‹åŠ¡çš„å½¢å¼åŒ–å®šä¹‰)
      - [5.2.1. PostgreSQLä¸¤é˜¶æ®µæäº¤çš„å½¢å¼åŒ–å®šä¹‰](#521-postgresqlä¸¤é˜¶æ®µæäº¤çš„å½¢å¼åŒ–å®šä¹‰)
      - [5.2.2. PostgreSQL Sagaæ¨¡å¼çš„å½¢å¼åŒ–å®šä¹‰](#522-postgresql-sagaæ¨¡å¼çš„å½¢å¼åŒ–å®šä¹‰)
    - [5.3. PostgreSQL Citusé›†ç¾¤çš„å½¢å¼åŒ–å®šä¹‰](#53-postgresql-citusé›†ç¾¤çš„å½¢å¼åŒ–å®šä¹‰)
      - [5.3.1. Citusé›†ç¾¤çš„å½¢å¼åŒ–å®šä¹‰](#531-citusé›†ç¾¤çš„å½¢å¼åŒ–å®šä¹‰)
      - [5.3.2. Citusåˆ†ç‰‡çš„å½¢å¼åŒ–å®šä¹‰](#532-citusåˆ†ç‰‡çš„å½¢å¼åŒ–å®šä¹‰)
    - [5.4. PostgreSQLå¾®æœåŠ¡åº”ç”¨çš„æœ€ä½³å®è·µ](#54-postgresqlå¾®æœåŠ¡åº”ç”¨çš„æœ€ä½³å®è·µ)
      - [5.4.1. æ•°æ®åº“peræœåŠ¡çš„æœ€ä½³å®è·µ](#541-æ•°æ®åº“peræœåŠ¡çš„æœ€ä½³å®è·µ)
      - [5.4.2. æœåŠ¡é—´é€šä¿¡çš„æœ€ä½³å®è·µ](#542-æœåŠ¡é—´é€šä¿¡çš„æœ€ä½³å®è·µ)
      - [5.4.3. åˆ†å¸ƒå¼äº‹åŠ¡çš„æœ€ä½³å®è·µ](#543-åˆ†å¸ƒå¼äº‹åŠ¡çš„æœ€ä½³å®è·µ)
  - [6. åº”ç”¨åœºæ™¯çš„å½¢å¼åŒ–åˆ†æ](#6-åº”ç”¨åœºæ™¯çš„å½¢å¼åŒ–åˆ†æ)
    - [6.1. å¾®æœåŠ¡ç³»ç»Ÿçš„å½¢å¼åŒ–å®šä¹‰](#61-å¾®æœåŠ¡ç³»ç»Ÿçš„å½¢å¼åŒ–å®šä¹‰)
    - [6.2. æœåŠ¡æ•°æ®åŒæ­¥çš„å½¢å¼åŒ–å®šä¹‰](#62-æœåŠ¡æ•°æ®åŒæ­¥çš„å½¢å¼åŒ–å®šä¹‰)
    - [6.3. æœåŠ¡æ‰©å±•çš„å½¢å¼åŒ–å®šä¹‰](#63-æœåŠ¡æ‰©å±•çš„å½¢å¼åŒ–å®šä¹‰)
    - [6.4. å¾®æœåŠ¡åº”ç”¨æ¡ˆä¾‹](#64-å¾®æœåŠ¡åº”ç”¨æ¡ˆä¾‹)
      - [6.4.1. ç”µå•†å¾®æœåŠ¡ç³»ç»Ÿ](#641-ç”µå•†å¾®æœåŠ¡ç³»ç»Ÿ)
      - [6.4.2. ç¤¾äº¤å¾®æœåŠ¡ç³»ç»Ÿ](#642-ç¤¾äº¤å¾®æœåŠ¡ç³»ç»Ÿ)
  - [7. PostgreSQLå¾®æœåŠ¡åº”ç”¨çš„æŠ€æœ¯å®ç°](#7-postgresqlå¾®æœåŠ¡åº”ç”¨çš„æŠ€æœ¯å®ç°)
    - [7.1. PostgreSQLæ•°æ®åº“peræœåŠ¡çš„å®ç°](#71-postgresqlæ•°æ®åº“peræœåŠ¡çš„å®ç°)
      - [7.1.1. æœåŠ¡æ•°æ®åº“åˆ›å»º](#711-æœåŠ¡æ•°æ®åº“åˆ›å»º)
      - [7.1.2. æœåŠ¡æ•°æ®åº“Schemaè®¾è®¡](#712-æœåŠ¡æ•°æ®åº“schemaè®¾è®¡)
    - [7.2. PostgreSQLåˆ†å¸ƒå¼äº‹åŠ¡çš„å®ç°](#72-postgresqlåˆ†å¸ƒå¼äº‹åŠ¡çš„å®ç°)
      - [7.2.1. Sagaæ¨¡å¼çš„å®ç°](#721-sagaæ¨¡å¼çš„å®ç°)
      - [7.2.2. Sagaæ‰§è¡Œå‡½æ•°](#722-sagaæ‰§è¡Œå‡½æ•°)
    - [7.3. PostgreSQL Citusé›†ç¾¤çš„å®ç°](#73-postgresql-citusé›†ç¾¤çš„å®ç°)
      - [7.3.1. Citusé›†ç¾¤é…ç½®](#731-citusé›†ç¾¤é…ç½®)
      - [7.3.2. åˆ†å¸ƒå¼è¡¨åˆ›å»º](#732-åˆ†å¸ƒå¼è¡¨åˆ›å»º)
  - [8. å‚è€ƒèµ„æ–™](#8-å‚è€ƒèµ„æ–™)
    - [8.1. ç»å…¸æ–‡çŒ®](#81-ç»å…¸æ–‡çŒ®)
    - [8.2. ç›¸å…³èµ„æº](#82-ç›¸å…³èµ„æº)

---

## 1. æ¦‚è¿°

### 1.1. å¾®æœåŠ¡åº”ç”¨ç®€ä»‹

å¾®æœåŠ¡åº”ç”¨æ˜¯ç°ä»£åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ¶æ„æ¨¡å¼ï¼Œæä¾›ï¼š

- **æœåŠ¡ç‹¬ç«‹æ€§**ï¼šæ¯ä¸ªæœåŠ¡ç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²
- **æ•°æ®åº“peræœåŠ¡**ï¼šæ¯ä¸ªæœåŠ¡ä½¿ç”¨ç‹¬ç«‹æ•°æ®åº“
- **åˆ†å¸ƒå¼äº‹åŠ¡**ï¼šè·¨æœåŠ¡çš„äº‹åŠ¡å¤„ç†
- **æœåŠ¡é€šä¿¡**ï¼šæœåŠ¡é—´é€šè¿‡APIé€šä¿¡

### 1.2. å¾®æœåŠ¡åº”ç”¨çš„é‡è¦æ€§

å¾®æœåŠ¡åº”ç”¨åœ¨ç°ä»£ç³»ç»Ÿä¸­è‡³å…³é‡è¦ï¼š

1. **å¯æ‰©å±•æ€§**ï¼šç‹¬ç«‹æ‰©å±•å„ä¸ªæœåŠ¡
2. **æŠ€æœ¯å¤šæ ·æ€§**ï¼šä¸åŒæœåŠ¡å¯ä»¥ä½¿ç”¨ä¸åŒæŠ€æœ¯æ ˆ
3. **æ•…éšœéš”ç¦»**ï¼šæœåŠ¡æ•…éšœä¸å½±å“å…¶ä»–æœåŠ¡
4. **å›¢é˜Ÿè‡ªæ²»**ï¼šå›¢é˜Ÿå¯ä»¥ç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²

### 1.3. PostgreSQLåœ¨å¾®æœåŠ¡åº”ç”¨ä¸­çš„ä½ç½®

PostgreSQLåœ¨å¾®æœåŠ¡åº”ç”¨ä¸­æä¾›ï¼š

- **æœåŠ¡æ•°æ®åº“**ï¼šæ¯ä¸ªæœåŠ¡ä½¿ç”¨ç‹¬ç«‹PostgreSQLå®ä¾‹
- **åˆ†å¸ƒå¼äº‹åŠ¡**ï¼šæ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†
- **æ•°æ®å¤åˆ¶**ï¼šæ”¯æŒæœåŠ¡é—´æ•°æ®å¤åˆ¶
- **ACIDä¿è¯**ï¼šä¿è¯æœåŠ¡å†…æ•°æ®ä¸€è‡´æ€§

---

## 2. å¾®æœåŠ¡åº”ç”¨çš„å½¢å¼åŒ–å®šä¹‰

### 2.1. å¾®æœåŠ¡æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰

#### 2.1.1. å¾®æœåŠ¡ç³»ç»Ÿçš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.1.1ï¼ˆå¾®æœåŠ¡ç³»ç»Ÿï¼‰**ï¼š

å¾®æœåŠ¡ç³»ç»Ÿ MicroserviceSystem æ˜¯ä¸€ä¸ªä¸‰å…ƒç»„ (Services, Databases, Communication)ï¼Œå…¶ä¸­ï¼š

- **Services**ï¼šæœåŠ¡é›†åˆï¼ŒServices = {Sâ‚, Sâ‚‚, ..., Sâ‚™}
- **Databases**ï¼šæ•°æ®åº“é›†åˆï¼ŒDatabases = {DBâ‚, DBâ‚‚, ..., DBâ‚™}
- **Communication**ï¼šæœåŠ¡é—´é€šä¿¡åè®®

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
MicroserviceSystem = (Services, Databases, Communication)
å…¶ä¸­ï¼š
  Services = {Sâ‚, Sâ‚‚, ..., Sâ‚™}
  Databases = {DBâ‚, DBâ‚‚, ..., DBâ‚™}
  Communication: Service Ã— Service â†’ Protocol
```

**å¾®æœåŠ¡ç³»ç»Ÿçš„æ€§è´¨**ï¼š

**æ€§è´¨2.1.1ï¼ˆå¾®æœåŠ¡ç³»ç»Ÿçš„ç‹¬ç«‹æ€§ï¼‰**ï¼š

æ¯ä¸ªæœåŠ¡ç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²ã€‚

**å½¢å¼åŒ–**ï¼š

```text
ç‹¬ç«‹æ€§ âŸº
  âˆ€Serviceáµ¢ âˆˆ Services.
    Serviceáµ¢ç‹¬ç«‹å¼€å‘ âˆ§
    Serviceáµ¢ç‹¬ç«‹éƒ¨ç½²
```

#### 2.1.2. æœåŠ¡çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.1.2ï¼ˆæœåŠ¡ï¼‰**ï¼š

æœåŠ¡ Service æ˜¯ä¸€ä¸ªä¸‰å…ƒç»„ (service_id, database, api)ï¼Œå…¶ä¸­ï¼š

- **service_id**ï¼šæœåŠ¡æ ‡è¯†ç¬¦
- **database**ï¼šæœåŠ¡æ•°æ®åº“
- **api**ï¼šæœåŠ¡APIæ¥å£

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
Service = (service_id, database, api)
å…¶ä¸­ï¼š
  service_id âˆˆ ServiceID
  database: Database
  api: APIInterface
```

#### 2.1.3. æœåŠ¡é—´é€šä¿¡çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.1.3ï¼ˆæœåŠ¡é—´é€šä¿¡ï¼‰**ï¼š

æœåŠ¡é—´é€šä¿¡ InterServiceCommunication é€šè¿‡APIè°ƒç”¨ï¼š

```text
æœåŠ¡é—´é€šä¿¡(Serviceâ‚, Serviceâ‚‚, request) =
    Serviceâ‚‚.api(Serviceâ‚.request)
```

### 2.2. æ•°æ®åº“peræœåŠ¡çš„å½¢å¼åŒ–å®šä¹‰

#### 2.2.1. æ•°æ®åº“peræœåŠ¡æ¨¡å¼çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.2.1ï¼ˆæ•°æ®åº“peræœåŠ¡ï¼‰**ï¼š

æ•°æ®åº“peræœåŠ¡ DatabasePerService è¦æ±‚æ¯ä¸ªæœåŠ¡ä½¿ç”¨ç‹¬ç«‹æ•°æ®åº“ï¼š

```text
æ•°æ®åº“peræœåŠ¡ âŸº
  âˆ€Serviceáµ¢ âˆˆ Services.
    âˆƒ!DBáµ¢ âˆˆ Databases.
      Serviceáµ¢ä½¿ç”¨DBáµ¢
```

**æ•°æ®åº“peræœåŠ¡çš„æ€§è´¨**ï¼š

**æ€§è´¨2.2.1ï¼ˆæ•°æ®åº“peræœåŠ¡çš„ç‹¬ç«‹æ€§ï¼‰**ï¼š

æ¯ä¸ªæœåŠ¡çš„æ•°æ®åº“ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰°ã€‚

**å½¢å¼åŒ–**ï¼š

```text
ç‹¬ç«‹æ€§ âŸº
  âˆ€Serviceáµ¢, Serviceâ±¼ âˆˆ Services, i â‰  j.
    DBáµ¢ âˆ© DBâ±¼ = âˆ…
```

#### 2.2.2. æœåŠ¡æ•°æ®çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.2.2ï¼ˆæœåŠ¡æ•°æ®ï¼‰**ï¼š

æœåŠ¡æ•°æ® ServiceData æ˜¯æœåŠ¡æ‹¥æœ‰çš„æ•°æ®ï¼š

```text
ServiceData(Service) = {
    data | data âˆˆ Database(Service)
}
```

#### 2.2.3. æ•°æ®ä¸€è‡´æ€§çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.2.3ï¼ˆæ•°æ®ä¸€è‡´æ€§ï¼‰**ï¼š

æ•°æ®ä¸€è‡´æ€§ DataConsistency è¦æ±‚æœåŠ¡å†…æ•°æ®ä¸€è‡´ï¼š

```text
æ•°æ®ä¸€è‡´æ€§ âŸº
  âˆ€Serviceáµ¢ âˆˆ Services.
    ä¸€è‡´æ€§çº¦æŸ(DBáµ¢) æ»¡è¶³
```

### 2.3. åˆ†å¸ƒå¼äº‹åŠ¡çš„å½¢å¼åŒ–å®šä¹‰

#### 2.3.1. Sagaæ¨¡å¼çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.3.1ï¼ˆSagaæ¨¡å¼ï¼‰**ï¼š

Sagaæ¨¡å¼ SagaPattern æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸€ç§æ¨¡å¼ï¼š

```text
Saga = (Steps, CompensationSteps)
å…¶ä¸­ï¼š
  Steps = {Stepâ‚, Stepâ‚‚, ..., Stepâ‚™}
  CompensationSteps = {Compensationâ‚, Compensationâ‚‚, ..., Compensationâ‚™}
```

**Sagaæ‰§è¡Œçš„å½¢å¼åŒ–å®šä¹‰**ï¼š

**å®šä¹‰2.3.2ï¼ˆSagaæ‰§è¡Œï¼‰**ï¼š

Sagaæ‰§è¡ŒæŒ‰é¡ºåºæ‰§è¡Œæ­¥éª¤ï¼Œå¦‚æœå¤±è´¥åˆ™æ‰§è¡Œè¡¥å¿ï¼š

```text
Sagaæ‰§è¡Œ =
    for step in Steps:
        if stepæ‰§è¡Œå¤±è´¥:
            for compensation in å·²æ‰§è¡Œæ­¥éª¤çš„è¡¥å¿:
                compensationæ‰§è¡Œ()
            return å¤±è´¥
    return æˆåŠŸ
```

#### 2.3.2. ä¸¤é˜¶æ®µæäº¤çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.3.3ï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰**ï¼š

ä¸¤é˜¶æ®µæäº¤ TwoPhaseCommit æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡çš„å¦ä¸€ç§æ¨¡å¼ï¼š

```text
ä¸¤é˜¶æ®µæäº¤ = {
    Phase1: Prepare,
    Phase2: Commit | Abort
}
```

**ä¸¤é˜¶æ®µæäº¤çš„å½¢å¼åŒ–å®šä¹‰**ï¼š

**å®šä¹‰2.3.4ï¼ˆä¸¤é˜¶æ®µæäº¤è¿‡ç¨‹ï¼‰**ï¼š

ä¸¤é˜¶æ®µæäº¤è¿‡ç¨‹åŒ…æ‹¬ï¼š

1. **Prepareé˜¶æ®µ**ï¼šæ‰€æœ‰å‚ä¸è€…å‡†å¤‡æäº¤
2. **Commité˜¶æ®µ**ï¼šå¦‚æœæ‰€æœ‰å‚ä¸è€…å‡†å¤‡æˆåŠŸï¼Œåˆ™æäº¤ï¼›å¦åˆ™å›æ»š

#### 2.3.3. æœ€ç»ˆä¸€è‡´æ€§çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.3.5ï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰**ï¼š

æœ€ç»ˆä¸€è‡´æ€§ EventualConsistency è¦æ±‚ç³»ç»Ÿæœ€ç»ˆè¾¾åˆ°ä¸€è‡´çŠ¶æ€ï¼š

```text
æœ€ç»ˆä¸€è‡´æ€§ âŸº
  âˆƒæ—¶é—´t.
    âˆ€æ—¶é—´t' > t.
      ç³»ç»ŸçŠ¶æ€ä¸€è‡´
```

---

## 3. å¾®æœåŠ¡æ¶æ„çš„å½¢å¼åŒ–ç†è®º

### 3.1. æ•°æ®åº“peræœåŠ¡æ¶æ„çš„å½¢å¼åŒ–å®šä¹‰

#### 3.1.1. æœåŠ¡æ•°æ®åº“çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰3.1.1ï¼ˆæœåŠ¡æ•°æ®åº“ï¼‰**ï¼š

æœåŠ¡æ•°æ®åº“ ServiceDatabase æ˜¯æœåŠ¡ä¸“ç”¨çš„æ•°æ®åº“ï¼š

```text
ServiceDatabase(Service) = {
    DB | DB âˆˆ Databases,
        DBä¸“å±äºService
}
```

#### 3.1.2. æ•°æ®æ‰€æœ‰æƒçš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰3.1.2ï¼ˆæ•°æ®æ‰€æœ‰æƒï¼‰**ï¼š

æ•°æ®æ‰€æœ‰æƒ DataOwnership å®šä¹‰æœåŠ¡å¯¹æ•°æ®çš„æ‰€æœ‰æƒï¼š

```text
æ•°æ®æ‰€æœ‰æƒ(data) =
    Service | data âˆˆ Database(Service)
```

#### 3.1.3. æœåŠ¡ç‹¬ç«‹æ€§çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰3.1.3ï¼ˆæœåŠ¡ç‹¬ç«‹æ€§ï¼‰**ï¼š

æœåŠ¡ç‹¬ç«‹æ€§ ServiceIndependence è¦æ±‚æœåŠ¡å¯ä»¥ç‹¬ç«‹è¿è¡Œï¼š

```text
æœåŠ¡ç‹¬ç«‹æ€§ âŸº
  âˆ€Serviceáµ¢ âˆˆ Services.
    Serviceáµ¢å¯ä»¥ç‹¬ç«‹è¿è¡Œ
```

### 3.2. åˆ†å¸ƒå¼äº‹åŠ¡æ¶æ„çš„å½¢å¼åŒ–å®šä¹‰

#### 3.2.1. Sagaæ¨¡å¼çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰3.2.1ï¼ˆSagaæ¨¡å¼æ¶æ„ï¼‰**ï¼š

Sagaæ¨¡å¼æ¶æ„ SagaArchitecture ç®¡ç†åˆ†å¸ƒå¼äº‹åŠ¡ï¼š

```text
SagaArchitecture = (Orchestrator, Services, CompensationLogic)
å…¶ä¸­ï¼š
  Orchestrator: åè°ƒå™¨
  Services: å‚ä¸æœåŠ¡é›†åˆ
  CompensationLogic: è¡¥å¿é€»è¾‘
```

#### 3.2.2. è¡¥å¿äº‹åŠ¡çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰3.2.2ï¼ˆè¡¥å¿äº‹åŠ¡ï¼‰**ï¼š

è¡¥å¿äº‹åŠ¡ CompensationTransaction æ’¤é”€å·²æ‰§è¡Œçš„æ“ä½œï¼š

```text
è¡¥å¿äº‹åŠ¡(Step) =
    æ’¤é”€(Stepçš„æ“ä½œ)
```

### 3.3. å¾®æœåŠ¡æ¶æ„å¯¹æ¯”çŸ©é˜µ

| æ¶æ„æ¨¡å¼ | æœåŠ¡ç‹¬ç«‹æ€§ | æ•°æ®ä¸€è‡´æ€§ | å¤æ‚åº¦ | æ€§èƒ½ | é€‚ç”¨åœºæ™¯ |
|---------|-----------|-----------|--------|------|---------|
| **æ•°æ®åº“peræœåŠ¡** | â­â­â­â­â­ | â­â­â­ | â­â­â­ | â­â­â­â­â­ | å¾®æœåŠ¡ç³»ç»Ÿ |
| **å…±äº«æ•°æ®åº“** | â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | å•ä½“åº”ç”¨ |
| **åˆ†å¸ƒå¼äº‹åŠ¡** | â­â­â­â­ | â­â­â­â­â­ | â­â­ | â­â­â­ | å¼ºä¸€è‡´æ€§éœ€æ±‚ |

### 3.4. å¾®æœåŠ¡æ¶æ„é€‰æ‹©å†³ç­–æ ‘

```mermaid
flowchart TD
    A[é€‰æ‹©å¾®æœåŠ¡æ¶æ„] --> B{æœåŠ¡ç‹¬ç«‹æ€§è¦æ±‚}
    B -->|é«˜| C[æ•°æ®åº“peræœåŠ¡ âœ…]
    B -->|ä½| D[å…±äº«æ•°æ®åº“]

    C --> E{æ•°æ®ä¸€è‡´æ€§è¦æ±‚}
    D --> F{æ€§èƒ½è¦æ±‚}

    E -->|å¼ºä¸€è‡´æ€§| G[åˆ†å¸ƒå¼äº‹åŠ¡]
    E -->|æœ€ç»ˆä¸€è‡´æ€§| H[Sagaæ¨¡å¼ âœ…]
    E -->|æœåŠ¡å†…ä¸€è‡´æ€§| C

    F -->|é«˜æ€§èƒ½| I[æ•°æ®åº“peræœåŠ¡]
    F -->|ä¸­ç­‰æ€§èƒ½| D

    G --> J[éªŒè¯éœ€æ±‚]
    H --> J
    I --> J

    J --> K{éœ€æ±‚æ»¡è¶³?}
    K -->|æ˜¯| L[å¾®æœåŠ¡æ¶æ„é€‰æ‹©å®Œæˆ âœ…]
    K -->|å¦| M[è°ƒæ•´æ¶æ„]
    M --> B
```

---

## 4. PostgreSQLå¾®æœåŠ¡åº”ç”¨æ–¹æ¡ˆä¸å…¶ä»–æ–¹æ¡ˆçš„å¯¹æ¯”

### 4.1. åŠŸèƒ½å¯¹æ¯”çŸ©é˜µ

| åŠŸèƒ½ | PostgreSQLé›†ç¾¤ | MongoDB | Cassandra | CockroachDB | TiDB |
|------|---------------|---------|-----------|-------------|------|
| **æ•°æ®åº“peræœåŠ¡** | âœ… | âœ… | âœ… | âœ… | âœ… |
| **ACIDäº‹åŠ¡** | âœ… | âš ï¸ | âŒ | âœ… | âœ… |
| **åˆ†å¸ƒå¼äº‹åŠ¡** | âš ï¸ | âŒ | âŒ | âœ… | âœ… |
| **SQLæ”¯æŒ** | âœ… | âŒ | âŒ | âœ… | âœ… |
| **PostgreSQLå…¼å®¹** | âœ… | âŒ | âŒ | âš ï¸ | âš ï¸ |

### 4.2. æ€§èƒ½å¯¹æ¯”çŸ©é˜µ

| æ€§èƒ½æŒ‡æ ‡ | PostgreSQLé›†ç¾¤ | MongoDB | Cassandra | CockroachDB | TiDB |
|---------|---------------|---------|-----------|-------------|------|
| **æœåŠ¡ç‹¬ç«‹æ€§** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­ |
| **æ•°æ®ä¸€è‡´æ€§** | â­â­â­â­â­ | â­â­â­ | â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| **åˆ†å¸ƒå¼äº‹åŠ¡** | â­â­â­ | â­â­ | â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| **PostgreSQLå…¼å®¹** | â­â­â­â­â­ | â­ | â­ | â­â­â­ | â­â­â­ |

### 4.3. PostgreSQLå¾®æœåŠ¡åº”ç”¨æ–¹æ¡ˆé€‰æ‹©å†³ç­–æ ‘

```mermaid
flowchart TD
    A[é€‰æ‹©å¾®æœåŠ¡åº”ç”¨æ–¹æ¡ˆ] --> B{éœ€è¦PostgreSQLé›†æˆ?}
    B -->|æ˜¯| C[PostgreSQLé›†ç¾¤ âœ…]
    B -->|å¦| D{æœåŠ¡ç‰¹å¾}

    D -->|éœ€è¦ACID| E[PostgreSQL/CockroachDB]
    D -->|ä¸éœ€è¦ACID| F[MongoDB/Cassandra]

    C --> G{åˆ†å¸ƒå¼äº‹åŠ¡éœ€æ±‚}
    E --> H{æ€§èƒ½è¦æ±‚}
    F --> I{æ€§èƒ½è¦æ±‚}

    G -->|éœ€è¦| J[CockroachDB/TiDB]
    G -->|ä¸éœ€è¦| C

    H -->|é«˜| K[PostgreSQLé›†ç¾¤]
    H -->|æé«˜| L[CockroachDB]

    I -->|æé«˜| M[Cassandra]
    I -->|é«˜| N[MongoDB]

    J --> O[éªŒè¯éœ€æ±‚]
    K --> O
    L --> O
    M --> O
    N --> O
    C --> O

    O --> P{éœ€æ±‚æ»¡è¶³?}
    P -->|æ˜¯| Q[å¾®æœåŠ¡åº”ç”¨æ–¹æ¡ˆé€‰æ‹©å®Œæˆ âœ…]
    P -->|å¦| R[è°ƒæ•´æ–¹æ¡ˆ]
    R --> B
```

---

## 5. PostgreSQLå¾®æœåŠ¡åº”ç”¨çš„å½¢å¼åŒ–ç†è®º

### 5.1. PostgreSQLæ•°æ®åº“peræœåŠ¡çš„å½¢å¼åŒ–å®šä¹‰

#### 5.1.1. PostgreSQLæœåŠ¡æ•°æ®åº“çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰5.1.1ï¼ˆPostgreSQLæœåŠ¡æ•°æ®åº“ï¼‰**ï¼š

PostgreSQLæœåŠ¡æ•°æ®åº“ PostgreSQLServiceDatabase æ˜¯æœåŠ¡ä¸“ç”¨çš„PostgreSQLæ•°æ®åº“ï¼š

```text
PostgreSQLServiceDatabase(Service) = {
    PostgreSQLDB | PostgreSQLDB âˆˆ Databases,
        PostgreSQLDBä¸“å±äºService,
        PostgreSQLDBç‹¬ç«‹éƒ¨ç½²
}
```

#### 5.1.2. PostgreSQLæœåŠ¡æ•°æ®åº“çš„æ€§è´¨

**æ€§è´¨5.1.1ï¼ˆPostgreSQLæœåŠ¡æ•°æ®åº“çš„ç‹¬ç«‹æ€§ï¼‰**ï¼š

æ¯ä¸ªæœåŠ¡çš„PostgreSQLæ•°æ®åº“ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰°ã€‚

**å½¢å¼åŒ–**ï¼š

```text
ç‹¬ç«‹æ€§ âŸº
  âˆ€Serviceáµ¢, Serviceâ±¼ âˆˆ Services, i â‰  j.
    PostgreSQLDBáµ¢ âˆ© PostgreSQLDBâ±¼ = âˆ… âˆ§
    PostgreSQLDBáµ¢ç‹¬ç«‹éƒ¨ç½² âˆ§
    PostgreSQLDBâ±¼ç‹¬ç«‹éƒ¨ç½²
```

### 5.2. PostgreSQLåˆ†å¸ƒå¼äº‹åŠ¡çš„å½¢å¼åŒ–å®šä¹‰

#### 5.2.1. PostgreSQLä¸¤é˜¶æ®µæäº¤çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰5.2.1ï¼ˆPostgreSQLä¸¤é˜¶æ®µæäº¤ï¼‰**ï¼š

PostgreSQLä¸¤é˜¶æ®µæäº¤ PostgreSQLTwoPhaseCommit æ˜¯PostgreSQLåˆ†å¸ƒå¼äº‹åŠ¡çš„æ¨¡å¼ï¼š

```text
PostgreSQLä¸¤é˜¶æ®µæäº¤ = {
    Phase1: PREPARE TRANSACTION,
    Phase2: COMMIT PREPARED | ROLLBACK PREPARED
}
```

#### 5.2.2. PostgreSQL Sagaæ¨¡å¼çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰5.2.2ï¼ˆPostgreSQL Sagaæ¨¡å¼ï¼‰**ï¼š

PostgreSQL Sagaæ¨¡å¼ PostgreSQLSagaPattern ä½¿ç”¨PostgreSQLç®¡ç†Sagaï¼š

```text
PostgreSQLSagaPattern = (SagaTable, StepTable, CompensationLogic)
å…¶ä¸­ï¼š
  SagaTable: PostgreSQLè¡¨å­˜å‚¨Sagaå®ä¾‹
  StepTable: PostgreSQLè¡¨å­˜å‚¨Sagaæ­¥éª¤
  CompensationLogic: è¡¥å¿é€»è¾‘
```

### 5.3. PostgreSQL Citusé›†ç¾¤çš„å½¢å¼åŒ–å®šä¹‰

#### 5.3.1. Citusé›†ç¾¤çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰5.3.1ï¼ˆCitusé›†ç¾¤ï¼‰**ï¼š

Citusé›†ç¾¤ CitusCluster æ˜¯ä¸€ä¸ªä¸‰å…ƒç»„ (Coordinator, Workers, Sharding)ï¼Œå…¶ä¸­ï¼š

- **Coordinator**ï¼šåè°ƒèŠ‚ç‚¹
- **Workers**ï¼šå·¥ä½œèŠ‚ç‚¹é›†åˆ
- **Sharding**ï¼šåˆ†ç‰‡ç­–ç•¥

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
CitusCluster = (Coordinator, Workers, Sharding)
å…¶ä¸­ï¼š
  Coordinator: PostgreSQLCoordinatorNode
  Workers = {Workerâ‚, Workerâ‚‚, ..., Workerâ‚™}
  Sharding: ShardingStrategy
```

#### 5.3.2. Citusåˆ†ç‰‡çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰5.3.2ï¼ˆCitusåˆ†ç‰‡ï¼‰**ï¼š

Citusåˆ†ç‰‡ CitusShard å°†æ•°æ®åˆ†å¸ƒåˆ°å¤šä¸ªå·¥ä½œèŠ‚ç‚¹ï¼š

```text
CitusShard(table, shard_key) = {
    Shardâ‚ â†’ Workerâ‚,
    Shardâ‚‚ â†’ Workerâ‚‚,
    ...,
    Shardâ‚™ â†’ Workerâ‚™
}
```

### 5.4. PostgreSQLå¾®æœåŠ¡åº”ç”¨çš„æœ€ä½³å®è·µ

#### 5.4.1. æ•°æ®åº“peræœåŠ¡çš„æœ€ä½³å®è·µ

**å®è·µ5.4.1ï¼ˆæ•°æ®åº“peræœåŠ¡ï¼‰**ï¼š

æ¯ä¸ªå¾®æœåŠ¡ä½¿ç”¨ç‹¬ç«‹çš„PostgreSQLæ•°æ®åº“ï¼š

```sql
-- ç”¨æˆ·æœåŠ¡æ•°æ®åº“
CREATE DATABASE user_service_db;

-- è®¢å•æœåŠ¡æ•°æ®åº“
CREATE DATABASE order_service_db;

-- å•†å“æœåŠ¡æ•°æ®åº“
CREATE DATABASE product_service_db;
```

#### 5.4.2. æœåŠ¡é—´é€šä¿¡çš„æœ€ä½³å®è·µ

**å®è·µ5.4.2ï¼ˆæœåŠ¡é—´é€šä¿¡ï¼‰**ï¼š

æœåŠ¡é—´é€šè¿‡APIé€šä¿¡ï¼Œä¸ç›´æ¥è®¿é—®å…¶ä»–æœåŠ¡çš„æ•°æ®åº“ï¼š

```text
æœåŠ¡é—´é€šä¿¡ âŸº
  âˆ€Serviceáµ¢, Serviceâ±¼ âˆˆ Services, i â‰  j.
    Serviceáµ¢ä¸ç›´æ¥è®¿é—®Database(Serviceâ±¼) âˆ§
    Serviceáµ¢é€šè¿‡APIè®¿é—®Serviceâ±¼
```

#### 5.4.3. åˆ†å¸ƒå¼äº‹åŠ¡çš„æœ€ä½³å®è·µ

**å®è·µ5.4.3ï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡ï¼‰**ï¼š

ä½¿ç”¨Sagaæ¨¡å¼å¤„ç†åˆ†å¸ƒå¼äº‹åŠ¡ï¼š

```sql
-- Sagaå®ä¾‹è¡¨
CREATE TABLE saga_instances (
    saga_id UUID PRIMARY KEY,
    saga_type VARCHAR(100) NOT NULL,
    status VARCHAR(20) NOT NULL,
    payload JSONB NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Sagaæ­¥éª¤è¡¨
CREATE TABLE saga_steps (
    step_id BIGSERIAL PRIMARY KEY,
    saga_id UUID NOT NULL REFERENCES saga_instances(saga_id),
    step_order INTEGER NOT NULL,
    service_name VARCHAR(100) NOT NULL,
    status VARCHAR(20) NOT NULL,
    request_payload JSONB,
    response_payload JSONB
);
```

## 6. åº”ç”¨åœºæ™¯çš„å½¢å¼åŒ–åˆ†æ

### 6.1. å¾®æœåŠ¡ç³»ç»Ÿçš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰6.1.1ï¼ˆå¾®æœåŠ¡ç³»ç»Ÿæ¶æ„ï¼‰**ï¼š

å¾®æœåŠ¡ç³»ç»Ÿæ¶æ„ MicroserviceArchitecture æ˜¯ä¸€ä¸ªå››å…ƒç»„ (Services, Databases, Communication, Transaction)ï¼Œå…¶ä¸­ï¼š

- **Services**ï¼šæœåŠ¡é›†åˆ
- **Databases**ï¼šæ•°æ®åº“é›†åˆï¼ˆæ•°æ®åº“peræœåŠ¡ï¼‰
- **Communication**ï¼šæœåŠ¡é—´é€šä¿¡
- **Transaction**ï¼šåˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
MicroserviceArchitecture = (Services, Databases, Communication, Transaction)
å…¶ä¸­ï¼š
  Services = {Sâ‚, Sâ‚‚, ..., Sâ‚™}
  Databases = {DBâ‚, DBâ‚‚, ..., DBâ‚™}
  Communication: Service Ã— Service â†’ Protocol
  Transaction: DistributedTransactionHandler
```

### 6.2. æœåŠ¡æ•°æ®åŒæ­¥çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰6.2.1ï¼ˆæœåŠ¡æ•°æ®åŒæ­¥ï¼‰**ï¼š

æœåŠ¡æ•°æ®åŒæ­¥ ServiceDataSync åŒæ­¥æœåŠ¡é—´çš„æ•°æ®ï¼š

```text
æœåŠ¡æ•°æ®åŒæ­¥(Serviceâ‚, Serviceâ‚‚, data) =
    å¤åˆ¶(data, Database(Serviceâ‚)) â†’ Database(Serviceâ‚‚)
```

### 6.3. æœåŠ¡æ‰©å±•çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰6.3.1ï¼ˆæœåŠ¡æ‰©å±•ï¼‰**ï¼š

æœåŠ¡æ‰©å±• ServiceScaling æ‰©å±•æœåŠ¡çš„å®¹é‡ï¼š

```text
æœåŠ¡æ‰©å±•(Service, scale_factor) =
    å¤åˆ¶(Service, scale_factor)
```

### 6.4. å¾®æœåŠ¡åº”ç”¨æ¡ˆä¾‹

#### 6.4.1. ç”µå•†å¾®æœåŠ¡ç³»ç»Ÿ

**æ¡ˆä¾‹6.4.1ï¼ˆç”µå•†å¾®æœåŠ¡ç³»ç»Ÿï¼‰**ï¼š

ç”µå•†å¾®æœåŠ¡ç³»ç»ŸåŒ…æ‹¬ï¼š

- **ç”¨æˆ·æœåŠ¡**ï¼šç”¨æˆ·ç®¡ç†ï¼Œä½¿ç”¨PostgreSQLæ•°æ®åº“
- **å•†å“æœåŠ¡**ï¼šå•†å“ç®¡ç†ï¼Œä½¿ç”¨PostgreSQLæ•°æ®åº“
- **è®¢å•æœåŠ¡**ï¼šè®¢å•å¤„ç†ï¼Œä½¿ç”¨PostgreSQLæ•°æ®åº“
- **æ”¯ä»˜æœåŠ¡**ï¼šæ”¯ä»˜å¤„ç†ï¼Œä½¿ç”¨PostgreSQLæ•°æ®åº“

**æ¶æ„è®¾è®¡**ï¼š

```text
ç”¨æˆ·æœåŠ¡ â†’ PostgreSQLç”¨æˆ·æ•°æ®åº“
å•†å“æœåŠ¡ â†’ PostgreSQLå•†å“æ•°æ®åº“
è®¢å•æœåŠ¡ â†’ PostgreSQLè®¢å•æ•°æ®åº“
æ”¯ä»˜æœåŠ¡ â†’ PostgreSQLæ”¯ä»˜æ•°æ®åº“
```

#### 6.4.2. ç¤¾äº¤å¾®æœåŠ¡ç³»ç»Ÿ

**æ¡ˆä¾‹6.4.2ï¼ˆç¤¾äº¤å¾®æœåŠ¡ç³»ç»Ÿï¼‰**ï¼š

ç¤¾äº¤å¾®æœåŠ¡ç³»ç»ŸåŒ…æ‹¬ï¼š

- **ç”¨æˆ·æœåŠ¡**ï¼šç”¨æˆ·ç®¡ç†ï¼Œä½¿ç”¨PostgreSQLæ•°æ®åº“
- **å†…å®¹æœåŠ¡**ï¼šå†…å®¹ç®¡ç†ï¼Œä½¿ç”¨PostgreSQLæ•°æ®åº“
- **å…³ç³»æœåŠ¡**ï¼šå…³ç³»ç®¡ç†ï¼Œä½¿ç”¨PostgreSQLæ•°æ®åº“
- **æ¶ˆæ¯æœåŠ¡**ï¼šæ¶ˆæ¯å¤„ç†ï¼Œä½¿ç”¨PostgreSQLæ•°æ®åº“

**æ¶æ„è®¾è®¡**ï¼š

```text
ç”¨æˆ·æœåŠ¡ â†’ PostgreSQLç”¨æˆ·æ•°æ®åº“
å†…å®¹æœåŠ¡ â†’ PostgreSQLå†…å®¹æ•°æ®åº“
å…³ç³»æœåŠ¡ â†’ PostgreSQLå…³ç³»æ•°æ®åº“
æ¶ˆæ¯æœåŠ¡ â†’ PostgreSQLæ¶ˆæ¯æ•°æ®åº“
```

---

## 7. PostgreSQLå¾®æœåŠ¡åº”ç”¨çš„æŠ€æœ¯å®ç°

### 7.1. PostgreSQLæ•°æ®åº“peræœåŠ¡çš„å®ç°

#### 7.1.1. æœåŠ¡æ•°æ®åº“åˆ›å»º

```sql
-- åˆ›å»ºç”¨æˆ·æœåŠ¡æ•°æ®åº“
CREATE DATABASE user_service_db;

-- åˆ›å»ºè®¢å•æœåŠ¡æ•°æ®åº“
CREATE DATABASE order_service_db;

-- åˆ›å»ºå•†å“æœåŠ¡æ•°æ®åº“
CREATE DATABASE product_service_db;
```

#### 7.1.2. æœåŠ¡æ•°æ®åº“Schemaè®¾è®¡

```sql
-- ç”¨æˆ·æœåŠ¡æ•°æ®åº“Schema
\c user_service_db;

CREATE SCHEMA user_service;

CREATE TABLE user_service.users (
    user_id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    password_hash TEXT NOT NULL,
    profile_data JSONB,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_email ON user_service.users(email);
CREATE INDEX idx_users_username ON user_service.users(username);

-- è®¢å•æœåŠ¡æ•°æ®åº“Schema
\c order_service_db;

CREATE SCHEMA order_service;

CREATE TABLE order_service.orders (
    order_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,  -- å¼•ç”¨ç”¨æˆ·æœåŠ¡ï¼Œä½†ä¸ä½¿ç”¨å¤–é”®
    order_number VARCHAR(50) NOT NULL UNIQUE,
    order_status VARCHAR(20) NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_orders_user_id ON order_service.orders(user_id);
CREATE INDEX idx_orders_status ON order_service.orders(order_status);
```

### 7.2. PostgreSQLåˆ†å¸ƒå¼äº‹åŠ¡çš„å®ç°

#### 7.2.1. Sagaæ¨¡å¼çš„å®ç°

```sql
-- Sagaå®ä¾‹è¡¨
CREATE SCHEMA saga_pattern;

CREATE TABLE saga_pattern.saga_instances (
    saga_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    saga_type VARCHAR(100) NOT NULL,
    status VARCHAR(20) NOT NULL CHECK (status IN ('pending', 'executing', 'completed', 'compensating', 'failed')),
    current_step INTEGER DEFAULT 0,
    total_steps INTEGER NOT NULL,
    payload JSONB NOT NULL,
    result JSONB,
    error_message TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_saga_instances_status ON saga_pattern.saga_instances(status, created_at DESC);

-- Sagaæ­¥éª¤è¡¨
CREATE TABLE saga_pattern.saga_steps (
    step_id BIGSERIAL PRIMARY KEY,
    saga_id UUID NOT NULL REFERENCES saga_pattern.saga_instances(saga_id) ON DELETE CASCADE,
    step_order INTEGER NOT NULL,
    step_name VARCHAR(100) NOT NULL,
    service_name VARCHAR(100) NOT NULL,
    action_type VARCHAR(20) NOT NULL CHECK (action_type IN ('action', 'compensation')),
    status VARCHAR(20) NOT NULL CHECK (status IN ('pending', 'executing', 'completed', 'failed', 'compensated')),
    request_payload JSONB,
    response_payload JSONB,
    error_message TEXT,
    executed_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    UNIQUE(saga_id, step_order, action_type)
);

CREATE INDEX idx_saga_steps_saga ON saga_pattern.saga_steps(saga_id, step_order);
```

#### 7.2.2. Sagaæ‰§è¡Œå‡½æ•°

```sql
-- Sagaæ‰§è¡Œå‡½æ•°
CREATE OR REPLACE FUNCTION execute_saga_step(
    p_saga_id UUID,
    p_step_order INTEGER,
    p_service_name VARCHAR,
    p_action_payload JSONB
)
RETURNS JSONB AS $$
DECLARE
    v_step_id BIGINT;
    v_result JSONB;
BEGIN
    -- è®°å½•æ­¥éª¤å¼€å§‹
    INSERT INTO saga_pattern.saga_steps (
        saga_id, step_order, step_name, service_name,
        action_type, status, request_payload, executed_at
    )
    VALUES (
        p_saga_id, p_step_order, 'step_' || p_step_order, p_service_name,
        'action', 'executing', p_action_payload, CURRENT_TIMESTAMP
    )
    RETURNING step_id INTO v_step_id;

    -- è¿™é‡Œåº”è¯¥è°ƒç”¨å®é™…çš„æœåŠ¡API
    -- ç®€åŒ–ç¤ºä¾‹ï¼šå‡è®¾è°ƒç”¨æˆåŠŸ
    v_result := '{"success": true}'::JSONB;

    -- æ›´æ–°æ­¥éª¤çŠ¶æ€
    UPDATE saga_pattern.saga_steps
    SET status = 'completed',
        response_payload = v_result,
        completed_at = CURRENT_TIMESTAMP
    WHERE step_id = v_step_id;

    -- æ›´æ–°SagaçŠ¶æ€
    UPDATE saga_pattern.saga_instances
    SET current_step = p_step_order,
        status = CASE
            WHEN p_step_order >= total_steps THEN 'completed'
            ELSE 'executing'
        END,
        updated_at = CURRENT_TIMESTAMP
    WHERE saga_id = p_saga_id;

    RETURN v_result;
EXCEPTION
    WHEN OTHERS THEN
        -- æ­¥éª¤å¤±è´¥ï¼Œæ ‡è®°ä¸ºå¤±è´¥
        UPDATE saga_pattern.saga_steps
        SET status = 'failed',
            error_message = SQLERRM,
            completed_at = CURRENT_TIMESTAMP
        WHERE step_id = v_step_id;

        -- è§¦å‘è¡¥å¿
        PERFORM compensate_saga(p_saga_id);

        RAISE;
END;
$$ LANGUAGE plpgsql;
```

### 7.3. PostgreSQL Citusé›†ç¾¤çš„å®ç°

#### 7.3.1. Citusé›†ç¾¤é…ç½®

```sql
-- å®‰è£…Citusæ‰©å±•
CREATE EXTENSION citus;

-- æ·»åŠ å·¥ä½œèŠ‚ç‚¹
SELECT citus_add_node('worker1_host', 5432);
SELECT citus_add_node('worker2_host', 5432);
SELECT citus_add_node('worker3_host', 5432);

-- æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯
SELECT * FROM citus_get_active_worker_nodes();
```

#### 7.3.2. åˆ†å¸ƒå¼è¡¨åˆ›å»º

```sql
-- åˆ›å»ºåˆ†å¸ƒå¼è¡¨
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    name TEXT,
    email TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æŒ‰idåˆ†ç‰‡
SELECT create_distributed_table('users', 'id');

-- åˆ›å»ºå‚è€ƒè¡¨ï¼ˆå¤åˆ¶åˆ°æ‰€æœ‰èŠ‚ç‚¹ï¼‰
CREATE TABLE countries (
    id SERIAL PRIMARY KEY,
    name TEXT,
    code TEXT
);

SELECT create_reference_table('countries');
```

## 8. å‚è€ƒèµ„æ–™

### 8.1. ç»å…¸æ–‡çŒ®

- "Microservices Patterns" (Richardson, 2018)
- "Building Microservices" (Newman, 2015)
- "Database per Service Pattern" (Martin Fowler)
- "PostgreSQL: Up and Running" (Obe & Hsu, 2017)

### 8.2. ç›¸å…³èµ„æº

- [å¾®æœåŠ¡æ¶æ„æ¨¡å¼](https://microservices.io/patterns/)
- [æ•°æ®åº“peræœåŠ¡](https://microservices.io/patterns/data/database-per-service.html)
- [åˆ†å¸ƒå¼äº‹åŠ¡](https://microservices.io/patterns/data/distributed-transactions.html)
- [PostgreSQL Citusæ–‡æ¡£](https://docs.citusdata.com/)
- [PostgreSQLåˆ†å¸ƒå¼äº‹åŠ¡](https://www.postgresql.org/docs/current/sql-prepare-transaction.html)

---

**æœ€åæ›´æ–°**ï¼š2025-01-15
**ç»´æŠ¤è€…**ï¼šData-Science Team
**çŠ¶æ€**ï¼šè¿›è¡Œä¸­
