# æ•°æ®åº“è®¾è®¡æ¨¡å¼æœ€ä½³å®è·µæ€»ç»“ï¼šæ ¸å¿ƒåŸåˆ™ä¸è§„èŒƒ

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-12-01
> **ç‰ˆæœ¬**ï¼šv2.0
> **çŠ¶æ€**ï¼šå·²å®Œæˆ âœ…

---

## ğŸ“‹ ç›®å½•

- [æ•°æ®åº“è®¾è®¡æ¨¡å¼æœ€ä½³å®è·µæ€»ç»“ï¼šæ ¸å¿ƒåŸåˆ™ä¸è§„èŒƒ](#æ•°æ®åº“è®¾è®¡æ¨¡å¼æœ€ä½³å®è·µæ€»ç»“æ ¸å¿ƒåŸåˆ™ä¸è§„èŒƒ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1. æœ€ä½³å®è·µåˆ†ç±»](#11-æœ€ä½³å®è·µåˆ†ç±»)
  - [2. æ ¸å¿ƒè®¾è®¡åŸåˆ™](#2-æ ¸å¿ƒè®¾è®¡åŸåˆ™)
    - [2.1. è®¾è®¡åŸåˆ™çŸ©é˜µ](#21-è®¾è®¡åŸåˆ™çŸ©é˜µ)
    - [2.2. è®¾è®¡åŸåˆ™å†³ç­–æ ‘](#22-è®¾è®¡åŸåˆ™å†³ç­–æ ‘)
  - [3. å‘½åè§„èŒƒ](#3-å‘½åè§„èŒƒ)
    - [3.1. å‘½åè§„èŒƒçŸ©é˜µ](#31-å‘½åè§„èŒƒçŸ©é˜µ)
    - [3.2. å‘½åè§„èŒƒæ£€æŸ¥æ¸…å•](#32-å‘½åè§„èŒƒæ£€æŸ¥æ¸…å•)
  - [4. æ•°æ®ç±»å‹é€‰æ‹©è§„èŒƒ](#4-æ•°æ®ç±»å‹é€‰æ‹©è§„èŒƒ)
    - [4.1. æ•°æ®ç±»å‹é€‰æ‹©å†³ç­–æ ‘](#41-æ•°æ®ç±»å‹é€‰æ‹©å†³ç­–æ ‘)
    - [4.2. æ•°æ®ç±»å‹é€‰æ‹©çŸ©é˜µ](#42-æ•°æ®ç±»å‹é€‰æ‹©çŸ©é˜µ)
  - [5. ç´¢å¼•è®¾è®¡è§„èŒƒ](#5-ç´¢å¼•è®¾è®¡è§„èŒƒ)
    - [5.1. ç´¢å¼•è®¾è®¡åŸåˆ™](#51-ç´¢å¼•è®¾è®¡åŸåˆ™)
    - [5.2. ç´¢å¼•è®¾è®¡æ£€æŸ¥æ¸…å•](#52-ç´¢å¼•è®¾è®¡æ£€æŸ¥æ¸…å•)
  - [6. åˆ†åŒºè®¾è®¡è§„èŒƒ](#6-åˆ†åŒºè®¾è®¡è§„èŒƒ)
    - [6.1. åˆ†åŒºç­–ç•¥é€‰æ‹©](#61-åˆ†åŒºç­–ç•¥é€‰æ‹©)
    - [6.2. åˆ†åŒºè®¾è®¡æœ€ä½³å®è·µ](#62-åˆ†åŒºè®¾è®¡æœ€ä½³å®è·µ)
  - [7. å®‰å…¨è®¾è®¡è§„èŒƒ](#7-å®‰å…¨è®¾è®¡è§„èŒƒ)
    - [7.1. å®‰å…¨è®¾è®¡åŸåˆ™](#71-å®‰å…¨è®¾è®¡åŸåˆ™)
    - [7.2. RLSè®¾è®¡è§„èŒƒ](#72-rlsè®¾è®¡è§„èŒƒ)
  - [8. æ€§èƒ½ä¼˜åŒ–è§„èŒƒ](#8-æ€§èƒ½ä¼˜åŒ–è§„èŒƒ)
    - [8.1. æ€§èƒ½ä¼˜åŒ–åŸåˆ™](#81-æ€§èƒ½ä¼˜åŒ–åŸåˆ™)
    - [8.2. æŸ¥è¯¢ä¼˜åŒ–æ£€æŸ¥æ¸…å•](#82-æŸ¥è¯¢ä¼˜åŒ–æ£€æŸ¥æ¸…å•)
  - [9. è®¾è®¡æ¨¡å¼é€‰æ‹©æŒ‡å—](#9-è®¾è®¡æ¨¡å¼é€‰æ‹©æŒ‡å—)
    - [9.1. è®¾è®¡æ¨¡å¼é€‰æ‹©çŸ©é˜µ](#91-è®¾è®¡æ¨¡å¼é€‰æ‹©çŸ©é˜µ)
  - [10. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#10-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
    - [10.1. å¸¸è§é—®é¢˜çŸ©é˜µ](#101-å¸¸è§é—®é¢˜çŸ©é˜µ)
    - [10.2. è®¾è®¡è¯„å®¡æ£€æŸ¥æ¸…å•](#102-è®¾è®¡è¯„å®¡æ£€æŸ¥æ¸…å•)
  - [11. 2025è¡Œä¸šæœ€ä½³å®è·µå¯¹æ ‡](#11-2025è¡Œä¸šæœ€ä½³å®è·µå¯¹æ ‡)
    - [11.1. æƒå¨æ¥æºæœ€ä½³å®è·µå¯¹æ¯”](#111-æƒå¨æ¥æºæœ€ä½³å®è·µå¯¹æ¯”)
    - [11.2. 2025æœ€ä½³å®è·µä¼˜å…ˆçº§çŸ©é˜µ](#112-2025æœ€ä½³å®è·µä¼˜å…ˆçº§çŸ©é˜µ)
    - [11.3. è¡Œä¸šåœºæ™¯æœ€ä½³å®è·µé€ŸæŸ¥](#113-è¡Œä¸šåœºæ™¯æœ€ä½³å®è·µé€ŸæŸ¥)
  - [12. äº‘åŸç”Ÿæ•°æ®åº“æœ€ä½³å®è·µ](#12-äº‘åŸç”Ÿæ•°æ®åº“æœ€ä½³å®è·µ)
    - [12.1. Serverless PostgreSQLå®è·µ](#121-serverless-postgresqlå®è·µ)
    - [12.2. åˆ†å¸ƒå¼æ•°æ®åº“æœ€ä½³å®è·µï¼ˆCitusï¼‰](#122-åˆ†å¸ƒå¼æ•°æ®åº“æœ€ä½³å®è·µcitus)
  - [13. AIé›†æˆæœ€ä½³å®è·µ](#13-aié›†æˆæœ€ä½³å®è·µ)
    - [13.1. RAGç³»ç»Ÿè®¾è®¡æœ€ä½³å®è·µ](#131-ragç³»ç»Ÿè®¾è®¡æœ€ä½³å®è·µ)
    - [13.2. å‘é‡æ•°æ®åº“æ€§èƒ½æœ€ä½³å®è·µ](#132-å‘é‡æ•°æ®åº“æ€§èƒ½æœ€ä½³å®è·µ)
  - [14. å‚è€ƒèµ„æ–™](#14-å‚è€ƒèµ„æ–™)
    - [14.1. è¡Œä¸šæ ‡å‡†ä¸è§„èŒƒ](#141-è¡Œä¸šæ ‡å‡†ä¸è§„èŒƒ)
    - [14.2. ç›¸å…³æ–‡æ¡£](#142-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

æœ¬æ–‡æ¡£æ€»ç»“æ•°æ®åº“è®¾è®¡æ¨¡å¼çš„æ ¸å¿ƒæœ€ä½³å®è·µï¼Œæä¾›è®¾è®¡åŸåˆ™ã€è§„èŒƒå’Œå¸¸è§é—®é¢˜çš„è§£å†³æ–¹æ¡ˆã€‚

### 1.1. æœ€ä½³å®è·µåˆ†ç±»

```mermaid
mindmap
  root((æœ€ä½³å®è·µ))
    è®¾è®¡åŸåˆ™
      è§„èŒƒåŒ–åŸåˆ™
      æ€§èƒ½ä¼˜å…ˆ
      å®‰å…¨ç¬¬ä¸€
      å¯æ‰©å±•æ€§
    å‘½åè§„èŒƒ
      è¡¨å‘½å
      å­—æ®µå‘½å
      ç´¢å¼•å‘½å
      å‡½æ•°å‘½å
    æ•°æ®ç±»å‹è§„èŒƒ
      æ•°å€¼ç±»å‹
      æ–‡æœ¬ç±»å‹
      æ—¥æœŸæ—¶é—´
      JSONç±»å‹
    ç´¢å¼•è§„èŒƒ
      ä¸»é”®ç´¢å¼•
      å¤–é”®ç´¢å¼•
      å¤åˆç´¢å¼•
      éƒ¨åˆ†ç´¢å¼•
    åˆ†åŒºè§„èŒƒ
      èŒƒå›´åˆ†åŒº
      åˆ—è¡¨åˆ†åŒº
      å“ˆå¸Œåˆ†åŒº
    å®‰å…¨è§„èŒƒ
      æƒé™æ§åˆ¶
      æ•°æ®åŠ å¯†
      å®¡è®¡æ—¥å¿—
```

---

## 2. æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 2.1. è®¾è®¡åŸåˆ™çŸ©é˜µ

**æ ¸å¿ƒè®¾è®¡åŸåˆ™å¯¹æ¯”**ï¼š

| åŸåˆ™ | ä¼˜å…ˆçº§ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|--------|------|---------|
| **è§„èŒƒåŒ–åŸåˆ™** | â­â­â­ | å‡å°‘æ•°æ®å†—ä½™ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§ | æ‰€æœ‰æ•°æ®åº“è®¾è®¡ |
| **æ€§èƒ½ä¼˜å…ˆ** | â­â­â­ | åˆç†ä½¿ç”¨ç´¢å¼•ã€åˆ†åŒºã€ç‰©åŒ–è§†å›¾ | é«˜å¹¶å‘ç³»ç»Ÿ |
| **å®‰å…¨ç¬¬ä¸€** | â­â­â­ | æƒé™æ§åˆ¶ã€æ•°æ®åŠ å¯†ã€å®¡è®¡æ—¥å¿— | æ•æ„Ÿæ•°æ®ç³»ç»Ÿ |
| **å¯æ‰©å±•æ€§** | â­â­ | åˆ†åŒºè®¾è®¡ã€åˆ†å¸ƒå¼æ¶æ„ | å¤§è§„æ¨¡ç³»ç»Ÿ |
| **å¯ç»´æŠ¤æ€§** | â­â­ | å‘½åè§„èŒƒã€æ–‡æ¡£å®Œæ•´ | é•¿æœŸç»´æŠ¤ç³»ç»Ÿ |

### 2.2. è®¾è®¡åŸåˆ™å†³ç­–æ ‘

```mermaid
flowchart TD
    A[å¼€å§‹è®¾è®¡] --> B{æ•°æ®ç‰¹å¾}

    B -->|ç»“æ„åŒ–æ•°æ®| C{äº‹åŠ¡éœ€æ±‚}
    B -->|éç»“æ„åŒ–æ•°æ®| D{æŸ¥è¯¢æ¨¡å¼}

    C -->|å¼ºäº‹åŠ¡| E[å…³ç³»æ•°æ®åº“+è§„èŒƒåŒ–]
    C -->|å¼±äº‹åŠ¡| F{æŸ¥è¯¢å¤æ‚åº¦}

    D -->|å‘é‡æœç´¢| G[å‘é‡æ•°æ®åº“]
    D -->|æ–‡æ¡£æŸ¥è¯¢| H[æ–‡æ¡£æ•°æ®åº“]
    D -->|å›¾æŸ¥è¯¢| I[çŸ¥è¯†å›¾è°±]

    F -->|ç®€å•æŸ¥è¯¢| J[åˆ—å¼æ•°æ®åº“]
    F -->|å¤æ‚æŸ¥è¯¢| E

    E --> K[åº”ç”¨è®¾è®¡åŸåˆ™]
    G --> K
    H --> K
    I --> K
    J --> K

    K --> L[æ€§èƒ½ä¼˜åŒ–]
    K --> M[å®‰å…¨è®¾è®¡]
    K --> N[å¯æ‰©å±•æ€§]
```

---

## 3. å‘½åè§„èŒƒ

### 3.1. å‘½åè§„èŒƒçŸ©é˜µ

**å‘½åè§„èŒƒå¯¹æ¯”**ï¼š

| å¯¹è±¡ç±»å‹ | å‘½åè§„èŒƒ | ç¤ºä¾‹ | è¯´æ˜ |
|---------|---------|------|------|
| **è¡¨å** | å°å†™å­—æ¯+ä¸‹åˆ’çº¿ï¼Œå¤æ•°å½¢å¼ | `users`, `order_items` | æ¸…æ™°è¡¨è¾¾å®ä½“ |
| **å­—æ®µå** | å°å†™å­—æ¯+ä¸‹åˆ’çº¿ | `user_id`, `created_at` | é¿å…å…³é”®å­—å†²çª |
| **ç´¢å¼•å** | `idx_` + è¡¨å + å­—æ®µå | `idx_users_email` | ä¾¿äºè¯†åˆ« |
| **ä¸»é”®å** | `pk_` + è¡¨å | `pk_users` | æ˜ç¡®ä¸»é”® |
| **å¤–é”®å** | `fk_` + è¡¨å + å­—æ®µå | `fk_orders_user_id` | æ˜ç¡®å¤–é”®å…³ç³» |
| **å‡½æ•°å** | åŠ¨è¯+åè¯ï¼Œå°å†™+ä¸‹åˆ’çº¿ | `get_user_by_id` | è¡¨è¾¾åŠŸèƒ½ |
| **è§†å›¾å** | `v_` + æè¿°æ€§åç§° | `v_user_statistics` | åŒºåˆ†è§†å›¾ |

### 3.2. å‘½åè§„èŒƒæ£€æŸ¥æ¸…å•

**å‘½åè§„èŒƒæ£€æŸ¥æ¸…å•**ï¼š

```sql
-- å‘½åè§„èŒƒæ£€æŸ¥å‡½æ•°
CREATE OR REPLACE FUNCTION check_naming_conventions()
RETURNS TABLE (
    object_type VARCHAR,
    object_name VARCHAR,
    issue_type VARCHAR,
    recommendation TEXT
) AS $$
BEGIN
    RETURN QUERY
    -- æ£€æŸ¥è¡¨åï¼šåº”è¯¥ä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿
    SELECT
        'table'::VARCHAR,
        t.table_name::VARCHAR,
        'warning'::VARCHAR,
        'Table name should use lowercase and underscores'::TEXT
    FROM information_schema.tables t
    WHERE t.table_schema = 'public'
      AND (t.table_name ~ '[A-Z]' OR t.table_name ~ '-')

    UNION ALL

    -- æ£€æŸ¥å­—æ®µåï¼šåº”è¯¥ä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿
    SELECT
        'column'::VARCHAR,
        c.column_name::VARCHAR,
        'warning'::VARCHAR,
        'Column name should use lowercase and underscores'::TEXT
    FROM information_schema.columns c
    WHERE c.table_schema = 'public'
      AND (c.column_name ~ '[A-Z]' OR c.column_name ~ '-')

    UNION ALL

    -- æ£€æŸ¥ç´¢å¼•åï¼šåº”è¯¥ä½¿ç”¨idx_å‰ç¼€
    SELECT
        'index'::VARCHAR,
        i.indexname::VARCHAR,
        'warning'::VARCHAR,
        'Index name should start with idx_'::TEXT
    FROM pg_indexes i
    WHERE i.schemaname = 'public'
      AND NOT i.indexname LIKE 'idx_%'
      AND NOT i.indexname LIKE '%_pkey';
END;
$$ LANGUAGE plpgsql;
```

---

## 4. æ•°æ®ç±»å‹é€‰æ‹©è§„èŒƒ

### 4.1. æ•°æ®ç±»å‹é€‰æ‹©å†³ç­–æ ‘

```mermaid
flowchart TD
    A[é€‰æ‹©æ•°æ®ç±»å‹] --> B{æ•°æ®ç‰¹å¾}

    B -->|æ•°å€¼| C{æ•´æ•°/å°æ•°}
    B -->|æ–‡æœ¬| D{é•¿åº¦å›ºå®š}
    B -->|æ—¥æœŸæ—¶é—´| E[æ—¶é—´ç±»å‹]
    B -->|å¸ƒå°”| F[BOOLEAN]
    B -->|äºŒè¿›åˆ¶| G[BYTEA]
    B -->|JSON| H[JSONB]

    C -->|æ•´æ•°| I{æ•°å€¼èŒƒå›´}
    C -->|å°æ•°| J[NUMERIC/DECIMAL]

    I -->|å°èŒƒå›´| K[SMALLINT]
    I -->|ä¸­èŒƒå›´| L[INTEGER]
    I -->|å¤§èŒƒå›´| M[BIGINT]

    D -->|å›ºå®š| N[CHAR(n)]
    D -->|å¯å˜| O{VARCHAR/TEXT}

    O -->|æœ‰ä¸Šé™| P[VARCHAR(n)]
    O -->|æ— ä¸Šé™| Q[TEXT]

    E -->|ä»…æ—¥æœŸ| R[DATE]
    E -->|æ—¥æœŸæ—¶é—´| S[TIMESTAMPTZ]
```

### 4.2. æ•°æ®ç±»å‹é€‰æ‹©çŸ©é˜µ

**æ•°æ®ç±»å‹é€‰æ‹©å¯¹æ¯”**ï¼š

| æ•°æ®ç±»å‹ | å­˜å‚¨å¤§å° | ç²¾åº¦ | é€‚ç”¨åœºæ™¯ | æ³¨æ„äº‹é¡¹ |
|---------|---------|------|---------|---------|
| **SMALLINT** | 2 bytes | -32768 to 32767 | å°èŒƒå›´æ•´æ•° | èŠ‚çœç©ºé—´ |
| **INTEGER** | 4 bytes | -2147483648 to 2147483647 | å¸¸ç”¨æ•´æ•° | é»˜è®¤é€‰æ‹© |
| **BIGINT** | 8 bytes | å¤§èŒƒå›´æ•´æ•° | IDã€æ—¶é—´æˆ³ | é¿å…æº¢å‡º |
| **NUMERIC** | å¯å˜ | ç²¾ç¡®å°æ•° | é‡‘é¢ã€ç²¾åº¦è¦æ±‚é«˜ | æ€§èƒ½ç•¥ä½ |
| **VARCHAR(n)** | å¯å˜ | æœ€å¤§nå­—ç¬¦ | æœ‰é•¿åº¦é™åˆ¶çš„æ–‡æœ¬ | è®¾ç½®åˆç†ä¸Šé™ |
| **TEXT** | å¯å˜ | æ— é™åˆ¶ | é•¿æ–‡æœ¬ã€å†…å®¹ | æ€§èƒ½è‰¯å¥½ |
| **TIMESTAMPTZ** | 8 bytes | æ—¶åŒºæ„ŸçŸ¥ | æ—¶é—´æˆ³ | æ¨èä½¿ç”¨ |
| **JSONB** | å¯å˜ | JSONæ•°æ® | åŠç»“æ„åŒ–æ•°æ® | æ”¯æŒç´¢å¼• |

---

## 5. ç´¢å¼•è®¾è®¡è§„èŒƒ

### 5.1. ç´¢å¼•è®¾è®¡åŸåˆ™

**ç´¢å¼•è®¾è®¡åŸåˆ™çŸ©é˜µ**ï¼š

| åŸåˆ™ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **ä¸»é”®ç´¢å¼•** | æ‰€æœ‰è¡¨å¿…é¡»æœ‰ä¸»é”® | `PRIMARY KEY (user_id)` |
| **å¤–é”®ç´¢å¼•** | å¤–é”®å­—æ®µå¿…é¡»æœ‰ç´¢å¼• | `CREATE INDEX idx_orders_user_id ON orders(user_id)` |
| **æŸ¥è¯¢å­—æ®µç´¢å¼•** | WHEREã€JOINã€ORDER BYå­—æ®µ | `CREATE INDEX idx_users_email ON users(email)` |
| **å¤åˆç´¢å¼•** | å¤šå­—æ®µæŸ¥è¯¢ä½¿ç”¨å¤åˆç´¢å¼• | `CREATE INDEX idx_orders_user_status ON orders(user_id, status)` |
| **éƒ¨åˆ†ç´¢å¼•** | æ¡ä»¶æŸ¥è¯¢ä½¿ç”¨éƒ¨åˆ†ç´¢å¼• | `CREATE INDEX idx_active_users ON users(email) WHERE status = 'active'` |
| **è¦†ç›–ç´¢å¼•** | åŒ…å«æŸ¥è¯¢æ‰€éœ€çš„æ‰€æœ‰å­—æ®µ | `CREATE INDEX idx_users_cover ON users(user_id, email, name)` |

### 5.2. ç´¢å¼•è®¾è®¡æ£€æŸ¥æ¸…å•

**ç´¢å¼•è®¾è®¡æ£€æŸ¥æ¸…å•**ï¼š

```sql
-- æ£€æŸ¥å¤–é”®æ˜¯å¦æœ‰ç´¢å¼•
CREATE OR REPLACE FUNCTION check_foreign_key_indexes()
RETURNS TABLE (
    table_name VARCHAR,
    column_name VARCHAR,
    has_index BOOLEAN,
    recommendation TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        tc.table_name::VARCHAR,
        kcu.column_name::VARCHAR,
        CASE WHEN i.indexname IS NOT NULL THEN TRUE ELSE FALSE END AS has_index,
        CASE
            WHEN i.indexname IS NULL THEN
                format('CREATE INDEX idx_%s_%s ON %s(%s)',
                       tc.table_name, kcu.column_name,
                       tc.table_name, kcu.column_name)
            ELSE 'Index exists'
        END AS recommendation
    FROM information_schema.table_constraints tc
    JOIN information_schema.key_column_usage kcu
        ON tc.constraint_name = kcu.constraint_name
    LEFT JOIN pg_indexes i
        ON i.tablename = tc.table_name
        AND i.indexdef LIKE '%' || kcu.column_name || '%'
    WHERE tc.constraint_type = 'FOREIGN KEY'
      AND tc.table_schema = 'public';
END;
$$ LANGUAGE plpgsql;
```

---

## 6. åˆ†åŒºè®¾è®¡è§„èŒƒ

### 6.1. åˆ†åŒºç­–ç•¥é€‰æ‹©

**åˆ†åŒºç­–ç•¥å¯¹æ¯”çŸ©é˜µ**ï¼š

| åˆ†åŒºç­–ç•¥ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|---------|---------|------|------|
| **èŒƒå›´åˆ†åŒº** | æ—¶é—´åºåˆ—æ•°æ®ã€æœ‰åºæ•°æ® | æŸ¥è¯¢æ€§èƒ½å¥½ã€æ˜“äºç®¡ç† | æ•°æ®åˆ†å¸ƒä¸å‡ |
| **åˆ—è¡¨åˆ†åŒº** | ç¦»æ•£å€¼åˆ†åŒº | çµæ´»ã€æ˜“äºç®¡ç† | åˆ†åŒºæ•°é‡é™åˆ¶ |
| **å“ˆå¸Œåˆ†åŒº** | æ•°æ®å‡åŒ€åˆ†å¸ƒ | è´Ÿè½½å‡è¡¡ | æŸ¥è¯¢æ€§èƒ½ä¸€èˆ¬ |
| **å¤åˆåˆ†åŒº** | å¤æ‚åœºæ™¯ | çµæ´»ç»„åˆ | å¤æ‚åº¦é«˜ |

### 6.2. åˆ†åŒºè®¾è®¡æœ€ä½³å®è·µ

**åˆ†åŒºè®¾è®¡æœ€ä½³å®è·µ**ï¼š

```sql
-- èŒƒå›´åˆ†åŒºç¤ºä¾‹ï¼šè®¢å•è¡¨æŒ‰æœˆåˆ†åŒº
CREATE TABLE orders (
    order_id BIGSERIAL,
    user_id BIGINT NOT NULL,
    order_date TIMESTAMPTZ NOT NULL,
    total_amount DECIMAL(12, 2) NOT NULL,
    PRIMARY KEY (order_id, order_date)
) PARTITION BY RANGE (order_date);

-- åˆ›å»ºåˆ†åŒº
CREATE TABLE orders_2025_01 PARTITION OF orders
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE TABLE orders_2025_02 PARTITION OF orders
FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');

-- è‡ªåŠ¨åˆ›å»ºåˆ†åŒºå‡½æ•°
CREATE OR REPLACE FUNCTION create_monthly_partitions(
    p_table_name TEXT,
    p_start_date DATE,
    p_end_date DATE
)
RETURNS VOID AS $$
DECLARE
    current_date DATE := p_start_date;
    partition_name TEXT;
BEGIN
    WHILE current_date < p_end_date LOOP
        partition_name := p_table_name || '_' || to_char(current_date, 'YYYY_MM');
        EXECUTE format(
            'CREATE TABLE IF NOT EXISTS %I PARTITION OF %I FOR VALUES FROM (%L) TO (%L)',
            partition_name,
            p_table_name,
            current_date,
            current_date + INTERVAL '1 month'
        );
        current_date := current_date + INTERVAL '1 month';
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

---

## 7. å®‰å…¨è®¾è®¡è§„èŒƒ

### 7.1. å®‰å…¨è®¾è®¡åŸåˆ™

**å®‰å…¨è®¾è®¡åŸåˆ™çŸ©é˜µ**ï¼š

| åŸåˆ™ | è¯´æ˜ | å®ç°æ–¹å¼ |
|------|------|---------|
| **æœ€å°æƒé™åŸåˆ™** | ç”¨æˆ·åªæ‹¥æœ‰å¿…è¦çš„æƒé™ | RBACã€RLS |
| **æ•°æ®åŠ å¯†** | æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨ | `pgcrypto`ã€å­—æ®µåŠ å¯† |
| **å®¡è®¡æ—¥å¿—** | è®°å½•æ‰€æœ‰æ•°æ®å˜æ›´ | è§¦å‘å™¨ã€å®¡è®¡è¡¨ |
| **è®¿é—®æ§åˆ¶** | é™åˆ¶æ•°æ®åº“è®¿é—® | é˜²ç«å¢™ã€SSLè¿æ¥ |
| **å¯†ç ç­–ç•¥** | å¼ºå¯†ç è¦æ±‚ | å¯†ç å¤æ‚åº¦ã€å®šæœŸæ›´æ¢ |

### 7.2. RLSè®¾è®¡è§„èŒƒ

**RLSè®¾è®¡æœ€ä½³å®è·µ**ï¼š

```sql
-- RLSç­–ç•¥è®¾è®¡ç¤ºä¾‹
CREATE TABLE sensitive_data (
    id BIGSERIAL PRIMARY KEY,
    tenant_id BIGINT NOT NULL,
    data TEXT NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- å¯ç”¨RLS
ALTER TABLE sensitive_data ENABLE ROW LEVEL SECURITY;

-- åˆ›å»ºç­–ç•¥å‡½æ•°
CREATE OR REPLACE FUNCTION get_current_tenant_id()
RETURNS BIGINT AS $$
BEGIN
    RETURN current_setting('app.current_tenant_id', TRUE)::BIGINT;
END;
$$ LANGUAGE plpgsql STABLE;

-- åˆ›å»ºRLSç­–ç•¥
CREATE POLICY tenant_isolation_policy ON sensitive_data
    FOR ALL
    USING (tenant_id = get_current_tenant_id())
    WITH CHECK (tenant_id = get_current_tenant_id());
```

---

## 8. æ€§èƒ½ä¼˜åŒ–è§„èŒƒ

### 8.1. æ€§èƒ½ä¼˜åŒ–åŸåˆ™

**æ€§èƒ½ä¼˜åŒ–åŸåˆ™çŸ©é˜µ**ï¼š

| åŸåˆ™ | è¯´æ˜ | å®ç°æ–¹å¼ |
|------|------|---------|
| **ç´¢å¼•ä¼˜åŒ–** | åˆç†ä½¿ç”¨ç´¢å¼• | åˆ†ææŸ¥è¯¢æ¨¡å¼ã€åˆ›å»ºåˆé€‚ç´¢å¼• |
| **æŸ¥è¯¢ä¼˜åŒ–** | ä¼˜åŒ–SQLæŸ¥è¯¢ | é¿å…N+1æŸ¥è¯¢ã€ä½¿ç”¨JOIN |
| **åˆ†åŒºä¼˜åŒ–** | å¤§è¡¨åˆ†åŒº | æŒ‰æ—¶é—´ã€èŒƒå›´åˆ†åŒº |
| **ç‰©åŒ–è§†å›¾** | é¢„è®¡ç®—èšåˆ | åˆ›å»ºç‰©åŒ–è§†å›¾ã€å®šæœŸåˆ·æ–° |
| **è¿æ¥æ± ** | ç®¡ç†æ•°æ®åº“è¿æ¥ | ä½¿ç”¨è¿æ¥æ± ã€é™åˆ¶è¿æ¥æ•° |

### 8.2. æŸ¥è¯¢ä¼˜åŒ–æ£€æŸ¥æ¸…å•

**æŸ¥è¯¢ä¼˜åŒ–æ£€æŸ¥æ¸…å•**ï¼š

```sql
-- æ£€æŸ¥æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    mean_exec_time,
    max_exec_time,
    (mean_exec_time * calls) AS total_time
FROM pg_stat_statements
WHERE mean_exec_time > 100  -- è¶…è¿‡100msçš„æŸ¥è¯¢
ORDER BY total_time DESC
LIMIT 20;

-- æ£€æŸ¥æœªä½¿ç”¨çš„ç´¢å¼•
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE idx_scan = 0
  AND indexrelid NOT IN (
      SELECT conindid FROM pg_constraint WHERE contype = 'p'
  )
ORDER BY pg_relation_size(indexrelid) DESC;
```

---

## 9. è®¾è®¡æ¨¡å¼é€‰æ‹©æŒ‡å—

### 9.1. è®¾è®¡æ¨¡å¼é€‰æ‹©çŸ©é˜µ

**è®¾è®¡æ¨¡å¼é€‰æ‹©å¯¹æ¯”**ï¼š

| åœºæ™¯ | æ¨èæ¨¡å¼ | å…³é”®ç‰¹æ€§ | æ–‡æ¡£é“¾æ¥ |
|------|---------|---------|---------|
| **é«˜å¹¶å‘è¯»å†™** | å…³ç³»æ•°æ®åº“+åˆ†åŒº+ç´¢å¼• | ACIDã€å¼ºä¸€è‡´æ€§ | [07.01](./07.01-Schemaè®¾è®¡æ–¹æ³•è®º.md) |
| **AIæ¨è** | å‘é‡æ•°æ®åº“ | ç›¸ä¼¼åº¦æœç´¢ | [07.10](./07.10-å‘é‡æ•°æ®åº“è®¾è®¡.md) |
| **LBSæœåŠ¡** | åœ°ç†ç©ºé—´æ•°æ®åº“ | ç©ºé—´æŸ¥è¯¢ | [07.11](./07.11-åœ°ç†ç©ºé—´æ•°æ®åº“è®¾è®¡.md) |
| **çŸ¥è¯†ç®¡ç†** | çŸ¥è¯†å›¾è°± | å›¾æŸ¥è¯¢ã€æ¨ç† | [07.12](./07.12-çŸ¥è¯†å›¾è°±æ•°æ®åº“è®¾è®¡å®æˆ˜.md) |
| **IoTç›‘æ§** | æ—¶åºæ•°æ®åº“ | æ—¶é—´åºåˆ—ä¼˜åŒ– | [07.18](./07.18-æ—¶åºæ•°æ®åº“è®¾è®¡æ¨¡å¼.md) |
| **å†…å®¹ç®¡ç†** | æ–‡æ¡£æ•°æ®åº“ | çµæ´»Schema | [07.19](./07.19-æ–‡æ¡£æ•°æ®åº“è®¾è®¡æ¨¡å¼.md) |
| **SaaSå¹³å°** | å¤šç§Ÿæˆ·æ•°æ®åº“ | RLSã€ç§Ÿæˆ·éš”ç¦» | [07.20](./07.20-å¤šç§Ÿæˆ·æ•°æ®åº“è®¾è®¡æ¨¡å¼.md) |
| **æ•°æ®åˆ†æ** | åˆ—å¼æ•°æ®åº“ | OLAPä¼˜åŒ– | [07.21](./07.21-åˆ—å¼æ•°æ®åº“è®¾è®¡æ¨¡å¼.md) |
| **ç¼“å­˜ç³»ç»Ÿ** | å†…å­˜æ•°æ®åº“ | é«˜é€Ÿè®¿é—® | [07.22](./07.22-å†…å­˜æ•°æ®åº“è®¾è®¡æ¨¡å¼.md) |
| **å¾®æœåŠ¡** | åˆ†å¸ƒå¼æ•°æ®åº“ | åˆ†å¸ƒå¼äº‹åŠ¡ | [07.17](./07.17-åˆ†å¸ƒå¼æ•°æ®åº“è®¾è®¡æ¨¡å¼.md) |

---

## 10. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 10.1. å¸¸è§é—®é¢˜çŸ©é˜µ

**å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ**ï¼š

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ | æ–‡æ¡£é“¾æ¥ |
|------|------|---------|---------|
| **æŸ¥è¯¢æ…¢** | ç¼ºå°‘ç´¢å¼•ã€å…¨è¡¨æ‰«æ | æ·»åŠ ç´¢å¼•ã€ä¼˜åŒ–æŸ¥è¯¢ | [07.08](./07.08-æ•°æ®åº“æ€§èƒ½è°ƒä¼˜å®æˆ˜.md) |
| **æ•°æ®ä¸ä¸€è‡´** | ç¼ºå°‘çº¦æŸã€äº‹åŠ¡é—®é¢˜ | æ·»åŠ å¤–é”®ã€ä½¿ç”¨äº‹åŠ¡ | [07.14](./07.14-æ•°æ®åº“è®¾è®¡æœ€ä½³å®è·µåº“.md) |
| **å­˜å‚¨ç©ºé—´ä¸è¶³** | æ•°æ®å¢é•¿å¿«ã€æœªåˆ†åŒº | æ•°æ®åˆ†åŒºã€å½’æ¡£ | [07.24](./07.24-æ•°æ®åº“å¤‡ä»½ä¸æ¢å¤è®¾è®¡æ¨¡å¼.md) |
| **å¹¶å‘å†²çª** | é”ç«äº‰ã€äº‹åŠ¡å†²çª | ä¼˜åŒ–äº‹åŠ¡ã€ä½¿ç”¨MVCC | [07.17](./07.17-åˆ†å¸ƒå¼æ•°æ®åº“è®¾è®¡æ¨¡å¼.md) |
| **å®‰å…¨æ¼æ´** | æƒé™è¿‡å¤§ã€æœªåŠ å¯† | RLSç­–ç•¥ã€æ•°æ®åŠ å¯† | [07.23](./07.23-æ•°æ®åº“å®‰å…¨è®¾è®¡æ¨¡å¼.md) |

### 10.2. è®¾è®¡è¯„å®¡æ£€æŸ¥æ¸…å•

**è®¾è®¡è¯„å®¡æ£€æŸ¥æ¸…å•**ï¼š

```sql
-- è®¾è®¡è´¨é‡è¯„åˆ†å‡½æ•°
CREATE OR REPLACE FUNCTION calculate_design_quality_score(
    p_schema_name VARCHAR,
    p_table_name VARCHAR
)
RETURNS TABLE (
    category VARCHAR,
    score INTEGER,
    max_score INTEGER,
    percentage DOUBLE PRECISION
) AS $$
DECLARE
    v_naming_score INTEGER := 25;
    v_structure_score INTEGER := 25;
    v_performance_score INTEGER := 25;
    v_security_score INTEGER := 25;
BEGIN
    -- å‘½åè§„èŒƒè¯„åˆ†ï¼ˆ25åˆ†ï¼‰
    -- æ£€æŸ¥å‘½åæ˜¯å¦ç¬¦åˆè§„èŒƒ
    SELECT COUNT(*) INTO v_naming_score
    FROM check_naming_conventions()
    WHERE object_name = p_table_name;

    v_naming_score := GREATEST(0, 25 - v_naming_score * 5);

    -- ç»“æ„è§„èŒƒè¯„åˆ†ï¼ˆ25åˆ†ï¼‰
    -- æ£€æŸ¥æ˜¯å¦æœ‰ä¸»é”®ã€å¤–é”®ç´¢å¼•ç­‰
    SELECT COUNT(*) INTO v_structure_score
    FROM check_structure_conventions(p_schema_name, p_table_name)
    WHERE issue_type = 'error';

    v_structure_score := GREATEST(0, 25 - v_structure_score * 5);

    -- æ€§èƒ½è®¾è®¡è¯„åˆ†ï¼ˆ25åˆ†ï¼‰
    -- æ£€æŸ¥ç´¢å¼•è®¾è®¡
    SELECT COUNT(*) INTO v_performance_score
    FROM check_index_design(p_schema_name, p_table_name)
    WHERE issue_type IN ('error', 'critical');

    v_performance_score := GREATEST(0, 25 - v_performance_score * 5);

    -- å®‰å…¨è®¾è®¡è¯„åˆ†ï¼ˆ25åˆ†ï¼‰
    -- æ£€æŸ¥å®‰å…¨è®¾è®¡
    SELECT COUNT(*) INTO v_security_score
    FROM check_security_design(p_schema_name)
    WHERE issue_type IN ('error', 'critical');

    v_security_score := GREATEST(0, 25 - v_security_score * 5);

    RETURN QUERY
    SELECT 'naming'::VARCHAR, v_naming_score, 25, (v_naming_score::DOUBLE PRECISION / 25 * 100)
    UNION ALL
    SELECT 'structure'::VARCHAR, v_structure_score, 25, (v_structure_score::DOUBLE PRECISION / 25 * 100)
    UNION ALL
    SELECT 'performance'::VARCHAR, v_performance_score, 25, (v_performance_score::DOUBLE PRECISION / 25 * 100)
    UNION ALL
    SELECT 'security'::VARCHAR, v_security_score, 25, (v_security_score::DOUBLE PRECISION / 25 * 100)
    UNION ALL
    SELECT 'total'::VARCHAR,
           v_naming_score + v_structure_score + v_performance_score + v_security_score,
           100,
           ((v_naming_score + v_structure_score + v_performance_score + v_security_score)::DOUBLE PRECISION / 100 * 100);
END;
$$ LANGUAGE plpgsql;
```

---

## 11. 2025è¡Œä¸šæœ€ä½³å®è·µå¯¹æ ‡

### 11.1. æƒå¨æ¥æºæœ€ä½³å®è·µå¯¹æ¯”

| æ¥æº | æ ¸å¿ƒåŸåˆ™ | é€‚ç”¨åœºæ™¯ | å‚è€ƒé“¾æ¥ |
|------|---------|---------|---------|
| **AWS Well-Architected** | å¯é æ€§ã€å®‰å…¨æ€§ã€æˆæœ¬ä¼˜åŒ– | äº‘åŸç”Ÿåº”ç”¨ | aws.amazon.com/architecture |
| **Google Cloud** | 12-Factor Appã€æ— çŠ¶æ€è®¾è®¡ | å¾®æœåŠ¡æ¶æ„ | cloud.google.com/architecture |
| **PostgreSQLå®˜æ–¹** | MVCCã€ç´¢å¼•ç­–ç•¥ã€åˆ†åŒº | PostgreSQLé¡¹ç›® | postgresql.org/docs |
| **Martin Fowler PoEAA** | é¢†åŸŸæ¨¡å‹ã€æ•°æ®æ˜ å°„å™¨ | ä¼ä¸šåº”ç”¨ | martinfowler.com |
| **DDIA (Kleppmann)** | åˆ†å¸ƒå¼ä¸€è‡´æ€§ã€æ•°æ®æµ | å¤§è§„æ¨¡ç³»ç»Ÿ | dataintensive.net |

### 11.2. 2025æœ€ä½³å®è·µä¼˜å…ˆçº§çŸ©é˜µ

```mermaid
quadrantChart
    title 2025æ•°æ®åº“æœ€ä½³å®è·µä¼˜å…ˆçº§
    x-axis ä½æŠ•å…¥ --> é«˜æŠ•å…¥
    y-axis ä½æ”¶ç›Š --> é«˜æ”¶ç›Š
    quadrant-1 ä¼˜å…ˆå®æ–½
    quadrant-2 æˆ˜ç•¥æŠ•èµ„
    quadrant-3 ä½ä¼˜å…ˆçº§
    quadrant-4 è°¨æ…è¯„ä¼°

    å‘é‡ç´¢å¼•ä¼˜åŒ–: [0.3, 0.9]
    GitOpsè¿ç§»: [0.4, 0.85]
    RLSå¤šç§Ÿæˆ·: [0.35, 0.75]
    è¿æ¥æ± ä¼˜åŒ–: [0.2, 0.7]
    åˆ†å¸ƒå¼äº‹åŠ¡: [0.8, 0.8]
    å…¨é¢å®¡è®¡: [0.6, 0.6]
    å®æ—¶CDC: [0.7, 0.75]
    è¾¹ç¼˜æ•°æ®åº“: [0.9, 0.65]
```

### 11.3. è¡Œä¸šåœºæ™¯æœ€ä½³å®è·µé€ŸæŸ¥

**ç”µå•†å¹³å°**ï¼š

| æ¨¡å— | æœ€ä½³å®è·µ | å…³é”®æŠ€æœ¯ | å‚è€ƒ |
|------|---------|---------|------|
| å•†å“ç›®å½• | è¯»å†™åˆ†ç¦» + ç¼“å­˜ | PostgreSQL + Redis | Shopifyæ¶æ„ |
| è®¢å•ç³»ç»Ÿ | åˆ†åŒº + äº‹ä»¶æº¯æº | CQRS + Event Sourcing | Amazonå®è·µ |
| æœç´¢æ¨è | å‘é‡æ£€ç´¢ + æ··åˆæœç´¢ | pgvector + Elasticsearch | Pinterestæ¶æ„ |
| åº“å­˜ç®¡ç† | ä¹è§‚é” + å¹‚ç­‰æ€§ | SELECT FOR UPDATE | Stripeå®è·µ |

**é‡‘èç³»ç»Ÿ**ï¼š

| æ¨¡å— | æœ€ä½³å®è·µ | å…³é”®æŠ€æœ¯ | å‚è€ƒ |
|------|---------|---------|------|
| äº¤æ˜“è®°å½• | å¼ºä¸€è‡´æ€§ + å®¡è®¡ | 2PC + å®Œæ•´å®¡è®¡æ—¥å¿— | é“¶è¡Œæ ‡å‡† |
| è´¦æˆ·ä½™é¢ | è¡Œçº§é” + äº‹åŠ¡éš”ç¦» | SERIALIZABLEéš”ç¦»çº§åˆ« | Stripeå®è·µ |
| é£æ§ç³»ç»Ÿ | å®æ—¶è®¡ç®— + æ—¶åºåˆ†æ | TimescaleDB + å®æ—¶æµ | èš‚èšé‡‘æœæ¶æ„ |
| åˆè§„å­˜å‚¨ | åŠ å¯† + ä¸å¯å˜ | TDE + åˆ†åŒºä¿ç•™ç­–ç•¥ | PCI-DSSè¦æ±‚ |

**AI/MLå¹³å°**ï¼š

| æ¨¡å— | æœ€ä½³å®è·µ | å…³é”®æŠ€æœ¯ | å‚è€ƒ |
|------|---------|---------|------|
| çŸ¥è¯†åº“ | å‘é‡ + å…¨æ–‡æ··åˆ | pgvector + RRFèåˆ | OpenAIå®è·µ |
| å¯¹è¯å†å² | åˆ†åŒº + Tokenè®¡é‡ | æŒ‰æ—¶é—´åˆ†åŒº + å…ƒæ•°æ® | Anthropicæ¶æ„ |
| æ¨¡å‹ç‰ˆæœ¬ | ç‰ˆæœ¬æ§åˆ¶ + è¡€ç¼˜ | MLflow + å…ƒæ•°æ®ç®¡ç† | MLOpsæ ‡å‡† |
| AgentçŠ¶æ€ | çŠ¶æ€æœº + æŒä¹…åŒ– | JSONB + äº‹ä»¶æ—¥å¿— | LangChainå®è·µ |

---

## 12. äº‘åŸç”Ÿæ•°æ®åº“æœ€ä½³å®è·µ

### 12.1. Serverless PostgreSQLå®è·µ

```sql
-- Neon/Supabase Serverlessæœ€ä½³å®è·µ

-- 1. è¿æ¥æ± ä¼˜åŒ–ï¼ˆServerlesså¿…å¤‡ï¼‰
-- ä½¿ç”¨è¿æ¥æ± ä»£ç†ï¼ˆå¦‚pgBouncer/Supavisorï¼‰
-- åº”ç”¨å±‚é…ç½®ï¼šæœ€å°è¿æ¥æ•°=0ï¼Œæœ€å¤§=10

-- 2. å†·å¯åŠ¨ä¼˜åŒ–
-- é¿å…é¦–æ¬¡æŸ¥è¯¢è§¦å‘å¤§é‡æ•°æ®åŠ è½½
CREATE INDEX CONCURRENTLY idx_hot_data ON table(column)
WHERE created_at > NOW() - INTERVAL '7 days';

-- 3. æˆæœ¬ä¼˜åŒ–ï¼šæŒ‰éœ€è®¡ç®—
-- ä½¿ç”¨ç‰©åŒ–è§†å›¾å‡å°‘å®æ—¶è®¡ç®—
CREATE MATERIALIZED VIEW mv_daily_stats AS
SELECT date_trunc('day', created_at) AS day, COUNT(*) AS cnt
FROM events GROUP BY 1;

-- å®šæ—¶åˆ·æ–°ï¼ˆè€Œéå®æ—¶æŸ¥è¯¢ï¼‰
SELECT cron.schedule('refresh-stats', '0 * * * *',
    $$REFRESH MATERIALIZED VIEW CONCURRENTLY mv_daily_stats$$);
```

### 12.2. åˆ†å¸ƒå¼æ•°æ®åº“æœ€ä½³å®è·µï¼ˆCitusï¼‰

```sql
-- Citusåˆ†å¸ƒå¼æœ€ä½³å®è·µ

-- 1. é€‰æ‹©åˆé€‚çš„åˆ†å¸ƒé”®
-- é«˜åŸºæ•°ã€æŸ¥è¯¢é¢‘ç¹ã€ä¸å…¶ä»–è¡¨å¯colocate
SELECT create_distributed_table('orders', 'tenant_id');
SELECT create_distributed_table('order_items', 'tenant_id',
    colocate_with => 'orders');

-- 2. æœ¬åœ°è¡¨ç”¨äºä½åŸºæ•°ç»´åº¦æ•°æ®
SELECT create_reference_table('countries');
SELECT create_reference_table('currencies');

-- 3. é¿å…è·¨åˆ†ç‰‡JOIN
-- å¥½ï¼šåŒä¸€tenant_idçš„JOINï¼ˆæœ¬åœ°æ‰§è¡Œï¼‰
SELECT o.*, oi.* FROM orders o
JOIN order_items oi ON o.order_id = oi.order_id
WHERE o.tenant_id = $1;

-- å·®ï¼šè·¨tenant_idçš„èšåˆï¼ˆéœ€è¦é‡åˆ†å¸ƒï¼‰
SELECT tenant_id, SUM(amount) FROM orders GROUP BY tenant_id;

-- 4. ä½¿ç”¨åˆ†å¸ƒå¼å‡½æ•°
CREATE OR REPLACE FUNCTION get_tenant_stats(p_tenant_id BIGINT)
RETURNS TABLE (total_orders BIGINT, total_amount NUMERIC) AS $$
    SELECT COUNT(*), SUM(amount) FROM orders WHERE tenant_id = p_tenant_id;
$$ LANGUAGE SQL;
```

---

## 13. AIé›†æˆæœ€ä½³å®è·µ

### 13.1. RAGç³»ç»Ÿè®¾è®¡æœ€ä½³å®è·µ

```sql
-- RAGç³»ç»Ÿæœ€ä½³å®è·µSchema

-- 1. æ–‡æ¡£å—è¡¨è®¾è®¡
CREATE TABLE rag_chunks (
    chunk_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    document_id UUID NOT NULL,
    content TEXT NOT NULL,
    embedding vector(1536),      -- OpenAI text-embedding-3-small
    metadata JSONB DEFAULT '{}', -- åŒ…å«source, page, sectionç­‰
    token_count INTEGER,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. HNSWç´¢å¼•ï¼ˆå¹³è¡¡å¬å›ç‡å’Œé€Ÿåº¦ï¼‰
CREATE INDEX idx_chunks_embedding ON rag_chunks
USING hnsw (embedding vector_cosine_ops)
WITH (m = 24, ef_construction = 100);  -- æé«˜å¬å›ç‡

-- 3. å…¨æ–‡æœç´¢ç´¢å¼•ï¼ˆæ··åˆæ£€ç´¢ï¼‰
CREATE INDEX idx_chunks_content_fts ON rag_chunks
USING GIN(to_tsvector('english', content));

-- 4. å…ƒæ•°æ®æŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_chunks_metadata ON rag_chunks USING GIN(metadata);
CREATE INDEX idx_chunks_doc ON rag_chunks(document_id);

-- 5. æ··åˆæ£€ç´¢å‡½æ•°ï¼ˆRRFèåˆï¼‰
CREATE OR REPLACE FUNCTION hybrid_rag_search(
    p_query TEXT,
    p_embedding vector(1536),
    p_filter JSONB DEFAULT NULL,
    p_limit INTEGER DEFAULT 10,
    p_vector_weight FLOAT DEFAULT 0.7
) RETURNS TABLE (
    chunk_id UUID,
    content TEXT,
    metadata JSONB,
    score FLOAT
) AS $$
WITH params AS (SELECT 60 AS k),  -- RRFå¸¸æ•°
vector_search AS (
    SELECT chunk_id, content, metadata,
           ROW_NUMBER() OVER (ORDER BY embedding <=> p_embedding) AS vrank
    FROM rag_chunks
    WHERE (p_filter IS NULL OR metadata @> p_filter)
    ORDER BY embedding <=> p_embedding
    LIMIT p_limit * 3
),
text_search AS (
    SELECT chunk_id, content, metadata,
           ROW_NUMBER() OVER (
               ORDER BY ts_rank_cd(to_tsvector('english', content),
                        websearch_to_tsquery('english', p_query)) DESC
           ) AS trank
    FROM rag_chunks
    WHERE to_tsvector('english', content) @@ websearch_to_tsquery('english', p_query)
      AND (p_filter IS NULL OR metadata @> p_filter)
    LIMIT p_limit * 3
)
SELECT
    COALESCE(v.chunk_id, t.chunk_id),
    COALESCE(v.content, t.content),
    COALESCE(v.metadata, t.metadata),
    (p_vector_weight / ((SELECT k FROM params) + COALESCE(v.vrank, 1000)) +
     (1 - p_vector_weight) / ((SELECT k FROM params) + COALESCE(t.trank, 1000)))::FLOAT
FROM vector_search v
FULL OUTER JOIN text_search t USING (chunk_id)
ORDER BY 4 DESC
LIMIT p_limit;
$$ LANGUAGE SQL STABLE;
```

### 13.2. å‘é‡æ•°æ®åº“æ€§èƒ½æœ€ä½³å®è·µ

| åœºæ™¯ | æœ€ä½³å®è·µ | å‚æ•°é…ç½® | æ•ˆæœ |
|------|---------|---------|------|
| **é«˜å¬å›ç‡** | å¢å¤§HNSW må‚æ•° | `m=32, ef_construction=200` | å¬å›ç‡+10% |
| **ä½å»¶è¿Ÿ** | å‡å°ef_search | `ef_search=40` | å»¶è¿Ÿ-30% |
| **å¤§è§„æ¨¡æ•°æ®** | IVFFlat + åˆ†åŒº | `lists=sqrt(n)` | å†…å­˜-50% |
| **æ··åˆæŸ¥è¯¢** | é¢„è¿‡æ»¤ + å‘é‡ | `WHERE + ORDER BY <=>` | å‡†ç¡®ç‡+20% |
| **æ‰¹é‡æ’å…¥** | ç¦ç”¨ç´¢å¼•åæ‰¹é‡ | `DROP INDEX â†’ INSERT â†’ CREATE INDEX` | é€Ÿåº¦+5x |

---

## 14. å‚è€ƒèµ„æ–™

### 14.1. è¡Œä¸šæ ‡å‡†ä¸è§„èŒƒ

- [AWS Well-Architected Framework - Database](https://aws.amazon.com/architecture/well-architected/)
- [Google Cloud Database Best Practices](https://cloud.google.com/architecture/best-practices-for-databases)
- [PostgreSQLå®˜æ–¹Wiki](https://wiki.postgresql.org/)
- [PCI-DSSæ•°æ®åº“è¦æ±‚](https://www.pcisecuritystandards.org/)

### 14.2. ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“è®¾è®¡æœ€ä½³å®è·µåº“](./07.14-æ•°æ®åº“è®¾è®¡æœ€ä½³å®è·µåº“.md)
- [æ•°æ®åº“è®¾è®¡å·¥å…·ä¸æ¨¡æ¿åº“](./07.15-æ•°æ®åº“è®¾è®¡å·¥å…·ä¸æ¨¡æ¿åº“.md)
- [æ•°æ®åº“è®¾è®¡è¯„å®¡ä¸è´¨é‡ä¿è¯](./07.26-æ•°æ®åº“è®¾è®¡è¯„å®¡ä¸è´¨é‡ä¿è¯.md)
- [æ•°æ®åº“è®¾è®¡æ¨¡å¼æ€»ç»“ä¸ç´¢å¼•](./07.27-æ•°æ®åº“è®¾è®¡æ¨¡å¼æ€»ç»“ä¸ç´¢å¼•.md)
- [å‘é‡æ•°æ®åº“è®¾è®¡](./07.10-å‘é‡æ•°æ®åº“è®¾è®¡.md)
- [åˆ†å¸ƒå¼æ•°æ®åº“è®¾è®¡](./07.17-åˆ†å¸ƒå¼æ•°æ®åº“è®¾è®¡æ¨¡å¼.md)

---

**æœ€åæ›´æ–°**ï¼š2025-12-01
**ç»´æŠ¤è€…**ï¼šData-Science Team
**çŠ¶æ€**ï¼šå·²å®Œæˆ âœ…
