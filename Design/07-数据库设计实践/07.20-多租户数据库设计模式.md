# å¤šç§Ÿæˆ·æ•°æ®åº“è®¾è®¡æ¨¡å¼ï¼šSaaSç³»ç»Ÿçš„æ•°æ®éš”ç¦»ä¸æ‰©å±•

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-12-01
> **ç‰ˆæœ¬**ï¼šv2.0 (å¢å¼ºç‰ˆ)
> **çŠ¶æ€**ï¼šå®æ–½ä¸­

---

## ğŸ“‹ ç›®å½•

- [å¤šç§Ÿæˆ·æ•°æ®åº“è®¾è®¡æ¨¡å¼ï¼šSaaSç³»ç»Ÿçš„æ•°æ®éš”ç¦»ä¸æ‰©å±•](#å¤šç§Ÿæˆ·æ•°æ®åº“è®¾è®¡æ¨¡å¼saasç³»ç»Ÿçš„æ•°æ®éš”ç¦»ä¸æ‰©å±•)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1. å¤šç§Ÿæˆ·åº”ç”¨åœºæ™¯](#11-å¤šç§Ÿæˆ·åº”ç”¨åœºæ™¯)
    - [1.2. å¤šç§Ÿæˆ·æ¶æ„é€‰æ‹©å†³ç­–æ ‘](#12-å¤šç§Ÿæˆ·æ¶æ„é€‰æ‹©å†³ç­–æ ‘)
  - [2. å¤šç§Ÿæˆ·æ¶æ„æ¨¡å¼](#2-å¤šç§Ÿæˆ·æ¶æ„æ¨¡å¼)
    - [2.1. æ¶æ„æ¨¡å¼å¯¹æ¯”](#21-æ¶æ„æ¨¡å¼å¯¹æ¯”)
    - [2.2. æ¶æ„æ¨¡å¼é€‰æ‹©å†³ç­–çŸ©é˜µ](#22-æ¶æ„æ¨¡å¼é€‰æ‹©å†³ç­–çŸ©é˜µ)
  - [3. å…±äº«æ•°æ®åº“+è¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰è®¾è®¡](#3-å…±äº«æ•°æ®åº“è¡Œçº§å®‰å…¨rlsè®¾è®¡)
    - [3.1. RLSåŸºç¡€Schemaè®¾è®¡](#31-rlsåŸºç¡€schemaè®¾è®¡)
    - [3.2. RLSç­–ç•¥å®ç°](#32-rlsç­–ç•¥å®ç°)
    - [3.3. ä¸šåŠ¡è¡¨RLSè®¾è®¡](#33-ä¸šåŠ¡è¡¨rlsè®¾è®¡)
    - [3.4. RLSæ€§èƒ½ä¼˜åŒ–](#34-rlsæ€§èƒ½ä¼˜åŒ–)
  - [4. å…±äº«æ•°æ®åº“+Schemaéš”ç¦»è®¾è®¡](#4-å…±äº«æ•°æ®åº“schemaéš”ç¦»è®¾è®¡)
    - [4.1. Schemaéš”ç¦»Schemaè®¾è®¡](#41-schemaéš”ç¦»schemaè®¾è®¡)
    - [4.2. Schemaåˆ‡æ¢å‡½æ•°](#42-schemaåˆ‡æ¢å‡½æ•°)
  - [5. ç‹¬ç«‹æ•°æ®åº“è®¾è®¡](#5-ç‹¬ç«‹æ•°æ®åº“è®¾è®¡)
    - [5.1. ç‹¬ç«‹æ•°æ®åº“Schemaè®¾è®¡](#51-ç‹¬ç«‹æ•°æ®åº“schemaè®¾è®¡)
  - [6. å¤šç§Ÿæˆ·æ•°æ®è¿ç§»ä¸æ‰©å±•](#6-å¤šç§Ÿæˆ·æ•°æ®è¿ç§»ä¸æ‰©å±•)
    - [6.1. ç§Ÿæˆ·æ•°æ®è¿ç§»](#61-ç§Ÿæˆ·æ•°æ®è¿ç§»)
    - [6.2. ç§Ÿæˆ·æ•°æ®æ‰©å±•](#62-ç§Ÿæˆ·æ•°æ®æ‰©å±•)
  - [7. å®é™…åº”ç”¨æ¡ˆä¾‹](#7-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [7.1. SaaSé¡¹ç›®ç®¡ç†å¹³å°è®¾è®¡](#71-saasé¡¹ç›®ç®¡ç†å¹³å°è®¾è®¡)
  - [8. 2024-2025æœ€æ–°è¶‹åŠ¿](#8-2024-2025æœ€æ–°è¶‹åŠ¿)
    - [8.1. å¤šç§Ÿæˆ·æ¶æ„æ¼”è¿›](#81-å¤šç§Ÿæˆ·æ¶æ„æ¼”è¿›)
    - [8.2. å¤šç§Ÿæˆ·æ¨¡å¼é€‰æ‹©çŸ©é˜µ](#82-å¤šç§Ÿæˆ·æ¨¡å¼é€‰æ‹©çŸ©é˜µ)
    - [8.3. äº‘åŸç”Ÿå¤šç§Ÿæˆ·å®è·µ](#83-äº‘åŸç”Ÿå¤šç§Ÿæˆ·å®è·µ)
  - [9. å‚è€ƒèµ„æ–™](#9-å‚è€ƒèµ„æ–™)
    - [9.1. æƒå¨æ–‡çŒ®](#91-æƒå¨æ–‡çŒ®)
    - [9.2. åœ¨çº¿èµ„æº](#92-åœ¨çº¿èµ„æº)
    - [9.3. ç›¸å…³æ–‡æ¡£](#93-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

å¤šç§Ÿæˆ·æ•°æ®åº“è®¾è®¡æ˜¯SaaSç³»ç»Ÿçš„æ ¸å¿ƒï¼Œéœ€è¦åœ¨æ•°æ®éš”ç¦»ã€æˆæœ¬æ•ˆç›Šå’Œæ‰©å±•æ€§ä¹‹é—´å–å¾—å¹³è¡¡ã€‚

### 1.1. å¤šç§Ÿæˆ·åº”ç”¨åœºæ™¯

```mermaid
mindmap
  root((å¤šç§Ÿæˆ·åº”ç”¨))
    SaaSå¹³å°
      ä¼ä¸šåº”ç”¨
      é¡¹ç›®ç®¡ç†
      å®¢æˆ·å…³ç³»ç®¡ç†
    äº‘æœåŠ¡
      äº‘å­˜å‚¨
      äº‘æ•°æ®åº“
      äº‘è®¡ç®—
    ç”µå•†å¹³å°
      å¤šåº—é“ºå¹³å°
      å¸‚åœºå¹³å°
    å†…å®¹ç®¡ç†
      å¤šç«™ç‚¹CMS
      åšå®¢å¹³å°
```

### 1.2. å¤šç§Ÿæˆ·æ¶æ„é€‰æ‹©å†³ç­–æ ‘

```mermaid
flowchart TD
    A[é€‰æ‹©å¤šç§Ÿæˆ·æ¶æ„] --> B{ç§Ÿæˆ·æ•°é‡}

    B -->|å°‘é‡ç§Ÿæˆ·| C[ç‹¬ç«‹æ•°æ®åº“]
    B -->|å¤§é‡ç§Ÿæˆ·| D{æ•°æ®éš”ç¦»è¦æ±‚}

    C --> E[è®¾è®¡å®Œæˆ]

    D -->|å¼ºéš”ç¦»| F[å…±äº«æ•°æ®åº“+Schema]
    D -->|ä¸€èˆ¬éš”ç¦»| G[å…±äº«æ•°æ®åº“+RLS]

    F --> E
    G --> E
```

---

## 2. å¤šç§Ÿæˆ·æ¶æ„æ¨¡å¼

### 2.1. æ¶æ„æ¨¡å¼å¯¹æ¯”

**å¤šç§Ÿæˆ·æ¶æ„æ¨¡å¼å¯¹æ¯”çŸ©é˜µ**ï¼š

| æ¨¡å¼ | æ•°æ®éš”ç¦» | æˆæœ¬ | ç®¡ç†å¤æ‚åº¦ | æ‰©å±•æ€§ | æ€§èƒ½ | é€‚ç”¨åœºæ™¯ |
|------|---------|------|-----------|--------|------|---------|
| **ç‹¬ç«‹æ•°æ®åº“** | â­â­â­â­â­ | â­â­ | â­â­â­â­ | â­â­ | â­â­â­â­â­ | å°‘é‡ç§Ÿæˆ·ã€å¼ºéš”ç¦»éœ€æ±‚ |
| **å…±äº«æ•°æ®åº“+Schema** | â­â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­ | â­â­â­â­ | ä¸­ç­‰ç§Ÿæˆ·æ•°ã€éœ€è¦éš”ç¦» |
| **å…±äº«æ•°æ®åº“+RLS** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | å¤§é‡ç§Ÿæˆ·ã€æˆæœ¬æ•æ„Ÿ |

### 2.2. æ¶æ„æ¨¡å¼é€‰æ‹©å†³ç­–çŸ©é˜µ

**å†³ç­–å› ç´ æƒé‡**ï¼š

| å› ç´  | æƒé‡ | ç‹¬ç«‹æ•°æ®åº“ | Schemaéš”ç¦» | RLSéš”ç¦» |
|------|------|-----------|-----------|---------|
| **æ•°æ®éš”ç¦»** | 30% | 100 | 80 | 80 |
| **æˆæœ¬æ•ˆç›Š** | 25% | 20 | 80 | 100 |
| **ç®¡ç†å¤æ‚åº¦** | 20% | 40 | 60 | 100 |
| **æ‰©å±•æ€§** | 15% | 40 | 70 | 100 |
| **æ€§èƒ½** | 10% | 100 | 90 | 80 |
| **ç»¼åˆå¾—åˆ†** | - | 52 | 75 | **92** |

---

## 3. å…±äº«æ•°æ®åº“+è¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰è®¾è®¡

### 3.1. RLSåŸºç¡€Schemaè®¾è®¡

**ç§Ÿæˆ·è¡¨è®¾è®¡**ï¼š

```sql
CREATE SCHEMA multi_tenant;

-- ç§Ÿæˆ·è¡¨
CREATE TABLE multi_tenant.tenants (
    tenant_id BIGSERIAL PRIMARY KEY,
    tenant_name VARCHAR(200) NOT NULL,
    tenant_slug VARCHAR(100) NOT NULL UNIQUE,
    domain VARCHAR(200),
    plan VARCHAR(50) NOT NULL CHECK (plan IN ('free', 'basic', 'premium', 'enterprise')),
    is_active BOOLEAN DEFAULT TRUE,
    subscription_expires_at TIMESTAMPTZ,
    settings JSONB DEFAULT '{}'::jsonb,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_tenants_slug ON multi_tenant.tenants(tenant_slug);
CREATE INDEX idx_tenants_domain ON multi_tenant.tenants(domain);
CREATE INDEX idx_tenants_active ON multi_tenant.tenants(tenant_id) WHERE is_active = TRUE;

-- ç§Ÿæˆ·ç”¨æˆ·å…³è”è¡¨
CREATE TABLE multi_tenant.tenant_users (
    tenant_id BIGINT NOT NULL REFERENCES multi_tenant.tenants(tenant_id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL,  -- å¼•ç”¨å…¨å±€ç”¨æˆ·è¡¨
    role VARCHAR(50) NOT NULL CHECK (role IN ('owner', 'admin', 'member', 'viewer')),
    joined_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (tenant_id, user_id)
);

CREATE INDEX idx_tenant_users_tenant ON multi_tenant.tenant_users(tenant_id);
CREATE INDEX idx_tenant_users_user ON multi_tenant.tenant_users(user_id);
```

### 3.2. RLSç­–ç•¥å®ç°

**RLSç­–ç•¥å‡½æ•°**ï¼š

```sql
-- è®¾ç½®å½“å‰ç§Ÿæˆ·IDçš„å‡½æ•°
CREATE OR REPLACE FUNCTION set_current_tenant(p_tenant_id BIGINT)
RETURNS VOID AS $$
BEGIN
    PERFORM set_config('app.current_tenant_id', p_tenant_id::TEXT, FALSE);
END;
$$ LANGUAGE plpgsql;

-- è·å–å½“å‰ç§Ÿæˆ·IDçš„å‡½æ•°
CREATE OR REPLACE FUNCTION current_tenant_id()
RETURNS BIGINT AS $$
BEGIN
    RETURN COALESCE(
        NULLIF(current_setting('app.current_tenant_id', TRUE), '')::BIGINT,
        0
    );
END;
$$ LANGUAGE plpgsql STABLE;

-- ç”¨æˆ·è¡¨ï¼ˆå¤šç§Ÿæˆ·ï¼‰
CREATE TABLE multi_tenant.users (
    user_id BIGSERIAL PRIMARY KEY,
    tenant_id BIGINT NOT NULL REFERENCES multi_tenant.tenants(tenant_id) ON DELETE CASCADE,
    username VARCHAR(100) NOT NULL,
    email VARCHAR(200) NOT NULL,
    password_hash TEXT NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(tenant_id, username),
    UNIQUE(tenant_id, email)
);

-- å¯ç”¨RLS
ALTER TABLE multi_tenant.users ENABLE ROW LEVEL SECURITY;

-- RLSç­–ç•¥ï¼šåªèƒ½è®¿é—®å½“å‰ç§Ÿæˆ·çš„æ•°æ®
CREATE POLICY users_tenant_isolation ON multi_tenant.users
    FOR ALL
    USING (tenant_id = current_tenant_id())
    WITH CHECK (tenant_id = current_tenant_id());

-- åˆ›å»ºç´¢å¼•ï¼ˆtenant_idå¿…é¡»åœ¨æœ€å‰é¢ï¼‰
CREATE INDEX idx_users_tenant ON multi_tenant.users(tenant_id, username);
CREATE INDEX idx_users_tenant_email ON multi_tenant.users(tenant_id, email);
```

### 3.3. ä¸šåŠ¡è¡¨RLSè®¾è®¡

**è®¢å•è¡¨RLSè®¾è®¡**ï¼š

```sql
-- è®¢å•è¡¨ï¼ˆå¤šç§Ÿæˆ·ï¼‰
CREATE TABLE multi_tenant.orders (
    order_id BIGSERIAL PRIMARY KEY,
    tenant_id BIGINT NOT NULL REFERENCES multi_tenant.tenants(tenant_id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL REFERENCES multi_tenant.users(user_id) ON DELETE CASCADE,
    order_number VARCHAR(100) NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(tenant_id, order_number)
);

-- å¯ç”¨RLS
ALTER TABLE multi_tenant.orders ENABLE ROW LEVEL SECURITY;

-- RLSç­–ç•¥
CREATE POLICY orders_tenant_isolation ON multi_tenant.orders
    FOR ALL
    USING (tenant_id = current_tenant_id())
    WITH CHECK (tenant_id = current_tenant_id());

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_orders_tenant ON multi_tenant.orders(tenant_id, created_at DESC);
CREATE INDEX idx_orders_tenant_user ON multi_tenant.orders(tenant_id, user_id, created_at DESC);
CREATE INDEX idx_orders_tenant_status ON multi_tenant.orders(tenant_id, status, created_at DESC);

-- è®¢å•é¡¹è¡¨ï¼ˆå¤šç§Ÿæˆ·ï¼‰
CREATE TABLE multi_tenant.order_items (
    item_id BIGSERIAL PRIMARY KEY,
    tenant_id BIGINT NOT NULL REFERENCES multi_tenant.tenants(tenant_id) ON DELETE CASCADE,
    order_id BIGINT NOT NULL REFERENCES multi_tenant.orders(order_id) ON DELETE CASCADE,
    product_id BIGINT NOT NULL,  -- å¼•ç”¨äº§å“è¡¨
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    price DECIMAL(10,2) NOT NULL,
    subtotal DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- å¯ç”¨RLS
ALTER TABLE multi_tenant.order_items ENABLE ROW LEVEL SECURITY;

-- RLSç­–ç•¥
CREATE POLICY order_items_tenant_isolation ON multi_tenant.order_items
    FOR ALL
    USING (tenant_id = current_tenant_id())
    WITH CHECK (tenant_id = current_tenant_id());

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_order_items_tenant_order ON multi_tenant.order_items(tenant_id, order_id);
CREATE INDEX idx_order_items_tenant_product ON multi_tenant.order_items(tenant_id, product_id);
```

### 3.4. RLSæ€§èƒ½ä¼˜åŒ–

**RLSæ€§èƒ½ä¼˜åŒ–æŠ€å·§**ï¼š

```sql
-- âœ… å¥½çš„è®¾è®¡ï¼štenant_idä½œä¸ºä¸»é”®æˆ–å”¯ä¸€çº¦æŸçš„ç¬¬ä¸€åˆ—
CREATE TABLE multi_tenant.products (
    product_id BIGSERIAL,
    tenant_id BIGINT NOT NULL REFERENCES multi_tenant.tenants(tenant_id) ON DELETE CASCADE,
    sku VARCHAR(100) NOT NULL,
    name VARCHAR(500) NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    PRIMARY KEY (tenant_id, product_id),  -- å¤åˆä¸»é”®ï¼Œtenant_idåœ¨å‰
    UNIQUE(tenant_id, sku)
);

-- âœ… ç´¢å¼•è®¾è®¡ï¼štenant_idå¿…é¡»åœ¨æœ€å‰é¢
CREATE INDEX idx_products_tenant_sku ON multi_tenant.products(tenant_id, sku);
CREATE INDEX idx_products_tenant_name ON multi_tenant.products(tenant_id, name);

-- âŒ é¿å…ï¼štenant_idä¸åœ¨ç´¢å¼•æœ€å‰é¢
-- CREATE INDEX idx_products_name_tenant ON multi_tenant.products(name, tenant_id);  -- æ€§èƒ½å·®

-- âœ… ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•ä¼˜åŒ–ç‰¹å®šç§Ÿæˆ·æŸ¥è¯¢
CREATE INDEX idx_products_active ON multi_tenant.products(tenant_id, name)
WHERE is_active = TRUE;

-- âœ… ä½¿ç”¨è¦†ç›–ç´¢å¼•å‡å°‘å›è¡¨
CREATE INDEX idx_orders_covering ON multi_tenant.orders(tenant_id, status, created_at DESC)
INCLUDE (order_number, total_amount);
```

---

## 4. å…±äº«æ•°æ®åº“+Schemaéš”ç¦»è®¾è®¡

### 4.1. Schemaéš”ç¦»Schemaè®¾è®¡

**Schemaéš”ç¦»å®ç°**ï¼š

```sql
-- ä¸ºæ¯ä¸ªç§Ÿæˆ·åˆ›å»ºç‹¬ç«‹çš„Schema
CREATE SCHEMA tenant_001;
CREATE SCHEMA tenant_002;
CREATE SCHEMA tenant_003;

-- åœ¨ç§Ÿæˆ·Schemaä¸­åˆ›å»ºè¡¨
CREATE TABLE tenant_001.users (
    user_id SERIAL PRIMARY KEY,
    username VARCHAR(100) NOT NULL UNIQUE,
    email VARCHAR(200) NOT NULL UNIQUE,
    password_hash TEXT NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE tenant_001.orders (
    order_id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES tenant_001.users(user_id),
    order_number VARCHAR(100) NOT NULL UNIQUE,
    total_amount DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- ç§Ÿæˆ·Schemaæ˜ å°„è¡¨
CREATE TABLE multi_tenant.tenant_schemas (
    tenant_id BIGINT NOT NULL REFERENCES multi_tenant.tenants(tenant_id) ON DELETE CASCADE,
    schema_name VARCHAR(100) NOT NULL UNIQUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (tenant_id)
);

CREATE INDEX idx_tenant_schemas_name ON multi_tenant.tenant_schemas(schema_name);
```

### 4.2. Schemaåˆ‡æ¢å‡½æ•°

**Schemaåˆ‡æ¢å®ç°**ï¼š

```sql
-- Schemaåˆ‡æ¢å‡½æ•°
CREATE OR REPLACE FUNCTION switch_to_tenant_schema(p_tenant_id BIGINT)
RETURNS VOID AS $$
DECLARE
    v_schema_name VARCHAR(100);
BEGIN
    -- è·å–ç§Ÿæˆ·Schemaåç§°
    SELECT schema_name INTO v_schema_name
    FROM multi_tenant.tenant_schemas
    WHERE tenant_id = p_tenant_id;

    IF v_schema_name IS NULL THEN
        RAISE EXCEPTION 'Schema not found for tenant %', p_tenant_id;
    END IF;

    -- åˆ‡æ¢Schema
    EXECUTE format('SET search_path TO %I, public', v_schema_name);
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT switch_to_tenant_schema(1);
SELECT * FROM users;  -- æŸ¥è¯¢tenant_001.users
SELECT * FROM orders;  -- æŸ¥è¯¢tenant_001.orders
```

---

## 5. ç‹¬ç«‹æ•°æ®åº“è®¾è®¡

### 5.1. ç‹¬ç«‹æ•°æ®åº“Schemaè®¾è®¡

**ç‹¬ç«‹æ•°æ®åº“å®ç°**ï¼š

```sql
-- ä¸ºæ¯ä¸ªç§Ÿæˆ·åˆ›å»ºç‹¬ç«‹æ•°æ®åº“
CREATE DATABASE tenant_001;
CREATE DATABASE tenant_002;
CREATE DATABASE tenant_003;

-- è¿æ¥åˆ°ç§Ÿæˆ·æ•°æ®åº“
\c tenant_001

-- åœ¨ç§Ÿæˆ·æ•°æ®åº“ä¸­åˆ›å»ºè¡¨
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    username VARCHAR(100) NOT NULL UNIQUE,
    email VARCHAR(200) NOT NULL UNIQUE,
    password_hash TEXT NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE orders (
    order_id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(user_id),
    order_number VARCHAR(100) NOT NULL UNIQUE,
    total_amount DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- ç§Ÿæˆ·æ•°æ®åº“æ˜ å°„è¡¨ï¼ˆåœ¨ä¸»æ•°æ®åº“ä¸­ï¼‰
CREATE TABLE multi_tenant.tenant_databases (
    tenant_id BIGINT NOT NULL REFERENCES multi_tenant.tenants(tenant_id) ON DELETE CASCADE,
    database_name VARCHAR(100) NOT NULL UNIQUE,
    connection_string TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (tenant_id)
);
```

---

## 6. å¤šç§Ÿæˆ·æ•°æ®è¿ç§»ä¸æ‰©å±•

### 6.1. ç§Ÿæˆ·æ•°æ®è¿ç§»

**ç§Ÿæˆ·æ•°æ®è¿ç§»å‡½æ•°**ï¼š

```sql
-- ç§Ÿæˆ·æ•°æ®è¿ç§»å‡½æ•°ï¼ˆä»RLSè¿ç§»åˆ°ç‹¬ç«‹Schemaï¼‰
CREATE OR REPLACE FUNCTION migrate_tenant_to_schema(
    p_tenant_id BIGINT,
    p_schema_name VARCHAR
)
RETURNS VOID AS $$
DECLARE
    v_table_name TEXT;
    v_table_record RECORD;
BEGIN
    -- åˆ›å»ºSchema
    EXECUTE format('CREATE SCHEMA IF NOT EXISTS %I', p_schema_name);

    -- è·å–æ‰€æœ‰ç§Ÿæˆ·è¡¨
    FOR v_table_record IN
        SELECT table_name
        FROM information_schema.tables
        WHERE table_schema = 'multi_tenant'
          AND table_name NOT IN ('tenants', 'tenant_users', 'tenant_schemas')
    LOOP
        v_table_name := v_table_record.table_name;

        -- åˆ›å»ºè¡¨ç»“æ„ï¼ˆå¤åˆ¶ç»“æ„ï¼‰
        EXECUTE format('
            CREATE TABLE %I.%I (LIKE multi_tenant.%I INCLUDING ALL)
        ', p_schema_name, v_table_name, v_table_name);

        -- è¿ç§»æ•°æ®
        EXECUTE format('
            INSERT INTO %I.%I
            SELECT * FROM multi_tenant.%I
            WHERE tenant_id = %L
        ', p_schema_name, v_table_name, v_table_name, p_tenant_id);

        -- æ›´æ–°åºåˆ—
        EXECUTE format('
            SELECT setval(
                pg_get_serial_sequence(''%I.%I'', ''%I_id''),
                COALESCE((SELECT MAX(%I_id) FROM %I.%I), 1),
                true
            )
        ', p_schema_name, v_table_name, v_table_name, v_table_name, p_schema_name, v_table_name);
    END LOOP;

    -- è®°å½•Schemaæ˜ å°„
    INSERT INTO multi_tenant.tenant_schemas (tenant_id, schema_name)
    VALUES (p_tenant_id, p_schema_name)
    ON CONFLICT (tenant_id) DO UPDATE SET schema_name = EXCLUDED.schema_name;
END;
$$ LANGUAGE plpgsql;
```

### 6.2. ç§Ÿæˆ·æ•°æ®æ‰©å±•

**ç§Ÿæˆ·æ•°æ®æ‰©å±•å‡½æ•°**ï¼š

```sql
-- ç§Ÿæˆ·æ•°æ®æ‰©å±•å‡½æ•°ï¼ˆæ·»åŠ ç§Ÿæˆ·ç‰¹å®šå­—æ®µï¼‰
CREATE OR REPLACE FUNCTION extend_tenant_table(
    p_tenant_id BIGINT,
    p_table_name VARCHAR,
    p_column_name VARCHAR,
    p_column_type VARCHAR
)
RETURNS VOID AS $$
DECLARE
    v_schema_name VARCHAR(100);
BEGIN
    -- è·å–ç§Ÿæˆ·Schemaåç§°
    SELECT schema_name INTO v_schema_name
    FROM multi_tenant.tenant_schemas
    WHERE tenant_id = p_tenant_id;

    IF v_schema_name IS NULL THEN
        RAISE EXCEPTION 'Schema not found for tenant %', p_tenant_id;
    END IF;

    -- æ·»åŠ åˆ—
    EXECUTE format('
        ALTER TABLE %I.%I
        ADD COLUMN IF NOT EXISTS %I %s
    ', v_schema_name, p_table_name, p_column_name, p_column_type);
END;
$$ LANGUAGE plpgsql;
```

---

## 7. å®é™…åº”ç”¨æ¡ˆä¾‹

### 7.1. SaaSé¡¹ç›®ç®¡ç†å¹³å°è®¾è®¡

**å®Œæ•´SaaSå¹³å°Schemaè®¾è®¡**ï¼š

```sql
CREATE SCHEMA saas_platform;

-- ç§Ÿæˆ·è¡¨
CREATE TABLE saas_platform.tenants (
    tenant_id BIGSERIAL PRIMARY KEY,
    tenant_name VARCHAR(200) NOT NULL,
    tenant_slug VARCHAR(100) NOT NULL UNIQUE,
    domain VARCHAR(200),
    plan VARCHAR(50) NOT NULL CHECK (plan IN ('free', 'basic', 'premium', 'enterprise')),
    max_users INTEGER DEFAULT 10,
    max_projects INTEGER DEFAULT 5,
    is_active BOOLEAN DEFAULT TRUE,
    subscription_expires_at TIMESTAMPTZ,
    settings JSONB DEFAULT '{}'::jsonb,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- é¡¹ç›®è¡¨ï¼ˆå¤šç§Ÿæˆ·ï¼‰
CREATE TABLE saas_platform.projects (
    project_id BIGSERIAL PRIMARY KEY,
    tenant_id BIGINT NOT NULL REFERENCES saas_platform.tenants(tenant_id) ON DELETE CASCADE,
    project_name VARCHAR(200) NOT NULL,
    description TEXT,
    status VARCHAR(20) NOT NULL DEFAULT 'active',
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(tenant_id, project_name)
);

-- å¯ç”¨RLS
ALTER TABLE saas_platform.projects ENABLE ROW LEVEL SECURITY;

-- RLSç­–ç•¥
CREATE POLICY projects_tenant_isolation ON saas_platform.projects
    FOR ALL
    USING (tenant_id = current_tenant_id())
    WITH CHECK (tenant_id = current_tenant_id());

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_projects_tenant ON saas_platform.projects(tenant_id, created_at DESC);
CREATE INDEX idx_projects_tenant_status ON saas_platform.projects(tenant_id, status);

-- ä»»åŠ¡è¡¨ï¼ˆå¤šç§Ÿæˆ·ï¼‰
CREATE TABLE saas_platform.tasks (
    task_id BIGSERIAL PRIMARY KEY,
    tenant_id BIGINT NOT NULL REFERENCES saas_platform.tenants(tenant_id) ON DELETE CASCADE,
    project_id BIGINT NOT NULL REFERENCES saas_platform.projects(project_id) ON DELETE CASCADE,
    task_name VARCHAR(500) NOT NULL,
    description TEXT,
    assignee_id BIGINT,
    status VARCHAR(20) NOT NULL DEFAULT 'todo',
    priority VARCHAR(20) NOT NULL DEFAULT 'medium',
    due_date TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- å¯ç”¨RLS
ALTER TABLE saas_platform.tasks ENABLE ROW LEVEL SECURITY;

-- RLSç­–ç•¥
CREATE POLICY tasks_tenant_isolation ON saas_platform.tasks
    FOR ALL
    USING (tenant_id = current_tenant_id())
    WITH CHECK (tenant_id = current_tenant_id());

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_tasks_tenant_project ON saas_platform.tasks(tenant_id, project_id, created_at DESC);
CREATE INDEX idx_tasks_tenant_status ON saas_platform.tasks(tenant_id, status);
CREATE INDEX idx_tasks_tenant_assignee ON saas_platform.tasks(tenant_id, assignee_id);

-- ç§Ÿæˆ·é™åˆ¶æ£€æŸ¥å‡½æ•°
CREATE OR REPLACE FUNCTION check_tenant_limits(
    p_tenant_id BIGINT,
    p_resource_type VARCHAR
)
RETURNS BOOLEAN AS $$
DECLARE
    v_tenant RECORD;
    v_current_count INTEGER;
BEGIN
    -- è·å–ç§Ÿæˆ·ä¿¡æ¯
    SELECT * INTO v_tenant
    FROM saas_platform.tenants
    WHERE tenant_id = p_tenant_id;

    IF NOT FOUND THEN
        RETURN FALSE;
    END IF;

    -- æ£€æŸ¥èµ„æºé™åˆ¶
    IF p_resource_type = 'users' THEN
        SELECT COUNT(*) INTO v_current_count
        FROM multi_tenant.users
        WHERE tenant_id = p_tenant_id;

        RETURN v_current_count < v_tenant.max_users;
    ELSIF p_resource_type = 'projects' THEN
        SELECT COUNT(*) INTO v_current_count
        FROM saas_platform.projects
        WHERE tenant_id = p_tenant_id;

        RETURN v_current_count < v_tenant.max_projects;
    END IF;

    RETURN TRUE;
END;
$$ LANGUAGE plpgsql;

-- é¡¹ç›®åˆ›å»ºè§¦å‘å™¨ï¼ˆæ£€æŸ¥é™åˆ¶ï¼‰
CREATE OR REPLACE FUNCTION check_project_limit_trigger()
RETURNS TRIGGER AS $$
BEGIN
    IF NOT check_tenant_limits(NEW.tenant_id, 'projects') THEN
        RAISE EXCEPTION 'Project limit exceeded for tenant %', NEW.tenant_id;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_check_project_limit
BEFORE INSERT ON saas_platform.projects
FOR EACH ROW
EXECUTE FUNCTION check_project_limit_trigger();
```

---

## 8. 2024-2025æœ€æ–°è¶‹åŠ¿

### 8.1. å¤šç§Ÿæˆ·æ¶æ„æ¼”è¿›

```mermaid
timeline
    title å¤šç§Ÿæˆ·æ¶æ„æ¼”è¿›
    2010 : å•æ•°æ®åº“å…±äº«
         : ç®€å•éš”ç¦»
    2015 : Schemaéš”ç¦»
         : ä¼ä¸šçº§SaaS
    2018 : RLSè¡Œçº§å®‰å…¨
         : PostgreSQLåŸç”Ÿ
    2021 : Serverlesså¤šç§Ÿæˆ·
         : å¼¹æ€§æ‰©å±•
    2024 : AIå¢å¼ºéš”ç¦»
         : æ™ºèƒ½èµ„æºåˆ†é…
    2025 : é›¶ä¿¡ä»»å¤šç§Ÿæˆ·
         : åŠ å¯†éš”ç¦»
```

### 8.2. å¤šç§Ÿæˆ·æ¨¡å¼é€‰æ‹©çŸ©é˜µ

| æ¨¡å¼ | éš”ç¦»çº§åˆ« | æˆæœ¬ | å®šåˆ¶åŒ– | è¿ç»´å¤æ‚åº¦ | é€‚ç”¨è§„æ¨¡ |
|------|---------|------|--------|-----------|---------|
| **å…±äº«è¡¨+RLS** | ä½ | æœ€ä½ | ä½ | ä½ | å°è§„æ¨¡SaaS |
| **å…±äº«åº“+Schema** | ä¸­ | ä½ | ä¸­ | ä¸­ | ä¸­è§„æ¨¡SaaS |
| **ç‹¬ç«‹æ•°æ®åº“** | é«˜ | é«˜ | é«˜ | é«˜ | ä¼ä¸šçº§ |
| **æ··åˆæ¨¡å¼** | å¯è°ƒ | ä¸­ | é«˜ | é«˜ | å¤šå±‚çº§SaaS |

### 8.3. äº‘åŸç”Ÿå¤šç§Ÿæˆ·å®è·µ

```sql
-- Citusåˆ†å¸ƒå¼å¤šç§Ÿæˆ·é…ç½®
-- 1. åˆ›å»ºåˆ†å¸ƒå¼è¡¨
SELECT create_distributed_table('tenants', 'tenant_id');
SELECT create_distributed_table('users', 'tenant_id');
SELECT create_distributed_table('projects', 'tenant_id');

-- 2. è®¾ç½®ç§Ÿæˆ·å…±ç½®ï¼ˆCo-locationï¼‰
SELECT citus_set_coordinator_host('coordinator-host');

-- 3. ç§Ÿæˆ·çº§åˆ«èµ„æºé™åˆ¶
CREATE TABLE tenant_quotas (
    tenant_id UUID PRIMARY KEY,
    cpu_limit INTEGER,
    memory_limit_mb INTEGER,
    storage_limit_gb INTEGER,
    concurrent_connections INTEGER
);

-- 4. ç§Ÿæˆ·éš”ç¦»å®¡è®¡
CREATE TABLE tenant_access_log (
    log_id BIGSERIAL,
    tenant_id UUID NOT NULL,
    user_id UUID,
    action VARCHAR(100),
    resource_type VARCHAR(100),
    resource_id TEXT,
    ip_address INET,
    timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (tenant_id, log_id)
);

SELECT create_distributed_table('tenant_access_log', 'tenant_id');
```

---

## 9. å‚è€ƒèµ„æ–™

### 9.1. æƒå¨æ–‡çŒ®

**å¤šç§Ÿæˆ·æ¶æ„**ï¼š

- Chong, F. & Carraro, G. (2006). "Architecture Strategies for Catching the Long Tail" (Microsoft)
- Aulbach, S. et al. (2008). "Multi-tenant Databases for Software as a Service"

### 9.2. åœ¨çº¿èµ„æº

| èµ„æº | URL | æè¿° |
|------|-----|------|
| **PostgreSQL RLS** | <https://www.postgresql.org/docs/current/ddl-rowsecurity.html> | è¡Œçº§å®‰å…¨ |
| **Cituså¤šç§Ÿæˆ·** | <https://docs.citusdata.com/en/stable/use_cases/multi_tenant.html> | åˆ†å¸ƒå¼å¤šç§Ÿæˆ· |
| **AWSå¤šç§Ÿæˆ·** | <https://aws.amazon.com/solutions/multi-tenant/> | äº‘åŸç”Ÿå®è·µ |

### 9.3. ç›¸å…³æ–‡æ¡£

- [07.17-åˆ†å¸ƒå¼æ•°æ®åº“è®¾è®¡æ¨¡å¼](./07.17-åˆ†å¸ƒå¼æ•°æ®åº“è®¾è®¡æ¨¡å¼.md)
- [07.14-æ•°æ®åº“è®¾è®¡æœ€ä½³å®è·µåº“](./07.14-æ•°æ®åº“è®¾è®¡æœ€ä½³å®è·µåº“.md)
- [07.23-æ•°æ®åº“å®‰å…¨è®¾è®¡æ¨¡å¼](./07.23-æ•°æ®åº“å®‰å…¨è®¾è®¡æ¨¡å¼.md)

---

**æœ€åæ›´æ–°**ï¼š2025-12-01
**ç»´æŠ¤è€…**ï¼šData-Science Team
**çŠ¶æ€**ï¼šå®æ–½ä¸­
**ç‰ˆæœ¬**ï¼šv2.0 (å¢å¼ºç‰ˆ)
