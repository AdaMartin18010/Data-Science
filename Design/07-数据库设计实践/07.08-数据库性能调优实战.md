# æ•°æ®åº“æ€§èƒ½è°ƒä¼˜å®æˆ˜ï¼šä»é—®é¢˜è¯Šæ–­åˆ°ä¼˜åŒ–å®æ–½

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-01-15
> **ç‰ˆæœ¬**ï¼šv1.0
> **çŠ¶æ€**ï¼šå®æ–½ä¸­

---

## ğŸ“‹ ç›®å½•

- [æ•°æ®åº“æ€§èƒ½è°ƒä¼˜å®æˆ˜ï¼šä»é—®é¢˜è¯Šæ–­åˆ°ä¼˜åŒ–å®æ–½](#æ•°æ®åº“æ€§èƒ½è°ƒä¼˜å®æˆ˜ä»é—®é¢˜è¯Šæ–­åˆ°ä¼˜åŒ–å®æ–½)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1. æ€§èƒ½è°ƒä¼˜æµç¨‹](#11-æ€§èƒ½è°ƒä¼˜æµç¨‹)
  - [2. æ€§èƒ½é—®é¢˜è¯Šæ–­](#2-æ€§èƒ½é—®é¢˜è¯Šæ–­)
    - [2.1. æ…¢æŸ¥è¯¢è¯†åˆ«](#21-æ…¢æŸ¥è¯¢è¯†åˆ«)
    - [2.2. é”ç­‰å¾…åˆ†æ](#22-é”ç­‰å¾…åˆ†æ)
    - [2.3. è¡¨ç»Ÿè®¡ä¿¡æ¯åˆ†æ](#23-è¡¨ç»Ÿè®¡ä¿¡æ¯åˆ†æ)
  - [3. æŸ¥è¯¢ä¼˜åŒ–å®æˆ˜](#3-æŸ¥è¯¢ä¼˜åŒ–å®æˆ˜)
    - [3.1. JOINä¼˜åŒ–](#31-joinä¼˜åŒ–)
    - [3.2. å­æŸ¥è¯¢ä¼˜åŒ–](#32-å­æŸ¥è¯¢ä¼˜åŒ–)
    - [3.3. åˆ†é¡µä¼˜åŒ–](#33-åˆ†é¡µä¼˜åŒ–)
  - [4. ç´¢å¼•ä¼˜åŒ–å®æˆ˜](#4-ç´¢å¼•ä¼˜åŒ–å®æˆ˜)
    - [4.1. ç´¢å¼•ä½¿ç”¨åˆ†æ](#41-ç´¢å¼•ä½¿ç”¨åˆ†æ)
    - [4.2. ç´¢å¼•ä¼˜åŒ–æ¡ˆä¾‹](#42-ç´¢å¼•ä¼˜åŒ–æ¡ˆä¾‹)
  - [5. é…ç½®ä¼˜åŒ–](#5-é…ç½®ä¼˜åŒ–)
    - [5.1. PostgreSQLé…ç½®ä¼˜åŒ–](#51-postgresqlé…ç½®ä¼˜åŒ–)
    - [5.2. è‡ªåŠ¨VACUUMä¼˜åŒ–](#52-è‡ªåŠ¨vacuumä¼˜åŒ–)
  - [6. ç›‘æ§ä¸å‘Šè­¦](#6-ç›‘æ§ä¸å‘Šè­¦)
    - [6.1. æ€§èƒ½ç›‘æ§è§†å›¾](#61-æ€§èƒ½ç›‘æ§è§†å›¾)
    - [6.2. å‘Šè­¦è§„åˆ™](#62-å‘Šè­¦è§„åˆ™)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

æ€§èƒ½è°ƒä¼˜æ˜¯æ•°æ®åº“ç®¡ç†çš„æ ¸å¿ƒæŠ€èƒ½ã€‚æœ¬æ–‡æ¡£æä¾›ä»é—®é¢˜è¯Šæ–­åˆ°ä¼˜åŒ–å®æ–½çš„å®Œæ•´å®æˆ˜æŒ‡å—ã€‚

### 1.1. æ€§èƒ½è°ƒä¼˜æµç¨‹

```mermaid
flowchart TD
    A[æ€§èƒ½é—®é¢˜] --> B[é—®é¢˜è¯Šæ–­]
    B --> C[è¯†åˆ«ç“¶é¢ˆ]
    C --> D{ç“¶é¢ˆç±»å‹}

    D -->|æŸ¥è¯¢æ…¢| E[æŸ¥è¯¢ä¼˜åŒ–]
    D -->|ç´¢å¼•ç¼ºå¤±| F[ç´¢å¼•ä¼˜åŒ–]
    D -->|é…ç½®ä¸å½“| G[é…ç½®ä¼˜åŒ–]
    D -->|ç¡¬ä»¶ä¸è¶³| H[ç¡¬ä»¶å‡çº§]

    E --> I[å®æ–½ä¼˜åŒ–]
    F --> I
    G --> I
    H --> I

    I --> J[éªŒè¯æ•ˆæœ]
    J --> K{æ€§èƒ½æå‡?}
    K -->|æ˜¯| L[ä¼˜åŒ–å®Œæˆ]
    K -->|å¦| M[é‡æ–°è¯Šæ–­]
    M --> B
```

---

## 2. æ€§èƒ½é—®é¢˜è¯Šæ–­

### 2.1. æ…¢æŸ¥è¯¢è¯†åˆ«

**å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆPostgreSQLï¼‰**ï¼š

```sql
-- å¯ç”¨pg_stat_statementsæ‰©å±•
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    (total_exec_time / calls) AS avg_time_per_call
FROM pg_stat_statements
WHERE mean_exec_time > 1000  -- å¹³å‡æ‰§è¡Œæ—¶é—´è¶…è¿‡1ç§’
ORDER BY mean_exec_time DESC
LIMIT 20;
```

**æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’åˆ†æ**ï¼š

```sql
-- åˆ†ææŸ¥è¯¢è®¡åˆ’
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT u.username, o.total, o.order_date
FROM users u
JOIN orders o ON u.id = o.user_id
WHERE u.email = 'user@example.com'
ORDER BY o.order_date DESC
LIMIT 10;

-- å…³é”®æŒ‡æ ‡è§£è¯»ï¼š
-- Seq Scan: å…¨è¡¨æ‰«æï¼Œé€šå¸¸éœ€è¦ä¼˜åŒ–
-- Index Scan: ç´¢å¼•æ‰«æï¼Œé€šå¸¸è¾ƒå¥½
-- Nested Loop: åµŒå¥—å¾ªç¯ï¼Œå°æ•°æ®é›†æ—¶å¥½
-- Hash Join: å“ˆå¸Œè¿æ¥ï¼Œå¤§æ•°æ®é›†æ—¶å¥½
-- Sort: æ’åºæ“ä½œï¼Œå¯èƒ½éœ€è¦ç´¢å¼•ä¼˜åŒ–
```

### 2.2. é”ç­‰å¾…åˆ†æ

**é”ç­‰å¾…æŸ¥è¯¢**ï¼š

```sql
-- æŸ¥çœ‹å½“å‰é”ç­‰å¾…
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement,
    blocked_activity.application_name AS blocked_application,
    blocking_activity.application_name AS blocking_application
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
    AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
    AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
    AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
    AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
    AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
    AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

### 2.3. è¡¨ç»Ÿè®¡ä¿¡æ¯åˆ†æ

**è¡¨å¤§å°å’Œç»Ÿè®¡ä¿¡æ¯**ï¼š

```sql
-- è¡¨å¤§å°åˆ†æ
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    pg_size_pretty(pg_indexes_size(schemaname||'.'||tablename)) AS indexes_size,
    n_live_tup AS row_count,
    n_dead_tup AS dead_rows,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- è¡¨è†¨èƒ€æ£€æŸ¥
SELECT
    schemaname,
    tablename,
    n_dead_tup,
    n_live_tup,
    CASE
        WHEN n_live_tup > 0
        THEN ROUND(100.0 * n_dead_tup / (n_live_tup + n_dead_tup), 2)
        ELSE 0
    END AS dead_tuple_percentage
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000
ORDER BY n_dead_tup DESC;
```

---

## 3. æŸ¥è¯¢ä¼˜åŒ–å®æˆ˜

### 3.1. JOINä¼˜åŒ–

**ä¼˜åŒ–å‰ï¼ˆæ…¢æŸ¥è¯¢ï¼‰**ï¼š

```sql
-- é—®é¢˜ï¼šæ²¡æœ‰ç´¢å¼•ï¼Œå…¨è¡¨æ‰«æ
SELECT u.username, o.total, p.name
FROM users u
JOIN orders o ON u.id = o.user_id
JOIN order_items oi ON o.id = oi.order_id
JOIN products p ON oi.product_id = p.id
WHERE u.email = 'user@example.com';
```

**ä¼˜åŒ–å**ï¼š

```sql
-- 1. æ·»åŠ ç´¢å¼•
CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_order_items_order_id ON order_items(order_id);
CREATE INDEX idx_order_items_product_id ON order_items(product_id);
CREATE INDEX idx_users_email ON users(email);

-- 2. ä¼˜åŒ–æŸ¥è¯¢ï¼ˆä½¿ç”¨EXISTSæ›¿ä»£JOINï¼‰
SELECT u.username, o.total, p.name
FROM users u
JOIN orders o ON u.id = o.user_id
JOIN order_items oi ON o.id = oi.order_id
JOIN products p ON oi.product_id = p.id
WHERE u.email = 'user@example.com'
  AND EXISTS (
      SELECT 1 FROM order_items oi2
      WHERE oi2.order_id = o.id
  );

-- 3. æˆ–è€…ä½¿ç”¨ç‰©åŒ–è§†å›¾ï¼ˆå¦‚æœæŸ¥è¯¢é¢‘ç¹ï¼‰
CREATE MATERIALIZED VIEW user_order_summary AS
SELECT
    u.id AS user_id,
    u.username,
    u.email,
    o.id AS order_id,
    o.total,
    o.order_date,
    p.name AS product_name
FROM users u
JOIN orders o ON u.id = o.user_id
JOIN order_items oi ON o.id = oi.order_id
JOIN products p ON oi.product_id = p.id;

CREATE INDEX idx_user_order_summary_email ON user_order_summary(email);

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY user_order_summary;
```

### 3.2. å­æŸ¥è¯¢ä¼˜åŒ–

**ä¼˜åŒ–å‰**ï¼š

```sql
-- é—®é¢˜ï¼šç›¸å…³å­æŸ¥è¯¢ï¼Œæ‰§è¡ŒNæ¬¡
SELECT
    u.id,
    u.username,
    (SELECT COUNT(*) FROM orders WHERE user_id = u.id) AS order_count,
    (SELECT SUM(total) FROM orders WHERE user_id = u.id) AS total_spent
FROM users u;
```

**ä¼˜åŒ–å**ï¼š

```sql
-- ä½¿ç”¨JOINå’Œèšåˆ
SELECT
    u.id,
    u.username,
    COALESCE(o.order_count, 0) AS order_count,
    COALESCE(o.total_spent, 0) AS total_spent
FROM users u
LEFT JOIN (
    SELECT
        user_id,
        COUNT(*) AS order_count,
        SUM(total) AS total_spent
    FROM orders
    GROUP BY user_id
) o ON u.id = o.user_id;
```

### 3.3. åˆ†é¡µä¼˜åŒ–

**ä¼˜åŒ–å‰ï¼ˆæ·±åº¦åˆ†é¡µæ…¢ï¼‰**ï¼š

```sql
-- é—®é¢˜ï¼šOFFSETè¶Šå¤§è¶Šæ…¢
SELECT * FROM orders
ORDER BY order_date DESC
OFFSET 100000 LIMIT 20;
```

**ä¼˜åŒ–åï¼ˆæ¸¸æ ‡åˆ†é¡µï¼‰**ï¼š

```sql
-- ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µ
SELECT * FROM orders
WHERE order_date < '2024-01-01'  -- ä¸Šä¸€é¡µçš„æœ€åä¸€æ¡è®°å½•çš„order_date
ORDER BY order_date DESC
LIMIT 20;

-- æˆ–è€…ä½¿ç”¨ç´¢å¼•è¦†ç›–
CREATE INDEX idx_orders_date_id ON orders(order_date DESC, id);

SELECT o.*
FROM (
    SELECT id
    FROM orders
    ORDER BY order_date DESC, id DESC
    LIMIT 20 OFFSET 100000
) sub
JOIN orders o ON sub.id = o.id
ORDER BY o.order_date DESC, o.id DESC;
```

---

## 4. ç´¢å¼•ä¼˜åŒ–å®æˆ˜

### 4.1. ç´¢å¼•ä½¿ç”¨åˆ†æ

**ç´¢å¼•ä½¿ç”¨æƒ…å†µæŸ¥è¯¢**ï¼š

```sql
-- æœªä½¿ç”¨çš„ç´¢å¼•
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE idx_scan = 0
  AND schemaname = 'public'
ORDER BY pg_relation_size(indexrelid) DESC;

-- ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan DESC;
```

### 4.2. ç´¢å¼•ä¼˜åŒ–æ¡ˆä¾‹

**æ¡ˆä¾‹1ï¼šå¤åˆç´¢å¼•ä¼˜åŒ–**:

```sql
-- æŸ¥è¯¢æ¨¡å¼
SELECT * FROM orders
WHERE user_id = 123
  AND status = 'completed'
  AND order_date >= '2024-01-01'
ORDER BY order_date DESC;

-- ä¼˜åŒ–ï¼šåˆ›å»ºå¤åˆç´¢å¼•
CREATE INDEX idx_orders_user_status_date
ON orders(user_id, status, order_date DESC);

-- ç´¢å¼•åˆ—é¡ºåºåŸåˆ™ï¼š
-- 1. ç­‰å€¼æŸ¥è¯¢åˆ—åœ¨å‰ï¼ˆuser_id, statusï¼‰
-- 2. èŒƒå›´æŸ¥è¯¢åˆ—åœ¨åï¼ˆorder_dateï¼‰
-- 3. æ’åºåˆ—åœ¨æœ€åï¼ˆorder_date DESCï¼‰
```

**æ¡ˆä¾‹2ï¼šéƒ¨åˆ†ç´¢å¼•ä¼˜åŒ–**:

```sql
-- æŸ¥è¯¢ï¼šåªæŸ¥è¯¢æ´»è·ƒè®¢å•
SELECT * FROM orders WHERE status = 'active';

-- ä¼˜åŒ–ï¼šåˆ›å»ºéƒ¨åˆ†ç´¢å¼•ï¼ˆåªç´¢å¼•æ´»è·ƒè®¢å•ï¼‰
CREATE INDEX idx_orders_active
ON orders(user_id, order_date DESC)
WHERE status = 'active';

-- ä¼˜åŠ¿ï¼šç´¢å¼•æ›´å°ï¼ŒæŸ¥è¯¢æ›´å¿«
```

**æ¡ˆä¾‹3ï¼šè¡¨è¾¾å¼ç´¢å¼•**:

```sql
-- æŸ¥è¯¢ï¼šæŒ‰é‚®ç®±åŸŸåæŸ¥è¯¢
SELECT * FROM users WHERE email LIKE '%@gmail.com';

-- ä¼˜åŒ–ï¼šåˆ›å»ºè¡¨è¾¾å¼ç´¢å¼•
CREATE INDEX idx_users_email_domain
ON users((substring(email FROM '@(.+)$')));

-- æˆ–è€…ä½¿ç”¨å…¨æ–‡æœç´¢
CREATE INDEX idx_users_email_gin
ON users USING GIN (email gin_trgm_ops);
```

---

## 5. é…ç½®ä¼˜åŒ–

### 5.1. PostgreSQLé…ç½®ä¼˜åŒ–

**å…³é”®é…ç½®å‚æ•°**ï¼š

```sql
-- æŸ¥çœ‹å½“å‰é…ç½®
SHOW shared_buffers;
SHOW effective_cache_size;
SHOW work_mem;
SHOW maintenance_work_mem;
SHOW max_connections;

-- æ¨èé…ç½®ï¼ˆ8GBå†…å­˜æœåŠ¡å™¨ï¼‰
-- postgresql.conf
shared_buffers = 2GB                    -- 25% of RAM
effective_cache_size = 6GB              -- 75% of RAM
work_mem = 16MB                         -- (RAM - shared_buffers) / (max_connections * 2)
maintenance_work_mem = 512MB            -- ç”¨äºVACUUMç­‰æ“ä½œ
max_connections = 100                   -- æ ¹æ®å®é™…éœ€æ±‚
random_page_cost = 1.1                  -- SSDç¯å¢ƒ
effective_io_concurrency = 200         -- SSDç¯å¢ƒ
```

### 5.2. è‡ªåŠ¨VACUUMä¼˜åŒ–

**VACUUMé…ç½®**ï¼š

```sql
-- æŸ¥çœ‹VACUUMç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    last_vacuum,
    last_autovacuum,
    vacuum_count,
    autovacuum_count,
    n_dead_tup,
    n_live_tup
FROM pg_stat_user_tables
ORDER BY n_dead_tup DESC;

-- æ‰‹åŠ¨æ‰§è¡ŒVACUUM
VACUUM ANALYZE orders;

-- è¡¨çº§VACUUMé…ç½®
ALTER TABLE orders SET (
    autovacuum_vacuum_scale_factor = 0.05,  -- 5% dead tuplesè§¦å‘
    autovacuum_analyze_scale_factor = 0.02  -- 2%å˜åŒ–è§¦å‘analyze
);
```

---

## 6. ç›‘æ§ä¸å‘Šè­¦

### 6.1. æ€§èƒ½ç›‘æ§è§†å›¾

**åˆ›å»ºç›‘æ§è§†å›¾**ï¼š

```sql
-- æ…¢æŸ¥è¯¢ç›‘æ§è§†å›¾
CREATE VIEW slow_queries AS
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time,
    (total_exec_time / calls) AS avg_time_per_call
FROM pg_stat_statements
WHERE mean_exec_time > 1000
ORDER BY mean_exec_time DESC;

-- è¡¨æ€§èƒ½ç›‘æ§è§†å›¾
CREATE VIEW table_performance AS
SELECT
    schemaname,
    tablename,
    seq_scan,
    seq_tup_read,
    idx_scan,
    idx_tup_fetch,
    n_tup_ins,
    n_tup_upd,
    n_tup_del,
    n_live_tup,
    n_dead_tup,
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables
ORDER BY seq_scan DESC;
```

### 6.2. å‘Šè­¦è§„åˆ™

**æ€§èƒ½å‘Šè­¦SQL**ï¼š

```sql
-- æ…¢æŸ¥è¯¢å‘Šè­¦
SELECT
    'SLOW_QUERY' AS alert_type,
    query,
    mean_exec_time,
    calls
FROM pg_stat_statements
WHERE mean_exec_time > 5000  -- 5ç§’
  AND calls > 10;

-- è¡¨è†¨èƒ€å‘Šè­¦
SELECT
    'TABLE_BLOAT' AS alert_type,
    schemaname,
    tablename,
    n_dead_tup,
    ROUND(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS dead_percentage
FROM pg_stat_user_tables
WHERE n_dead_tup > 10000
  AND ROUND(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) > 20;

-- é”ç­‰å¾…å‘Šè­¦
SELECT
    'LOCK_WAIT' AS alert_type,
    COUNT(*) AS waiting_queries
FROM pg_locks
WHERE NOT granted;
```

---

## 7. å‚è€ƒèµ„æ–™

- [æ•°æ®åˆ†æä¸ä½¿ç”¨æŒ‡å—](./07.04-æ•°æ®åˆ†æä¸ä½¿ç”¨æŒ‡å—.md)
- [æ•°æ®åº“è®¾è®¡åæ¨¡å¼](./07.06-æ•°æ®åº“è®¾è®¡åæ¨¡å¼ä¸è§£å†³æ–¹æ¡ˆ.md)
- [PostgreSQLæ€§èƒ½è°ƒä¼˜](https://www.postgresql.org/docs/current/performance-tips.html)

---

**æœ€åæ›´æ–°**ï¼š2025-01-15
**ç»´æŠ¤è€…**ï¼šData-Science Team
**çŠ¶æ€**ï¼šå®æ–½ä¸­
