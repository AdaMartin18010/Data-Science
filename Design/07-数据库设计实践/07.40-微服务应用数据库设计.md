# å¾®æœåŠ¡åº”ç”¨æ•°æ®åº“è®¾è®¡å®è·µ

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-01-15
> **ç‰ˆæœ¬**ï¼šv1.0
> **çŠ¶æ€**ï¼šè¿›è¡Œä¸­

---

## ğŸ“‹ ç›®å½•

- [å¾®æœåŠ¡åº”ç”¨æ•°æ®åº“è®¾è®¡å®è·µ](#å¾®æœåŠ¡åº”ç”¨æ•°æ®åº“è®¾è®¡å®è·µ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1. å¾®æœåŠ¡æ•°æ®åº“è®¾è®¡æŒ‘æˆ˜](#11-å¾®æœåŠ¡æ•°æ®åº“è®¾è®¡æŒ‘æˆ˜)
    - [1.2. å¾®æœåŠ¡æ•°æ®åº“è®¾è®¡åŸåˆ™](#12-å¾®æœåŠ¡æ•°æ®åº“è®¾è®¡åŸåˆ™)
  - [2. æ•°æ®åº“peræœåŠ¡æ¨¡å¼](#2-æ•°æ®åº“peræœåŠ¡æ¨¡å¼)
    - [2.1. æ¨¡å¼å®šä¹‰](#21-æ¨¡å¼å®šä¹‰)
    - [2.2. Schemaè®¾è®¡](#22-schemaè®¾è®¡)
      - [2.2.1. ç”¨æˆ·æœåŠ¡æ•°æ®åº“Schema](#221-ç”¨æˆ·æœåŠ¡æ•°æ®åº“schema)
      - [2.2.2. è®¢å•æœåŠ¡æ•°æ®åº“Schema](#222-è®¢å•æœåŠ¡æ•°æ®åº“schema)
      - [2.2.3. å•†å“æœåŠ¡æ•°æ®åº“Schema](#223-å•†å“æœåŠ¡æ•°æ®åº“schema)
    - [2.3. æ•°æ®æ‰€æœ‰æƒ](#23-æ•°æ®æ‰€æœ‰æƒ)
  - [3. åˆ†å¸ƒå¼äº‹åŠ¡è®¾è®¡](#3-åˆ†å¸ƒå¼äº‹åŠ¡è®¾è®¡)
    - [3.1. Sagaæ¨¡å¼è®¾è®¡](#31-sagaæ¨¡å¼è®¾è®¡)
      - [3.1.1. Sagaæ¨¡å¼å®šä¹‰](#311-sagaæ¨¡å¼å®šä¹‰)
      - [3.1.2. Sagaæ¨¡å¼Schemaè®¾è®¡](#312-sagaæ¨¡å¼schemaè®¾è®¡)
      - [3.1.3. Sagaæ‰§è¡Œå‡½æ•°](#313-sagaæ‰§è¡Œå‡½æ•°)
    - [3.2. ä¸¤é˜¶æ®µæäº¤è®¾è®¡](#32-ä¸¤é˜¶æ®µæäº¤è®¾è®¡)
      - [3.2.1. ä¸¤é˜¶æ®µæäº¤å®šä¹‰](#321-ä¸¤é˜¶æ®µæäº¤å®šä¹‰)
    - [3.3. æœ€ç»ˆä¸€è‡´æ€§è®¾è®¡](#33-æœ€ç»ˆä¸€è‡´æ€§è®¾è®¡)
      - [3.3.1. æœ€ç»ˆä¸€è‡´æ€§å®šä¹‰](#331-æœ€ç»ˆä¸€è‡´æ€§å®šä¹‰)
  - [4. æœåŠ¡é—´æ•°æ®åŒæ­¥](#4-æœåŠ¡é—´æ•°æ®åŒæ­¥)
    - [4.1. äº‹ä»¶é©±åŠ¨åŒæ­¥](#41-äº‹ä»¶é©±åŠ¨åŒæ­¥)
      - [4.1.1. äº‹ä»¶é©±åŠ¨æ¶æ„](#411-äº‹ä»¶é©±åŠ¨æ¶æ„)
    - [4.2. CDCå˜æ›´æ•è·](#42-cdcå˜æ›´æ•è·)
      - [4.2.1. CDCå˜æ›´æ•è·](#421-cdcå˜æ›´æ•è·)
    - [4.3. æ•°æ®å¤åˆ¶ç­–ç•¥](#43-æ•°æ®å¤åˆ¶ç­–ç•¥)
      - [4.3.1. æ•°æ®å¤åˆ¶ç­–ç•¥](#431-æ•°æ®å¤åˆ¶ç­–ç•¥)
  - [5. PostgreSQLå¾®æœåŠ¡åº”ç”¨å®è·µ](#5-postgresqlå¾®æœåŠ¡åº”ç”¨å®è·µ)
    - [5.1. æ•°æ®åº“peræœåŠ¡å®ç°](#51-æ•°æ®åº“peræœåŠ¡å®ç°)
      - [5.1.1. æœåŠ¡æ•°æ®åº“åˆ›å»º](#511-æœåŠ¡æ•°æ®åº“åˆ›å»º)
    - [5.2. åˆ†å¸ƒå¼äº‹åŠ¡å®ç°](#52-åˆ†å¸ƒå¼äº‹åŠ¡å®ç°)
      - [5.2.1. Sagaæ¨¡å¼å®ç°](#521-sagaæ¨¡å¼å®ç°)
    - [5.3. Citusé›†ç¾¤å®ç°](#53-citusé›†ç¾¤å®ç°)
      - [5.3.1. Citusé›†ç¾¤é…ç½®](#531-citusé›†ç¾¤é…ç½®)
      - [5.3.2. åˆ†å¸ƒå¼è¡¨åˆ›å»º](#532-åˆ†å¸ƒå¼è¡¨åˆ›å»º)
  - [6. å®é™…åº”ç”¨æ¡ˆä¾‹](#6-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [6.1. ç”µå•†å¾®æœåŠ¡ç³»ç»Ÿ](#61-ç”µå•†å¾®æœåŠ¡ç³»ç»Ÿ)
      - [6.1.1. ç³»ç»Ÿæ¶æ„](#611-ç³»ç»Ÿæ¶æ„)
      - [6.1.2. æ•°æ®åº“è®¾è®¡](#612-æ•°æ®åº“è®¾è®¡)
    - [6.2. ç¤¾äº¤å¾®æœåŠ¡ç³»ç»Ÿ](#62-ç¤¾äº¤å¾®æœåŠ¡ç³»ç»Ÿ)
      - [6.2.1. ç³»ç»Ÿæ¶æ„](#621-ç³»ç»Ÿæ¶æ„)
  - [7. å‚è€ƒèµ„æ–™](#7-å‚è€ƒèµ„æ–™)
    - [7.1. ç»å…¸æ–‡çŒ®](#71-ç»å…¸æ–‡çŒ®)
    - [7.2. ç›¸å…³èµ„æº](#72-ç›¸å…³èµ„æº)

---

## 1. æ¦‚è¿°

### 1.1. å¾®æœåŠ¡æ•°æ®åº“è®¾è®¡æŒ‘æˆ˜

å¾®æœåŠ¡æ•°æ®åº“è®¾è®¡é¢ä¸´ä»¥ä¸‹æŒ‘æˆ˜ï¼š

1. **æœåŠ¡è§£è€¦**ï¼šå¦‚ä½•å®ç°æœåŠ¡é—´çš„æ•°æ®è§£è€¦
2. **æ•°æ®ä¸€è‡´æ€§**ï¼šå¦‚ä½•ä¿è¯è·¨æœåŠ¡çš„æ•°æ®ä¸€è‡´æ€§
3. **åˆ†å¸ƒå¼äº‹åŠ¡**ï¼šå¦‚ä½•ç®¡ç†è·¨æœåŠ¡çš„äº‹åŠ¡
4. **æ•°æ®åŒæ­¥**ï¼šå¦‚ä½•åŒæ­¥æœåŠ¡é—´çš„æ•°æ®

### 1.2. å¾®æœåŠ¡æ•°æ®åº“è®¾è®¡åŸåˆ™

å¾®æœåŠ¡æ•°æ®åº“è®¾è®¡éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

1. **æ•°æ®åº“peræœåŠ¡**ï¼šæ¯ä¸ªæœåŠ¡ä½¿ç”¨ç‹¬ç«‹æ•°æ®åº“
2. **æœåŠ¡ç‹¬ç«‹æ€§**ï¼šæœåŠ¡å¯ä»¥ç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²
3. **æ•°æ®æ‰€æœ‰æƒ**ï¼šæ¯ä¸ªæœåŠ¡æ‹¥æœ‰è‡ªå·±çš„æ•°æ®
4. **APIé€šä¿¡**ï¼šæœåŠ¡é—´é€šè¿‡APIé€šä¿¡ï¼Œä¸ç›´æ¥è®¿é—®æ•°æ®åº“

---

## 2. æ•°æ®åº“peræœåŠ¡æ¨¡å¼

### 2.1. æ¨¡å¼å®šä¹‰

**æ¨¡å¼å®šä¹‰**ï¼š

æ¯ä¸ªå¾®æœåŠ¡æ‹¥æœ‰ç‹¬ç«‹çš„æ•°æ®åº“ï¼ŒæœåŠ¡é—´é€šè¿‡APIé€šä¿¡ï¼Œä¸ç›´æ¥è®¿é—®å…¶ä»–æœåŠ¡çš„æ•°æ®åº“ã€‚

**å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[å¾®æœåŠ¡æ•°æ®åº“è®¾è®¡] --> B{æœåŠ¡è¾¹ç•Œ}
    B -->|æ¸…æ™°è¾¹ç•Œ| C[ç‹¬ç«‹æ•°æ®åº“ âœ…]
    B -->|å…±äº«æ•°æ®| D{æ•°æ®ç‰¹æ€§}

    C --> E[é€‰æ‹©æ•°æ®åº“ç±»å‹]
    D -->|åªè¯»å…±äº«| F[åªè¯»å‰¯æœ¬]
    D -->|è¯»å†™å…±äº«| G[å…±äº«æœåŠ¡]

    E --> H{æ•°æ®æ¨¡å‹}
    H -->|å…³ç³»å‹| I[PostgreSQL âœ…]
    H -->|æ–‡æ¡£å‹| J[MongoDB]
    H -->|å›¾å‹| K[Neo4j]
    H -->|æ—¶åº| L[TimescaleDB]

    F --> M[æ•°æ®åŒæ­¥]
    G --> N[APIç½‘å…³]
    I --> O[æ•°æ®åº“peræœåŠ¡å®ç° âœ…]
    J --> O
    K --> O
    L --> O
```

### 2.2. Schemaè®¾è®¡

#### 2.2.1. ç”¨æˆ·æœåŠ¡æ•°æ®åº“Schema

```sql
-- ============================================
-- ç”¨æˆ·æœåŠ¡æ•°æ®åº“
-- ============================================

CREATE DATABASE user_service_db;

\c user_service_db;

CREATE SCHEMA user_service;

-- ç”¨æˆ·è¡¨
CREATE TABLE user_service.users (
    user_id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    password_hash TEXT NOT NULL,
    profile_data JSONB,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_email ON user_service.users(email);
CREATE INDEX idx_users_username ON user_service.users(username);

-- ç”¨æˆ·è§’è‰²è¡¨
CREATE TABLE user_service.user_roles (
    role_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES user_service.users(user_id) ON DELETE CASCADE,
    role_name VARCHAR(50) NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, role_name)
);

CREATE INDEX idx_user_roles_user_id ON user_service.user_roles(user_id);
```

#### 2.2.2. è®¢å•æœåŠ¡æ•°æ®åº“Schema

```sql
-- ============================================
-- è®¢å•æœåŠ¡æ•°æ®åº“
-- ============================================

CREATE DATABASE order_service_db;

\c order_service_db;

CREATE SCHEMA order_service;

-- è®¢å•è¡¨
CREATE TABLE order_service.orders (
    order_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,  -- å¼•ç”¨ç”¨æˆ·æœåŠ¡ï¼Œä½†ä¸ä½¿ç”¨å¤–é”®
    order_number VARCHAR(50) NOT NULL UNIQUE,
    order_status VARCHAR(20) NOT NULL CHECK (order_status IN ('pending', 'paid', 'shipped', 'delivered', 'cancelled')),
    total_amount DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_orders_user_id ON order_service.orders(user_id);
CREATE INDEX idx_orders_status ON order_service.orders(order_status);
CREATE INDEX idx_orders_created_at ON order_service.orders(created_at DESC);

-- è®¢å•é¡¹è¡¨
CREATE TABLE order_service.order_items (
    item_id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL REFERENCES order_service.orders(order_id) ON DELETE CASCADE,
    product_id BIGINT NOT NULL,  -- å¼•ç”¨å•†å“æœåŠ¡ï¼Œä½†ä¸ä½¿ç”¨å¤–é”®
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    unit_price DECIMAL(10,2) NOT NULL,
    total_price DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_order_items_order_id ON order_service.order_items(order_id);
CREATE INDEX idx_order_items_product_id ON order_service.order_items(product_id);
```

#### 2.2.3. å•†å“æœåŠ¡æ•°æ®åº“Schema

```sql
-- ============================================
-- å•†å“æœåŠ¡æ•°æ®åº“
-- ============================================

CREATE DATABASE product_service_db;

\c product_service_db;

CREATE SCHEMA product_service;

-- å•†å“è¡¨
CREATE TABLE product_service.products (
    product_id BIGSERIAL PRIMARY KEY,
    product_name VARCHAR(200) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL CHECK (price >= 0),
    stock_quantity INTEGER NOT NULL DEFAULT 0 CHECK (stock_quantity >= 0),
    category_id BIGINT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_products_category_id ON product_service.products(category_id);
CREATE INDEX idx_products_name ON product_service.products(product_name);

-- å•†å“åˆ†ç±»è¡¨
CREATE TABLE product_service.categories (
    category_id BIGSERIAL PRIMARY KEY,
    category_name VARCHAR(100) NOT NULL UNIQUE,
    parent_category_id BIGINT REFERENCES product_service.categories(category_id),
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_categories_parent ON product_service.categories(parent_category_id);
```

### 2.3. æ•°æ®æ‰€æœ‰æƒ

**æ•°æ®æ‰€æœ‰æƒåŸåˆ™**ï¼š

1. **ç”¨æˆ·æ•°æ®**ï¼šç”¨æˆ·æœåŠ¡æ‹¥æœ‰ç”¨æˆ·æ•°æ®çš„æ‰€æœ‰æƒ
2. **è®¢å•æ•°æ®**ï¼šè®¢å•æœåŠ¡æ‹¥æœ‰è®¢å•æ•°æ®çš„æ‰€æœ‰æƒ
3. **å•†å“æ•°æ®**ï¼šå•†å“æœåŠ¡æ‹¥æœ‰å•†å“æ•°æ®çš„æ‰€æœ‰æƒ

**æ•°æ®è®¿é—®è§„åˆ™**ï¼š

```text
æ•°æ®è®¿é—®è§„åˆ™ âŸº
  âˆ€Serviceáµ¢, Serviceâ±¼ âˆˆ Services, i â‰  j.
    Serviceáµ¢ä¸ç›´æ¥è®¿é—®Database(Serviceâ±¼) âˆ§
    Serviceáµ¢é€šè¿‡APIè®¿é—®Serviceâ±¼
```

---

## 3. åˆ†å¸ƒå¼äº‹åŠ¡è®¾è®¡

### 3.1. Sagaæ¨¡å¼è®¾è®¡

#### 3.1.1. Sagaæ¨¡å¼å®šä¹‰

**Sagaæ¨¡å¼**ï¼š

å°†é•¿äº‹åŠ¡åˆ†è§£ä¸ºå¤šä¸ªæœ¬åœ°äº‹åŠ¡ï¼Œæ¯ä¸ªæœ¬åœ°äº‹åŠ¡æœ‰å¯¹åº”çš„è¡¥å¿æ“ä½œã€‚å¦‚æœæŸä¸ªæ­¥éª¤å¤±è´¥ï¼Œæ‰§è¡Œå·²å®Œæˆçš„æ­¥éª¤çš„è¡¥å¿æ“ä½œã€‚

**Sagaæ¨¡å¼å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[åˆ†å¸ƒå¼äº‹åŠ¡è®¾è®¡] --> B{ä¸€è‡´æ€§è¦æ±‚}
    B -->|å¼ºä¸€è‡´æ€§| C[ä¸¤é˜¶æ®µæäº¤]
    B -->|æœ€ç»ˆä¸€è‡´æ€§| D[Sagaæ¨¡å¼ âœ…]

    D --> E{Sagaç±»å‹}
    E -->|ç¼–æ’| F[Sagaç¼–æ’å™¨]
    E -->|ç¼–æ’| G[Sagaç¼–æ’å™¨]

    F --> H[é›†ä¸­å¼åè°ƒ]
    G --> I[åˆ†å¸ƒå¼åè°ƒ]

    H --> J[Sagaå®ç° âœ…]
    I --> J
    C --> K[2PCå®ç°]

    J --> L[éªŒè¯éœ€æ±‚]
    K --> L
```

#### 3.1.2. Sagaæ¨¡å¼Schemaè®¾è®¡

```sql
-- ============================================
-- Sagaæ¨¡å¼Schemaè®¾è®¡
-- ============================================

CREATE SCHEMA saga_pattern;

-- Sagaå®ä¾‹è¡¨
CREATE TABLE saga_pattern.saga_instances (
    saga_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    saga_type VARCHAR(100) NOT NULL,
    status VARCHAR(20) NOT NULL CHECK (status IN ('pending', 'executing', 'completed', 'compensating', 'failed')),
    current_step INTEGER DEFAULT 0,
    total_steps INTEGER NOT NULL,
    payload JSONB NOT NULL,
    result JSONB,
    error_message TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_saga_instances_status ON saga_pattern.saga_instances(status, created_at DESC);
CREATE INDEX idx_saga_instances_type ON saga_pattern.saga_instances(saga_type, status);

-- Sagaæ­¥éª¤è¡¨
CREATE TABLE saga_pattern.saga_steps (
    step_id BIGSERIAL PRIMARY KEY,
    saga_id UUID NOT NULL REFERENCES saga_pattern.saga_instances(saga_id) ON DELETE CASCADE,
    step_order INTEGER NOT NULL,
    step_name VARCHAR(100) NOT NULL,
    service_name VARCHAR(100) NOT NULL,
    action_type VARCHAR(20) NOT NULL CHECK (action_type IN ('action', 'compensation')),
    status VARCHAR(20) NOT NULL CHECK (status IN ('pending', 'executing', 'completed', 'failed', 'compensated')),
    request_payload JSONB,
    response_payload JSONB,
    error_message TEXT,
    executed_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    UNIQUE(saga_id, step_order, action_type)
);

CREATE INDEX idx_saga_steps_saga ON saga_pattern.saga_steps(saga_id, step_order);
CREATE INDEX idx_saga_steps_status ON saga_pattern.saga_steps(status, executed_at);
```

#### 3.1.3. Sagaæ‰§è¡Œå‡½æ•°

```sql
-- Sagaæ‰§è¡Œå‡½æ•°
CREATE OR REPLACE FUNCTION saga_pattern.execute_saga_step(
    p_saga_id UUID,
    p_step_order INTEGER,
    p_service_name VARCHAR,
    p_action_payload JSONB
)
RETURNS JSONB AS $$
DECLARE
    v_step_id BIGINT;
    v_result JSONB;
BEGIN
    -- è®°å½•æ­¥éª¤å¼€å§‹
    INSERT INTO saga_pattern.saga_steps (
        saga_id, step_order, step_name, service_name,
        action_type, status, request_payload, executed_at
    )
    VALUES (
        p_saga_id, p_step_order, 'step_' || p_step_order, p_service_name,
        'action', 'executing', p_action_payload, CURRENT_TIMESTAMP
    )
    RETURNING step_id INTO v_step_id;

    -- è¿™é‡Œåº”è¯¥è°ƒç”¨å®é™…çš„æœåŠ¡API
    -- ç®€åŒ–ç¤ºä¾‹ï¼šå‡è®¾è°ƒç”¨æˆåŠŸ
    v_result := '{"success": true}'::JSONB;

    -- æ›´æ–°æ­¥éª¤çŠ¶æ€
    UPDATE saga_pattern.saga_steps
    SET status = 'completed',
        response_payload = v_result,
        completed_at = CURRENT_TIMESTAMP
    WHERE step_id = v_step_id;

    -- æ›´æ–°SagaçŠ¶æ€
    UPDATE saga_pattern.saga_instances
    SET current_step = p_step_order,
        status = CASE
            WHEN p_step_order >= total_steps THEN 'completed'
            ELSE 'executing'
        END,
        updated_at = CURRENT_TIMESTAMP
    WHERE saga_id = p_saga_id;

    RETURN v_result;
EXCEPTION
    WHEN OTHERS THEN
        -- æ­¥éª¤å¤±è´¥ï¼Œæ ‡è®°ä¸ºå¤±è´¥
        UPDATE saga_pattern.saga_steps
        SET status = 'failed',
            error_message = SQLERRM,
            completed_at = CURRENT_TIMESTAMP
        WHERE step_id = v_step_id;

        -- è§¦å‘è¡¥å¿
        PERFORM saga_pattern.compensate_saga(p_saga_id);

        RAISE;
END;
$$ LANGUAGE plpgsql;

-- Sagaè¡¥å¿å‡½æ•°
CREATE OR REPLACE FUNCTION saga_pattern.compensate_saga(p_saga_id UUID)
RETURNS VOID AS $$
DECLARE
    v_step RECORD;
BEGIN
    -- æ›´æ–°SagaçŠ¶æ€ä¸ºè¡¥å¿ä¸­
    UPDATE saga_pattern.saga_instances
    SET status = 'compensating'
    WHERE saga_id = p_saga_id;

    -- é€†åºæ‰§è¡Œè¡¥å¿æ“ä½œ
    FOR v_step IN
        SELECT * FROM saga_pattern.saga_steps
        WHERE saga_id = p_saga_id
          AND action_type = 'action'
          AND status = 'completed'
        ORDER BY step_order DESC
    LOOP
        -- æ‰§è¡Œè¡¥å¿æ“ä½œ
        UPDATE saga_pattern.saga_steps
        SET status = 'compensated',
            completed_at = CURRENT_TIMESTAMP
        WHERE step_id = v_step.step_id;
    END LOOP;

    -- æ›´æ–°SagaçŠ¶æ€ä¸ºå¤±è´¥
    UPDATE saga_pattern.saga_instances
    SET status = 'failed',
        updated_at = CURRENT_TIMESTAMP
    WHERE saga_id = p_saga_id;
END;
$$ LANGUAGE plpgsql;
```

### 3.2. ä¸¤é˜¶æ®µæäº¤è®¾è®¡

#### 3.2.1. ä¸¤é˜¶æ®µæäº¤å®šä¹‰

**ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰**ï¼š

ä¸¤é˜¶æ®µæäº¤æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡çš„å¦ä¸€ç§æ¨¡å¼ï¼ŒåŒ…æ‹¬å‡†å¤‡é˜¶æ®µå’Œæäº¤é˜¶æ®µã€‚

**ä¸¤é˜¶æ®µæäº¤Schemaè®¾è®¡**ï¼š

```sql
-- ä¸¤é˜¶æ®µæäº¤äº‹åŠ¡è¡¨
CREATE TABLE distributed_transactions (
    transaction_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    status VARCHAR(20) NOT NULL CHECK (status IN ('preparing', 'prepared', 'committed', 'aborted')),
    participants JSONB NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_distributed_transactions_status ON distributed_transactions(status, created_at DESC);
```

### 3.3. æœ€ç»ˆä¸€è‡´æ€§è®¾è®¡

#### 3.3.1. æœ€ç»ˆä¸€è‡´æ€§å®šä¹‰

**æœ€ç»ˆä¸€è‡´æ€§**ï¼š

ç³»ç»Ÿæœ€ç»ˆè¾¾åˆ°ä¸€è‡´çŠ¶æ€ï¼Œä¸è¦æ±‚ç«‹å³ä¸€è‡´ã€‚

**æœ€ç»ˆä¸€è‡´æ€§å®ç°**ï¼š

```sql
-- äº‹ä»¶è¡¨
CREATE TABLE events (
    event_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    event_type VARCHAR(100) NOT NULL,
    aggregate_id VARCHAR(100) NOT NULL,
    payload JSONB NOT NULL,
    status VARCHAR(20) NOT NULL CHECK (status IN ('pending', 'processed', 'failed')),
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    processed_at TIMESTAMPTZ
);

CREATE INDEX idx_events_status ON events(status, created_at DESC);
CREATE INDEX idx_events_aggregate ON events(aggregate_id, created_at DESC);
```

---

## 4. æœåŠ¡é—´æ•°æ®åŒæ­¥

### 4.1. äº‹ä»¶é©±åŠ¨åŒæ­¥

#### 4.1.1. äº‹ä»¶é©±åŠ¨æ¶æ„

**äº‹ä»¶é©±åŠ¨æ¶æ„**ï¼š

æœåŠ¡é—´é€šè¿‡äº‹ä»¶è¿›è¡Œæ•°æ®åŒæ­¥ã€‚

**äº‹ä»¶è¡¨è®¾è®¡**ï¼š

```sql
-- äº‹ä»¶è¡¨
CREATE TABLE events (
    event_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    event_type VARCHAR(100) NOT NULL,
    aggregate_id VARCHAR(100) NOT NULL,
    payload JSONB NOT NULL,
    status VARCHAR(20) NOT NULL CHECK (status IN ('pending', 'published', 'processed', 'failed')),
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    published_at TIMESTAMPTZ,
    processed_at TIMESTAMPTZ
);

CREATE INDEX idx_events_status ON events(status, created_at DESC);
CREATE INDEX idx_events_aggregate ON events(aggregate_id, created_at DESC);
CREATE INDEX idx_events_type ON events(event_type, created_at DESC);
```

### 4.2. CDCå˜æ›´æ•è·

#### 4.2.1. CDCå˜æ›´æ•è·

**CDCå˜æ›´æ•è·**ï¼š

ä½¿ç”¨PostgreSQLçš„é€»è¾‘å¤åˆ¶æ•è·æ•°æ®å˜æ›´ã€‚

**CDCé…ç½®**ï¼š

```sql
-- å¯ç”¨é€»è¾‘å¤åˆ¶
ALTER SYSTEM SET wal_level = logical;

-- åˆ›å»ºå‘å¸ƒ
CREATE PUBLICATION user_service_publication FOR TABLE user_service.users;

-- åˆ›å»ºè®¢é˜…
CREATE SUBSCRIPTION order_service_subscription
CONNECTION 'host=order_service_db port=5432 dbname=order_service_db'
PUBLICATION user_service_publication;
```

### 4.3. æ•°æ®å¤åˆ¶ç­–ç•¥

#### 4.3.1. æ•°æ®å¤åˆ¶ç­–ç•¥

**æ•°æ®å¤åˆ¶ç­–ç•¥**ï¼š

1. **å®æ—¶å¤åˆ¶**ï¼šä½¿ç”¨CDCå®æ—¶å¤åˆ¶æ•°æ®
2. **æ‰¹é‡å¤åˆ¶**ï¼šå®šæœŸæ‰¹é‡å¤åˆ¶æ•°æ®
3. **æŒ‰éœ€å¤åˆ¶**ï¼šæŒ‰éœ€å¤åˆ¶æ•°æ®

---

## 5. PostgreSQLå¾®æœåŠ¡åº”ç”¨å®è·µ

### 5.1. æ•°æ®åº“peræœåŠ¡å®ç°

#### 5.1.1. æœåŠ¡æ•°æ®åº“åˆ›å»º

```sql
-- åˆ›å»ºç”¨æˆ·æœåŠ¡æ•°æ®åº“
CREATE DATABASE user_service_db;

-- åˆ›å»ºè®¢å•æœåŠ¡æ•°æ®åº“
CREATE DATABASE order_service_db;

-- åˆ›å»ºå•†å“æœåŠ¡æ•°æ®åº“
CREATE DATABASE product_service_db;
```

### 5.2. åˆ†å¸ƒå¼äº‹åŠ¡å®ç°

#### 5.2.1. Sagaæ¨¡å¼å®ç°

å‚è€ƒç¬¬3.1èŠ‚çš„Sagaæ¨¡å¼è®¾è®¡ã€‚

### 5.3. Citusé›†ç¾¤å®ç°

#### 5.3.1. Citusé›†ç¾¤é…ç½®

```sql
-- å®‰è£…Citusæ‰©å±•
CREATE EXTENSION citus;

-- æ·»åŠ å·¥ä½œèŠ‚ç‚¹
SELECT citus_add_node('worker1_host', 5432);
SELECT citus_add_node('worker2_host', 5432);
SELECT citus_add_node('worker3_host', 5432);

-- æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯
SELECT * FROM citus_get_active_worker_nodes();
```

#### 5.3.2. åˆ†å¸ƒå¼è¡¨åˆ›å»º

```sql
-- åˆ›å»ºåˆ†å¸ƒå¼è¡¨
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    name TEXT,
    email TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æŒ‰idåˆ†ç‰‡
SELECT create_distributed_table('users', 'id');

-- åˆ›å»ºå‚è€ƒè¡¨ï¼ˆå¤åˆ¶åˆ°æ‰€æœ‰èŠ‚ç‚¹ï¼‰
CREATE TABLE countries (
    id SERIAL PRIMARY KEY,
    name TEXT,
    code TEXT
);

SELECT create_reference_table('countries');
```

---

## 6. å®é™…åº”ç”¨æ¡ˆä¾‹

### 6.1. ç”µå•†å¾®æœåŠ¡ç³»ç»Ÿ

#### 6.1.1. ç³»ç»Ÿæ¶æ„

**ç³»ç»Ÿæ¶æ„**ï¼š

```text
ç”¨æˆ·æœåŠ¡ â†’ PostgreSQLç”¨æˆ·æ•°æ®åº“
å•†å“æœåŠ¡ â†’ PostgreSQLå•†å“æ•°æ®åº“
è®¢å•æœåŠ¡ â†’ PostgreSQLè®¢å•æ•°æ®åº“
æ”¯ä»˜æœåŠ¡ â†’ PostgreSQLæ”¯ä»˜æ•°æ®åº“
```

#### 6.1.2. æ•°æ®åº“è®¾è®¡

å‚è€ƒç¬¬2.2èŠ‚çš„Schemaè®¾è®¡ã€‚

### 6.2. ç¤¾äº¤å¾®æœåŠ¡ç³»ç»Ÿ

#### 6.2.1. ç³»ç»Ÿæ¶æ„

**ç³»ç»Ÿæ¶æ„**ï¼š

```text
ç”¨æˆ·æœåŠ¡ â†’ PostgreSQLç”¨æˆ·æ•°æ®åº“
å†…å®¹æœåŠ¡ â†’ PostgreSQLå†…å®¹æ•°æ®åº“
å…³ç³»æœåŠ¡ â†’ PostgreSQLå…³ç³»æ•°æ®åº“
æ¶ˆæ¯æœåŠ¡ â†’ PostgreSQLæ¶ˆæ¯æ•°æ®åº“
```

---

## 7. å‚è€ƒèµ„æ–™

### 7.1. ç»å…¸æ–‡çŒ®

- "Microservices Patterns" (Richardson, 2018)
- "Building Microservices" (Newman, 2015)
- "Database per Service Pattern" (Martin Fowler)

### 7.2. ç›¸å…³èµ„æº

- [å¾®æœåŠ¡æ¶æ„æ¨¡å¼](https://microservices.io/patterns/)
- [æ•°æ®åº“peræœåŠ¡](https://microservices.io/patterns/data/database-per-service.html)
- [åˆ†å¸ƒå¼äº‹åŠ¡](https://microservices.io/patterns/data/distributed-transactions.html)
- [PostgreSQL Citusæ–‡æ¡£](https://docs.citusdata.com/)

---

**æœ€åæ›´æ–°**ï¼š2025-01-15
**ç»´æŠ¤è€…**ï¼šData-Science Team
**çŠ¶æ€**ï¼šè¿›è¡Œä¸­
