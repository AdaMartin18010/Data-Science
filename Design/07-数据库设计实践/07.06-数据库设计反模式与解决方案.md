# æ•°æ®åº“è®¾è®¡åæ¨¡å¼ä¸è§£å†³æ–¹æ¡ˆï¼šå¸¸è§é™·é˜±ä¸æœ€ä½³å®è·µ

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-12-01
> **ç‰ˆæœ¬**ï¼šv2.0 (å¢å¼ºç‰ˆ)
> **çŠ¶æ€**ï¼šå®æ–½ä¸­

---

## ğŸ“‹ ç›®å½•

- [æ•°æ®åº“è®¾è®¡åæ¨¡å¼ä¸è§£å†³æ–¹æ¡ˆï¼šå¸¸è§é™·é˜±ä¸æœ€ä½³å®è·µ](#æ•°æ®åº“è®¾è®¡åæ¨¡å¼ä¸è§£å†³æ–¹æ¡ˆå¸¸è§é™·é˜±ä¸æœ€ä½³å®è·µ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1. åæ¨¡å¼åˆ†ç±»](#11-åæ¨¡å¼åˆ†ç±»)
  - [2. Schemaè®¾è®¡åæ¨¡å¼](#2-schemaè®¾è®¡åæ¨¡å¼)
    - [2.1. å¤šç”¨é€”è¡¨ï¼ˆGod Tableï¼‰](#21-å¤šç”¨é€”è¡¨god-table)
    - [2.2. å•è¡¨ç»§æ‰¿ï¼ˆSingle Table Inheritanceï¼‰](#22-å•è¡¨ç»§æ‰¿single-table-inheritance)
    - [2.3. ä¼ªé”®æ»¥ç”¨ï¼ˆPseudokey Neat-Freakï¼‰](#23-ä¼ªé”®æ»¥ç”¨pseudokey-neat-freak)
    - [2.4. åˆ—æ•°è¿‡å¤šï¼ˆWide Tableï¼‰](#24-åˆ—æ•°è¿‡å¤šwide-table)
  - [3. æŸ¥è¯¢è®¾è®¡åæ¨¡å¼](#3-æŸ¥è¯¢è®¾è®¡åæ¨¡å¼)
    - [3.1. N+1æŸ¥è¯¢é—®é¢˜](#31-n1æŸ¥è¯¢é—®é¢˜)
    - [3.2. å…¨è¡¨æ‰«æ](#32-å…¨è¡¨æ‰«æ)
    - [3.3. éšå¼ç±»å‹è½¬æ¢](#33-éšå¼ç±»å‹è½¬æ¢)
  - [4. æ€§èƒ½ä¼˜åŒ–åæ¨¡å¼](#4-æ€§èƒ½ä¼˜åŒ–åæ¨¡å¼)
    - [4.1. ç´¢å¼•æ»¥ç”¨](#41-ç´¢å¼•æ»¥ç”¨)
    - [4.2. è¿‡åº¦è§„èŒƒåŒ–](#42-è¿‡åº¦è§„èŒƒåŒ–)
  - [5. æ•°æ®ä¸€è‡´æ€§åæ¨¡å¼](#5-æ•°æ®ä¸€è‡´æ€§åæ¨¡å¼)
    - [5.1. ç¼ºå°‘å¤–é”®çº¦æŸ](#51-ç¼ºå°‘å¤–é”®çº¦æŸ)
    - [5.2. è§¦å‘å™¨æ»¥ç”¨](#52-è§¦å‘å™¨æ»¥ç”¨)
  - [6. åæ¨¡å¼è¯†åˆ«æ–¹æ³•](#6-åæ¨¡å¼è¯†åˆ«æ–¹æ³•)
    - [6.1. åæ¨¡å¼æ£€æµ‹å·¥å…·](#61-åæ¨¡å¼æ£€æµ‹å·¥å…·)
    - [6.2. åæ¨¡å¼æ£€æŸ¥æ¸…å•](#62-åæ¨¡å¼æ£€æŸ¥æ¸…å•)
    - [6.3. åæ¨¡å¼è¯†åˆ«å†³ç­–æ ‘](#63-åæ¨¡å¼è¯†åˆ«å†³ç­–æ ‘)
  - [7. åæ¨¡å¼ä¿®å¤ç­–ç•¥](#7-åæ¨¡å¼ä¿®å¤ç­–ç•¥)
    - [7.1. ä¿®å¤ä¼˜å…ˆçº§](#71-ä¿®å¤ä¼˜å…ˆçº§)
    - [7.2. ä¿®å¤æ–¹æ³•](#72-ä¿®å¤æ–¹æ³•)
    - [7.3. ä¿®å¤å†³ç­–æ ‘](#73-ä¿®å¤å†³ç­–æ ‘)
  - [8. åæ¨¡å¼é¢„é˜²æªæ–½](#8-åæ¨¡å¼é¢„é˜²æªæ–½)
    - [8.1. è®¾è®¡è¯„å®¡](#81-è®¾è®¡è¯„å®¡)
    - [8.2. ä»£ç å®¡æŸ¥](#82-ä»£ç å®¡æŸ¥)
    - [8.3. è‡ªåŠ¨åŒ–æ£€æŸ¥](#83-è‡ªåŠ¨åŒ–æ£€æŸ¥)
  - [9. å®é™…æ¡ˆä¾‹æ·±åº¦åˆ†æ](#9-å®é™…æ¡ˆä¾‹æ·±åº¦åˆ†æ)
    - [9.1. æ¡ˆä¾‹1ï¼šç”µå•†ç³»ç»Ÿåæ¨¡å¼ä¿®å¤](#91-æ¡ˆä¾‹1ç”µå•†ç³»ç»Ÿåæ¨¡å¼ä¿®å¤)
    - [9.2. æ¡ˆä¾‹2ï¼šé‡‘èç³»ç»Ÿåæ¨¡å¼ä¿®å¤](#92-æ¡ˆä¾‹2é‡‘èç³»ç»Ÿåæ¨¡å¼ä¿®å¤)
    - [9.3. æ¡ˆä¾‹3ï¼šç¤¾äº¤ç½‘ç»œåæ¨¡å¼ä¿®å¤](#93-æ¡ˆä¾‹3ç¤¾äº¤ç½‘ç»œåæ¨¡å¼ä¿®å¤)
  - [10. åæ¨¡å¼å¯¹æ¯”çŸ©é˜µ](#10-åæ¨¡å¼å¯¹æ¯”çŸ©é˜µ)
    - [10.1. åæ¨¡å¼å½±å“å¯¹æ¯”](#101-åæ¨¡å¼å½±å“å¯¹æ¯”)
    - [10.2. ä¿®å¤æˆæœ¬å¯¹æ¯”](#102-ä¿®å¤æˆæœ¬å¯¹æ¯”)
  - [11. å½¢å¼åŒ–åæ¨¡å¼è¯†åˆ«](#11-å½¢å¼åŒ–åæ¨¡å¼è¯†åˆ«)
    - [11.1. åæ¨¡å¼å½¢å¼åŒ–å®šä¹‰](#111-åæ¨¡å¼å½¢å¼åŒ–å®šä¹‰)
    - [11.2. è‡ªåŠ¨åŒ–æ£€æµ‹ç®—æ³•](#112-è‡ªåŠ¨åŒ–æ£€æµ‹ç®—æ³•)
  - [12. å‚è€ƒèµ„æ–™](#12-å‚è€ƒèµ„æ–™)
    - [12.1. æƒå¨æ–‡çŒ®](#121-æƒå¨æ–‡çŒ®)
    - [12.2. åœ¨çº¿èµ„æº](#122-åœ¨çº¿èµ„æº)
    - [12.3. ç›¸å…³æ–‡æ¡£](#123-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

åæ¨¡å¼ï¼ˆAnti-patternï¼‰æ˜¯çœ‹ä¼¼åˆç†ä½†å®é™…æœ‰å®³çš„è®¾è®¡æ¨¡å¼ã€‚æœ¬æ–‡æ¡£è¯†åˆ«å¸¸è§çš„æ•°æ®åº“è®¾è®¡åæ¨¡å¼å¹¶æä¾›è§£å†³æ–¹æ¡ˆã€‚

### 1.1. åæ¨¡å¼åˆ†ç±»

```mermaid
mindmap
  root((æ•°æ®åº“åæ¨¡å¼))
    Schemaåæ¨¡å¼
      å¤šç”¨é€”è¡¨
      å•è¡¨ç»§æ‰¿
      ä¼ªé”®æ»¥ç”¨
      åˆ—æ•°è¿‡å¤š
    æŸ¥è¯¢åæ¨¡å¼
      N+1æŸ¥è¯¢
      å…¨è¡¨æ‰«æ
      éšå¼è½¬æ¢
      è¿‡åº¦ä½¿ç”¨å­æŸ¥è¯¢
    æ€§èƒ½åæ¨¡å¼
      ç´¢å¼•æ»¥ç”¨
      è¿‡åº¦è§„èŒƒåŒ–
      ç¼ºå°‘ç´¢å¼•
      æ•°æ®ç±»å‹ä¸å½“
    ä¸€è‡´æ€§åæ¨¡å¼
      ç¼ºå°‘å¤–é”®
      è§¦å‘å™¨æ»¥ç”¨
      å…¨å±€çŠ¶æ€è¡¨
```

---

## 2. Schemaè®¾è®¡åæ¨¡å¼

### 2.1. å¤šç”¨é€”è¡¨ï¼ˆGod Tableï¼‰

**åæ¨¡å¼**ï¼šå°†æ‰€æœ‰æ•°æ®å¡è¿›ä¸€ä¸ªå·¨å¤§çš„è¡¨ã€‚

**é—®é¢˜ç¤ºä¾‹**ï¼š

```sql
-- åæ¨¡å¼ï¼šä¸‡èƒ½è¡¨
CREATE TABLE everything (
    id INTEGER PRIMARY KEY,
    type VARCHAR(50),  -- 'user', 'order', 'product', ...
    data JSONB,  -- æ‰€æœ‰æ•°æ®éƒ½å¡è¿™é‡Œ
    created_at TIMESTAMP
);
```

**é—®é¢˜**ï¼š

- æ— æ³•å»ºç«‹æœ‰æ•ˆç´¢å¼•
- æŸ¥è¯¢æ€§èƒ½å·®
- æ•°æ®å®Œæ•´æ€§æ— æ³•ä¿è¯
- éš¾ä»¥ç»´æŠ¤

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æ­£ç¡®ï¼šæŒ‰å®ä½“åˆ†ç¦»
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100)
);

CREATE TABLE orders (
    id INTEGER PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    total DECIMAL(10,2)
);

CREATE TABLE products (
    id INTEGER PRIMARY KEY,
    name VARCHAR(200),
    price DECIMAL(10,2)
);
```

### 2.2. å•è¡¨ç»§æ‰¿ï¼ˆSingle Table Inheritanceï¼‰

**åæ¨¡å¼**ï¼šä½¿ç”¨ä¸€ä¸ªè¡¨å­˜å‚¨å¤šç§ç±»å‹çš„å®ä½“ï¼Œç”¨typeåˆ—åŒºåˆ†ã€‚

**é—®é¢˜ç¤ºä¾‹**ï¼š

```sql
-- åæ¨¡å¼ï¼šå•è¡¨ç»§æ‰¿
CREATE TABLE vehicles (
    id INTEGER PRIMARY KEY,
    type VARCHAR(20),  -- 'car', 'truck', 'motorcycle'
    wheels INTEGER,
    cargo_capacity INTEGER,  -- åªæœ‰truckéœ€è¦
    engine_cc INTEGER,  -- åªæœ‰motorcycleéœ€è¦
    doors INTEGER  -- åªæœ‰caréœ€è¦
);
```

**é—®é¢˜**ï¼š

- å¤§é‡NULLå€¼
- æ— æ³•ä½¿ç”¨CHECKçº¦æŸ
- æŸ¥è¯¢éœ€è¦è¿‡æ»¤type

**è§£å†³æ–¹æ¡ˆå†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[ç»§æ‰¿è®¾è®¡] --> B{ç±»å‹å·®å¼‚}

    B -->|å·®å¼‚å°| C[å•è¡¨+typeåˆ—]
    B -->|å·®å¼‚å¤§| D{æŸ¥è¯¢æ¨¡å¼}

    D -->|å¤šç±»å‹è”åˆæŸ¥è¯¢| E[å•è¡¨+typeåˆ—+éƒ¨åˆ†åˆ—]
    D -->|ç±»å‹ç‹¬ç«‹æŸ¥è¯¢| F[å¤šè¡¨ç»§æ‰¿]

    F --> G[åŸºè¡¨+å­è¡¨]
    G --> H[ä½¿ç”¨å¤–é”®å…³è”]
```

**æ­£ç¡®æ–¹æ¡ˆ**ï¼š

```sql
-- æ–¹æ¡ˆ1ï¼šå¤šè¡¨ç»§æ‰¿ï¼ˆç±»å‹å·®å¼‚å¤§ï¼‰
CREATE TABLE vehicles (
    id INTEGER PRIMARY KEY,
    type VARCHAR(20) NOT NULL,
    wheels INTEGER NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE cars (
    vehicle_id INTEGER PRIMARY KEY REFERENCES vehicles(id),
    doors INTEGER NOT NULL,
    CHECK ((SELECT type FROM vehicles WHERE id = vehicle_id) = 'car')
);

CREATE TABLE trucks (
    vehicle_id INTEGER PRIMARY KEY REFERENCES vehicles(id),
    cargo_capacity INTEGER NOT NULL,
    CHECK ((SELECT type FROM vehicles WHERE id = vehicle_id) = 'truck')
);

-- æ–¹æ¡ˆ2ï¼šå…±äº«è¡¨+æ‰©å±•è¡¨ï¼ˆPostgreSQLï¼‰
CREATE TABLE vehicles (
    id INTEGER PRIMARY KEY,
    type VARCHAR(20) NOT NULL,
    common_attributes JSONB NOT NULL
);

CREATE TABLE vehicle_extensions (
    vehicle_id INTEGER PRIMARY KEY REFERENCES vehicles(id),
    type_specific_data JSONB NOT NULL
);
```

### 2.3. ä¼ªé”®æ»¥ç”¨ï¼ˆPseudokey Neat-Freakï¼‰

**åæ¨¡å¼**ï¼šä¸ºæ‰€æœ‰è¡¨éƒ½æ·»åŠ è‡ªå¢IDï¼Œå³ä½¿æœ‰è‡ªç„¶é”®ã€‚

**é—®é¢˜ç¤ºä¾‹**ï¼š

```sql
-- åæ¨¡å¼ï¼šä¸å¿…è¦çš„ä»£ç†é”®
CREATE TABLE countries (
    id SERIAL PRIMARY KEY,  -- ä¸å¿…è¦çš„
    country_code CHAR(2) UNIQUE NOT NULL,  -- è‡ªç„¶é”®
    name VARCHAR(100) NOT NULL
);

CREATE TABLE country_languages (
    id SERIAL PRIMARY KEY,  -- ä¸å¿…è¦çš„
    country_id INTEGER REFERENCES countries(id),
    language_code CHAR(2),
    UNIQUE(country_id, language_code)  -- è¿™æ‰æ˜¯çœŸæ­£çš„é”®
);
```

**è§£å†³æ–¹æ¡ˆå†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[é€‰æ‹©ä¸»é”®] --> B{æœ‰ç¨³å®šè‡ªç„¶é”®?}

    B -->|æ˜¯| C{è‡ªç„¶é”®ç®€å•?}
    B -->|å¦| D[ä½¿ç”¨ä»£ç†é”®]

    C -->|æ˜¯| E[ä½¿ç”¨è‡ªç„¶é”®]
    C -->|å¦| F{å¤åˆé”®?}

    F -->|æ˜¯| G[è€ƒè™‘ä»£ç†é”®]
    F -->|å¦| H[ä½¿ç”¨è‡ªç„¶é”®]

    E --> I[ä¸»é”®é€‰æ‹©å®Œæˆ]
    G --> I
    H --> I
    D --> I
```

**æ­£ç¡®æ–¹æ¡ˆ**ï¼š

```sql
-- æ­£ç¡®ï¼šä½¿ç”¨è‡ªç„¶é”®
CREATE TABLE countries (
    country_code CHAR(2) PRIMARY KEY,  -- ISOä»£ç æ˜¯ç¨³å®šçš„è‡ªç„¶é”®
    name VARCHAR(100) NOT NULL
);

-- æ­£ç¡®ï¼šå…³è”è¡¨ä½¿ç”¨å¤åˆä¸»é”®
CREATE TABLE country_languages (
    country_code CHAR(2) REFERENCES countries(country_code),
    language_code CHAR(2),
    PRIMARY KEY (country_code, language_code)
);

-- éœ€è¦ä»£ç†é”®çš„åœºæ™¯ï¼šè®¢å•è¡¨
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,  -- è®¢å•å·å¯èƒ½å˜åŒ–ï¼Œä½¿ç”¨ä»£ç†é”®
    order_number VARCHAR(50) UNIQUE NOT NULL,
    user_id INTEGER NOT NULL
);
```

### 2.4. åˆ—æ•°è¿‡å¤šï¼ˆWide Tableï¼‰

**åæ¨¡å¼**ï¼šè¡¨æœ‰æ•°ç™¾åˆ—ï¼ŒåŒ…å«æ‰€æœ‰å¯èƒ½çš„å±æ€§ã€‚

**é—®é¢˜ç¤ºä¾‹**ï¼š

```sql
-- åæ¨¡å¼ï¼šåˆ—æ•°è¿‡å¤š
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100),
    -- ... 200+ åˆ—
    attribute_1 VARCHAR(100),
    attribute_2 VARCHAR(100),
    -- ...
    attribute_200 VARCHAR(100)
);
```

**é—®é¢˜**ï¼š

- è¡Œå®½è¿‡å¤§ï¼Œå½±å“æ€§èƒ½
- å¤§é‡NULLå€¼
- éš¾ä»¥ç»´æŠ¤
- ç´¢å¼•æ•ˆç‡ä½

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æ–¹æ¡ˆ1ï¼šå‚ç›´åˆ†å‰²
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100),
    created_at TIMESTAMP
);

CREATE TABLE user_profiles (
    user_id INTEGER PRIMARY KEY REFERENCES users(id),
    bio TEXT,
    avatar_url VARCHAR(255),
    preferences JSONB
);

-- æ–¹æ¡ˆ2ï¼šä½¿ç”¨JSONBï¼ˆPostgreSQLï¼‰
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100),
    profile_data JSONB,  -- çµæ´»å±æ€§
    created_at TIMESTAMP
);

-- ä¸ºJSONBå­—æ®µåˆ›å»ºGINç´¢å¼•
CREATE INDEX idx_users_profile_data ON users USING GIN (profile_data);
```

---

## 3. æŸ¥è¯¢è®¾è®¡åæ¨¡å¼

### 3.1. N+1æŸ¥è¯¢é—®é¢˜

**åæ¨¡å¼**ï¼šåœ¨å¾ªç¯ä¸­æ‰§è¡ŒæŸ¥è¯¢ã€‚

**é—®é¢˜ç¤ºä¾‹**ï¼š

```sql
-- åæ¨¡å¼ï¼šN+1æŸ¥è¯¢
-- åº”ç”¨ä»£ç ä¼ªä»£ç 
users = SELECT * FROM users;
FOR EACH user IN users:
    orders = SELECT * FROM orders WHERE user_id = user.id;  -- Næ¬¡æŸ¥è¯¢
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æ–¹æ¡ˆ1ï¼šä½¿ç”¨JOIN
SELECT
    u.id,
    u.username,
    o.id AS order_id,
    o.total
FROM users u
LEFT JOIN orders o ON u.id = o.user_id;

-- æ–¹æ¡ˆ2ï¼šä½¿ç”¨INå­æŸ¥è¯¢ï¼ˆå°æ•°æ®é›†ï¼‰
SELECT * FROM orders
WHERE user_id IN (SELECT id FROM users WHERE status = 'active');

-- æ–¹æ¡ˆ3ï¼šä½¿ç”¨EXISTSï¼ˆå¤§æ•°æ®é›†ï¼‰
SELECT * FROM orders o
WHERE EXISTS (
    SELECT 1 FROM users u
    WHERE u.id = o.user_id AND u.status = 'active'
);
```

### 3.2. å…¨è¡¨æ‰«æ

**åæ¨¡å¼**ï¼šæŸ¥è¯¢æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ï¼Œå¯¼è‡´å…¨è¡¨æ‰«æã€‚

**é—®é¢˜ç¤ºä¾‹**ï¼š

```sql
-- åæ¨¡å¼ï¼šå…¨è¡¨æ‰«æ
SELECT * FROM orders WHERE YEAR(order_date) = 2024;  -- å‡½æ•°è°ƒç”¨é˜»æ­¢ç´¢å¼•ä½¿ç”¨
SELECT * FROM users WHERE email LIKE '%@gmail.com';  -- å‰å¯¼é€šé…ç¬¦
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æ­£ç¡®ï¼šé¿å…å‡½æ•°è°ƒç”¨
SELECT * FROM orders
WHERE order_date >= '2024-01-01'
  AND order_date < '2025-01-01';

-- æ­£ç¡®ï¼šä½¿ç”¨å…¨æ–‡æœç´¢ï¼ˆPostgreSQLï¼‰
CREATE INDEX idx_users_email_gin ON users USING GIN (email gin_trgm_ops);
SELECT * FROM users WHERE email LIKE '%@gmail.com';  -- ä½¿ç”¨GINç´¢å¼•

-- æˆ–è€…ä½¿ç”¨å…¨æ–‡æœç´¢
CREATE INDEX idx_users_email_fulltext ON users USING GIN (to_tsvector('english', email));
SELECT * FROM users
WHERE to_tsvector('english', email) @@ to_tsquery('gmail.com');
```

### 3.3. éšå¼ç±»å‹è½¬æ¢

**åæ¨¡å¼**ï¼šWHEREæ¡ä»¶ä¸­çš„ç±»å‹ä¸åŒ¹é…å¯¼è‡´éšå¼è½¬æ¢ã€‚

**é—®é¢˜ç¤ºä¾‹**ï¼š

```sql
-- åæ¨¡å¼ï¼šéšå¼è½¬æ¢
CREATE TABLE orders (
    id VARCHAR(50) PRIMARY KEY,  -- å­—ç¬¦ä¸²ç±»å‹
    user_id INTEGER
);

-- æŸ¥è¯¢æ—¶ä½¿ç”¨æ•°å­—
SELECT * FROM orders WHERE id = 123;  -- éšå¼è½¬æ¢ï¼Œæ— æ³•ä½¿ç”¨ç´¢å¼•
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æ­£ç¡®ï¼šç±»å‹åŒ¹é…
SELECT * FROM orders WHERE id = '123';  -- å­—ç¬¦ä¸²åŒ¹é…å­—ç¬¦ä¸²

-- æˆ–è€…ä¿®æ”¹è¡¨ç»“æ„
CREATE TABLE orders (
    id INTEGER PRIMARY KEY,  -- ä½¿ç”¨æ•°å­—ç±»å‹
    user_id INTEGER
);
```

---

## 4. æ€§èƒ½ä¼˜åŒ–åæ¨¡å¼

### 4.1. ç´¢å¼•æ»¥ç”¨

**åæ¨¡å¼**ï¼šä¸ºæ‰€æœ‰åˆ—åˆ›å»ºç´¢å¼•ã€‚

**é—®é¢˜**ï¼š

- å†™æ“ä½œå˜æ…¢
- å­˜å‚¨ç©ºé—´æµªè´¹
- ç´¢å¼•ç»´æŠ¤å¼€é”€

**ç´¢å¼•åˆ›å»ºå†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[åˆ›å»ºç´¢å¼•?] --> B{åˆ—ç±»å‹}

    B -->|ä¸»é”®| C[è‡ªåŠ¨åˆ›å»º]
    B -->|å¤–é”®| D[é€šå¸¸éœ€è¦]
    B -->|æŸ¥è¯¢åˆ—| E{æŸ¥è¯¢é¢‘ç‡}
    B -->|æ’åºåˆ—| F{æ’åºé¢‘ç‡}

    E -->|é«˜| G[åˆ›å»ºç´¢å¼•]
    E -->|ä½| H[ä¸åˆ›å»º]

    F -->|é«˜| I[åˆ›å»ºç´¢å¼•]
    F -->|ä½| J[ä¸åˆ›å»º]

    G --> K[åˆ†æé€‰æ‹©æ€§]
    I --> K

    K --> L{é€‰æ‹©æ€§é«˜?}
    L -->|æ˜¯| M[åˆ›å»ºç´¢å¼•]
    L -->|å¦| N[è€ƒè™‘ä¸åˆ›å»º]
```

**æ­£ç¡®å®è·µ**ï¼š

```sql
-- åˆ†æç´¢å¼•é€‰æ‹©æ€§
SELECT
    column_name,
    COUNT(DISTINCT column_name) * 100.0 / COUNT(*) AS selectivity
FROM table_name
GROUP BY column_name;

-- é€‰æ‹©æ€§ > 10% é€šå¸¸å€¼å¾—åˆ›å»ºç´¢å¼•
-- é€‰æ‹©æ€§ < 1% é€šå¸¸ä¸å€¼å¾—

-- ç›‘æ§ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE idx_scan = 0  -- æœªä½¿ç”¨çš„ç´¢å¼•
ORDER BY pg_relation_size(indexrelid) DESC;
```

### 4.2. è¿‡åº¦è§„èŒƒåŒ–

**åæ¨¡å¼**ï¼šä¸ºäº†è§„èŒƒåŒ–è€Œè§„èŒƒåŒ–ï¼Œå¯¼è‡´æŸ¥è¯¢éœ€è¦å¤§é‡JOINã€‚

**é—®é¢˜ç¤ºä¾‹**ï¼š

```sql
-- è¿‡åº¦è§„èŒƒåŒ–ï¼šæ¯ä¸ªå±æ€§ä¸€ä¸ªè¡¨
CREATE TABLE users (id INTEGER PRIMARY KEY);
CREATE TABLE user_names (user_id INTEGER, name VARCHAR(50));
CREATE TABLE user_emails (user_id INTEGER, email VARCHAR(100));
CREATE TABLE user_phones (user_id INTEGER, phone VARCHAR(20));

-- æŸ¥è¯¢éœ€è¦å¤šæ¬¡JOIN
SELECT u.id, n.name, e.email, p.phone
FROM users u
JOIN user_names n ON u.id = n.user_id
JOIN user_emails e ON u.id = e.user_id
JOIN user_phones p ON u.id = p.user_id;
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æ­£ç¡®ï¼šé€‚åº¦åèŒƒå¼åŒ–
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,
    phone VARCHAR(20)
);

-- æˆ–è€…ï¼šåˆç†çš„è§„èŒƒåŒ–
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL
);

-- åªæœ‰å¤šå€¼å±æ€§æ‰åˆ†ç¦»
CREATE TABLE user_phones (
    user_id INTEGER REFERENCES users(id),
    phone VARCHAR(20),
    PRIMARY KEY (user_id, phone)
);
```

---

## 5. æ•°æ®ä¸€è‡´æ€§åæ¨¡å¼

### 5.1. ç¼ºå°‘å¤–é”®çº¦æŸ

**åæ¨¡å¼**ï¼šä¸ä½¿ç”¨å¤–é”®çº¦æŸï¼Œä¾èµ–åº”ç”¨å±‚ä¿è¯ä¸€è‡´æ€§ã€‚

**é—®é¢˜**ï¼š

- æ•°æ®ä¸ä¸€è‡´
- å­¤ç«‹è®°å½•
- éš¾ä»¥ç»´æŠ¤

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æ­£ç¡®ï¼šä½¿ç”¨å¤–é”®çº¦æŸ
CREATE TABLE orders (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id)
        ON DELETE RESTRICT  -- é˜²æ­¢åˆ é™¤æœ‰è®¢å•çš„ç”¨æˆ·
        ON UPDATE CASCADE   -- ç”¨æˆ·IDæ›´æ–°æ—¶çº§è”
);

-- æ£€æŸ¥å­¤ç«‹è®°å½•
SELECT o.*
FROM orders o
LEFT JOIN users u ON o.user_id = u.id
WHERE u.id IS NULL;  -- æ‰¾åˆ°å­¤ç«‹è®°å½•
```

### 5.2. è§¦å‘å™¨æ»¥ç”¨

**åæ¨¡å¼**ï¼šä½¿ç”¨è§¦å‘å™¨å®ç°å¤æ‚ä¸šåŠ¡é€»è¾‘ã€‚

**é—®é¢˜**ï¼š

- éš¾ä»¥è°ƒè¯•
- æ€§èƒ½å½±å“
- éšè—çš„ä¸šåŠ¡é€»è¾‘

**è§£å†³æ–¹æ¡ˆå†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[ä½¿ç”¨è§¦å‘å™¨?] --> B{é€»è¾‘ç±»å‹}

    B -->|å®¡è®¡æ—¥å¿—| C[å¯ä»¥ä½¿ç”¨]
    B -->|æ•°æ®éªŒè¯| D[è€ƒè™‘CHECKçº¦æŸ]
    B -->|ä¸šåŠ¡é€»è¾‘| E[åº”ç”¨å±‚å®ç°]
    B -->|æ•°æ®åŒæ­¥| F[è€ƒè™‘äº‹ä»¶é©±åŠ¨]

    C --> G[å®ç°è§¦å‘å™¨]
    D --> H[ä½¿ç”¨çº¦æŸ]
    E --> I[åº”ç”¨ä»£ç ]
    F --> J[æ¶ˆæ¯é˜Ÿåˆ—]
```

**æ­£ç¡®å®è·µ**ï¼š

```sql
-- è§¦å‘å™¨ç”¨äºå®¡è®¡ï¼ˆåˆç†ä½¿ç”¨ï¼‰
CREATE TABLE audit_log (
    id SERIAL PRIMARY KEY,
    table_name VARCHAR(100),
    operation VARCHAR(20),
    old_data JSONB,
    new_data JSONB,
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE OR REPLACE FUNCTION audit_trigger()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO audit_log (table_name, operation, old_data, new_data)
    VALUES (
        TG_TABLE_NAME,
        TG_OP,
        row_to_json(OLD),
        row_to_json(NEW)
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER users_audit
AFTER INSERT OR UPDATE OR DELETE ON users
FOR EACH ROW EXECUTE FUNCTION audit_trigger();
```

---

## 6. åæ¨¡å¼è¯†åˆ«æ–¹æ³•

### 6.1. åæ¨¡å¼æ£€æµ‹å·¥å…·

**è‡ªåŠ¨åŒ–æ£€æµ‹å·¥å…·**ï¼š

```sql
-- æ£€æµ‹å¤šç”¨é€”è¡¨
SELECT
    table_name,
    column_count,
    CASE
        WHEN column_count > 50 THEN 'å¯èƒ½çš„å¤šç”¨é€”è¡¨'
        ELSE 'æ­£å¸¸'
    END AS status
FROM (
    SELECT
        table_name,
        COUNT(*) as column_count
    FROM information_schema.columns
    WHERE table_schema = 'public'
    GROUP BY table_name
) t
WHERE column_count > 50;

-- æ£€æµ‹ç¼ºå°‘å¤–é”®çš„è¡¨
SELECT
    t.table_name,
    COUNT(c.column_name) as foreign_key_count
FROM information_schema.tables t
LEFT JOIN information_schema.table_constraints tc
    ON t.table_name = tc.table_name
    AND tc.constraint_type = 'FOREIGN KEY'
LEFT JOIN information_schema.key_column_usage c
    ON tc.constraint_name = c.constraint_name
WHERE t.table_schema = 'public'
    AND t.table_type = 'BASE TABLE'
GROUP BY t.table_name
HAVING COUNT(c.column_name) = 0;

-- æ£€æµ‹ç¼ºå°‘ç´¢å¼•çš„è¡¨
SELECT
    schemaname,
    tablename,
    seq_scan,
    idx_scan,
    seq_scan - idx_scan AS too_many_seq_scans
FROM pg_stat_user_tables
WHERE seq_scan > idx_scan + 10000
ORDER BY too_many_seq_scans DESC;
```

### 6.2. åæ¨¡å¼æ£€æŸ¥æ¸…å•

**Schemaè®¾è®¡æ£€æŸ¥æ¸…å•**ï¼š

| æ£€æŸ¥é¡¹ | æ£€æŸ¥å†…å®¹ | ä¸¥é‡ç¨‹åº¦ |
|--------|---------|---------|
| **è¡¨è®¾è®¡** | è¡¨åˆ—æ•°æ˜¯å¦è¿‡å¤šï¼ˆ>50åˆ—ï¼‰ | â­â­â­ |
| **è¡¨è®¾è®¡** | æ˜¯å¦å­˜åœ¨å¤šç”¨é€”è¡¨ | â­â­â­â­ |
| **ç´¢å¼•è®¾è®¡** | æ˜¯å¦ç¼ºå°‘å¿…è¦ç´¢å¼• | â­â­â­â­ |
| **ç´¢å¼•è®¾è®¡** | æ˜¯å¦å­˜åœ¨ç´¢å¼•æ»¥ç”¨ | â­â­â­ |
| **çº¦æŸè®¾è®¡** | æ˜¯å¦ç¼ºå°‘å¤–é”®çº¦æŸ | â­â­â­â­â­ |
| **çº¦æŸè®¾è®¡** | æ˜¯å¦ç¼ºå°‘æ£€æŸ¥çº¦æŸ | â­â­â­ |
| **æ•°æ®ç±»å‹** | æ•°æ®ç±»å‹æ˜¯å¦åˆé€‚ | â­â­â­ |
| **èŒƒå¼è®¾è®¡** | æ˜¯å¦è¿‡åº¦è§„èŒƒåŒ– | â­â­â­ |

### 6.3. åæ¨¡å¼è¯†åˆ«å†³ç­–æ ‘

```mermaid
flowchart TD
    A[å¼€å§‹åæ¨¡å¼è¯†åˆ«] --> B{è¡¨è®¾è®¡}

    B -->|åˆ—æ•°>50| C[å¯èƒ½çš„å¤šç”¨é€”è¡¨]
    B -->|å•è¡¨ç»§æ‰¿| D[å•è¡¨ç»§æ‰¿åæ¨¡å¼]
    B -->|æ­£å¸¸| E{ç´¢å¼•è®¾è®¡}

    E -->|ç¼ºå°‘ç´¢å¼•| F[ç´¢å¼•ç¼ºå¤±åæ¨¡å¼]
    E -->|ç´¢å¼•è¿‡å¤š| G[ç´¢å¼•æ»¥ç”¨åæ¨¡å¼]
    E -->|æ­£å¸¸| H{çº¦æŸè®¾è®¡}

    H -->|ç¼ºå°‘å¤–é”®| I[å¤–é”®ç¼ºå¤±åæ¨¡å¼]
    H -->|ç¼ºå°‘æ£€æŸ¥çº¦æŸ| J[çº¦æŸç¼ºå¤±åæ¨¡å¼]
    H -->|æ­£å¸¸| K[è®¾è®¡æ­£å¸¸]
```

---

## 7. åæ¨¡å¼ä¿®å¤ç­–ç•¥

### 7.1. ä¿®å¤ä¼˜å…ˆçº§

**ä¼˜å…ˆçº§çŸ©é˜µ**ï¼š

| åæ¨¡å¼ | å½±å“ç¨‹åº¦ | ä¿®å¤éš¾åº¦ | ä¼˜å…ˆçº§ | å»ºè®®ä¿®å¤æ—¶é—´ |
|--------|---------|---------|--------|------------|
| **ç¼ºå°‘å¤–é”®çº¦æŸ** | â­â­â­â­â­ | â­â­ | P0 | ç«‹å³ä¿®å¤ |
| **ç´¢å¼•ç¼ºå¤±** | â­â­â­â­ | â­â­â­ | P0 | 1å‘¨å†… |
| **å¤šç”¨é€”è¡¨** | â­â­â­â­ | â­â­â­â­ | P1 | 1ä¸ªæœˆå†… |
| **N+1æŸ¥è¯¢** | â­â­â­ | â­â­ | P1 | 2å‘¨å†… |
| **ç´¢å¼•æ»¥ç”¨** | â­â­â­ | â­â­ | P2 | 1ä¸ªæœˆå†… |
| **è¿‡åº¦è§„èŒƒåŒ–** | â­â­ | â­â­â­ | P2 | 2ä¸ªæœˆå†… |

### 7.2. ä¿®å¤æ–¹æ³•

**ä¿®å¤æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[è¯†åˆ«åæ¨¡å¼] --> B[è¯„ä¼°å½±å“]
    B --> C[åˆ¶å®šä¿®å¤è®¡åˆ’]
    C --> D[å®æ–½ä¿®å¤]
    D --> E[éªŒè¯ä¿®å¤æ•ˆæœ]
    E --> F{æ•ˆæœæ»¡æ„?}
    F -->|æ˜¯| G[ä¿®å¤å®Œæˆ]
    F -->|å¦| H[è°ƒæ•´ä¿®å¤æ–¹æ¡ˆ]
    H --> D
```

**ä¿®å¤ç¤ºä¾‹**ï¼š

```sql
-- ä¿®å¤ç¼ºå°‘å¤–é”®çº¦æŸ
-- æ­¥éª¤1ï¼šæ·»åŠ å¤–é”®çº¦æŸ
ALTER TABLE order_items
ADD CONSTRAINT fk_order_items_order
FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE;

-- æ­¥éª¤2ï¼šéªŒè¯æ•°æ®å®Œæ•´æ€§
SELECT COUNT(*) FROM order_items oi
LEFT JOIN orders o ON oi.order_id = o.id
WHERE o.id IS NULL;  -- åº”è¯¥è¿”å›0

-- æ­¥éª¤3ï¼šåˆ›å»ºç´¢å¼•ï¼ˆå¦‚æœå¤–é”®åˆ—æ²¡æœ‰ç´¢å¼•ï¼‰
CREATE INDEX idx_order_items_order_id ON order_items(order_id);
```

### 7.3. ä¿®å¤å†³ç­–æ ‘

```mermaid
flowchart TD
    A[å‘ç°åæ¨¡å¼] --> B{å½±å“ç¨‹åº¦}

    B -->|é«˜| C{ä¿®å¤éš¾åº¦}
    B -->|ä¸­| D{ä¿®å¤æˆæœ¬}
    B -->|ä½| E[ä½ä¼˜å…ˆçº§]

    C -->|ä½| F[ç«‹å³ä¿®å¤]
    C -->|é«˜| G[åˆ¶å®šè®¡åˆ’]

    D -->|ä½| H[è¿‘æœŸä¿®å¤]
    D -->|é«˜| I[é•¿æœŸè§„åˆ’]

    F --> J[å®æ–½ä¿®å¤]
    G --> J
    H --> J
    I --> K[çº³å…¥é‡æ„è®¡åˆ’]
```

---

## 8. åæ¨¡å¼é¢„é˜²æªæ–½

### 8.1. è®¾è®¡è¯„å®¡

**è®¾è®¡è¯„å®¡æ£€æŸ¥æ¸…å•**ï¼š

1. **Schemaè®¾è®¡è¯„å®¡**ï¼š
   - è¡¨è®¾è®¡æ˜¯å¦åˆç†
   - ç´¢å¼•è®¾è®¡æ˜¯å¦å……åˆ†
   - çº¦æŸè®¾è®¡æ˜¯å¦å®Œæ•´
   - æ•°æ®ç±»å‹æ˜¯å¦åˆé€‚

2. **æŸ¥è¯¢è®¾è®¡è¯„å®¡**ï¼š
   - æ˜¯å¦å­˜åœ¨N+1æŸ¥è¯¢
   - æ˜¯å¦å­˜åœ¨å…¨è¡¨æ‰«æ
   - æŸ¥è¯¢æ˜¯å¦å¯ä»¥ä½¿ç”¨ç´¢å¼•

3. **æ€§èƒ½è®¾è®¡è¯„å®¡**ï¼š
   - æ˜¯å¦è€ƒè™‘äº†æ€§èƒ½éœ€æ±‚
   - æ˜¯å¦è¿›è¡Œäº†æ€§èƒ½æµ‹è¯•
   - æ˜¯å¦å»ºç«‹äº†ç›‘æ§æœºåˆ¶

### 8.2. ä»£ç å®¡æŸ¥

**ä»£ç å®¡æŸ¥è¦ç‚¹**ï¼š

1. **SQLä»£ç å®¡æŸ¥**ï¼š
   - SQLè¯­å¥æ˜¯å¦ä¼˜åŒ–
   - æ˜¯å¦ä½¿ç”¨äº†åˆé€‚çš„ç´¢å¼•
   - æ˜¯å¦é¿å…äº†åæ¨¡å¼

2. **ORMä»£ç å®¡æŸ¥**ï¼š
   - æ˜¯å¦é¿å…äº†N+1æŸ¥è¯¢
   - æ˜¯å¦ä½¿ç”¨äº†é¢„åŠ è½½
   - æ˜¯å¦ä½¿ç”¨äº†æ‰¹é‡æ“ä½œ

### 8.3. è‡ªåŠ¨åŒ–æ£€æŸ¥

**è‡ªåŠ¨åŒ–æ£€æŸ¥å·¥å…·**ï¼š

```python
# åæ¨¡å¼æ£€æµ‹è„šæœ¬ç¤ºä¾‹
import psycopg2
from typing import List, Dict

class AntiPatternDetector:
    def __init__(self, connection_string: str):
        self.conn = psycopg2.connect(connection_string)

    def detect_god_tables(self) -> List[Dict]:
        """æ£€æµ‹å¤šç”¨é€”è¡¨"""
        query = """
        SELECT
            table_name,
            COUNT(*) as column_count
        FROM information_schema.columns
        WHERE table_schema = 'public'
        GROUP BY table_name
        HAVING COUNT(*) > 50
        ORDER BY column_count DESC;
        """
        cursor = self.conn.cursor()
        cursor.execute(query)
        return [{'table': row[0], 'columns': row[1]}
                for row in cursor.fetchall()]

    def detect_missing_foreign_keys(self) -> List[Dict]:
        """æ£€æµ‹ç¼ºå°‘å¤–é”®çš„è¡¨"""
        query = """
        SELECT
            t.table_name,
            COUNT(c.column_name) as fk_count
        FROM information_schema.tables t
        LEFT JOIN information_schema.table_constraints tc
            ON t.table_name = tc.table_name
            AND tc.constraint_type = 'FOREIGN KEY'
        LEFT JOIN information_schema.key_column_usage c
            ON tc.constraint_name = c.constraint_name
        WHERE t.table_schema = 'public'
            AND t.table_type = 'BASE TABLE'
        GROUP BY t.table_name
        HAVING COUNT(c.column_name) = 0;
        """
        cursor = self.conn.cursor()
        cursor.execute(query)
        return [{'table': row[0]} for row in cursor.fetchall()]

    def detect_missing_indexes(self) -> List[Dict]:
        """æ£€æµ‹ç¼ºå°‘ç´¢å¼•çš„è¡¨"""
        query = """
        SELECT
            schemaname,
            tablename,
            seq_scan,
            idx_scan,
            seq_scan - idx_scan AS too_many_seq_scans
        FROM pg_stat_user_tables
        WHERE seq_scan > idx_scan + 10000
        ORDER BY too_many_seq_scans DESC;
        """
        cursor = self.conn.cursor()
        cursor.execute(query)
        return [{'table': row[1], 'seq_scans': row[2], 'idx_scans': row[3]}
                for row in cursor.fetchall()]

    def generate_report(self) -> str:
        """ç”Ÿæˆåæ¨¡å¼æ£€æµ‹æŠ¥å‘Š"""
        report = []
        report.append("=== åæ¨¡å¼æ£€æµ‹æŠ¥å‘Š ===\n")

        god_tables = self.detect_god_tables()
        if god_tables:
            report.append(f"å¤šç”¨é€”è¡¨: {len(god_tables)}ä¸ª")
            for table in god_tables:
                report.append(f"  - {table['table']}: {table['columns']}åˆ—")

        missing_fks = self.detect_missing_foreign_keys()
        if missing_fks:
            report.append(f"\nç¼ºå°‘å¤–é”®çš„è¡¨: {len(missing_fks)}ä¸ª")
            for table in missing_fks:
                report.append(f"  - {table['table']}")

        missing_indexes = self.detect_missing_indexes()
        if missing_indexes:
            report.append(f"\nç¼ºå°‘ç´¢å¼•çš„è¡¨: {len(missing_indexes)}ä¸ª")
            for table in missing_indexes:
                report.append(f"  - {table['table']}: {table['seq_scans']}æ¬¡é¡ºåºæ‰«æ")

        return "\n".join(report)
```

---

## 9. å®é™…æ¡ˆä¾‹æ·±åº¦åˆ†æ

### 9.1. æ¡ˆä¾‹1ï¼šç”µå•†ç³»ç»Ÿåæ¨¡å¼ä¿®å¤

**èƒŒæ™¯**ï¼š

æŸç”µå•†ç³»ç»Ÿå­˜åœ¨å¤šä¸ªåæ¨¡å¼ï¼Œå¯¼è‡´æ€§èƒ½é—®é¢˜å’Œæ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚

**å‘ç°çš„åæ¨¡å¼**ï¼š

1. **ç¼ºå°‘å¤–é”®çº¦æŸ**ï¼šè®¢å•é¡¹è¡¨ç¼ºå°‘å¤–é”®çº¦æŸ
2. **ç´¢å¼•ç¼ºå¤±**ï¼šå•†å“æœç´¢æŸ¥è¯¢ç¼ºå°‘ç´¢å¼•
3. **N+1æŸ¥è¯¢**ï¼šè®¢å•åˆ—è¡¨æŸ¥è¯¢å­˜åœ¨N+1é—®é¢˜

**ä¿®å¤è¿‡ç¨‹**ï¼š

1. **æ·»åŠ å¤–é”®çº¦æŸ**ï¼š

   ```sql
   -- éªŒè¯æ•°æ®å®Œæ•´æ€§
   SELECT COUNT(*) FROM order_items oi
   LEFT JOIN orders o ON oi.order_id = o.id
   WHERE o.id IS NULL;

   -- æ·»åŠ å¤–é”®çº¦æŸ
   ALTER TABLE order_items
   ADD CONSTRAINT fk_order_items_order
   FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE;
   ```

2. **åˆ›å»ºç´¢å¼•**ï¼š

   ```sql
   -- åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•
   CREATE INDEX idx_products_name_gin ON products
       USING gin(to_tsvector('english', name));
   ```

3. **ä¼˜åŒ–æŸ¥è¯¢**ï¼š

   ```sql
   -- ä¼˜åŒ–å‰ï¼šN+1æŸ¥è¯¢
   -- ä¼˜åŒ–åï¼šä½¿ç”¨JOIN
   SELECT o.*, u.username, u.email
   FROM orders o
   JOIN users u ON o.user_id = u.id
   WHERE o.user_id = $1
   ORDER BY o.created_at DESC
   LIMIT 20;
   ```

**ä¿®å¤æ•ˆæœ**ï¼š

- æ•°æ®ä¸€è‡´æ€§ï¼š100%
- æŸ¥è¯¢æ€§èƒ½ï¼šæå‡10x
- ç³»ç»Ÿç¨³å®šæ€§ï¼šæ˜¾è‘—æå‡

### 9.2. æ¡ˆä¾‹2ï¼šé‡‘èç³»ç»Ÿåæ¨¡å¼ä¿®å¤

**èƒŒæ™¯**ï¼š

æŸé‡‘èç³»ç»Ÿå­˜åœ¨å®‰å…¨ç›¸å…³çš„åæ¨¡å¼ã€‚

**å‘ç°çš„åæ¨¡å¼**ï¼š

1. **ç¼ºå°‘æ£€æŸ¥çº¦æŸ**ï¼šè´¦æˆ·ä½™é¢å¯ä»¥ä¸ºè´Ÿæ•°
2. **ç¼ºå°‘å®¡è®¡æ—¥å¿—**ï¼šå…³é”®æ“ä½œæ²¡æœ‰å®¡è®¡æ—¥å¿—
3. **æ•°æ®ç±»å‹ä¸å½“**ï¼šé‡‘é¢ä½¿ç”¨FLOATç±»å‹

**ä¿®å¤è¿‡ç¨‹**ï¼š

1. **æ·»åŠ æ£€æŸ¥çº¦æŸ**ï¼š

   ```sql
   ALTER TABLE accounts
   ADD CONSTRAINT chk_accounts_balance
       CHECK (balance >= 0);
   ```

2. **æ·»åŠ å®¡è®¡æ—¥å¿—**ï¼š

   ```sql
   CREATE TABLE audit_logs (
       id UUID PRIMARY KEY,
       table_name VARCHAR(100),
       operation VARCHAR(20),
       record_id UUID,
       old_data JSONB,
       new_data JSONB,
       created_at TIMESTAMP
   );
   ```

3. **ä¿®æ”¹æ•°æ®ç±»å‹**ï¼š

   ```sql
   -- ä½¿ç”¨DECIMALæ›¿ä»£FLOAT
   ALTER TABLE accounts
   ALTER COLUMN balance TYPE DECIMAL(15,2);
   ```

**ä¿®å¤æ•ˆæœ**ï¼š

- æ•°æ®å®Œæ•´æ€§ï¼š100%
- å®¡è®¡è¦†ç›–ç‡ï¼š100%
- æ•°æ®ç²¾åº¦ï¼šæ˜¾è‘—æå‡

### 9.3. æ¡ˆä¾‹3ï¼šç¤¾äº¤ç½‘ç»œåæ¨¡å¼ä¿®å¤

**èƒŒæ™¯**ï¼š

æŸç¤¾äº¤ç½‘ç»œç³»ç»Ÿå­˜åœ¨æ€§èƒ½ç›¸å…³çš„åæ¨¡å¼ã€‚

**å‘ç°çš„åæ¨¡å¼**ï¼š

1. **å¤šç”¨é€”è¡¨**ï¼šå°†æ‰€æœ‰æ•°æ®å¡è¿›ä¸€ä¸ªè¡¨
2. **ç¼ºå°‘åˆ†åŒº**ï¼šå¤§è¡¨æ²¡æœ‰åˆ†åŒº
3. **ç´¢å¼•æ»¥ç”¨**ï¼šåˆ›å»ºäº†è¿‡å¤šä¸å¿…è¦çš„ç´¢å¼•

**ä¿®å¤è¿‡ç¨‹**ï¼š

1. **è¡¨æ‹†åˆ†**ï¼š

   ```sql
   -- æ‹†åˆ†å¤šç”¨é€”è¡¨
   CREATE TABLE users (...);
   CREATE TABLE posts (...);
   CREATE TABLE comments (...);
   ```

2. **æ·»åŠ åˆ†åŒº**ï¼š

   ```sql
   -- ä¸ºå¸–å­è¡¨æ·»åŠ åˆ†åŒº
   CREATE TABLE posts (
       ...
   ) PARTITION BY RANGE (created_at);
   ```

3. **ç´¢å¼•ä¼˜åŒ–**ï¼š

   ```sql
   -- åˆ é™¤ä¸å¿…è¦çš„ç´¢å¼•
   DROP INDEX idx_posts_unused;

   -- åˆ›å»ºå¿…è¦çš„å¤åˆç´¢å¼•
   CREATE INDEX idx_posts_user_created ON posts(user_id, created_at DESC);
   ```

**ä¿®å¤æ•ˆæœ**ï¼š

- æŸ¥è¯¢æ€§èƒ½ï¼šæå‡5x
- å­˜å‚¨ç©ºé—´ï¼šå‡å°‘30%
- ç»´æŠ¤æˆæœ¬ï¼šé™ä½40%

---

## 10. åæ¨¡å¼å¯¹æ¯”çŸ©é˜µ

### 10.1. åæ¨¡å¼å½±å“å¯¹æ¯”

| åæ¨¡å¼ | æ€§èƒ½å½±å“ | æ•°æ®å®Œæ•´æ€§å½±å“ | å¯ç»´æŠ¤æ€§å½±å“ | æ€»ä½“å½±å“ |
|--------|---------|--------------|------------|---------|
| **ç¼ºå°‘å¤–é”®çº¦æŸ** | â­â­ | â­â­â­â­â­ | â­â­â­ | â­â­â­â­â­ |
| **ç´¢å¼•ç¼ºå¤±** | â­â­â­â­â­ | â­ | â­â­ | â­â­â­â­ |
| **å¤šç”¨é€”è¡¨** | â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­â­ |
| **N+1æŸ¥è¯¢** | â­â­â­â­ | â­ | â­â­ | â­â­â­ |
| **ç´¢å¼•æ»¥ç”¨** | â­â­â­ | â­ | â­â­ | â­â­ |
| **è¿‡åº¦è§„èŒƒåŒ–** | â­â­ | â­ | â­â­â­ | â­â­ |

### 10.2. ä¿®å¤æˆæœ¬å¯¹æ¯”

| åæ¨¡å¼ | ä¿®å¤æ—¶é—´ | ä¿®å¤é£é™© | ä¿®å¤æˆæœ¬ | æ€»ä½“æˆæœ¬ |
|--------|---------|---------|---------|---------|
| **ç¼ºå°‘å¤–é”®çº¦æŸ** | 1-2å¤© | ä¸­ | ä½ | ä½-ä¸­ |
| **ç´¢å¼•ç¼ºå¤±** | 1-3å¤© | ä½ | ä½ | ä½ |
| **å¤šç”¨é€”è¡¨** | 1-2å‘¨ | é«˜ | é«˜ | é«˜ |
| **N+1æŸ¥è¯¢** | 1-3å¤© | ä½ | ä½ | ä½ |
| **ç´¢å¼•æ»¥ç”¨** | 1-2å¤© | ä½ | ä½ | ä½ |
| **è¿‡åº¦è§„èŒƒåŒ–** | 1-2å‘¨ | ä¸­ | ä¸­ | ä¸­ |

---

## 11. å½¢å¼åŒ–åæ¨¡å¼è¯†åˆ«

### 11.1. åæ¨¡å¼å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰11.1.1ï¼ˆåæ¨¡å¼æ£€æµ‹è§„åˆ™ï¼‰**ï¼š

```text
åæ¨¡å¼æ£€æµ‹è§„åˆ™é›† R = {râ‚, râ‚‚, ..., râ‚™}

æ¯æ¡è§„åˆ™ ráµ¢ = (æ¡ä»¶, åæ¨¡å¼ç±»å‹, ä¸¥é‡ç¨‹åº¦)

æ£€æµ‹å‡½æ•°ï¼š
detect(Schema S, Rule r) â†’ Boolean

åæ¨¡å¼é›†åˆï¼š
AntiPatterns(S) = {ráµ¢.type | ráµ¢ âˆˆ R âˆ§ detect(S, ráµ¢) = true}
```

### 11.2. è‡ªåŠ¨åŒ–æ£€æµ‹ç®—æ³•

```python
from dataclasses import dataclass
from typing import List, Dict, Any
from enum import Enum

class Severity(Enum):
    LOW = 1
    MEDIUM = 2
    HIGH = 3
    CRITICAL = 4

@dataclass
class AntiPattern:
    name: str
    severity: Severity
    table: str
    description: str
    recommendation: str

class AntiPatternDetector:
    """åæ¨¡å¼è‡ªåŠ¨æ£€æµ‹å™¨"""

    def __init__(self, conn):
        self.conn = conn

    def detect_all(self, schema: str = 'public') -> List[AntiPattern]:
        """æ£€æµ‹æ‰€æœ‰åæ¨¡å¼"""
        results = []
        results.extend(self.detect_god_table(schema))
        results.extend(self.detect_missing_pk(schema))
        results.extend(self.detect_missing_fk_index(schema))
        results.extend(self.detect_wide_table(schema))
        results.extend(self.detect_unused_indexes(schema))
        return results

    def detect_god_table(self, schema: str) -> List[AntiPattern]:
        """æ£€æµ‹God Tableåæ¨¡å¼"""
        query = """
        SELECT table_name, COUNT(*) as column_count
        FROM information_schema.columns
        WHERE table_schema = %s
        GROUP BY table_name
        HAVING COUNT(*) > 30
        """
        results = []
        with self.conn.cursor() as cur:
            cur.execute(query, (schema,))
            for row in cur.fetchall():
                results.append(AntiPattern(
                    name="God Table",
                    severity=Severity.HIGH,
                    table=row[0],
                    description=f"è¡¨ {row[0]} æœ‰ {row[1]} åˆ—ï¼Œè¶…è¿‡30åˆ—é˜ˆå€¼",
                    recommendation="è€ƒè™‘æŒ‰èŒè´£æ‹†åˆ†ä¸ºå¤šä¸ªè¡¨"
                ))
        return results

    def detect_missing_pk(self, schema: str) -> List[AntiPattern]:
        """æ£€æµ‹ç¼ºå°‘ä¸»é”®"""
        query = """
        SELECT t.table_name
        FROM information_schema.tables t
        LEFT JOIN information_schema.table_constraints tc
            ON t.table_name = tc.table_name
            AND tc.constraint_type = 'PRIMARY KEY'
        WHERE t.table_schema = %s
            AND t.table_type = 'BASE TABLE'
            AND tc.constraint_name IS NULL
        """
        results = []
        with self.conn.cursor() as cur:
            cur.execute(query, (schema,))
            for row in cur.fetchall():
                results.append(AntiPattern(
                    name="Missing Primary Key",
                    severity=Severity.CRITICAL,
                    table=row[0],
                    description=f"è¡¨ {row[0]} æ²¡æœ‰ä¸»é”®",
                    recommendation="æ·»åŠ ä¸»é”®çº¦æŸ"
                ))
        return results

    def detect_missing_fk_index(self, schema: str) -> List[AntiPattern]:
        """æ£€æµ‹å¤–é”®åˆ—ç¼ºå°‘ç´¢å¼•"""
        query = """
        SELECT
            tc.table_name,
            kcu.column_name
        FROM information_schema.table_constraints tc
        JOIN information_schema.key_column_usage kcu
            ON tc.constraint_name = kcu.constraint_name
        WHERE tc.constraint_type = 'FOREIGN KEY'
            AND tc.table_schema = %s
            AND NOT EXISTS (
                SELECT 1 FROM pg_indexes pi
                WHERE pi.tablename = tc.table_name
                    AND pi.indexdef LIKE '%%' || kcu.column_name || '%%'
            )
        """
        results = []
        with self.conn.cursor() as cur:
            cur.execute(query, (schema,))
            for row in cur.fetchall():
                results.append(AntiPattern(
                    name="Missing FK Index",
                    severity=Severity.HIGH,
                    table=row[0],
                    description=f"å¤–é”®åˆ— {row[0]}.{row[1]} ç¼ºå°‘ç´¢å¼•",
                    recommendation=f"CREATE INDEX ON {row[0]}({row[1]})"
                ))
        return results

# ä½¿ç”¨ç¤ºä¾‹
# detector = AntiPatternDetector(conn)
# issues = detector.detect_all()
# for issue in issues:
#     print(f"[{issue.severity.name}] {issue.name}: {issue.description}")
```

---

## 12. å‚è€ƒèµ„æ–™

### 12.1. æƒå¨æ–‡çŒ®

- **Bill Karwin** (2010). "SQL Antipatterns: Avoiding the Pitfalls of Database Programming"
- **Martin Fowler** (2002). "Patterns of Enterprise Application Architecture"
- **Ambler, S.** (2003). "Agile Database Techniques"

### 12.2. åœ¨çº¿èµ„æº

| èµ„æº | URL | æè¿° |
|------|-----|------|
| **PostgreSQL Wiki** | <https://wiki.postgresql.org/wiki/Don%27t_Do_This> | PGåæ¨¡å¼ |
| **Use The Index, Luke** | <https://use-the-index-luke.com> | ç´¢å¼•åæ¨¡å¼ |
| **SQL Performance** | <https://sqlperformance.com> | æ€§èƒ½åæ¨¡å¼ |

### 12.3. ç›¸å…³æ–‡æ¡£

- [07.01-Schemaè®¾è®¡æ–¹æ³•è®º](./07.01-Schemaè®¾è®¡æ–¹æ³•è®º.md)
- [07.08-æ•°æ®åº“æ€§èƒ½è°ƒä¼˜](./07.08-æ•°æ®åº“æ€§èƒ½è°ƒä¼˜.md)
- [07.14-æ•°æ®åº“è®¾è®¡æœ€ä½³å®è·µåº“](./07.14-æ•°æ®åº“è®¾è®¡æœ€ä½³å®è·µåº“.md)

---

**æœ€åæ›´æ–°**ï¼š2025-12-01
**ç»´æŠ¤è€…**ï¼šData-Science Team
**çŠ¶æ€**ï¼šå®æ–½ä¸­
**ç‰ˆæœ¬**ï¼šv2.0 (å¢å¼ºç‰ˆ)
