# æ•°æ®åº“è®¾è®¡åæ¨¡å¼ä¸è§£å†³æ–¹æ¡ˆï¼šå¸¸è§é™·é˜±ä¸æœ€ä½³å®è·µ

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-01-15
> **ç‰ˆæœ¬**ï¼šv1.0
> **çŠ¶æ€**ï¼šå®æ–½ä¸­

---

## ğŸ“‹ ç›®å½•

- [æ•°æ®åº“è®¾è®¡åæ¨¡å¼ä¸è§£å†³æ–¹æ¡ˆï¼šå¸¸è§é™·é˜±ä¸æœ€ä½³å®è·µ](#æ•°æ®åº“è®¾è®¡åæ¨¡å¼ä¸è§£å†³æ–¹æ¡ˆå¸¸è§é™·é˜±ä¸æœ€ä½³å®è·µ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1. åæ¨¡å¼åˆ†ç±»](#11-åæ¨¡å¼åˆ†ç±»)
  - [2. Schemaè®¾è®¡åæ¨¡å¼](#2-schemaè®¾è®¡åæ¨¡å¼)
    - [2.1. å¤šç”¨é€”è¡¨ï¼ˆGod Tableï¼‰](#21-å¤šç”¨é€”è¡¨god-table)
    - [2.2. å•è¡¨ç»§æ‰¿ï¼ˆSingle Table Inheritanceï¼‰](#22-å•è¡¨ç»§æ‰¿single-table-inheritance)
    - [2.3. ä¼ªé”®æ»¥ç”¨ï¼ˆPseudokey Neat-Freakï¼‰](#23-ä¼ªé”®æ»¥ç”¨pseudokey-neat-freak)
    - [2.4. åˆ—æ•°è¿‡å¤šï¼ˆWide Tableï¼‰](#24-åˆ—æ•°è¿‡å¤šwide-table)
  - [3. æŸ¥è¯¢è®¾è®¡åæ¨¡å¼](#3-æŸ¥è¯¢è®¾è®¡åæ¨¡å¼)
    - [3.1. N+1æŸ¥è¯¢é—®é¢˜](#31-n1æŸ¥è¯¢é—®é¢˜)
    - [3.2. å…¨è¡¨æ‰«æ](#32-å…¨è¡¨æ‰«æ)
    - [3.3. éšå¼ç±»å‹è½¬æ¢](#33-éšå¼ç±»å‹è½¬æ¢)
  - [4. æ€§èƒ½ä¼˜åŒ–åæ¨¡å¼](#4-æ€§èƒ½ä¼˜åŒ–åæ¨¡å¼)
    - [4.1. ç´¢å¼•æ»¥ç”¨](#41-ç´¢å¼•æ»¥ç”¨)
    - [4.2. è¿‡åº¦è§„èŒƒåŒ–](#42-è¿‡åº¦è§„èŒƒåŒ–)
  - [5. æ•°æ®ä¸€è‡´æ€§åæ¨¡å¼](#5-æ•°æ®ä¸€è‡´æ€§åæ¨¡å¼)
    - [5.1. ç¼ºå°‘å¤–é”®çº¦æŸ](#51-ç¼ºå°‘å¤–é”®çº¦æŸ)
    - [5.2. è§¦å‘å™¨æ»¥ç”¨](#52-è§¦å‘å™¨æ»¥ç”¨)
  - [6. å‚è€ƒèµ„æ–™](#6-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

åæ¨¡å¼ï¼ˆAnti-patternï¼‰æ˜¯çœ‹ä¼¼åˆç†ä½†å®é™…æœ‰å®³çš„è®¾è®¡æ¨¡å¼ã€‚æœ¬æ–‡æ¡£è¯†åˆ«å¸¸è§çš„æ•°æ®åº“è®¾è®¡åæ¨¡å¼å¹¶æä¾›è§£å†³æ–¹æ¡ˆã€‚

### 1.1. åæ¨¡å¼åˆ†ç±»

```mermaid
mindmap
  root((æ•°æ®åº“åæ¨¡å¼))
    Schemaåæ¨¡å¼
      å¤šç”¨é€”è¡¨
      å•è¡¨ç»§æ‰¿
      ä¼ªé”®æ»¥ç”¨
      åˆ—æ•°è¿‡å¤š
    æŸ¥è¯¢åæ¨¡å¼
      N+1æŸ¥è¯¢
      å…¨è¡¨æ‰«æ
      éšå¼è½¬æ¢
      è¿‡åº¦ä½¿ç”¨å­æŸ¥è¯¢
    æ€§èƒ½åæ¨¡å¼
      ç´¢å¼•æ»¥ç”¨
      è¿‡åº¦è§„èŒƒåŒ–
      ç¼ºå°‘ç´¢å¼•
      æ•°æ®ç±»å‹ä¸å½“
    ä¸€è‡´æ€§åæ¨¡å¼
      ç¼ºå°‘å¤–é”®
      è§¦å‘å™¨æ»¥ç”¨
      å…¨å±€çŠ¶æ€è¡¨
```

---

## 2. Schemaè®¾è®¡åæ¨¡å¼

### 2.1. å¤šç”¨é€”è¡¨ï¼ˆGod Tableï¼‰

**åæ¨¡å¼**ï¼šå°†æ‰€æœ‰æ•°æ®å¡è¿›ä¸€ä¸ªå·¨å¤§çš„è¡¨ã€‚

**é—®é¢˜ç¤ºä¾‹**ï¼š

```sql
-- åæ¨¡å¼ï¼šä¸‡èƒ½è¡¨
CREATE TABLE everything (
    id INTEGER PRIMARY KEY,
    type VARCHAR(50),  -- 'user', 'order', 'product', ...
    data JSONB,  -- æ‰€æœ‰æ•°æ®éƒ½å¡è¿™é‡Œ
    created_at TIMESTAMP
);
```

**é—®é¢˜**ï¼š

- æ— æ³•å»ºç«‹æœ‰æ•ˆç´¢å¼•
- æŸ¥è¯¢æ€§èƒ½å·®
- æ•°æ®å®Œæ•´æ€§æ— æ³•ä¿è¯
- éš¾ä»¥ç»´æŠ¤

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æ­£ç¡®ï¼šæŒ‰å®ä½“åˆ†ç¦»
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100)
);

CREATE TABLE orders (
    id INTEGER PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    total DECIMAL(10,2)
);

CREATE TABLE products (
    id INTEGER PRIMARY KEY,
    name VARCHAR(200),
    price DECIMAL(10,2)
);
```

### 2.2. å•è¡¨ç»§æ‰¿ï¼ˆSingle Table Inheritanceï¼‰

**åæ¨¡å¼**ï¼šä½¿ç”¨ä¸€ä¸ªè¡¨å­˜å‚¨å¤šç§ç±»å‹çš„å®ä½“ï¼Œç”¨typeåˆ—åŒºåˆ†ã€‚

**é—®é¢˜ç¤ºä¾‹**ï¼š

```sql
-- åæ¨¡å¼ï¼šå•è¡¨ç»§æ‰¿
CREATE TABLE vehicles (
    id INTEGER PRIMARY KEY,
    type VARCHAR(20),  -- 'car', 'truck', 'motorcycle'
    wheels INTEGER,
    cargo_capacity INTEGER,  -- åªæœ‰truckéœ€è¦
    engine_cc INTEGER,  -- åªæœ‰motorcycleéœ€è¦
    doors INTEGER  -- åªæœ‰caréœ€è¦
);
```

**é—®é¢˜**ï¼š

- å¤§é‡NULLå€¼
- æ— æ³•ä½¿ç”¨CHECKçº¦æŸ
- æŸ¥è¯¢éœ€è¦è¿‡æ»¤type

**è§£å†³æ–¹æ¡ˆå†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[ç»§æ‰¿è®¾è®¡] --> B{ç±»å‹å·®å¼‚}

    B -->|å·®å¼‚å°| C[å•è¡¨+typeåˆ—]
    B -->|å·®å¼‚å¤§| D{æŸ¥è¯¢æ¨¡å¼}

    D -->|å¤šç±»å‹è”åˆæŸ¥è¯¢| E[å•è¡¨+typeåˆ—+éƒ¨åˆ†åˆ—]
    D -->|ç±»å‹ç‹¬ç«‹æŸ¥è¯¢| F[å¤šè¡¨ç»§æ‰¿]

    F --> G[åŸºè¡¨+å­è¡¨]
    G --> H[ä½¿ç”¨å¤–é”®å…³è”]
```

**æ­£ç¡®æ–¹æ¡ˆ**ï¼š

```sql
-- æ–¹æ¡ˆ1ï¼šå¤šè¡¨ç»§æ‰¿ï¼ˆç±»å‹å·®å¼‚å¤§ï¼‰
CREATE TABLE vehicles (
    id INTEGER PRIMARY KEY,
    type VARCHAR(20) NOT NULL,
    wheels INTEGER NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE cars (
    vehicle_id INTEGER PRIMARY KEY REFERENCES vehicles(id),
    doors INTEGER NOT NULL,
    CHECK ((SELECT type FROM vehicles WHERE id = vehicle_id) = 'car')
);

CREATE TABLE trucks (
    vehicle_id INTEGER PRIMARY KEY REFERENCES vehicles(id),
    cargo_capacity INTEGER NOT NULL,
    CHECK ((SELECT type FROM vehicles WHERE id = vehicle_id) = 'truck')
);

-- æ–¹æ¡ˆ2ï¼šå…±äº«è¡¨+æ‰©å±•è¡¨ï¼ˆPostgreSQLï¼‰
CREATE TABLE vehicles (
    id INTEGER PRIMARY KEY,
    type VARCHAR(20) NOT NULL,
    common_attributes JSONB NOT NULL
);

CREATE TABLE vehicle_extensions (
    vehicle_id INTEGER PRIMARY KEY REFERENCES vehicles(id),
    type_specific_data JSONB NOT NULL
);
```

### 2.3. ä¼ªé”®æ»¥ç”¨ï¼ˆPseudokey Neat-Freakï¼‰

**åæ¨¡å¼**ï¼šä¸ºæ‰€æœ‰è¡¨éƒ½æ·»åŠ è‡ªå¢IDï¼Œå³ä½¿æœ‰è‡ªç„¶é”®ã€‚

**é—®é¢˜ç¤ºä¾‹**ï¼š

```sql
-- åæ¨¡å¼ï¼šä¸å¿…è¦çš„ä»£ç†é”®
CREATE TABLE countries (
    id SERIAL PRIMARY KEY,  -- ä¸å¿…è¦çš„
    country_code CHAR(2) UNIQUE NOT NULL,  -- è‡ªç„¶é”®
    name VARCHAR(100) NOT NULL
);

CREATE TABLE country_languages (
    id SERIAL PRIMARY KEY,  -- ä¸å¿…è¦çš„
    country_id INTEGER REFERENCES countries(id),
    language_code CHAR(2),
    UNIQUE(country_id, language_code)  -- è¿™æ‰æ˜¯çœŸæ­£çš„é”®
);
```

**è§£å†³æ–¹æ¡ˆå†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[é€‰æ‹©ä¸»é”®] --> B{æœ‰ç¨³å®šè‡ªç„¶é”®?}

    B -->|æ˜¯| C{è‡ªç„¶é”®ç®€å•?}
    B -->|å¦| D[ä½¿ç”¨ä»£ç†é”®]

    C -->|æ˜¯| E[ä½¿ç”¨è‡ªç„¶é”®]
    C -->|å¦| F{å¤åˆé”®?}

    F -->|æ˜¯| G[è€ƒè™‘ä»£ç†é”®]
    F -->|å¦| H[ä½¿ç”¨è‡ªç„¶é”®]

    E --> I[ä¸»é”®é€‰æ‹©å®Œæˆ]
    G --> I
    H --> I
    D --> I
```

**æ­£ç¡®æ–¹æ¡ˆ**ï¼š

```sql
-- æ­£ç¡®ï¼šä½¿ç”¨è‡ªç„¶é”®
CREATE TABLE countries (
    country_code CHAR(2) PRIMARY KEY,  -- ISOä»£ç æ˜¯ç¨³å®šçš„è‡ªç„¶é”®
    name VARCHAR(100) NOT NULL
);

-- æ­£ç¡®ï¼šå…³è”è¡¨ä½¿ç”¨å¤åˆä¸»é”®
CREATE TABLE country_languages (
    country_code CHAR(2) REFERENCES countries(country_code),
    language_code CHAR(2),
    PRIMARY KEY (country_code, language_code)
);

-- éœ€è¦ä»£ç†é”®çš„åœºæ™¯ï¼šè®¢å•è¡¨
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,  -- è®¢å•å·å¯èƒ½å˜åŒ–ï¼Œä½¿ç”¨ä»£ç†é”®
    order_number VARCHAR(50) UNIQUE NOT NULL,
    user_id INTEGER NOT NULL
);
```

### 2.4. åˆ—æ•°è¿‡å¤šï¼ˆWide Tableï¼‰

**åæ¨¡å¼**ï¼šè¡¨æœ‰æ•°ç™¾åˆ—ï¼ŒåŒ…å«æ‰€æœ‰å¯èƒ½çš„å±æ€§ã€‚

**é—®é¢˜ç¤ºä¾‹**ï¼š

```sql
-- åæ¨¡å¼ï¼šåˆ—æ•°è¿‡å¤š
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100),
    -- ... 200+ åˆ—
    attribute_1 VARCHAR(100),
    attribute_2 VARCHAR(100),
    -- ...
    attribute_200 VARCHAR(100)
);
```

**é—®é¢˜**ï¼š

- è¡Œå®½è¿‡å¤§ï¼Œå½±å“æ€§èƒ½
- å¤§é‡NULLå€¼
- éš¾ä»¥ç»´æŠ¤
- ç´¢å¼•æ•ˆç‡ä½

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æ–¹æ¡ˆ1ï¼šå‚ç›´åˆ†å‰²
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100),
    created_at TIMESTAMP
);

CREATE TABLE user_profiles (
    user_id INTEGER PRIMARY KEY REFERENCES users(id),
    bio TEXT,
    avatar_url VARCHAR(255),
    preferences JSONB
);

-- æ–¹æ¡ˆ2ï¼šä½¿ç”¨JSONBï¼ˆPostgreSQLï¼‰
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100),
    profile_data JSONB,  -- çµæ´»å±æ€§
    created_at TIMESTAMP
);

-- ä¸ºJSONBå­—æ®µåˆ›å»ºGINç´¢å¼•
CREATE INDEX idx_users_profile_data ON users USING GIN (profile_data);
```

---

## 3. æŸ¥è¯¢è®¾è®¡åæ¨¡å¼

### 3.1. N+1æŸ¥è¯¢é—®é¢˜

**åæ¨¡å¼**ï¼šåœ¨å¾ªç¯ä¸­æ‰§è¡ŒæŸ¥è¯¢ã€‚

**é—®é¢˜ç¤ºä¾‹**ï¼š

```sql
-- åæ¨¡å¼ï¼šN+1æŸ¥è¯¢
-- åº”ç”¨ä»£ç ä¼ªä»£ç 
users = SELECT * FROM users;
FOR EACH user IN users:
    orders = SELECT * FROM orders WHERE user_id = user.id;  -- Næ¬¡æŸ¥è¯¢
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æ–¹æ¡ˆ1ï¼šä½¿ç”¨JOIN
SELECT
    u.id,
    u.username,
    o.id AS order_id,
    o.total
FROM users u
LEFT JOIN orders o ON u.id = o.user_id;

-- æ–¹æ¡ˆ2ï¼šä½¿ç”¨INå­æŸ¥è¯¢ï¼ˆå°æ•°æ®é›†ï¼‰
SELECT * FROM orders
WHERE user_id IN (SELECT id FROM users WHERE status = 'active');

-- æ–¹æ¡ˆ3ï¼šä½¿ç”¨EXISTSï¼ˆå¤§æ•°æ®é›†ï¼‰
SELECT * FROM orders o
WHERE EXISTS (
    SELECT 1 FROM users u
    WHERE u.id = o.user_id AND u.status = 'active'
);
```

### 3.2. å…¨è¡¨æ‰«æ

**åæ¨¡å¼**ï¼šæŸ¥è¯¢æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ï¼Œå¯¼è‡´å…¨è¡¨æ‰«æã€‚

**é—®é¢˜ç¤ºä¾‹**ï¼š

```sql
-- åæ¨¡å¼ï¼šå…¨è¡¨æ‰«æ
SELECT * FROM orders WHERE YEAR(order_date) = 2024;  -- å‡½æ•°è°ƒç”¨é˜»æ­¢ç´¢å¼•ä½¿ç”¨
SELECT * FROM users WHERE email LIKE '%@gmail.com';  -- å‰å¯¼é€šé…ç¬¦
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æ­£ç¡®ï¼šé¿å…å‡½æ•°è°ƒç”¨
SELECT * FROM orders
WHERE order_date >= '2024-01-01'
  AND order_date < '2025-01-01';

-- æ­£ç¡®ï¼šä½¿ç”¨å…¨æ–‡æœç´¢ï¼ˆPostgreSQLï¼‰
CREATE INDEX idx_users_email_gin ON users USING GIN (email gin_trgm_ops);
SELECT * FROM users WHERE email LIKE '%@gmail.com';  -- ä½¿ç”¨GINç´¢å¼•

-- æˆ–è€…ä½¿ç”¨å…¨æ–‡æœç´¢
CREATE INDEX idx_users_email_fulltext ON users USING GIN (to_tsvector('english', email));
SELECT * FROM users
WHERE to_tsvector('english', email) @@ to_tsquery('gmail.com');
```

### 3.3. éšå¼ç±»å‹è½¬æ¢

**åæ¨¡å¼**ï¼šWHEREæ¡ä»¶ä¸­çš„ç±»å‹ä¸åŒ¹é…å¯¼è‡´éšå¼è½¬æ¢ã€‚

**é—®é¢˜ç¤ºä¾‹**ï¼š

```sql
-- åæ¨¡å¼ï¼šéšå¼è½¬æ¢
CREATE TABLE orders (
    id VARCHAR(50) PRIMARY KEY,  -- å­—ç¬¦ä¸²ç±»å‹
    user_id INTEGER
);

-- æŸ¥è¯¢æ—¶ä½¿ç”¨æ•°å­—
SELECT * FROM orders WHERE id = 123;  -- éšå¼è½¬æ¢ï¼Œæ— æ³•ä½¿ç”¨ç´¢å¼•
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æ­£ç¡®ï¼šç±»å‹åŒ¹é…
SELECT * FROM orders WHERE id = '123';  -- å­—ç¬¦ä¸²åŒ¹é…å­—ç¬¦ä¸²

-- æˆ–è€…ä¿®æ”¹è¡¨ç»“æ„
CREATE TABLE orders (
    id INTEGER PRIMARY KEY,  -- ä½¿ç”¨æ•°å­—ç±»å‹
    user_id INTEGER
);
```

---

## 4. æ€§èƒ½ä¼˜åŒ–åæ¨¡å¼

### 4.1. ç´¢å¼•æ»¥ç”¨

**åæ¨¡å¼**ï¼šä¸ºæ‰€æœ‰åˆ—åˆ›å»ºç´¢å¼•ã€‚

**é—®é¢˜**ï¼š

- å†™æ“ä½œå˜æ…¢
- å­˜å‚¨ç©ºé—´æµªè´¹
- ç´¢å¼•ç»´æŠ¤å¼€é”€

**ç´¢å¼•åˆ›å»ºå†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[åˆ›å»ºç´¢å¼•?] --> B{åˆ—ç±»å‹}

    B -->|ä¸»é”®| C[è‡ªåŠ¨åˆ›å»º]
    B -->|å¤–é”®| D[é€šå¸¸éœ€è¦]
    B -->|æŸ¥è¯¢åˆ—| E{æŸ¥è¯¢é¢‘ç‡}
    B -->|æ’åºåˆ—| F{æ’åºé¢‘ç‡}

    E -->|é«˜| G[åˆ›å»ºç´¢å¼•]
    E -->|ä½| H[ä¸åˆ›å»º]

    F -->|é«˜| I[åˆ›å»ºç´¢å¼•]
    F -->|ä½| J[ä¸åˆ›å»º]

    G --> K[åˆ†æé€‰æ‹©æ€§]
    I --> K

    K --> L{é€‰æ‹©æ€§é«˜?}
    L -->|æ˜¯| M[åˆ›å»ºç´¢å¼•]
    L -->|å¦| N[è€ƒè™‘ä¸åˆ›å»º]
```

**æ­£ç¡®å®è·µ**ï¼š

```sql
-- åˆ†æç´¢å¼•é€‰æ‹©æ€§
SELECT
    column_name,
    COUNT(DISTINCT column_name) * 100.0 / COUNT(*) AS selectivity
FROM table_name
GROUP BY column_name;

-- é€‰æ‹©æ€§ > 10% é€šå¸¸å€¼å¾—åˆ›å»ºç´¢å¼•
-- é€‰æ‹©æ€§ < 1% é€šå¸¸ä¸å€¼å¾—

-- ç›‘æ§ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE idx_scan = 0  -- æœªä½¿ç”¨çš„ç´¢å¼•
ORDER BY pg_relation_size(indexrelid) DESC;
```

### 4.2. è¿‡åº¦è§„èŒƒåŒ–

**åæ¨¡å¼**ï¼šä¸ºäº†è§„èŒƒåŒ–è€Œè§„èŒƒåŒ–ï¼Œå¯¼è‡´æŸ¥è¯¢éœ€è¦å¤§é‡JOINã€‚

**é—®é¢˜ç¤ºä¾‹**ï¼š

```sql
-- è¿‡åº¦è§„èŒƒåŒ–ï¼šæ¯ä¸ªå±æ€§ä¸€ä¸ªè¡¨
CREATE TABLE users (id INTEGER PRIMARY KEY);
CREATE TABLE user_names (user_id INTEGER, name VARCHAR(50));
CREATE TABLE user_emails (user_id INTEGER, email VARCHAR(100));
CREATE TABLE user_phones (user_id INTEGER, phone VARCHAR(20));

-- æŸ¥è¯¢éœ€è¦å¤šæ¬¡JOIN
SELECT u.id, n.name, e.email, p.phone
FROM users u
JOIN user_names n ON u.id = n.user_id
JOIN user_emails e ON u.id = e.user_id
JOIN user_phones p ON u.id = p.user_id;
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æ­£ç¡®ï¼šé€‚åº¦åèŒƒå¼åŒ–
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,
    phone VARCHAR(20)
);

-- æˆ–è€…ï¼šåˆç†çš„è§„èŒƒåŒ–
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL
);

-- åªæœ‰å¤šå€¼å±æ€§æ‰åˆ†ç¦»
CREATE TABLE user_phones (
    user_id INTEGER REFERENCES users(id),
    phone VARCHAR(20),
    PRIMARY KEY (user_id, phone)
);
```

---

## 5. æ•°æ®ä¸€è‡´æ€§åæ¨¡å¼

### 5.1. ç¼ºå°‘å¤–é”®çº¦æŸ

**åæ¨¡å¼**ï¼šä¸ä½¿ç”¨å¤–é”®çº¦æŸï¼Œä¾èµ–åº”ç”¨å±‚ä¿è¯ä¸€è‡´æ€§ã€‚

**é—®é¢˜**ï¼š

- æ•°æ®ä¸ä¸€è‡´
- å­¤ç«‹è®°å½•
- éš¾ä»¥ç»´æŠ¤

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æ­£ç¡®ï¼šä½¿ç”¨å¤–é”®çº¦æŸ
CREATE TABLE orders (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id)
        ON DELETE RESTRICT  -- é˜²æ­¢åˆ é™¤æœ‰è®¢å•çš„ç”¨æˆ·
        ON UPDATE CASCADE   -- ç”¨æˆ·IDæ›´æ–°æ—¶çº§è”
);

-- æ£€æŸ¥å­¤ç«‹è®°å½•
SELECT o.*
FROM orders o
LEFT JOIN users u ON o.user_id = u.id
WHERE u.id IS NULL;  -- æ‰¾åˆ°å­¤ç«‹è®°å½•
```

### 5.2. è§¦å‘å™¨æ»¥ç”¨

**åæ¨¡å¼**ï¼šä½¿ç”¨è§¦å‘å™¨å®ç°å¤æ‚ä¸šåŠ¡é€»è¾‘ã€‚

**é—®é¢˜**ï¼š

- éš¾ä»¥è°ƒè¯•
- æ€§èƒ½å½±å“
- éšè—çš„ä¸šåŠ¡é€»è¾‘

**è§£å†³æ–¹æ¡ˆå†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[ä½¿ç”¨è§¦å‘å™¨?] --> B{é€»è¾‘ç±»å‹}

    B -->|å®¡è®¡æ—¥å¿—| C[å¯ä»¥ä½¿ç”¨]
    B -->|æ•°æ®éªŒè¯| D[è€ƒè™‘CHECKçº¦æŸ]
    B -->|ä¸šåŠ¡é€»è¾‘| E[åº”ç”¨å±‚å®ç°]
    B -->|æ•°æ®åŒæ­¥| F[è€ƒè™‘äº‹ä»¶é©±åŠ¨]

    C --> G[å®ç°è§¦å‘å™¨]
    D --> H[ä½¿ç”¨çº¦æŸ]
    E --> I[åº”ç”¨ä»£ç ]
    F --> J[æ¶ˆæ¯é˜Ÿåˆ—]
```

**æ­£ç¡®å®è·µ**ï¼š

```sql
-- è§¦å‘å™¨ç”¨äºå®¡è®¡ï¼ˆåˆç†ä½¿ç”¨ï¼‰
CREATE TABLE audit_log (
    id SERIAL PRIMARY KEY,
    table_name VARCHAR(100),
    operation VARCHAR(20),
    old_data JSONB,
    new_data JSONB,
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE OR REPLACE FUNCTION audit_trigger()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO audit_log (table_name, operation, old_data, new_data)
    VALUES (
        TG_TABLE_NAME,
        TG_OP,
        row_to_json(OLD),
        row_to_json(NEW)
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER users_audit
AFTER INSERT OR UPDATE OR DELETE ON users
FOR EACH ROW EXECUTE FUNCTION audit_trigger();
```

---

## 6. å‚è€ƒèµ„æ–™

- [SQLåæ¨¡å¼](https://www.oreilly.com/library/view/sql-antipatterns/9781934356555/)
- [æ•°æ®åº“è®¾è®¡æœ€ä½³å®è·µ](./07.01-Schemaè®¾è®¡æ–¹æ³•è®º.md)
- [PostgreSQLæœ€ä½³å®è·µ](../PostgreSQL/INDEX.md)

---

**æœ€åæ›´æ–°**ï¼š2025-01-15
**ç»´æŠ¤è€…**ï¼šData-Science Team
**çŠ¶æ€**ï¼šå®æ–½ä¸­
