# åˆ—å¼æ•°æ®åº“è®¾è®¡æ¨¡å¼ï¼šOLAPåˆ†æå‹æ•°æ®åº“çš„é«˜æ•ˆè®¾è®¡

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-12-01
> **ç‰ˆæœ¬**ï¼šv2.0 (å¢å¼ºç‰ˆ)
> **çŠ¶æ€**ï¼šå·²å®Œæˆ âœ…

---

## ğŸ“‹ ç›®å½•

- [åˆ—å¼æ•°æ®åº“è®¾è®¡æ¨¡å¼ï¼šOLAPåˆ†æå‹æ•°æ®åº“çš„é«˜æ•ˆè®¾è®¡](#åˆ—å¼æ•°æ®åº“è®¾è®¡æ¨¡å¼olapåˆ†æå‹æ•°æ®åº“çš„é«˜æ•ˆè®¾è®¡)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1. åˆ—å¼æ•°æ®åº“åº”ç”¨åœºæ™¯](#11-åˆ—å¼æ•°æ®åº“åº”ç”¨åœºæ™¯)
    - [1.2. åˆ—å¼æ•°æ®åº“é€‰æ‹©å†³ç­–æ ‘](#12-åˆ—å¼æ•°æ®åº“é€‰æ‹©å†³ç­–æ ‘)
  - [2. åˆ—å¼æ•°æ®åº“ç‰¹æ€§](#2-åˆ—å¼æ•°æ®åº“ç‰¹æ€§)
    - [2.1. åˆ—å¼å­˜å‚¨ç‰¹å¾](#21-åˆ—å¼å­˜å‚¨ç‰¹å¾)
    - [2.2. åˆ—å¼vsè¡Œå¼å¯¹æ¯”](#22-åˆ—å¼vsè¡Œå¼å¯¹æ¯”)
  - [3. ClickHouse Schemaè®¾è®¡](#3-clickhouse-schemaè®¾è®¡)
    - [3.1. ClickHouseè¡¨å¼•æ“é€‰æ‹©](#31-clickhouseè¡¨å¼•æ“é€‰æ‹©)
    - [3.2. MergeTreeå¼•æ“è®¾è®¡](#32-mergetreeå¼•æ“è®¾è®¡)
    - [3.3. ReplacingMergeTreeå¼•æ“è®¾è®¡](#33-replacingmergetreeå¼•æ“è®¾è®¡)
    - [3.4. ç‰©åŒ–è§†å›¾è®¾è®¡](#34-ç‰©åŒ–è§†å›¾è®¾è®¡)
  - [4. PostgreSQLåˆ—å¼å­˜å‚¨è®¾è®¡](#4-postgresqlåˆ—å¼å­˜å‚¨è®¾è®¡)
    - [4.1. cstore\_fdwæ‰©å±•è®¾è®¡](#41-cstore_fdwæ‰©å±•è®¾è®¡)
    - [4.2. åˆ—å¼åˆ†åŒºè®¾è®¡](#42-åˆ—å¼åˆ†åŒºè®¾è®¡)
  - [5. åˆ—å¼æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–](#5-åˆ—å¼æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–)
    - [5.1. ClickHouseæŸ¥è¯¢ä¼˜åŒ–](#51-clickhouseæŸ¥è¯¢ä¼˜åŒ–)
    - [5.2. èšåˆå‡½æ•°ä¼˜åŒ–](#52-èšåˆå‡½æ•°ä¼˜åŒ–)
  - [6. åˆ—å¼æ•°æ®åº“åˆ†åŒºä¸æ’åºé”®è®¾è®¡](#6-åˆ—å¼æ•°æ®åº“åˆ†åŒºä¸æ’åºé”®è®¾è®¡)
    - [6.1. åˆ†åŒºé”®è®¾è®¡](#61-åˆ†åŒºé”®è®¾è®¡)
    - [6.2. æ’åºé”®è®¾è®¡](#62-æ’åºé”®è®¾è®¡)
  - [7. å®é™…åº”ç”¨æ¡ˆä¾‹](#7-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [7.1. æ•°æ®ä»“åº“è®¾è®¡](#71-æ•°æ®ä»“åº“è®¾è®¡)
    - [7.2. å®æ—¶æ—¥å¿—åˆ†æç³»ç»Ÿè®¾è®¡](#72-å®æ—¶æ—¥å¿—åˆ†æç³»ç»Ÿè®¾è®¡)
  - [8. 2024-2025æœ€æ–°è¶‹åŠ¿](#8-2024-2025æœ€æ–°è¶‹åŠ¿)
    - [8.1. åˆ—å¼æ•°æ®åº“æŠ€æœ¯æ¼”è¿›](#81-åˆ—å¼æ•°æ®åº“æŠ€æœ¯æ¼”è¿›)
    - [8.2. åˆ—å¼æ•°æ®åº“é€‰å‹çŸ©é˜µ](#82-åˆ—å¼æ•°æ®åº“é€‰å‹çŸ©é˜µ)
    - [8.3. ClickHouseå‘é‡æœç´¢](#83-clickhouseå‘é‡æœç´¢)
  - [9. å‚è€ƒèµ„æ–™](#9-å‚è€ƒèµ„æ–™)
    - [9.1. æƒå¨æ–‡çŒ®](#91-æƒå¨æ–‡çŒ®)
    - [9.2. åœ¨çº¿èµ„æº](#92-åœ¨çº¿èµ„æº)
    - [9.3. ç›¸å…³æ–‡æ¡£](#93-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

åˆ—å¼æ•°æ®åº“ä¸“é—¨ç”¨äºOLAPï¼ˆåœ¨çº¿åˆ†æå¤„ç†ï¼‰ï¼Œé€‚åˆå¤§è§„æ¨¡æ•°æ®åˆ†æã€æ•°æ®ä»“åº“ç­‰åœºæ™¯ã€‚

### 1.1. åˆ—å¼æ•°æ®åº“åº”ç”¨åœºæ™¯

```mermaid
mindmap
  root((åˆ—å¼æ•°æ®åº“åº”ç”¨))
    æ•°æ®ä»“åº“
      ä¼ä¸šæ•°æ®ä»“åº“
      æ•°æ®é›†å¸‚
      æ•°æ®æ¹–åˆ†æ
    å®æ—¶åˆ†æ
      å®æ—¶æŠ¥è¡¨
      å®æ—¶ç›‘æ§
      å®æ—¶æ¨è
    æ—¥å¿—åˆ†æ
      åº”ç”¨æ—¥å¿—åˆ†æ
      è®¿é—®æ—¥å¿—åˆ†æ
      å®‰å…¨æ—¥å¿—åˆ†æ
    æ—¶åºåˆ†æ
      ç›‘æ§æŒ‡æ ‡åˆ†æ
      IoTæ•°æ®åˆ†æ
      é‡‘èæ•°æ®åˆ†æ
```

### 1.2. åˆ—å¼æ•°æ®åº“é€‰æ‹©å†³ç­–æ ‘

```mermaid
flowchart TD
    A[é€‰æ‹©åˆ—å¼æ•°æ®åº“] --> B{æ•°æ®è§„æ¨¡}

    B -->|å°è§„æ¨¡| C[PostgreSQLåˆ—å¼æ‰©å±•]
    B -->|å¤§è§„æ¨¡| D{æŸ¥è¯¢æ¨¡å¼}

    C --> E[è®¾è®¡å®Œæˆ]

    D -->|å®æ—¶åˆ†æ| F[ClickHouse]
    D -->|æ‰¹å¤„ç†åˆ†æ| G[Greenplum]

    F --> E
    G --> E
```

---

## 2. åˆ—å¼æ•°æ®åº“ç‰¹æ€§

### 2.1. åˆ—å¼å­˜å‚¨ç‰¹å¾

**åˆ—å¼å­˜å‚¨å®šä¹‰**ï¼š

```text
åˆ—å¼å­˜å‚¨ = {
    æ•°æ®æŒ‰åˆ—å­˜å‚¨è€ŒéæŒ‰è¡Œå­˜å‚¨,
    ç›¸åŒç±»å‹æ•°æ®è¿ç»­å­˜å‚¨,
    é«˜å‹ç¼©ç‡,
    åˆ—å¼æ‰«æä¼˜åŒ–
}

ç‰¹å¾ï¼š
1. åˆ—å¼å­˜å‚¨ï¼šæ•°æ®æŒ‰åˆ—å­˜å‚¨ï¼Œç›¸åŒç±»å‹æ•°æ®è¿ç»­
2. é«˜å‹ç¼©ç‡ï¼šç›¸åŒç±»å‹æ•°æ®å‹ç¼©ç‡é«˜
3. åˆ—å¼æ‰«æï¼šåªæ‰«æéœ€è¦çš„åˆ—ï¼Œå‡å°‘I/O
4. å‘é‡åŒ–æ‰§è¡Œï¼šæ”¯æŒSIMDå‘é‡åŒ–è®¡ç®—
5. é€‚åˆèšåˆï¼šé€‚åˆSUMã€AVGã€COUNTç­‰èšåˆæ“ä½œ
```

### 2.2. åˆ—å¼vsè¡Œå¼å¯¹æ¯”

**å­˜å‚¨æ¨¡å¼å¯¹æ¯”çŸ©é˜µ**ï¼š

| ç‰¹æ€§ | è¡Œå¼å­˜å‚¨ | åˆ—å¼å­˜å‚¨ |
|------|---------|---------|
| **å­˜å‚¨æ–¹å¼** | æŒ‰è¡Œå­˜å‚¨ | æŒ‰åˆ—å­˜å‚¨ |
| **å‹ç¼©ç‡** | ä½ | é«˜ï¼ˆ5-10å€ï¼‰ |
| **æŸ¥è¯¢æ€§èƒ½** | é€‚åˆç‚¹æŸ¥è¯¢ | é€‚åˆåˆ†ææŸ¥è¯¢ |
| **å†™å…¥æ€§èƒ½** | é«˜ | ä¸­ç­‰ï¼ˆæ‰¹é‡å†™å…¥ï¼‰ |
| **æ›´æ–°æ€§èƒ½** | é«˜ | ä½ï¼ˆä¸é€‚åˆé¢‘ç¹æ›´æ–°ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | OLTP | OLAP |

---

## 3. ClickHouse Schemaè®¾è®¡

### 3.1. ClickHouseè¡¨å¼•æ“é€‰æ‹©

**è¡¨å¼•æ“é€‰æ‹©å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[é€‰æ‹©è¡¨å¼•æ“] --> B{æ•°æ®ç‰¹ç‚¹}

    B -->|å°è¡¨| C[MergeTree]
    B -->|å¤§è¡¨| D{æ›´æ–°éœ€æ±‚}

    C --> E[è®¾è®¡å®Œæˆ]

    D -->|æ— æ›´æ–°| F[MergeTree]
    D -->|æœ‰æ›´æ–°| G[ReplacingMergeTree]

    F --> E
    G --> E
```

### 3.2. MergeTreeå¼•æ“è®¾è®¡

**åŸºç¡€MergeTreeè¡¨è®¾è®¡**ï¼š

```sql
-- ClickHouseè¡¨è®¾è®¡
CREATE TABLE analytics.events
(
    event_id UInt64,
    user_id UInt64,
    event_type String,
    event_time DateTime,
    properties String,  -- JSONå­—ç¬¦ä¸²
    session_id String
)
ENGINE = MergeTree()
PARTITION BY toYYYYMM(event_time)  -- æŒ‰æœˆåˆ†åŒº
ORDER BY (user_id, event_time)     -- æ’åºé”®
SETTINGS index_granularity = 8192;

-- åˆ›å»ºç´¢å¼•
ALTER TABLE analytics.events ADD INDEX idx_event_type event_type TYPE bloom_filter GRANULARITY 4;
ALTER TABLE analytics.events ADD INDEX idx_session_id session_id TYPE bloom_filter GRANULARITY 4;
```

### 3.3. ReplacingMergeTreeå¼•æ“è®¾è®¡

**å»é‡è¡¨è®¾è®¡**ï¼š

```sql
-- ReplacingMergeTreeï¼šè‡ªåŠ¨å»é‡
CREATE TABLE analytics.user_sessions
(
    user_id UInt64,
    session_id String,
    start_time DateTime,
    end_time DateTime,
    page_views UInt32,
    duration UInt32
)
ENGINE = ReplacingMergeTree(end_time)  -- æŒ‰end_timeå»é‡
PARTITION BY toYYYYMM(start_time)
ORDER BY (user_id, session_id);

-- æŸ¥è¯¢æ—¶å»é‡
SELECT *
FROM analytics.user_sessions
FINAL;  -- FINALå…³é”®å­—å¼ºåˆ¶å»é‡
```

### 3.4. ç‰©åŒ–è§†å›¾è®¾è®¡

**ç‰©åŒ–è§†å›¾èšåˆ**ï¼š

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾ï¼ˆå®æ—¶èšåˆï¼‰
CREATE MATERIALIZED VIEW analytics.event_stats_mv
ENGINE = SummingMergeTree()
PARTITION BY toYYYYMM(event_time)
ORDER BY (event_type, toStartOfHour(event_time))
AS SELECT
    event_type,
    toStartOfHour(event_time) AS hour,
    count() AS event_count,
    uniq(user_id) AS unique_users
FROM analytics.events
GROUP BY event_type, hour;

-- æŸ¥è¯¢ç‰©åŒ–è§†å›¾
SELECT
    event_type,
    hour,
    sum(event_count) AS total_events,
    sum(unique_users) AS total_users
FROM analytics.event_stats_mv
GROUP BY event_type, hour
ORDER BY hour DESC;
```

---

## 4. PostgreSQLåˆ—å¼å­˜å‚¨è®¾è®¡

### 4.1. cstore_fdwæ‰©å±•è®¾è®¡

**cstore_fdwåˆ—å¼å­˜å‚¨**ï¼š

```sql
-- å®‰è£…cstore_fdwæ‰©å±•
CREATE EXTENSION IF NOT EXISTS cstore_fdw;

-- åˆ›å»ºå¤–éƒ¨æœåŠ¡å™¨
CREATE SERVER cstore_server
FOREIGN DATA WRAPPER cstore_fdw;

-- åˆ›å»ºåˆ—å¼è¡¨
CREATE FOREIGN TABLE analytics.events_cstore
(
    event_id BIGINT,
    user_id BIGINT,
    event_type VARCHAR(50),
    event_time TIMESTAMPTZ,
    properties JSONB,
    session_id VARCHAR(100)
)
SERVER cstore_server
OPTIONS (
    compression 'pglz',
    stripe_row_count '150000'
);

-- æ’å…¥æ•°æ®ï¼ˆæ‰¹é‡æ’å…¥æ€§èƒ½å¥½ï¼‰
INSERT INTO analytics.events_cstore
SELECT * FROM analytics.events;

-- æŸ¥è¯¢ï¼ˆåˆ—å¼æ‰«æï¼‰
SELECT event_type, COUNT(*)
FROM analytics.events_cstore
WHERE event_time >= '2024-01-01'
GROUP BY event_type;
```

### 4.2. åˆ—å¼åˆ†åŒºè®¾è®¡

**åˆ—å¼åˆ†åŒºè¡¨è®¾è®¡**ï¼š

```sql
-- åˆ›å»ºåˆ†åŒºè¡¨ï¼ˆæŒ‰æ—¶é—´åˆ†åŒºï¼‰
CREATE TABLE analytics.events_partitioned
(
    event_id BIGINT,
    user_id BIGINT,
    event_type VARCHAR(50),
    event_time TIMESTAMPTZ,
    properties JSONB,
    session_id VARCHAR(100)
) PARTITION BY RANGE (event_time);

-- åˆ›å»ºåˆ†åŒºï¼ˆæŒ‰æœˆï¼‰
CREATE TABLE analytics.events_2024_01 PARTITION OF analytics.events_partitioned
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE analytics.events_2024_02 PARTITION OF analytics.events_partitioned
FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');

-- ä¸ºæ¯ä¸ªåˆ†åŒºåˆ›å»ºåˆ—å¼å­˜å‚¨
-- æ³¨æ„ï¼šPostgreSQLä¸æ”¯æŒç›´æ¥åœ¨åˆ†åŒºä¸Šä½¿ç”¨FDWï¼Œéœ€è¦åº”ç”¨å±‚å¤„ç†
```

---

## 5. åˆ—å¼æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

### 5.1. ClickHouseæŸ¥è¯¢ä¼˜åŒ–

**æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§**ï¼š

```sql
-- âœ… å¥½çš„æŸ¥è¯¢ï¼šä½¿ç”¨æ’åºé”®è¿‡æ»¤
SELECT user_id, COUNT(*) AS event_count
FROM analytics.events
WHERE user_id = 12345
  AND event_time >= '2024-01-01'
GROUP BY user_id;

-- âœ… ä½¿ç”¨PREWHEREä¼˜åŒ–ï¼ˆå…ˆè¿‡æ»¤ï¼Œå†è¯»å–åˆ—ï¼‰
SELECT event_type, COUNT(*)
FROM analytics.events
PREWHERE event_time >= '2024-01-01'  -- PREWHEREå…ˆè¿‡æ»¤
WHERE event_type = 'click'
GROUP BY event_type;

-- âœ… ä½¿ç”¨SAMPLEé‡‡æ ·ï¼ˆå¤§æ•°æ®é›†ï¼‰
SELECT event_type, COUNT(*) AS event_count
FROM analytics.events
SAMPLE 0.1  -- é‡‡æ ·10%
WHERE event_time >= '2024-01-01'
GROUP BY event_type;

-- âœ… ä½¿ç”¨LIMIT BYï¼ˆæ¯ç»„Top-Kï¼‰
SELECT user_id, event_type, COUNT(*) AS event_count
FROM analytics.events
WHERE event_time >= '2024-01-01'
GROUP BY user_id, event_type
ORDER BY event_count DESC
LIMIT 10 BY user_id;  -- æ¯ä¸ªç”¨æˆ·Top 10äº‹ä»¶ç±»å‹
```

### 5.2. èšåˆå‡½æ•°ä¼˜åŒ–

**èšåˆå‡½æ•°ä½¿ç”¨**ï¼š

```sql
-- âœ… ä½¿ç”¨uniqExactç²¾ç¡®å»é‡ï¼ˆå°æ•°æ®é›†ï¼‰
SELECT uniqExact(user_id) AS unique_users
FROM analytics.events
WHERE event_time >= '2024-01-01';

-- âœ… ä½¿ç”¨uniqè¿‘ä¼¼å»é‡ï¼ˆå¤§æ•°æ®é›†ï¼Œæ€§èƒ½æ›´å¥½ï¼‰
SELECT uniq(user_id) AS unique_users_approx
FROM analytics.events
WHERE event_time >= '2024-01-01';

-- âœ… ä½¿ç”¨quantileåˆ†ä½æ•°
SELECT
    quantile(0.5)(duration) AS median_duration,
    quantile(0.95)(duration) AS p95_duration,
    quantile(0.99)(duration) AS p99_duration
FROM analytics.user_sessions
WHERE start_time >= '2024-01-01';

-- âœ… ä½¿ç”¨windowå‡½æ•°
SELECT
    user_id,
    event_time,
    event_type,
    count() OVER (PARTITION BY user_id ORDER BY event_time ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS events_7d
FROM analytics.events
WHERE event_time >= '2024-01-01'
ORDER BY user_id, event_time;
```

---

## 6. åˆ—å¼æ•°æ®åº“åˆ†åŒºä¸æ’åºé”®è®¾è®¡

### 6.1. åˆ†åŒºé”®è®¾è®¡

**åˆ†åŒºé”®é€‰æ‹©å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[é€‰æ‹©åˆ†åŒºé”®] --> B{æ•°æ®ç‰¹ç‚¹}

    B -->|æ—¶é—´åºåˆ—| C[æŒ‰æ—¶é—´åˆ†åŒº]
    B -->|ç”¨æˆ·æ•°æ®| D{ç”¨æˆ·åˆ†å¸ƒ}

    C --> E[æŒ‰æœˆ/å‘¨åˆ†åŒº]
    D -->|å‡åŒ€åˆ†å¸ƒ| F[æŒ‰ç”¨æˆ·IDå“ˆå¸Œ]
    D -->|ä¸å‡åŒ€åˆ†å¸ƒ| G[æŒ‰ç”¨æˆ·IDèŒƒå›´]

    E --> H[è®¾è®¡å®Œæˆ]
    F --> H
    G --> H
```

**åˆ†åŒºé”®è®¾è®¡ç¤ºä¾‹**ï¼š

```sql
-- âœ… å¥½çš„åˆ†åŒºï¼šæŒ‰æ—¶é—´åˆ†åŒºï¼ˆæ—¶é—´åºåˆ—æ•°æ®ï¼‰
CREATE TABLE analytics.events
(
    event_id UInt64,
    user_id UInt64,
    event_time DateTime,
    ...
)
ENGINE = MergeTree()
PARTITION BY toYYYYMM(event_time)  -- æŒ‰æœˆåˆ†åŒº
ORDER BY (user_id, event_time);

-- âœ… å¥½çš„åˆ†åŒºï¼šæŒ‰ç”¨æˆ·IDèŒƒå›´åˆ†åŒºï¼ˆç”¨æˆ·æ•°æ®ï¼‰
CREATE TABLE analytics.user_events
(
    user_id UInt64,
    event_time DateTime,
    ...
)
ENGINE = MergeTree()
PARTITION BY intDiv(user_id, 1000000)  -- æ¯100ä¸‡ç”¨æˆ·ä¸€ä¸ªåˆ†åŒº
ORDER BY (user_id, event_time);

-- âŒ é¿å…ï¼šåˆ†åŒºè¿‡ç»†ï¼ˆåˆ†åŒºæ•°è¿‡å¤šï¼‰
-- PARTITION BY toYYYYMMDD(event_time)  -- æ¯å¤©ä¸€ä¸ªåˆ†åŒºï¼Œåˆ†åŒºæ•°è¿‡å¤š

-- âŒ é¿å…ï¼šåˆ†åŒºé”®ä¸åœ¨WHEREæ¡ä»¶ä¸­
-- PARTITION BY user_id  -- ä½†æŸ¥è¯¢æ—¶å¾ˆå°‘æŒ‰user_idè¿‡æ»¤
```

### 6.2. æ’åºé”®è®¾è®¡

**æ’åºé”®è®¾è®¡åŸåˆ™**ï¼š

```sql
-- âœ… å¥½çš„æ’åºé”®ï¼šé«˜åŸºæ•°åˆ—åœ¨å‰ï¼Œä½åŸºæ•°åˆ—åœ¨å
CREATE TABLE analytics.events
(
    event_id UInt64,
    user_id UInt64,        -- é«˜åŸºæ•°
    event_time DateTime,   -- é«˜åŸºæ•°
    event_type String,     -- ä½åŸºæ•°
    ...
)
ENGINE = MergeTree()
PARTITION BY toYYYYMM(event_time)
ORDER BY (user_id, event_time, event_type);  -- é«˜åŸºæ•°åœ¨å‰

-- âœ… æ’åºé”®åŒ…å«å¸¸ç”¨è¿‡æ»¤æ¡ä»¶
-- å¦‚æœç»å¸¸æŒ‰(user_id, event_time)è¿‡æ»¤ï¼Œåˆ™ORDER BY (user_id, event_time)

-- âœ… ä½¿ç”¨è·³æ•°ç´¢å¼•ä¼˜åŒ–ä½åŸºæ•°åˆ—æŸ¥è¯¢
ALTER TABLE analytics.events ADD INDEX idx_event_type event_type TYPE set(100) GRANULARITY 4;
ALTER TABLE analytics.events ADD INDEX idx_session_id session_id TYPE bloom_filter(0.01) GRANULARITY 4;
```

---

## 7. å®é™…åº”ç”¨æ¡ˆä¾‹

### 7.1. æ•°æ®ä»“åº“è®¾è®¡

**å®Œæ•´æ•°æ®ä»“åº“Schemaè®¾è®¡**ï¼š

```sql
-- ClickHouseæ•°æ®ä»“åº“è®¾è®¡

-- äº‹å®è¡¨ï¼šè®¢å•äº‹å®è¡¨
CREATE TABLE dw.fact_orders
(
    order_id UInt64,
    user_id UInt64,
    product_id UInt64,
    order_date Date,
    order_time DateTime,
    quantity UInt32,
    amount Decimal(10,2),
    discount Decimal(10,2),
    final_amount Decimal(10,2),
    payment_method String,
    shipping_method String
)
ENGINE = MergeTree()
PARTITION BY toYYYYMM(order_date)
ORDER BY (user_id, order_date, product_id)
SETTINGS index_granularity = 8192;

-- ç»´åº¦è¡¨ï¼šç”¨æˆ·ç»´åº¦è¡¨
CREATE TABLE dw.dim_users
(
    user_id UInt64,
    username String,
    email String,
    age UInt8,
    gender String,
    city String,
    country String,
    registration_date Date,
    is_vip UInt8
)
ENGINE = ReplacingMergeTree(registration_date)
ORDER BY user_id;

-- ç»´åº¦è¡¨ï¼šäº§å“ç»´åº¦è¡¨
CREATE TABLE dw.dim_products
(
    product_id UInt64,
    product_name String,
    category String,
    brand String,
    price Decimal(10,2),
    created_date Date
)
ENGINE = ReplacingMergeTree(created_date)
ORDER BY product_id;

-- ç‰©åŒ–è§†å›¾ï¼šæ¯æ—¥è®¢å•ç»Ÿè®¡
CREATE MATERIALIZED VIEW dw.mv_daily_order_stats
ENGINE = SummingMergeTree()
PARTITION BY toYYYYMM(order_date)
ORDER BY (order_date, product_id)
AS SELECT
    order_date,
    product_id,
    count() AS order_count,
    sum(quantity) AS total_quantity,
    sum(final_amount) AS total_amount,
    uniq(user_id) AS unique_users
FROM dw.fact_orders
GROUP BY order_date, product_id;

-- æŸ¥è¯¢æ¯æ—¥ç»Ÿè®¡
SELECT
    order_date,
    sum(order_count) AS total_orders,
    sum(total_quantity) AS total_items,
    sum(total_amount) AS total_revenue,
    sum(unique_users) AS total_customers
FROM dw.mv_daily_order_stats
WHERE order_date >= '2024-01-01'
GROUP BY order_date
ORDER BY order_date DESC;
```

### 7.2. å®æ—¶æ—¥å¿—åˆ†æç³»ç»Ÿè®¾è®¡

**æ—¥å¿—åˆ†æç³»ç»ŸSchemaè®¾è®¡**ï¼š

```sql
-- ClickHouseæ—¥å¿—åˆ†æç³»ç»Ÿ

-- åŸå§‹æ—¥å¿—è¡¨
CREATE TABLE logs.raw_logs
(
    log_id UInt64,
    timestamp DateTime,
    level String,
    service String,
    host String,
    message String,
    trace_id String,
    user_id UInt64,
    request_id String,
    duration_ms UInt32,
    status_code UInt16,
    metadata String  -- JSONå­—ç¬¦ä¸²
)
ENGINE = MergeTree()
PARTITION BY toYYYYMMDD(timestamp)
ORDER BY (service, timestamp, level)
TTL timestamp + INTERVAL 30 DAY  -- 30å¤©åè‡ªåŠ¨åˆ é™¤
SETTINGS index_granularity = 8192;

-- åˆ›å»ºç´¢å¼•
ALTER TABLE logs.raw_logs ADD INDEX idx_trace_id trace_id TYPE bloom_filter GRANULARITY 4;
ALTER TABLE logs.raw_logs ADD INDEX idx_user_id user_id TYPE bloom_filter GRANULARITY 4;

-- é”™è¯¯æ—¥å¿—ç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW logs.mv_error_logs
ENGINE = MergeTree()
PARTITION BY toYYYYMMDD(timestamp)
ORDER BY (service, timestamp)
AS SELECT
    timestamp,
    service,
    host,
    message,
    trace_id,
    user_id,
    status_code,
    metadata
FROM logs.raw_logs
WHERE level = 'ERROR';

-- æœåŠ¡ç»Ÿè®¡ç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW logs.mv_service_stats
ENGINE = SummingMergeTree()
PARTITION BY toYYYYMMDD(timestamp)
ORDER BY (service, toStartOfHour(timestamp))
AS SELECT
    service,
    toStartOfHour(timestamp) AS hour,
    count() AS log_count,
    countIf(level = 'ERROR') AS error_count,
    countIf(level = 'WARN') AS warn_count,
    avg(duration_ms) AS avg_duration,
    quantile(0.95)(duration_ms) AS p95_duration,
    uniq(user_id) AS unique_users
FROM logs.raw_logs
GROUP BY service, hour;

-- æŸ¥è¯¢æœåŠ¡ç»Ÿè®¡
SELECT
    service,
    hour,
    sum(log_count) AS total_logs,
    sum(error_count) AS total_errors,
    sum(warn_count) AS total_warnings,
    avg(avg_duration) AS avg_duration,
    max(p95_duration) AS max_p95_duration
FROM logs.mv_service_stats
WHERE hour >= now() - INTERVAL 24 HOUR
GROUP BY service, hour
ORDER BY service, hour DESC;
```

---

## 8. 2024-2025æœ€æ–°è¶‹åŠ¿

### 8.1. åˆ—å¼æ•°æ®åº“æŠ€æœ¯æ¼”è¿›

```mermaid
timeline
    title åˆ—å¼æ•°æ®åº“æ¼”è¿›
    2009 : Vertica/Greenplum
         : MPPåˆ—å¼
    2016 : ClickHouseå¼€æº
         : å®æ—¶OLAP
    2019 : Apache Arrow
         : åˆ—å¼å†…å­˜æ ¼å¼
    2022 : DuckDBå…´èµ·
         : åµŒå…¥å¼OLAP
    2024 : å‘é‡åŒ–å¼•æ“
         : SIMDä¼˜åŒ–
    2025 : AI+OLAPèåˆ
         : å®æ—¶åˆ†æ
```

### 8.2. åˆ—å¼æ•°æ®åº“é€‰å‹çŸ©é˜µ

| æ•°æ®åº“ | éƒ¨ç½²æ¨¡å¼ | å®æ—¶æ€§ | å‘é‡æ”¯æŒ | é€‚ç”¨åœºæ™¯ |
|-------|---------|--------|---------|---------|
| **ClickHouse** | åˆ†å¸ƒå¼ | æé«˜ | âœ… | å®æ—¶åˆ†æ |
| **DuckDB** | åµŒå…¥å¼ | é«˜ | âœ… | æœ¬åœ°åˆ†æ |
| **Apache Druid** | åˆ†å¸ƒå¼ | é«˜ | âŒ | æ—¶åºåˆ†æ |
| **StarRocks** | åˆ†å¸ƒå¼ | æé«˜ | âŒ | MPPåˆ†æ |
| **Apache Doris** | åˆ†å¸ƒå¼ | é«˜ | âŒ | å®æ—¶æ•°ä»“ |

### 8.3. ClickHouseå‘é‡æœç´¢

```sql
-- ClickHouseå‘é‡æ‰©å±•ï¼ˆ2024+ï¼‰
CREATE TABLE vectors.embeddings (
    id UInt64,
    content String,
    embedding Array(Float32),  -- å‘é‡å­—æ®µ
    created_at DateTime DEFAULT now()
) ENGINE = MergeTree()
ORDER BY id;

-- å‘é‡ç›¸ä¼¼åº¦æœç´¢
SELECT
    id,
    content,
    L2Distance(embedding, [0.1, 0.2, ...]) AS distance
FROM vectors.embeddings
ORDER BY distance ASC
LIMIT 10;

-- ä½¿ç”¨ANNç´¢å¼•åŠ é€Ÿ
ALTER TABLE vectors.embeddings
ADD INDEX embedding_idx embedding TYPE annoy(100);
```

---

## 9. å‚è€ƒèµ„æ–™

### 9.1. æƒå¨æ–‡çŒ®

**åˆ—å¼å­˜å‚¨ç†è®º**ï¼š

- Abadi, D. et al. (2006). "Integrating Compression and Execution in Column-Oriented Database Systems"
- Stonebraker, M. et al. (2005). "C-Store: A Column-oriented DBMS"

### 9.2. åœ¨çº¿èµ„æº

| èµ„æº | URL | æè¿° |
|------|-----|------|
| **ClickHouseæ–‡æ¡£** | <https://clickhouse.com/docs/> | å®˜æ–¹æ–‡æ¡£ |
| **DuckDBæ–‡æ¡£** | <https://duckdb.org/docs/> | åµŒå…¥å¼OLAP |
| **Apache Arrow** | <https://arrow.apache.org/> | åˆ—å¼æ ¼å¼ |

### 9.3. ç›¸å…³æ–‡æ¡£

- [07.18-æ—¶åºæ•°æ®åº“è®¾è®¡æ¨¡å¼](./07.18-æ—¶åºæ•°æ®åº“è®¾è®¡æ¨¡å¼.md)
- [07.08-æ•°æ®åº“æ€§èƒ½è°ƒä¼˜å®æˆ˜](./07.08-æ•°æ®åº“æ€§èƒ½è°ƒä¼˜å®æˆ˜.md)

---

**æœ€åæ›´æ–°**ï¼š2025-12-01
**ç»´æŠ¤è€…**ï¼šData-Science Team
**çŠ¶æ€**ï¼šå·²å®Œæˆ âœ…
**ç‰ˆæœ¬**ï¼šv2.0 (å¢å¼ºç‰ˆ)
