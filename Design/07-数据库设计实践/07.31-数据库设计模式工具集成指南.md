# æ•°æ®åº“è®¾è®¡æ¨¡å¼å·¥å…·é›†æˆæŒ‡å—ï¼šå·¥å…·é“¾ä¸è‡ªåŠ¨åŒ–

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-01-15
> **ç‰ˆæœ¬**ï¼šv1.0
> **çŠ¶æ€**ï¼šå®æ–½ä¸­

---

## ğŸ“‹ ç›®å½•

- [æ•°æ®åº“è®¾è®¡æ¨¡å¼å·¥å…·é›†æˆæŒ‡å—ï¼šå·¥å…·é“¾ä¸è‡ªåŠ¨åŒ–](#æ•°æ®åº“è®¾è®¡æ¨¡å¼å·¥å…·é›†æˆæŒ‡å—å·¥å…·é“¾ä¸è‡ªåŠ¨åŒ–)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1. å·¥å…·é“¾æ¶æ„](#11-å·¥å…·é“¾æ¶æ„)
  - [2. è®¾è®¡å·¥å…·åˆ†ç±»](#2-è®¾è®¡å·¥å…·åˆ†ç±»)
    - [2.1. å·¥å…·åˆ†ç±»çŸ©é˜µ](#21-å·¥å…·åˆ†ç±»çŸ©é˜µ)
  - [3. ERå›¾è®¾è®¡å·¥å…·](#3-erå›¾è®¾è®¡å·¥å…·)
    - [3.1. draw.ioé›†æˆ](#31-drawioé›†æˆ)
    - [3.2. dbdiagram.ioé›†æˆ](#32-dbdiagramioé›†æˆ)
    - [3.3. ERDPlusé›†æˆ](#33-erdplusé›†æˆ)
  - [4. DDLç”Ÿæˆå·¥å…·](#4-ddlç”Ÿæˆå·¥å…·)
    - [4.1. Python DDLç”Ÿæˆå™¨](#41-python-ddlç”Ÿæˆå™¨)
    - [4.2. SQLAlchemyé›†æˆ](#42-sqlalchemyé›†æˆ)
  - [5. ä»£ç ç”Ÿæˆå·¥å…·](#5-ä»£ç ç”Ÿæˆå·¥å…·)
    - [5.1. SQLAlchemyæ¨¡å‹ç”Ÿæˆ](#51-sqlalchemyæ¨¡å‹ç”Ÿæˆ)
    - [5.2. TypeORMæ¨¡å‹ç”Ÿæˆ](#52-typeormæ¨¡å‹ç”Ÿæˆ)
  - [6. è®¾è®¡è¯„å®¡å·¥å…·](#6-è®¾è®¡è¯„å®¡å·¥å…·)
    - [6.1. è´¨é‡æ£€æŸ¥å·¥å…·](#61-è´¨é‡æ£€æŸ¥å·¥å…·)
    - [6.2. è§„èŒƒæ£€æŸ¥å·¥å…·](#62-è§„èŒƒæ£€æŸ¥å·¥å…·)
  - [7. ç‰ˆæœ¬ç®¡ç†å·¥å…·](#7-ç‰ˆæœ¬ç®¡ç†å·¥å…·)
    - [7.1. Flywayé›†æˆ](#71-flywayé›†æˆ)
    - [7.2. Liquibaseé›†æˆ](#72-liquibaseé›†æˆ)
  - [8. CI/CDé›†æˆ](#8-cicdé›†æˆ)
    - [8.1. GitHub Actionsé›†æˆ](#81-github-actionsé›†æˆ)
    - [8.2. GitLab CIé›†æˆ](#82-gitlab-cié›†æˆ)
  - [9. å·¥å…·é“¾é›†æˆæ–¹æ¡ˆ](#9-å·¥å…·é“¾é›†æˆæ–¹æ¡ˆ)
    - [9.1. å®Œæ•´å·¥å…·é“¾æµç¨‹](#91-å®Œæ•´å·¥å…·é“¾æµç¨‹)
    - [9.2. å·¥å…·é“¾é›†æˆè„šæœ¬](#92-å·¥å…·é“¾é›†æˆè„šæœ¬)
  - [10. å‚è€ƒèµ„æ–™](#10-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›æ•°æ®åº“è®¾è®¡å·¥å…·é›†æˆæŒ‡å—ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºå®Œæ•´çš„æ•°æ®åº“è®¾è®¡å·¥å…·é“¾ã€‚

### 1.1. å·¥å…·é“¾æ¶æ„

```mermaid
mindmap
  root((è®¾è®¡å·¥å…·é“¾))
    ERå›¾è®¾è®¡
      draw.io
      dbdiagram.io
      ERDPlus
    DDLç”Ÿæˆ
      Python DDLç”Ÿæˆå™¨
      SQLAlchemy
      Alembic
    ä»£ç ç”Ÿæˆ
      SQLAlchemyæ¨¡å‹
      TypeORMæ¨¡å‹
      Prisma Schema
    è®¾è®¡è¯„å®¡
      è´¨é‡æ£€æŸ¥å·¥å…·
      è§„èŒƒæ£€æŸ¥å·¥å…·
      æ€§èƒ½åˆ†æå·¥å…·
    ç‰ˆæœ¬ç®¡ç†
      Git
      Flyway
      Liquibase
    CI/CDé›†æˆ
      GitHub Actions
      GitLab CI
      Jenkins
```

---

## 2. è®¾è®¡å·¥å…·åˆ†ç±»

### 2.1. å·¥å…·åˆ†ç±»çŸ©é˜µ

**è®¾è®¡å·¥å…·åˆ†ç±»å¯¹æ¯”**ï¼š

| å·¥å…·ç±»åˆ« | å·¥å…·åç§° | åŠŸèƒ½ | é€‚ç”¨åœºæ™¯ | æ–‡æ¡£é“¾æ¥ |
|---------|---------|------|---------|---------|
| **ERå›¾è®¾è®¡** | draw.io | å¯è§†åŒ–ERå›¾ | æ¦‚å¿µè®¾è®¡ | [3.1](#31-drawioé›†æˆ) |
| **ERå›¾è®¾è®¡** | dbdiagram.io | åœ¨çº¿ERå›¾ | å¿«é€Ÿè®¾è®¡ | [3.2](#32-dbdiagramioé›†æˆ) |
| **ERå›¾è®¾è®¡** | ERDPlus | ERå›¾å·¥å…· | ä¸“ä¸šè®¾è®¡ | [3.3](#33-erdplusé›†æˆ) |
| **DDLç”Ÿæˆ** | Python DDLç”Ÿæˆå™¨ | ä»£ç ç”ŸæˆDDL | è‡ªåŠ¨åŒ–è®¾è®¡ | [4.1](#41-python-ddlç”Ÿæˆå™¨) |
| **DDLç”Ÿæˆ** | SQLAlchemy | ORMåˆ°DDL | Pythoné¡¹ç›® | [4.2](#42-sqlalchemyé›†æˆ) |
| **ä»£ç ç”Ÿæˆ** | SQLAlchemyæ¨¡å‹ | DDLåˆ°æ¨¡å‹ | Pythoné¡¹ç›® | [5.1](#51-sqlalchemyæ¨¡å‹ç”Ÿæˆ) |
| **ä»£ç ç”Ÿæˆ** | TypeORM | DDLåˆ°æ¨¡å‹ | TypeScripté¡¹ç›® | [5.2](#52-typeormæ¨¡å‹ç”Ÿæˆ) |
| **è®¾è®¡è¯„å®¡** | è´¨é‡æ£€æŸ¥å·¥å…· | è®¾è®¡è´¨é‡è¯„åˆ† | è®¾è®¡è¯„å®¡ | [6.1](#61-è´¨é‡æ£€æŸ¥å·¥å…·) |
| **ç‰ˆæœ¬ç®¡ç†** | Flyway | æ•°æ®åº“è¿ç§» | ç‰ˆæœ¬ç®¡ç† | [7.1](#71-flywayé›†æˆ) |
| **ç‰ˆæœ¬ç®¡ç†** | Liquibase | æ•°æ®åº“è¿ç§» | ç‰ˆæœ¬ç®¡ç† | [7.2](#72-liquibaseé›†æˆ) |

---

## 3. ERå›¾è®¾è®¡å·¥å…·

### 3.1. draw.ioé›†æˆ

**draw.io ERå›¾è®¾è®¡**ï¼š

```mermaid
erDiagram
    USERS ||--o{ ORDERS : places
    PRODUCTS ||--o{ ORDER_ITEMS : contains
    ORDERS ||--o{ ORDER_ITEMS : has
```

**draw.ioä½¿ç”¨ç¤ºä¾‹**ï¼š

1. **åˆ›å»ºERå›¾**ï¼š
   - æ‰“å¼€draw.io
   - é€‰æ‹©"Entity Relationship"æ¨¡æ¿
   - ç»˜åˆ¶å®ä½“å’Œå…³ç³»

2. **å¯¼å‡ºDDL**ï¼š
   - ä½¿ç”¨draw.ioæ’ä»¶å¯¼å‡ºSQL
   - æˆ–æ‰‹åŠ¨è½¬æ¢ä¸ºDDL

### 3.2. dbdiagram.ioé›†æˆ

**dbdiagram.ioè¯­æ³•ç¤ºä¾‹**ï¼š

```dbml
Table users {
  id bigserial [pk]
  username varchar(50) [unique, not null]
  email varchar(100) [unique, not null]
  created_at timestamptz [default: `now()`]
}

Table orders {
  id bigserial [pk]
  user_id bigint [ref: > users.id]
  total_amount decimal(12, 2) [not null]
  created_at timestamptz [default: `now()`]
}

Table order_items {
  id bigserial [pk]
  order_id bigint [ref: > orders.id]
  product_id bigint [ref: > products.id]
  quantity integer [not null]
  price decimal(10, 2) [not null]
}
```

**dbdiagram.ioåˆ°DDLè½¬æ¢**ï¼š

```python
# dbdiagram.ioåˆ°PostgreSQL DDLè½¬æ¢å·¥å…·
def dbml_to_postgresql_ddl(dbml_content: str) -> str:
    """
    å°†dbdiagram.ioçš„DBMLè¯­æ³•è½¬æ¢ä¸ºPostgreSQL DDL
    """
    # è§£æDBMLè¯­æ³•
    # è½¬æ¢ä¸ºPostgreSQL DDL
    # è¿”å›DDLå­—ç¬¦ä¸²
    pass
```

### 3.3. ERDPlusé›†æˆ

**ERDPlusä½¿ç”¨æµç¨‹**ï¼š

1. **åˆ›å»ºERå›¾**ï¼šåœ¨ERDPlusä¸­ç»˜åˆ¶ERå›¾
2. **ç”Ÿæˆå…³ç³»æ¨¡å¼**ï¼šè‡ªåŠ¨ç”Ÿæˆå…³ç³»æ¨¡å¼
3. **å¯¼å‡ºSQL**ï¼šå¯¼å‡ºPostgreSQL DDL

---

## 4. DDLç”Ÿæˆå·¥å…·

### 4.1. Python DDLç”Ÿæˆå™¨

**Python DDLç”Ÿæˆå™¨å®ç°**ï¼š

```python
from typing import List, Optional

class Column:
    def __init__(
        self,
        name: str,
        data_type: str,
        nullable: bool = True,
        default: Optional[str] = None,
        primary_key: bool = False,
        unique: bool = False
    ):
        self.name = name
        self.data_type = data_type
        self.nullable = nullable
        self.default = default
        self.primary_key = primary_key
        self.unique = unique

    def to_ddl(self) -> str:
        ddl = f"{self.name} {self.data_type}"
        if not self.nullable:
            ddl += " NOT NULL"
        if self.default:
            ddl += f" DEFAULT {self.default}"
        if self.primary_key:
            ddl += " PRIMARY KEY"
        if self.unique:
            ddl += " UNIQUE"
        return ddl

class Table:
    def __init__(
        self,
        name: str,
        columns: List[Column],
        schema: str = "public"
    ):
        self.name = name
        self.columns = columns
        self.schema = schema

    def to_ddl(self) -> str:
        column_ddls = [col.to_ddl() for col in self.columns]
        ddl = f"CREATE TABLE {self.schema}.{self.name} (\n"
        ddl += ",\n".join(f"    {cd}" for cd in column_ddls)
        ddl += "\n);"
        return ddl

# ä½¿ç”¨ç¤ºä¾‹
users_table = Table(
    name="users",
    columns=[
        Column("user_id", "BIGSERIAL", primary_key=True),
        Column("username", "VARCHAR(50)", nullable=False, unique=True),
        Column("email", "VARCHAR(100)", nullable=False, unique=True),
        Column("created_at", "TIMESTAMPTZ", default="CURRENT_TIMESTAMP")
    ]
)

print(users_table.to_ddl())
```

### 4.2. SQLAlchemyé›†æˆ

**SQLAlchemyæ¨¡å‹åˆ°DDL**ï¼š

```python
from sqlalchemy import create_engine, Column, Integer, String, DateTime
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.sql import func

Base = declarative_base()

class User(Base):
    __tablename__ = 'users'

    user_id = Column(Integer, primary_key=True)
    username = Column(String(50), nullable=False, unique=True)
    email = Column(String(100), nullable=False, unique=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now())

# ç”ŸæˆDDL
engine = create_engine('postgresql://user:pass@localhost/db')
Base.metadata.create_all(engine)

# å¯¼å‡ºDDLåˆ°æ–‡ä»¶
from sqlalchemy.schema import CreateTable
ddl = str(CreateTable(User.__table__).compile(engine))
print(ddl)
```

---

## 5. ä»£ç ç”Ÿæˆå·¥å…·

### 5.1. SQLAlchemyæ¨¡å‹ç”Ÿæˆ

**ä»DDLç”ŸæˆSQLAlchemyæ¨¡å‹**ï¼š

```python
from sqlalchemy import create_engine, MetaData, Table
from sqlalchemy.ext.automap import automap_base

# ä»ç°æœ‰æ•°æ®åº“ç”Ÿæˆæ¨¡å‹
engine = create_engine('postgresql://user:pass@localhost/db')
metadata = MetaData()
metadata.reflect(engine)

Base = automap_base(metadata=metadata)
Base.prepare()

# ä½¿ç”¨ç”Ÿæˆçš„æ¨¡å‹
User = Base.classes.users
Order = Base.classes.orders
```

### 5.2. TypeORMæ¨¡å‹ç”Ÿæˆ

**ä»DDLç”ŸæˆTypeORMæ¨¡å‹**ï¼š

```typescript
// TypeORMå®ä½“å®šä¹‰
import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn } from 'typeorm';

@Entity('users')
export class User {
    @PrimaryGeneratedColumn('bigint')
    userId: number;

    @Column({ type: 'varchar', length: 50, unique: true })
    username: string;

    @Column({ type: 'varchar', length: 100, unique: true })
    email: string;

    @CreateDateColumn({ type: 'timestamptz' })
    createdAt: Date;
}
```

**TypeORM Schemaç”Ÿæˆå·¥å…·**ï¼š

```typescript
// ä»PostgreSQL Schemaç”ŸæˆTypeORMå®ä½“
async function generateTypeORMEntities(schemaName: string) {
    // è¿æ¥æ•°æ®åº“
    // è¯»å–è¡¨ç»“æ„
    // ç”ŸæˆTypeORMå®ä½“ä»£ç 
    // ä¿å­˜åˆ°æ–‡ä»¶
}
```

---

## 6. è®¾è®¡è¯„å®¡å·¥å…·

### 6.1. è´¨é‡æ£€æŸ¥å·¥å…·

**è®¾è®¡è´¨é‡æ£€æŸ¥å·¥å…·**ï¼š

```python
import psycopg2
from typing import List, Dict

class DesignQualityChecker:
    def __init__(self, connection_string: str):
        self.conn = psycopg2.connect(connection_string)

    def check_naming_conventions(self, schema_name: str) -> List[Dict]:
        """æ£€æŸ¥å‘½åè§„èŒƒ"""
        query = """
        SELECT table_name, column_name
        FROM information_schema.tables t
        JOIN information_schema.columns c ON t.table_name = c.table_name
        WHERE t.table_schema = %s
          AND (c.column_name ~ '[A-Z]' OR c.column_name ~ '-')
        """
        # æ‰§è¡Œæ£€æŸ¥
        # è¿”å›é—®é¢˜åˆ—è¡¨
        pass

    def check_index_design(self, schema_name: str) -> List[Dict]:
        """æ£€æŸ¥ç´¢å¼•è®¾è®¡"""
        query = """
        SELECT
            t.table_name,
            kcu.column_name,
            CASE WHEN i.indexname IS NULL THEN 'missing' ELSE 'exists' END AS index_status
        FROM information_schema.table_constraints tc
        JOIN information_schema.key_column_usage kcu
            ON tc.constraint_name = kcu.constraint_name
        LEFT JOIN pg_indexes i
            ON i.tablename = tc.table_name
            AND i.indexdef LIKE '%' || kcu.column_name || '%'
        WHERE tc.constraint_type = 'FOREIGN KEY'
          AND tc.table_schema = %s
        """
        # æ‰§è¡Œæ£€æŸ¥
        # è¿”å›é—®é¢˜åˆ—è¡¨
        pass

    def generate_report(self, schema_name: str) -> Dict:
        """ç”Ÿæˆè®¾è®¡è´¨é‡æŠ¥å‘Š"""
        naming_issues = self.check_naming_conventions(schema_name)
        index_issues = self.check_index_design(schema_name)

        return {
            'naming_issues': naming_issues,
            'index_issues': index_issues,
            'total_issues': len(naming_issues) + len(index_issues)
        }

# ä½¿ç”¨ç¤ºä¾‹
checker = DesignQualityChecker('postgresql://user:pass@localhost/db')
report = checker.generate_report('public')
print(report)
```

### 6.2. è§„èŒƒæ£€æŸ¥å·¥å…·

**è®¾è®¡è§„èŒƒæ£€æŸ¥å·¥å…·**ï¼š

```python
class DesignConventionChecker:
    def check_primary_keys(self, schema_name: str) -> List[str]:
        """æ£€æŸ¥æ‰€æœ‰è¡¨æ˜¯å¦æœ‰ä¸»é”®"""
        query = """
        SELECT t.table_name
        FROM information_schema.tables t
        WHERE t.table_schema = %s
          AND t.table_type = 'BASE TABLE'
          AND NOT EXISTS (
              SELECT 1 FROM information_schema.table_constraints tc
              WHERE tc.table_schema = t.table_schema
                AND tc.table_name = t.table_name
                AND tc.constraint_type = 'PRIMARY KEY'
          )
        """
        # è¿”å›ç¼ºå°‘ä¸»é”®çš„è¡¨åˆ—è¡¨
        pass

    def check_foreign_key_indexes(self, schema_name: str) -> List[Dict]:
        """æ£€æŸ¥å¤–é”®æ˜¯å¦æœ‰ç´¢å¼•"""
        query = """
        SELECT
            tc.table_name,
            kcu.column_name,
            'Missing index on foreign key' AS issue
        FROM information_schema.table_constraints tc
        JOIN information_schema.key_column_usage kcu
            ON tc.constraint_name = kcu.constraint_name
        LEFT JOIN pg_indexes i
            ON i.tablename = tc.table_name
            AND i.indexdef LIKE '%' || kcu.column_name || '%'
        WHERE tc.constraint_type = 'FOREIGN KEY'
          AND tc.table_schema = %s
          AND i.indexname IS NULL
        """
        # è¿”å›ç¼ºå°‘ç´¢å¼•çš„å¤–é”®åˆ—è¡¨
        pass
```

---

## 7. ç‰ˆæœ¬ç®¡ç†å·¥å…·

### 7.1. Flywayé›†æˆ

**Flywayè¿ç§»è„šæœ¬ç¤ºä¾‹**ï¼š

```sql
-- V1__Create_users_table.sql
CREATE TABLE users (
    user_id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- V2__Create_orders_table.sql
CREATE TABLE orders (
    order_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(user_id),
    total_amount DECIMAL(12, 2) NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_orders_user ON orders(user_id);

-- V3__Add_order_status.sql
ALTER TABLE orders ADD COLUMN status VARCHAR(20) DEFAULT 'pending';
```

**Flywayé…ç½®**ï¼š

```properties
# flyway.conf
flyway.url=jdbc:postgresql://localhost:5432/mydb
flyway.user=myuser
flyway.password=mypassword
flyway.schemas=public
flyway.locations=filesystem:db/migration
```

### 7.2. Liquibaseé›†æˆ

**Liquibaseå˜æ›´é›†ç¤ºä¾‹**ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="1" author="developer">
        <createTable tableName="users">
            <column name="user_id" type="BIGSERIAL">
                <constraints primaryKey="true"/>
            </column>
            <column name="username" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="email" type="VARCHAR(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="created_at" type="TIMESTAMPTZ" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="2" author="developer">
        <createTable tableName="orders">
            <column name="order_id" type="BIGSERIAL">
                <constraints primaryKey="true"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_orders_user"
                             referencedTableName="users" referencedColumnNames="user_id"/>
            </column>
            <column name="total_amount" type="DECIMAL(12, 2)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMPTZ" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="idx_orders_user" tableName="orders">
            <column name="user_id"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>
```

---

## 8. CI/CDé›†æˆ

### 8.1. GitHub Actionsé›†æˆ

**GitHub Actionså·¥ä½œæµ**ï¼š

```yaml
name: Database Design CI

on:
  pull_request:
    paths:
      - 'db/migration/**'
      - 'db/schema/**'

jobs:
  design-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run design quality check
        run: |
          python scripts/check_design_quality.py

      - name: Generate design report
        run: |
          python scripts/generate_design_report.py > design_report.md

      - name: Comment PR
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('design_report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            })
```

### 8.2. GitLab CIé›†æˆ

**GitLab CIé…ç½®**ï¼š

```yaml
# .gitlab-ci.yml
stages:
  - design-review
  - migration-test

design-review:
  stage: design-review
  image: python:3.11
  script:
    - pip install -r requirements.txt
    - python scripts/check_design_quality.py
    - python scripts/generate_design_report.py
  artifacts:
    paths:
      - design_report.md
    expire_in: 1 week

migration-test:
  stage: migration-test
  image: postgres:15
  services:
    - postgres:15
  variables:
    POSTGRES_DB: test_db
    POSTGRES_USER: test_user
    POSTGRES_PASSWORD: test_password
  script:
    - apt-get update && apt-get install -y flyway
    - flyway -url=jdbc:postgresql://postgres:5432/test_db -user=test_user -password=test_password migrate
```

---

## 9. å·¥å…·é“¾é›†æˆæ–¹æ¡ˆ

### 9.1. å®Œæ•´å·¥å…·é“¾æµç¨‹

**å·¥å…·é“¾é›†æˆæµç¨‹å›¾**ï¼š

```mermaid
flowchart TD
    A[ERå›¾è®¾è®¡] --> B[dbdiagram.io]
    B --> C[DBMLå¯¼å‡º]
    C --> D[Python DDLç”Ÿæˆå™¨]
    D --> E[PostgreSQL DDL]
    E --> F[Flywayè¿ç§»è„šæœ¬]
    F --> G[Gitç‰ˆæœ¬ç®¡ç†]
    G --> H[CI/CDæ£€æŸ¥]
    H --> I[è®¾è®¡è´¨é‡æŠ¥å‘Š]
    I --> J[ä»£ç ç”Ÿæˆ]
    J --> K[SQLAlchemyæ¨¡å‹]
```

### 9.2. å·¥å…·é“¾é›†æˆè„šæœ¬

**å®Œæ•´å·¥å…·é“¾é›†æˆè„šæœ¬**ï¼š

```python
#!/usr/bin/env python3
"""
æ•°æ®åº“è®¾è®¡å·¥å…·é“¾é›†æˆè„šæœ¬
"""
import os
import subprocess
from pathlib import Path

class DesignToolchain:
    def __init__(self, project_root: str):
        self.project_root = Path(project_root)
        self.db_dir = self.project_root / "db"
        self.migration_dir = self.db_dir / "migration"
        self.schema_dir = self.db_dir / "schema"

    def dbml_to_ddl(self, dbml_file: str) -> str:
        """å°†DBMLè½¬æ¢ä¸ºPostgreSQL DDL"""
        # ä½¿ç”¨dbml-to-postgreså·¥å…·
        result = subprocess.run(
            ['dbml2sql', dbml_file, '--postgres'],
            capture_output=True,
            text=True
        )
        return result.stdout

    def generate_migration(self, ddl: str, version: str) -> Path:
        """ç”ŸæˆFlywayè¿ç§»è„šæœ¬"""
        migration_file = self.migration_dir / f"V{version}__Create_schema.sql"
        migration_file.write_text(ddl)
        return migration_file

    def check_design_quality(self) -> dict:
        """æ£€æŸ¥è®¾è®¡è´¨é‡"""
        from design_quality_checker import DesignQualityChecker
        checker = DesignQualityChecker(os.getenv('DATABASE_URL'))
        return checker.generate_report('public')

    def generate_models(self, ddl_file: str):
        """ç”ŸæˆORMæ¨¡å‹"""
        # ä½¿ç”¨sqlacodegenç”ŸæˆSQLAlchemyæ¨¡å‹
        subprocess.run([
            'sqlacodegen',
            f'postgresql://{os.getenv("DATABASE_URL")}',
            '--outfile', 'models.py'
        ])

    def run_full_pipeline(self, dbml_file: str, version: str):
        """è¿è¡Œå®Œæ•´å·¥å…·é“¾"""
        # 1. DBMLè½¬DDL
        ddl = self.dbml_to_ddl(dbml_file)

        # 2. ç”Ÿæˆè¿ç§»è„šæœ¬
        migration_file = self.generate_migration(ddl, version)

        # 3. æ£€æŸ¥è®¾è®¡è´¨é‡
        quality_report = self.check_design_quality()

        # 4. ç”ŸæˆORMæ¨¡å‹
        self.generate_models(str(migration_file))

        return {
            'migration_file': migration_file,
            'quality_report': quality_report
        }

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == '__main__':
    toolchain = DesignToolchain('.')
    result = toolchain.run_full_pipeline('schema.dbml', '1.0.0')
    print(result)
```

---

## 10. å‚è€ƒèµ„æ–™

- [æ•°æ®åº“è®¾è®¡å·¥å…·ä¸æ¨¡æ¿åº“](./07.15-æ•°æ®åº“è®¾è®¡å·¥å…·ä¸æ¨¡æ¿åº“.md)
- [æ•°æ®åº“è®¾è®¡è¯„å®¡ä¸è´¨é‡ä¿è¯](./07.26-æ•°æ®åº“è®¾è®¡è¯„å®¡ä¸è´¨é‡ä¿è¯.md)
- [æ•°æ®åº“è¿ç§»ä¸ç‰ˆæœ¬ç®¡ç†](./07.07-æ•°æ®åº“è¿ç§»ä¸ç‰ˆæœ¬ç®¡ç†.md)

---

**æœ€åæ›´æ–°**ï¼š2025-01-15
**ç»´æŠ¤è€…**ï¼šData-Science Team
**çŠ¶æ€**ï¼šå®æ–½ä¸­
