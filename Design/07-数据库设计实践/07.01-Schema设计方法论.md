# Schemaè®¾è®¡æ–¹æ³•è®ºï¼šæ•°æ®åº“æ¨¡å¼è®¾è®¡çš„ç³»ç»ŸåŒ–æ–¹æ³•

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-12-01
> **ç‰ˆæœ¬**ï¼šv2.0 (å¢å¼ºç‰ˆ)
> **çŠ¶æ€**ï¼šå®æ–½ä¸­

---

## ğŸ“‹ ç›®å½•

- [Schemaè®¾è®¡æ–¹æ³•è®ºï¼šæ•°æ®åº“æ¨¡å¼è®¾è®¡çš„ç³»ç»ŸåŒ–æ–¹æ³•](#schemaè®¾è®¡æ–¹æ³•è®ºæ•°æ®åº“æ¨¡å¼è®¾è®¡çš„ç³»ç»ŸåŒ–æ–¹æ³•)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1. Schemaè®¾è®¡çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾](#11-schemaè®¾è®¡çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾)
    - [1.2. Schemaè®¾è®¡çš„æ ¸å¿ƒç›®æ ‡](#12-schemaè®¾è®¡çš„æ ¸å¿ƒç›®æ ‡)
    - [1.3. Schemaè®¾è®¡å†³ç­–æ ‘](#13-schemaè®¾è®¡å†³ç­–æ ‘)
    - [1.4. è®¾è®¡æ–¹æ³•è®ºæ¼”è¿›æ—¶é—´çº¿](#14-è®¾è®¡æ–¹æ³•è®ºæ¼”è¿›æ—¶é—´çº¿)
  - [2. å½¢å¼åŒ–ç†è®ºåŸºç¡€](#2-å½¢å¼åŒ–ç†è®ºåŸºç¡€)
    - [2.1. å…³ç³»æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰](#21-å…³ç³»æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰)
    - [2.2. å‡½æ•°ä¾èµ–ä¸èŒƒå¼ç†è®º](#22-å‡½æ•°ä¾èµ–ä¸èŒƒå¼ç†è®º)
    - [2.3. èŒƒå¼å±‚çº§å½¢å¼åŒ–è¯æ˜](#23-èŒƒå¼å±‚çº§å½¢å¼åŒ–è¯æ˜)
    - [2.4. Schemaè®¾è®¡æ­£ç¡®æ€§éªŒè¯](#24-schemaè®¾è®¡æ­£ç¡®æ€§éªŒè¯)
  - [3. Schemaè®¾è®¡æµç¨‹](#3-schemaè®¾è®¡æµç¨‹)
    - [3.1. è®¾è®¡æµç¨‹æ¦‚è§ˆ](#31-è®¾è®¡æµç¨‹æ¦‚è§ˆ)
    - [3.2. è®¾è®¡é˜¶æ®µå¯¹æ¯”çŸ©é˜µ](#32-è®¾è®¡é˜¶æ®µå¯¹æ¯”çŸ©é˜µ)
    - [3.3. æ•æ·ä¸ç€‘å¸ƒè®¾è®¡æµç¨‹å¯¹æ¯”](#33-æ•æ·ä¸ç€‘å¸ƒè®¾è®¡æµç¨‹å¯¹æ¯”)
  - [4. é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰ä¸Schemaè®¾è®¡é›†æˆ](#4-é¢†åŸŸé©±åŠ¨è®¾è®¡dddä¸schemaè®¾è®¡é›†æˆ)
    - [4.1. DDDæ ¸å¿ƒæ¦‚å¿µä¸æ•°æ®åº“æ˜ å°„](#41-dddæ ¸å¿ƒæ¦‚å¿µä¸æ•°æ®åº“æ˜ å°„)
    - [4.2. èšåˆæ ¹ä¸è¡¨è®¾è®¡](#42-èšåˆæ ¹ä¸è¡¨è®¾è®¡)
    - [4.3. é™ç•Œä¸Šä¸‹æ–‡ä¸Schemaè¾¹ç•Œ](#43-é™ç•Œä¸Šä¸‹æ–‡ä¸schemaè¾¹ç•Œ)
    - [4.4. DDDæˆ˜æœ¯æ¨¡å¼æ•°æ®åº“å®ç°](#44-dddæˆ˜æœ¯æ¨¡å¼æ•°æ®åº“å®ç°)
  - [5. éœ€æ±‚åˆ†æä¸å»ºæ¨¡](#5-éœ€æ±‚åˆ†æä¸å»ºæ¨¡)
    - [5.1. éœ€æ±‚æ”¶é›†æ–¹æ³•](#51-éœ€æ±‚æ”¶é›†æ–¹æ³•)
    - [5.2. éœ€æ±‚åˆ†æå†³ç­–æ ‘](#52-éœ€æ±‚åˆ†æå†³ç­–æ ‘)
    - [5.3. éœ€æ±‚å»ºæ¨¡æ–¹æ³•](#53-éœ€æ±‚å»ºæ¨¡æ–¹æ³•)
    - [5.4. äº‹ä»¶é£æš´ä¸æ•°æ®å»ºæ¨¡](#54-äº‹ä»¶é£æš´ä¸æ•°æ®å»ºæ¨¡)
  - [6. æ¦‚å¿µæ¨¡å‹è®¾è®¡](#6-æ¦‚å¿µæ¨¡å‹è®¾è®¡)
    - [6.1. å®ä½“è¯†åˆ«](#61-å®ä½“è¯†åˆ«)
    - [6.2. å…³ç³»è¯†åˆ«](#62-å…³ç³»è¯†åˆ«)
    - [6.3. ERå›¾è®¾è®¡](#63-erå›¾è®¾è®¡)
    - [6.4. æ¦‚å¿µæ¨¡å‹å½¢å¼åŒ–éªŒè¯](#64-æ¦‚å¿µæ¨¡å‹å½¢å¼åŒ–éªŒè¯)
  - [7. é€»è¾‘æ¨¡å‹è®¾è®¡](#7-é€»è¾‘æ¨¡å‹è®¾è®¡)
    - [7.1. è¡¨è®¾è®¡åŸåˆ™](#71-è¡¨è®¾è®¡åŸåˆ™)
    - [7.2. è¡¨è®¾è®¡å†³ç­–æ ‘](#72-è¡¨è®¾è®¡å†³ç­–æ ‘)
    - [7.3. é”®è®¾è®¡ç­–ç•¥](#73-é”®è®¾è®¡ç­–ç•¥)
    - [7.4. èŒƒå¼åŒ–å†³ç­–](#74-èŒƒå¼åŒ–å†³ç­–)
    - [7.5. åèŒƒå¼åŒ–ç­–ç•¥](#75-åèŒƒå¼åŒ–ç­–ç•¥)
  - [8. ç‰©ç†æ¨¡å‹è®¾è®¡](#8-ç‰©ç†æ¨¡å‹è®¾è®¡)
    - [8.1. æ•°æ®ç±»å‹é€‰æ‹©](#81-æ•°æ®ç±»å‹é€‰æ‹©)
    - [8.2. æ•°æ®ç±»å‹é€‰æ‹©å†³ç­–çŸ©é˜µ](#82-æ•°æ®ç±»å‹é€‰æ‹©å†³ç­–çŸ©é˜µ)
    - [8.3. ç´¢å¼•è®¾è®¡](#83-ç´¢å¼•è®¾è®¡)
    - [8.4. ç´¢å¼•ç±»å‹å¯¹æ¯”çŸ©é˜µ](#84-ç´¢å¼•ç±»å‹å¯¹æ¯”çŸ©é˜µ)
    - [8.5. åˆ†åŒºè®¾è®¡](#85-åˆ†åŒºè®¾è®¡)
  - [9. Schemaä¼˜åŒ–ä¸é‡æ„](#9-schemaä¼˜åŒ–ä¸é‡æ„)
    - [9.1. æ€§èƒ½ä¼˜åŒ–](#91-æ€§èƒ½ä¼˜åŒ–)
    - [9.2. Schemaé‡æ„](#92-schemaé‡æ„)
    - [9.3. é›¶åœæœºè¿ç§»ç­–ç•¥](#93-é›¶åœæœºè¿ç§»ç­–ç•¥)
  - [10. è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µ](#10-è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µ)
    - [10.1. å¸¸è§è®¾è®¡æ¨¡å¼](#101-å¸¸è§è®¾è®¡æ¨¡å¼)
    - [10.2. æ¨¡å¼é€‰æ‹©å†³ç­–çŸ©é˜µ](#102-æ¨¡å¼é€‰æ‹©å†³ç­–çŸ©é˜µ)
    - [10.3. æœ€ä½³å®è·µçŸ©é˜µ](#103-æœ€ä½³å®è·µçŸ©é˜µ)
  - [11. 2024-2025æœ€æ–°è¶‹åŠ¿](#11-2024-2025æœ€æ–°è¶‹åŠ¿)
    - [11.1. Schemaè®¾è®¡æŠ€æœ¯æ¼”è¿›](#111-schemaè®¾è®¡æŠ€æœ¯æ¼”è¿›)
    - [11.2. AIè¾…åŠ©Schemaè®¾è®¡](#112-aiè¾…åŠ©schemaè®¾è®¡)
    - [11.3. äº‘åŸç”ŸSchemaè®¾è®¡æ¨¡å¼](#113-äº‘åŸç”Ÿschemaè®¾è®¡æ¨¡å¼)
  - [12. å·¥å…·ä¸è‡ªåŠ¨åŒ–](#12-å·¥å…·ä¸è‡ªåŠ¨åŒ–)
    - [12.1. Schemaè®¾è®¡å·¥å…·å¯¹æ¯”](#121-schemaè®¾è®¡å·¥å…·å¯¹æ¯”)
    - [12.2. SchemaéªŒè¯è‡ªåŠ¨åŒ–](#122-schemaéªŒè¯è‡ªåŠ¨åŒ–)
  - [13. å‚è€ƒèµ„æ–™](#13-å‚è€ƒèµ„æ–™)
    - [13.1. æƒå¨æ–‡çŒ®](#131-æƒå¨æ–‡çŒ®)
    - [13.2. åœ¨çº¿èµ„æº](#132-åœ¨çº¿èµ„æº)

---

## 1. æ¦‚è¿°

Schemaè®¾è®¡æ˜¯æ•°æ®åº“è®¾è®¡çš„æ ¸å¿ƒï¼Œæ¶‰åŠä»ä¸šåŠ¡éœ€æ±‚åˆ°ç‰©ç†å®ç°çš„å®Œæ•´è¿‡ç¨‹ã€‚æœ¬æ–‡æ¡£åŸºäºå½¢å¼åŒ–ç†è®ºï¼Œç»“åˆé¢†åŸŸé©±åŠ¨è®¾è®¡(DDD)æ–¹æ³•è®ºï¼Œæä¾›ç³»ç»ŸåŒ–çš„Schemaè®¾è®¡æŒ‡å—ã€‚

### 1.1. Schemaè®¾è®¡çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((Schemaè®¾è®¡æ–¹æ³•è®º))
    ç†è®ºåŸºç¡€
      å…³ç³»ä»£æ•°
        é€‰æ‹©Selection
        æŠ•å½±Projection
        è¿æ¥Join
      å‡½æ•°ä¾èµ–
        Armstrongå…¬ç†
        é—­åŒ…è®¡ç®—
      èŒƒå¼ç†è®º
        1NF-5NF
        BCNF
        åèŒƒå¼åŒ–
    è®¾è®¡æ–¹æ³•
      ä¼ ç»Ÿæ–¹æ³•
        ERå»ºæ¨¡
        UMLæ•°æ®å»ºæ¨¡
        IDEF1X
      ç°ä»£æ–¹æ³•
        DDDé¢†åŸŸé©±åŠ¨
        äº‹ä»¶é£æš´
        äº‹ä»¶æº¯æº
    è®¾è®¡æµç¨‹
      éœ€æ±‚åˆ†æ
        ä¸šåŠ¡éœ€æ±‚
        éåŠŸèƒ½éœ€æ±‚
      æ¦‚å¿µå»ºæ¨¡
        å®ä½“è¯†åˆ«
        å…³ç³»å»ºæ¨¡
      é€»è¾‘å»ºæ¨¡
        è¡¨è®¾è®¡
        èŒƒå¼åŒ–
      ç‰©ç†å»ºæ¨¡
        æ•°æ®ç±»å‹
        ç´¢å¼•åˆ†åŒº
    è®¾è®¡æ¨¡å¼
      åŸºç¡€æ¨¡å¼
        ä¸»ä»æ¨¡å¼
        å®¡è®¡æ¨¡å¼
        è½¯åˆ é™¤
      é«˜çº§æ¨¡å¼
        å¤šç§Ÿæˆ·
        äº‹ä»¶æº¯æº
        CQRS
    æœ€æ–°è¶‹åŠ¿2025
      AIè¾…åŠ©è®¾è®¡
      Schemaæ¼”è¿›
      äº‘åŸç”Ÿè®¾è®¡
```

### 1.2. Schemaè®¾è®¡çš„æ ¸å¿ƒç›®æ ‡

**ç›®æ ‡å±‚æ¬¡æ¨¡å‹**ï¼š

```mermaid
flowchart TB
    subgraph ä¸šåŠ¡ç›®æ ‡
        B1[ä¸šåŠ¡è§„åˆ™å®Œæ•´è¡¨è¾¾]
        B2[ä¸šåŠ¡æµç¨‹æ”¯æ’‘]
        B3[ä¸šåŠ¡æ¼”è¿›é€‚åº”]
    end

    subgraph æŠ€æœ¯ç›®æ ‡
        T1[æ•°æ®å®Œæ•´æ€§]
        T2[æŸ¥è¯¢æ€§èƒ½]
        T3[å¯æ‰©å±•æ€§]
        T4[å¯ç»´æŠ¤æ€§]
        T5[å®‰å…¨æ€§]
    end

    subgraph è¿ç»´ç›®æ ‡
        O1[æ˜“äºç›‘æ§]
        O2[æ˜“äºå¤‡ä»½æ¢å¤]
        O3[æ˜“äºè¿ç§»]
    end

    B1 --> T1
    B2 --> T2
    B3 --> T3
    T1 --> O1
    T2 --> O2
    T3 --> O3
```

**ç›®æ ‡ä¼˜å…ˆçº§çŸ©é˜µ**ï¼š

| ç›®æ ‡ | OLTPç³»ç»Ÿ | OLAPç³»ç»Ÿ | æ··åˆç³»ç»Ÿ | å¾®æœåŠ¡ |
|------|---------|---------|---------|--------|
| **æ•°æ®å®Œæ•´æ€§** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­â­ |
| **æŸ¥è¯¢æ€§èƒ½** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **å†™å…¥æ€§èƒ½** | â­â­â­â­â­ | â­â­ | â­â­â­â­ | â­â­â­â­ |
| **å¯æ‰©å±•æ€§** | â­â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| **å¯ç»´æŠ¤æ€§** | â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |

### 1.3. Schemaè®¾è®¡å†³ç­–æ ‘

```mermaid
flowchart TD
    A[å¼€å§‹Schemaè®¾è®¡] --> B{ç³»ç»Ÿç±»å‹?}

    B -->|OLTP| C[äº‹åŠ¡ä¼˜å…ˆè®¾è®¡]
    B -->|OLAP| D[åˆ†æä¼˜å…ˆè®¾è®¡]
    B -->|æ··åˆ| E[HTAPè®¾è®¡]
    B -->|å¾®æœåŠ¡| F[é¢†åŸŸè¾¹ç•Œè®¾è®¡]

    C --> G{æ•°æ®è§„æ¨¡?}
    D --> H{æŸ¥è¯¢æ¨¡å¼?}
    E --> I{è¯»å†™æ¯”ä¾‹?}
    F --> J{èšåˆè¾¹ç•Œ?}

    G -->|å°<1M| K[å•è¡¨è®¾è®¡]
    G -->|ä¸­1M-100M| L[åˆ†åŒºè®¾è®¡]
    G -->|å¤§>100M| M[åˆ†åº“åˆ†è¡¨]

    H -->|å›ºå®šæŸ¥è¯¢| N[é¢„è®¡ç®—/ç‰©åŒ–è§†å›¾]
    H -->|çµæ´»æŸ¥è¯¢| O[æ˜Ÿå‹/é›ªèŠ±Schema]

    I -->|è¯»å¤šå†™å°‘| P[è¯»å†™åˆ†ç¦»+ç¼“å­˜]
    I -->|è¯»å†™å‡è¡¡| Q[CQRSæ¨¡å¼]

    J -->|å¼ºä¸€è‡´æ€§| R[å•åº“äº‹åŠ¡]
    J -->|æœ€ç»ˆä¸€è‡´| S[Saga/äº‹ä»¶é©±åŠ¨]

    K --> T[èŒƒå¼åŒ–è®¾è®¡]
    L --> T
    M --> U[åˆ†ç‰‡é”®è®¾è®¡]
    N --> V[ETLæµç¨‹è®¾è®¡]
    O --> V
    P --> W[ç¼“å­˜ç­–ç•¥è®¾è®¡]
    Q --> X[å‘½ä»¤æŸ¥è¯¢åˆ†ç¦»]
    R --> T
    S --> Y[äº‹ä»¶å­˜å‚¨è®¾è®¡]

    T --> Z[SchemaéªŒè¯]
    U --> Z
    V --> Z
    W --> Z
    X --> Z
    Y --> Z

    Z --> AA{æ»¡è¶³éœ€æ±‚?}
    AA -->|æ˜¯| AB[è®¾è®¡å®Œæˆ]
    AA -->|å¦| AC[è¿­ä»£ä¼˜åŒ–]
    AC --> B
```

### 1.4. è®¾è®¡æ–¹æ³•è®ºæ¼”è¿›æ—¶é—´çº¿

```mermaid
timeline
    title Schemaè®¾è®¡æ–¹æ³•è®ºæ¼”è¿›
    1970s : å…³ç³»æ¨¡å‹æå‡º(Codd)
          : ERæ¨¡å‹(Chen)
          : èŒƒå¼ç†è®ºå®Œå–„
    1980s : SQLæ ‡å‡†åŒ–
          : CASEå·¥å…·å…´èµ·
          : IDEF1Xæ–¹æ³•
    1990s : UMLæ•°æ®å»ºæ¨¡
          : å¯¹è±¡å…³ç³»æ˜ å°„
          : æ•°æ®ä»“åº“Schema
    2000s : æ•æ·æ•°æ®å»ºæ¨¡
          : NoSQLå…´èµ·
          : åˆ†å¸ƒå¼Schema
    2010s : DDDé¢†åŸŸé©±åŠ¨
          : å¾®æœåŠ¡æ•°æ®è®¾è®¡
          : äº‹ä»¶æº¯æºæ¨¡å¼
    2020s : AIè¾…åŠ©è®¾è®¡
          : Schemaå³ä»£ç 
          : äº‘åŸç”Ÿæ•°æ®æ¶æ„
    2025+ : è‡ªåŠ¨Schemaæ¼”è¿›
          : æ™ºèƒ½ä¼˜åŒ–æ¨è
          : å¤šæ¨¡æ€æ•°æ®èåˆ
```

---

## 2. å½¢å¼åŒ–ç†è®ºåŸºç¡€

### 2.1. å…³ç³»æ¨¡å‹çš„å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰2.1.1ï¼ˆå…³ç³»Schemaï¼‰**ï¼š

å…³ç³»Schema R æ˜¯ä¸€ä¸ªäºŒå…ƒç»„ï¼š

```text
R = (U, F)

å…¶ä¸­ï¼š
- U = {Aâ‚, Aâ‚‚, ..., Aâ‚™} æ˜¯å±æ€§é›†åˆ
- F æ˜¯ U ä¸Šçš„å‡½æ•°ä¾èµ–é›†åˆ
```

**å®šä¹‰2.1.2ï¼ˆå…³ç³»å®ä¾‹ï¼‰**ï¼š

å…³ç³» R çš„å®ä¾‹ r æ˜¯å®šä¹‰åœ¨å±æ€§é›†åˆ U ä¸Šçš„ä¸€ä¸ªæœ‰é™é›†åˆï¼š

```text
r âŠ† dom(Aâ‚) Ã— dom(Aâ‚‚) Ã— ... Ã— dom(Aâ‚™)

å…¶ä¸­ dom(Aáµ¢) æ˜¯å±æ€§ Aáµ¢ çš„å€¼åŸŸ
```

**å…³ç³»çš„å½¢å¼åŒ–æ€§è´¨**ï¼š

| æ€§è´¨ | å½¢å¼åŒ–å®šä¹‰ | å®é™…æ„ä¹‰ |
|------|-----------|---------|
| **å…ƒç»„å”¯ä¸€æ€§** | âˆ€tâ‚,tâ‚‚âˆˆr, tâ‚â‰ tâ‚‚ âŸ¹ âˆƒAáµ¢: tâ‚[Aáµ¢]â‰ tâ‚‚[Aáµ¢] | æ— é‡å¤è¡Œ |
| **å±æ€§åŸå­æ€§** | âˆ€AâˆˆU, âˆ€tâˆˆr: t[A]âˆˆdom(A)ä¸”ä¸ºåŸå­å€¼ | å€¼ä¸å¯åˆ† |
| **å…ƒç»„æ— åºæ€§** | r = {tâ‚,...,tâ‚™} = {t_{Ï€(1)},...,t_{Ï€(n)}} | è¡Œé¡ºåºæ— å…³ |
| **å±æ€§æ— åºæ€§** | R(A,B,C) â‰¡ R(B,C,A) | åˆ—é¡ºåºæ— å…³ |

### 2.2. å‡½æ•°ä¾èµ–ä¸èŒƒå¼ç†è®º

**å®šä¹‰2.2.1ï¼ˆå‡½æ•°ä¾èµ–ï¼‰**ï¼š

è®¾ R æ˜¯å…³ç³»Schemaï¼ŒX, Y âŠ† Uã€‚å‡½æ•°ä¾èµ– X â†’ Y æˆç«‹ï¼Œå½“ä¸”ä»…å½“ï¼š

```text
âˆ€tâ‚,tâ‚‚âˆˆr(R): tâ‚[X] = tâ‚‚[X] âŸ¹ tâ‚[Y] = tâ‚‚[Y]
```

**Armstrongå…¬ç†ç³»ç»Ÿ**ï¼š

```mermaid
flowchart TD
    subgraph åŸºæœ¬å…¬ç†
        A1[è‡ªåå¾‹: YâŠ†X âŸ¹ Xâ†’Y]
        A2[å¢å¹¿å¾‹: Xâ†’Y âŸ¹ XZâ†’YZ]
        A3[ä¼ é€’å¾‹: Xâ†’Y âˆ§ Yâ†’Z âŸ¹ Xâ†’Z]
    end

    subgraph æ´¾ç”Ÿè§„åˆ™
        D1[åˆå¹¶å¾‹: Xâ†’Y âˆ§ Xâ†’Z âŸ¹ Xâ†’YZ]
        D2[åˆ†è§£å¾‹: Xâ†’YZ âŸ¹ Xâ†’Y âˆ§ Xâ†’Z]
        D3[ä¼ªä¼ é€’å¾‹: Xâ†’Y âˆ§ WYâ†’Z âŸ¹ XWâ†’Z]
    end

    A1 --> D1
    A2 --> D1
    A3 --> D1
    A1 --> D2
    A3 --> D2
    A2 --> D3
    A3 --> D3
```

**å‡½æ•°ä¾èµ–ç±»å‹å¯¹æ¯”çŸ©é˜µ**ï¼š

| ä¾èµ–ç±»å‹ | å½¢å¼åŒ–å®šä¹‰ | åˆ¤å®šæ¡ä»¶ | å¯¹èŒƒå¼çš„å½±å“ |
|---------|-----------|---------|-------------|
| **å¹³å‡¡ä¾èµ–** | Y âŠ† X æ—¶ Xâ†’Y | æ€»æ˜¯æˆç«‹ | æ— å½±å“ |
| **å®Œå…¨ä¾èµ–** | Xâ†’Y ä¸” âˆ€X'âŠ‚X: X'â†›Y | æœ€å°å†³å®šå› ç´  | 2NFè¦æ±‚ |
| **éƒ¨åˆ†ä¾èµ–** | âˆƒX'âŠ‚X: X'â†’Y | å­˜åœ¨çœŸå­é›†å†³å®š | è¿å2NF |
| **ä¼ é€’ä¾èµ–** | Xâ†’Y, Yâ†’Z, Yâ†›X | é—´æ¥å†³å®š | è¿å3NF |

### 2.3. èŒƒå¼å±‚çº§å½¢å¼åŒ–è¯æ˜

**å®šç†2.3.1ï¼ˆèŒƒå¼å±‚çº§åŒ…å«å…³ç³»ï¼‰**ï¼š

```text
5NF âŠ‚ 4NF âŠ‚ BCNF âŠ‚ 3NF âŠ‚ 2NF âŠ‚ 1NF

è¯æ˜ï¼ˆä»¥3NFâŠ‚2NFä¸ºä¾‹ï¼‰ï¼š
1. å‡è®¾Ræ»¡è¶³3NF
2. 3NFå®šä¹‰ï¼šå¯¹äºæ¯ä¸ªéå¹³å‡¡FD Xâ†’Yï¼ŒXæ˜¯è¶…é”®æˆ–Yæ˜¯ä¸»å±æ€§
3. 2NFå®šä¹‰ï¼šæ¯ä¸ªéä¸»å±æ€§å®Œå…¨ä¾èµ–äºä¸»é”®
4. è‹¥å­˜åœ¨éƒ¨åˆ†ä¾èµ–K'â†’Aï¼ˆK'âŠ‚Kæ˜¯ä¸»é”®çœŸå­é›†ï¼ŒAéä¸»å±æ€§ï¼‰
5. åˆ™K'ä¸æ˜¯è¶…é”®ï¼ˆå› ä¸ºK'âŠ‚Kï¼‰ï¼Œä¸”Aä¸æ˜¯ä¸»å±æ€§
6. è¿™è¿å3NFå®šä¹‰
7. å› æ­¤Ræ»¡è¶³2NF âˆ
```

**èŒƒå¼é€‰æ‹©å†³ç­–çŸ©é˜µ**ï¼š

| èŒƒå¼ | æ¶ˆé™¤çš„å¼‚å¸¸ | æŸ¥è¯¢å¤æ‚åº¦ | æ›´æ–°å¤æ‚åº¦ | æ¨èåœºæ™¯ |
|------|-----------|-----------|-----------|---------|
| **1NF** | - | â­ | â­ | æœ€ä½è¦æ±‚ |
| **2NF** | éƒ¨åˆ†ä¾èµ–å†—ä½™ | â­â­ | â­â­ | å¤åˆä¸»é”®è¡¨ |
| **3NF** | ä¼ é€’ä¾èµ–å†—ä½™ | â­â­â­ | â­â­â­ | å¤§å¤šæ•°OLTP |
| **BCNF** | æ‰€æœ‰FDå†—ä½™ | â­â­â­â­ | â­â­â­â­ | ä¸¥æ ¼è¦æ±‚ |
| **4NF** | å¤šå€¼ä¾èµ–å†—ä½™ | â­â­â­â­ | â­â­â­â­ | å¤šå¯¹å¤šå…³ç³» |
| **5NF** | è¿æ¥ä¾èµ–å†—ä½™ | â­â­â­â­â­ | â­â­â­â­â­ | ç†è®ºç ”ç©¶ |

### 2.4. Schemaè®¾è®¡æ­£ç¡®æ€§éªŒè¯

**ç®—æ³•2.4.1ï¼šSchemaèŒƒå¼éªŒè¯**:

```python
def verify_normalization(schema: RelationSchema, target_nf: str) -> ValidationResult:
    """
    éªŒè¯Schemaæ˜¯å¦æ»¡è¶³ç›®æ ‡èŒƒå¼

    å‚æ•°:
        schema: å…³ç³»Schema (å±æ€§é›†åˆ, å‡½æ•°ä¾èµ–é›†åˆ)
        target_nf: ç›®æ ‡èŒƒå¼ ('1NF', '2NF', '3NF', 'BCNF', '4NF', '5NF')

    è¿”å›:
        ValidationResult: (is_valid, violations, suggestions)
    """
    violations = []

    # 1NFæ£€æŸ¥ï¼šå±æ€§åŸå­æ€§
    if target_nf in ['1NF', '2NF', '3NF', 'BCNF', '4NF', '5NF']:
        for attr in schema.attributes:
            if not is_atomic(attr.domain):
                violations.append(f"å±æ€§ {attr.name} è¿å1NFï¼šå€¼åŸŸéåŸå­")

    # 2NFæ£€æŸ¥ï¼šæ¶ˆé™¤éƒ¨åˆ†ä¾èµ–
    if target_nf in ['2NF', '3NF', 'BCNF', '4NF', '5NF']:
        candidate_keys = compute_candidate_keys(schema)
        for fd in schema.functional_dependencies:
            if is_partial_dependency(fd, candidate_keys):
                violations.append(f"FD {fd} è¿å2NFï¼šéƒ¨åˆ†ä¾èµ–")

    # 3NFæ£€æŸ¥ï¼šæ¶ˆé™¤ä¼ é€’ä¾èµ–
    if target_nf in ['3NF', 'BCNF', '4NF', '5NF']:
        for fd in schema.functional_dependencies:
            X, Y = fd.determinant, fd.dependent
            if not is_superkey(X, schema) and not is_prime_attribute(Y, schema):
                violations.append(f"FD {fd} è¿å3NFï¼šéè¶…é”®å†³å®šéä¸»å±æ€§")

    # BCNFæ£€æŸ¥ï¼šæ‰€æœ‰å†³å®šå› ç´ éƒ½æ˜¯è¶…é”®
    if target_nf in ['BCNF', '4NF', '5NF']:
        for fd in schema.functional_dependencies:
            if not is_trivial(fd) and not is_superkey(fd.determinant, schema):
                violations.append(f"FD {fd} è¿åBCNFï¼šå†³å®šå› ç´ éè¶…é”®")

    return ValidationResult(
        is_valid=len(violations) == 0,
        violations=violations,
        suggestions=generate_decomposition_suggestions(violations)
    )
```

---

## 3. Schemaè®¾è®¡æµç¨‹

### 3.1. è®¾è®¡æµç¨‹æ¦‚è§ˆ

```mermaid
mindmap
  root((Schemaè®¾è®¡æµç¨‹))
    éœ€æ±‚åˆ†æ
      ä¸šåŠ¡éœ€æ±‚
        ä¸šåŠ¡æµç¨‹
        ä¸šåŠ¡è§„åˆ™
        ä¸šåŠ¡å®ä½“
      åŠŸèƒ½éœ€æ±‚
        æ•°æ®æ“ä½œ
        æŸ¥è¯¢éœ€æ±‚
        æŠ¥è¡¨éœ€æ±‚
      éåŠŸèƒ½éœ€æ±‚
        æ€§èƒ½æŒ‡æ ‡
        å®‰å…¨è¦æ±‚
        å¯ç”¨æ€§SLA
    æ¦‚å¿µå»ºæ¨¡
      å®ä½“è¯†åˆ«
        æ ¸å¿ƒå®ä½“
        å…³è”å®ä½“
        å€¼å¯¹è±¡
      å…³ç³»è¯†åˆ«
        ä¸€å¯¹ä¸€
        ä¸€å¯¹å¤š
        å¤šå¯¹å¤š
      å±æ€§å®šä¹‰
        æ ‡è¯†å±æ€§
        æè¿°å±æ€§
        è®¡ç®—å±æ€§
    é€»è¾‘å»ºæ¨¡
      è¡¨è®¾è®¡
        å‘½åè§„èŒƒ
        åˆ—å®šä¹‰
        çº¦æŸè®¾è®¡
      é”®è®¾è®¡
        ä¸»é”®ç­–ç•¥
        å¤–é”®è®¾è®¡
        å€™é€‰é”®
      èŒƒå¼åŒ–
        èŒƒå¼é€‰æ‹©
        åˆ†è§£ç­–ç•¥
        ä¾èµ–ä¿æŒ
    ç‰©ç†å»ºæ¨¡
      æ•°æ®ç±»å‹
        å­˜å‚¨æ•ˆç‡
        æŸ¥è¯¢æ•ˆç‡
        å…¼å®¹æ€§
      ç´¢å¼•è®¾è®¡
        ç´¢å¼•ç±»å‹
        å¤åˆç´¢å¼•
        è¦†ç›–ç´¢å¼•
      åˆ†åŒºè®¾è®¡
        åˆ†åŒºç­–ç•¥
        åˆ†åŒºé”®
        åˆ†åŒºç®¡ç†
    éªŒè¯ä¼˜åŒ–
      å®Œæ•´æ€§éªŒè¯
        çº¦æŸæµ‹è¯•
        æ•°æ®éªŒè¯
      æ€§èƒ½æµ‹è¯•
        æŸ¥è¯¢åŸºå‡†
        å†™å…¥åŸºå‡†
      é‡æ„ä¼˜åŒ–
        Schemaæ¼”è¿›
        è¿ç§»ç­–ç•¥
```

### 3.2. è®¾è®¡é˜¶æ®µå¯¹æ¯”çŸ©é˜µ

| è®¾è®¡é˜¶æ®µ | è¾“å…¥ | è¾“å‡º | ä¸»è¦æ´»åŠ¨ | å·¥å…· | å‚ä¸è§’è‰² |
|---------|------|------|---------|------|---------|
| **éœ€æ±‚åˆ†æ** | ä¸šåŠ¡éœ€æ±‚æ–‡æ¡£ | éœ€æ±‚è§„æ ¼è¯´æ˜ | éœ€æ±‚æ”¶é›†ã€åˆ†æ | Jira, Confluence | BA, PM |
| **æ¦‚å¿µå»ºæ¨¡** | éœ€æ±‚è§„æ ¼è¯´æ˜ | ERå›¾/é¢†åŸŸæ¨¡å‹ | å®ä½“è¯†åˆ«ã€DDDå»ºæ¨¡ | Draw.io, Miro | æ¶æ„å¸ˆ, DBA |
| **é€»è¾‘å»ºæ¨¡** | ERå›¾ | é€»è¾‘Schema | è¡¨è®¾è®¡ã€èŒƒå¼åŒ– | DbSchema, ERwin | DBA |
| **ç‰©ç†å»ºæ¨¡** | é€»è¾‘Schema | DDLè„šæœ¬ | æ•°æ®ç±»å‹ã€ç´¢å¼• | pgAdmin, DataGrip | DBA |
| **éªŒè¯ä¼˜åŒ–** | ç‰©ç†Schema | ä¼˜åŒ–Schema | æµ‹è¯•ã€è°ƒä¼˜ | pgBench, EXPLAIN | DBA, Dev |

### 3.3. æ•æ·ä¸ç€‘å¸ƒè®¾è®¡æµç¨‹å¯¹æ¯”

```mermaid
flowchart TB
    subgraph ç€‘å¸ƒæ¨¡å‹
        W1[éœ€æ±‚åˆ†æ] --> W2[æ¦‚å¿µè®¾è®¡]
        W2 --> W3[é€»è¾‘è®¾è®¡]
        W3 --> W4[ç‰©ç†è®¾è®¡]
        W4 --> W5[å®æ–½]
        W5 --> W6[ç»´æŠ¤]
    end

    subgraph æ•æ·æ¨¡å‹
        A1[Sprintè§„åˆ’] --> A2[å¢é‡è®¾è®¡]
        A2 --> A3[å®ç°]
        A3 --> A4[æµ‹è¯•]
        A4 --> A5[å›é¡¾]
        A5 --> A1
    end

    subgraph æ¼”è¿›å¼è®¾è®¡
        E1[æœ€å°å¯è¡ŒSchema] --> E2[ç›‘æ§åé¦ˆ]
        E2 --> E3[Schemaæ¼”è¿›]
        E3 --> E4[è¿ç§»éƒ¨ç½²]
        E4 --> E2
    end
```

**è®¾è®¡æ–¹æ³•å¯¹æ¯”çŸ©é˜µ**ï¼š

| ç»´åº¦ | ç€‘å¸ƒæ¨¡å‹ | æ•æ·æ¨¡å‹ | æ¼”è¿›å¼è®¾è®¡ |
|------|---------|---------|-----------|
| **é€‚ç”¨åœºæ™¯** | éœ€æ±‚æ˜ç¡®ã€ç¨³å®š | éœ€æ±‚å˜åŒ–ã€è¿­ä»£ | æŒç»­æ¼”è¿› |
| **è®¾è®¡æ·±åº¦** | å®Œæ•´è¯¦ç»† | å¢é‡è®¾è®¡ | æœ€å°å¯è¡Œ |
| **å˜æ›´æˆæœ¬** | é«˜ | ä¸­ | ä½ |
| **æ–‡æ¡£è¦æ±‚** | è¯¦ç»†æ–‡æ¡£ | è½»é‡æ–‡æ¡£ | ä»£ç å³æ–‡æ¡£ |
| **å›¢é˜Ÿåä½œ** | é˜¶æ®µäº¤æ¥ | æŒç»­åä½œ | DevOps |
| **é£é™©ç®¡ç†** | åæœŸæš´éœ² | æ—©æœŸå‘ç° | æŒç»­ç›‘æ§ |

---

## 4. é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰ä¸Schemaè®¾è®¡é›†æˆ

### 4.1. DDDæ ¸å¿ƒæ¦‚å¿µä¸æ•°æ®åº“æ˜ å°„

```mermaid
flowchart LR
    subgraph DDDæˆ˜æœ¯æ¨¡å¼
        E[å®ä½“Entity]
        VO[å€¼å¯¹è±¡ValueObject]
        AR[èšåˆæ ¹AggregateRoot]
        R[ä»“å‚¨Repository]
        DS[é¢†åŸŸæœåŠ¡DomainService]
        DE[é¢†åŸŸäº‹ä»¶DomainEvent]
    end

    subgraph æ•°æ®åº“æ˜ å°„
        T[è¡¨Table]
        ET[åµŒå…¥å¼ç±»å‹/JSON]
        MT[ä¸»è¡¨+å­è¡¨]
        DAO[æ•°æ®è®¿é—®å±‚]
        SP[å­˜å‚¨è¿‡ç¨‹]
        EL[äº‹ä»¶æ—¥å¿—è¡¨]
    end

    E --> T
    VO --> ET
    AR --> MT
    R --> DAO
    DS --> SP
    DE --> EL
```

**DDDæ¦‚å¿µæ•°æ®åº“æ˜ å°„å¯¹æ¯”**ï¼š

| DDDæ¦‚å¿µ | æ•°æ®åº“æ˜ å°„æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | ç¤ºä¾‹ |
|---------|--------------|------|------|------|
| **å®ä½“(Entity)** | ç‹¬ç«‹è¡¨ | æ¸…æ™°ã€å¯æŸ¥è¯¢ | éœ€è¦IDç®¡ç† | `users`è¡¨ |
| **å€¼å¯¹è±¡(VO)** | åµŒå…¥åˆ—/JSON | ç®€å•ã€åŸå­ | æŸ¥è¯¢å—é™ | `address`å­—æ®µ |
| **èšåˆæ ¹** | ä¸»è¡¨+çº§è” | ä¸€è‡´æ€§ä¿è¯ | æ€§èƒ½è€ƒé‡ | `orders`+`order_items` |
| **ä»“å‚¨** | Repositoryæ¨¡å¼ | è§£è€¦ | æŠ½è±¡å¼€é”€ | `OrderRepository` |
| **é¢†åŸŸäº‹ä»¶** | äº‹ä»¶è¡¨ | å¯è¿½æº¯ | å­˜å‚¨å¢é•¿ | `domain_events` |

### 4.2. èšåˆæ ¹ä¸è¡¨è®¾è®¡

**èšåˆè®¾è®¡åŸåˆ™**ï¼š

```mermaid
flowchart TD
    A[è¯†åˆ«èšåˆè¾¹ç•Œ] --> B{ä¸€è‡´æ€§è¾¹ç•Œ?}

    B -->|å¼ºä¸€è‡´æ€§| C[åŒä¸€èšåˆ]
    B -->|æœ€ç»ˆä¸€è‡´| D[åˆ†ç¦»èšåˆ]

    C --> E{å¤§å°è¯„ä¼°}
    E -->|å°| F[å•è¡¨å­˜å‚¨]
    E -->|ä¸­| G[ä¸»ä»è¡¨]
    E -->|å¤§| H[æ‹†åˆ†èšåˆ]

    D --> I[äº‹ä»¶é©±åŠ¨åŒæ­¥]

    F --> J[è®¾è®¡å®Œæˆ]
    G --> J
    H --> A
    I --> J
```

**èšåˆæ ¹è¡¨è®¾è®¡ç¤ºä¾‹**ï¼š

```sql
-- è®¢å•èšåˆæ ¹è®¾è®¡
-- èšåˆæ ¹ï¼šOrder
-- èšåˆæˆå‘˜ï¼šOrderItem, ShippingAddress

CREATE TABLE orders (
    -- èšåˆæ ¹æ ‡è¯†
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_number VARCHAR(32) UNIQUE NOT NULL,

    -- èšåˆç‰ˆæœ¬ï¼ˆä¹è§‚é”ï¼‰
    version INTEGER NOT NULL DEFAULT 1,

    -- èšåˆçŠ¶æ€
    status VARCHAR(20) NOT NULL DEFAULT 'CREATED',

    -- å€¼å¯¹è±¡ï¼šåµŒå…¥å¼å­˜å‚¨
    shipping_address JSONB NOT NULL,
    -- ç¤ºä¾‹: {"street": "123 Main St", "city": "NYC", "zip": "10001"}

    -- èšåˆå…ƒæ•°æ®
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,

    -- é¢†åŸŸçº¦æŸ
    CONSTRAINT valid_status CHECK (status IN ('CREATED', 'PAID', 'SHIPPED', 'DELIVERED', 'CANCELLED'))
);

-- èšåˆæˆå‘˜ï¼šè®¢å•é¡¹ï¼ˆåªèƒ½é€šè¿‡èšåˆæ ¹è®¿é—®ï¼‰
CREATE TABLE order_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID NOT NULL REFERENCES orders(id) ON DELETE CASCADE,

    -- äº§å“å¿«ç…§ï¼ˆå€¼å¯¹è±¡ï¼‰
    product_snapshot JSONB NOT NULL,
    -- ç¤ºä¾‹: {"product_id": "...", "name": "...", "price": 99.99}

    quantity INTEGER NOT NULL CHECK (quantity > 0),
    unit_price DECIMAL(10,2) NOT NULL CHECK (unit_price >= 0),

    -- ä¸å…è®¸ç›´æ¥æŸ¥è¯¢ï¼Œåªé€šè¿‡èšåˆæ ¹
    CONSTRAINT fk_order FOREIGN KEY (order_id) REFERENCES orders(id)
);

-- èšåˆæ ¹ç´¢å¼•
CREATE INDEX idx_orders_number ON orders(order_number);
CREATE INDEX idx_orders_status ON orders(status);

-- èšåˆæˆå‘˜ç´¢å¼•ï¼ˆä»…æ”¯æŒèšåˆå†…æŸ¥è¯¢ï¼‰
CREATE INDEX idx_order_items_order ON order_items(order_id);

-- èšåˆä¸å˜é‡æ£€æŸ¥è§¦å‘å™¨
CREATE OR REPLACE FUNCTION check_order_invariants()
RETURNS TRIGGER AS $$
BEGIN
    -- ä¸å˜é‡1ï¼šè®¢å•è‡³å°‘æœ‰ä¸€ä¸ªè®¢å•é¡¹ï¼ˆåœ¨ä¸šåŠ¡å±‚ä¿è¯ï¼‰
    -- ä¸å˜é‡2ï¼šå·²å‘è´§è®¢å•ä¸èƒ½ä¿®æ”¹
    IF TG_OP = 'UPDATE' AND OLD.status IN ('SHIPPED', 'DELIVERED') THEN
        IF NEW.status NOT IN ('SHIPPED', 'DELIVERED', 'CANCELLED') THEN
            RAISE EXCEPTION 'Cannot modify shipped order status to %', NEW.status;
        END IF;
    END IF;

    NEW.updated_at = CURRENT_TIMESTAMP;
    NEW.version = OLD.version + 1;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER order_invariants_check
BEFORE UPDATE ON orders
FOR EACH ROW EXECUTE FUNCTION check_order_invariants();
```

### 4.3. é™ç•Œä¸Šä¸‹æ–‡ä¸Schemaè¾¹ç•Œ

```mermaid
flowchart TB
    subgraph è®¢å•ä¸Šä¸‹æ–‡
        O_User[ç”¨æˆ·å¼•ç”¨]
        O_Order[è®¢å•]
        O_Item[è®¢å•é¡¹]
    end

    subgraph åº“å­˜ä¸Šä¸‹æ–‡
        I_Product[äº§å“]
        I_Stock[åº“å­˜]
        I_Reservation[é¢„ç•™]
    end

    subgraph ç”¨æˆ·ä¸Šä¸‹æ–‡
        U_User[ç”¨æˆ·]
        U_Profile[ç”¨æˆ·æ¡£æ¡ˆ]
        U_Address[åœ°å€]
    end

    subgraph æ”¯ä»˜ä¸Šä¸‹æ–‡
        P_Payment[æ”¯ä»˜]
        P_Transaction[äº¤æ˜“]
    end

    O_User -.->|IDå¼•ç”¨| U_User
    O_Item -.->|å¿«ç…§| I_Product
    O_Order -.->|äº‹ä»¶| P_Payment
    O_Order -.->|äº‹ä»¶| I_Reservation
```

**ä¸Šä¸‹æ–‡é—´æ•°æ®å…±äº«ç­–ç•¥**ï¼š

| ç­–ç•¥ | æè¿° | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|------|---------|
| **å…±äº«å†…æ ¸** | å…±äº«Schema | ç®€å• | è€¦åˆé«˜ | ç´§å¯†ç›¸å…³ä¸Šä¸‹æ–‡ |
| **å®¢æˆ·-ä¾›åº”å•†** | ä¾›åº”å•†æä¾›API | è§£è€¦ | ä¾èµ– | ä¸Šä¸‹æ¸¸å…³ç³»æ˜ç¡® |
| **é˜²è…å±‚** | ç¿»è¯‘å±‚éš”ç¦» | å®Œå…¨è§£è€¦ | å¤æ‚ | é—ç•™ç³»ç»Ÿé›†æˆ |
| **å‘å¸ƒè¯­è¨€** | æ ‡å‡†åŒ–æ ¼å¼ | é€šç”¨ | åå•†æˆæœ¬ | å¤šä¸Šä¸‹æ–‡é›†æˆ |
| **åˆ†ç¦»æ–¹å¼** | å®Œå…¨ç‹¬ç«‹ | è‡ªæ²» | åŒæ­¥éš¾ | ç‹¬ç«‹æ¼”è¿› |

### 4.4. DDDæˆ˜æœ¯æ¨¡å¼æ•°æ®åº“å®ç°

**å€¼å¯¹è±¡å­˜å‚¨ç­–ç•¥**ï¼š

```sql
-- ç­–ç•¥1ï¼šåµŒå…¥å¼åˆ—ï¼ˆç®€å•å€¼å¯¹è±¡ï¼‰
CREATE TABLE users (
    id UUID PRIMARY KEY,
    -- Moneyå€¼å¯¹è±¡
    account_balance_amount DECIMAL(10,2) NOT NULL DEFAULT 0,
    account_balance_currency VARCHAR(3) NOT NULL DEFAULT 'USD',
    -- Addresså€¼å¯¹è±¡
    address_street VARCHAR(200),
    address_city VARCHAR(100),
    address_zip VARCHAR(20)
);

-- ç­–ç•¥2ï¼šJSONBå­˜å‚¨ï¼ˆå¤æ‚å€¼å¯¹è±¡ï¼‰
CREATE TABLE products (
    id UUID PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    -- å¤æ‚å€¼å¯¹è±¡
    specifications JSONB NOT NULL DEFAULT '{}',
    -- ç¤ºä¾‹: {"weight": {"value": 1.5, "unit": "kg"}, "dimensions": {...}}
    pricing JSONB NOT NULL,
    -- ç¤ºä¾‹: {"base_price": 99.99, "currency": "USD", "tax_rate": 0.1}

    -- JSONBçº¦æŸ
    CONSTRAINT valid_specs CHECK (jsonb_typeof(specifications) = 'object'),
    CONSTRAINT valid_pricing CHECK (
        pricing ? 'base_price' AND
        pricing ? 'currency' AND
        (pricing->>'base_price')::DECIMAL >= 0
    )
);

-- ç­–ç•¥3ï¼šå…³è”è¡¨ï¼ˆå€¼å¯¹è±¡é›†åˆï¼‰
CREATE TABLE user_phones (
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    phone_type VARCHAR(20) NOT NULL,
    country_code VARCHAR(5) NOT NULL,
    number VARCHAR(20) NOT NULL,
    is_primary BOOLEAN DEFAULT FALSE,
    PRIMARY KEY (user_id, phone_type, number)
);
```

**é¢†åŸŸäº‹ä»¶å­˜å‚¨**ï¼š

```sql
-- é¢†åŸŸäº‹ä»¶è¡¨
CREATE TABLE domain_events (
    event_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    aggregate_type VARCHAR(100) NOT NULL,
    aggregate_id UUID NOT NULL,
    event_type VARCHAR(100) NOT NULL,
    event_data JSONB NOT NULL,
    metadata JSONB DEFAULT '{}',
    occurred_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    published_at TIMESTAMPTZ,

    -- äº‹ä»¶ç‰ˆæœ¬ï¼ˆç”¨äºä¹è§‚å¹¶å‘ï¼‰
    sequence_number BIGINT NOT NULL,

    UNIQUE(aggregate_type, aggregate_id, sequence_number)
);

-- äº‹ä»¶ç´¢å¼•
CREATE INDEX idx_events_aggregate ON domain_events(aggregate_type, aggregate_id, sequence_number);
CREATE INDEX idx_events_type ON domain_events(event_type);
CREATE INDEX idx_events_occurred ON domain_events(occurred_at);
CREATE INDEX idx_events_unpublished ON domain_events(published_at) WHERE published_at IS NULL;

-- äº‹ä»¶å‘å¸ƒå‡½æ•°
CREATE OR REPLACE FUNCTION publish_domain_event(
    p_aggregate_type VARCHAR,
    p_aggregate_id UUID,
    p_event_type VARCHAR,
    p_event_data JSONB
)
RETURNS UUID AS $$
DECLARE
    v_event_id UUID;
    v_sequence BIGINT;
BEGIN
    -- è·å–ä¸‹ä¸€ä¸ªåºåˆ—å·
    SELECT COALESCE(MAX(sequence_number), 0) + 1 INTO v_sequence
    FROM domain_events
    WHERE aggregate_type = p_aggregate_type AND aggregate_id = p_aggregate_id;

    INSERT INTO domain_events (aggregate_type, aggregate_id, event_type, event_data, sequence_number)
    VALUES (p_aggregate_type, p_aggregate_id, p_event_type, p_event_data, v_sequence)
    RETURNING event_id INTO v_event_id;

    -- é€šçŸ¥è®¢é˜…è€…ï¼ˆPostgreSQL NOTIFYï¼‰
    PERFORM pg_notify('domain_events', json_build_object(
        'event_id', v_event_id,
        'aggregate_type', p_aggregate_type,
        'event_type', p_event_type
    )::TEXT);

    RETURN v_event_id;
END;
$$ LANGUAGE plpgsql;
```

---

## 5. éœ€æ±‚åˆ†æä¸å»ºæ¨¡

### 5.1. éœ€æ±‚æ”¶é›†æ–¹æ³•

**éœ€æ±‚æ”¶é›†æ–¹æ³•å¯¹æ¯”**ï¼š

| æ–¹æ³• | æè¿° | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|------|---------|
| **è®¿è°ˆ** | ä¸åˆ©ç›Šç›¸å…³è€…é¢è°ˆ | æ·±å…¥ç†è§£ | è€—æ—¶ | å¤æ‚ä¸šåŠ¡ |
| **é—®å·** | æ ‡å‡†åŒ–é—®é¢˜æ”¶é›† | è§„æ¨¡åŒ– | æ·±åº¦ä¸è¶³ | å¤§èŒƒå›´è°ƒç ” |
| **è§‚å¯Ÿ** | è§‚å¯Ÿç°æœ‰ç³»ç»Ÿä½¿ç”¨ | å‘ç°éšæ€§éœ€æ±‚ | ä¸»è§‚æ€§ | ç°æœ‰ç³»ç»Ÿæ”¹é€  |
| **åŸå‹** | å¿«é€ŸåŸå‹éªŒè¯ | ç›´è§‚ | å¯èƒ½è¯¯å¯¼ | æ–°ç³»ç»Ÿè®¾è®¡ |
| **äº‹ä»¶é£æš´** | é¢†åŸŸä¸“å®¶åä½œ | å…¨é¢ | éœ€è¦æŠ€å·§ | DDDé¡¹ç›® |

### 5.2. éœ€æ±‚åˆ†æå†³ç­–æ ‘

```mermaid
flowchart TD
    A[éœ€æ±‚åˆ†æ] --> B{éœ€æ±‚ç±»å‹}

    B -->|ä¸šåŠ¡éœ€æ±‚| C[ä¸šåŠ¡æµç¨‹åˆ†æ]
    B -->|åŠŸèƒ½éœ€æ±‚| D[åŠŸèƒ½ç‚¹åˆ†æ]
    B -->|æ€§èƒ½éœ€æ±‚| E[æ€§èƒ½æŒ‡æ ‡åˆ†æ]
    B -->|å®‰å…¨éœ€æ±‚| F[å®‰å…¨è¦æ±‚åˆ†æ]

    C --> G[è¯†åˆ«ä¸šåŠ¡å®ä½“]
    D --> H[è¯†åˆ«æ•°æ®æ“ä½œ]
    E --> I[è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ]
    F --> J[è¯†åˆ«æ•æ„Ÿæ•°æ®]

    G --> K[å®ä½“å…³ç³»å»ºæ¨¡]
    H --> L[æ“ä½œå»ºæ¨¡]
    I --> M[æ€§èƒ½å»ºæ¨¡]
    J --> N[å®‰å…¨å»ºæ¨¡]

    K --> O[éœ€æ±‚æ–‡æ¡£]
    L --> O
    M --> O
    N --> O
```

### 5.3. éœ€æ±‚å»ºæ¨¡æ–¹æ³•

**ç”¨ä¾‹å»ºæ¨¡**ï¼š

```text
ç”¨ä¾‹ï¼šç”¨æˆ·æ³¨å†Œ
å‰ç½®æ¡ä»¶ï¼šç”¨æˆ·æœªæ³¨å†Œ
ä¸»æµç¨‹ï¼š
  1. ç”¨æˆ·è¾“å…¥æ³¨å†Œä¿¡æ¯
  2. ç³»ç»ŸéªŒè¯ä¿¡æ¯
  3. åˆ›å»ºç”¨æˆ·è®°å½•
  4. å‘é€ç¡®è®¤é‚®ä»¶
åç½®æ¡ä»¶ï¼šç”¨æˆ·è®°å½•å·²åˆ›å»º

æ•°æ®éœ€æ±‚ï¼š
  - ç”¨æˆ·è¡¨ï¼šid, username, email, password_hash, created_at
  - éªŒè¯è§„åˆ™ï¼šemailå”¯ä¸€ï¼Œusernameå”¯ä¸€
```

**æ•°æ®æµå»ºæ¨¡**ï¼š

```mermaid
flowchart LR
    A[ç”¨æˆ·è¾“å…¥] --> B[éªŒè¯æ¨¡å—]
    B --> C[ç”¨æˆ·è¡¨]
    C --> D[é‚®ä»¶æœåŠ¡]
    D --> E[é€šçŸ¥ç”¨æˆ·]
```

### 5.4. äº‹ä»¶é£æš´ä¸æ•°æ®å»ºæ¨¡

```mermaid
flowchart LR
    subgraph äº‹ä»¶é£æš´äº§å‡º
        E1[é¢†åŸŸäº‹ä»¶]
        C1[å‘½ä»¤]
        A1[èšåˆ]
        P1[ç­–ç•¥]
        R1[è¯»æ¨¡å‹]
    end

    subgraph Schemaè®¾è®¡
        T1[äº‹ä»¶å­˜å‚¨è¡¨]
        T2[å‘½ä»¤è¡¨]
        T3[èšåˆè¡¨]
        T4[ç‰©åŒ–è§†å›¾]
        T5[æŸ¥è¯¢è¡¨]
    end

    E1 --> T1
    C1 --> T2
    A1 --> T3
    P1 --> T4
    R1 --> T5
```

---

## 6. æ¦‚å¿µæ¨¡å‹è®¾è®¡

### 6.1. å®ä½“è¯†åˆ«

**å®ä½“è¯†åˆ«æ–¹æ³•**ï¼š

1. **åè¯è¯†åˆ«æ³•**ï¼šä»éœ€æ±‚æ–‡æ¡£ä¸­æå–åè¯ä½œä¸ºå€™é€‰å®ä½“
2. **ä¸šåŠ¡å¯¹è±¡æ³•**ï¼šè¯†åˆ«ä¸šåŠ¡ä¸­çš„æ ¸å¿ƒå¯¹è±¡
3. **æ•°æ®æµæ³•**ï¼šä»æ•°æ®æµä¸­è¯†åˆ«æ•°æ®å­˜å‚¨ç‚¹
4. **DDDæ–¹æ³•**ï¼šé€šè¿‡äº‹ä»¶é£æš´è¯†åˆ«èšåˆæ ¹

**å®ä½“è¯†åˆ«å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[è¯†åˆ«å€™é€‰å®ä½“] --> B{æ˜¯ä¸šåŠ¡å¯¹è±¡?}
    B -->|æ˜¯| C{æœ‰ç‹¬ç«‹å­˜åœ¨æ€§?}
    B -->|å¦| D[æ’é™¤]

    C -->|æ˜¯| E{æœ‰å±æ€§?}
    C -->|å¦| D

    E -->|æ˜¯| F{æœ‰å”¯ä¸€æ ‡è¯†?}
    E -->|å¦| G{æ˜¯å€¼å¯¹è±¡?}

    F -->|æ˜¯| H[ç¡®è®¤ä¸ºå®ä½“]
    F -->|å¦| I[æ·»åŠ ä»£ç†é”®]

    G -->|æ˜¯| J[ä½œä¸ºå€¼å¯¹è±¡]
    G -->|å¦| D

    H --> K[å®šä¹‰å®ä½“å±æ€§]
    I --> K
    J --> L[åµŒå…¥çˆ¶å®ä½“]
```

### 6.2. å…³ç³»è¯†åˆ«

**å…³ç³»ç±»å‹**ï¼š

1. **ä¸€å¯¹ä¸€ï¼ˆ1:1ï¼‰**ï¼šæ¯ä¸ªå®ä½“å®ä¾‹åªä¸å¦ä¸€ä¸ªå®ä½“å®ä¾‹å…³è”
2. **ä¸€å¯¹å¤šï¼ˆ1:Nï¼‰**ï¼šä¸€ä¸ªå®ä½“å®ä¾‹ä¸å¤šä¸ªå¦ä¸€ä¸ªå®ä½“å®ä¾‹å…³è”
3. **å¤šå¯¹å¤šï¼ˆM:Nï¼‰**ï¼šå¤šä¸ªå®ä½“å®ä¾‹ä¸å¤šä¸ªå¦ä¸€ä¸ªå®ä½“å®ä¾‹å…³è”

**å…³ç³»è¯†åˆ«å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[è¯†åˆ«å®ä½“å…³ç³»] --> B{å…³ç³»åŸºæ•°}

    B -->|1:1| C[ä¸€å¯¹ä¸€å…³ç³»]
    B -->|1:N| D[ä¸€å¯¹å¤šå…³ç³»]
    B -->|M:N| E[å¤šå¯¹å¤šå…³ç³»]

    C --> F{éœ€è¦ç‹¬ç«‹è¡¨?}
    F -->|æ˜¯| G[åˆ›å»ºå…³è”è¡¨]
    F -->|å¦| H[å¤–é”®å…³ç³»]

    D --> I[å¤–é”®å…³ç³»]
    E --> G

    G --> J[å®šä¹‰å…³ç³»å±æ€§]
    H --> K[å®šä¹‰å¤–é”®]
    I --> K
```

### 6.3. ERå›¾è®¾è®¡

**ERå›¾ç¤ºä¾‹**ï¼š

```mermaid
erDiagram
    USER ||--o{ ORDER : places
    ORDER ||--|{ ORDER_ITEM : contains
    PRODUCT ||--o{ ORDER_ITEM : "included in"
    USER ||--o{ ADDRESS : has
    ORDER }|--|| ADDRESS : "ships to"

    USER {
        uuid id PK
        string username UK
        string email UK
        string password_hash
        jsonb profile
        timestamp created_at
        timestamp updated_at
    }

    ORDER {
        uuid id PK
        uuid user_id FK
        string order_number UK
        decimal total
        string status
        integer version
        timestamp order_date
        timestamp created_at
    }

    PRODUCT {
        uuid id PK
        string sku UK
        string name
        text description
        decimal price
        integer stock
        jsonb specifications
        timestamp created_at
    }

    ORDER_ITEM {
        uuid id PK
        uuid order_id FK
        uuid product_id FK
        integer quantity
        decimal unit_price
        jsonb product_snapshot
    }

    ADDRESS {
        uuid id PK
        uuid user_id FK
        string type
        string street
        string city
        string state
        string zip
        string country
        boolean is_default
    }
```

### 6.4. æ¦‚å¿µæ¨¡å‹å½¢å¼åŒ–éªŒè¯

**éªŒè¯æ£€æŸ¥æ¸…å•**ï¼š

| æ£€æŸ¥é¡¹ | éªŒè¯æ–¹æ³• | é€šè¿‡æ¡ä»¶ |
|-------|---------|---------|
| **å®ä½“å®Œæ•´æ€§** | æ¯ä¸ªå®ä½“æœ‰å”¯ä¸€æ ‡è¯† | æ‰€æœ‰å®ä½“æœ‰PK |
| **å…³ç³»å®Œæ•´æ€§** | å…³ç³»æœ‰æ˜ç¡®åŸºæ•° | æ‰€æœ‰å…³ç³»æ ‡æ³¨åŸºæ•° |
| **å±æ€§å®Œæ•´æ€§** | å±æ€§å½’å±æ˜ç¡® | æ— æ‚¬æŒ‚å±æ€§ |
| **ä¸šåŠ¡è§„åˆ™è¦†ç›–** | ä¸šåŠ¡çº¦æŸå¯è¡¨è¾¾ | çº¦æŸå¯æ˜ å°„ |
| **æ— å†—ä½™å®ä½“** | æ— é‡å¤æ¦‚å¿µ | å®ä½“å”¯ä¸€ |

---

## 7. é€»è¾‘æ¨¡å‹è®¾è®¡

### 7.1. è¡¨è®¾è®¡åŸåˆ™

**è¡¨è®¾è®¡åŸåˆ™**ï¼š

1. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªè¡¨åªè¡¨ç¤ºä¸€ä¸ªå®ä½“æˆ–å…³ç³»
2. **è§„èŒƒåŒ–**ï¼šéµå¾ªèŒƒå¼ç†è®ºï¼Œæ¶ˆé™¤å†—ä½™
3. **å®Œæ•´æ€§**ï¼šå®šä¹‰é€‚å½“çš„çº¦æŸä¿è¯æ•°æ®å®Œæ•´æ€§
4. **å¯æ‰©å±•æ€§**ï¼šè€ƒè™‘æœªæ¥éœ€æ±‚å˜åŒ–
5. **å‘½åä¸€è‡´æ€§**ï¼šéµå¾ªå‘½åè§„èŒƒ

**å‘½åè§„èŒƒ**ï¼š

| å¯¹è±¡ç±»å‹ | å‘½åè§„åˆ™ | ç¤ºä¾‹ |
|---------|---------|------|
| **è¡¨å** | snake_caseå¤æ•° | `users`, `order_items` |
| **åˆ—å** | snake_case | `created_at`, `user_id` |
| **ä¸»é”®** | `id` æˆ– `{table}_id` | `id`, `user_id` |
| **å¤–é”®** | `{referenced_table}_id` | `user_id`, `order_id` |
| **ç´¢å¼•** | `idx_{table}_{columns}` | `idx_orders_user_id` |
| **å”¯ä¸€çº¦æŸ** | `uk_{table}_{columns}` | `uk_users_email` |
| **æ£€æŸ¥çº¦æŸ** | `chk_{table}_{description}` | `chk_orders_status` |

### 7.2. è¡¨è®¾è®¡å†³ç­–æ ‘

```mermaid
flowchart TD
    A[è¡¨è®¾è®¡] --> B[ç¡®å®šè¡¨å]
    B --> C[è¯†åˆ«å±æ€§]
    C --> D[é€‰æ‹©ä¸»é”®]

    D --> E{ä¸»é”®ç±»å‹}
    E -->|å•å±æ€§| F[è‡ªç„¶é”®/ä»£ç†é”®]
    E -->|å¤šå±æ€§| G[å¤åˆä¸»é”®]

    F --> H[å®šä¹‰å¤–é”®]
    G --> H

    H --> I[å®šä¹‰çº¦æŸ]
    I --> J[å®šä¹‰ç´¢å¼•]

    J --> K{æ»¡è¶³èŒƒå¼?}
    K -->|å¦| L[è§„èŒƒåŒ–]
    K -->|æ˜¯| M[è¡¨è®¾è®¡å®Œæˆ]

    L --> C
```

### 7.3. é”®è®¾è®¡ç­–ç•¥

**ä¸»é”®é€‰æ‹©ç­–ç•¥**ï¼š

| ç­–ç•¥ | ç±»å‹ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|------|---------|
| **UUID** | ä»£ç†é”® | å…¨å±€å”¯ä¸€ã€åˆ†å¸ƒå¼å‹å¥½ | å­˜å‚¨å¤§ã€æ— åº | åˆ†å¸ƒå¼ç³»ç»Ÿ |
| **ULID** | ä»£ç†é”® | æœ‰åºUUIDã€å¯æ’åº | éæ ‡å‡† | éœ€è¦æ’åºçš„åˆ†å¸ƒå¼ |
| **è‡ªå¢ID** | ä»£ç†é”® | ç®€å•ã€æœ‰åºã€ç´§å‡‘ | å•ç‚¹ã€å¯é¢„æµ‹ | å•æœºOLTP |
| **é›ªèŠ±ID** | ä»£ç†é”® | æœ‰åºã€åˆ†å¸ƒå¼ | æ—¶é’Ÿä¾èµ– | é«˜å¹¶å‘åˆ†å¸ƒå¼ |
| **è‡ªç„¶é”®** | è‡ªç„¶é”® | æœ‰ä¸šåŠ¡æ„ä¹‰ | å¯èƒ½å˜åŒ– | ç¨³å®šä¸šåŠ¡æ ‡è¯† |
| **å¤åˆé”®** | å¤åˆé”® | åæ˜ ä¸šåŠ¡å…³ç³» | å¤æ‚ | å…³è”è¡¨ |

**ä¸»é”®é€‰æ‹©å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[é€‰æ‹©ä¸»é”®ç­–ç•¥] --> B{ç³»ç»Ÿæ¶æ„?}

    B -->|å•æœº| C{æ•°æ®è§„æ¨¡?}
    B -->|åˆ†å¸ƒå¼| D{æ’åºéœ€æ±‚?}

    C -->|å°| E[è‡ªå¢ID]
    C -->|å¤§| F{éœ€è¦åˆ†åº“?}

    D -->|éœ€è¦| G[ULID/é›ªèŠ±ID]
    D -->|ä¸éœ€è¦| H[UUID]

    F -->|æ˜¯| G
    F -->|å¦| E

    E --> I{æœ‰ç¨³å®šä¸šåŠ¡æ ‡è¯†?}
    G --> I
    H --> I

    I -->|æ˜¯| J[è€ƒè™‘è‡ªç„¶é”®+ä»£ç†é”®]
    I -->|å¦| K[ä½¿ç”¨ä»£ç†é”®]
```

**å¤–é”®è®¾è®¡ç¤ºä¾‹**ï¼š

```sql
-- å¤–é”®çº¦æŸç¤ºä¾‹
CREATE TABLE orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    shipping_address_id UUID,
    order_date TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,

    -- å¼ºå¤–é”®ï¼ˆç”¨æˆ·å¿…é¡»å­˜åœ¨ï¼‰
    CONSTRAINT fk_orders_user
        FOREIGN KEY (user_id) REFERENCES users(id)
        ON DELETE RESTRICT      -- é˜»æ­¢åˆ é™¤æœ‰è®¢å•çš„ç”¨æˆ·
        ON UPDATE CASCADE,      -- çº§è”æ›´æ–°

    -- å¯ç©ºå¤–é”®ï¼ˆåœ°å€å¯é€‰ï¼‰
    CONSTRAINT fk_orders_address
        FOREIGN KEY (shipping_address_id) REFERENCES addresses(id)
        ON DELETE SET NULL      -- åˆ é™¤åœ°å€æ—¶ç½®ç©º
        ON UPDATE CASCADE
);

-- å¤–é”®ç´¢å¼•ï¼ˆé‡è¦ï¼ï¼‰
CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_address_id ON orders(shipping_address_id);
```

### 7.4. èŒƒå¼åŒ–å†³ç­–

**èŒƒå¼é€‰æ‹©å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[èŒƒå¼åŒ–å†³ç­–] --> B[æ£€æŸ¥1NF]
    B --> C{æ»¡è¶³1NF?}
    C -->|å¦| D[è§„èŒƒåŒ–åˆ°1NF]
    C -->|æ˜¯| E[æ£€æŸ¥2NF]

    D --> E
    E --> F{æ»¡è¶³2NF?}
    F -->|å¦| G[è§„èŒƒåŒ–åˆ°2NF]
    F -->|æ˜¯| H[æ£€æŸ¥3NF]

    G --> H
    H --> I{æ»¡è¶³3NF?}
    I -->|å¦| J[è§„èŒƒåŒ–åˆ°3NF]
    I -->|æ˜¯| K{éœ€è¦BCNF?}

    J --> K
    K -->|æ˜¯| L[æ£€æŸ¥BCNF]
    K -->|å¦| M[è®¾è®¡å®Œæˆ]

    L --> N{æ»¡è¶³BCNF?}
    N -->|å¦| O[è§„èŒƒåŒ–åˆ°BCNF]
    N -->|æ˜¯| M

    O --> M
```

### 7.5. åèŒƒå¼åŒ–ç­–ç•¥

**åèŒƒå¼åŒ–å†³ç­–çŸ©é˜µ**ï¼š

| åœºæ™¯ | åèŒƒå¼åŒ–ç­–ç•¥ | ä¼˜ç‚¹ | ä»£ä»· | å»ºè®® |
|------|-------------|------|------|------|
| **é¢‘ç¹JOIN** | åˆå¹¶è¡¨ | å‡å°‘JOIN | å†—ä½™ | è¯»å¤šå†™å°‘ |
| **è®¡ç®—å­—æ®µ** | é¢„è®¡ç®—åˆ— | é¿å…è®¡ç®— | åŒæ­¥ | å¤æ‚è®¡ç®— |
| **èšåˆæŸ¥è¯¢** | æ±‡æ€»è¡¨ | å¿«é€Ÿèšåˆ | å­˜å‚¨ | æŠ¥è¡¨åœºæ™¯ |
| **å†å²å¿«ç…§** | å†—ä½™å¿«ç…§ | æ—¶é—´æ—…è¡Œ | å­˜å‚¨ | å®¡è®¡éœ€æ±‚ |
| **å±‚æ¬¡æ•°æ®** | ç‰©åŒ–è·¯å¾„ | å¿«é€ŸæŸ¥è¯¢ | æ›´æ–°å¤æ‚ | æ ‘å½¢ç»“æ„ |

**åèŒƒå¼åŒ–ç¤ºä¾‹**ï¼š

```sql
-- åœºæ™¯ï¼šè®¢å•åˆ—è¡¨éœ€è¦æ˜¾ç¤ºç”¨æˆ·åå’Œäº§å“å
-- èŒƒå¼åŒ–è®¾è®¡éœ€è¦3è¡¨JOIN

-- åèŒƒå¼åŒ–æ–¹æ¡ˆ1ï¼šå†—ä½™å­—æ®µ
CREATE TABLE order_items_denormalized (
    id UUID PRIMARY KEY,
    order_id UUID NOT NULL REFERENCES orders(id),
    product_id UUID NOT NULL REFERENCES products(id),

    -- å†—ä½™å­—æ®µï¼ˆæŸ¥è¯¢ä¼˜åŒ–ï¼‰
    product_name VARCHAR(200) NOT NULL,     -- å†—ä½™
    product_sku VARCHAR(50) NOT NULL,       -- å†—ä½™

    quantity INTEGER NOT NULL,
    unit_price DECIMAL(10,2) NOT NULL,

    -- åŒæ­¥è§¦å‘å™¨ç»´æŠ¤å†—ä½™å­—æ®µ
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- åŒæ­¥è§¦å‘å™¨
CREATE OR REPLACE FUNCTION sync_order_item_product()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' OR TG_OP = 'UPDATE' THEN
        SELECT name, sku INTO NEW.product_name, NEW.product_sku
        FROM products WHERE id = NEW.product_id;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_sync_product
BEFORE INSERT OR UPDATE ON order_items_denormalized
FOR EACH ROW EXECUTE FUNCTION sync_order_item_product();

-- åèŒƒå¼åŒ–æ–¹æ¡ˆ2ï¼šç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW mv_order_details AS
SELECT
    o.id AS order_id,
    o.order_number,
    o.status,
    u.username,
    u.email,
    oi.product_id,
    p.name AS product_name,
    oi.quantity,
    oi.unit_price,
    (oi.quantity * oi.unit_price) AS line_total
FROM orders o
JOIN users u ON o.user_id = u.id
JOIN order_items oi ON o.id = oi.order_id
JOIN products p ON oi.product_id = p.id;

-- åˆ·æ–°ç‰©åŒ–è§†å›¾
CREATE UNIQUE INDEX idx_mv_order_details ON mv_order_details(order_id, product_id);
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_order_details;
```

---

## 8. ç‰©ç†æ¨¡å‹è®¾è®¡

### 8.1. æ•°æ®ç±»å‹é€‰æ‹©

**æ•°æ®ç±»å‹é€‰æ‹©å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[é€‰æ‹©æ•°æ®ç±»å‹] --> B{æ•°æ®ç‰¹æ€§}

    B -->|æ•´æ•°| C{æ•°å€¼èŒƒå›´}
    B -->|å°æ•°| D{ç²¾åº¦è¦æ±‚}
    B -->|æ–‡æœ¬| E{é•¿åº¦/ç”¨é€”}
    B -->|æ—¥æœŸæ—¶é—´| F{ç²¾åº¦/æ—¶åŒº}
    B -->|å¸ƒå°”| G[BOOLEAN]
    B -->|äºŒè¿›åˆ¶| H[BYTEA]
    B -->|ç»“æ„åŒ–| I{æŸ¥è¯¢éœ€æ±‚}

    C -->|â‰¤32767| J[SMALLINT]
    C -->|â‰¤2B| K[INTEGER]
    C -->|>2B| L[BIGINT]

    D -->|ç²¾ç¡®è®¡ç®—| M[NUMERIC/DECIMAL]
    D -->|ç§‘å­¦è®¡ç®—| N[REAL/DOUBLE]

    E -->|å®šé•¿| O[CHAR]
    E -->|å˜é•¿â‰¤1000| P[VARCHAR]
    E -->|é•¿æ–‡æœ¬| Q[TEXT]
    E -->|å…¨æ–‡æœç´¢| R[TEXT + tsvector]

    F -->|ä»…æ—¥æœŸ| S[DATE]
    F -->|æ— æ—¶åŒº| T[TIMESTAMP]
    F -->|æœ‰æ—¶åŒº| U[TIMESTAMPTZ]

    I -->|æ·±åº¦æŸ¥è¯¢| V[JSONB]
    I -->|å­˜å‚¨ä¸ºä¸»| W[JSON]
    I -->|æ•°ç»„| X[ARRAY]
```

### 8.2. æ•°æ®ç±»å‹é€‰æ‹©å†³ç­–çŸ©é˜µ

| æ•°æ®ç±»å‹ | å­˜å‚¨å¤§å° | èŒƒå›´/ç²¾åº¦ | é€‚ç”¨åœºæ™¯ | PostgreSQLç±»å‹ |
|---------|---------|----------|---------|---------------|
| **å°æ•´æ•°** | 2å­—èŠ‚ | -32768~32767 | çŠ¶æ€ç ã€æšä¸¾ | SMALLINT |
| **æ•´æ•°** | 4å­—èŠ‚ | Â±2.1B | æ™®é€šIDã€è®¡æ•° | INTEGER |
| **å¤§æ•´æ•°** | 8å­—èŠ‚ | Â±9.2E18 | å¤§IDã€æ—¶é—´æˆ³ | BIGINT |
| **ç²¾ç¡®å°æ•°** | å¯å˜ | ä»»æ„ç²¾åº¦ | é‡‘é¢ã€æ¯”ç‡ | NUMERIC(p,s) |
| **æµ®ç‚¹æ•°** | 4/8å­—èŠ‚ | çº¦6/15ä½ | ç§‘å­¦è®¡ç®— | REAL/DOUBLE |
| **å®šé•¿å­—ç¬¦** | nå­—èŠ‚ | å›ºå®šé•¿åº¦ | ä»£ç ã€ç¼–ç  | CHAR(n) |
| **å˜é•¿å­—ç¬¦** | 1+nå­—èŠ‚ | æœ€å¤§1GB | åç§°ã€æè¿° | VARCHAR(n)/TEXT |
| **æ—¥æœŸ** | 4å­—èŠ‚ | 4713BC-5874897AD | ç”Ÿæ—¥ã€æ—¥æœŸ | DATE |
| **æ—¶é—´æˆ³** | 8å­—èŠ‚ | å¾®ç§’ç²¾åº¦ | åˆ›å»ºæ—¶é—´ | TIMESTAMP |
| **å¸¦æ—¶åŒºæ—¶é—´æˆ³** | 8å­—èŠ‚ | å¾®ç§’ç²¾åº¦+æ—¶åŒº | å›½é™…åŒ–æ—¶é—´ | TIMESTAMPTZ |
| **UUID** | 16å­—èŠ‚ | 128ä½ | åˆ†å¸ƒå¼ID | UUID |
| **JSON** | å¯å˜ | ä»»æ„JSON | çµæ´»ç»“æ„ | JSONB |

### 8.3. ç´¢å¼•è®¾è®¡

**ç´¢å¼•è®¾è®¡åŸåˆ™**ï¼š

1. **ä¸»é”®ç´¢å¼•**ï¼šè‡ªåŠ¨åˆ›å»ºï¼Œæ— éœ€æ‰‹åŠ¨åˆ›å»º
2. **å¤–é”®ç´¢å¼•**ï¼šé€šå¸¸éœ€è¦åˆ›å»ºä»¥æé«˜è¿æ¥æ€§èƒ½
3. **æŸ¥è¯¢ç´¢å¼•**ï¼šä¸ºé¢‘ç¹æŸ¥è¯¢çš„åˆ—åˆ›å»ºç´¢å¼•
4. **å¤åˆç´¢å¼•**ï¼šè€ƒè™‘æŸ¥è¯¢æ¨¡å¼ï¼Œæœ€å·¦å‰ç¼€åŸåˆ™
5. **éƒ¨åˆ†ç´¢å¼•**ï¼šåªç´¢å¼•éƒ¨åˆ†æ•°æ®ï¼Œå‡å°‘å­˜å‚¨

**ç´¢å¼•è®¾è®¡å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[ç´¢å¼•è®¾è®¡] --> B{åˆ—ç”¨é€”}

    B -->|ä¸»é”®| C[è‡ªåŠ¨B-Tree]
    B -->|å¤–é”®| D[åˆ›å»ºB-Tree]
    B -->|ç­‰å€¼æŸ¥è¯¢| E{é€‰æ‹©æ€§?}
    B -->|èŒƒå›´æŸ¥è¯¢| F[B-Tree]
    B -->|å…¨æ–‡æœç´¢| G[GIN + tsvector]
    B -->|JSONæŸ¥è¯¢| H[GIN]
    B -->|åœ°ç†ç©ºé—´| I[GiST/SP-GiST]
    B -->|å‘é‡ç›¸ä¼¼| J[HNSW/IVFFlat]

    E -->|é«˜>10%| K[åˆ›å»ºB-Tree]
    E -->|ä½<10%| L[è€ƒè™‘éƒ¨åˆ†ç´¢å¼•]

    D --> M[åˆ†ææŸ¥è¯¢æ¨¡å¼]
    K --> M
    L --> M
    F --> M

    M --> N{éœ€è¦å¤åˆç´¢å¼•?}
    N -->|æ˜¯| O[è®¾è®¡å¤åˆç´¢å¼•]
    N -->|å¦| P[å®Œæˆ]

    O --> Q[ç¡®å®šåˆ—é¡ºåº]
    Q --> R{éœ€è¦è¦†ç›–ç´¢å¼•?}
    R -->|æ˜¯| S[INCLUDEåˆ—]
    R -->|å¦| P
    S --> P
```

### 8.4. ç´¢å¼•ç±»å‹å¯¹æ¯”çŸ©é˜µ

| ç´¢å¼•ç±»å‹ | é€‚ç”¨æ“ä½œ | ä¼˜ç‚¹ | ç¼ºç‚¹ | PostgreSQLè¯­æ³• |
|---------|---------|------|------|---------------|
| **B-Tree** | =, <, >, BETWEEN | é€šç”¨ã€æœ‰åº | ä¸é€‚åˆæ•°ç»„ | é»˜è®¤ |
| **Hash** | = | ç­‰å€¼å¿« | ä»…ç­‰å€¼ | USING hash |
| **GIN** | æ•°ç»„ã€JSONã€å…¨æ–‡ | å¤šå€¼é«˜æ•ˆ | å†™å…¥æ…¢ | USING gin |
| **GiST** | å‡ ä½•ã€èŒƒå›´ã€å…¨æ–‡ | çµæ´» | ç²¾åº¦æŸå¤± | USING gist |
| **SP-GiST** | éå¹³è¡¡ç»“æ„ | ç‰¹å®šæ•°æ®é«˜æ•ˆ | åœºæ™¯é™åˆ¶ | USING spgist |
| **BRIN** | å¤§è¡¨èŒƒå›´ | å­˜å‚¨å° | ç²¾åº¦ä½ | USING brin |
| **HNSW** | å‘é‡ç›¸ä¼¼ | ANNé«˜æ•ˆ | å†…å­˜å¤§ | USING hnsw |

**ç´¢å¼•è®¾è®¡ç¤ºä¾‹**ï¼š

```sql
-- å•åˆ—ç´¢å¼•
CREATE INDEX idx_users_email ON users(email);

-- å¤åˆç´¢å¼•ï¼ˆè€ƒè™‘æŸ¥è¯¢æ¨¡å¼å’Œåˆ—é¡ºåºï¼‰
CREATE INDEX idx_orders_user_status_date
ON orders(user_id, status, order_date DESC);

-- éƒ¨åˆ†ç´¢å¼•ï¼ˆåªç´¢å¼•æ´»è·ƒæ•°æ®ï¼‰
CREATE INDEX idx_orders_active
ON orders(user_id, order_date)
WHERE status NOT IN ('CANCELLED', 'COMPLETED');

-- è¦†ç›–ç´¢å¼•ï¼ˆé¿å…å›è¡¨ï¼‰
CREATE INDEX idx_orders_covering
ON orders(user_id, order_date)
INCLUDE (status, total);

-- è¡¨è¾¾å¼ç´¢å¼•
CREATE INDEX idx_users_email_lower ON users(LOWER(email));

-- GINç´¢å¼•ï¼ˆJSONBï¼‰
CREATE INDEX idx_products_specs ON products USING gin(specifications);

-- å…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_products_search
ON products USING gin(to_tsvector('english', name || ' ' || description));
```

### 8.5. åˆ†åŒºè®¾è®¡

**åˆ†åŒºç­–ç•¥**ï¼š

| åˆ†åŒºç±»å‹ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ | PostgreSQLè¯­æ³• |
|---------|---------|------|------|---------------|
| **èŒƒå›´åˆ†åŒº** | æ—¶é—´åºåˆ— | æŸ¥è¯¢æ€§èƒ½å¥½ | æ•°æ®åˆ†å¸ƒä¸å‡ | PARTITION BY RANGE |
| **åˆ—è¡¨åˆ†åŒº** | ç¦»æ•£å€¼ | ç®€å•ç›´è§‚ | åˆ†åŒºæ•°é‡é™åˆ¶ | PARTITION BY LIST |
| **å“ˆå¸Œåˆ†åŒº** | å‡åŒ€åˆ†å¸ƒ | è´Ÿè½½å‡è¡¡ | èŒƒå›´æŸ¥è¯¢å·® | PARTITION BY HASH |

**åˆ†åŒºè®¾è®¡ç¤ºä¾‹**ï¼š

```sql
-- èŒƒå›´åˆ†åŒºï¼šæŒ‰æœˆåˆ†åŒºè®¢å•è¡¨
CREATE TABLE orders_partitioned (
    id UUID NOT NULL,
    user_id UUID NOT NULL,
    order_date TIMESTAMPTZ NOT NULL,
    total DECIMAL(10,2),
    status VARCHAR(20),
    PRIMARY KEY (id, order_date)
) PARTITION BY RANGE (order_date);

-- åˆ›å»ºåˆ†åŒº
CREATE TABLE orders_2024_01 PARTITION OF orders_partitioned
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
CREATE TABLE orders_2024_02 PARTITION OF orders_partitioned
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');
-- ... æ›´å¤šåˆ†åŒº

-- è‡ªåŠ¨åˆ†åŒºç®¡ç†å‡½æ•°
CREATE OR REPLACE FUNCTION create_orders_partition(p_date DATE)
RETURNS VOID AS $$
DECLARE
    v_partition_name TEXT;
    v_start_date DATE;
    v_end_date DATE;
BEGIN
    v_start_date := DATE_TRUNC('month', p_date);
    v_end_date := v_start_date + INTERVAL '1 month';
    v_partition_name := 'orders_' || TO_CHAR(v_start_date, 'YYYY_MM');

    EXECUTE format(
        'CREATE TABLE IF NOT EXISTS %I PARTITION OF orders_partitioned
         FOR VALUES FROM (%L) TO (%L)',
        v_partition_name, v_start_date, v_end_date
    );
END;
$$ LANGUAGE plpgsql;

-- åˆ—è¡¨åˆ†åŒºï¼šæŒ‰åœ°åŒºåˆ†åŒº
CREATE TABLE users_by_region (
    id UUID NOT NULL,
    region VARCHAR(10) NOT NULL,
    username VARCHAR(50),
    PRIMARY KEY (id, region)
) PARTITION BY LIST (region);

CREATE TABLE users_us PARTITION OF users_by_region FOR VALUES IN ('US');
CREATE TABLE users_eu PARTITION OF users_by_region FOR VALUES IN ('EU', 'UK');
CREATE TABLE users_asia PARTITION OF users_by_region FOR VALUES IN ('CN', 'JP', 'KR');
```

---

## 9. Schemaä¼˜åŒ–ä¸é‡æ„

### 9.1. æ€§èƒ½ä¼˜åŒ–

**æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**ï¼š

```mermaid
flowchart TD
    A[æ€§èƒ½é—®é¢˜] --> B{é—®é¢˜ç±»å‹}

    B -->|æŸ¥è¯¢æ…¢| C[æŸ¥è¯¢ä¼˜åŒ–]
    B -->|å†™å…¥æ…¢| D[å†™å…¥ä¼˜åŒ–]
    B -->|é”ç«äº‰| E[å¹¶å‘ä¼˜åŒ–]
    B -->|å­˜å‚¨å¤§| F[å­˜å‚¨ä¼˜åŒ–]

    C --> C1[æ·»åŠ ç´¢å¼•]
    C --> C2[ä¼˜åŒ–SQL]
    C --> C3[ç‰©åŒ–è§†å›¾]
    C --> C4[åˆ†åŒºå‰ªæ]

    D --> D1[æ‰¹é‡å†™å…¥]
    D --> D2[å»¶è¿Ÿç´¢å¼•]
    D --> D3[å¼‚æ­¥å†™å…¥]
    D --> D4[åˆ†åŒº]

    E --> E1[å‡å°äº‹åŠ¡]
    E --> E2[ä¹è§‚é”]
    E --> E3[åˆ†åŒºéš”ç¦»]

    F --> F1[æ•°æ®å½’æ¡£]
    F --> F2[å‹ç¼©]
    F --> F3[åˆ—å­˜å‚¨]
```

### 9.2. Schemaé‡æ„

**é‡æ„å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[Schemaé‡æ„] --> B{é‡æ„åŸå› }

    B -->|æ€§èƒ½é—®é¢˜| C[æ€§èƒ½ä¼˜åŒ–]
    B -->|éœ€æ±‚å˜åŒ–| D[ç»“æ„è°ƒæ•´]
    B -->|æ•°æ®è´¨é‡| E[è§„èŒƒåŒ–]
    B -->|æŠ€æœ¯å€ºåŠ¡| F[æ¶æ„å‡çº§]

    C --> G[åˆ†æç“¶é¢ˆ]
    D --> H[è¯„ä¼°å½±å“]
    E --> I[æ•°æ®æ¸…ç†]
    F --> J[è¿ç§»è§„åˆ’]

    G --> K[å®æ–½æ–¹æ¡ˆ]
    H --> K
    I --> K
    J --> K

    K --> L{åœ¨çº¿è¿ç§»?}
    L -->|æ˜¯| M[é›¶åœæœºè¿ç§»]
    L -->|å¦| N[è®¡åˆ’åœæœº]

    M --> O[éªŒè¯æµ‹è¯•]
    N --> O
    O --> P{æˆåŠŸ?}
    P -->|æ˜¯| Q[å®Œæˆ]
    P -->|å¦| R[å›æ»š]
```

### 9.3. é›¶åœæœºè¿ç§»ç­–ç•¥

**è¿ç§»æ¨¡å¼å¯¹æ¯”**ï¼š

| è¿ç§»æ¨¡å¼ | æè¿° | é€‚ç”¨åœºæ™¯ | å¤æ‚åº¦ |
|---------|------|---------|-------|
| **æ‰©å±•æ”¶ç¼©** | å…ˆæ·»åŠ ååˆ é™¤ | æ·»åŠ åˆ—ã€æ”¹å | ä½ |
| **åŒå†™** | åŒæ—¶å†™æ–°æ—§ | è¡¨è¿ç§» | ä¸­ |
| **å½±å­è¡¨** | åå°è¿ç§» | å¤§è¡¨é‡æ„ | é«˜ |
| **è“ç»¿éƒ¨ç½²** | å®Œæ•´åˆ‡æ¢ | å¤§æ”¹åŠ¨ | é«˜ |

**é›¶åœæœºè¿ç§»ç¤ºä¾‹**ï¼š

```sql
-- åœºæ™¯ï¼šå°†usernameåˆ—ä»VARCHAR(50)æ‰©å±•åˆ°VARCHAR(100)
-- PostgreSQLå¯ä»¥ç›´æ¥æ‰©å±•ï¼Œä½†è¿™é‡Œæ¼”ç¤ºå®Œæ•´æµç¨‹

-- æ­¥éª¤1ï¼šæ·»åŠ æ–°åˆ—
ALTER TABLE users ADD COLUMN username_new VARCHAR(100);

-- æ­¥éª¤2ï¼šåŒæ­¥æ•°æ®
UPDATE users SET username_new = username WHERE username_new IS NULL;

-- æ­¥éª¤3ï¼šæ·»åŠ è§¦å‘å™¨ä¿æŒåŒæ­¥
CREATE OR REPLACE FUNCTION sync_username()
RETURNS TRIGGER AS $$
BEGIN
    NEW.username_new = NEW.username;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_sync_username
BEFORE INSERT OR UPDATE ON users
FOR EACH ROW EXECUTE FUNCTION sync_username();

-- æ­¥éª¤4ï¼šåº”ç”¨å±‚åˆ‡æ¢ï¼ˆè¯»æ–°å†™åŒå†™ï¼‰
-- æ­¥éª¤5ï¼šéªŒè¯æ•°æ®ä¸€è‡´æ€§
SELECT COUNT(*) FROM users WHERE username != username_new;

-- æ­¥éª¤6ï¼šåˆ é™¤æ—§åˆ—
DROP TRIGGER trg_sync_username ON users;
ALTER TABLE users DROP COLUMN username;
ALTER TABLE users RENAME COLUMN username_new TO username;
```

---

## 10. è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µ

### 10.1. å¸¸è§è®¾è®¡æ¨¡å¼

**1. å®¡è®¡æ¨¡å¼ï¼ˆAudit Patternï¼‰**ï¼š

```sql
-- å®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE audit_log (
    id BIGSERIAL PRIMARY KEY,
    table_name VARCHAR(100) NOT NULL,
    record_id UUID NOT NULL,
    operation VARCHAR(20) NOT NULL,
    old_values JSONB,
    new_values JSONB,
    changed_by UUID,
    changed_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    client_ip INET,
    user_agent TEXT
);

CREATE INDEX idx_audit_table_record ON audit_log(table_name, record_id);
CREATE INDEX idx_audit_changed_at ON audit_log(changed_at);

-- é€šç”¨å®¡è®¡è§¦å‘å™¨
CREATE OR REPLACE FUNCTION audit_trigger_func()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO audit_log (table_name, record_id, operation, old_values, new_values, changed_by)
    VALUES (
        TG_TABLE_NAME,
        COALESCE(NEW.id, OLD.id),
        TG_OP,
        CASE WHEN TG_OP IN ('UPDATE', 'DELETE') THEN to_jsonb(OLD) END,
        CASE WHEN TG_OP IN ('INSERT', 'UPDATE') THEN to_jsonb(NEW) END,
        current_setting('app.current_user_id', TRUE)::UUID
    );
    RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

-- åº”ç”¨åˆ°è¡¨
CREATE TRIGGER audit_users
AFTER INSERT OR UPDATE OR DELETE ON users
FOR EACH ROW EXECUTE FUNCTION audit_trigger_func();
```

**2. è½¯åˆ é™¤æ¨¡å¼ï¼ˆSoft Deleteï¼‰**ï¼š

```sql
CREATE TABLE products (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(200) NOT NULL,
    price DECIMAL(10,2),

    -- è½¯åˆ é™¤å­—æ®µ
    is_deleted BOOLEAN DEFAULT FALSE,
    deleted_at TIMESTAMPTZ,
    deleted_by UUID,

    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- éƒ¨åˆ†ç´¢å¼•ï¼šåªç´¢å¼•æœªåˆ é™¤æ•°æ®
CREATE INDEX idx_products_active ON products(name) WHERE NOT is_deleted;

-- æ´»è·ƒæ•°æ®è§†å›¾
CREATE VIEW active_products AS
SELECT * FROM products WHERE NOT is_deleted;

-- è½¯åˆ é™¤å‡½æ•°
CREATE OR REPLACE FUNCTION soft_delete(
    p_table_name TEXT,
    p_id UUID,
    p_deleted_by UUID DEFAULT NULL
)
RETURNS BOOLEAN AS $$
BEGIN
    EXECUTE format(
        'UPDATE %I SET is_deleted = TRUE, deleted_at = NOW(), deleted_by = $1 WHERE id = $2',
        p_table_name
    ) USING p_deleted_by, p_id;
    RETURN FOUND;
END;
$$ LANGUAGE plpgsql;
```

**3. å¤šç§Ÿæˆ·æ¨¡å¼ï¼ˆMulti-Tenantï¼‰**ï¼š

```sql
-- æ–¹æ¡ˆ1ï¼šè¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰
CREATE TABLE tenant_data (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    data JSONB,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_tenant_data_tenant ON tenant_data(tenant_id);

ALTER TABLE tenant_data ENABLE ROW LEVEL SECURITY;

CREATE POLICY tenant_isolation ON tenant_data
    FOR ALL
    USING (tenant_id = current_setting('app.current_tenant_id')::UUID);

-- æ–¹æ¡ˆ2ï¼šSchemaéš”ç¦»
CREATE OR REPLACE FUNCTION create_tenant_schema(p_tenant_id TEXT)
RETURNS VOID AS $$
BEGIN
    EXECUTE format('CREATE SCHEMA IF NOT EXISTS tenant_%s', p_tenant_id);
    EXECUTE format('
        CREATE TABLE tenant_%s.users (
            id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            email VARCHAR(200) UNIQUE NOT NULL,
            created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
        )', p_tenant_id);
    -- åˆ›å»ºå…¶ä»–è¡¨...
END;
$$ LANGUAGE plpgsql;
```

### 10.2. æ¨¡å¼é€‰æ‹©å†³ç­–çŸ©é˜µ

| è®¾è®¡æ¨¡å¼ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ | å¤æ‚åº¦ |
|---------|---------|------|------|-------|
| **å®¡è®¡æ¨¡å¼** | åˆè§„ã€è¿½æº¯ | å®Œæ•´è®°å½• | å­˜å‚¨å¢é•¿ | â­â­ |
| **è½¯åˆ é™¤** | æ•°æ®æ¢å¤ | å¯æ¢å¤ | æŸ¥è¯¢å¤æ‚ | â­ |
| **ç‰ˆæœ¬æ§åˆ¶** | å†å²è¿½æº¯ | æ—¶é—´æ—…è¡Œ | å­˜å‚¨å¤§ | â­â­â­ |
| **å¤šç§Ÿæˆ·RLS** | SaaS | ç®€å• | æ€§èƒ½å½±å“ | â­â­ |
| **å¤šç§Ÿæˆ·Schema** | SaaS | éš”ç¦»å¥½ | ç®¡ç†å¤æ‚ | â­â­â­ |
| **äº‹ä»¶æº¯æº** | é¢†åŸŸé©±åŠ¨ | å¯é‡æ”¾ | å¤æ‚ | â­â­â­â­ |
| **CQRS** | è¯»å†™åˆ†ç¦» | æ€§èƒ½å¥½ | å¤æ‚ | â­â­â­â­ |

### 10.3. æœ€ä½³å®è·µçŸ©é˜µ

| å®è·µ | æè¿° | é€‚ç”¨åœºæ™¯ | ä¼˜å…ˆçº§ |
|------|------|---------|--------|
| **ä½¿ç”¨UUIDä¸»é”®** | åˆ†å¸ƒå¼å‹å¥½ | åˆ†å¸ƒå¼ç³»ç»Ÿ | â­â­â­â­â­ |
| **å¤–é”®ç´¢å¼•** | æé«˜JOINæ€§èƒ½ | å…³è”è¡¨ | â­â­â­â­â­ |
| **NOT NULLçº¦æŸ** | æ•°æ®å®Œæ•´æ€§ | å…³é”®å­—æ®µ | â­â­â­â­â­ |
| **CHECKçº¦æŸ** | ä¸šåŠ¡è§„åˆ™ | æšä¸¾ã€èŒƒå›´ | â­â­â­â­ |
| **TIMESTAMPTZ** | æ—¶åŒºå®‰å…¨ | å›½é™…åŒ– | â­â­â­â­ |
| **JSONB** | çµæ´»ç»“æ„ | å¯å˜Schema | â­â­â­â­ |
| **å‘½åè§„èŒƒ** | ä¸€è‡´æ€§ | æ‰€æœ‰å¯¹è±¡ | â­â­â­â­ |
| **æ³¨é‡Šæ–‡æ¡£** | å¯ç»´æŠ¤æ€§ | å¤æ‚Schema | â­â­â­ |

---

## 11. 2024-2025æœ€æ–°è¶‹åŠ¿

### 11.1. Schemaè®¾è®¡æŠ€æœ¯æ¼”è¿›

```mermaid
timeline
    title Schemaè®¾è®¡æŠ€æœ¯æ¼”è¿› 2020-2025
    2020 : å¾®æœåŠ¡æ•°æ®è®¾è®¡æˆç†Ÿ
         : äº‹ä»¶é©±åŠ¨æ¶æ„æ™®åŠ
    2021 : Schemaå³ä»£ç å…´èµ·
         : GitOpsæ•°æ®ç®¡ç†
    2022 : å‘é‡æ•°æ®åº“Schema
         : çŸ¥è¯†å›¾è°±èåˆ
    2023 : AIè¾…åŠ©Schemaè®¾è®¡
         : LLMæ•°æ®æ¨¡å‹
    2024 : è‡ªåŠ¨Schemaä¼˜åŒ–
         : å¤šæ¨¡æ€æ•°æ®èåˆ
    2025 : æ™ºèƒ½Schemaæ¼”è¿›
         : è‡ªé€‚åº”æ•°æ®æ¶æ„
```

### 11.2. AIè¾…åŠ©Schemaè®¾è®¡

**AIè¾…åŠ©è®¾è®¡èƒ½åŠ›çŸ©é˜µ**ï¼š

| èƒ½åŠ› | å½“å‰æˆç†Ÿåº¦ | 2025é¢„æœŸ | å·¥å…·ç¤ºä¾‹ |
|------|-----------|---------|---------|
| **éœ€æ±‚åˆ†æ** | â­â­â­ | â­â­â­â­ | GPT-4, Claude |
| **ERå›¾ç”Ÿæˆ** | â­â­ | â­â­â­â­ | DBML AI |
| **DDLç”Ÿæˆ** | â­â­â­â­ | â­â­â­â­â­ | Copilot |
| **ç´¢å¼•æ¨è** | â­â­â­ | â­â­â­â­â­ | pgAnalyze AI |
| **æŸ¥è¯¢ä¼˜åŒ–** | â­â­â­â­ | â­â­â­â­â­ | OtterTune |
| **Schemaæ¼”è¿›** | â­â­ | â­â­â­â­ | ç ”å‘ä¸­ |

### 11.3. äº‘åŸç”ŸSchemaè®¾è®¡æ¨¡å¼

**äº‘åŸç”Ÿæ•°æ®åº“é€‰æ‹©çŸ©é˜µ**ï¼š

| åœºæ™¯ | AWS | GCP | Azure | å¼€æºæ›¿ä»£ |
|------|-----|-----|-------|---------|
| **OLTP** | Aurora PostgreSQL | Cloud SQL | Azure PostgreSQL | PostgreSQL |
| **OLAP** | Redshift | BigQuery | Synapse | ClickHouse |
| **æ–‡æ¡£** | DocumentDB | Firestore | Cosmos DB | MongoDB |
| **å›¾** | Neptune | - | Cosmos DB | Neo4j |
| **å‘é‡** | OpenSearch | Vertex AI | Cognitive Search | pgvector |
| **æ—¶åº** | Timestream | - | Time Series | TimescaleDB |

---

## 12. å·¥å…·ä¸è‡ªåŠ¨åŒ–

### 12.1. Schemaè®¾è®¡å·¥å…·å¯¹æ¯”

| å·¥å…· | ç±»å‹ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|------|---------|
| **DbSchema** | GUI | å¯è§†åŒ–å¼º | ä»˜è´¹ | ä¼ä¸šé¡¹ç›® |
| **DBeaver** | GUI/å…è´¹ | å¤šæ•°æ®åº“ | å»ºæ¨¡å¼± | æ—¥å¸¸å¼€å‘ |
| **pgModeler** | GUI/å¼€æº | PostgreSQLä¸“ç”¨ | å­¦ä¹ æ›²çº¿ | PGé¡¹ç›® |
| **dbdiagram.io** | åœ¨çº¿ | ç®€å•æ˜“ç”¨ | åŠŸèƒ½æœ‰é™ | å¿«é€ŸåŸå‹ |
| **DBML** | DSL | ä»£ç åŒ– | éœ€å­¦ä¹  | IaCé¡¹ç›® |
| **Prisma** | ORM | ç±»å‹å®‰å…¨ | è¿ç§»é™åˆ¶ | ç°ä»£åº”ç”¨ |

### 12.2. SchemaéªŒè¯è‡ªåŠ¨åŒ–

```python
# schema_validator.py - SchemaéªŒè¯è‡ªåŠ¨åŒ–è„šæœ¬

from dataclasses import dataclass
from typing import List, Dict, Any
import re

@dataclass
class ValidationRule:
    name: str
    check: callable
    severity: str  # 'error', 'warning', 'info'

class SchemaValidator:
    """SchemaéªŒè¯å™¨"""

    def __init__(self):
        self.rules = [
            ValidationRule("è¡¨å‘½åè§„èŒƒ", self._check_table_naming, "error"),
            ValidationRule("ä¸»é”®å­˜åœ¨", self._check_primary_key, "error"),
            ValidationRule("å¤–é”®ç´¢å¼•", self._check_foreign_key_index, "warning"),
            ValidationRule("æ—¶é—´æˆ³å­—æ®µ", self._check_timestamp_fields, "info"),
            ValidationRule("æ³¨é‡Šå­˜åœ¨", self._check_comments, "info"),
        ]

    def validate(self, schema: Dict[str, Any]) -> List[Dict]:
        """éªŒè¯Schema"""
        results = []
        for rule in self.rules:
            issues = rule.check(schema)
            for issue in issues:
                results.append({
                    "rule": rule.name,
                    "severity": rule.severity,
                    "issue": issue
                })
        return results

    def _check_table_naming(self, schema: Dict) -> List[str]:
        """æ£€æŸ¥è¡¨å‘½åè§„èŒƒ"""
        issues = []
        for table_name in schema.get("tables", {}):
            if not re.match(r'^[a-z][a-z0-9_]*s?$', table_name):
                issues.append(f"è¡¨å '{table_name}' ä¸ç¬¦åˆå‘½åè§„èŒƒï¼ˆåº”ä¸ºsnake_caseï¼‰")
        return issues

    def _check_primary_key(self, schema: Dict) -> List[str]:
        """æ£€æŸ¥ä¸»é”®å­˜åœ¨"""
        issues = []
        for table_name, table in schema.get("tables", {}).items():
            if "primary_key" not in table:
                issues.append(f"è¡¨ '{table_name}' ç¼ºå°‘ä¸»é”®")
        return issues

    def _check_foreign_key_index(self, schema: Dict) -> List[str]:
        """æ£€æŸ¥å¤–é”®ç´¢å¼•"""
        issues = []
        for table_name, table in schema.get("tables", {}).items():
            fks = table.get("foreign_keys", [])
            indexes = table.get("indexes", [])
            indexed_columns = set()
            for idx in indexes:
                indexed_columns.update(idx.get("columns", []))

            for fk in fks:
                fk_columns = fk.get("columns", [])
                if not set(fk_columns).issubset(indexed_columns):
                    issues.append(f"è¡¨ '{table_name}' çš„å¤–é”®åˆ— {fk_columns} ç¼ºå°‘ç´¢å¼•")
        return issues

    def _check_timestamp_fields(self, schema: Dict) -> List[str]:
        """æ£€æŸ¥æ—¶é—´æˆ³å­—æ®µ"""
        issues = []
        for table_name, table in schema.get("tables", {}).items():
            columns = [c["name"] for c in table.get("columns", [])]
            if "created_at" not in columns:
                issues.append(f"è¡¨ '{table_name}' å»ºè®®æ·»åŠ  'created_at' å­—æ®µ")
            if "updated_at" not in columns:
                issues.append(f"è¡¨ '{table_name}' å»ºè®®æ·»åŠ  'updated_at' å­—æ®µ")
        return issues

    def _check_comments(self, schema: Dict) -> List[str]:
        """æ£€æŸ¥æ³¨é‡Šå­˜åœ¨"""
        issues = []
        for table_name, table in schema.get("tables", {}).items():
            if not table.get("comment"):
                issues.append(f"è¡¨ '{table_name}' ç¼ºå°‘æ³¨é‡Š")
        return issues

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    schema = {
        "tables": {
            "users": {
                "primary_key": ["id"],
                "columns": [
                    {"name": "id", "type": "UUID"},
                    {"name": "email", "type": "VARCHAR(200)"},
                    {"name": "created_at", "type": "TIMESTAMPTZ"},
                ],
                "comment": "ç”¨æˆ·è¡¨"
            },
            "Order": {  # æ•…æ„é”™è¯¯çš„å‘½å
                "columns": [
                    {"name": "id", "type": "UUID"},
                    {"name": "user_id", "type": "UUID"},
                ],
                "foreign_keys": [
                    {"columns": ["user_id"], "references": "users.id"}
                ],
                "indexes": []  # ç¼ºå°‘å¤–é”®ç´¢å¼•
            }
        }
    }

    validator = SchemaValidator()
    results = validator.validate(schema)
    for r in results:
        print(f"[{r['severity'].upper()}] {r['rule']}: {r['issue']}")
```

---

## 13. å‚è€ƒèµ„æ–™

### 13.1. æƒå¨æ–‡çŒ®

**ç»å…¸ç†è®º**ï¼š

- Codd, E.F. (1970). "A Relational Model of Data for Large Shared Data Banks"
- Chen, P. (1976). "The Entity-Relationship Model"
- Date, C.J. "An Introduction to Database Systems"

**ç°ä»£å®è·µ**ï¼š

- Fowler, M. "Patterns of Enterprise Application Architecture"
- Evans, E. "Domain-Driven Design"
- Vernon, V. "Implementing Domain-Driven Design"
- Kleppmann, M. "Designing Data-Intensive Applications"

### 13.2. åœ¨çº¿èµ„æº

| èµ„æº | URL | æè¿° |
|------|-----|------|
| **PostgreSQLå®˜æ–¹æ–‡æ¡£** | <https://www.postgresql.org/docs/> | æƒå¨æ•°æ®åº“æ–‡æ¡£ |
| **Martin Fowler Blog** | <https://martinfowler.com> | æ¶æ„æ¨¡å¼ |
| **AWS Database Blog** | <https://aws.amazon.com/blogs/database/> | äº‘æ•°æ®åº“å®è·µ |
| **Use The Index, Luke** | <https://use-the-index-luke.com> | ç´¢å¼•è®¾è®¡ |
| **DBML** | <https://dbml.dbdiagram.io> | Schema DSL |
| **pgAnalyze** | <https://pganalyze.com/docs> | PostgreSQLä¼˜åŒ– |

---

**æœ€åæ›´æ–°**ï¼š2025-12-01
**ç»´æŠ¤è€…**ï¼šData-Science Team
**çŠ¶æ€**ï¼šå®æ–½ä¸­
**ç‰ˆæœ¬**ï¼šv2.0 (å¢å¼ºç‰ˆ)
