# Schemaè®¾è®¡æ–¹æ³•è®ºï¼šæ•°æ®åº“æ¨¡å¼è®¾è®¡çš„ç³»ç»ŸåŒ–æ–¹æ³•

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-01-15
> **ç‰ˆæœ¬**ï¼šv1.0
> **çŠ¶æ€**ï¼šå®æ–½ä¸­

---

## ğŸ“‹ ç›®å½•

- [Schemaè®¾è®¡æ–¹æ³•è®ºï¼šæ•°æ®åº“æ¨¡å¼è®¾è®¡çš„ç³»ç»ŸåŒ–æ–¹æ³•](#schemaè®¾è®¡æ–¹æ³•è®ºæ•°æ®åº“æ¨¡å¼è®¾è®¡çš„ç³»ç»ŸåŒ–æ–¹æ³•)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1. Schemaè®¾è®¡çš„æ ¸å¿ƒç›®æ ‡](#11-schemaè®¾è®¡çš„æ ¸å¿ƒç›®æ ‡)
    - [1.2. Schemaè®¾è®¡å†³ç­–æ ‘](#12-schemaè®¾è®¡å†³ç­–æ ‘)
  - [2. Schemaè®¾è®¡æµç¨‹](#2-schemaè®¾è®¡æµç¨‹)
    - [2.1. è®¾è®¡æµç¨‹æ¦‚è§ˆ](#21-è®¾è®¡æµç¨‹æ¦‚è§ˆ)
    - [2.2. è®¾è®¡é˜¶æ®µå¯¹æ¯”çŸ©é˜µ](#22-è®¾è®¡é˜¶æ®µå¯¹æ¯”çŸ©é˜µ)
  - [3. éœ€æ±‚åˆ†æä¸å»ºæ¨¡](#3-éœ€æ±‚åˆ†æä¸å»ºæ¨¡)
    - [3.1. éœ€æ±‚æ”¶é›†æ–¹æ³•](#31-éœ€æ±‚æ”¶é›†æ–¹æ³•)
    - [3.2. éœ€æ±‚åˆ†æå†³ç­–æ ‘](#32-éœ€æ±‚åˆ†æå†³ç­–æ ‘)
    - [3.3. éœ€æ±‚å»ºæ¨¡æ–¹æ³•](#33-éœ€æ±‚å»ºæ¨¡æ–¹æ³•)
  - [4. æ¦‚å¿µæ¨¡å‹è®¾è®¡](#4-æ¦‚å¿µæ¨¡å‹è®¾è®¡)
    - [4.1. å®ä½“è¯†åˆ«](#41-å®ä½“è¯†åˆ«)
    - [4.2. å…³ç³»è¯†åˆ«](#42-å…³ç³»è¯†åˆ«)
    - [4.3. ERå›¾è®¾è®¡](#43-erå›¾è®¾è®¡)
  - [5. é€»è¾‘æ¨¡å‹è®¾è®¡](#5-é€»è¾‘æ¨¡å‹è®¾è®¡)
    - [5.1. è¡¨è®¾è®¡åŸåˆ™](#51-è¡¨è®¾è®¡åŸåˆ™)
    - [5.2. è¡¨è®¾è®¡å†³ç­–æ ‘](#52-è¡¨è®¾è®¡å†³ç­–æ ‘)
    - [5.3. é”®è®¾è®¡ç­–ç•¥](#53-é”®è®¾è®¡ç­–ç•¥)
    - [5.4. èŒƒå¼åŒ–å†³ç­–](#54-èŒƒå¼åŒ–å†³ç­–)
  - [6. ç‰©ç†æ¨¡å‹è®¾è®¡](#6-ç‰©ç†æ¨¡å‹è®¾è®¡)
    - [6.1. æ•°æ®ç±»å‹é€‰æ‹©](#61-æ•°æ®ç±»å‹é€‰æ‹©)
    - [6.2. ç´¢å¼•è®¾è®¡](#62-ç´¢å¼•è®¾è®¡)
    - [6.3. åˆ†åŒºè®¾è®¡](#63-åˆ†åŒºè®¾è®¡)
  - [7. Schemaä¼˜åŒ–ä¸é‡æ„](#7-schemaä¼˜åŒ–ä¸é‡æ„)
    - [7.1. æ€§èƒ½ä¼˜åŒ–](#71-æ€§èƒ½ä¼˜åŒ–)
    - [7.2. Schemaé‡æ„](#72-schemaé‡æ„)
  - [8. è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µ](#8-è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µ)
    - [8.1. å¸¸è§è®¾è®¡æ¨¡å¼](#81-å¸¸è§è®¾è®¡æ¨¡å¼)
    - [8.2. æœ€ä½³å®è·µçŸ©é˜µ](#82-æœ€ä½³å®è·µçŸ©é˜µ)
  - [9. å‚è€ƒèµ„æ–™](#9-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

Schemaè®¾è®¡æ˜¯æ•°æ®åº“è®¾è®¡çš„æ ¸å¿ƒï¼Œæ¶‰åŠä»ä¸šåŠ¡éœ€æ±‚åˆ°ç‰©ç†å®ç°çš„å®Œæ•´è¿‡ç¨‹ã€‚

### 1.1. Schemaè®¾è®¡çš„æ ¸å¿ƒç›®æ ‡

1. **æ•°æ®å®Œæ•´æ€§**ï¼šç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’Œæ­£ç¡®æ€§
2. **æŸ¥è¯¢æ€§èƒ½**ï¼šä¼˜åŒ–å¸¸è§æŸ¥è¯¢çš„æ‰§è¡Œæ•ˆç‡
3. **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒæœªæ¥ä¸šåŠ¡éœ€æ±‚çš„å˜åŒ–
4. **å¯ç»´æŠ¤æ€§**ï¼šä¾¿äºç†è§£å’Œç»´æŠ¤
5. **å®‰å…¨æ€§**ï¼šä¿æŠ¤æ•æ„Ÿæ•°æ®

### 1.2. Schemaè®¾è®¡å†³ç­–æ ‘

```mermaid
flowchart TD
    A[å¼€å§‹Schemaè®¾è®¡] --> B[éœ€æ±‚åˆ†æ]
    B --> C[æ¦‚å¿µå»ºæ¨¡]
    C --> D[é€»è¾‘å»ºæ¨¡]
    D --> E[ç‰©ç†å»ºæ¨¡]

    E --> F{æ€§èƒ½è¦æ±‚}
    F -->|é«˜| G[æ€§èƒ½ä¼˜åŒ–]
    F -->|ä¸­| H[æ ‡å‡†è®¾è®¡]
    F -->|ä½| I[ç®€å•è®¾è®¡]

    G --> J[ç´¢å¼•è®¾è®¡]
    H --> J
    I --> J

    J --> K[çº¦æŸè®¾è®¡]
    K --> L[éªŒè¯è®¾è®¡]

    L --> M{æ»¡è¶³éœ€æ±‚?}
    M -->|æ˜¯| N[è®¾è®¡å®Œæˆ]
    M -->|å¦| O[è¿­ä»£ä¼˜åŒ–]
    O --> B
```

---

## 2. Schemaè®¾è®¡æµç¨‹

### 2.1. è®¾è®¡æµç¨‹æ¦‚è§ˆ

```mermaid
mindmap
  root((Schemaè®¾è®¡æµç¨‹))
    éœ€æ±‚åˆ†æ
      ä¸šåŠ¡éœ€æ±‚
      åŠŸèƒ½éœ€æ±‚
      æ€§èƒ½éœ€æ±‚
      å®‰å…¨éœ€æ±‚
    æ¦‚å¿µå»ºæ¨¡
      å®ä½“è¯†åˆ«
      å…³ç³»è¯†åˆ«
      å±æ€§å®šä¹‰
      ERå›¾è®¾è®¡
    é€»è¾‘å»ºæ¨¡
      è¡¨è®¾è®¡
      é”®è®¾è®¡
      å…³ç³»è®¾è®¡
      èŒƒå¼åŒ–
    ç‰©ç†å»ºæ¨¡
      æ•°æ®ç±»å‹é€‰æ‹©
      ç´¢å¼•è®¾è®¡
      åˆ†åŒºè®¾è®¡
      å­˜å‚¨ä¼˜åŒ–
    éªŒè¯ä¼˜åŒ–
      å®Œæ•´æ€§éªŒè¯
      æ€§èƒ½æµ‹è¯•
      é‡æ„ä¼˜åŒ–
```

### 2.2. è®¾è®¡é˜¶æ®µå¯¹æ¯”çŸ©é˜µ

| è®¾è®¡é˜¶æ®µ | è¾“å…¥ | è¾“å‡º | ä¸»è¦æ´»åŠ¨ | å·¥å…· |
|---------|------|------|---------|------|
| **éœ€æ±‚åˆ†æ** | ä¸šåŠ¡éœ€æ±‚æ–‡æ¡£ | éœ€æ±‚è§„æ ¼è¯´æ˜ | éœ€æ±‚æ”¶é›†ã€åˆ†æ | éœ€æ±‚ç®¡ç†å·¥å…· |
| **æ¦‚å¿µå»ºæ¨¡** | éœ€æ±‚è§„æ ¼è¯´æ˜ | ERå›¾ | å®ä½“è¯†åˆ«ã€å…³ç³»å»ºæ¨¡ | ERå·¥å…· |
| **é€»è¾‘å»ºæ¨¡** | ERå›¾ | é€»è¾‘Schema | è¡¨è®¾è®¡ã€èŒƒå¼åŒ– | æ•°æ®åº“è®¾è®¡å·¥å…· |
| **ç‰©ç†å»ºæ¨¡** | é€»è¾‘Schema | ç‰©ç†Schema | æ•°æ®ç±»å‹ã€ç´¢å¼• | DDLç”Ÿæˆå·¥å…· |
| **éªŒè¯ä¼˜åŒ–** | ç‰©ç†Schema | ä¼˜åŒ–Schema | æµ‹è¯•ã€è°ƒä¼˜ | æ€§èƒ½åˆ†æå·¥å…· |

---

## 3. éœ€æ±‚åˆ†æä¸å»ºæ¨¡

### 3.1. éœ€æ±‚æ”¶é›†æ–¹æ³•

**éœ€æ±‚æ¥æº**ï¼š

1. **ä¸šåŠ¡éœ€æ±‚**ï¼š
   - ä¸šåŠ¡æµç¨‹åˆ†æ
   - ä¸šåŠ¡è§„åˆ™è¯†åˆ«
   - ä¸šåŠ¡å®ä½“è¯†åˆ«

2. **åŠŸèƒ½éœ€æ±‚**ï¼š
   - æ•°æ®æ“ä½œéœ€æ±‚
   - æŸ¥è¯¢éœ€æ±‚
   - æŠ¥è¡¨éœ€æ±‚

3. **éåŠŸèƒ½éœ€æ±‚**ï¼š
   - æ€§èƒ½éœ€æ±‚
   - å®‰å…¨éœ€æ±‚
   - å¯ç”¨æ€§éœ€æ±‚

### 3.2. éœ€æ±‚åˆ†æå†³ç­–æ ‘

```mermaid
flowchart TD
    A[éœ€æ±‚åˆ†æ] --> B{éœ€æ±‚ç±»å‹}

    B -->|ä¸šåŠ¡éœ€æ±‚| C[ä¸šåŠ¡æµç¨‹åˆ†æ]
    B -->|åŠŸèƒ½éœ€æ±‚| D[åŠŸèƒ½ç‚¹åˆ†æ]
    B -->|æ€§èƒ½éœ€æ±‚| E[æ€§èƒ½æŒ‡æ ‡åˆ†æ]

    C --> F[è¯†åˆ«ä¸šåŠ¡å®ä½“]
    D --> G[è¯†åˆ«æ•°æ®æ“ä½œ]
    E --> H[è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ]

    F --> I[å®ä½“å…³ç³»å»ºæ¨¡]
    G --> J[æ“ä½œå»ºæ¨¡]
    H --> K[æ€§èƒ½å»ºæ¨¡]

    I --> L[éœ€æ±‚æ–‡æ¡£]
    J --> L
    K --> L
```

### 3.3. éœ€æ±‚å»ºæ¨¡æ–¹æ³•

**ç”¨ä¾‹å»ºæ¨¡**ï¼š

```text
ç”¨ä¾‹ï¼šç”¨æˆ·æ³¨å†Œ
å‰ç½®æ¡ä»¶ï¼šç”¨æˆ·æœªæ³¨å†Œ
ä¸»æµç¨‹ï¼š
  1. ç”¨æˆ·è¾“å…¥æ³¨å†Œä¿¡æ¯
  2. ç³»ç»ŸéªŒè¯ä¿¡æ¯
  3. åˆ›å»ºç”¨æˆ·è®°å½•
  4. å‘é€ç¡®è®¤é‚®ä»¶
åç½®æ¡ä»¶ï¼šç”¨æˆ·è®°å½•å·²åˆ›å»º

æ•°æ®éœ€æ±‚ï¼š
  - ç”¨æˆ·è¡¨ï¼šid, username, email, password_hash, created_at
  - éªŒè¯è§„åˆ™ï¼šemailå”¯ä¸€ï¼Œusernameå”¯ä¸€
```

**æ•°æ®æµå»ºæ¨¡**ï¼š

```mermaid
flowchart LR
    A[ç”¨æˆ·è¾“å…¥] --> B[éªŒè¯æ¨¡å—]
    B --> C[ç”¨æˆ·è¡¨]
    C --> D[é‚®ä»¶æœåŠ¡]
    D --> E[é€šçŸ¥ç”¨æˆ·]
```

---

## 4. æ¦‚å¿µæ¨¡å‹è®¾è®¡

### 4.1. å®ä½“è¯†åˆ«

**å®ä½“è¯†åˆ«æ–¹æ³•**ï¼š

1. **åè¯è¯†åˆ«æ³•**ï¼šä»éœ€æ±‚æ–‡æ¡£ä¸­æå–åè¯ä½œä¸ºå€™é€‰å®ä½“
2. **ä¸šåŠ¡å¯¹è±¡æ³•**ï¼šè¯†åˆ«ä¸šåŠ¡ä¸­çš„æ ¸å¿ƒå¯¹è±¡
3. **æ•°æ®æµæ³•**ï¼šä»æ•°æ®æµä¸­è¯†åˆ«æ•°æ®å­˜å‚¨ç‚¹

**å®ä½“è¯†åˆ«å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[è¯†åˆ«å€™é€‰å®ä½“] --> B{æ˜¯ä¸šåŠ¡å¯¹è±¡?}
    B -->|æ˜¯| C{æœ‰ç‹¬ç«‹å­˜åœ¨æ€§?}
    B -->|å¦| D[æ’é™¤]

    C -->|æ˜¯| E{æœ‰å±æ€§?}
    C -->|å¦| D

    E -->|æ˜¯| F[ç¡®è®¤ä¸ºå®ä½“]
    E -->|å¦| G{æ˜¯å…³ç³»?}

    G -->|æ˜¯| H[ä½œä¸ºå…³ç³»å¤„ç†]
    G -->|å¦| D

    F --> I[å®šä¹‰å®ä½“å±æ€§]
    H --> J[å®šä¹‰å…³ç³»å±æ€§]
```

### 4.2. å…³ç³»è¯†åˆ«

**å…³ç³»ç±»å‹**ï¼š

1. **ä¸€å¯¹ä¸€ï¼ˆ1:1ï¼‰**ï¼šæ¯ä¸ªå®ä½“å®ä¾‹åªä¸å¦ä¸€ä¸ªå®ä½“å®ä¾‹å…³è”
2. **ä¸€å¯¹å¤šï¼ˆ1:Nï¼‰**ï¼šä¸€ä¸ªå®ä½“å®ä¾‹ä¸å¤šä¸ªå¦ä¸€ä¸ªå®ä½“å®ä¾‹å…³è”
3. **å¤šå¯¹å¤šï¼ˆM:Nï¼‰**ï¼šå¤šä¸ªå®ä½“å®ä¾‹ä¸å¤šä¸ªå¦ä¸€ä¸ªå®ä½“å®ä¾‹å…³è”

**å…³ç³»è¯†åˆ«å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[è¯†åˆ«å®ä½“å…³ç³»] --> B{å…³ç³»åŸºæ•°}

    B -->|1:1| C[ä¸€å¯¹ä¸€å…³ç³»]
    B -->|1:N| D[ä¸€å¯¹å¤šå…³ç³»]
    B -->|M:N| E[å¤šå¯¹å¤šå…³ç³»]

    C --> F{éœ€è¦ç‹¬ç«‹è¡¨?}
    F -->|æ˜¯| G[åˆ›å»ºå…³è”è¡¨]
    F -->|å¦| H[å¤–é”®å…³ç³»]

    D --> I[å¤–é”®å…³ç³»]
    E --> G

    G --> J[å®šä¹‰å…³ç³»å±æ€§]
    H --> K[å®šä¹‰å¤–é”®]
    I --> K
```

### 4.3. ERå›¾è®¾è®¡

**ERå›¾å…ƒç´ **ï¼š

- **å®ä½“**ï¼šçŸ©å½¢è¡¨ç¤º
- **å±æ€§**ï¼šæ¤­åœ†è¡¨ç¤º
- **å…³ç³»**ï¼šè±å½¢è¡¨ç¤º
- **åŸºæ•°**ï¼š1, N, Mæ ‡æ³¨

**ERå›¾ç¤ºä¾‹**ï¼š

```mermaid
erDiagram
    USER ||--o{ ORDER : places
    ORDER ||--|{ ORDER_ITEM : contains
    PRODUCT ||--o{ ORDER_ITEM : "included in"

    USER {
        int id PK
        string username
        string email
        datetime created_at
    }

    ORDER {
        int id PK
        int user_id FK
        decimal total
        datetime order_date
    }

    PRODUCT {
        int id PK
        string name
        decimal price
        int stock
    }

    ORDER_ITEM {
        int order_id FK
        int product_id FK
        int quantity
        decimal price
    }
```

---

## 5. é€»è¾‘æ¨¡å‹è®¾è®¡

### 5.1. è¡¨è®¾è®¡åŸåˆ™

**è¡¨è®¾è®¡åŸåˆ™**ï¼š

1. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªè¡¨åªè¡¨ç¤ºä¸€ä¸ªå®ä½“æˆ–å…³ç³»
2. **è§„èŒƒåŒ–**ï¼šéµå¾ªèŒƒå¼ç†è®ºï¼Œæ¶ˆé™¤å†—ä½™
3. **å®Œæ•´æ€§**ï¼šå®šä¹‰é€‚å½“çš„çº¦æŸä¿è¯æ•°æ®å®Œæ•´æ€§
4. **å¯æ‰©å±•æ€§**ï¼šè€ƒè™‘æœªæ¥éœ€æ±‚å˜åŒ–

### 5.2. è¡¨è®¾è®¡å†³ç­–æ ‘

```mermaid
flowchart TD
    A[è¡¨è®¾è®¡] --> B[ç¡®å®šè¡¨å]
    B --> C[è¯†åˆ«å±æ€§]
    C --> D[é€‰æ‹©ä¸»é”®]

    D --> E{ä¸»é”®ç±»å‹}
    E -->|å•å±æ€§| F[è‡ªç„¶é”®/ä»£ç†é”®]
    E -->|å¤šå±æ€§| G[å¤åˆä¸»é”®]

    F --> H[å®šä¹‰å¤–é”®]
    G --> H

    H --> I[å®šä¹‰çº¦æŸ]
    I --> J[å®šä¹‰ç´¢å¼•]

    J --> K{æ»¡è¶³èŒƒå¼?}
    K -->|å¦| L[è§„èŒƒåŒ–]
    K -->|æ˜¯| M[è¡¨è®¾è®¡å®Œæˆ]

    L --> C
```

### 5.3. é”®è®¾è®¡ç­–ç•¥

**ä¸»é”®é€‰æ‹©ç­–ç•¥**ï¼š

| ç­–ç•¥ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| **è‡ªç„¶é”®** | æœ‰ä¸šåŠ¡æ„ä¹‰ï¼ŒæŸ¥è¯¢æ–¹ä¾¿ | å¯èƒ½å˜åŒ–ï¼Œå¤åˆé”®å¤æ‚ | ä¸šåŠ¡ç¨³å®šçš„æ ‡è¯†ç¬¦ |
| **ä»£ç†é”®** | ç¨³å®šï¼Œç®€å• | æ— ä¸šåŠ¡æ„ä¹‰ï¼Œéœ€è¦é¢å¤–æŸ¥è¯¢ | å¤§å¤šæ•°åœºæ™¯ |
| **å¤åˆé”®** | åæ˜ ä¸šåŠ¡å…³ç³» | å¤æ‚ï¼Œæ€§èƒ½å½±å“ | å…³è”è¡¨ |

**å¤–é”®è®¾è®¡ç­–ç•¥**ï¼š

```sql
-- å¤–é”®çº¦æŸç¤ºä¾‹
CREATE TABLE orders (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    order_date DATE NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id)
        ON DELETE CASCADE      -- çº§è”åˆ é™¤
        ON UPDATE CASCADE      -- çº§è”æ›´æ–°
);

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_orders_user_id ON orders(user_id);
```

### 5.4. èŒƒå¼åŒ–å†³ç­–

**èŒƒå¼é€‰æ‹©å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[èŒƒå¼åŒ–å†³ç­–] --> B[æ£€æŸ¥1NF]
    B --> C{æ»¡è¶³1NF?}
    C -->|å¦| D[è§„èŒƒåŒ–åˆ°1NF]
    C -->|æ˜¯| E[æ£€æŸ¥2NF]

    D --> E
    E --> F{æ»¡è¶³2NF?}
    F -->|å¦| G[è§„èŒƒåŒ–åˆ°2NF]
    F -->|æ˜¯| H[æ£€æŸ¥3NF]

    G --> H
    H --> I{æ»¡è¶³3NF?}
    I -->|å¦| J[è§„èŒƒåŒ–åˆ°3NF]
    I -->|æ˜¯| K{éœ€è¦BCNF?}

    J --> K
    K -->|æ˜¯| L[æ£€æŸ¥BCNF]
    K -->|å¦| M[è®¾è®¡å®Œæˆ]

    L --> N{æ»¡è¶³BCNF?}
    N -->|å¦| O[è§„èŒƒåŒ–åˆ°BCNF]
    N -->|æ˜¯| M

    O --> M
```

---

## 6. ç‰©ç†æ¨¡å‹è®¾è®¡

### 6.1. æ•°æ®ç±»å‹é€‰æ‹©

**æ•°æ®ç±»å‹é€‰æ‹©å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[é€‰æ‹©æ•°æ®ç±»å‹] --> B{æ•°æ®ç‰¹æ€§}

    B -->|æ•´æ•°| C{æ•°å€¼èŒƒå›´}
    B -->|å°æ•°| D{ç²¾åº¦è¦æ±‚}
    B -->|æ–‡æœ¬| E{é•¿åº¦è¦æ±‚}
    B -->|æ—¥æœŸæ—¶é—´| F{ç²¾åº¦è¦æ±‚}
    B -->|å¸ƒå°”| G[BOOLEAN]

    C -->|å°| H[SMALLINT]
    C -->|ä¸­| I[INTEGER]
    C -->|å¤§| J[BIGINT]

    D -->|å›ºå®šç²¾åº¦| K[DECIMAL]
    D -->|æµ®ç‚¹| L[REAL/DOUBLE]

    E -->|çŸ­| M[VARCHAR(n)]
    E -->|é•¿| N[TEXT]
    E -->|å›ºå®š| O[CHAR(n)]

    F -->|æ—¥æœŸ| P[DATE]
    F -->|æ—¶é—´| Q[TIME]
    F -->|æ—¥æœŸæ—¶é—´| R[TIMESTAMP]
```

### 6.2. ç´¢å¼•è®¾è®¡

**ç´¢å¼•è®¾è®¡åŸåˆ™**ï¼š

1. **ä¸»é”®ç´¢å¼•**ï¼šè‡ªåŠ¨åˆ›å»ºï¼Œæ— éœ€æ‰‹åŠ¨åˆ›å»º
2. **å¤–é”®ç´¢å¼•**ï¼šé€šå¸¸éœ€è¦åˆ›å»ºä»¥æé«˜è¿æ¥æ€§èƒ½
3. **æŸ¥è¯¢ç´¢å¼•**ï¼šä¸ºé¢‘ç¹æŸ¥è¯¢çš„åˆ—åˆ›å»ºç´¢å¼•
4. **å¤åˆç´¢å¼•**ï¼šè€ƒè™‘æŸ¥è¯¢æ¨¡å¼åˆ›å»ºå¤åˆç´¢å¼•

**ç´¢å¼•è®¾è®¡å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[ç´¢å¼•è®¾è®¡] --> B{åˆ—ç±»å‹}

    B -->|ä¸»é”®| C[è‡ªåŠ¨ç´¢å¼•]
    B -->|å¤–é”®| D[åˆ›å»ºç´¢å¼•]
    B -->|æŸ¥è¯¢åˆ—| E{æŸ¥è¯¢é¢‘ç‡}
    B -->|æ’åºåˆ—| F[åˆ›å»ºç´¢å¼•]

    E -->|é«˜| G[åˆ›å»ºç´¢å¼•]
    E -->|ä½| H[ä¸åˆ›å»º]

    D --> I[åˆ†ææŸ¥è¯¢æ¨¡å¼]
    G --> I
    F --> I

    I --> J{éœ€è¦å¤åˆç´¢å¼•?}
    J -->|æ˜¯| K[è®¾è®¡å¤åˆç´¢å¼•]
    J -->|å¦| L[ç´¢å¼•è®¾è®¡å®Œæˆ]

    K --> M[ç¡®å®šåˆ—é¡ºåº]
    M --> L
```

**ç´¢å¼•è®¾è®¡ç¤ºä¾‹**ï¼š

```sql
-- å•åˆ—ç´¢å¼•
CREATE INDEX idx_users_email ON users(email);

-- å¤åˆç´¢å¼•ï¼ˆè€ƒè™‘æŸ¥è¯¢æ¨¡å¼ï¼‰
CREATE INDEX idx_orders_user_date ON orders(user_id, order_date DESC);

-- éƒ¨åˆ†ç´¢å¼•ï¼ˆPostgreSQLï¼‰
CREATE INDEX idx_orders_active ON orders(user_id)
WHERE status = 'active';

-- è¦†ç›–ç´¢å¼•ï¼ˆåŒ…å«æŸ¥è¯¢æ‰€éœ€çš„æ‰€æœ‰åˆ—ï¼‰
CREATE INDEX idx_orders_covering ON orders(user_id, order_date, total);
```

### 6.3. åˆ†åŒºè®¾è®¡

**åˆ†åŒºç­–ç•¥**ï¼š

| åˆ†åŒºç±»å‹ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|---------|---------|------|------|
| **èŒƒå›´åˆ†åŒº** | æ—¶é—´åºåˆ—æ•°æ® | æŸ¥è¯¢æ€§èƒ½å¥½ | æ•°æ®åˆ†å¸ƒä¸å‡ |
| **åˆ—è¡¨åˆ†åŒº** | ç¦»æ•£å€¼åˆ†åŒº | ç®€å•ç›´è§‚ | åˆ†åŒºæ•°é‡é™åˆ¶ |
| **å“ˆå¸Œåˆ†åŒº** | å‡åŒ€åˆ†å¸ƒ | è´Ÿè½½å‡è¡¡ | èŒƒå›´æŸ¥è¯¢æ€§èƒ½å·® |
| **å¤åˆåˆ†åŒº** | å¤æ‚åœºæ™¯ | çµæ´» | ç®¡ç†å¤æ‚ |

**åˆ†åŒºè®¾è®¡å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[åˆ†åŒºè®¾è®¡] --> B{æ•°æ®é‡}
    B -->|å°| C[ä¸åˆ†åŒº]
    B -->|å¤§| D{æ•°æ®ç‰¹æ€§}

    D -->|æ—¶é—´åºåˆ—| E[èŒƒå›´åˆ†åŒº]
    D -->|ç¦»æ•£å€¼| F[åˆ—è¡¨åˆ†åŒº]
    D -->|å‡åŒ€åˆ†å¸ƒ| G[å“ˆå¸Œåˆ†åŒº]

    E --> H[æŒ‰æ—¶é—´åˆ†åŒº]
    F --> I[æŒ‰ç±»åˆ«åˆ†åŒº]
    G --> J[æŒ‰å“ˆå¸Œå€¼åˆ†åŒº]

    H --> K[è®¾è®¡åˆ†åŒºé”®]
    I --> K
    J --> K

    K --> L[å®šä¹‰åˆ†åŒºç­–ç•¥]
    L --> M[åˆ†åŒºè®¾è®¡å®Œæˆ]
```

---

## 7. Schemaä¼˜åŒ–ä¸é‡æ„

### 7.1. æ€§èƒ½ä¼˜åŒ–

**æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**ï¼š

1. **æŸ¥è¯¢ä¼˜åŒ–**ï¼š
   - æ·»åŠ é€‚å½“çš„ç´¢å¼•
   - ä¼˜åŒ–æŸ¥è¯¢è¯­å¥
   - ä½¿ç”¨ç‰©åŒ–è§†å›¾

2. **å­˜å‚¨ä¼˜åŒ–**ï¼š
   - æ•°æ®ç±»å‹ä¼˜åŒ–
   - è¡¨å‹ç¼©
   - åˆ†åŒº

3. **æ¶æ„ä¼˜åŒ–**ï¼š
   - è¯»å†™åˆ†ç¦»
   - ç¼“å­˜ç­–ç•¥
   - åˆ†åº“åˆ†è¡¨

### 7.2. Schemaé‡æ„

**é‡æ„å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[Schemaé‡æ„] --> B{é‡æ„åŸå› }

    B -->|æ€§èƒ½é—®é¢˜| C[æ€§èƒ½ä¼˜åŒ–]
    B -->|éœ€æ±‚å˜åŒ–| D[ç»“æ„è°ƒæ•´]
    B -->|æ•°æ®è´¨é‡| E[è§„èŒƒåŒ–]

    C --> F[æ·»åŠ ç´¢å¼•]
    D --> G[è¡¨ç»“æ„è°ƒæ•´]
    E --> H[æ•°æ®æ¸…ç†]

    F --> I[æµ‹è¯•éªŒè¯]
    G --> I
    H --> I

    I --> J{æ»¡è¶³è¦æ±‚?}
    J -->|æ˜¯| K[é‡æ„å®Œæˆ]
    J -->|å¦| L[è°ƒæ•´æ–¹æ¡ˆ]
    L --> B
```

**é‡æ„æ­¥éª¤**ï¼š

```text
1. åˆ†æå½“å‰Schema
2. è¯†åˆ«é—®é¢˜å’Œæ”¹è¿›ç‚¹
3. è®¾è®¡æ–°Schema
4. åˆ¶å®šè¿ç§»è®¡åˆ’
5. æ‰§è¡Œè¿ç§»
6. éªŒè¯æ•°æ®å®Œæ•´æ€§
7. æ€§èƒ½æµ‹è¯•
8. å›æ»šè®¡åˆ’ï¼ˆå¦‚éœ€è¦ï¼‰
```

---

## 8. è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µ

### 8.1. å¸¸è§è®¾è®¡æ¨¡å¼

**1. ä¸»ä»æ¨¡å¼ï¼ˆMaster-Detailï¼‰**ï¼š

```sql
-- ä¸»è¡¨
CREATE TABLE orders (
    id INTEGER PRIMARY KEY,
    order_date DATE,
    total DECIMAL
);

-- ä»è¡¨
CREATE TABLE order_items (
    order_id INTEGER,
    product_id INTEGER,
    quantity INTEGER,
    price DECIMAL,
    PRIMARY KEY (order_id, product_id),
    FOREIGN KEY (order_id) REFERENCES orders(id)
);
```

**2. å®¡è®¡æ¨¡å¼ï¼ˆAudit Patternï¼‰**ï¼š

```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    username VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by INTEGER,
    updated_by INTEGER
);

-- å®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE audit_log (
    id SERIAL PRIMARY KEY,
    table_name VARCHAR(100) NOT NULL,
    record_id INTEGER NOT NULL,
    operation VARCHAR(20) NOT NULL,  -- INSERT, UPDATE, DELETE
    old_values JSONB,
    new_values JSONB,
    changed_by INTEGER,
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- è‡ªåŠ¨å®¡è®¡è§¦å‘å™¨
CREATE OR REPLACE FUNCTION audit_trigger()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO audit_log (table_name, record_id, operation, old_values, new_values, changed_by)
    VALUES (
        TG_TABLE_NAME,
        COALESCE(NEW.id, OLD.id),
        TG_OP,
        row_to_json(OLD),
        row_to_json(NEW),
        current_setting('app.user_id', TRUE)::INTEGER
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER users_audit
AFTER INSERT OR UPDATE OR DELETE ON users
FOR EACH ROW EXECUTE FUNCTION audit_trigger();
```

**3. è½¯åˆ é™¤æ¨¡å¼ï¼ˆSoft Deleteï¼‰**ï¼š

```sql
CREATE TABLE products (
    id INTEGER PRIMARY KEY,
    name VARCHAR(100),
    deleted_at TIMESTAMP NULL,
    deleted_by INTEGER NULL
);

-- æŸ¥è¯¢æ—¶è¿‡æ»¤å·²åˆ é™¤è®°å½•
CREATE INDEX idx_products_active ON products(id) WHERE deleted_at IS NULL;

-- åˆ›å»ºè§†å›¾åªæ˜¾ç¤ºæœªåˆ é™¤è®°å½•
CREATE VIEW active_products AS
SELECT * FROM products WHERE deleted_at IS NULL;

-- è½¯åˆ é™¤å‡½æ•°
CREATE OR REPLACE FUNCTION soft_delete_product(p_id INTEGER, p_deleted_by INTEGER)
RETURNS VOID AS $$
BEGIN
    UPDATE products
    SET deleted_at = CURRENT_TIMESTAMP,
        deleted_by = p_deleted_by
    WHERE id = p_id AND deleted_at IS NULL;
END;
$$ LANGUAGE plpgsql;
```

**4. ç‰ˆæœ¬æ§åˆ¶æ¨¡å¼ï¼ˆVersioning Patternï¼‰**ï¼š

```sql
-- ç‰ˆæœ¬åŒ–è¡¨è®¾è®¡
CREATE TABLE documents (
    id INTEGER PRIMARY KEY,
    current_version INTEGER NOT NULL DEFAULT 1,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE document_versions (
    id INTEGER PRIMARY KEY,
    document_id INTEGER REFERENCES documents(id),
    version INTEGER NOT NULL,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    created_by INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(document_id, version)
);

-- ç‰ˆæœ¬åˆ›å»ºè§¦å‘å™¨
CREATE OR REPLACE FUNCTION create_version()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO document_versions (document_id, version, title, content, created_by)
    VALUES (NEW.id, NEW.current_version, NEW.title, NEW.content, current_setting('app.user_id', TRUE)::INTEGER);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER document_version_trigger
AFTER INSERT OR UPDATE ON documents
FOR EACH ROW EXECUTE FUNCTION create_version();
```

**5. å¤šç§Ÿæˆ·æ¨¡å¼ï¼ˆMulti-Tenant Patternï¼‰**ï¼š

```sql
-- æ–¹æ¡ˆ1ï¼šå…±äº«è¡¨ï¼Œç§Ÿæˆ·IDåˆ—
CREATE TABLE orders (
    id INTEGER PRIMARY KEY,
    tenant_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,
    total DECIMAL(10,2),
    FOREIGN KEY (tenant_id) REFERENCES tenants(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE INDEX idx_orders_tenant ON orders(tenant_id);

-- è¡Œçº§å®‰å…¨ç­–ç•¥ï¼ˆPostgreSQLï¼‰
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;

CREATE POLICY tenant_isolation ON orders
    FOR ALL
    USING (tenant_id = current_setting('app.tenant_id', TRUE)::INTEGER);

-- æ–¹æ¡ˆ2ï¼šæ¯ä¸ªç§Ÿæˆ·ç‹¬ç«‹Schema
CREATE SCHEMA tenant_1;
CREATE SCHEMA tenant_2;

CREATE TABLE tenant_1.orders (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    total DECIMAL(10,2)
);

CREATE TABLE tenant_2.orders (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    total DECIMAL(10,2)
);
```

**6. æ—¶é—´åºåˆ—æ¨¡å¼ï¼ˆTime-Series Patternï¼‰**ï¼š

```sql
-- æ—¶é—´åºåˆ—è¡¨è®¾è®¡
CREATE TABLE sensor_readings (
    sensor_id INTEGER NOT NULL,
    reading_time TIMESTAMP NOT NULL,
    value DECIMAL(10,2) NOT NULL,
    PRIMARY KEY (sensor_id, reading_time)
) PARTITION BY RANGE (reading_time);

-- æŒ‰æœˆåˆ†åŒº
CREATE TABLE sensor_readings_2024_01 PARTITION OF sensor_readings
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE sensor_readings_2024_02 PARTITION OF sensor_readings
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');

-- æ—¶é—´åºåˆ—æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_sensor_readings_time ON sensor_readings(sensor_id, reading_time DESC);

-- è‡ªåŠ¨åˆ†åŒºåˆ›å»ºå‡½æ•°
CREATE OR REPLACE FUNCTION create_monthly_partition(p_table_name TEXT, p_start_date DATE)
RETURNS VOID AS $$
DECLARE
    v_partition_name TEXT;
    v_end_date DATE;
    v_sql TEXT;
BEGIN
    v_end_date := p_start_date + INTERVAL '1 month';
    v_partition_name := p_table_name || '_' || to_char(p_start_date, 'YYYY_MM');

    v_sql := format('CREATE TABLE IF NOT EXISTS %I PARTITION OF %I FOR VALUES FROM (%L) TO (%L)',
        v_partition_name, p_table_name, p_start_date, v_end_date);

    EXECUTE v_sql;
END;
$$ LANGUAGE plpgsql;
```

### 8.2. æœ€ä½³å®è·µçŸ©é˜µ

| å®è·µ | æè¿° | é€‚ç”¨åœºæ™¯ | ä¼˜å…ˆçº§ |
|------|------|---------|--------|
| **ä½¿ç”¨ä»£ç†é”®** | ä½¿ç”¨è‡ªå¢IDä½œä¸ºä¸»é”® | å¤§å¤šæ•°è¡¨ | â­â­â­â­â­ |
| **å¤–é”®çº¦æŸ** | å®šä¹‰å¤–é”®ä¿è¯å®Œæ•´æ€§ | å…³è”è¡¨ | â­â­â­â­â­ |
| **NOT NULLçº¦æŸ** | å¿…å¡«å­—æ®µä½¿ç”¨NOT NULL | å…³é”®å­—æ®µ | â­â­â­â­â­ |
| **ç´¢å¼•ä¼˜åŒ–** | ä¸ºæŸ¥è¯¢åˆ—åˆ›å»ºç´¢å¼• | é¢‘ç¹æŸ¥è¯¢ | â­â­â­â­ |
| **å‘½åè§„èŒƒ** | ç»Ÿä¸€çš„å‘½åçº¦å®š | æ‰€æœ‰å¯¹è±¡ | â­â­â­â­ |
| **æ–‡æ¡£åŒ–** | è®°å½•è®¾è®¡å†³ç­– | å¤æ‚Schema | â­â­â­ |

---

## 9. å‚è€ƒèµ„æ–™

- [å…³ç³»æ•°æ®åº“ç†è®º](./01-ç†è®ºæ¨¡å‹/01.02-å…³ç³»æ•°æ®åº“ç†è®º.md)
- [èŒƒå¼ç†è®º](./01-ç†è®ºæ¨¡å‹/01.02-å…³ç³»æ•°æ®åº“ç†è®º.md#5-èŒƒå¼ç†è®º)
- [PostgreSQL Schemaè®¾è®¡](../PostgreSQL/INDEX.md)

---

**æœ€åæ›´æ–°**ï¼š2025-01-15
**ç»´æŠ¤è€…**ï¼šData-Science Team
**çŠ¶æ€**ï¼šå®æ–½ä¸­
