# æ•°æ®åº“è®¾è®¡æ¨¡å¼å¿«é€Ÿå‚è€ƒæ‰‹å†Œï¼šé€ŸæŸ¥è¡¨ä¸å¿«é€ŸæŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-12-01
> **ç‰ˆæœ¬**ï¼šv2.0
> **çŠ¶æ€**ï¼šå·²å®Œæˆ âœ…

---

## ğŸ“‹ ç›®å½•

- [æ•°æ®åº“è®¾è®¡æ¨¡å¼å¿«é€Ÿå‚è€ƒæ‰‹å†Œï¼šé€ŸæŸ¥è¡¨ä¸å¿«é€ŸæŒ‡å—](#æ•°æ®åº“è®¾è®¡æ¨¡å¼å¿«é€Ÿå‚è€ƒæ‰‹å†Œé€ŸæŸ¥è¡¨ä¸å¿«é€ŸæŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1. é€ŸæŸ¥è¡¨åˆ†ç±»](#11-é€ŸæŸ¥è¡¨åˆ†ç±»)
  - [2. Schemaè®¾è®¡é€ŸæŸ¥è¡¨](#2-schemaè®¾è®¡é€ŸæŸ¥è¡¨)
    - [2.1. å‘½åè§„èŒƒé€ŸæŸ¥è¡¨](#21-å‘½åè§„èŒƒé€ŸæŸ¥è¡¨)
    - [2.2. æ•°æ®ç±»å‹é€ŸæŸ¥è¡¨](#22-æ•°æ®ç±»å‹é€ŸæŸ¥è¡¨)
    - [2.3. çº¦æŸè®¾è®¡é€ŸæŸ¥è¡¨](#23-çº¦æŸè®¾è®¡é€ŸæŸ¥è¡¨)
  - [3. æ•°æ®ç±»å‹é€ŸæŸ¥è¡¨](#3-æ•°æ®ç±»å‹é€ŸæŸ¥è¡¨)
    - [3.1. æ•°å€¼ç±»å‹é€‰æ‹©å†³ç­–è¡¨](#31-æ•°å€¼ç±»å‹é€‰æ‹©å†³ç­–è¡¨)
    - [3.2. æ–‡æœ¬ç±»å‹é€‰æ‹©å†³ç­–è¡¨](#32-æ–‡æœ¬ç±»å‹é€‰æ‹©å†³ç­–è¡¨)
    - [3.3. æ—¶é—´ç±»å‹é€‰æ‹©å†³ç­–è¡¨](#33-æ—¶é—´ç±»å‹é€‰æ‹©å†³ç­–è¡¨)
  - [4. ç´¢å¼•è®¾è®¡é€ŸæŸ¥è¡¨](#4-ç´¢å¼•è®¾è®¡é€ŸæŸ¥è¡¨)
    - [4.1. ç´¢å¼•ç±»å‹é€ŸæŸ¥è¡¨](#41-ç´¢å¼•ç±»å‹é€ŸæŸ¥è¡¨)
    - [4.2. ç´¢å¼•è®¾è®¡å†³ç­–è¡¨](#42-ç´¢å¼•è®¾è®¡å†³ç­–è¡¨)
  - [5. åˆ†åŒºè®¾è®¡é€ŸæŸ¥è¡¨](#5-åˆ†åŒºè®¾è®¡é€ŸæŸ¥è¡¨)
    - [5.1. åˆ†åŒºç­–ç•¥é€ŸæŸ¥è¡¨](#51-åˆ†åŒºç­–ç•¥é€ŸæŸ¥è¡¨)
    - [5.2. åˆ†åŒºè®¾è®¡å†³ç­–è¡¨](#52-åˆ†åŒºè®¾è®¡å†³ç­–è¡¨)
  - [6. è®¾è®¡æ¨¡å¼é€ŸæŸ¥è¡¨](#6-è®¾è®¡æ¨¡å¼é€ŸæŸ¥è¡¨)
    - [6.1. æ•°æ®åº“ç±»å‹é€‰æ‹©é€ŸæŸ¥è¡¨](#61-æ•°æ®åº“ç±»å‹é€‰æ‹©é€ŸæŸ¥è¡¨)
    - [6.2. å¤šç§Ÿæˆ·æ¨¡å¼é€‰æ‹©é€ŸæŸ¥è¡¨](#62-å¤šç§Ÿæˆ·æ¨¡å¼é€‰æ‹©é€ŸæŸ¥è¡¨)
    - [6.3. åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å¼é€‰æ‹©é€ŸæŸ¥è¡¨](#63-åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å¼é€‰æ‹©é€ŸæŸ¥è¡¨)
  - [7. SQLè¯­æ³•é€ŸæŸ¥è¡¨](#7-sqlè¯­æ³•é€ŸæŸ¥è¡¨)
    - [7.1. DDLè¯­æ³•é€ŸæŸ¥è¡¨](#71-ddlè¯­æ³•é€ŸæŸ¥è¡¨)
    - [7.2. DMLè¯­æ³•é€ŸæŸ¥è¡¨](#72-dmlè¯­æ³•é€ŸæŸ¥è¡¨)
  - [8. æ€§èƒ½ä¼˜åŒ–é€ŸæŸ¥è¡¨](#8-æ€§èƒ½ä¼˜åŒ–é€ŸæŸ¥è¡¨)
    - [8.1. æŸ¥è¯¢ä¼˜åŒ–é€ŸæŸ¥è¡¨](#81-æŸ¥è¯¢ä¼˜åŒ–é€ŸæŸ¥è¡¨)
    - [8.2. ç´¢å¼•ä¼˜åŒ–é€ŸæŸ¥è¡¨](#82-ç´¢å¼•ä¼˜åŒ–é€ŸæŸ¥è¡¨)
  - [9. å®‰å…¨è®¾è®¡é€ŸæŸ¥è¡¨](#9-å®‰å…¨è®¾è®¡é€ŸæŸ¥è¡¨)
    - [9.1. æƒé™æ§åˆ¶é€ŸæŸ¥è¡¨](#91-æƒé™æ§åˆ¶é€ŸæŸ¥è¡¨)
    - [9.2. æ•°æ®åŠ å¯†é€ŸæŸ¥è¡¨](#92-æ•°æ®åŠ å¯†é€ŸæŸ¥è¡¨)
  - [10. å‘é‡æ•°æ®åº“é€ŸæŸ¥è¡¨ï¼ˆ2025ï¼‰](#10-å‘é‡æ•°æ®åº“é€ŸæŸ¥è¡¨2025)
    - [10.1. pgvectoræ“ä½œé€ŸæŸ¥](#101-pgvectoræ“ä½œé€ŸæŸ¥)
    - [10.2. å‘é‡æ£€ç´¢ä»£ç æ¨¡æ¿](#102-å‘é‡æ£€ç´¢ä»£ç æ¨¡æ¿)
  - [11. å‘½ä»¤è¡Œå·¥å…·é€ŸæŸ¥](#11-å‘½ä»¤è¡Œå·¥å…·é€ŸæŸ¥)
    - [11.1. psqlå¸¸ç”¨å‘½ä»¤](#111-psqlå¸¸ç”¨å‘½ä»¤)
    - [11.2. pg_dumpå¤‡ä»½å‘½ä»¤](#112-pg_dumpå¤‡ä»½å‘½ä»¤)
    - [11.3. æ€§èƒ½åˆ†æå‘½ä»¤](#113-æ€§èƒ½åˆ†æå‘½ä»¤)
  - [12. è¿ç§»å·¥å…·é€ŸæŸ¥](#12-è¿ç§»å·¥å…·é€ŸæŸ¥)
    - [12.1. Atlaså‘½ä»¤é€ŸæŸ¥](#121-atlaså‘½ä»¤é€ŸæŸ¥)
    - [12.2. Flywayå‘½ä»¤é€ŸæŸ¥](#122-flywayå‘½ä»¤é€ŸæŸ¥)
  - [13. é…ç½®å‚æ•°é€ŸæŸ¥](#13-é…ç½®å‚æ•°é€ŸæŸ¥)
    - [13.1. PostgreSQLå…³é”®é…ç½®](#131-postgresqlå…³é”®é…ç½®)
    - [13.2. pgvectorç´¢å¼•å‚æ•°](#132-pgvectorç´¢å¼•å‚æ•°)
  - [14. å‚è€ƒèµ„æ–™](#14-å‚è€ƒèµ„æ–™)
    - [14.1. å®˜æ–¹æ–‡æ¡£](#141-å®˜æ–¹æ–‡æ¡£)
    - [14.2. ç›¸å…³æ–‡æ¡£](#142-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›æ•°æ®åº“è®¾è®¡æ¨¡å¼çš„å¿«é€Ÿå‚è€ƒæ‰‹å†Œï¼ŒåŒ…å«å„ç§é€ŸæŸ¥è¡¨å’Œå¿«é€ŸæŒ‡å—ã€‚

### 1.1. é€ŸæŸ¥è¡¨åˆ†ç±»

```mermaid
mindmap
  root((é€ŸæŸ¥è¡¨))
    Schemaè®¾è®¡
      å‘½åè§„èŒƒ
      æ•°æ®ç±»å‹
      çº¦æŸè®¾è®¡
    ç´¢å¼•è®¾è®¡
      ç´¢å¼•ç±»å‹
      ç´¢å¼•ç­–ç•¥
      ç´¢å¼•ä¼˜åŒ–
    åˆ†åŒºè®¾è®¡
      åˆ†åŒºç­–ç•¥
      åˆ†åŒºå‡½æ•°
    è®¾è®¡æ¨¡å¼
      æ¨¡å¼é€‰æ‹©
      æ¨¡å¼ç»„åˆ
    æ€§èƒ½ä¼˜åŒ–
      æŸ¥è¯¢ä¼˜åŒ–
      ç´¢å¼•ä¼˜åŒ–
    å®‰å…¨è®¾è®¡
      æƒé™æ§åˆ¶
      æ•°æ®åŠ å¯†
```

---

## 2. Schemaè®¾è®¡é€ŸæŸ¥è¡¨

### 2.1. å‘½åè§„èŒƒé€ŸæŸ¥è¡¨

| å¯¹è±¡ç±»å‹ | å‘½åè§„èŒƒ | ç¤ºä¾‹ | è¯´æ˜ |
|---------|---------|------|------|
| **è¡¨å** | å°å†™+ä¸‹åˆ’çº¿ï¼Œå¤æ•° | `users`, `order_items` | å­˜å‚¨å¤šä¸ªå®ä½“ |
| **å­—æ®µå** | å°å†™+ä¸‹åˆ’çº¿ | `user_id`, `created_at` | é¿å…å…³é”®å­—å†²çª |
| **ä¸»é”®** | `pk_` + è¡¨å | `pk_users` | æ˜ç¡®ä¸»é”® |
| **å¤–é”®** | `fk_` + è¡¨å + å­—æ®µ | `fk_orders_user_id` | æ˜ç¡®å¤–é”®å…³ç³» |
| **ç´¢å¼•** | `idx_` + è¡¨å + å­—æ®µ | `idx_users_email` | ä¾¿äºè¯†åˆ« |
| **å”¯ä¸€çº¦æŸ** | `uk_` + è¡¨å + å­—æ®µ | `uk_users_email` | æ˜ç¡®å”¯ä¸€çº¦æŸ |
| **æ£€æŸ¥çº¦æŸ** | `ck_` + è¡¨å + å­—æ®µ | `ck_users_age` | æ˜ç¡®æ£€æŸ¥çº¦æŸ |
| **å‡½æ•°** | åŠ¨è¯+åè¯ï¼Œå°å†™+ä¸‹åˆ’çº¿ | `get_user_by_id` | è¡¨è¾¾åŠŸèƒ½ |
| **è§†å›¾** | `v_` + æè¿°æ€§åç§° | `v_user_statistics` | åŒºåˆ†è§†å›¾ |
| **åºåˆ—** | `seq_` + è¡¨å | `seq_users_user_id` | æ˜ç¡®åºåˆ— |

### 2.2. æ•°æ®ç±»å‹é€ŸæŸ¥è¡¨

| æ•°æ®ç±»å‹ | å­˜å‚¨å¤§å° | èŒƒå›´/ç²¾åº¦ | é€‚ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|---------|---------|----------|---------|------|
| **SMALLINT** | 2 bytes | -32768 to 32767 | å°èŒƒå›´æ•´æ•° | å¹´é¾„ã€çŠ¶æ€ç  |
| **INTEGER** | 4 bytes | -2^31 to 2^31-1 | å¸¸ç”¨æ•´æ•° | IDã€è®¡æ•° |
| **BIGINT** | 8 bytes | -2^63 to 2^63-1 | å¤§èŒƒå›´æ•´æ•° | æ—¶é—´æˆ³ã€å¤§ID |
| **NUMERIC(p,s)** | å¯å˜ | ç²¾ç¡®å°æ•° | é‡‘é¢ã€ç²¾åº¦è¦æ±‚é«˜ | `NUMERIC(12, 2)` |
| **VARCHAR(n)** | å¯å˜ | æœ€å¤§nå­—ç¬¦ | æœ‰é•¿åº¦é™åˆ¶çš„æ–‡æœ¬ | ç”¨æˆ·åã€é‚®ç®± |
| **TEXT** | å¯å˜ | æ— é™åˆ¶ | é•¿æ–‡æœ¬ | æ–‡ç« å†…å®¹ã€æè¿° |
| **BOOLEAN** | 1 byte | true/false | å¸ƒå°”å€¼ | æ˜¯å¦æ¿€æ´» |
| **DATE** | 4 bytes | æ—¥æœŸ | ä»…æ—¥æœŸ | ç”Ÿæ—¥ã€æ—¥æœŸ |
| **TIMESTAMP** | 8 bytes | æ—¥æœŸæ—¶é—´ï¼ˆæ— æ—¶åŒºï¼‰ | æœ¬åœ°æ—¶é—´ | ä¸æ¨è |
| **TIMESTAMPTZ** | 8 bytes | æ—¥æœŸæ—¶é—´ï¼ˆæœ‰æ—¶åŒºï¼‰ | æ—¶é—´æˆ³ | æ¨èä½¿ç”¨ |
| **JSONB** | å¯å˜ | JSONæ•°æ® | åŠç»“æ„åŒ–æ•°æ® | é…ç½®ã€å…ƒæ•°æ® |
| **UUID** | 16 bytes | UUID | å…¨å±€å”¯ä¸€ID | åˆ†å¸ƒå¼ID |
| **BYTEA** | å¯å˜ | äºŒè¿›åˆ¶æ•°æ® | æ–‡ä»¶ã€å›¾ç‰‡ | äºŒè¿›åˆ¶å­˜å‚¨ |

### 2.3. çº¦æŸè®¾è®¡é€ŸæŸ¥è¡¨

| çº¦æŸç±»å‹ | SQLè¯­æ³• | ç¤ºä¾‹ | è¯´æ˜ |
|---------|---------|------|------|
| **ä¸»é”®** | `PRIMARY KEY` | `user_id BIGSERIAL PRIMARY KEY` | å”¯ä¸€æ ‡è¯† |
| **å¤–é”®** | `FOREIGN KEY` | `FOREIGN KEY (user_id) REFERENCES users(user_id)` | å¼•ç”¨å®Œæ•´æ€§ |
| **å”¯ä¸€çº¦æŸ** | `UNIQUE` | `email VARCHAR(100) UNIQUE` | å”¯ä¸€å€¼ |
| **éç©ºçº¦æŸ** | `NOT NULL` | `username VARCHAR(50) NOT NULL` | å¿…å¡«å­—æ®µ |
| **æ£€æŸ¥çº¦æŸ** | `CHECK` | `CHECK (age >= 0 AND age <= 150)` | å€¼èŒƒå›´æ£€æŸ¥ |
| **é»˜è®¤å€¼** | `DEFAULT` | `created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP` | é»˜è®¤å€¼ |

---

## 3. æ•°æ®ç±»å‹é€ŸæŸ¥è¡¨

### 3.1. æ•°å€¼ç±»å‹é€‰æ‹©å†³ç­–è¡¨

| éœ€æ±‚ | æ¨èç±»å‹ | ç¤ºä¾‹ |
|------|---------|------|
| **å°èŒƒå›´æ•´æ•°ï¼ˆ-32768 to 32767ï¼‰** | SMALLINT | å¹´é¾„ã€çŠ¶æ€ç  |
| **å¸¸ç”¨æ•´æ•°ï¼ˆ-2^31 to 2^31-1ï¼‰** | INTEGER | IDã€è®¡æ•° |
| **å¤§èŒƒå›´æ•´æ•°ï¼ˆ-2^63 to 2^63-1ï¼‰** | BIGINT | æ—¶é—´æˆ³ã€å¤§ID |
| **ç²¾ç¡®å°æ•°ï¼ˆé‡‘é¢ï¼‰** | NUMERIC(12, 2) | é‡‘é¢ã€ä»·æ ¼ |
| **æµ®ç‚¹æ•°ï¼ˆç§‘å­¦è®¡ç®—ï¼‰** | DOUBLE PRECISION | ç§‘å­¦è®¡ç®— |

### 3.2. æ–‡æœ¬ç±»å‹é€‰æ‹©å†³ç­–è¡¨

| éœ€æ±‚ | æ¨èç±»å‹ | ç¤ºä¾‹ |
|------|---------|------|
| **å›ºå®šé•¿åº¦æ–‡æœ¬** | CHAR(n) | å›½å®¶ä»£ç ï¼ˆ2å­—ç¬¦ï¼‰ |
| **æœ‰é•¿åº¦é™åˆ¶æ–‡æœ¬** | VARCHAR(n) | ç”¨æˆ·åï¼ˆ50å­—ç¬¦ï¼‰ã€é‚®ç®±ï¼ˆ100å­—ç¬¦ï¼‰ |
| **é•¿æ–‡æœ¬ï¼ˆæ— é™åˆ¶ï¼‰** | TEXT | æ–‡ç« å†…å®¹ã€æè¿° |
| **åŠç»“æ„åŒ–æ•°æ®** | JSONB | é…ç½®ã€å…ƒæ•°æ® |

### 3.3. æ—¶é—´ç±»å‹é€‰æ‹©å†³ç­–è¡¨

| éœ€æ±‚ | æ¨èç±»å‹ | ç¤ºä¾‹ |
|------|---------|------|
| **ä»…æ—¥æœŸ** | DATE | ç”Ÿæ—¥ã€æ—¥æœŸ |
| **æ—¥æœŸæ—¶é—´ï¼ˆæ¨èï¼‰** | TIMESTAMPTZ | æ—¶é—´æˆ³ã€åˆ›å»ºæ—¶é—´ |
| **æ—¶é—´é—´éš”** | INTERVAL | æŒç»­æ—¶é—´ |

---

## 4. ç´¢å¼•è®¾è®¡é€ŸæŸ¥è¡¨

### 4.1. ç´¢å¼•ç±»å‹é€ŸæŸ¥è¡¨

| ç´¢å¼•ç±»å‹ | SQLè¯­æ³• | é€‚ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|---------|---------|---------|------|
| **B-Treeç´¢å¼•** | `CREATE INDEX` | é»˜è®¤ç´¢å¼•ï¼Œé€šç”¨åœºæ™¯ | `CREATE INDEX idx_users_email ON users(email)` |
| **å”¯ä¸€ç´¢å¼•** | `CREATE UNIQUE INDEX` | å”¯ä¸€å€¼çº¦æŸ | `CREATE UNIQUE INDEX uk_users_email ON users(email)` |
| **éƒ¨åˆ†ç´¢å¼•** | `CREATE INDEX ... WHERE` | æ¡ä»¶æŸ¥è¯¢ | `CREATE INDEX idx_active_users ON users(email) WHERE status = 'active'` |
| **è¡¨è¾¾å¼ç´¢å¼•** | `CREATE INDEX ... ON ... (è¡¨è¾¾å¼)` | å‡½æ•°æŸ¥è¯¢ | `CREATE INDEX idx_users_lower_email ON users(LOWER(email))` |
| **å¤åˆç´¢å¼•** | `CREATE INDEX ... ON ... (col1, col2)` | å¤šå­—æ®µæŸ¥è¯¢ | `CREATE INDEX idx_orders_user_status ON orders(user_id, status)` |
| **è¦†ç›–ç´¢å¼•** | åŒ…å«æŸ¥è¯¢æ‰€éœ€å­—æ®µ | é¿å…å›è¡¨ | `CREATE INDEX idx_users_cover ON users(user_id, email, name)` |
| **GINç´¢å¼•** | `CREATE INDEX ... USING GIN` | å…¨æ–‡æœç´¢ã€æ•°ç»„ | `CREATE INDEX idx_articles_content ON articles USING GIN(to_tsvector('english', content))` |
| **GiSTç´¢å¼•** | `CREATE INDEX ... USING GIST` | åœ°ç†ç©ºé—´æ•°æ® | `CREATE INDEX idx_locations_geom ON locations USING GIST(geom)` |
| **HNSWç´¢å¼•** | `CREATE INDEX ... USING hnsw` | å‘é‡ç›¸ä¼¼åº¦æœç´¢ | `CREATE INDEX idx_products_embedding ON products USING hnsw (embedding vector_cosine_ops)` |

### 4.2. ç´¢å¼•è®¾è®¡å†³ç­–è¡¨

| åœºæ™¯ | æ¨èç´¢å¼• | SQLç¤ºä¾‹ |
|------|---------|---------|
| **ä¸»é”®å­—æ®µ** | è‡ªåŠ¨åˆ›å»ºä¸»é”®ç´¢å¼• | `PRIMARY KEY (user_id)` |
| **å¤–é”®å­—æ®µ** | B-Treeç´¢å¼• | `CREATE INDEX idx_orders_user_id ON orders(user_id)` |
| **WHEREæ¡ä»¶å­—æ®µ** | B-Treeç´¢å¼• | `CREATE INDEX idx_users_status ON users(status)` |
| **ORDER BYå­—æ®µ** | B-Treeç´¢å¼• | `CREATE INDEX idx_orders_created_at ON orders(created_at DESC)` |
| **JOINå­—æ®µ** | B-Treeç´¢å¼• | `CREATE INDEX idx_orders_user_id ON orders(user_id)` |
| **å…¨æ–‡æœç´¢** | GINç´¢å¼• | `CREATE INDEX idx_articles_content ON articles USING GIN(to_tsvector('english', content))` |
| **åœ°ç†ç©ºé—´æŸ¥è¯¢** | GiSTç´¢å¼• | `CREATE INDEX idx_locations_geom ON locations USING GIST(geom)` |
| **å‘é‡ç›¸ä¼¼åº¦æœç´¢** | HNSWç´¢å¼• | `CREATE INDEX idx_products_embedding ON products USING hnsw (embedding vector_cosine_ops)` |
| **æ¡ä»¶æŸ¥è¯¢ï¼ˆéƒ¨åˆ†æ•°æ®ï¼‰** | éƒ¨åˆ†ç´¢å¼• | `CREATE INDEX idx_active_users ON users(email) WHERE status = 'active'` |
| **å‡½æ•°æŸ¥è¯¢** | è¡¨è¾¾å¼ç´¢å¼• | `CREATE INDEX idx_users_lower_email ON users(LOWER(email))` |

---

## 5. åˆ†åŒºè®¾è®¡é€ŸæŸ¥è¡¨

### 5.1. åˆ†åŒºç­–ç•¥é€ŸæŸ¥è¡¨

| åˆ†åŒºç­–ç•¥ | SQLè¯­æ³• | é€‚ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|---------|---------|---------|------|
| **èŒƒå›´åˆ†åŒº** | `PARTITION BY RANGE` | æ—¶é—´åºåˆ—æ•°æ®ã€æœ‰åºæ•°æ® | `PARTITION BY RANGE (created_at)` |
| **åˆ—è¡¨åˆ†åŒº** | `PARTITION BY LIST` | ç¦»æ•£å€¼åˆ†åŒº | `PARTITION BY LIST (region)` |
| **å“ˆå¸Œåˆ†åŒº** | `PARTITION BY HASH` | æ•°æ®å‡åŒ€åˆ†å¸ƒ | `PARTITION BY HASH (user_id)` |
| **å¤åˆåˆ†åŒº** | ç»„åˆå¤šç§ç­–ç•¥ | å¤æ‚åœºæ™¯ | `PARTITION BY RANGE (created_at), LIST (region)` |

### 5.2. åˆ†åŒºè®¾è®¡å†³ç­–è¡¨

| åœºæ™¯ | æ¨èåˆ†åŒºç­–ç•¥ | SQLç¤ºä¾‹ |
|------|------------|---------|
| **æ—¶é—´åºåˆ—æ•°æ®** | èŒƒå›´åˆ†åŒºï¼ˆæŒ‰æœˆ/å¹´ï¼‰ | `PARTITION BY RANGE (created_at)` |
| **æŒ‰åœ°åŒºåˆ†åŒº** | åˆ—è¡¨åˆ†åŒº | `PARTITION BY LIST (region)` |
| **æ•°æ®å‡åŒ€åˆ†å¸ƒ** | å“ˆå¸Œåˆ†åŒº | `PARTITION BY HASH (user_id)` |
| **å¤§è¡¨æŸ¥è¯¢ä¼˜åŒ–** | èŒƒå›´åˆ†åŒº + ç´¢å¼• | `PARTITION BY RANGE (created_at)` + ç´¢å¼• |

---

## 6. è®¾è®¡æ¨¡å¼é€ŸæŸ¥è¡¨

### 6.1. æ•°æ®åº“ç±»å‹é€‰æ‹©é€ŸæŸ¥è¡¨

| æ•°æ®ç‰¹å¾ | æ¨èæ•°æ®åº“ç±»å‹ | ä»£è¡¨ç³»ç»Ÿ | æ–‡æ¡£é“¾æ¥ |
|---------|--------------|---------|---------|
| **ç»“æ„åŒ–æ•°æ® + å¼ºäº‹åŠ¡** | å…³ç³»æ•°æ®åº“ | PostgreSQLã€MySQL | [07.01](./07.01-Schemaè®¾è®¡æ–¹æ³•è®º.md) |
| **å‘é‡æ•°æ® + ç›¸ä¼¼åº¦æœç´¢** | å‘é‡æ•°æ®åº“ | pgvectorã€Pinecone | [07.10](./07.10-å‘é‡æ•°æ®åº“è®¾è®¡.md) |
| **åœ°ç†æ•°æ® + ç©ºé—´æŸ¥è¯¢** | åœ°ç†ç©ºé—´æ•°æ®åº“ | PostGIS | [07.11](./07.11-åœ°ç†ç©ºé—´æ•°æ®åº“è®¾è®¡.md) |
| **å›¾æ•°æ® + å›¾æŸ¥è¯¢** | çŸ¥è¯†å›¾è°± | Neo4jã€Apache AGE | [07.12](./07.12-çŸ¥è¯†å›¾è°±æ•°æ®åº“è®¾è®¡å®æˆ˜.md) |
| **æ—¶åºæ•°æ® + æ—¶é—´çª—å£æŸ¥è¯¢** | æ—¶åºæ•°æ®åº“ | TimescaleDBã€InfluxDB | [07.18](./07.18-æ—¶åºæ•°æ®åº“è®¾è®¡æ¨¡å¼.md) |
| **æ–‡æ¡£æ•°æ® + çµæ´»Schema** | æ–‡æ¡£æ•°æ®åº“ | MongoDBã€PostgreSQL JSONB | [07.19](./07.19-æ–‡æ¡£æ•°æ®åº“è®¾è®¡æ¨¡å¼.md) |
| **åˆ†ææ•°æ® + èšåˆæŸ¥è¯¢** | åˆ—å¼æ•°æ®åº“ | ClickHouseã€Snowflake | [07.21](./07.21-åˆ—å¼æ•°æ®åº“è®¾è®¡æ¨¡å¼.md) |
| **ç¼“å­˜æ•°æ® + é«˜é€Ÿè®¿é—®** | å†…å­˜æ•°æ®åº“ | Redisã€Memcached | [07.22](./07.22-å†…å­˜æ•°æ®åº“è®¾è®¡æ¨¡å¼.md) |

### 6.2. å¤šç§Ÿæˆ·æ¨¡å¼é€‰æ‹©é€ŸæŸ¥è¡¨

| ç§Ÿæˆ·è§„æ¨¡ | éš”ç¦»éœ€æ±‚ | æ¨èæ¨¡å¼ | æ–‡æ¡£é“¾æ¥ |
|---------|---------|---------|---------|
| **å¤§å‹ä¼ä¸š** | é«˜éš”ç¦» | ç‹¬ç«‹æ•°æ®åº“ | [07.20](./07.20-å¤šç§Ÿæˆ·æ•°æ®åº“è®¾è®¡æ¨¡å¼.md) |
| **ä¸­å‹ä¼ä¸š** | ä¸­éš”ç¦» | å…±äº«æ•°æ®åº“+Schema | [07.20](./07.20-å¤šç§Ÿæˆ·æ•°æ®åº“è®¾è®¡æ¨¡å¼.md) |
| **å°å‹ä¼ä¸š** | ä½éš”ç¦» | å…±äº«æ•°æ®åº“+RLS | [07.20](./07.20-å¤šç§Ÿæˆ·æ•°æ®åº“è®¾è®¡æ¨¡å¼.md) |

### 6.3. åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å¼é€‰æ‹©é€ŸæŸ¥è¡¨

| ä¸€è‡´æ€§éœ€æ±‚ | äº‹åŠ¡å¤æ‚åº¦ | æ¨èæ¨¡å¼ | æ–‡æ¡£é“¾æ¥ |
|-----------|-----------|---------|---------|
| **å¼ºä¸€è‡´æ€§** | ç®€å•/å¤æ‚ | 2PC | [07.17](./07.17-åˆ†å¸ƒå¼æ•°æ®åº“è®¾è®¡æ¨¡å¼.md) |
| **æœ€ç»ˆä¸€è‡´æ€§** | ç®€å•äº‹åŠ¡ | Saga | [07.17](./07.17-åˆ†å¸ƒå¼æ•°æ®åº“è®¾è®¡æ¨¡å¼.md) |
| **æœ€ç»ˆä¸€è‡´æ€§** | å¤æ‚äº‹åŠ¡ + å®¡è®¡éœ€æ±‚ | äº‹ä»¶æº¯æº | [07.17](./07.17-åˆ†å¸ƒå¼æ•°æ®åº“è®¾è®¡æ¨¡å¼.md) |
| **æœ€ç»ˆä¸€è‡´æ€§** | å¤æ‚äº‹åŠ¡ + è¡¥å¿éœ€æ±‚ | TCC | [07.17](./07.17-åˆ†å¸ƒå¼æ•°æ®åº“è®¾è®¡æ¨¡å¼.md) |

---

## 7. SQLè¯­æ³•é€ŸæŸ¥è¡¨

### 7.1. DDLè¯­æ³•é€ŸæŸ¥è¡¨

| æ“ä½œ | SQLè¯­æ³• | ç¤ºä¾‹ |
|------|---------|------|
| **åˆ›å»ºè¡¨** | `CREATE TABLE` | `CREATE TABLE users (user_id BIGSERIAL PRIMARY KEY, username VARCHAR(50) NOT NULL)` |
| **ä¿®æ”¹è¡¨** | `ALTER TABLE` | `ALTER TABLE users ADD COLUMN email VARCHAR(100)` |
| **åˆ é™¤è¡¨** | `DROP TABLE` | `DROP TABLE users CASCADE` |
| **åˆ›å»ºç´¢å¼•** | `CREATE INDEX` | `CREATE INDEX idx_users_email ON users(email)` |
| **åˆ é™¤ç´¢å¼•** | `DROP INDEX` | `DROP INDEX idx_users_email` |
| **åˆ›å»ºè§†å›¾** | `CREATE VIEW` | `CREATE VIEW v_active_users AS SELECT * FROM users WHERE status = 'active'` |
| **åˆ›å»ºå‡½æ•°** | `CREATE FUNCTION` | `CREATE FUNCTION get_user(id BIGINT) RETURNS TABLE AS $$ ... $$` |
| **åˆ›å»ºè§¦å‘å™¨** | `CREATE TRIGGER` | `CREATE TRIGGER trg_update_timestamp BEFORE UPDATE ON users FOR EACH ROW EXECUTE FUNCTION update_timestamp()` |

### 7.2. DMLè¯­æ³•é€ŸæŸ¥è¡¨

| æ“ä½œ | SQLè¯­æ³• | ç¤ºä¾‹ |
|------|---------|------|
| **æ’å…¥æ•°æ®** | `INSERT INTO` | `INSERT INTO users (username, email) VALUES ('alice', 'alice@example.com')` |
| **æ›´æ–°æ•°æ®** | `UPDATE` | `UPDATE users SET email = 'new@example.com' WHERE user_id = 1` |
| **åˆ é™¤æ•°æ®** | `DELETE FROM` | `DELETE FROM users WHERE user_id = 1` |
| **æŸ¥è¯¢æ•°æ®** | `SELECT` | `SELECT * FROM users WHERE status = 'active'` |
| **JOINæŸ¥è¯¢** | `JOIN` | `SELECT * FROM users u JOIN orders o ON u.user_id = o.user_id` |
| **èšåˆæŸ¥è¯¢** | `GROUP BY` | `SELECT user_id, COUNT(*) FROM orders GROUP BY user_id` |
| **å­æŸ¥è¯¢** | `SELECT ... WHERE ... IN (SELECT ...)` | `SELECT * FROM users WHERE user_id IN (SELECT user_id FROM orders)` |

---

## 8. æ€§èƒ½ä¼˜åŒ–é€ŸæŸ¥è¡¨

### 8.1. æŸ¥è¯¢ä¼˜åŒ–é€ŸæŸ¥è¡¨

| é—®é¢˜ | ä¼˜åŒ–æ–¹æ³• | SQLç¤ºä¾‹ |
|------|---------|---------|
| **å…¨è¡¨æ‰«æ** | æ·»åŠ ç´¢å¼• | `CREATE INDEX idx_users_email ON users(email)` |
| **N+1æŸ¥è¯¢** | ä½¿ç”¨JOIN | `SELECT u.*, o.* FROM users u LEFT JOIN orders o ON u.user_id = o.user_id` |
| **æ…¢åˆ†é¡µæŸ¥è¯¢** | ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µ | `SELECT * FROM orders WHERE created_at < $1 ORDER BY created_at DESC LIMIT 20` |
| **é‡å¤è®¡ç®—** | ä½¿ç”¨ç‰©åŒ–è§†å›¾ | `CREATE MATERIALIZED VIEW mv_user_stats AS SELECT ...` |
| **å¤§è¡¨æŸ¥è¯¢** | ä½¿ç”¨åˆ†åŒº | `PARTITION BY RANGE (created_at)` |

### 8.2. ç´¢å¼•ä¼˜åŒ–é€ŸæŸ¥è¡¨

| åœºæ™¯ | ä¼˜åŒ–æ–¹æ³• | SQLç¤ºä¾‹ |
|------|---------|---------|
| **å¤–é”®å­—æ®µ** | åˆ›å»ºç´¢å¼• | `CREATE INDEX idx_orders_user_id ON orders(user_id)` |
| **WHEREæ¡ä»¶å­—æ®µ** | åˆ›å»ºç´¢å¼• | `CREATE INDEX idx_users_status ON users(status)` |
| **ORDER BYå­—æ®µ** | åˆ›å»ºç´¢å¼• | `CREATE INDEX idx_orders_created_at ON orders(created_at DESC)` |
| **å¤åˆæŸ¥è¯¢** | åˆ›å»ºå¤åˆç´¢å¼• | `CREATE INDEX idx_orders_user_status ON orders(user_id, status)` |
| **æ¡ä»¶æŸ¥è¯¢** | åˆ›å»ºéƒ¨åˆ†ç´¢å¼• | `CREATE INDEX idx_active_users ON users(email) WHERE status = 'active'` |
| **å‡½æ•°æŸ¥è¯¢** | åˆ›å»ºè¡¨è¾¾å¼ç´¢å¼• | `CREATE INDEX idx_users_lower_email ON users(LOWER(email))` |

---

## 9. å®‰å…¨è®¾è®¡é€ŸæŸ¥è¡¨

### 9.1. æƒé™æ§åˆ¶é€ŸæŸ¥è¡¨

| éœ€æ±‚ | å®ç°æ–¹æ³• | SQLç¤ºä¾‹ |
|------|---------|---------|
| **è¡Œçº§å®‰å…¨** | RLSç­–ç•¥ | `ALTER TABLE orders ENABLE ROW LEVEL SECURITY; CREATE POLICY ...` |
| **åˆ—çº§æƒé™** | GRANTåˆ—æƒé™ | `GRANT SELECT (username, email) ON users TO app_user` |
| **è§’è‰²æƒé™** | RBAC | `CREATE ROLE app_user; GRANT SELECT ON users TO app_user` |
| **å¤šç§Ÿæˆ·éš”ç¦»** | RLS + ç§Ÿæˆ·ID | `CREATE POLICY tenant_isolation ON orders USING (tenant_id = get_current_tenant_id())` |

### 9.2. æ•°æ®åŠ å¯†é€ŸæŸ¥è¡¨

| éœ€æ±‚ | å®ç°æ–¹æ³• | SQLç¤ºä¾‹ |
|------|---------|---------|
| **å­—æ®µåŠ å¯†** | pgcrypto | `INSERT INTO users (password_hash) VALUES (crypt('password', gen_salt('bf')))` |
| **ä¼ è¾“åŠ å¯†** | SSL/TLS | `ALTER SYSTEM SET ssl = on` |
| **å­˜å‚¨åŠ å¯†** | TDE | æ•°æ®åº“çº§åˆ«åŠ å¯† |

---

## 10. å‘é‡æ•°æ®åº“é€ŸæŸ¥è¡¨ï¼ˆ2025ï¼‰

### 10.1. pgvectoræ“ä½œé€ŸæŸ¥

| æ“ä½œ | SQLè¯­æ³• | è¯´æ˜ |
|------|---------|------|
| **å¯ç”¨æ‰©å±•** | `CREATE EXTENSION vector;` | å®‰è£…pgvector |
| **åˆ›å»ºå‘é‡åˆ—** | `embedding vector(1536)` | 1536ç»´å‘é‡ |
| **ä½™å¼¦è·ç¦»** | `embedding <=> query_vec` | å€¼è¶Šå°è¶Šç›¸ä¼¼ |
| **æ¬§æ°è·ç¦»** | `embedding <-> query_vec` | L2è·ç¦» |
| **å†…ç§¯** | `embedding <#> query_vec` | éœ€è¦å½’ä¸€åŒ– |
| **HNSWç´¢å¼•** | `USING hnsw (embedding vector_cosine_ops)` | æ¨èç”¨äºANN |
| **IVFFlatç´¢å¼•** | `USING ivfflat (embedding vector_l2_ops)` | å¤§è§„æ¨¡æ•°æ® |

### 10.2. å‘é‡æ£€ç´¢ä»£ç æ¨¡æ¿

```sql
-- åˆ›å»ºå‘é‡è¡¨
CREATE TABLE documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    content TEXT NOT NULL,
    embedding vector(1536),
    metadata JSONB DEFAULT '{}'
);

-- HNSWç´¢å¼•ï¼ˆæ¨èå‚æ•°ï¼‰
CREATE INDEX idx_docs_embedding ON documents
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- ç›¸ä¼¼åº¦æœç´¢
SELECT id, content, 1 - (embedding <=> $1) AS similarity
FROM documents
ORDER BY embedding <=> $1
LIMIT 10;

-- æ··åˆæ£€ç´¢ï¼ˆå‘é‡+å…³é”®è¯ï¼‰
WITH vector_results AS (
    SELECT id, content, ROW_NUMBER() OVER (ORDER BY embedding <=> $1) AS vrank
    FROM documents ORDER BY embedding <=> $1 LIMIT 20
),
text_results AS (
    SELECT id, content, ROW_NUMBER() OVER (
        ORDER BY ts_rank(to_tsvector('english', content), plainto_tsquery($2)) DESC
    ) AS trank
    FROM documents
    WHERE to_tsvector('english', content) @@ plainto_tsquery($2)
    LIMIT 20
)
SELECT COALESCE(v.id, t.id), COALESCE(v.content, t.content),
       1.0/(60+COALESCE(v.vrank,1000)) + 1.0/(60+COALESCE(t.trank,1000)) AS score
FROM vector_results v FULL JOIN text_results t USING(id)
ORDER BY score DESC LIMIT 10;
```

---

## 11. å‘½ä»¤è¡Œå·¥å…·é€ŸæŸ¥

### 11.1. psqlå¸¸ç”¨å‘½ä»¤

| å‘½ä»¤ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `\l` | åˆ—å‡ºæ•°æ®åº“ | `\l` |
| `\c dbname` | è¿æ¥æ•°æ®åº“ | `\c mydb` |
| `\dt` | åˆ—å‡ºè¡¨ | `\dt public.*` |
| `\d tablename` | æŸ¥çœ‹è¡¨ç»“æ„ | `\d users` |
| `\di` | åˆ—å‡ºç´¢å¼• | `\di` |
| `\df` | åˆ—å‡ºå‡½æ•° | `\df public.*` |
| `\x` | æ‰©å±•æ˜¾ç¤º | `\x auto` |
| `\timing` | æ˜¾ç¤ºæ‰§è¡Œæ—¶é—´ | `\timing on` |
| `\i file.sql` | æ‰§è¡ŒSQLæ–‡ä»¶ | `\i schema.sql` |
| `\copy` | å¯¼å…¥/å¯¼å‡ºæ•°æ® | `\copy table TO 'file.csv' CSV` |

### 11.2. pg_dumpå¤‡ä»½å‘½ä»¤

```bash
# å¤‡ä»½å•ä¸ªæ•°æ®åº“
pg_dump -h host -U user -d dbname -F c -f backup.dump

# åªå¤‡ä»½Schema
pg_dump -h host -U user -d dbname -s -f schema.sql

# åªå¤‡ä»½æ•°æ®
pg_dump -h host -U user -d dbname -a -f data.sql

# å¤‡ä»½ç‰¹å®šè¡¨
pg_dump -h host -U user -d dbname -t users -t orders -f tables.sql

# æ¢å¤å¤‡ä»½
pg_restore -h host -U user -d dbname -F c backup.dump
```

### 11.3. æ€§èƒ½åˆ†æå‘½ä»¤

```bash
# æŸ¥çœ‹è¿æ¥æ•°
psql -c "SELECT count(*) FROM pg_stat_activity;"

# æŸ¥çœ‹æ…¢æŸ¥è¯¢
psql -c "SELECT query, calls, mean_exec_time
         FROM pg_stat_statements
         ORDER BY mean_exec_time DESC LIMIT 10;"

# æŸ¥çœ‹è¡¨å¤§å°
psql -c "SELECT relname, pg_size_pretty(pg_total_relation_size(oid))
         FROM pg_class WHERE relkind='r' ORDER BY pg_total_relation_size(oid) DESC LIMIT 10;"

# æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨ç‡
psql -c "SELECT relname, idx_scan, seq_scan, idx_tup_fetch
         FROM pg_stat_user_tables ORDER BY seq_scan DESC LIMIT 10;"
```

---

## 12. è¿ç§»å·¥å…·é€ŸæŸ¥

### 12.1. Atlaså‘½ä»¤é€ŸæŸ¥

```bash
# Schemaæ£€æŸ¥
atlas schema inspect --url "postgres://user:pass@host/db"

# ç”Ÿæˆè¿ç§»å·®å¼‚
atlas schema diff --from "postgres://host/old" --to "file://schema.hcl"

# åº”ç”¨è¿ç§»
atlas schema apply --url "postgres://host/db" --to "file://schema.hcl"

# ç”Ÿæˆè¿ç§»æ–‡ä»¶
atlas migrate diff migration_name --dir "file://migrations" --to "file://schema.hcl"

# æ‰§è¡Œè¿ç§»
atlas migrate apply --dir "file://migrations" --url "postgres://host/db"
```

### 12.2. Flywayå‘½ä»¤é€ŸæŸ¥

```bash
# æ‰§è¡Œè¿ç§»
flyway -url="jdbc:postgresql://host/db" -user=user -password=pass migrate

# æŸ¥çœ‹è¿ç§»çŠ¶æ€
flyway info

# éªŒè¯è¿ç§»
flyway validate

# æ¸…ç†æ•°æ®åº“
flyway clean

# ç”ŸæˆåŸºçº¿
flyway baseline
```

---

## 13. é…ç½®å‚æ•°é€ŸæŸ¥

### 13.1. PostgreSQLå…³é”®é…ç½®

| å‚æ•° | æ¨èå€¼ | è¯´æ˜ |
|------|-------|------|
| `shared_buffers` | RAMçš„25% | å…±äº«ç¼“å­˜ |
| `effective_cache_size` | RAMçš„75% | æŸ¥è¯¢è§„åˆ’å™¨å‚è€ƒ |
| `work_mem` | 64MB-256MB | æ’åº/å“ˆå¸Œå†…å­˜ |
| `maintenance_work_mem` | 512MB-2GB | ç»´æŠ¤æ“ä½œå†…å­˜ |
| `max_connections` | 100-500 | æœ€å¤§è¿æ¥æ•° |
| `wal_level` | logical | é€»è¾‘å¤åˆ¶éœ€è¦ |
| `max_wal_size` | 4GB-16GB | WALæœ€å¤§å¤§å° |
| `random_page_cost` | 1.1 (SSD) | SSDä¼˜åŒ– |

### 13.2. pgvectorç´¢å¼•å‚æ•°

| å‚æ•° | æ¨èå€¼ | è¯´æ˜ |
|------|-------|------|
| `m` | 16-32 | HNSWå›¾è¿æ¥æ•° |
| `ef_construction` | 64-200 | æ„å»ºæ—¶æœç´¢èŒƒå›´ |
| `hnsw.ef_search` | 40-100 | æŸ¥è¯¢æ—¶æœç´¢èŒƒå›´ |
| `lists` | sqrt(n) | IVFFlatèšç±»æ•° |
| `probes` | 10-50 | IVFFlatæŸ¥è¯¢æ¢é’ˆæ•° |

---

## 14. å‚è€ƒèµ„æ–™

### 14.1. å®˜æ–¹æ–‡æ¡£

- [PostgreSQLå®˜æ–¹æ–‡æ¡£](https://www.postgresql.org/docs/)
- [pgvectoræ–‡æ¡£](https://github.com/pgvector/pgvector)
- [Atlasæ–‡æ¡£](https://atlasgo.io/docs)
- [Flywayæ–‡æ¡£](https://flywaydb.org/documentation/)

### 14.2. ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“è®¾è®¡æ¨¡å¼æ€»ç»“ä¸ç´¢å¼•](./07.27-æ•°æ®åº“è®¾è®¡æ¨¡å¼æ€»ç»“ä¸ç´¢å¼•.md)
- [æ•°æ®åº“è®¾è®¡æ¨¡å¼æœ€ä½³å®è·µæ€»ç»“](./07.29-æ•°æ®åº“è®¾è®¡æ¨¡å¼æœ€ä½³å®è·µæ€»ç»“.md)
- [æ•°æ®åº“è®¾è®¡æ¨¡å¼å¸¸è§é—®é¢˜FAQ](./07.32-æ•°æ®åº“è®¾è®¡æ¨¡å¼å¸¸è§é—®é¢˜FAQ.md)
- [å‘é‡æ•°æ®åº“è®¾è®¡](./07.10-å‘é‡æ•°æ®åº“è®¾è®¡.md)
- [æ•°æ®åº“è¿ç§»ä¸ç‰ˆæœ¬ç®¡ç†](./07.07-æ•°æ®åº“è¿ç§»ä¸ç‰ˆæœ¬ç®¡ç†.md)

---

**æœ€åæ›´æ–°**ï¼š2025-12-01
**ç»´æŠ¤è€…**ï¼šData-Science Team
**çŠ¶æ€**ï¼šå·²å®Œæˆ âœ…
