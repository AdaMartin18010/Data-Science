# æ•°æ®åº“è®¾è®¡æ¡ˆä¾‹æ·±åº¦è§£æï¼šä»éœ€æ±‚åˆ°å®ç°çš„å®Œæ•´è¿‡ç¨‹

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-12-01
> **ç‰ˆæœ¬**ï¼šv2.0 (å¢å¼ºç‰ˆ)
> **çŠ¶æ€**ï¼šå®æ–½ä¸­

---

## ğŸ“‹ ç›®å½•

- [æ•°æ®åº“è®¾è®¡æ¡ˆä¾‹æ·±åº¦è§£æï¼šä»éœ€æ±‚åˆ°å®ç°çš„å®Œæ•´è¿‡ç¨‹](#æ•°æ®åº“è®¾è®¡æ¡ˆä¾‹æ·±åº¦è§£æä»éœ€æ±‚åˆ°å®ç°çš„å®Œæ•´è¿‡ç¨‹)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1. æ¡ˆä¾‹é€‰æ‹©](#11-æ¡ˆä¾‹é€‰æ‹©)
  - [2. æ¡ˆä¾‹1ï¼šç”µå•†å¹³å°å®Œæ•´è®¾è®¡](#2-æ¡ˆä¾‹1ç”µå•†å¹³å°å®Œæ•´è®¾è®¡)
    - [2.1. éœ€æ±‚åˆ†æ](#21-éœ€æ±‚åˆ†æ)
    - [2.2. æ¦‚å¿µæ¨¡å‹è®¾è®¡](#22-æ¦‚å¿µæ¨¡å‹è®¾è®¡)
    - [2.3. é€»è¾‘æ¨¡å‹è®¾è®¡](#23-é€»è¾‘æ¨¡å‹è®¾è®¡)
    - [2.4. è®¾è®¡å†³ç­–è®°å½•](#24-è®¾è®¡å†³ç­–è®°å½•)
  - [3. æ¡ˆä¾‹2ï¼šé‡‘èæ”¯ä»˜ç³»ç»Ÿè®¾è®¡](#3-æ¡ˆä¾‹2é‡‘èæ”¯ä»˜ç³»ç»Ÿè®¾è®¡)
    - [3.1. éœ€æ±‚åˆ†æ](#31-éœ€æ±‚åˆ†æ)
    - [3.2. å®Œæ•´Schemaè®¾è®¡](#32-å®Œæ•´schemaè®¾è®¡)
  - [4. æ¡ˆä¾‹3ï¼šç¤¾äº¤ç½‘ç»œå¹³å°è®¾è®¡](#4-æ¡ˆä¾‹3ç¤¾äº¤ç½‘ç»œå¹³å°è®¾è®¡)
    - [4.1. éœ€æ±‚åˆ†æ](#41-éœ€æ±‚åˆ†æ)
    - [4.2. å®Œæ•´Schemaè®¾è®¡](#42-å®Œæ•´schemaè®¾è®¡)
  - [5. æ¡ˆä¾‹4ï¼šç‰©è”ç½‘æ•°æ®å¹³å°è®¾è®¡](#5-æ¡ˆä¾‹4ç‰©è”ç½‘æ•°æ®å¹³å°è®¾è®¡)
    - [5.1. éœ€æ±‚åˆ†æ](#51-éœ€æ±‚åˆ†æ)
    - [5.2. å®Œæ•´Schemaè®¾è®¡](#52-å®Œæ•´schemaè®¾è®¡)
  - [6. æ¡ˆä¾‹5ï¼šå†…å®¹ç®¡ç†ç³»ç»Ÿè®¾è®¡](#6-æ¡ˆä¾‹5å†…å®¹ç®¡ç†ç³»ç»Ÿè®¾è®¡)
    - [6.1. éœ€æ±‚åˆ†æ](#61-éœ€æ±‚åˆ†æ)
    - [6.2. å®Œæ•´Schemaè®¾è®¡](#62-å®Œæ•´schemaè®¾è®¡)
  - [7. è®¾è®¡å†³ç­–è®°å½•](#7-è®¾è®¡å†³ç­–è®°å½•)
    - [7.1. è®¾è®¡å†³ç­–çŸ©é˜µ](#71-è®¾è®¡å†³ç­–çŸ©é˜µ)
  - [8. æ¡ˆä¾‹6ï¼šAIåº”ç”¨å¹³å°è®¾è®¡ï¼ˆ2025æ–°å¢ï¼‰](#8-æ¡ˆä¾‹6aiåº”ç”¨å¹³å°è®¾è®¡2025æ–°å¢)
    - [8.1. éœ€æ±‚åˆ†æ](#81-éœ€æ±‚åˆ†æ)
    - [8.2. AIå¹³å°Schemaè®¾è®¡](#82-aiå¹³å°schemaè®¾è®¡)
  - [9. 2024-2025æ¡ˆä¾‹è®¾è®¡è¶‹åŠ¿](#9-2024-2025æ¡ˆä¾‹è®¾è®¡è¶‹åŠ¿)
    - [9.1. æ¡ˆä¾‹è®¾è®¡æ¼”è¿›](#91-æ¡ˆä¾‹è®¾è®¡æ¼”è¿›)
    - [9.2. è¡Œä¸šæ¡ˆä¾‹å¯¹æ¯”çŸ©é˜µ](#92-è¡Œä¸šæ¡ˆä¾‹å¯¹æ¯”çŸ©é˜µ)
  - [10. å‚è€ƒèµ„æ–™](#10-å‚è€ƒèµ„æ–™)
    - [10.1. æƒå¨æ–‡çŒ®](#101-æƒå¨æ–‡çŒ®)
    - [10.2. åœ¨çº¿èµ„æº](#102-åœ¨çº¿èµ„æº)
    - [10.3. ç›¸å…³æ–‡æ¡£](#103-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

æœ¬æ–‡æ¡£é€šè¿‡5ä¸ªå®Œæ•´çš„è¡Œä¸šæ¡ˆä¾‹ï¼Œæ·±å…¥è§£ææ•°æ®åº“è®¾è®¡çš„å®Œæ•´è¿‡ç¨‹ï¼Œä»éœ€æ±‚åˆ†æåˆ°Schemaå®ç°ã€‚

### 1.1. æ¡ˆä¾‹é€‰æ‹©

```mermaid
mindmap
  root((è®¾è®¡æ¡ˆä¾‹))
    ç”µå•†å¹³å°
      é«˜å¹¶å‘
      å¤æ‚ä¸šåŠ¡é€»è¾‘
      å¤šè¡¨å…³è”
    é‡‘èæ”¯ä»˜
      äº‹åŠ¡ä¸€è‡´æ€§
      æ•°æ®å®‰å…¨
      å®¡è®¡è¦æ±‚
    ç¤¾äº¤ç½‘ç»œ
      å›¾å…³ç³»
      æ—¶é—´åºåˆ—
      å†…å®¹ç®¡ç†
    ç‰©è”ç½‘
      æ—¶åºæ•°æ®
      å¤§è§„æ¨¡å†™å…¥
      å®æ—¶æŸ¥è¯¢
    å†…å®¹ç®¡ç†
      ç‰ˆæœ¬æ§åˆ¶
      æƒé™ç®¡ç†
      å…¨æ–‡æœç´¢
```

---

## 2. æ¡ˆä¾‹1ï¼šç”µå•†å¹³å°å®Œæ•´è®¾è®¡

### 2.1. éœ€æ±‚åˆ†æ

**ä¸šåŠ¡éœ€æ±‚**ï¼š

1. **ç”¨æˆ·ç®¡ç†**ï¼šæ³¨å†Œã€ç™»å½•ã€ä¸ªäººä¿¡æ¯ç®¡ç†
2. **å•†å“ç®¡ç†**ï¼šå•†å“ä¿¡æ¯ã€åˆ†ç±»ã€åº“å­˜ã€ä»·æ ¼
3. **è®¢å•ç®¡ç†**ï¼šä¸‹å•ã€æ”¯ä»˜ã€å‘è´§ã€æ”¶è´§ã€é€€æ¬¾
4. **è´­ç‰©è½¦**ï¼šæ·»åŠ å•†å“ã€ä¿®æ”¹æ•°é‡ã€ç»“ç®—
5. **è¯„ä»·ç³»ç»Ÿ**ï¼šå•†å“è¯„ä»·ã€å•†å®¶è¯„ä»·
6. **ä¼˜æƒ ç³»ç»Ÿ**ï¼šä¼˜æƒ åˆ¸ã€ä¿ƒé”€æ´»åŠ¨

**æ€§èƒ½éœ€æ±‚**ï¼š

- æ”¯æŒ10ä¸‡+å¹¶å‘ç”¨æˆ·
- è®¢å•æŸ¥è¯¢å“åº”æ—¶é—´ < 100ms
- å•†å“æœç´¢å“åº”æ—¶é—´ < 200ms
- æ”¯æŒæ—¥è®¢å•é‡100ä¸‡+

**æ•°æ®è§„æ¨¡**ï¼š

- ç”¨æˆ·æ•°ï¼š1000ä¸‡+
- å•†å“æ•°ï¼š100ä¸‡+
- æ—¥è®¢å•é‡ï¼š100ä¸‡+
- å†å²è®¢å•ï¼š1äº¿+

### 2.2. æ¦‚å¿µæ¨¡å‹è®¾è®¡

**å®ä½“è¯†åˆ«**ï¼š

```mermaid
erDiagram
    USER ||--o{ ORDER : places
    USER ||--o{ CART_ITEM : has
    USER ||--o{ ADDRESS : has
    USER ||--o{ COUPON : owns

    PRODUCT ||--o{ ORDER_ITEM : contains
    PRODUCT ||--o{ CART_ITEM : in
    PRODUCT ||--o{ PRODUCT_REVIEW : reviewed
    PRODUCT }o--|| CATEGORY : belongs_to

    ORDER ||--o{ ORDER_ITEM : contains
    ORDER }o--|| ADDRESS : ships_to
    ORDER }o--|| PAYMENT : paid_by
    ORDER }o--o| COUPON : uses

    CATEGORY ||--o{ CATEGORY : has_child
```

### 2.3. é€»è¾‘æ¨¡å‹è®¾è®¡

**å®Œæ•´Schemaè®¾è®¡**ï¼š

```sql
CREATE SCHEMA ecommerce;

-- ============================================
-- ç”¨æˆ·æ¨¡å—
-- ============================================

-- ç”¨æˆ·è¡¨
CREATE TABLE ecommerce.users (
    user_id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    password_hash TEXT NOT NULL,
    phone VARCHAR(20),
    avatar_url TEXT,
    gender VARCHAR(10) CHECK (gender IN ('male', 'female', 'other')),
    birth_date DATE,
    is_active BOOLEAN DEFAULT TRUE,
    is_email_verified BOOLEAN DEFAULT FALSE,
    last_login_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_email ON ecommerce.users(email);
CREATE INDEX idx_users_username ON ecommerce.users(username);
CREATE INDEX idx_users_active ON ecommerce.users(user_id) WHERE is_active = TRUE;

-- ç”¨æˆ·åœ°å€è¡¨
CREATE TABLE ecommerce.user_addresses (
    address_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES ecommerce.users(user_id) ON DELETE CASCADE,
    recipient_name VARCHAR(100) NOT NULL,
    phone VARCHAR(20) NOT NULL,
    province VARCHAR(50) NOT NULL,
    city VARCHAR(50) NOT NULL,
    district VARCHAR(50) NOT NULL,
    street VARCHAR(200) NOT NULL,
    zip_code VARCHAR(20),
    is_default BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_user_addresses_user ON ecommerce.user_addresses(user_id);
CREATE INDEX idx_user_addresses_default ON ecommerce.user_addresses(user_id, is_default) WHERE is_default = TRUE;

-- ============================================
-- å•†å“æ¨¡å—
-- ============================================

-- å•†å“åˆ†ç±»è¡¨ï¼ˆæ ‘å½¢ç»“æ„ï¼‰
CREATE TABLE ecommerce.categories (
    category_id SERIAL PRIMARY KEY,
    category_name VARCHAR(100) NOT NULL,
    parent_id INTEGER REFERENCES ecommerce.categories(category_id),
    level INTEGER NOT NULL CHECK (level BETWEEN 1 AND 5),
    sort_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_categories_parent ON ecommerce.categories(parent_id);
CREATE INDEX idx_categories_level ON ecommerce.categories(level, is_active) WHERE is_active = TRUE;

-- å•†å“è¡¨
CREATE TABLE ecommerce.products (
    product_id BIGSERIAL PRIMARY KEY,
    sku VARCHAR(50) NOT NULL UNIQUE,
    product_name VARCHAR(200) NOT NULL,
    category_id INTEGER NOT NULL REFERENCES ecommerce.categories(category_id),
    brand VARCHAR(100),
    description TEXT,
    specifications JSONB,  -- å•†å“è§„æ ¼
    images TEXT[],  -- å•†å“å›¾ç‰‡URLæ•°ç»„
    base_price DECIMAL(10,2) NOT NULL CHECK (base_price >= 0),
    sale_price DECIMAL(10,2) NOT NULL CHECK (sale_price >= 0),
    stock_quantity INTEGER NOT NULL DEFAULT 0 CHECK (stock_quantity >= 0),
    sales_count INTEGER DEFAULT 0 CHECK (sales_count >= 0),
    view_count INTEGER DEFAULT 0 CHECK (view_count >= 0),
    rating_average DECIMAL(3,2) DEFAULT 0.0 CHECK (rating_average BETWEEN 0 AND 5),
    rating_count INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    is_deleted BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_products_sku ON ecommerce.products(sku);
CREATE INDEX idx_products_category ON ecommerce.products(category_id, is_active, is_deleted) WHERE is_active = TRUE AND is_deleted = FALSE;
CREATE INDEX idx_products_price ON ecommerce.products(sale_price) WHERE is_active = TRUE AND is_deleted = FALSE;
CREATE INDEX idx_products_search ON ecommerce.products USING GIN(to_tsvector('english', product_name || ' ' || COALESCE(description, '')));
CREATE INDEX idx_products_rating ON ecommerce.products(rating_average DESC, rating_count DESC) WHERE is_active = TRUE AND is_deleted = FALSE;

-- å•†å“SKUè¡¨ï¼ˆå¤šè§„æ ¼å•†å“ï¼‰
CREATE TABLE ecommerce.product_skus (
    sku_id BIGSERIAL PRIMARY KEY,
    product_id BIGINT NOT NULL REFERENCES ecommerce.products(product_id) ON DELETE CASCADE,
    sku_code VARCHAR(50) NOT NULL UNIQUE,
    attributes JSONB NOT NULL,  -- è§„æ ¼å±æ€§ï¼Œå¦‚ {"color": "red", "size": "L"}
    price DECIMAL(10,2) NOT NULL CHECK (price >= 0),
    stock_quantity INTEGER NOT NULL DEFAULT 0 CHECK (stock_quantity >= 0),
    image_url TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_product_skus_product ON ecommerce.product_skus(product_id, is_active) WHERE is_active = TRUE;
CREATE INDEX idx_product_skus_code ON ecommerce.product_skus(sku_code);

-- ============================================
-- è´­ç‰©è½¦æ¨¡å—
-- ============================================

CREATE TABLE ecommerce.cart_items (
    cart_item_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES ecommerce.users(user_id) ON DELETE CASCADE,
    product_id BIGINT NOT NULL REFERENCES ecommerce.products(product_id) ON DELETE CASCADE,
    sku_id BIGINT REFERENCES ecommerce.product_skus(sku_id) ON DELETE CASCADE,
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    added_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, product_id, sku_id)
);

CREATE INDEX idx_cart_items_user ON ecommerce.cart_items(user_id);
CREATE INDEX idx_cart_items_product ON ecommerce.cart_items(product_id);

-- ============================================
-- è®¢å•æ¨¡å—
-- ============================================

-- è®¢å•è¡¨ï¼ˆåˆ†åŒºè¡¨ï¼šæŒ‰åˆ›å»ºæ—¶é—´åˆ†åŒºï¼‰
CREATE TABLE ecommerce.orders (
    order_id BIGSERIAL,
    order_number VARCHAR(50) NOT NULL UNIQUE,
    user_id BIGINT NOT NULL REFERENCES ecommerce.users(user_id),
    shipping_address_id BIGINT NOT NULL REFERENCES ecommerce.user_addresses(address_id),
    billing_address_id BIGINT NOT NULL REFERENCES ecommerce.user_addresses(address_id),
    order_status VARCHAR(20) NOT NULL CHECK (order_status IN (
        'pending', 'paid', 'shipped', 'delivered', 'completed',
        'cancelled', 'refunding', 'refunded'
    )),
    payment_status VARCHAR(20) NOT NULL CHECK (payment_status IN (
        'unpaid', 'paid', 'refunding', 'refunded'
    )),
    payment_method VARCHAR(50),
    payment_time TIMESTAMPTZ,
    subtotal DECIMAL(10,2) NOT NULL CHECK (subtotal >= 0),
    shipping_fee DECIMAL(10,2) NOT NULL DEFAULT 0 CHECK (shipping_fee >= 0),
    discount_amount DECIMAL(10,2) NOT NULL DEFAULT 0 CHECK (discount_amount >= 0),
    total_amount DECIMAL(10,2) NOT NULL CHECK (total_amount >= 0),
    coupon_id BIGINT REFERENCES ecommerce.coupons(coupon_id),
    coupon_discount DECIMAL(10,2) DEFAULT 0,
    shipping_time TIMESTAMPTZ,
    delivered_time TIMESTAMPTZ,
    completed_time TIMESTAMPTZ,
    cancelled_time TIMESTAMPTZ,
    cancel_reason TEXT,
    notes TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (order_id, created_at)
) PARTITION BY RANGE (created_at);

-- æŒ‰æœˆåˆ†åŒºï¼ˆè‡ªåŠ¨åˆ›å»ºæœªæ¥12ä¸ªæœˆçš„åˆ†åŒºï¼‰
CREATE TABLE ecommerce.orders_2024_01 PARTITION OF ecommerce.orders
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE ecommerce.orders_2024_02 PARTITION OF ecommerce.orders
FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');

-- è®¢å•ç´¢å¼•
CREATE INDEX idx_orders_user ON ecommerce.orders(user_id, created_at DESC);
CREATE INDEX idx_orders_status ON ecommerce.orders(order_status, created_at DESC);
CREATE INDEX idx_orders_number ON ecommerce.orders(order_number);
CREATE INDEX idx_orders_payment_status ON ecommerce.orders(payment_status, created_at DESC);

-- è®¢å•é¡¹è¡¨
CREATE TABLE ecommerce.order_items (
    order_item_id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL,
    order_created_at TIMESTAMPTZ NOT NULL,
    product_id BIGINT NOT NULL REFERENCES ecommerce.products(product_id),
    sku_id BIGINT REFERENCES ecommerce.product_skus(sku_id),
    product_name VARCHAR(200) NOT NULL,  -- å†—ä½™ï¼šå•†å“å¿«ç…§
    product_image TEXT,  -- å†—ä½™ï¼šå•†å“å›¾ç‰‡å¿«ç…§
    sku_attributes JSONB,  -- å†—ä½™ï¼šSKUå±æ€§å¿«ç…§
    unit_price DECIMAL(10,2) NOT NULL CHECK (unit_price >= 0),  -- å†—ä½™ï¼šä¸‹å•æ—¶ä»·æ ¼
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    subtotal DECIMAL(10,2) NOT NULL CHECK (subtotal >= 0),
    FOREIGN KEY (order_id, order_created_at) REFERENCES ecommerce.orders(order_id, created_at) ON DELETE CASCADE
);

CREATE INDEX idx_order_items_order ON ecommerce.order_items(order_id, order_created_at);
CREATE INDEX idx_order_items_product ON ecommerce.order_items(product_id);

-- ============================================
-- æ”¯ä»˜æ¨¡å—
-- ============================================

CREATE TABLE ecommerce.payments (
    payment_id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL,
    order_created_at TIMESTAMPTZ NOT NULL,
    payment_number VARCHAR(50) NOT NULL UNIQUE,
    payment_method VARCHAR(50) NOT NULL,  -- alipay, wechat, credit_card
    payment_amount DECIMAL(10,2) NOT NULL CHECK (payment_amount > 0),
    payment_status VARCHAR(20) NOT NULL CHECK (payment_status IN (
        'pending', 'processing', 'success', 'failed', 'cancelled', 'refunded'
    )),
    third_party_transaction_id VARCHAR(200),
    payment_time TIMESTAMPTZ,
    failure_reason TEXT,
    refund_amount DECIMAL(10,2) DEFAULT 0 CHECK (refund_amount >= 0),
    refund_time TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id, order_created_at) REFERENCES ecommerce.orders(order_id, created_at)
);

CREATE INDEX idx_payments_order ON ecommerce.payments(order_id, order_created_at);
CREATE INDEX idx_payments_number ON ecommerce.payments(payment_number);
CREATE INDEX idx_payments_status ON ecommerce.payments(payment_status, created_at DESC);
CREATE INDEX idx_payments_third_party ON ecommerce.payments(third_party_transaction_id) WHERE third_party_transaction_id IS NOT NULL;

-- ============================================
-- ä¼˜æƒ åˆ¸æ¨¡å—
-- ============================================

CREATE TABLE ecommerce.coupons (
    coupon_id BIGSERIAL PRIMARY KEY,
    coupon_code VARCHAR(50) NOT NULL UNIQUE,
    coupon_name VARCHAR(200) NOT NULL,
    coupon_type VARCHAR(20) NOT NULL CHECK (coupon_type IN ('fixed', 'percentage', 'shipping')),
    discount_value DECIMAL(10,2) NOT NULL CHECK (discount_value >= 0),
    min_purchase_amount DECIMAL(10,2) DEFAULT 0 CHECK (min_purchase_amount >= 0),
    max_discount_amount DECIMAL(10,2),
    valid_from TIMESTAMPTZ NOT NULL,
    valid_until TIMESTAMPTZ NOT NULL,
    total_quantity INTEGER,  -- NULLè¡¨ç¤ºæ— é™åˆ¶
    used_quantity INTEGER DEFAULT 0 CHECK (used_quantity >= 0),
    per_user_limit INTEGER DEFAULT 1 CHECK (per_user_limit >= 1),
    applicable_categories INTEGER[],  -- NULLè¡¨ç¤ºæ‰€æœ‰åˆ†ç±»
    applicable_products BIGINT[],  -- NULLè¡¨ç¤ºæ‰€æœ‰å•†å“
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_coupons_code ON ecommerce.coupons(coupon_code);
CREATE INDEX idx_coupons_valid ON ecommerce.coupons(valid_from, valid_until, is_active) WHERE is_active = TRUE;

-- ç”¨æˆ·ä¼˜æƒ åˆ¸è¡¨
CREATE TABLE ecommerce.user_coupons (
    user_coupon_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES ecommerce.users(user_id) ON DELETE CASCADE,
    coupon_id BIGINT NOT NULL REFERENCES ecommerce.coupons(coupon_id) ON DELETE CASCADE,
    status VARCHAR(20) NOT NULL CHECK (status IN ('unused', 'used', 'expired')),
    used_at TIMESTAMPTZ,
    used_order_id BIGINT REFERENCES ecommerce.orders(order_id),
    obtained_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMPTZ NOT NULL,
    UNIQUE(user_id, coupon_id, obtained_at)
);

CREATE INDEX idx_user_coupons_user ON ecommerce.user_coupons(user_id, status, expires_at) WHERE status = 'unused';
CREATE INDEX idx_user_coupons_coupon ON ecommerce.user_coupons(coupon_id);

-- ============================================
-- è¯„ä»·æ¨¡å—
-- ============================================

CREATE TABLE ecommerce.product_reviews (
    review_id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL,
    order_created_at TIMESTAMPTZ NOT NULL,
    user_id BIGINT NOT NULL REFERENCES ecommerce.users(user_id),
    product_id BIGINT NOT NULL REFERENCES ecommerce.products(product_id),
    rating INTEGER NOT NULL CHECK (rating BETWEEN 1 AND 5),
    review_title VARCHAR(200),
    review_content TEXT,
    images TEXT[],
    is_anonymous BOOLEAN DEFAULT FALSE,
    helpful_count INTEGER DEFAULT 0,
    reply_count INTEGER DEFAULT 0,
    is_verified_purchase BOOLEAN DEFAULT TRUE,
    is_visible BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id, order_created_at) REFERENCES ecommerce.orders(order_id, created_at),
    UNIQUE(order_id, product_id)
);

CREATE INDEX idx_product_reviews_product ON ecommerce.product_reviews(product_id, rating, created_at DESC) WHERE is_visible = TRUE;
CREATE INDEX idx_product_reviews_user ON ecommerce.product_reviews(user_id, created_at DESC);
CREATE INDEX idx_product_reviews_rating ON ecommerce.product_reviews(product_id, rating);

-- è¯„ä»·å›å¤è¡¨
CREATE TABLE ecommerce.review_replies (
    reply_id BIGSERIAL PRIMARY KEY,
    review_id BIGINT NOT NULL REFERENCES ecommerce.product_reviews(review_id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL REFERENCES ecommerce.users(user_id),
    reply_content TEXT NOT NULL,
    is_seller_reply BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_review_replies_review ON ecommerce.review_replies(review_id, created_at);

-- ============================================
-- è§¦å‘å™¨ï¼šæ›´æ–°å•†å“è¯„åˆ†å’Œé”€é‡
-- ============================================

CREATE OR REPLACE FUNCTION update_product_stats()
RETURNS TRIGGER AS $$
BEGIN
    -- æ›´æ–°å•†å“è¯„åˆ†å’Œè¯„ä»·æ•°
    UPDATE ecommerce.products
    SET
        rating_average = (
            SELECT AVG(rating)::DECIMAL(3,2)
            FROM ecommerce.product_reviews
            WHERE product_id = NEW.product_id
              AND is_visible = TRUE
        ),
        rating_count = (
            SELECT COUNT(*)
            FROM ecommerce.product_reviews
            WHERE product_id = NEW.product_id
              AND is_visible = TRUE
        )
    WHERE product_id = NEW.product_id;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_product_stats_trigger
AFTER INSERT OR UPDATE ON ecommerce.product_reviews
FOR EACH ROW
WHEN (NEW.is_visible = TRUE)
EXECUTE FUNCTION update_product_stats();

-- æ›´æ–°è®¢å•çŠ¶æ€æ—¶æ›´æ–°å•†å“é”€é‡
CREATE OR REPLACE FUNCTION update_product_sales()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.order_status = 'completed' AND (OLD.order_status IS NULL OR OLD.order_status != 'completed') THEN
        -- å¢åŠ å•†å“é”€é‡
        UPDATE ecommerce.products p
        SET sales_count = sales_count + oi.quantity
        FROM ecommerce.order_items oi
        WHERE p.product_id = oi.product_id
          AND oi.order_id = NEW.order_id;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_product_sales_trigger
AFTER UPDATE ON ecommerce.orders
FOR EACH ROW
EXECUTE FUNCTION update_product_sales();
```

### 2.4. è®¾è®¡å†³ç­–è®°å½•

**å…³é”®è®¾è®¡å†³ç­–**ï¼š

| å†³ç­–ç‚¹ | é€‰æ‹© | ç†ç”± |
|--------|------|------|
| **è®¢å•è¡¨åˆ†åŒº** | æŒ‰åˆ›å»ºæ—¶é—´èŒƒå›´åˆ†åŒº | æ”¯æŒå¤§è§„æ¨¡å†å²æ•°æ®ï¼ŒæŸ¥è¯¢æ€§èƒ½å¥½ |
| **è®¢å•é¡¹å†—ä½™å­—æ®µ** | ä¿å­˜å•†å“å¿«ç…§ | ä¿è¯å†å²æ•°æ®å‡†ç¡®æ€§ï¼Œå³ä½¿å•†å“ä¿¡æ¯å˜æ›´ |
| **å•†å“è¯„åˆ†æ›´æ–°** | ä½¿ç”¨è§¦å‘å™¨è‡ªåŠ¨æ›´æ–° | ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œå‡å°‘åº”ç”¨å±‚å¤æ‚åº¦ |
| **è´­ç‰©è½¦è®¾è®¡** | ç‹¬ç«‹è¡¨ï¼Œä¸åˆå¹¶åˆ°è®¢å• | æ”¯æŒè´­ç‰©è½¦æŒä¹…åŒ–ï¼Œç”¨æˆ·ä½“éªŒå¥½ |
| **ä¼˜æƒ åˆ¸è®¾è®¡** | ç”¨æˆ·ä¼˜æƒ åˆ¸è¡¨ç‹¬ç«‹ | æ”¯æŒä¼˜æƒ åˆ¸å‘æ”¾å’Œä½¿ç”¨è¿½è¸ª |

---

## 3. æ¡ˆä¾‹2ï¼šé‡‘èæ”¯ä»˜ç³»ç»Ÿè®¾è®¡

### 3.1. éœ€æ±‚åˆ†æ

**ä¸šåŠ¡éœ€æ±‚**ï¼š

1. **è´¦æˆ·ç®¡ç†**ï¼šè´¦æˆ·å¼€æˆ·ã€é”€æˆ·ã€ä½™é¢ç®¡ç†
2. **äº¤æ˜“ç®¡ç†**ï¼šå……å€¼ã€æç°ã€è½¬è´¦ã€æ”¯ä»˜
3. **é£æ§ç³»ç»Ÿ**ï¼šäº¤æ˜“é™é¢ã€å¼‚å¸¸æ£€æµ‹ã€é»‘åå•
4. **å¯¹è´¦ç³»ç»Ÿ**ï¼šä¸ç¬¬ä¸‰æ–¹æ”¯ä»˜å¯¹è´¦
5. **å®¡è®¡è¦æ±‚**ï¼šå®Œæ•´çš„æ“ä½œæ—¥å¿—ã€æ•°æ®ä¸å¯ç¯¡æ”¹

**æ€§èƒ½éœ€æ±‚**ï¼š

- æ”¯æŒæ¯ç§’10ä¸‡+äº¤æ˜“
- äº¤æ˜“å“åº”æ—¶é—´ < 50ms
- å¼ºä¸€è‡´æ€§è¦æ±‚
- 7Ã—24å°æ—¶å¯ç”¨æ€§

**å®‰å…¨éœ€æ±‚**ï¼š

- æ•°æ®åŠ å¯†å­˜å‚¨
- æ“ä½œå®¡è®¡æ—¥å¿—
- é˜²é‡æ”¾æ”»å‡»
- é˜²å¹¶å‘å†²çª

### 3.2. å®Œæ•´Schemaè®¾è®¡

```sql
CREATE SCHEMA payment_system;

-- ============================================
-- è´¦æˆ·æ¨¡å—
-- ============================================

-- è´¦æˆ·è¡¨
CREATE TABLE payment_system.accounts (
    account_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    account_type VARCHAR(20) NOT NULL CHECK (account_type IN ('savings', 'checking', 'credit')),
    account_number VARCHAR(50) NOT NULL UNIQUE,
    balance DECIMAL(15,2) NOT NULL DEFAULT 0 CHECK (balance >= 0),
    frozen_balance DECIMAL(15,2) NOT NULL DEFAULT 0 CHECK (frozen_balance >= 0),
    available_balance DECIMAL(15,2) GENERATED ALWAYS AS (balance - frozen_balance) STORED,
    currency VARCHAR(3) NOT NULL DEFAULT 'CNY',
    status VARCHAR(20) NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'frozen', 'closed')),
    opened_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    closed_at TIMESTAMPTZ,
    version INTEGER NOT NULL DEFAULT 1,  -- ä¹è§‚é”ç‰ˆæœ¬å·
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_accounts_user ON payment_system.accounts(user_id, account_type);
CREATE INDEX idx_accounts_number ON payment_system.accounts(account_number);
CREATE INDEX idx_accounts_status ON payment_system.accounts(status) WHERE status = 'active';

-- è´¦æˆ·å˜æ›´æ—¥å¿—è¡¨ï¼ˆå®¡è®¡ï¼‰
CREATE TABLE payment_system.account_changes (
    change_id BIGSERIAL PRIMARY KEY,
    account_id BIGINT NOT NULL REFERENCES payment_system.accounts(account_id),
    change_type VARCHAR(20) NOT NULL CHECK (change_type IN ('balance', 'status', 'frozen')),
    old_value TEXT,
    new_value TEXT,
    change_amount DECIMAL(15,2),
    transaction_id BIGINT REFERENCES payment_system.transactions(transaction_id),
    changed_by VARCHAR(100),
    change_reason TEXT,
    changed_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
) PARTITION BY RANGE (changed_at);

CREATE INDEX idx_account_changes_account ON payment_system.account_changes(account_id, changed_at DESC);

-- ============================================
-- äº¤æ˜“æ¨¡å—
-- ============================================

-- äº¤æ˜“è¡¨ï¼ˆåˆ†åŒºè¡¨ï¼‰
CREATE TABLE payment_system.transactions (
    transaction_id BIGSERIAL,
    transaction_number VARCHAR(50) NOT NULL UNIQUE,
    transaction_type VARCHAR(20) NOT NULL CHECK (transaction_type IN (
        'deposit', 'withdraw', 'transfer', 'payment', 'refund', 'recharge'
    )),
    from_account_id BIGINT REFERENCES payment_system.accounts(account_id),
    to_account_id BIGINT REFERENCES payment_system.accounts(account_id),
    amount DECIMAL(15,2) NOT NULL CHECK (amount > 0),
    currency VARCHAR(3) NOT NULL DEFAULT 'CNY',
    fee DECIMAL(15,2) DEFAULT 0 CHECK (fee >= 0),
    transaction_status VARCHAR(20) NOT NULL CHECK (transaction_status IN (
        'pending', 'processing', 'success', 'failed', 'cancelled', 'refunded'
    )),
    failure_reason TEXT,
    third_party_transaction_id VARCHAR(200),
    merchant_order_id VARCHAR(100),
    description TEXT,
    metadata JSONB,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMPTZ,
    PRIMARY KEY (transaction_id, created_at)
) PARTITION BY RANGE (created_at);

-- äº¤æ˜“ç´¢å¼•
CREATE INDEX idx_transactions_number ON payment_system.transactions(transaction_number);
CREATE INDEX idx_transactions_from_account ON payment_system.transactions(from_account_id, created_at DESC);
CREATE INDEX idx_transactions_to_account ON payment_system.transactions(to_account_id, created_at DESC);
CREATE INDEX idx_transactions_status ON payment_system.transactions(transaction_status, created_at DESC);
CREATE INDEX idx_transactions_third_party ON payment_system.transactions(third_party_transaction_id) WHERE third_party_transaction_id IS NOT NULL;

-- äº¤æ˜“æ˜ç»†è¡¨ï¼ˆè®°å½•æ¯ç¬”äº¤æ˜“çš„è´¦æˆ·å˜æ›´ï¼‰
CREATE TABLE payment_system.transaction_details (
    detail_id BIGSERIAL PRIMARY KEY,
    transaction_id BIGINT NOT NULL,
    transaction_created_at TIMESTAMPTZ NOT NULL,
    account_id BIGINT NOT NULL REFERENCES payment_system.accounts(account_id),
    detail_type VARCHAR(20) NOT NULL CHECK (detail_type IN ('debit', 'credit')),
    amount DECIMAL(15,2) NOT NULL CHECK (amount > 0),
    balance_before DECIMAL(15,2) NOT NULL,
    balance_after DECIMAL(15,2) NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (transaction_id, transaction_created_at)
        REFERENCES payment_system.transactions(transaction_id, created_at)
);

CREATE INDEX idx_transaction_details_transaction ON payment_system.transaction_details(transaction_id, transaction_created_at);
CREATE INDEX idx_transaction_details_account ON payment_system.transaction_details(account_id, created_at DESC);

-- ============================================
-- é£æ§æ¨¡å—
-- ============================================

-- äº¤æ˜“é™é¢è¡¨
CREATE TABLE payment_system.transaction_limits (
    limit_id BIGSERIAL PRIMARY KEY,
    account_id BIGINT NOT NULL REFERENCES payment_system.accounts(account_id),
    limit_type VARCHAR(50) NOT NULL,  -- daily_amount, single_amount, monthly_count
    limit_value DECIMAL(15,2) NOT NULL CHECK (limit_value >= 0),
    current_usage DECIMAL(15,2) DEFAULT 0 CHECK (current_usage >= 0),
    period_start TIMESTAMPTZ NOT NULL,
    period_end TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(account_id, limit_type, period_start)
);

CREATE INDEX idx_transaction_limits_account ON payment_system.transaction_limits(account_id, period_start, period_end);

-- é»‘åå•è¡¨
CREATE TABLE payment_system.blacklist (
    blacklist_id BIGSERIAL PRIMARY KEY,
    entity_type VARCHAR(20) NOT NULL CHECK (entity_type IN ('user', 'account', 'ip', 'device')),
    entity_value VARCHAR(200) NOT NULL,
    blacklist_type VARCHAR(50) NOT NULL,  -- fraud, risk, compliance
    reason TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    added_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMPTZ,
    added_by VARCHAR(100),
    UNIQUE(entity_type, entity_value, blacklist_type)
);

CREATE INDEX idx_blacklist_entity ON payment_system.blacklist(entity_type, entity_value, is_active) WHERE is_active = TRUE;
CREATE INDEX idx_blacklist_expires ON payment_system.blacklist(expires_at) WHERE expires_at IS NOT NULL;

-- ============================================
-- å¯¹è´¦æ¨¡å—
-- ============================================

CREATE TABLE payment_system.reconciliation_records (
    reconciliation_id BIGSERIAL PRIMARY KEY,
    reconciliation_date DATE NOT NULL,
    third_party VARCHAR(50) NOT NULL,  -- alipay, wechat, bank
    total_transactions INTEGER NOT NULL DEFAULT 0,
    total_amount DECIMAL(15,2) NOT NULL DEFAULT 0,
    matched_count INTEGER DEFAULT 0,
    unmatched_count INTEGER DEFAULT 0,
    reconciliation_status VARCHAR(20) NOT NULL CHECK (reconciliation_status IN (
        'pending', 'processing', 'completed', 'failed'
    )),
    reconciliation_file_path TEXT,
    notes TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMPTZ,
    UNIQUE(reconciliation_date, third_party)
);

CREATE INDEX idx_reconciliation_date ON payment_system.reconciliation_records(reconciliation_date DESC, third_party);

-- ============================================
-- äº‹åŠ¡å¤„ç†å‡½æ•°ï¼ˆä¿è¯ä¸€è‡´æ€§ï¼‰
-- ============================================

CREATE OR REPLACE FUNCTION process_transfer(
    p_from_account_id BIGINT,
    p_to_account_id BIGINT,
    p_amount DECIMAL,
    p_transaction_number VARCHAR,
    p_description TEXT DEFAULT NULL
)
RETURNS TABLE (
    transaction_id BIGINT,
    success BOOLEAN,
    error_message TEXT
) AS $$
DECLARE
    v_transaction_id BIGINT;
    v_from_balance DECIMAL(15,2);
    v_to_balance DECIMAL(15,2);
    v_from_version INTEGER;
    v_to_version INTEGER;
BEGIN
    -- æ£€æŸ¥è´¦æˆ·çŠ¶æ€å’Œä½™é¢
    SELECT balance, version INTO v_from_balance, v_from_version
    FROM payment_system.accounts
    WHERE account_id = p_from_account_id
      AND status = 'active'
    FOR UPDATE;

    IF NOT FOUND THEN
        RETURN QUERY SELECT NULL::BIGINT, FALSE, 'From account not found or inactive';
        RETURN;
    END IF;

    IF v_from_balance < p_amount THEN
        RETURN QUERY SELECT NULL::BIGINT, FALSE, 'Insufficient balance';
        RETURN;
    END IF;

    SELECT balance, version INTO v_to_balance, v_to_version
    FROM payment_system.accounts
    WHERE account_id = p_to_account_id
      AND status = 'active'
    FOR UPDATE;

    IF NOT FOUND THEN
        RETURN QUERY SELECT NULL::BIGINT, FALSE, 'To account not found or inactive';
        RETURN;
    END IF;

    -- åˆ›å»ºäº¤æ˜“è®°å½•
    INSERT INTO payment_system.transactions (
        transaction_number, transaction_type, from_account_id,
        to_account_id, amount, transaction_status
    )
    VALUES (
        p_transaction_number, 'transfer', p_from_account_id,
        p_to_account_id, p_amount, 'processing'
    )
    RETURNING transaction_id INTO v_transaction_id;

    -- æ›´æ–°è´¦æˆ·ä½™é¢ï¼ˆä½¿ç”¨ä¹è§‚é”ï¼‰
    UPDATE payment_system.accounts
    SET balance = balance - p_amount,
        version = version + 1,
        updated_at = CURRENT_TIMESTAMP
    WHERE account_id = p_from_account_id
      AND version = v_from_version;

    IF NOT FOUND THEN
        -- ç‰ˆæœ¬å†²çªï¼Œå›æ»š
        UPDATE payment_system.transactions
        SET transaction_status = 'failed', failure_reason = 'Version conflict'
        WHERE transaction_id = v_transaction_id;
        RETURN QUERY SELECT v_transaction_id, FALSE, 'Version conflict';
        RETURN;
    END IF;

    UPDATE payment_system.accounts
    SET balance = balance + p_amount,
        version = version + 1,
        updated_at = CURRENT_TIMESTAMP
    WHERE account_id = p_to_account_id
      AND version = v_to_version;

    IF NOT FOUND THEN
        -- ç‰ˆæœ¬å†²çªï¼Œå›æ»š
        UPDATE payment_system.accounts
        SET balance = balance + p_amount, version = version - 1
        WHERE account_id = p_from_account_id;

        UPDATE payment_system.transactions
        SET transaction_status = 'failed', failure_reason = 'Version conflict'
        WHERE transaction_id = v_transaction_id;
        RETURN QUERY SELECT v_transaction_id, FALSE, 'Version conflict';
        RETURN;
    END IF;

    -- è®°å½•äº¤æ˜“æ˜ç»†
    INSERT INTO payment_system.transaction_details (
        transaction_id, transaction_created_at, account_id,
        detail_type, amount, balance_before, balance_after
    )
    VALUES
        (v_transaction_id, CURRENT_TIMESTAMP, p_from_account_id,
         'debit', p_amount, v_from_balance, v_from_balance - p_amount),
        (v_transaction_id, CURRENT_TIMESTAMP, p_to_account_id,
         'credit', p_amount, v_to_balance, v_to_balance + p_amount);

    -- æ›´æ–°äº¤æ˜“çŠ¶æ€
    UPDATE payment_system.transactions
    SET transaction_status = 'success', completed_at = CURRENT_TIMESTAMP
    WHERE transaction_id = v_transaction_id;

    RETURN QUERY SELECT v_transaction_id, TRUE, NULL::TEXT;
END;
$$ LANGUAGE plpgsql;
```

---

## 4. æ¡ˆä¾‹3ï¼šç¤¾äº¤ç½‘ç»œå¹³å°è®¾è®¡

### 4.1. éœ€æ±‚åˆ†æ

**ä¸šåŠ¡éœ€æ±‚**ï¼š

1. **ç”¨æˆ·ç®¡ç†**ï¼šæ³¨å†Œã€ä¸ªäººèµ„æ–™ã€å…³æ³¨å…³ç³»
2. **å†…å®¹å‘å¸ƒ**ï¼šæ–‡æœ¬ã€å›¾ç‰‡ã€è§†é¢‘åŠ¨æ€
3. **äº’åŠ¨åŠŸèƒ½**ï¼šç‚¹èµã€è¯„è®ºã€è½¬å‘ã€æ”¶è—
4. **æ¶ˆæ¯ç³»ç»Ÿ**ï¼šç§ä¿¡ã€é€šçŸ¥
5. **æ¨èç³»ç»Ÿ**ï¼šå†…å®¹æ¨èã€ç”¨æˆ·æ¨è

**æ€§èƒ½éœ€æ±‚**ï¼š

- æ”¯æŒåƒä¸‡çº§ç”¨æˆ·
- æ—¶é—´çº¿æŸ¥è¯¢ < 200ms
- æ”¯æŒå®æ—¶æ¨é€
- é«˜å¹¶å‘å†™å…¥

### 4.2. å®Œæ•´Schemaè®¾è®¡

```sql
CREATE SCHEMA social_network;

-- ============================================
-- ç”¨æˆ·æ¨¡å—
-- ============================================

CREATE TABLE social_network.users (
    user_id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) UNIQUE,
    phone VARCHAR(20) UNIQUE,
    password_hash TEXT NOT NULL,
    nickname VARCHAR(100),
    avatar_url TEXT,
    bio TEXT,
    location VARCHAR(100),
    website VARCHAR(200),
    birth_date DATE,
    gender VARCHAR(10) CHECK (gender IN ('male', 'female', 'other')),
    is_verified BOOLEAN DEFAULT FALSE,
    is_private BOOLEAN DEFAULT FALSE,
    follower_count INTEGER DEFAULT 0 CHECK (follower_count >= 0),
    following_count INTEGER DEFAULT 0 CHECK (following_count >= 0),
    post_count INTEGER DEFAULT 0 CHECK (post_count >= 0),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_username ON social_network.users(username);
CREATE INDEX idx_users_email ON social_network.users(email) WHERE email IS NOT NULL;

-- å…³æ³¨å…³ç³»è¡¨
CREATE TABLE social_network.follows (
    follower_id BIGINT NOT NULL REFERENCES social_network.users(user_id) ON DELETE CASCADE,
    followee_id BIGINT NOT NULL REFERENCES social_network.users(user_id) ON DELETE CASCADE,
    status VARCHAR(20) NOT NULL CHECK (status IN ('active', 'blocked')),
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (follower_id, followee_id),
    CHECK (follower_id != followee_id)
);

CREATE INDEX idx_follows_follower ON social_network.follows(follower_id, created_at DESC);
CREATE INDEX idx_follows_followee ON social_network.follows(followee_id, created_at DESC);

-- ============================================
-- å†…å®¹æ¨¡å—
-- ============================================

-- åŠ¨æ€è¡¨ï¼ˆåˆ†åŒºè¡¨ï¼šæŒ‰æ—¶é—´åˆ†åŒºï¼‰
CREATE TABLE social_network.posts (
    post_id BIGSERIAL,
    user_id BIGINT NOT NULL REFERENCES social_network.users(user_id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    content_type VARCHAR(20) NOT NULL CHECK (content_type IN ('text', 'image', 'video', 'mixed')),
    media_urls TEXT[],
    location_name VARCHAR(200),
    location_coordinates POINT,  -- PostGIS point
    is_public BOOLEAN DEFAULT TRUE,
    comment_count INTEGER DEFAULT 0 CHECK (comment_count >= 0),
    like_count INTEGER DEFAULT 0 CHECK (like_count >= 0),
    share_count INTEGER DEFAULT 0 CHECK (share_count >= 0),
    view_count INTEGER DEFAULT 0 CHECK (view_count >= 0),
    original_post_id BIGINT,  -- è½¬å‘åŸåŠ¨æ€ID
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (post_id, created_at)
) PARTITION BY RANGE (created_at);

CREATE INDEX idx_posts_user ON social_network.posts(user_id, created_at DESC);
CREATE INDEX idx_posts_public ON social_network.posts(created_at DESC) WHERE is_public = TRUE;
CREATE INDEX idx_posts_content_search ON social_network.posts USING GIN(to_tsvector('english', content));

-- ç‚¹èµè¡¨
CREATE TABLE social_network.post_likes (
    like_id BIGSERIAL PRIMARY KEY,
    post_id BIGINT NOT NULL,
    post_created_at TIMESTAMPTZ NOT NULL,
    user_id BIGINT NOT NULL REFERENCES social_network.users(user_id) ON DELETE CASCADE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (post_id, post_created_at) REFERENCES social_network.posts(post_id, created_at) ON DELETE CASCADE,
    UNIQUE(post_id, post_created_at, user_id)
);

CREATE INDEX idx_post_likes_post ON social_network.post_likes(post_id, post_created_at);
CREATE INDEX idx_post_likes_user ON social_network.post_likes(user_id, created_at DESC);

-- è¯„è®ºè¡¨
CREATE TABLE social_network.comments (
    comment_id BIGSERIAL PRIMARY KEY,
    post_id BIGINT NOT NULL,
    post_created_at TIMESTAMPTZ NOT NULL,
    user_id BIGINT NOT NULL REFERENCES social_network.users(user_id) ON DELETE CASCADE,
    parent_comment_id BIGINT REFERENCES social_network.comments(comment_id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    like_count INTEGER DEFAULT 0 CHECK (like_count >= 0),
    reply_count INTEGER DEFAULT 0 CHECK (reply_count >= 0),
    is_deleted BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (post_id, post_created_at) REFERENCES social_network.posts(post_id, created_at) ON DELETE CASCADE
);

CREATE INDEX idx_comments_post ON social_network.comments(post_id, post_created_at, created_at);
CREATE INDEX idx_comments_user ON social_network.comments(user_id, created_at DESC);
CREATE INDEX idx_comments_parent ON social_network.comments(parent_comment_id) WHERE parent_comment_id IS NOT NULL;

-- ============================================
-- æ¶ˆæ¯æ¨¡å—
-- ============================================

-- ç§ä¿¡è¡¨
CREATE TABLE social_network.direct_messages (
    message_id BIGSERIAL PRIMARY KEY,
    conversation_id BIGINT NOT NULL,
    sender_id BIGINT NOT NULL REFERENCES social_network.users(user_id) ON DELETE CASCADE,
    recipient_id BIGINT NOT NULL REFERENCES social_network.users(user_id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    message_type VARCHAR(20) DEFAULT 'text' CHECK (message_type IN ('text', 'image', 'video', 'file')),
    media_url TEXT,
    is_read BOOLEAN DEFAULT FALSE,
    read_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_direct_messages_conversation ON social_network.direct_messages(conversation_id, created_at DESC);
CREATE INDEX idx_direct_messages_sender ON social_network.direct_messages(sender_id, created_at DESC);
CREATE INDEX idx_direct_messages_recipient ON social_network.direct_messages(recipient_id, is_read, created_at DESC) WHERE is_read = FALSE;

-- é€šçŸ¥è¡¨
CREATE TABLE social_network.notifications (
    notification_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES social_network.users(user_id) ON DELETE CASCADE,
    notification_type VARCHAR(50) NOT NULL,  -- like, comment, follow, mention
    actor_id BIGINT REFERENCES social_network.users(user_id),
    target_type VARCHAR(50),  -- post, comment
    target_id BIGINT,
    content TEXT,
    is_read BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
) PARTITION BY RANGE (created_at);

CREATE INDEX idx_notifications_user ON social_network.notifications(user_id, is_read, created_at DESC);
CREATE INDEX idx_notifications_unread ON social_network.notifications(user_id, created_at DESC) WHERE is_read = FALSE;
```

---

## 5. æ¡ˆä¾‹4ï¼šç‰©è”ç½‘æ•°æ®å¹³å°è®¾è®¡

### 5.1. éœ€æ±‚åˆ†æ

**ä¸šåŠ¡éœ€æ±‚**ï¼š

1. **è®¾å¤‡ç®¡ç†**ï¼šè®¾å¤‡æ³¨å†Œã€çŠ¶æ€ç®¡ç†ã€åˆ†ç»„
2. **æ•°æ®é‡‡é›†**ï¼šä¼ æ„Ÿå™¨æ•°æ®ã€è®¾å¤‡çŠ¶æ€ã€äº‹ä»¶æ—¥å¿—
3. **æ•°æ®å¤„ç†**ï¼šå®æ—¶è®¡ç®—ã€èšåˆç»Ÿè®¡ã€å‘Šè­¦
4. **æ•°æ®æŸ¥è¯¢**ï¼šæ—¶é—´åºåˆ—æŸ¥è¯¢ã€èšåˆæŸ¥è¯¢ã€å†å²æ•°æ®

**æ€§èƒ½éœ€æ±‚**ï¼š

- æ”¯æŒç™¾ä¸‡çº§è®¾å¤‡
- æ¯ç§’ç™¾ä¸‡çº§æ•°æ®å†™å…¥
- å®æ—¶æŸ¥è¯¢å“åº” < 100ms
- å†å²æ•°æ®æŸ¥è¯¢ < 1s

### 5.2. å®Œæ•´Schemaè®¾è®¡

```sql
CREATE SCHEMA iot_platform;

-- ============================================
-- è®¾å¤‡æ¨¡å—
-- ============================================

CREATE TABLE iot_platform.devices (
    device_id BIGSERIAL PRIMARY KEY,
    device_code VARCHAR(100) NOT NULL UNIQUE,
    device_name VARCHAR(200) NOT NULL,
    device_type VARCHAR(50) NOT NULL,
    manufacturer VARCHAR(100),
    model VARCHAR(100),
    firmware_version VARCHAR(50),
    group_id BIGINT REFERENCES iot_platform.device_groups(group_id),
    location_name VARCHAR(200),
    location_coordinates POINT,  -- PostGIS
    status VARCHAR(20) NOT NULL DEFAULT 'offline' CHECK (status IN ('online', 'offline', 'error')),
    last_seen_at TIMESTAMPTZ,
    metadata JSONB,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_devices_code ON iot_platform.devices(device_code);
CREATE INDEX idx_devices_type ON iot_platform.devices(device_type, status);
CREATE INDEX idx_devices_group ON iot_platform.devices(group_id);
CREATE INDEX idx_devices_status ON iot_platform.devices(status, last_seen_at);

-- è®¾å¤‡ç»„è¡¨
CREATE TABLE iot_platform.device_groups (
    group_id BIGSERIAL PRIMARY KEY,
    group_name VARCHAR(200) NOT NULL,
    parent_group_id BIGINT REFERENCES iot_platform.device_groups(group_id),
    description TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- ============================================
-- æ•°æ®é‡‡é›†æ¨¡å—ï¼ˆæ—¶åºæ•°æ®ï¼‰
-- ============================================

-- ä¼ æ„Ÿå™¨æ•°æ®è¡¨ï¼ˆæŒ‰æ—¶é—´åˆ†åŒºï¼‰
CREATE TABLE iot_platform.sensor_data (
    data_id BIGSERIAL,
    device_id BIGINT NOT NULL REFERENCES iot_platform.devices(device_id) ON DELETE CASCADE,
    sensor_name VARCHAR(100) NOT NULL,
    sensor_value DECIMAL(15,4) NOT NULL,
    sensor_unit VARCHAR(20),
    data_quality INTEGER CHECK (data_quality BETWEEN 0 AND 100),
    collected_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (data_id, collected_at)
) PARTITION BY RANGE (collected_at);

-- åˆ›å»ºæœˆåº¦åˆ†åŒº
CREATE TABLE iot_platform.sensor_data_2024_01 PARTITION OF iot_platform.sensor_data
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

-- ç´¢å¼•ï¼ˆæ¯ä¸ªåˆ†åŒºï¼‰
CREATE INDEX idx_sensor_data_device_time ON iot_platform.sensor_data(device_id, collected_at DESC);
CREATE INDEX idx_sensor_data_sensor_time ON iot_platform.sensor_data(device_id, sensor_name, collected_at DESC);

-- è®¾å¤‡çŠ¶æ€è¡¨ï¼ˆçŠ¶æ€å˜æ›´è®°å½•ï¼‰
CREATE TABLE iot_platform.device_status_history (
    status_id BIGSERIAL PRIMARY KEY,
    device_id BIGINT NOT NULL REFERENCES iot_platform.devices(device_id) ON DELETE CASCADE,
    old_status VARCHAR(20),
    new_status VARCHAR(20) NOT NULL,
    change_reason TEXT,
    changed_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
) PARTITION BY RANGE (changed_at);

CREATE INDEX idx_device_status_device ON iot_platform.device_status_history(device_id, changed_at DESC);

-- ============================================
-- èšåˆç»Ÿè®¡è¡¨ï¼ˆç‰©åŒ–è§†å›¾ï¼‰
-- ============================================

-- è®¾å¤‡æ•°æ®å°æ—¶èšåˆè¡¨
CREATE MATERIALIZED VIEW iot_platform.device_hourly_stats AS
SELECT
    device_id,
    sensor_name,
    DATE_TRUNC('hour', collected_at) AS hour,
    COUNT(*) AS data_count,
    AVG(sensor_value) AS avg_value,
    MIN(sensor_value) AS min_value,
    MAX(sensor_value) AS max_value,
    STDDEV(sensor_value) AS stddev_value
FROM iot_platform.sensor_data
GROUP BY device_id, sensor_name, DATE_TRUNC('hour', collected_at);

CREATE UNIQUE INDEX idx_device_hourly_stats_unique
ON iot_platform.device_hourly_stats(device_id, sensor_name, hour);

-- åˆ·æ–°å‡½æ•°
CREATE OR REPLACE FUNCTION refresh_device_hourly_stats()
RETURNS VOID AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY iot_platform.device_hourly_stats;
END;
$$ LANGUAGE plpgsql;
```

---

## 6. æ¡ˆä¾‹5ï¼šå†…å®¹ç®¡ç†ç³»ç»Ÿè®¾è®¡

### 6.1. éœ€æ±‚åˆ†æ

**ä¸šåŠ¡éœ€æ±‚**ï¼š

1. **å†…å®¹ç®¡ç†**ï¼šæ–‡ç« ã€é¡µé¢ã€åª’ä½“æ–‡ä»¶
2. **åˆ†ç±»æ ‡ç­¾**ï¼šåˆ†ç±»ä½“ç³»ã€æ ‡ç­¾ç³»ç»Ÿ
3. **ç”¨æˆ·æƒé™**ï¼šè§’è‰²ç®¡ç†ã€æƒé™æ§åˆ¶
4. **ç‰ˆæœ¬æ§åˆ¶**ï¼šå†…å®¹ç‰ˆæœ¬å†å²
5. **è¯„è®ºç³»ç»Ÿ**ï¼šè¯„è®ºã€å®¡æ ¸

### 6.2. å®Œæ•´Schemaè®¾è®¡

```sql
CREATE SCHEMA cms;

-- ============================================
-- å†…å®¹æ¨¡å—
-- ============================================

-- å†…å®¹è¡¨
CREATE TABLE cms.contents (
    content_id BIGSERIAL PRIMARY KEY,
    content_type VARCHAR(50) NOT NULL CHECK (content_type IN ('post', 'page', 'media')),
    title VARCHAR(500) NOT NULL,
    slug VARCHAR(500) NOT NULL UNIQUE,
    content TEXT NOT NULL,
    excerpt TEXT,
    author_id BIGINT NOT NULL REFERENCES cms.users(user_id),
    status VARCHAR(20) NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'published', 'archived', 'trashed')),
    visibility VARCHAR(20) NOT NULL DEFAULT 'public' CHECK (visibility IN ('public', 'private', 'password')),
    password_hash TEXT,
    published_at TIMESTAMPTZ,
    view_count INTEGER DEFAULT 0,
    comment_count INTEGER DEFAULT 0,
    like_count INTEGER DEFAULT 0,
    featured_image_url TEXT,
    metadata JSONB,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_contents_type_status ON cms.contents(content_type, status, published_at DESC);
CREATE INDEX idx_contents_author ON cms.contents(author_id, created_at DESC);
CREATE INDEX idx_contents_slug ON cms.contents(slug);
CREATE INDEX idx_contents_search ON cms.contents USING GIN(to_tsvector('english', title || ' ' || content));

-- å†…å®¹ç‰ˆæœ¬è¡¨ï¼ˆç‰ˆæœ¬æ§åˆ¶ï¼‰
CREATE TABLE cms.content_versions (
    version_id BIGSERIAL PRIMARY KEY,
    content_id BIGINT NOT NULL REFERENCES cms.contents(content_id) ON DELETE CASCADE,
    version_number INTEGER NOT NULL,
    title VARCHAR(500) NOT NULL,
    content TEXT NOT NULL,
    author_id BIGINT NOT NULL REFERENCES cms.users(user_id),
    change_summary TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(content_id, version_number)
);

CREATE INDEX idx_content_versions_content ON cms.content_versions(content_id, version_number DESC);

-- åˆ†ç±»è¡¨
CREATE TABLE cms.categories (
    category_id SERIAL PRIMARY KEY,
    category_name VARCHAR(100) NOT NULL,
    slug VARCHAR(100) NOT NULL UNIQUE,
    parent_id INTEGER REFERENCES cms.categories(category_id),
    description TEXT,
    post_count INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_categories_parent ON cms.categories(parent_id);
CREATE INDEX idx_categories_slug ON cms.categories(slug);

-- å†…å®¹åˆ†ç±»å…³è”è¡¨
CREATE TABLE cms.content_categories (
    content_id BIGINT NOT NULL REFERENCES cms.contents(content_id) ON DELETE CASCADE,
    category_id INTEGER NOT NULL REFERENCES cms.categories(category_id) ON DELETE CASCADE,
    PRIMARY KEY (content_id, category_id)
);

CREATE INDEX idx_content_categories_content ON cms.content_categories(content_id);
CREATE INDEX idx_content_categories_category ON cms.content_categories(category_id);

-- æ ‡ç­¾è¡¨
CREATE TABLE cms.tags (
    tag_id SERIAL PRIMARY KEY,
    tag_name VARCHAR(50) NOT NULL UNIQUE,
    slug VARCHAR(50) NOT NULL UNIQUE,
    description TEXT,
    post_count INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_tags_slug ON cms.tags(slug);

-- å†…å®¹æ ‡ç­¾å…³è”è¡¨
CREATE TABLE cms.content_tags (
    content_id BIGINT NOT NULL REFERENCES cms.contents(content_id) ON DELETE CASCADE,
    tag_id INTEGER NOT NULL REFERENCES cms.tags(tag_id) ON DELETE CASCADE,
    PRIMARY KEY (content_id, tag_id)
);

CREATE INDEX idx_content_tags_content ON cms.content_tags(content_id);
CREATE INDEX idx_content_tags_tag ON cms.content_tags(tag_id);
```

---

## 7. è®¾è®¡å†³ç­–è®°å½•

### 7.1. è®¾è®¡å†³ç­–çŸ©é˜µ

| æ¡ˆä¾‹ | å…³é”®å†³ç­– | é€‰æ‹©æ–¹æ¡ˆ | ç†ç”± |
|------|---------|---------|------|
| **ç”µå•†** | è®¢å•è¡¨è®¾è®¡ | åˆ†åŒºè¡¨ + å†—ä½™å­—æ®µ | æ”¯æŒå¤§è§„æ¨¡æ•°æ®ï¼Œä¿è¯å†å²å‡†ç¡®æ€§ |
| **ç”µå•†** | å•†å“è¯„åˆ† | è§¦å‘å™¨è‡ªåŠ¨æ›´æ–° | ä¿è¯ä¸€è‡´æ€§ï¼Œå‡å°‘åº”ç”¨å¤æ‚åº¦ |
| **é‡‘è** | è´¦æˆ·ä½™é¢ | ä¹è§‚é” + ç‰ˆæœ¬å· | é˜²æ­¢å¹¶å‘å†²çªï¼Œä¿è¯ä¸€è‡´æ€§ |
| **é‡‘è** | äº¤æ˜“è®°å½• | åˆ†åŒºè¡¨ + æ˜ç»†è¡¨ | æ”¯æŒå¤§è§„æ¨¡äº¤æ˜“ï¼Œå®Œæ•´å®¡è®¡ |
| **ç¤¾äº¤** | åŠ¨æ€è¡¨ | åˆ†åŒºè¡¨ + å…¨æ–‡æœç´¢ | æ”¯æŒå¤§è§„æ¨¡å†…å®¹ï¼Œå¿«é€Ÿæœç´¢ |
| **ç¤¾äº¤** | å…³æ³¨å…³ç³» | ç‹¬ç«‹è¡¨ + è®¡æ•°å™¨ | æ”¯æŒå¤æ‚æŸ¥è¯¢ï¼Œæ€§èƒ½ä¼˜åŒ– |
| **ç‰©è”ç½‘** | ä¼ æ„Ÿå™¨æ•°æ® | æ—¶é—´åˆ†åŒº + ç‰©åŒ–è§†å›¾ | æ”¯æŒé«˜é¢‘å†™å…¥ï¼Œå¿«é€ŸèšåˆæŸ¥è¯¢ |
| **CMS** | å†…å®¹ç‰ˆæœ¬ | ç‹¬ç«‹ç‰ˆæœ¬è¡¨ | æ”¯æŒç‰ˆæœ¬æ§åˆ¶ï¼Œå†å²è¿½æº¯ |

---

## 8. æ¡ˆä¾‹6ï¼šAIåº”ç”¨å¹³å°è®¾è®¡ï¼ˆ2025æ–°å¢ï¼‰

### 8.1. éœ€æ±‚åˆ†æ

```mermaid
mindmap
  root((AIåº”ç”¨å¹³å°))
    ç”¨æˆ·ç®¡ç†
      è®¤è¯æˆæƒ
      é…é¢ç®¡ç†
      ä½¿ç”¨ç»Ÿè®¡
    æ¨¡å‹æœåŠ¡
      æ¨¡å‹æ³¨å†Œ
      ç‰ˆæœ¬ç®¡ç†
      æ¨ç†æœåŠ¡
    RAGç³»ç»Ÿ
      æ–‡æ¡£ç®¡ç†
      å‘é‡å­˜å‚¨
      æ£€ç´¢æœåŠ¡
    Agentç³»ç»Ÿ
      å·¥å…·æ³¨å†Œ
      æ‰§è¡Œè®°å½•
      ä¸Šä¸‹æ–‡ç®¡ç†
```

### 8.2. AIå¹³å°Schemaè®¾è®¡

```sql
CREATE SCHEMA ai_platform;

-- æ¨¡å‹æ³¨å†Œè¡¨
CREATE TABLE ai_platform.models (
    model_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    model_name VARCHAR(200) NOT NULL,
    provider VARCHAR(100) NOT NULL,  -- openai, anthropic, local
    model_type VARCHAR(50) NOT NULL,  -- llm, embedding, vision
    version VARCHAR(50),
    config JSONB,  -- æ¨¡å‹é…ç½®
    pricing JSONB,  -- å®šä»·ä¿¡æ¯
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- RAGçŸ¥è¯†åº“
CREATE TABLE ai_platform.knowledge_bases (
    kb_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    kb_name VARCHAR(200) NOT NULL,
    owner_id UUID NOT NULL,
    embedding_model_id UUID REFERENCES ai_platform.models(model_id),
    chunk_size INTEGER DEFAULT 500,
    chunk_overlap INTEGER DEFAULT 50,
    metadata JSONB,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- æ–‡æ¡£å—ä¸å‘é‡
CREATE TABLE ai_platform.documents (
    doc_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    kb_id UUID REFERENCES ai_platform.knowledge_bases(kb_id),
    source_url TEXT,
    content TEXT NOT NULL,
    embedding vector(1536),
    metadata JSONB,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_docs_embedding ON ai_platform.documents
    USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);

-- Agentå·¥å…·æ³¨å†Œ
CREATE TABLE ai_platform.tools (
    tool_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tool_name VARCHAR(200) NOT NULL UNIQUE,
    description TEXT,
    parameters_schema JSONB,  -- JSON Schema
    implementation_type VARCHAR(50),  -- api, function, mcp
    endpoint TEXT,
    is_active BOOLEAN DEFAULT TRUE
);

-- å¯¹è¯ä¼šè¯
CREATE TABLE ai_platform.conversations (
    conversation_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    model_id UUID REFERENCES ai_platform.models(model_id),
    title VARCHAR(500),
    system_prompt TEXT,
    context_window INTEGER DEFAULT 4096,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- æ¶ˆæ¯è®°å½•
CREATE TABLE ai_platform.messages (
    message_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id UUID REFERENCES ai_platform.conversations(conversation_id),
    role VARCHAR(20) NOT NULL CHECK (role IN ('system', 'user', 'assistant', 'tool')),
    content TEXT,
    tool_calls JSONB,
    token_count INTEGER,
    latency_ms INTEGER,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- ä½¿ç”¨é‡ç»Ÿè®¡
CREATE TABLE ai_platform.usage_stats (
    stat_id BIGSERIAL,
    user_id UUID NOT NULL,
    model_id UUID REFERENCES ai_platform.models(model_id),
    date DATE NOT NULL,
    input_tokens BIGINT DEFAULT 0,
    output_tokens BIGINT DEFAULT 0,
    request_count INTEGER DEFAULT 0,
    total_cost DECIMAL(10,4) DEFAULT 0,
    PRIMARY KEY (user_id, model_id, date)
);

-- RAGæ£€ç´¢å‡½æ•°
CREATE OR REPLACE FUNCTION ai_platform.rag_search(
    p_kb_id UUID,
    p_query_embedding vector(1536),
    p_top_k INTEGER DEFAULT 5
)
RETURNS TABLE (
    doc_id UUID,
    content TEXT,
    similarity FLOAT,
    metadata JSONB
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        d.doc_id,
        d.content,
        (1 - (d.embedding <=> p_query_embedding))::FLOAT AS similarity,
        d.metadata
    FROM ai_platform.documents d
    WHERE d.kb_id = p_kb_id
    ORDER BY d.embedding <=> p_query_embedding
    LIMIT p_top_k;
END;
$$ LANGUAGE plpgsql;
```

---

## 9. 2024-2025æ¡ˆä¾‹è®¾è®¡è¶‹åŠ¿

### 9.1. æ¡ˆä¾‹è®¾è®¡æ¼”è¿›

```mermaid
timeline
    title æ•°æ®åº“æ¡ˆä¾‹è®¾è®¡æ¼”è¿›
    2015 : ä¼ ç»ŸCRUDåº”ç”¨
         : å•ä½“æ¶æ„
    2018 : å¾®æœåŠ¡æ¶æ„
         : åˆ†å¸ƒå¼äº‹åŠ¡
    2021 : äº‘åŸç”Ÿè®¾è®¡
         : Serverless
    2024 : AIåŸç”Ÿåº”ç”¨
         : RAG/Agent
    2025 : å¤šæ¨¡æ€æ•°æ®
         : å®æ—¶æ™ºèƒ½
```

### 9.2. è¡Œä¸šæ¡ˆä¾‹å¯¹æ¯”çŸ©é˜µ

| è¡Œä¸š | æ ¸å¿ƒæŒ‘æˆ˜ | å…³é”®æ¨¡å¼ | æ•°æ®åº“é€‰å‹ | 2025è¶‹åŠ¿ |
|------|---------|---------|-----------|---------|
| **ç”µå•†** | é«˜å¹¶å‘ã€å¤æ‚ä¸šåŠ¡ | åˆ†åº“åˆ†è¡¨ã€CQRS | PG+Redis+ES | AIæ¨è |
| **é‡‘è** | ä¸€è‡´æ€§ã€å®‰å…¨ | 2PCã€å®¡è®¡æ—¥å¿— | Oracle/PG | å®æ—¶é£æ§ |
| **ç¤¾äº¤** | å›¾å…³ç³»ã€å†…å®¹ | å›¾æ•°æ®åº“ã€å…¨æ–‡ | Neo4j+PG | çŸ¥è¯†å›¾è°± |
| **IoT** | é«˜é¢‘å†™å…¥ã€èšåˆ | æ—¶åºåˆ†åŒºã€é™é‡‡æ · | TimescaleDB | è¾¹ç¼˜è®¡ç®— |
| **AIå¹³å°** | å‘é‡æ£€ç´¢ã€ä¼šè¯ | RAGã€Agent | pgvector+PG | å¤šæ¨¡æ€ |

---

## 10. å‚è€ƒèµ„æ–™

### 10.1. æƒå¨æ–‡çŒ®

**æ¶æ„è®¾è®¡**ï¼š

- Fowler, M. "Patterns of Enterprise Application Architecture"
- Richardson, C. "Microservices Patterns"

### 10.2. åœ¨çº¿èµ„æº

| èµ„æº | URL | æè¿° |
|------|-----|------|
| **AWSæ¶æ„ä¸­å¿ƒ** | <https://aws.amazon.com/architecture/> | äº‘åŸç”Ÿæ¡ˆä¾‹ |
| **Google Cloudæ¡ˆä¾‹** | <https://cloud.google.com/customers> | è¡Œä¸šæ¡ˆä¾‹ |

### 10.3. ç›¸å…³æ–‡æ¡£

- [07.01-Schemaè®¾è®¡æ–¹æ³•è®º](./07.01-Schemaè®¾è®¡æ–¹æ³•è®º.md)
- [07.09-è¡Œä¸šæ¡ˆä¾‹åº“](./07.09-è¡Œä¸šæ¡ˆä¾‹åº“.md)
- [07.10-å‘é‡æ•°æ®åº“è®¾è®¡](./07.10-å‘é‡æ•°æ®åº“è®¾è®¡.md)

---

**æœ€åæ›´æ–°**ï¼š2025-12-01
**ç»´æŠ¤è€…**ï¼šData-Science Team
**çŠ¶æ€**ï¼šå®æ–½ä¸­
**ç‰ˆæœ¬**ï¼šv2.0 (å¢å¼ºç‰ˆ)
