# æ•°æ®åº“è®¾è®¡æœ€ä½³å®è·µåº“ï¼šä»ç†è®ºåˆ°å®è·µ

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-12-01
> **ç‰ˆæœ¬**ï¼šv2.0 (å¢å¼ºç‰ˆ)
> **çŠ¶æ€**ï¼šå·²å®Œæˆ âœ…

---

## ğŸ“‹ ç›®å½•

- [æ•°æ®åº“è®¾è®¡æœ€ä½³å®è·µåº“ï¼šä»ç†è®ºåˆ°å®è·µ](#æ•°æ®åº“è®¾è®¡æœ€ä½³å®è·µåº“ä»ç†è®ºåˆ°å®è·µ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1. æœ€ä½³å®è·µåˆ†ç±»](#11-æœ€ä½³å®è·µåˆ†ç±»)
  - [2. Schemaè®¾è®¡æœ€ä½³å®è·µ](#2-schemaè®¾è®¡æœ€ä½³å®è·µ)
    - [2.1. å‘½åè§„èŒƒ](#21-å‘½åè§„èŒƒ)
    - [2.2. æ•°æ®ç±»å‹é€‰æ‹©](#22-æ•°æ®ç±»å‹é€‰æ‹©)
    - [2.3. çº¦æŸè®¾è®¡](#23-çº¦æŸè®¾è®¡)
    - [2.4. èŒƒå¼åŒ–è®¾è®¡](#24-èŒƒå¼åŒ–è®¾è®¡)
  - [3. ç´¢å¼•è®¾è®¡æœ€ä½³å®è·µ](#3-ç´¢å¼•è®¾è®¡æœ€ä½³å®è·µ)
    - [3.1. ç´¢å¼•é€‰æ‹©å†³ç­–æ ‘](#31-ç´¢å¼•é€‰æ‹©å†³ç­–æ ‘)
    - [3.2. ç´¢å¼•è®¾è®¡æœ€ä½³å®è·µ](#32-ç´¢å¼•è®¾è®¡æœ€ä½³å®è·µ)
  - [4. æŸ¥è¯¢è®¾è®¡æœ€ä½³å®è·µ](#4-æŸ¥è¯¢è®¾è®¡æœ€ä½³å®è·µ)
    - [4.1. JOINä¼˜åŒ–](#41-joinä¼˜åŒ–)
    - [4.2. å­æŸ¥è¯¢ä¼˜åŒ–](#42-å­æŸ¥è¯¢ä¼˜åŒ–)
    - [4.3. èšåˆä¼˜åŒ–](#43-èšåˆä¼˜åŒ–)
    - [4.4. åˆ†é¡µä¼˜åŒ–](#44-åˆ†é¡µä¼˜åŒ–)
  - [5. æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ](#5-æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ)
    - [5.1. åˆ†åŒºç­–ç•¥](#51-åˆ†åŒºç­–ç•¥)
    - [5.2. ç‰©åŒ–è§†å›¾](#52-ç‰©åŒ–è§†å›¾)
  - [6. æ•°æ®å»ºæ¨¡æœ€ä½³å®è·µ](#6-æ•°æ®å»ºæ¨¡æœ€ä½³å®è·µ)
    - [6.1. å®ä½“å…³ç³»è®¾è®¡](#61-å®ä½“å…³ç³»è®¾è®¡)
    - [6.2. æ•°æ®å­—å…¸](#62-æ•°æ®å­—å…¸)
  - [7. å®‰å…¨ä¸åˆè§„æœ€ä½³å®è·µ](#7-å®‰å…¨ä¸åˆè§„æœ€ä½³å®è·µ)
    - [7.1. è®¿é—®æ§åˆ¶](#71-è®¿é—®æ§åˆ¶)
    - [7.2. æ•°æ®åŠ å¯†](#72-æ•°æ®åŠ å¯†)
  - [8. 2024-2025æœ€ä½³å®è·µè¶‹åŠ¿](#8-2024-2025æœ€ä½³å®è·µè¶‹åŠ¿)
    - [8.1. æ•°æ®åº“è®¾è®¡å®è·µæ¼”è¿›](#81-æ•°æ®åº“è®¾è®¡å®è·µæ¼”è¿›)
    - [8.2. æœ€ä½³å®è·µä¼˜å…ˆçº§çŸ©é˜µ](#82-æœ€ä½³å®è·µä¼˜å…ˆçº§çŸ©é˜µ)
    - [8.3. ç°ä»£PostgreSQLæœ€ä½³å®è·µ](#83-ç°ä»£postgresqlæœ€ä½³å®è·µ)
    - [8.4. äº‘åŸç”Ÿæ•°æ®åº“æœ€ä½³å®è·µ](#84-äº‘åŸç”Ÿæ•°æ®åº“æœ€ä½³å®è·µ)
  - [9. å‚è€ƒèµ„æ–™](#9-å‚è€ƒèµ„æ–™)
    - [9.1. æƒå¨æ–‡çŒ®](#91-æƒå¨æ–‡çŒ®)
    - [9.2. åœ¨çº¿èµ„æº](#92-åœ¨çº¿èµ„æº)
    - [9.3. ç›¸å…³æ–‡æ¡£](#93-ç›¸å…³æ–‡æ¡£)

---

## 1. æ¦‚è¿°

æœ¬æ–‡æ¡£æ±‡é›†äº†æ•°æ®åº“è®¾è®¡çš„æ ¸å¿ƒæœ€ä½³å®è·µï¼Œæ¶µç›–ä»Schemaè®¾è®¡åˆ°æ€§èƒ½ä¼˜åŒ–çš„å„ä¸ªæ–¹é¢ã€‚

### 1.1. æœ€ä½³å®è·µåˆ†ç±»

```mermaid
mindmap
  root((æœ€ä½³å®è·µ))
    Schemaè®¾è®¡
      å‘½åè§„èŒƒ
      æ•°æ®ç±»å‹é€‰æ‹©
      çº¦æŸè®¾è®¡
      èŒƒå¼åŒ–è®¾è®¡
    ç´¢å¼•è®¾è®¡
      ä¸»é”®ç´¢å¼•
      å¤–é”®ç´¢å¼•
      å¤åˆç´¢å¼•
      éƒ¨åˆ†ç´¢å¼•
    æŸ¥è¯¢è®¾è®¡
      JOINä¼˜åŒ–
      å­æŸ¥è¯¢ä¼˜åŒ–
      èšåˆä¼˜åŒ–
      åˆ†é¡µä¼˜åŒ–
    æ€§èƒ½ä¼˜åŒ–
      åˆ†åŒºç­–ç•¥
      ç‰©åŒ–è§†å›¾
      æŸ¥è¯¢ç¼“å­˜
      è¿æ¥æ± 
    æ•°æ®å»ºæ¨¡
      å®ä½“å…³ç³»
      æ•°æ®å­—å…¸
      ç‰ˆæœ¬ç®¡ç†
      è¿ç§»ç­–ç•¥
```

---

## 2. Schemaè®¾è®¡æœ€ä½³å®è·µ

### 2.1. å‘½åè§„èŒƒ

**è¡¨å‘½åè§„èŒƒ**ï¼š

```sql
-- âœ… å¥½çš„å‘½å
CREATE TABLE users (
    user_id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL
);

CREATE TABLE user_profiles (
    profile_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(user_id),
    first_name VARCHAR(100),
    last_name VARCHAR(100)
);

-- âŒ ä¸å¥½çš„å‘½å
CREATE TABLE tbl_user ();  -- ä¸è¦ä½¿ç”¨tblå‰ç¼€
CREATE TABLE User ();  -- ä¸è¦ä½¿ç”¨å¤§å†™
CREATE TABLE user_data_table ();  -- ä¸è¦ä½¿ç”¨data_tableåç¼€
```

**åˆ—å‘½åè§„èŒƒ**ï¼š

```sql
-- âœ… å¥½çš„å‘½å
CREATE TABLE orders (
    order_id BIGSERIAL PRIMARY KEY,
    customer_id BIGINT NOT NULL,
    order_date TIMESTAMP NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL,
    is_paid BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- âŒ ä¸å¥½çš„å‘½å
CREATE TABLE orders (
    id BIGSERIAL PRIMARY KEY,  -- ä¸å¤Ÿæ˜ç¡®
    cust_id BIGINT,  -- ç¼©å†™ä¸æ¸…æ™°
    date TIMESTAMP,  -- å¤ªé€šç”¨
    amt DECIMAL(10,2),  -- ç¼©å†™
    paid BOOLEAN  -- ç¼ºå°‘is_å‰ç¼€
);
```

### 2.2. æ•°æ®ç±»å‹é€‰æ‹©

**æ•°æ®ç±»å‹é€‰æ‹©å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[é€‰æ‹©æ•°æ®ç±»å‹] --> B{æ•°æ®ç‰¹æ€§}

    B -->|æ•´æ•°| C{æ•°å€¼èŒƒå›´}
    B -->|å°æ•°| D{ç²¾åº¦è¦æ±‚}
    B -->|æ–‡æœ¬| E{é•¿åº¦å›ºå®š?}
    B -->|æ—¥æœŸæ—¶é—´| F{æ—¶åŒºè¦æ±‚}
    B -->|å¸ƒå°”| G[BOOLEAN]
    B -->|JSON| H[JSONB]

    C -->|å°èŒƒå›´| I[SMALLINT]
    C -->|ä¸­ç­‰èŒƒå›´| J[INTEGER]
    C -->|å¤§èŒƒå›´| K[BIGINT]

    D -->|è´§å¸| L[DECIMAL]
    D -->|ç§‘å­¦è®¡ç®—| M[DOUBLE PRECISION]

    E -->|æ˜¯| N[CHAR/VARCHAR]
    E -->|å¦| O[TEXT]

    F -->|éœ€è¦æ—¶åŒº| P[TIMESTAMPTZ]
    F -->|ä¸éœ€è¦| Q[TIMESTAMP]
```

**æ•°æ®ç±»å‹æœ€ä½³å®è·µ**ï¼š

```sql
-- âœ… å¥½çš„æ•°æ®ç±»å‹é€‰æ‹©
CREATE TABLE products (
    product_id BIGSERIAL PRIMARY KEY,  -- ä½¿ç”¨BIGSERIALæ”¯æŒå¤§ID
    sku VARCHAR(50) NOT NULL UNIQUE,  -- å›ºå®šé•¿åº¦ä½¿ç”¨VARCHAR
    name VARCHAR(200) NOT NULL,
    description TEXT,  -- å¯å˜é•¿åº¦ä½¿ç”¨TEXT
    price DECIMAL(10,2) NOT NULL,  -- è´§å¸ä½¿ç”¨DECIMAL
    stock_quantity INTEGER NOT NULL DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    metadata JSONB,  -- ç»“æ„åŒ–æ•°æ®ä½¿ç”¨JSONB
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,  -- ä½¿ç”¨TIMESTAMPTZ
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- âŒ ä¸å¥½çš„æ•°æ®ç±»å‹é€‰æ‹©
CREATE TABLE products (
    id INT PRIMARY KEY,  -- å¯èƒ½æº¢å‡º
    sku CHAR(50),  -- å›ºå®šé•¿åº¦æµªè´¹ç©ºé—´
    description VARCHAR(10000),  -- åº”è¯¥ç”¨TEXT
    price FLOAT,  -- ç²¾åº¦é—®é¢˜
    stock SMALLINT,  -- å¯èƒ½ä¸å¤Ÿ
    active CHAR(1),  -- åº”è¯¥ç”¨BOOLEAN
    metadata TEXT,  -- åº”è¯¥ç”¨JSONB
    created_at TIMESTAMP  -- ç¼ºå°‘æ—¶åŒº
);
```

### 2.3. çº¦æŸè®¾è®¡

**çº¦æŸè®¾è®¡æœ€ä½³å®è·µ**ï¼š

```sql
-- âœ… å®Œæ•´çš„çº¦æŸè®¾è®¡
CREATE TABLE orders (
    order_id BIGSERIAL PRIMARY KEY,
    customer_id BIGINT NOT NULL REFERENCES customers(customer_id) ON DELETE RESTRICT,
    order_number VARCHAR(50) NOT NULL UNIQUE,
    order_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    total_amount DECIMAL(10,2) NOT NULL CHECK (total_amount >= 0),
    status VARCHAR(20) NOT NULL CHECK (status IN ('pending', 'processing', 'shipped', 'delivered', 'cancelled')),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    -- è¡¨çº§çº¦æŸ
    CONSTRAINT orders_customer_date_unique UNIQUE (customer_id, order_date)
);

-- åˆ›å»ºæ›´æ–°æ—¶é—´è§¦å‘å™¨
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_orders_updated_at
BEFORE UPDATE ON orders
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();
```

### 2.4. èŒƒå¼åŒ–è®¾è®¡

**èŒƒå¼åŒ–å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[æ•°æ®å»ºæ¨¡] --> B{æŸ¥è¯¢æ¨¡å¼}

    B -->|OLTP| C[é«˜åº¦èŒƒå¼åŒ–]
    B -->|OLAP| D[é€‚åº¦åèŒƒå¼åŒ–]
    B -->|æ··åˆ| E[æ··åˆè®¾è®¡]

    C --> F[3NF/BCNF]
    D --> G[æ˜Ÿå‹/é›ªèŠ±å‹]
    E --> H[æ ¸å¿ƒè¡¨èŒƒå¼åŒ–<br/>æŠ¥è¡¨è¡¨åèŒƒå¼åŒ–]
```

**èŒƒå¼åŒ–æœ€ä½³å®è·µ**ï¼š

```sql
-- âœ… èŒƒå¼åŒ–è®¾è®¡ï¼ˆ3NFï¼‰
CREATE TABLE customers (
    customer_id BIGSERIAL PRIMARY KEY,
    email VARCHAR(100) NOT NULL UNIQUE,
    name VARCHAR(200) NOT NULL
);

CREATE TABLE addresses (
    address_id BIGSERIAL PRIMARY KEY,
    customer_id BIGINT NOT NULL REFERENCES customers(customer_id),
    address_type VARCHAR(20) NOT NULL CHECK (address_type IN ('billing', 'shipping')),
    street VARCHAR(200) NOT NULL,
    city VARCHAR(100) NOT NULL,
    state VARCHAR(50) NOT NULL,
    zip_code VARCHAR(20) NOT NULL,
    country VARCHAR(50) NOT NULL DEFAULT 'USA',
    is_default BOOLEAN DEFAULT FALSE,
    UNIQUE(customer_id, address_type)
);

CREATE TABLE orders (
    order_id BIGSERIAL PRIMARY KEY,
    customer_id BIGINT NOT NULL REFERENCES customers(customer_id),
    shipping_address_id BIGINT NOT NULL REFERENCES addresses(address_id),
    billing_address_id BIGINT NOT NULL REFERENCES addresses(address_id),
    order_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    total_amount DECIMAL(10,2) NOT NULL
);
```

---

## 3. ç´¢å¼•è®¾è®¡æœ€ä½³å®è·µ

### 3.1. ç´¢å¼•é€‰æ‹©å†³ç­–æ ‘

```mermaid
flowchart TD
    A[éœ€è¦ç´¢å¼•?] --> B{æŸ¥è¯¢æ¨¡å¼}

    B -->|ä¸»é”®æŸ¥è¯¢| C[ä¸»é”®ç´¢å¼•<br/>è‡ªåŠ¨åˆ›å»º]
    B -->|å¤–é”®æŸ¥è¯¢| D[å¤–é”®ç´¢å¼•<br/>è‡ªåŠ¨åˆ›å»º]
    B -->|ç­‰å€¼æŸ¥è¯¢| E[B-Treeç´¢å¼•]
    B -->|èŒƒå›´æŸ¥è¯¢| F[B-Treeç´¢å¼•]
    B -->|å…¨æ–‡æœç´¢| G[GINç´¢å¼•]
    B -->|æ•°ç»„æŸ¥è¯¢| H[GINç´¢å¼•]
    B -->|JSONæŸ¥è¯¢| I[GINç´¢å¼•]
    B -->|å‘é‡ç›¸ä¼¼åº¦| J[HNSW/IVFFlat]
    B -->|ç©ºé—´æŸ¥è¯¢| K[GISTç´¢å¼•]

    E --> L[åˆ›å»ºç´¢å¼•]
    F --> L
    G --> L
    H --> L
    I --> L
    J --> L
    K --> L
```

### 3.2. ç´¢å¼•è®¾è®¡æœ€ä½³å®è·µ

**ä¸»é”®ç´¢å¼•**ï¼š

```sql
-- âœ… å¥½çš„ä¸»é”®è®¾è®¡
CREATE TABLE users (
    user_id BIGSERIAL PRIMARY KEY,  -- ä½¿ç”¨BIGSERIALæ”¯æŒå¤§ID
    email VARCHAR(100) NOT NULL UNIQUE,
    username VARCHAR(50) NOT NULL UNIQUE
);

-- å¤åˆä¸»é”®ï¼ˆå¦‚æœéœ€è¦ï¼‰
CREATE TABLE order_items (
    order_id BIGINT NOT NULL REFERENCES orders(order_id),
    product_id BIGINT NOT NULL REFERENCES products(product_id),
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    unit_price DECIMAL(10,2) NOT NULL,
    PRIMARY KEY (order_id, product_id)  -- å¤åˆä¸»é”®
);
```

**å¤–é”®ç´¢å¼•**ï¼š

```sql
-- âœ… å¤–é”®è‡ªåŠ¨åˆ›å»ºç´¢å¼•
CREATE TABLE orders (
    order_id BIGSERIAL PRIMARY KEY,
    customer_id BIGINT NOT NULL REFERENCES customers(customer_id),  -- è‡ªåŠ¨åˆ›å»ºç´¢å¼•
    status VARCHAR(20) NOT NULL
);

-- å¦‚æœéœ€è¦é¢å¤–çš„å¤–é”®ç´¢å¼•ï¼ˆå¤šåˆ—å¤–é”®ï¼‰
CREATE TABLE order_items (
    order_id BIGINT NOT NULL REFERENCES orders(order_id),
    product_id BIGINT NOT NULL REFERENCES products(product_id),
    PRIMARY KEY (order_id, product_id)
);

-- ä¸ºå¤–é”®åˆ—åˆ›å»ºå¤åˆç´¢å¼•ï¼ˆå¦‚æœéœ€è¦ï¼‰
CREATE INDEX idx_orders_customer_status
ON orders(customer_id, status);
```

**å¤åˆç´¢å¼•**ï¼š

```sql
-- âœ… å¥½çš„å¤åˆç´¢å¼•è®¾è®¡
CREATE TABLE orders (
    order_id BIGSERIAL PRIMARY KEY,
    customer_id BIGINT NOT NULL,
    order_date TIMESTAMP NOT NULL,
    status VARCHAR(20) NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL
);

-- å¤åˆç´¢å¼•ï¼šæ”¯æŒå¤šåˆ—æŸ¥è¯¢
CREATE INDEX idx_orders_customer_date
ON orders(customer_id, order_date DESC);

-- è¦†ç›–ç´¢å¼•ï¼šåŒ…å«æŸ¥è¯¢æ‰€éœ€çš„æ‰€æœ‰åˆ—
CREATE INDEX idx_orders_customer_status_covering
ON orders(customer_id, status)
INCLUDE (order_date, total_amount);

-- âŒ ä¸å¥½çš„ç´¢å¼•è®¾è®¡
CREATE INDEX idx_orders_all ON orders(customer_id, order_date, status, total_amount);  -- ç´¢å¼•å¤ªå¤§
```

**éƒ¨åˆ†ç´¢å¼•**ï¼š

```sql
-- âœ… éƒ¨åˆ†ç´¢å¼•ï¼šåªç´¢å¼•æ´»è·ƒæ•°æ®
CREATE INDEX idx_orders_active
ON orders(customer_id, order_date)
WHERE status = 'active';

-- éƒ¨åˆ†ç´¢å¼•ï¼šæ’é™¤NULLå€¼
CREATE INDEX idx_orders_with_discount
ON orders(customer_id, total_amount)
WHERE discount_amount IS NOT NULL;

-- éƒ¨åˆ†ç´¢å¼•ï¼šåªç´¢å¼•æœ€è¿‘æ•°æ®
CREATE INDEX idx_orders_recent
ON orders(customer_id, order_date)
WHERE order_date >= CURRENT_DATE - INTERVAL '1 year';
```

**è¡¨è¾¾å¼ç´¢å¼•**ï¼š

```sql
-- âœ… è¡¨è¾¾å¼ç´¢å¼•ï¼šæ”¯æŒå‡½æ•°æŸ¥è¯¢
CREATE INDEX idx_users_email_lower
ON users(LOWER(email));

-- ä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢
SELECT * FROM users WHERE LOWER(email) = LOWER('user@example.com');

-- è¡¨è¾¾å¼ç´¢å¼•ï¼šæ”¯æŒJSONæŸ¥è¯¢
CREATE INDEX idx_products_metadata_category
ON products((metadata->>'category'));

-- ä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢
SELECT * FROM products WHERE metadata->>'category' = 'electronics';
```

---

## 4. æŸ¥è¯¢è®¾è®¡æœ€ä½³å®è·µ

### 4.1. JOINä¼˜åŒ–

**JOINä¼˜åŒ–æœ€ä½³å®è·µ**ï¼š

```sql
-- âœ… å¥½çš„JOINè®¾è®¡
-- 1. ä½¿ç”¨INNER JOINè€Œä¸æ˜¯WHEREå­å¥
SELECT
    o.order_id,
    o.order_date,
    c.customer_name,
    c.email
FROM orders o
INNER JOIN customers c ON o.customer_id = c.customer_id
WHERE o.order_date >= CURRENT_DATE - INTERVAL '30 days';

-- 2. ç¡®ä¿JOINåˆ—æœ‰ç´¢å¼•
CREATE INDEX idx_orders_customer ON orders(customer_id);
CREATE INDEX idx_customers_id ON customers(customer_id);  -- ä¸»é”®è‡ªåŠ¨æœ‰ç´¢å¼•

-- 3. ä½¿ç”¨EXPLAIN ANALYZEåˆ†ææŸ¥è¯¢è®¡åˆ’
EXPLAIN ANALYZE
SELECT o.*, c.customer_name
FROM orders o
INNER JOIN customers c ON o.customer_id = c.customer_id
WHERE o.status = 'pending';

-- âŒ ä¸å¥½çš„JOINè®¾è®¡
-- 1. ä½¿ç”¨WHEREå­å¥ä»£æ›¿JOIN
SELECT o.*, c.customer_name
FROM orders o, customers c
WHERE o.customer_id = c.customer_id;  -- æ—§å¼è¯­æ³•

-- 2. ç¼ºå°‘ç´¢å¼•
SELECT o.*, c.customer_name
FROM orders o
INNER JOIN customers c ON o.customer_id = c.customer_id;  -- customer_idæ²¡æœ‰ç´¢å¼•
```

### 4.2. å­æŸ¥è¯¢ä¼˜åŒ–

**å­æŸ¥è¯¢ä¼˜åŒ–æœ€ä½³å®è·µ**ï¼š

```sql
-- âœ… ä½¿ç”¨EXISTSä»£æ›¿INï¼ˆå½“åªéœ€è¦æ£€æŸ¥å­˜åœ¨æ€§æ—¶ï¼‰
SELECT customer_id, customer_name
FROM customers c
WHERE EXISTS (
    SELECT 1 FROM orders o
    WHERE o.customer_id = c.customer_id
      AND o.order_date >= CURRENT_DATE - INTERVAL '30 days'
);

-- âŒ ä½¿ç”¨INï¼ˆæ€§èƒ½è¾ƒå·®ï¼‰
SELECT customer_id, customer_name
FROM customers
WHERE customer_id IN (
    SELECT customer_id FROM orders
    WHERE order_date >= CURRENT_DATE - INTERVAL '30 days'
);

-- âœ… ä½¿ç”¨JOINä»£æ›¿å­æŸ¥è¯¢ï¼ˆå½“éœ€è¦å…³è”æ•°æ®æ—¶ï¼‰
SELECT DISTINCT c.customer_id, c.customer_name
FROM customers c
INNER JOIN orders o ON c.customer_id = o.customer_id
WHERE o.order_date >= CURRENT_DATE - INTERVAL '30 days';

-- âœ… ä½¿ç”¨LATERAL JOINï¼ˆå½“å­æŸ¥è¯¢ä¾èµ–å¤–å±‚æŸ¥è¯¢æ—¶ï¼‰
SELECT
    c.customer_id,
    c.customer_name,
    recent_orders.order_id,
    recent_orders.order_date
FROM customers c
CROSS JOIN LATERAL (
    SELECT order_id, order_date
    FROM orders
    WHERE customer_id = c.customer_id
    ORDER BY order_date DESC
    LIMIT 5
) AS recent_orders;
```

### 4.3. èšåˆä¼˜åŒ–

**èšåˆä¼˜åŒ–æœ€ä½³å®è·µ**ï¼š

```sql
-- âœ… ä½¿ç”¨GROUP BYä¼˜åŒ–
-- 1. ç¡®ä¿GROUP BYåˆ—æœ‰ç´¢å¼•
CREATE INDEX idx_orders_customer_date
ON orders(customer_id, order_date);

SELECT
    customer_id,
    COUNT(*) AS order_count,
    SUM(total_amount) AS total_spent,
    AVG(total_amount) AS avg_order_value
FROM orders
WHERE order_date >= CURRENT_DATE - INTERVAL '1 year'
GROUP BY customer_id;

-- 2. ä½¿ç”¨HAVINGè¿‡æ»¤èšåˆç»“æœï¼ˆè€Œä¸æ˜¯å­æŸ¥è¯¢ï¼‰
SELECT
    customer_id,
    COUNT(*) AS order_count,
    SUM(total_amount) AS total_spent
FROM orders
GROUP BY customer_id
HAVING COUNT(*) >= 5 AND SUM(total_amount) >= 1000;

-- âŒ ä¸å¥½çš„èšåˆè®¾è®¡
-- ä½¿ç”¨å­æŸ¥è¯¢è¿‡æ»¤èšåˆç»“æœ
SELECT customer_id, order_count, total_spent
FROM (
    SELECT
        customer_id,
        COUNT(*) AS order_count,
        SUM(total_amount) AS total_spent
    FROM orders
    GROUP BY customer_id
) subq
WHERE order_count >= 5 AND total_spent >= 1000;
```

### 4.4. åˆ†é¡µä¼˜åŒ–

**åˆ†é¡µä¼˜åŒ–æœ€ä½³å®è·µ**ï¼š

```sql
-- âœ… ä½¿ç”¨OFFSET/LIMITï¼ˆå°æ•°æ®é›†ï¼‰
SELECT order_id, order_date, total_amount
FROM orders
WHERE customer_id = 123
ORDER BY order_date DESC
LIMIT 20 OFFSET 0;

-- âœ… ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µï¼ˆå¤§æ•°æ®é›†ï¼‰
-- ç¬¬ä¸€é¡µ
SELECT order_id, order_date, total_amount
FROM orders
WHERE customer_id = 123
ORDER BY order_date DESC, order_id DESC
LIMIT 20;

-- åç»­é¡µï¼ˆä½¿ç”¨ä¸Šä¸€é¡µçš„æœ€åä¸€æ¡è®°å½•çš„order_dateå’Œorder_idï¼‰
SELECT order_id, order_date, total_amount
FROM orders
WHERE customer_id = 123
  AND (order_date < '2024-01-15' OR (order_date = '2024-01-15' AND order_id < 456))
ORDER BY order_date DESC, order_id DESC
LIMIT 20;

-- âŒ ä¸å¥½çš„åˆ†é¡µè®¾è®¡ï¼ˆå¤§æ•°æ®é›†ä½¿ç”¨OFFSETï¼‰
SELECT order_id, order_date, total_amount
FROM orders
WHERE customer_id = 123
ORDER BY order_date DESC
LIMIT 20 OFFSET 10000;  -- æ€§èƒ½å¾ˆå·®
```

---

## 5. æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

### 5.1. åˆ†åŒºç­–ç•¥

**åˆ†åŒºé€‰æ‹©å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[éœ€è¦åˆ†åŒº?] --> B{æ•°æ®è§„æ¨¡}

    B -->|å°è§„æ¨¡| C[ä¸éœ€è¦åˆ†åŒº]
    B -->|å¤§è§„æ¨¡| D{æ•°æ®ç‰¹æ€§}

    D -->|æ—¶é—´åºåˆ—| E[æŒ‰æ—¶é—´åˆ†åŒº]
    D -->|åœ°ç†åˆ†å¸ƒ| F[æŒ‰åœ°ç†ä½ç½®åˆ†åŒº]
    D -->|ä¸šåŠ¡é€»è¾‘| G[æŒ‰ä¸šåŠ¡åˆ†åŒº]

    E --> H[èŒƒå›´åˆ†åŒº]
    F --> I[åˆ—è¡¨åˆ†åŒº]
    G --> J[å“ˆå¸Œåˆ†åŒº]
```

**åˆ†åŒºæœ€ä½³å®è·µ**ï¼š

```sql
-- âœ… æ—¶é—´åºåˆ—æ•°æ®åˆ†åŒº
CREATE TABLE orders (
    order_id BIGSERIAL,
    customer_id BIGINT NOT NULL,
    order_date TIMESTAMP NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL,
    PRIMARY KEY (order_id, order_date)
) PARTITION BY RANGE (order_date);

-- åˆ›å»ºåˆ†åŒº
CREATE TABLE orders_2024_q1
PARTITION OF orders
FOR VALUES FROM ('2024-01-01') TO ('2024-04-01');

CREATE TABLE orders_2024_q2
PARTITION OF orders
FOR VALUES FROM ('2024-04-01') TO ('2024-07-01');

-- è‡ªåŠ¨åˆ›å»ºæœªæ¥åˆ†åŒºçš„å‡½æ•°
CREATE OR REPLACE FUNCTION create_monthly_partitions(
    p_table_name TEXT,
    p_start_date DATE,
    p_months_ahead INTEGER DEFAULT 12
)
RETURNS VOID AS $$
DECLARE
    v_date DATE;
    v_partition_name TEXT;
    v_start_date DATE;
    v_end_date DATE;
BEGIN
    v_date := p_start_date;

    FOR i IN 1..p_months_ahead LOOP
        v_start_date := date_trunc('month', v_date);
        v_end_date := v_start_date + INTERVAL '1 month';
        v_partition_name := p_table_name || '_' || to_char(v_start_date, 'YYYY_MM');

        EXECUTE format(
            'CREATE TABLE IF NOT EXISTS %I PARTITION OF %I FOR VALUES FROM (%L) TO (%L)',
            v_partition_name,
            p_table_name,
            v_start_date,
            v_end_date
        );

        v_date := v_end_date;
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

### 5.2. ç‰©åŒ–è§†å›¾

**ç‰©åŒ–è§†å›¾æœ€ä½³å®è·µ**ï¼š

```sql
-- âœ… åˆ›å»ºç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW mv_customer_order_summary AS
SELECT
    c.customer_id,
    c.customer_name,
    COUNT(o.order_id) AS total_orders,
    SUM(o.total_amount) AS total_spent,
    AVG(o.total_amount) AS avg_order_value,
    MAX(o.order_date) AS last_order_date
FROM customers c
LEFT JOIN orders o ON c.customer_id = o.customer_id
GROUP BY c.customer_id, c.customer_name;

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_mv_customer_order_summary_customer
ON mv_customer_order_summary(customer_id);

-- åˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_customer_order_summary;

-- è‡ªåŠ¨åˆ·æ–°ç‰©åŒ–è§†å›¾çš„å‡½æ•°
CREATE OR REPLACE FUNCTION refresh_materialized_views()
RETURNS VOID AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY mv_customer_order_summary;
    -- å¯ä»¥æ·»åŠ æ›´å¤šç‰©åŒ–è§†å›¾
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨pg_cronå®šæœŸåˆ·æ–°ï¼ˆéœ€è¦å®‰è£…æ‰©å±•ï¼‰
-- SELECT cron.schedule('refresh-mv', '0 * * * *', 'SELECT refresh_materialized_views()');
```

---

## 6. æ•°æ®å»ºæ¨¡æœ€ä½³å®è·µ

### 6.1. å®ä½“å…³ç³»è®¾è®¡

**ERè®¾è®¡æœ€ä½³å®è·µ**ï¼š

```sql
-- âœ… æ¸…æ™°çš„å®ä½“å…³ç³»è®¾è®¡
-- 1. æ˜ç¡®çš„å®ä½“
CREATE TABLE customers (
    customer_id BIGSERIAL PRIMARY KEY,
    email VARCHAR(100) NOT NULL UNIQUE,
    name VARCHAR(200) NOT NULL
);

CREATE TABLE products (
    product_id BIGSERIAL PRIMARY KEY,
    sku VARCHAR(50) NOT NULL UNIQUE,
    name VARCHAR(200) NOT NULL,
    price DECIMAL(10,2) NOT NULL
);

-- 2. æ˜ç¡®çš„å…³è”è¡¨
CREATE TABLE order_items (
    order_id BIGINT NOT NULL REFERENCES orders(order_id) ON DELETE CASCADE,
    product_id BIGINT NOT NULL REFERENCES products(product_id) ON DELETE RESTRICT,
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    unit_price DECIMAL(10,2) NOT NULL,
    PRIMARY KEY (order_id, product_id)
);

-- 3. è½¯åˆ é™¤è®¾è®¡
CREATE TABLE customers (
    customer_id BIGSERIAL PRIMARY KEY,
    email VARCHAR(100) NOT NULL UNIQUE,
    name VARCHAR(200) NOT NULL,
    deleted_at TIMESTAMP NULL,
    CONSTRAINT customers_email_unique_when_active
        UNIQUE NULLS NOT DISTINCT (email, deleted_at)
);

-- æŸ¥è¯¢æ—¶æ’é™¤å·²åˆ é™¤è®°å½•
CREATE INDEX idx_customers_active
ON customers(customer_id)
WHERE deleted_at IS NULL;
```

### 6.2. æ•°æ®å­—å…¸

**æ•°æ®å­—å…¸æœ€ä½³å®è·µ**ï¼š

```sql
-- âœ… ä½¿ç”¨COMMENTåˆ›å»ºæ•°æ®å­—å…¸
COMMENT ON TABLE customers IS 'å®¢æˆ·ä¿¡æ¯è¡¨ï¼Œå­˜å‚¨æ‰€æœ‰æ³¨å†Œå®¢æˆ·çš„åŸºæœ¬ä¿¡æ¯';
COMMENT ON COLUMN customers.customer_id IS 'å®¢æˆ·å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œè‡ªå¢ä¸»é”®';
COMMENT ON COLUMN customers.email IS 'å®¢æˆ·é‚®ç®±åœ°å€ï¼Œç”¨äºç™»å½•å’Œé€šçŸ¥ï¼Œå”¯ä¸€çº¦æŸ';
COMMENT ON COLUMN customers.name IS 'å®¢æˆ·å§“åï¼Œæ˜¾ç¤ºåç§°';

COMMENT ON TABLE orders IS 'è®¢å•è¡¨ï¼Œå­˜å‚¨æ‰€æœ‰è®¢å•ä¿¡æ¯';
COMMENT ON COLUMN orders.order_id IS 'è®¢å•å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œè‡ªå¢ä¸»é”®';
COMMENT ON COLUMN orders.customer_id IS 'å®¢æˆ·IDï¼Œå¤–é”®å…³è”customersè¡¨';
COMMENT ON COLUMN orders.total_amount IS 'è®¢å•æ€»é‡‘é¢ï¼Œå•ä½ï¼šå…ƒï¼Œç²¾åº¦ï¼š2ä½å°æ•°';

-- æŸ¥è¯¢æ•°æ®å­—å…¸
SELECT
    t.table_name,
    c.column_name,
    c.data_type,
    c.column_default,
    c.is_nullable,
    obj_description(c.oid, 'pg_class') AS table_comment,
    col_description(c.oid, c.ordinal_position) AS column_comment
FROM information_schema.tables t
JOIN information_schema.columns c ON t.table_name = c.table_name
WHERE t.table_schema = 'public'
ORDER BY t.table_name, c.ordinal_position;
```

---

## 7. å®‰å…¨ä¸åˆè§„æœ€ä½³å®è·µ

### 7.1. è®¿é—®æ§åˆ¶

**è®¿é—®æ§åˆ¶æœ€ä½³å®è·µ**ï¼š

```sql
-- âœ… åˆ›å»ºè§’è‰²å’Œæƒé™
-- 1. åˆ›å»ºåªè¯»è§’è‰²
CREATE ROLE read_only_user;
GRANT CONNECT ON DATABASE mydb TO read_only_user;
GRANT USAGE ON SCHEMA public TO read_only_user;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO read_only_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO read_only_user;

-- 2. åˆ›å»ºåº”ç”¨è§’è‰²
CREATE ROLE app_user;
GRANT CONNECT ON DATABASE mydb TO app_user;
GRANT USAGE ON SCHEMA public TO app_user;
GRANT SELECT, INSERT, UPDATE ON ALL TABLES IN SCHEMA public TO app_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public
    GRANT SELECT, INSERT, UPDATE ON TABLES TO app_user;

-- 3. åˆ›å»ºç”¨æˆ·å¹¶åˆ†é…è§’è‰²
CREATE USER app_user_1 WITH PASSWORD 'secure_password';
GRANT app_user TO app_user_1;
```

### 7.2. æ•°æ®åŠ å¯†

**æ•°æ®åŠ å¯†æœ€ä½³å®è·µ**ï¼š

```sql
-- âœ… ä½¿ç”¨pgcryptoæ‰©å±•åŠ å¯†æ•æ„Ÿæ•°æ®
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- åŠ å¯†å­˜å‚¨
CREATE TABLE users (
    user_id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL,
    password_hash TEXT NOT NULL,  -- ä½¿ç”¨bcryptå“ˆå¸Œ
    credit_card_encrypted BYTEA,  -- åŠ å¯†å­˜å‚¨ä¿¡ç”¨å¡å·
    ssn_encrypted BYTEA  -- åŠ å¯†å­˜å‚¨SSN
);

-- åŠ å¯†å‡½æ•°
CREATE OR REPLACE FUNCTION encrypt_sensitive_data(data TEXT, key TEXT)
RETURNS BYTEA AS $$
BEGIN
    RETURN pgp_sym_encrypt(data, key);
END;
$$ LANGUAGE plpgsql;

-- è§£å¯†å‡½æ•°
CREATE OR REPLACE FUNCTION decrypt_sensitive_data(encrypted_data BYTEA, key TEXT)
RETURNS TEXT AS $$
BEGIN
    RETURN pgp_sym_decrypt(encrypted_data, key);
END;
$$ LANGUAGE plpgsql;
```

---

## 8. 2024-2025æœ€ä½³å®è·µè¶‹åŠ¿

### 8.1. æ•°æ®åº“è®¾è®¡å®è·µæ¼”è¿›

```mermaid
timeline
    title æ•°æ®åº“è®¾è®¡å®è·µæ¼”è¿›
    2010 : ä¼ ç»ŸèŒƒå¼è®¾è®¡
         : å•ä½“åº”ç”¨
    2015 : NoSQLå…´èµ·
         : åˆ†å¸ƒå¼è®¾è®¡
    2018 : å¾®æœåŠ¡æ•°æ®åº“
         : Database per Service
    2022 : å¤šæ¨¡æ€æ•°æ®åº“
         : PostgreSQLæ‰©å±•
    2024 : AIåŸç”Ÿè®¾è®¡
         : å‘é‡ä¼˜å…ˆ
    2025 : è‡ªé€‚åº”è®¾è®¡
         : æ™ºèƒ½ä¼˜åŒ–
```

### 8.2. æœ€ä½³å®è·µä¼˜å…ˆçº§çŸ©é˜µ

| å®è·µé¢†åŸŸ | é‡è¦æ€§ | ç´§è¿«æ€§ | æŠ•èµ„å›æŠ¥ | 2025ä¼˜å…ˆçº§ |
|---------|--------|--------|---------|-----------|
| **å‘é‡ç´¢å¼•** | é«˜ | é«˜ | é«˜ | P0 |
| **å¤šç§Ÿæˆ·RLS** | é«˜ | ä¸­ | é«˜ | P0 |
| **JSONBä¼˜åŒ–** | ä¸­ | ä¸­ | ä¸­ | P1 |
| **åˆ†åŒºç­–ç•¥** | é«˜ | ä¸­ | é«˜ | P1 |
| **CDCå®ç°** | ä¸­ | ä½ | ä¸­ | P2 |

### 8.3. ç°ä»£PostgreSQLæœ€ä½³å®è·µ

```sql
-- 2025 PostgreSQLæœ€ä½³å®è·µç¤ºä¾‹

-- 1. å‘é‡+å…¨æ–‡æ··åˆç´¢å¼•
CREATE TABLE modern_docs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    content TEXT NOT NULL,
    content_tsv tsvector GENERATED ALWAYS AS (to_tsvector('english', content)) STORED,
    embedding vector(1536),
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_docs_fts ON modern_docs USING gin (content_tsv);
CREATE INDEX idx_docs_vec ON modern_docs USING ivfflat (embedding vector_cosine_ops);
CREATE INDEX idx_docs_meta ON modern_docs USING gin (metadata jsonb_path_ops);

-- 2. å£°æ˜å¼åˆ†åŒº+è‡ªåŠ¨ç®¡ç†
CREATE TABLE events (
    id BIGSERIAL,
    event_type VARCHAR(50),
    payload JSONB,
    created_at TIMESTAMPTZ NOT NULL
) PARTITION BY RANGE (created_at);

-- è‡ªåŠ¨åˆ†åŒºç®¡ç†æ‰©å±•
SELECT create_parent('public.events', 'created_at', 'native', 'monthly');

-- 3. è¡Œçº§å®‰å…¨+å®¡è®¡
ALTER TABLE modern_docs ENABLE ROW LEVEL SECURITY;

CREATE POLICY tenant_isolation ON modern_docs
    USING (metadata->>'tenant_id' = current_setting('app.tenant_id'));

-- 4. é«˜çº§çº¦æŸ
ALTER TABLE modern_docs ADD CONSTRAINT check_embedding_dim
    CHECK (array_length(embedding::real[], 1) = 1536);
```

### 8.4. äº‘åŸç”Ÿæ•°æ®åº“æœ€ä½³å®è·µ

```mermaid
flowchart TB
    subgraph åº”ç”¨å±‚
        A1[å¾®æœåŠ¡A]
        A2[å¾®æœåŠ¡B]
        A3[å¾®æœåŠ¡C]
    end

    subgraph æ•°æ®å±‚
        D1[(PostgreSQL<br/>Primary)]
        D2[(Read Replica)]
        D3[(Read Replica)]
    end

    subgraph ç¼“å­˜å±‚
        C1[Redis Cluster]
    end

    subgraph å­˜å‚¨å±‚
        S1[S3/å¯¹è±¡å­˜å‚¨]
    end

    A1 --> C1
    A2 --> C1
    A3 --> C1
    C1 --> D1
    D1 --> D2
    D1 --> D3
    A1 -->|è¯»| D2
    A2 -->|è¯»| D3
    D1 --> S1
```

---

## 9. å‚è€ƒèµ„æ–™

### 9.1. æƒå¨æ–‡çŒ®

**æ•°æ®åº“è®¾è®¡**ï¼š

- Kleppmann, M. "Designing Data-Intensive Applications"
- PostgreSQL Global Development Group "PostgreSQL Documentation"

### 9.2. åœ¨çº¿èµ„æº

| èµ„æº | URL | æè¿° |
|------|-----|------|
| **PostgreSQL Wiki** | <https://wiki.postgresql.org/> | ç¤¾åŒºçŸ¥è¯† |
| **Use The Index, Luke** | <https://use-the-index-luke.com/> | ç´¢å¼•æŒ‡å— |
| **pganalyze** | <https://pganalyze.com/docs> | æ€§èƒ½åˆ†æ |

### 9.3. ç›¸å…³æ–‡æ¡£

- [07.01-Schemaè®¾è®¡æ–¹æ³•è®º](./07.01-Schemaè®¾è®¡æ–¹æ³•è®º.md)
- [07.06-æ•°æ®åº“è®¾è®¡åæ¨¡å¼ä¸è§£å†³æ–¹æ¡ˆ](./07.06-æ•°æ®åº“è®¾è®¡åæ¨¡å¼ä¸è§£å†³æ–¹æ¡ˆ.md)
- [07.08-æ•°æ®åº“æ€§èƒ½è°ƒä¼˜å®æˆ˜](./07.08-æ•°æ®åº“æ€§èƒ½è°ƒä¼˜å®æˆ˜.md)

---

**æœ€åæ›´æ–°**ï¼š2025-12-01
**ç»´æŠ¤è€…**ï¼šData-Science Team
**çŠ¶æ€**ï¼šå·²å®Œæˆ âœ…
**ç‰ˆæœ¬**ï¼šv2.0 (å¢å¼ºç‰ˆ)
