# 07 实践指南（落地清单）

> **最后更新**：2025年11月11日
> **版本覆盖**：PostgreSQL 17+ | PostgreSQL 18
> **面向企业/团队的执行化清单**

---

## 📋 目录

- [07 实践指南（落地清单）](#07-实践指南落地清单)
  - [📋 目录](#-目录)
  - [一、基础能力启用](#一基础能力启用)
  - [二、数据与建模](#二数据与建模)
  - [三、SLO 与自治](#三slo-与自治)
  - [四、合规与审计](#四合规与审计)
  - [五、评估与优化](#五评估与优化)
  - [六、一次性决策](#六一次性决策)
  - [七、标准作业（SOP）](#七标准作业sop)
  - [八、合规护栏](#八合规护栏)
  - [九、模板与示例](#九模板与示例)
    - [指标看板字段](#指标看板字段)
    - [变更票据模板](#变更票据模板)
  - [📚 参考文档](#-参考文档)
    - [主题文档](#主题文档)
    - [快速开始指南](#快速开始指南)

---

## 一、基础能力启用

1. **启用 pgvector 扩展**
   - 安装 pgvector 扩展
   - 配置连接池（PgBouncer 或应用层连接池）
   - 完成最小可用语义检索功能验证

2. **评估 Serverless 使用场景**
   - 评估是否需要常驻连接
   - 评估是否需要预热策略
   - 确定分支数量上限和生命周期策略

3. **PostgreSQL 18 特性启用**
   - 启用异步 I/O 子系统（自动启用）
   - 使用虚拟生成列优化查询
   - 配置 UUID v7 函数（如适用）

---

## 二、数据与建模

1. **统一业务实体设计**
   - 主表：结构化字段 + JSONB 扩展字段
   - 时序侧表：以设备/用户为分区键，与主表共享标识符
   - 向量表：对文本/图像/日志嵌入，存储向量与源主键
   - 图侧：高价值关系抽取为图边与点

2. **明确 Embedding 策略**
   - 确定模型版本（如 text-embedding-ada-002、all-MiniLM-L6-v2）
   - 确定向量维度（384/768/1536）
   - 设计索引策略（HNSW/IVFFlat/SP-GiST）
   - 设计精排流程（RRF 融合参数）

3. **共分区/共簇策略**
   - 时序表和向量表使用同分区键共簇存
   - 为混合查询设计复合索引
   - 明确冷热数据分层策略

---

## 三、SLO 与自治

1. **建立 SLI/SLO 指标体系**
   - **延迟指标**：P50/95/99 延迟目标
   - **吞吐指标**：QPS、TPS 目标
   - **成本指标**：存储成本、计算成本目标
   - **可用性指标**：99.9% / 99.99% 可用性目标

2. **导入自治工具输出到变更闭环**
   - 将 AI 优化建议转化为变更票据
   - 设计回滚策略和验证脚本
   - 建立变更追踪和审计机制

3. **PostgreSQL 18 AI 自治配置**
   - 评估 pg_ai 插件可用性（云托管版本）
   - 配置自动索引推荐阈值
   - 设置预测式缓存预热策略

---

## 四、合规与审计

1. **数据分级分域**
   - 定义数据分类标准（public/internal/sensitive/highly_sensitive）
   - 设置主权标签（ROW LABEL）
   - 配置 RLS 策略（按角色/地域/数据域）
   - 实现跨境数据拦截机制

2. **审计全链路**
   - **DB 审计**：启用 pgAudit 扩展
   - **应用审计**：记录应用层操作日志
   - **外部存证**：可选的外部审计系统集成
   - 定义审计日志保留与访问策略

3. **数据脱敏策略**
   - 列级脱敏：敏感字段掩码规则
   - 行级脱敏：基于 RLS 的敏感行过滤
   - 动态脱敏：根据用户角色动态调整

---

## 五、评估与优化

1. **基准与压测**
   - 混合负载压测（向量/全文/图/时序）
   - 评估各场景下的性能指标
   - 建立性能基线

2. **成本优化**
   - **冷热分层**：热数据保留在主库，冷数据归档
   - **只读副本**：为读多写少场景配置只读副本
   - **归档与压缩**：定期归档历史数据，启用压缩

3. **PostgreSQL 18 性能优化**
   - 利用异步 I/O 自动优化
   - 使用虚拟生成列减少计算开销
   - 优化多列索引的跳过扫描

---

## 六、一次性决策

1. **知识库/检索类型选择**
   - 纯向量检索 vs 混合检索（BM25 + 向量/RRF）
   - 根据业务场景选择合适方案

2. **部署形态选择**
   - 自建 vs 托管（评估 Serverless/Branching 价值）
   - 评估成本、运维复杂度、扩展性

3. **多模一体化规划**
   - 是否引入 Timescale（时序）
   - 是否引入 Apache AGE（图）
   - 如何规划分区与索引策略

---

## 七、标准作业（SOP）

1. **向量表结构与索引参数模板**

   ```sql
   -- HNSW 索引模板
   CREATE INDEX idx_<table>_hnsw ON <table>
   USING hnsw (embedding vector_cosine_ops)
   WITH (m = 16, ef_construction = 64);

   -- IVFFlat 索引模板（大数据集）
   CREATE INDEX idx_<table>_ivf ON <table>
   USING ivfflat (embedding vector_cosine_ops)
   WITH (lists = 100);
   ```

2. **混合搜索 SQL 模板**
   - 向量检索 + 全文检索
   - RRF 融合函数
   - 二阶段检索（候选召回 + 精排）

3. **观测与诊断**
   - **pg_stat_statements**：查询性能统计
   - **auto_explain**：自动执行计划分析
   - **采样与指标**：定期采样性能指标

4. **变更闭环**
   - 变更票据模板
   - 验证用例设计
   - 回退策略定义

---

## 八、合规护栏

1. **RLS 策略模板**
   - 按角色/地域/数据域的 RLS 策略模板
   - 策略版本管理
   - 策略测试用例

2. **审计留痕**
   - 接入外部审计/日志系统
   - 定义保留与访问策略
   - 不可篡改日志实现

3. **数据主权管理**
   - 行级主权标签（ROW LABEL）
   - 自动跨境数据拦截
   - 数据保留策略

---

## 九、模板与示例

### 指标看板字段

| 指标类型 | 字段名称 | 说明 |
|---------|---------|------|
| **延迟** | `p50_latency` | 50% 请求延迟 |
| | `p95_latency` | 95% 请求延迟 |
| | `p99_latency` | 99% 请求延迟 |
| **吞吐** | `qps` | 每秒查询数 |
| | `tps` | 每秒事务数 |
| **错误率** | `error_rate` | 错误请求比例 |
| **缓存** | `cache_hit_rate` | 缓存命中率 |
| **索引** | `index_health` | 索引健康度 |

### 变更票据模板

```yaml
变更票据:
  ticket_id: <自动生成>
  optimization_type: index | statistics | plan | cache
  recommendation_sql: <优化建议 SQL>
  estimated_benefit: <预计收益比例>
  status: pending | approved | applied | rolled_back
  impact_scope: <影响范围>
  rollback_sql: <回滚 SQL>
  validation_script: <验证脚本>
  owner: <负责人>
  created_at: <创建时间>
  applied_at: <应用时间>
```

---

## 📚 参考文档

### 主题文档

- [`./01-向量与混合搜索-pgvector与RRF.md`](./01-向量与混合搜索-pgvector与RRF.md) - 向量检索与混合搜索实现
- [`./02-AI自治与自优化.md`](./02-AI自治与自优化.md) - AI 自治能力配置
- [`./03-Serverless与分支-Neon与Supabase.md`](./03-Serverless与分支-Neon与Supabase.md) - Serverless 与分支管理
- [`./04-多模一体化-JSONB时序图向量.md`](./04-多模一体化-JSONB时序图向量.md) - 多模态数据模型设计
- [`./05-合规与可信-AI Act与审计.md`](./05-合规与可信-AI Act与审计.md) - 合规与审计实现
- [`./06-落地案例-2025精选.md`](./06-落地案例-2025精选.md) - 真实案例参考

### 快速开始指南

1. **30 分钟快速开始**
   - 安装 PostgreSQL 18
   - 启用 pgvector 扩展
   - 创建第一个向量表
   - 实现基础语义搜索

2. **架构设计检查清单**
   - [ ] 数据模型设计（结构化 + JSONB + 向量）
   - [ ] 索引策略选择（HNSW/IVFFlat）
   - [ ] 混合搜索方案（RRF 参数）
   - [ ] 性能目标定义（SLO）
   - [ ] 合规策略设计（RLS/审计）

3. **性能调优检查清单**
   - [ ] 索引参数调优
   - [ ] 查询优化（EXPLAIN ANALYZE）
   - [ ] 连接池配置
   - [ ] 缓存策略
   - [ ] 监控指标设置

4. **合规检查清单**
   - [ ] 数据分类分级
   - [ ] RLS 策略配置
   - [ ] 审计日志启用
   - [ ] 数据脱敏实现
   - [ ] 合规测试用例

---

**文档版本**：v2.0 (2025-11-11)
**维护者**：Data-Science 项目组
**更新频率**：每月更新，重大版本发布时即时更新
