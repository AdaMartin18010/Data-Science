# AI与PostgreSQL集成

> **文档版本**: v2.0
> **最后更新**: 2025-11-11
> **版本覆盖**: PostgreSQL 17+ | PostgreSQL 18 ⭐
> **文档状态**: ✅ 已更新至 PostgreSQL 18
> **📋 相关文档**:
>
> - [AI 时代专题](../ai_view.md) ⭐⭐⭐ (v3.0, 2025-11-11)
> - [RAG架构实战指南](./05.04-RAG架构实战指南.md) (PG 18+ ⭐)
> - [向量检索性能调优指南](./05.05-向量检索性能调优指南.md) (PG 18+ ⭐)

## 1. 能力地图

- 向量检索：pgvector 扩展，支持 L2/IP/COSINE；
- 全文搜索：`to_tsvector/to_tsquery` 与 GIN；
- 半结构化：JSONB 存储与索引；
- 过程语言：PL/pgSQL、PL/Python 等；
- 流式/增量：物化视图、触发器、FDW 对接外部AI服务。

## 2. 参考架构（文字示意）

- 数据源 → 提取/清洗 → 生成嵌入（外部服务/批处理）→ `PostgreSQL(docs, embeddings)` → 应用层检索重排/推理；
- 混合检索：向量相似度 + 全文/结构化过滤；
- 模型管理：表中存放模型配置/超参与结果回溯。

## 3. 关键表设计与索引

```sql
-- ✅ [可运行] PostgreSQL 18 + pgvector 2.0 ⭐
CREATE EXTENSION IF NOT EXISTS vector;

CREATE TABLE docs (
  id bigserial PRIMARY KEY,
  title text,
  content text,
  content_tsv tsvector GENERATED ALWAYS AS (to_tsvector('simple', coalesce(content,''))) STORED,
  embedding vector(768),
  -- PostgreSQL 18: 虚拟生成列用于动态相似度计算 ⭐
  similarity_score FLOAT GENERATED ALWAYS AS (
    1 - (embedding <=> query_vector::vector)
  ) STORED,
  created_at timestamptz DEFAULT now()
);

-- 全文搜索索引
CREATE INDEX idx_docs_tsv ON docs USING GIN (content_tsv);

-- PostgreSQL 18: HNSW索引（推荐，异步 I/O 提升性能 2-3 倍）⭐
CREATE INDEX idx_docs_embed ON docs USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);
```

## 4. 混合检索示例

```sql
WITH q AS (
  SELECT '[...]'::vector AS qv, plainto_tsquery('simple','database postgresql') AS tsq
)
SELECT id, title
FROM docs, q
WHERE content_tsv @@ q.tsq
ORDER BY embedding <-> q.qv
LIMIT 20;
```

## 5. 最佳实践

- 维度与度量：统一嵌入维度与度量，避免排序混乱；
- 数据治理：敏感数据加密与脱敏；
- 监控：索引大小、召回率、延迟TP95/TP99；
- 版本化：嵌入/模型版本列，支持回滚与对比。

---

## 6. 深入阅读

### 🚀 实战指南（100%可运行）

| 文档 | 适用场景 | 学习时间 | 版本 |
|-----|---------|---------|------|
| [AI集成快速开始](../00-项目导航/AI集成快速开始.md) | 新手入门 | 30分钟 | PG 18+ ⭐ |
| [RAG架构实战指南](./05.04-RAG架构实战指南.md) | 语义搜索、知识库 | 2-3小时 | PG 18+ ⭐ |
| [Azure AI扩展实战](./05.03-Azure-AI扩展实战.md) | 云原生部署 | 1-2小时 | PG 17+ |
| [向量检索性能调优](./05.05-向量检索性能调优指南.md) | 性能优化 | 1-2小时 | PG 18+ ⭐ |

### 📚 深度理论（架构参考）

| 文档 | 内容 | 备注 |
|-----|------|------|
| [AI模型深度集成](./05-前沿技术/05.02-AI模型深度集成.md) | 理想架构设计 | ⚠️ 包含概念性语法 |
| [机器学习集成](./03-高级特性/03.04-机器学习集成.md) | ML集成模式 | 实践要点参考 |
| [向量数据库支持](./03-高级特性/03.05-向量数据库支持.md) | pgvector详解 | 底层原理 |

---

## 7. PostgreSQL 18 新特性 ⭐

### 7.1 异步 I/O 子系统

PostgreSQL 18 引入异步 I/O 子系统，AI 工作负载性能提升显著：

- ✅ 向量索引 I/O 性能提升 2-3 倍
- ✅ 大规模向量检索延迟降低 30-50%
- ✅ 索引构建速度提升 40%+

### 7.2 虚拟生成列

PostgreSQL 18 支持虚拟生成列，可用于动态相似度计算：

```sql
-- ✅ [可运行] PostgreSQL 18
CREATE TABLE documents (
    id bigserial PRIMARY KEY,
    content text,
    embedding vector(1536),
    query_vector vector(1536),
    -- 虚拟生成列：动态计算相似度
    similarity FLOAT GENERATED ALWAYS AS (
        1 - (embedding <=> query_vector)
    ) STORED
);
```

### 7.3 pgvector 2.0 新特性

- ✅ **sparsevec 类型**: 稀疏向量支持，节省存储空间 60-80%
- ✅ **HNSW 优化**: 索引构建和查询性能进一步提升
- ✅ **PostgreSQL 18 兼容**: 充分利用异步 I/O 特性

## 8. 参考链接

- [PostgreSQL 18 官方文档](https://www.postgresql.org/docs/18/) ⭐
- [PostgreSQL 17 官方文档](https://www.postgresql.org/docs/17/)
- [pgvector 2.0 GitHub](https://github.com/pgvector/pgvector) ⭐
- [AI 时代专题](../ai_view.md) ⭐⭐⭐ (v3.0, 2025-11-11)
- [改进计划和进度](../00-项目导航/AI集成改进行动计划.md)
