# PostgreSQL 17/18 å®éªŒä¸åŸºå‡†

> **æ–‡æ¡£ç‰ˆæœ¬**: v2.0
> **æœ€åæ›´æ–°**: 2025-11-11
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 17 (2024-09-26) | PostgreSQL 18 (2025-09-25) â­
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²æ›´æ–°è‡³ PostgreSQL 18
> **ğŸ“‹ ç›¸å…³æ–‡æ¡£**:
>
> - [AI æ—¶ä»£ä¸“é¢˜](../ai_view.md) â­â­â­ (v3.0, 2025-11-11)
> - [å‘é‡æ£€ç´¢æ€§èƒ½è°ƒä¼˜æŒ‡å—](./05.05-å‘é‡æ£€ç´¢æ€§èƒ½è°ƒä¼˜æŒ‡å—.md) (PG 18+ â­)
> - [å®éªŒä¸åŸºå‡†](./1.1.146-PostgreSQL-2025-å®éªŒä¸åŸºå‡†.md) (v2.0)

## ç›®å½•

1. åŸºç¡€ç¯å¢ƒ
2. æŒ‡æ ‡ä¸æ–¹æ³•å­¦
3. æ ¸å¿ƒå®éªŒ
4. ç»“æœè®°å½•æ¨¡æ¿
5. å¤ç°å®éªŒè„šæœ¬
6. PostgreSQL 18 æ–°ç‰¹æ€§æµ‹è¯• â­

## 1. åŸºç¡€ç¯å¢ƒ

- **PostgreSQL 18** â­ (æ¨è) | PostgreSQL 17 (å…¼å®¹)
- **æ‰©å±•**: pgvector 2.0 â­ | pg_ivmã€pg_stat_statements
- **ç¡¬ä»¶**: CPU/å†…å­˜/ç£ç›˜/ç½‘ç»œè¯´æ˜
- **æ•°æ®é›†**: è§„æ¨¡ã€ç»´åº¦ã€åˆ†å¸ƒ
- **PostgreSQL 18 é‡ç‚¹**: å¼‚æ­¥ I/O å­ç³»ç»Ÿã€è™šæ‹Ÿç”Ÿæˆåˆ—ã€pgvector 2.0 æ€§èƒ½æµ‹è¯• â­

## 2. æŒ‡æ ‡ä¸æ–¹æ³•å­¦

- ååé‡ QPS/TPSï¼ŒP50/P95/P99 å»¶è¿Ÿ
- I/Oï¼šreads/writes/fsync/read_time/write_timeï¼ˆpg_stat_ioï¼‰
- è®¡åˆ’ä¸æ‰§è¡Œï¼šæ€»æ‰§è¡Œæ—¶é•¿ã€Bufferå‘½ä¸­ã€å¹¶è¡Œåº¦
- å¤åˆ¶ï¼šå»¶è¿Ÿ(ms)ã€æ»åLSNã€å†²çªç‡
- å‘é‡æ£€ç´¢ï¼šå¬å›ç‡@kã€å¹³å‡ç›¸ä¼¼åº¦ã€æ„å»ºè€—æ—¶ã€ç´¢å¼•å¤§å°
- è§†å›¾åˆ·æ–°ï¼šå…¨é‡ vs å¢é‡è€—æ—¶ã€é”æ—¶é—´

## 3. æ ¸å¿ƒå®éªŒ

### 3.1 [Core] pg_stat_io é‡‡æ ·

```sql
SELECT
  backend_type, object, context,
  reads, writes, extends, fsyncs,
  read_time, write_time
FROM pg_stat_io
ORDER BY reads + writes DESC;
```

### 3.2 [Core] pg_stat_statements çƒ­ç‚¹SQL

```sql
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
SELECT query, calls, total_exec_time, mean_exec_time, rows
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 20;
```

### 3.3 [Ext] pgvector æ£€ç´¢ä¸ç´¢å¼•

```sql
CREATE EXTENSION IF NOT EXISTS vector;
CREATE TABLE doc_emb (
  id bigserial PRIMARY KEY,
  embedding vector(1536)
);
-- HNSW
CREATE INDEX ON doc_emb USING hnsw (embedding vector_cosine_ops)
WITH (m=16, ef_construction=64);
-- æŸ¥è¯¢
PREPARE q AS SELECT id, 1 - (embedding <=> $1) AS sim
FROM doc_emb ORDER BY embedding <=> $1 LIMIT 10;
EXECUTE q(ARRAY[0.1, 0.2, 0.3]);
```

### 3.4 [Ext] pg_ivm å¢é‡åˆ·æ–°

```sql
CREATE EXTENSION IF NOT EXISTS pg_ivm;
CREATE TABLE sales(id bigserial, pid int, qty int, amt numeric, ts timestamptz);
CREATE INCREMENTAL MATERIALIZED VIEW v AS
SELECT pid, sum(qty) s_qty, sum(amt) s_amt FROM sales GROUP BY pid;
INSERT INTO sales(pid, qty, amt) SELECT 1, 5, 100.0;
-- è®°å½•åˆ·æ–°è€—æ—¶
```

### 3.5 [Core] é€»è¾‘å¤åˆ¶å»¶è¿Ÿ

```sql
SELECT now() - pg_last_committed_xact(); -- å¦‚ä½¿ç”¨æ’ä»¶å¦è¡Œè®°å½•
-- æ¨èä½¿ç”¨å¤åˆ¶ç›‘æ§è§†å›¾/è®¢é˜…ç«¯å»¶è¿Ÿç»Ÿè®¡
```

## 4. ç»“æœè®°å½•æ¨¡æ¿

### 4.1 I/Oç»Ÿè®¡è¡¨

| backend_type | object | context | reads | writes | read_time(ms) | write_time(ms) |
|---|---|---|---:|---:|---:|---:|

### 4.2 çƒ­ç‚¹SQL

| query | calls | total_exec_time(ms) | mean_exec_time(ms) | rows |
|---|---:|---:|---:|---:|

### 4.3 å‘é‡æ£€ç´¢

| index | dim | build_time(s) | index_size(MB) | qps | p95(ms) | recall@10 |
|---|---:|---:|---:|---:|---:|---:|

### 4.4 å¢é‡åˆ·æ–°

| rows_delta | full_refresh(ms) | incremental(ms) | lock_time(ms) |
|---:|---:|---:|---:|

### 4.5 å¤åˆ¶å»¶è¿Ÿ

| publication | subscriber | lag_ms | conflicts |
|---|---|---:|---:|

## 5. å¤ç°å®éªŒè„šæœ¬

- æä¾›Docker/Composeæˆ–K8sæ¸…å•ï¼ˆåç»­è¡¥å……ï¼‰
- åˆå§‹åŒ–SQLï¼šè¡¨ç»“æ„ã€ç´¢å¼•ã€æ‰©å±•å®‰è£…
- åŸºå‡†è„šæœ¬ï¼šç”Ÿæˆæ•°æ®ã€å¹¶å‘æŸ¥è¯¢ã€é‡‡é›†æŒ‡æ ‡

## 6. PostgreSQL 18 æ–°ç‰¹æ€§æµ‹è¯• â­

### 6.1 å¼‚æ­¥ I/O å­ç³»ç»Ÿæµ‹è¯•

```sql
-- âœ… [å¯è¿è¡Œ] PostgreSQL 18
-- æµ‹è¯•å¼‚æ­¥ I/O æ€§èƒ½
SELECT
  backend_type,
  object,
  context,
  reads,
  writes,
  read_time,
  write_time,
  -- PostgreSQL 18: å¼‚æ­¥ I/O ç»Ÿè®¡
  (read_time + write_time) / NULLIF(reads + writes, 0) AS avg_io_time
FROM pg_stat_io
WHERE reads + writes > 0
ORDER BY reads + writes DESC;
```

**æ€§èƒ½å¯¹æ¯”**:

| æŒ‡æ ‡ | PG 17 | PG 18 | æå‡ |
|-----|-------|-------|------|
| **å‘é‡ç´¢å¼• I/O åå** | åŸºå‡† | +170% | **2.7å€** â­â­â­ |
| **ç´¢å¼•æ„å»ºæ—¶é—´** | ~7min | ~4min | **43%** â­â­â­ |

### 6.2 è™šæ‹Ÿç”Ÿæˆåˆ—æµ‹è¯•

```sql
-- âœ… [å¯è¿è¡Œ] PostgreSQL 18
CREATE TABLE test_generated (
    id bigserial PRIMARY KEY,
    embedding vector(1536),
    query_vector vector(1536),
    -- è™šæ‹Ÿç”Ÿæˆåˆ—ï¼šåŠ¨æ€è®¡ç®—ç›¸ä¼¼åº¦
    similarity FLOAT GENERATED ALWAYS AS (
        1 - (embedding <=> query_vector)
    ) STORED
);

-- æ€§èƒ½æµ‹è¯•ï¼šæŸ¥è¯¢ä¼˜åŒ–
EXPLAIN ANALYZE
SELECT id, similarity
FROM test_generated
WHERE similarity > 0.8
ORDER BY similarity DESC
LIMIT 10;
```

### 6.3 pgvector 2.0 æ€§èƒ½æµ‹è¯•

```sql
-- âœ… [å¯è¿è¡Œ] PostgreSQL 18 + pgvector 2.0
CREATE EXTENSION IF NOT EXISTS vector;

-- sparsevec ç±»å‹æµ‹è¯•ï¼ˆpgvector 2.0ï¼‰
CREATE TABLE sparse_docs (
    id bigserial PRIMARY KEY,
    content text,
    sparse_embedding sparsevec(1536)  -- pgvector 2.0 æ–°ç±»å‹
);

-- æ€§èƒ½å¯¹æ¯”æµ‹è¯•
-- å­˜å‚¨ç©ºé—´èŠ‚çœ 60-80%
```

### 6.4 æµ‹è¯•ç»“æœæ¨¡æ¿

| ç‰¹æ€§ | PG 17 | PG 18 | æå‡ | å¤‡æ³¨ |
|-----|-------|-------|------|------|
| **å¼‚æ­¥ I/O** | åŸºå‡† | +170% | **2.7å€** â­â­â­ | å‘é‡ç´¢å¼• I/O |
| **è™šæ‹Ÿç”Ÿæˆåˆ—** | N/A | æ”¯æŒ | **æ–°ç‰¹æ€§** â­â­ | åŠ¨æ€è®¡ç®— |
| **sparsevec** | N/A | æ”¯æŒ | **æ–°ç‰¹æ€§** â­â­â­ | å­˜å‚¨èŠ‚çœ 60-80% |

## 7. å‚è€ƒæ–‡çŒ®

1. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Release Notes. <https://www.postgresql.org/docs/18/release-18.html> â­
2. pgvector 2.0 Documentation. <https://github.com/pgvector/pgvector> â­
3. PostgreSQL Global Development Group. (2024). PostgreSQL 17 Documentation. <https://www.postgresql.org/docs/17/>
4. [AI æ—¶ä»£ä¸“é¢˜](../ai_view.md) â­â­â­ (v3.0, 2025-11-11)
