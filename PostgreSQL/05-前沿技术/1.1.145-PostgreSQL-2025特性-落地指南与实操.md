# PostgreSQL 17/18 ç‰¹æ€§è½åœ°æŒ‡å—ä¸å®æ“

> **æ–‡æ¡£ç‰ˆæœ¬**: v2.0
> **æœ€åæ›´æ–°**: 2025-11-11
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 17 (2024-09-26) | PostgreSQL 18 (2025-09-25) â­
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²æ›´æ–°è‡³ PostgreSQL 18

> **ğŸ“‹ ç›¸å…³æ–‡æ¡£**:
> - [AI æ—¶ä»£ä¸“é¢˜](../ai_view.md) â­â­â­ (v3.0, 2025-11-11)
> - [PostgreSQL 17/18 æœ€æ–°ç‰¹æ€§å…¨é¢åˆ†æ](./1.1.21-PostgreSQL-2025æœ€æ–°ç‰¹æ€§å…¨é¢åˆ†æ.md) (v2.0)

[English](../../en-US/1-database-systems/1.1-postgresql/1.1.145-postgresql-2025-features-deployment-guide-and-operations.md)

## 1. åœºæ™¯æ¦‚è¿°ä¸é€‚é…è¯„ä¼°

- ç›®æ ‡ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒå®‰å…¨å¯ç”¨ 2025 æ–°ç‰¹æ€§ï¼ˆAI åŸç”Ÿã€å‘é‡å¢å¼ºã€æµå¤„ç†ã€å¤šæ¨¡æ€ã€äº‘åŸç”Ÿï¼‰ã€‚
- é€‚é…è¯„ä¼°ï¼š
  - ç¡¬ä»¶ï¼šCPU AVX2/AVX512ï¼ŒGPU å¯é€‰ï¼ˆCUDA/ROCmï¼‰ï¼ŒNVMe SSD ä¼˜å…ˆã€‚
  - ç³»ç»Ÿï¼šLinux Kernel >= 5.15ï¼ŒK8s >= 1.28ï¼ˆäº‘åŸç”Ÿæ–¹æ¡ˆï¼‰ã€‚
  - æ•°æ®è§„æ¨¡ï¼šè¡Œæ•° â‰¥ 10^8 æ—¶å»ºè®®åˆ†åŒº+å‹ç¼©ï¼Œå‘é‡åº“ä½¿ç”¨ HNSW/IVF å¤åˆç´¢å¼•ã€‚

## 2. å®‰è£…ä¸éƒ¨ç½²

### 2.1 äºŒè¿›åˆ¶/å®¹å™¨

- å®¹å™¨é•œåƒï¼š`postgresql:2025`
- åŸºç¡€å‘½ä»¤ï¼š

```bash
# Dockerï¼ˆå•æœº PoCï¼‰
docker run -d --name pg2025 -p 5432:5432 \
  -e POSTGRES_PASSWORD=postgres \
  -v $PWD/pgdata:/var/lib/postgresql/data \
  -v $PWD/models:/models \
  postgresql:2025
```

### 2.2 Kubernetesï¼ˆç”Ÿäº§é›†ç¾¤ï¼‰

- æ¨èï¼šStatefulSet + ReadOnlyMany å­˜å‚¨ï¼ˆå¯¹è±¡å­˜å‚¨æŒ‚è½½æ¨¡å‹ä»“åº“ï¼‰ã€‚
- å…³é”®å‚æ•°ï¼šèµ„æº QoSã€äº²å’Œæ€§ã€PodDisruptionBudgetã€PodAntiAffinityã€‚

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgresql-cluster
spec:
  serviceName: postgresql
  replicas: 3
  selector:
    matchLabels:
      app: postgresql
  template:
    metadata:
      labels:
        app: postgresql
    spec:
      containers:
      - name: postgresql
        image: postgresql:2025
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_DB
          value: "datascience"
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgresql-secret
              key: password
        volumeMounts:
        - name: postgresql-data
          mountPath: /var/lib/postgresql/data
        - name: ai-models
          mountPath: /models
  volumeClaimTemplates:
  - metadata:
      name: postgresql-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 200Gi
```

## 3. é…ç½®ä¸æ‰©å±•å¯ç”¨

åœ¨ `postgresql.conf` ä¸­ï¼š

```conf
shared_preload_libraries = 'pg_stat_statements,pgvector,ai_inference,streaming'
max_worker_processes = 64
max_parallel_workers = 32
max_parallel_workers_per_gather = 8
maintenance_work_mem = '2GB'
work_mem = '128MB'
effective_cache_size = '32GB'
```

å¯ç”¨æ‰©å±•ä¸åŸºçº¿å‚æ•°ï¼š

```sql
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
CREATE EXTENSION IF NOT EXISTS vector;
CREATE EXTENSION IF NOT EXISTS ai_inference; -- AI åŸç”Ÿæ¨ç†
CREATE EXTENSION IF NOT EXISTS streaming;    -- åŸç”Ÿæµå¤„ç†

-- AI/å‘é‡é»˜è®¤ç­–ç•¥
SELECT ai_set_option('gpu.enabled', 'auto');
SELECT ai_set_option('model.store', '/models');
SELECT set_config('vector.simd', 'on', false);
```

## 4. å…¸å‹åœºæ™¯å®æ“

### 4.1 å‘é‡æ£€ç´¢ï¼ˆpgvector/HNSWï¼‰

```sql
CREATE TABLE items (
  id BIGSERIAL PRIMARY KEY,
  title TEXT,
  embedding VECTOR(768)
);

-- HNSW ç´¢å¼•
CREATE INDEX idx_items_emb_hnsw ON items
USING hnsw (embedding vector_cosine_ops)
WITH (m=16, ef_construction=200, ef_search=100);

-- æŸ¥è¯¢
WITH q AS (
  SELECT ai_embedding('text_encoder', json_build_object('text', 'æ¨èæ™ºèƒ½æ‰‹è¡¨')) AS emb
)
SELECT i.id, i.title, (1 - (i.embedding <=> q.emb)) AS score
FROM items i, q
ORDER BY i.embedding <=> q.emb
LIMIT 10;
```

### 4.2 AI åŸç”Ÿæ¨ç†ï¼ˆSQL å†…è”ï¼‰

```sql
-- æ¨¡å‹æ³¨å†Œï¼ˆç¤ºä¾‹ï¼‰
CREATE MODEL sentiment_analyzer (
  model_type = 'transformer',
  model_path = '/models/sentiment_v2.pt',
  input_schema = '{"text":"text"}',
  output_schema = '{"sentiment":"float","confidence":"float"}'
);

-- æ¨ç†å‡½æ•°
CREATE OR REPLACE FUNCTION predict_sentiment(txt TEXT)
RETURNS TABLE(sentiment FLOAT, confidence FLOAT)
LANGUAGE plpgsql AS $$
BEGIN
  RETURN QUERY SELECT * FROM ai_inference('sentiment_analyzer', json_build_object('text', txt));
END;$$;

-- ä½¿ç”¨
SELECT * FROM predict_sentiment('è¿™æ¬¾äº§å“éå¸¸å¥½ç”¨');
```

### 4.3 åŸç”Ÿæµå¤„ç†ä¸å®æ—¶çœ‹æ¿

```sql
CREATE STREAM user_events (
  user_id BIGINT,
  event_type TEXT,
  event_data JSONB,
  ts TIMESTAMPTZ
) WITH (
  retention = '7 days',
  watermark = 'ts - INTERVAL ''5 minutes'''
);

CREATE MATERIALIZED VIEW m_window AS
SELECT window_start, window_end, event_type,
       COUNT(*) AS cnt, COUNT(DISTINCT user_id) AS uniq
FROM TABLE(
  TUMBLE(TABLE user_events, DESCRIPTOR(ts), INTERVAL '1 minute')
)
GROUP BY window_start, window_end, event_type;
```

### 4.4 å¤šæ¨¡æ€ç»Ÿä¸€æ£€ç´¢

```sql
CREATE TABLE multimodal_content (
  id BIGSERIAL PRIMARY KEY,
  text_content TEXT,
  text_embedding VECTOR(768),
  image_path TEXT,
  image_embedding VECTOR(512),
  audio_path TEXT,
  audio_embedding VECTOR(256),
  unified_embedding VECTOR(1024)
);

CREATE OR REPLACE FUNCTION search_mm(q TEXT)
RETURNS TABLE(id BIGINT, score FLOAT) LANGUAGE plpgsql AS $$
DECLARE
  q_emb VECTOR(1024);
BEGIN
  q_emb := multimodal_fusion(
    ai_embedding('text_model', json_build_object('text', q)),
    NULL, NULL, NULL
  );
  RETURN QUERY
  SELECT id, (1 - (unified_embedding <=> q_emb)) AS score
  FROM multimodal_content
  ORDER BY unified_embedding <=> q_emb
  LIMIT 20;
END;$$;
```

## 5. æ€§èƒ½åŸºçº¿ä¸è°ƒä¼˜æ¸…å•

- ç´¢å¼•ï¼šæ–‡æœ¬/å‘é‡/ç»„åˆç´¢å¼•ï¼Œå®šæœŸ `REINDEX CONCURRENTLY`ã€‚
- Autovacuumï¼šçƒ­ç‚¹è¡¨æé«˜ `vacuum_cost_limit` ä¸ `autovacuum_vacuum_scale_factor`ã€‚
- å¹¶è¡Œï¼šæ‰«æ/èšåˆå¯ç”¨å¹¶è¡Œï¼Œè§‚å¯Ÿ `max_parallel_workers_per_gather`ã€‚
- I/Oï¼šæ£€æŸ¥ `effective_io_concurrency` ä¸ `checkpoint_timeout`ï¼ˆâ‰¥ 15minï¼‰ã€‚
- è§‚æµ‹ï¼š`pg_stat_statements`ã€è‡ªç ”è§†å›¾ `performance_metrics`ã€‚

## 6. å®‰å…¨ã€åˆè§„ä¸å¤šç§Ÿæˆ·

- RLSï¼šå¤šç§Ÿæˆ·åœºæ™¯å¯ç”¨è¡Œçº§å®‰å…¨ä¸ç­–ç•¥éš”ç¦»ã€‚
- å®¡è®¡ï¼šè®°å½• AI æ¨ç†è¾“å…¥/è¾“å‡ºæ‘˜è¦ä¸è´£ä»»è¿½è¸ªã€‚
- éšç§ï¼šå·®åˆ†éšç§èšåˆã€æœ€å°å¯ç”¨ç‰¹å¾ç­–ç•¥ã€‚

## 7. å…¼å®¹æ€§ä¸å›é€€ç­–ç•¥

- è“ç»¿/é‡‘ä¸é›€ï¼šå¯¹ AI/æµå¤„ç†åŠŸèƒ½åˆ†é˜¶æ®µæ”¾é‡ã€‚
- å¼€å…³ï¼šé€šè¿‡ `ai_set_option('enabled','off')` ä¸ `set_config('vector.simd','off',false)` å¿«é€Ÿé™çº§ã€‚
- æ•°æ®ï¼šå‘é‡åˆ—ä¿ç•™ä¸ºåŸå§‹å‘é‡ä¸æŠ•å½±å‘é‡åŒå†™ï¼Œä¾¿äºå›é€€ã€‚
- å¤‡ä»½ï¼šå¯ç”¨ PITRï¼Œé‡è¦è¿ç§»å‰åšå…¨é‡å¿«ç…§ã€‚

## 8. å‚è€ƒæ¨¡æ¿ä¸è„šæœ¬

- Helm/Kustomize æ¨¡æ¿
- psql å¯åŠ¨è„šæœ¬ä¸åˆå§‹åŒ– `CREATE EXTENSION` æ¸…å•
- æ€§èƒ½é‡‡é›†ä¸åŸºçº¿æ¯”å¯¹è„šæœ¬

> å»ºè®®å…ˆåœ¨å½±å­ç¯å¢ƒè·‘ 24-72 å°æ—¶æµé‡å›æ”¾ï¼Œç¡®è®¤å»¶è¿Ÿã€èµ„æºã€æ­£ç¡®æ€§æŒ‡æ ‡è¾¾æ ‡åå†å…¨é‡åˆ‡æ¢ã€‚

## 9. ç”Ÿäº§æ£€æŸ¥æ¸…å•ä¸å›é€€æ¼”ç»ƒ

### 9.1 ç”Ÿäº§å‰æ£€æŸ¥æ¸…å•ï¼ˆGo/No-Goï¼‰

- ç¯å¢ƒä¸ä¾èµ–
  - [ ] OS/Kernelã€å®¹å™¨è¿è¡Œæ—¶ã€K8s ç‰ˆæœ¬ç¬¦åˆåŸºçº¿
  - [ ] CPU SIMDã€GPU é©±åŠ¨ä¸åº“ç‰ˆæœ¬éªŒè¯ï¼ˆnvidia-smi/rocminfoï¼‰
  - [ ] å­˜å‚¨æ€§èƒ½ä¸å®¹é‡è¯„ä¼°ï¼ˆfio/iostat/blkidï¼‰
- æ•°æ®åº“é…ç½®
  - [ ] shared_preload_librariesã€worker å¹¶å‘ã€å†…å­˜å‚æ•°
  - [ ] autovacuumã€checkpointã€IO å¹¶å‘
  - [ ] æ‰©å±•å¯ç”¨ï¼ˆpg_stat_statements/vector/ai_inference/streamingï¼‰
- åŠŸèƒ½ä¸å…¼å®¹
  - [ ] å‘é‡ç´¢å¼•åˆ›å»º/å›é€€è·¯å¾„éªŒè¯ï¼ˆHNSWâ†’BTREE/ç¦ç”¨ï¼‰
  - [ ] AI æ¨ç†ç¦ç”¨/é™çº§å¼€å…³éªŒè¯ï¼ˆai_set_option enabled=offï¼‰
  - [ ] æµå¤„ç† Exactly-Onceã€é‡æ”¾ã€å¹‚ç­‰éªŒè¯
- å®‰å…¨åˆè§„
  - [ ] RLS ç­–ç•¥ã€å®¡è®¡æ—¥å¿—ã€å¯†é’¥è½®æ¢
  - [ ] éšç§ä¸æœ€å°ç‰¹å¾ç­–ç•¥ã€æ•°æ®ç•™å­˜
- è§‚æµ‹ä¸SLO
  - [ ] æŒ‡æ ‡åŸºçº¿ä¸æŠ¥è­¦é˜ˆå€¼ï¼ˆå»¶è¿ŸP95/é”™è¯¯ç‡/èµ„æºï¼‰
  - [ ] ä»ªè¡¨æ¿å¯ç”¨ï¼Œæ¼”ç»ƒæŠ¥è­¦è§¦å‘ä¸æ¢å¤
- å¤‡ä»½ä¸å›é€€
  - [ ] PITR å¯ç”¨ï¼Œå…¨é‡/å¢é‡å¿«ç…§æœ‰æ•ˆ
  - [ ] æ¶æ„å˜æ›´ï¼ˆDDLï¼‰å…·å¤‡å›é€€è„šæœ¬

### 9.2 å›é€€æ¼”ç»ƒè„šæœ¬ï¼ˆç¤ºä¾‹ï¼‰

```bash
#!/usr/bin/env bash
# rollback_ai_vector.sh - AI/å‘é‡/æµå¤„ç†å¿«é€Ÿé™çº§æ¼”ç»ƒ
set -euo pipefail

PGURL=${PGURL:-"postgresql://postgres:postgres@localhost:5432/postgres"}

psql "$PGURL" -v ON_ERROR_STOP=1 <<'SQL'
-- 1) å¿«é€Ÿå…³é—­AIä¸SIMD
SELECT ai_set_option('enabled','off');
SELECT set_config('vector.simd','off', false);

-- 2) å°†å…³é”®æŸ¥è¯¢åˆ‡æ¢è‡³çº¯ç»“æ„åŒ–è·¯å¾„ï¼ˆç¤ºä¾‹å ä½ï¼‰
CREATE OR REPLACE VIEW search_fallback AS
SELECT id, title FROM items
WHERE to_tsvector('simple', title) @@ plainto_tsquery('smart watch')
LIMIT 20;

-- 3) æš‚åœæµå¤„ç†å¹¶è½¬ç‰©åŒ–æ‰¹å¤„ç†
ALTER STREAM user_events SET (retention = '0 minutes');
DROP MATERIALIZED VIEW IF EXISTS m_window;
CREATE MATERIALIZED VIEW m_window_batch AS
SELECT date_trunc('minute', ts) as ts_minute, event_type, count(*) cnt
FROM user_events_archive
GROUP BY 1,2;
SQL

echo "é™çº§å®Œæˆï¼šå·²åˆ‡æ¢è‡³ä¼ ç»Ÿè·¯å¾„ï¼ŒAI/å‘é‡/æµå¤„ç†å…³é—­/æ‰¹å¤„ç†åŒ–ã€‚"
```

> å»ºè®®æ¯æœˆæ‰§è¡Œä¸€æ¬¡æ¼”ç»ƒï¼Œè®°å½•è€—æ—¶ã€å½±å“é¢ã€å›é€€åSLOï¼Œå¹¶åœ¨å½±å­ç¯å¢ƒå›æ”¾æµé‡è¿›è¡Œå¯¹æ¯”ã€‚
