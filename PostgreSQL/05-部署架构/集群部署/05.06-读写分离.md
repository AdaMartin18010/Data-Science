# è¯»å†™åˆ†ç¦»é…ç½®æŒ‡å—

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-13
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²åˆ›å»º

---

## ğŸ“‹ ç›®å½•

- [è¯»å†™åˆ†ç¦»é…ç½®æŒ‡å—](#è¯»å†™åˆ†ç¦»é…ç½®æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [ä¼˜åŠ¿](#ä¼˜åŠ¿)
    - [æŒ‘æˆ˜](#æŒ‘æˆ˜)
  - [2. æ¶æ„è®¾è®¡](#2-æ¶æ„è®¾è®¡)
    - [2.1 åŸºæœ¬æ¶æ„](#21-åŸºæœ¬æ¶æ„)
    - [2.2 ä¸­é—´ä»¶æ¶æ„](#22-ä¸­é—´ä»¶æ¶æ„)
    - [2.3 åº”ç”¨å±‚è·¯ç”±](#23-åº”ç”¨å±‚è·¯ç”±)
  - [3. ä½¿ç”¨ pgpool-II](#3-ä½¿ç”¨-pgpool-ii)
    - [3.1 å®‰è£…é…ç½®](#31-å®‰è£…é…ç½®)
      - [å®‰è£…](#å®‰è£…)
      - [åŸºæœ¬é…ç½®ï¼ˆpgpool.confï¼‰](#åŸºæœ¬é…ç½®pgpoolconf)
    - [3.2 å¯åŠ¨æœåŠ¡](#32-å¯åŠ¨æœåŠ¡)
    - [3.3 è¿æ¥æµ‹è¯•](#33-è¿æ¥æµ‹è¯•)
  - [4. ä½¿ç”¨ pgbouncer](#4-ä½¿ç”¨-pgbouncer)
    - [4.1 é…ç½®ï¼ˆpgbouncer.iniï¼‰](#41-é…ç½®pgbouncerini)
    - [4.2 åº”ç”¨å±‚è·¯ç”±](#42-åº”ç”¨å±‚è·¯ç”±)
  - [5. åº”ç”¨å±‚è·¯ç”±](#5-åº”ç”¨å±‚è·¯ç”±)
    - [5.1 Django é…ç½®](#51-django-é…ç½®)
    - [5.2 Spring Boot é…ç½®](#52-spring-boot-é…ç½®)
  - [6. è´Ÿè½½å‡è¡¡](#6-è´Ÿè½½å‡è¡¡)
    - [6.1 è½®è¯¢ï¼ˆRound Robinï¼‰](#61-è½®è¯¢round-robin)
    - [6.2 åŠ æƒè½®è¯¢](#62-åŠ æƒè½®è¯¢)
    - [6.3 åŸºäºå»¶è¿Ÿçš„è·¯ç”±](#63-åŸºäºå»¶è¿Ÿçš„è·¯ç”±)
  - [7. pgpool-IIè¯¦ç»†é…ç½®](#7-pgpool-iiè¯¦ç»†é…ç½®)
    - [7.1 ç”Ÿäº§çº§é…ç½®](#71-ç”Ÿäº§çº§é…ç½®)
    - [7.2 è´Ÿè½½å‡è¡¡é…ç½®](#72-è´Ÿè½½å‡è¡¡é…ç½®)
    - [7.3 æ•…éšœè½¬ç§»é…ç½®](#73-æ•…éšœè½¬ç§»é…ç½®)
    - [7.4 æ€§èƒ½ä¼˜åŒ–é…ç½®](#74-æ€§èƒ½ä¼˜åŒ–é…ç½®)
  - [8. åº”ç”¨å±‚è·¯ç”±è¯¦ç»†å®ç°](#8-åº”ç”¨å±‚è·¯ç”±è¯¦ç»†å®ç°)
    - [8.1 Djangoå®Œæ•´é…ç½®ç¤ºä¾‹](#81-djangoå®Œæ•´é…ç½®ç¤ºä¾‹)
    - [8.2 Spring Bootå®Œæ•´é…ç½®ç¤ºä¾‹](#82-spring-bootå®Œæ•´é…ç½®ç¤ºä¾‹)
    - [8.3 Node.jsé…ç½®ç¤ºä¾‹](#83-nodejsé…ç½®ç¤ºä¾‹)
    - [8.4 Pythonè¿æ¥æ± é…ç½®](#84-pythonè¿æ¥æ± é…ç½®)
  - [9. æ•…éšœæ’æŸ¥å’Œè¯Šæ–­](#9-æ•…éšœæ’æŸ¥å’Œè¯Šæ–­)
    - [9.1 è¯»å†™åˆ†ç¦»é—®é¢˜è¯Šæ–­](#91-è¯»å†™åˆ†ç¦»é—®é¢˜è¯Šæ–­)
    - [9.2 è´Ÿè½½å‡è¡¡é—®é¢˜](#92-è´Ÿè½½å‡è¡¡é—®é¢˜)
    - [9.3 è¿æ¥æ± é—®é¢˜](#93-è¿æ¥æ± é—®é¢˜)
    - [9.4 æ€§èƒ½é—®é¢˜è¯Šæ–­](#94-æ€§èƒ½é—®é¢˜è¯Šæ–­)
  - [10. ç›‘æ§å’Œå‘Šè­¦](#10-ç›‘æ§å’Œå‘Šè­¦)
    - [10.1 è¯»å†™åˆ†ç¦»æ•ˆæœç›‘æ§](#101-è¯»å†™åˆ†ç¦»æ•ˆæœç›‘æ§)
    - [10.2 å»¶è¿Ÿç›‘æ§](#102-å»¶è¿Ÿç›‘æ§)
    - [10.3 å‘Šè­¦è§„åˆ™é…ç½®](#103-å‘Šè­¦è§„åˆ™é…ç½®)
    - [10.4 æ€§èƒ½æŒ‡æ ‡ç›‘æ§](#104-æ€§èƒ½æŒ‡æ ‡ç›‘æ§)
  - [11. äº¤å‰å¼•ç”¨](#11-äº¤å‰å¼•ç”¨)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
      - [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
      - [æ ¸å¿ƒè¯¾ç¨‹](#æ ¸å¿ƒè¯¾ç¨‹)
      - [æŸ¥è¯¢ä¸ä¼˜åŒ–](#æŸ¥è¯¢ä¸ä¼˜åŒ–)
      - [è¿ç»´å®è·µ](#è¿ç»´å®è·µ)
    - [å¤–éƒ¨èµ„æº](#å¤–éƒ¨èµ„æº)

---

## 1. æ¦‚è¿°

è¯»å†™åˆ†ç¦»ï¼ˆRead-Write Splittingï¼‰æ˜¯å°†è¯»æ“ä½œå’Œå†™æ“ä½œåˆ†å‘åˆ°ä¸åŒçš„æ•°æ®åº“å®ä¾‹ï¼Œä»¥æé«˜ç³»ç»Ÿæ•´ä½“æ€§èƒ½å’Œå¯æ‰©å±•æ€§ã€‚

### ä¼˜åŠ¿

- **æå‡è¯»æ€§èƒ½**: è¯»æ“ä½œåˆ†æ•£åˆ°å¤šä¸ªä»åº“
- **é™ä½ä¸»åº“å‹åŠ›**: ä¸»åº“ä¸“æ³¨äºå†™æ“ä½œ
- **æé«˜å¯ç”¨æ€§**: ä»åº“æ•…éšœä¸å½±å“å†™æ“ä½œ
- **æ°´å¹³æ‰©å±•**: é€šè¿‡å¢åŠ ä»åº“æ‰©å±•è¯»èƒ½åŠ›

### æŒ‘æˆ˜

- **æ•°æ®ä¸€è‡´æ€§**: ä¸»ä»å¤åˆ¶å»¶è¿Ÿå¯¼è‡´è¯»å»¶è¿Ÿ
- **è·¯ç”±å¤æ‚æ€§**: éœ€è¦åŒºåˆ†è¯»å†™æ“ä½œ
- **æ•…éšœå¤„ç†**: ä»åº“æ•…éšœæ—¶çš„è‡ªåŠ¨åˆ‡æ¢

---

## 2. æ¶æ„è®¾è®¡

### 2.1 åŸºæœ¬æ¶æ„

```text
åº”ç”¨å±‚
  â”‚
  â”œâ”€ å†™æ“ä½œ â”€â”€â†’ ä¸»åº“ (Primary)
  â”‚
  â””â”€ è¯»æ“ä½œ â”€â”€â†’ ä»åº“ (Standby) â”€â”€â†’ ä»åº“ (Standby)
```

### 2.2 ä¸­é—´ä»¶æ¶æ„

```text
åº”ç”¨å±‚
  â”‚
  â””â”€ pgpool-II / pgbouncer
      â”‚
      â”œâ”€ å†™æ“ä½œ â”€â”€â†’ ä¸»åº“
      â”‚
      â””â”€ è¯»æ“ä½œ â”€â”€â†’ ä»åº“ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
```

### 2.3 åº”ç”¨å±‚è·¯ç”±

```text
åº”ç”¨å±‚ï¼ˆè¿æ¥æ± ï¼‰
  â”‚
  â”œâ”€ å†™è¿æ¥ â”€â”€â†’ ä¸»åº“
  â”‚
  â””â”€ è¯»è¿æ¥ â”€â”€â†’ ä»åº“ï¼ˆè½®è¯¢/éšæœºï¼‰
```

---

## 3. ä½¿ç”¨ pgpool-II

### 3.1 å®‰è£…é…ç½®

#### å®‰è£…

```bash
# Ubuntu/Debian
sudo apt-get install pgpool2

# æˆ–ä»æºç ç¼–è¯‘
wget https://www.pgpool.net/download.php?f=pgpool-II-4.4.3.tar.gz
tar xzf pgpool-II-4.4.3.tar.gz
cd pgpool-II-4.4.3
./configure --prefix=/usr/local/pgpool
make && make install
```

#### åŸºæœ¬é…ç½®ï¼ˆpgpool.confï¼‰

```text
# ç›‘å¬åœ°å€å’Œç«¯å£
listen_addresses = '*'
port = 9999

# åç«¯æ•°æ®åº“é…ç½®
backend_hostname0 = 'primary_host'
backend_port0 = 5432
backend_weight0 = 0  # ä¸»åº“æƒé‡ï¼ˆå†™æ“ä½œï¼‰
backend_flag0 = 'ALLOW_TO_FAILOVER'

backend_hostname1 = 'standby1_host'
backend_port1 = 5432
backend_weight1 = 1  # ä»åº“æƒé‡ï¼ˆè¯»æ“ä½œï¼‰
backend_flag1 = 'ALLOW_TO_FAILOVER'

backend_hostname2 = 'standby2_host'
backend_port2 = 5432
backend_weight2 = 1
backend_flag2 = 'ALLOW_TO_FAILOVER'

# è´Ÿè½½å‡è¡¡æ¨¡å¼
load_balance_mode = on

# ä¸»ä»å¤åˆ¶æ£€æŸ¥
master_slave_mode = on
master_slave_sub_mode = 'stream'

# å¥åº·æ£€æŸ¥
health_check_period = 30
health_check_timeout = 10
health_check_user = 'postgres'
health_check_password = 'password'
health_check_database = 'postgres'

# æ•…éšœè½¬ç§»
failover_on_backend_error = on
```

### 3.2 å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨ pgpool-II
pgpool -n -f /etc/pgpool2/pgpool.conf -F /etc/pgpool2/pcp.conf

# æˆ–ä½¿ç”¨ systemd
sudo systemctl start pgpool2
sudo systemctl enable pgpool2
```

### 3.3 è¿æ¥æµ‹è¯•

```bash
# é€šè¿‡ pgpool è¿æ¥
psql -h pgpool_host -p 9999 -U postgres -d mydb

# æŸ¥çœ‹åç«¯çŠ¶æ€
psql -h pgpool_host -p 9999 -U postgres -c "SHOW POOL_NODES;"
```

---

## 4. ä½¿ç”¨ pgbouncer

### 4.1 é…ç½®ï¼ˆpgbouncer.iniï¼‰

```ini
[databases]
mydb = host=primary_host port=5432 dbname=mydb
mydb_ro = host=standby1_host port=5432 dbname=mydb

[pgbouncer]
listen_addr = *
listen_port = 6432
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

# è¿æ¥æ± æ¨¡å¼
pool_mode = transaction

# è¿æ¥é™åˆ¶
max_client_conn = 1000
default_pool_size = 25
```

### 4.2 åº”ç”¨å±‚è·¯ç”±

```python
# Python ç¤ºä¾‹
import psycopg2

# å†™æ“ä½œè¿æ¥ï¼ˆä¸»åº“ï¼‰
write_conn = psycopg2.connect(
    host='pgbouncer_host',
    port=6432,
    database='mydb',
    user='app_user',
    password='password'
)

# è¯»æ“ä½œè¿æ¥ï¼ˆä»åº“ï¼‰
read_conn = psycopg2.connect(
    host='pgbouncer_host',
    port=6432,
    database='mydb_ro',
    user='app_user',
    password='password'
)
```

---

## 5. åº”ç”¨å±‚è·¯ç”±

### 5.1 Django é…ç½®

```python
# settings.py
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'mydb',
        'USER': 'app_user',
        'PASSWORD': 'password',
        'HOST': 'primary_host',
        'PORT': '5432',
    },
    'read': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'mydb',
        'USER': 'app_user',
        'PASSWORD': 'password',
        'HOST': 'standby1_host',
        'PORT': '5432',
    }
}

# æ•°æ®åº“è·¯ç”±
DATABASE_ROUTERS = ['myapp.dbrouter.DatabaseRouter']
```

```python
# dbrouter.py
class DatabaseRouter:
    def db_for_read(self, model, **hints):
        return 'read'

    def db_for_write(self, model, **hints):
        return 'default'
```

### 5.2 Spring Boot é…ç½®

```yaml
# application.yml
spring:
  datasource:
    write:
      jdbc-url: jdbc:postgresql://primary_host:5432/mydb
      username: app_user
      password: password
    read:
      - jdbc-url: jdbc:postgresql://standby1_host:5432/mydb
        username: app_user
        password: password
      - jdbc-url: jdbc:postgresql://standby2_host:5432/mydb
        username: app_user
        password: password
```

---

## 6. è´Ÿè½½å‡è¡¡

### 6.1 è½®è¯¢ï¼ˆRound Robinï¼‰

```python
class RoundRobinRouter:
    def __init__(self, read_hosts):
        self.read_hosts = read_hosts
        self.current = 0

    def get_read_host(self):
        host = self.read_hosts[self.current]
        self.current = (self.current + 1) % len(self.read_hosts)
        return host
```

### 6.2 åŠ æƒè½®è¯¢

```python
class WeightedRoundRobinRouter:
    def __init__(self, read_hosts_with_weights):
        self.hosts = read_hosts_with_weights
        self.current_weight = 0
        self.current_index = -1

    def get_read_host(self):
        while True:
            self.current_index = (self.current_index + 1) % len(self.hosts)
            if self.current_index == 0:
                self.current_weight -= sum(w for _, w in self.hosts)
            self.current_weight += self.hosts[self.current_index][1]
            if self.current_weight > 0:
                return self.hosts[self.current_index][0]
```

### 6.3 åŸºäºå»¶è¿Ÿçš„è·¯ç”±

```python
import time

class LatencyBasedRouter:
    def __init__(self, read_hosts):
        self.read_hosts = read_hosts
        self.latencies = {host: 0 for host in read_hosts}

    def measure_latency(self, host):
        start = time.time()
        # æ‰§è¡Œç®€å•æŸ¥è¯¢
        conn = psycopg2.connect(host=host, ...)
        conn.execute("SELECT 1")
        conn.close()
        return time.time() - start

    def get_read_host(self):
        # å®šæœŸæµ‹é‡å»¶è¿Ÿ
        for host in self.read_hosts:
            self.latencies[host] = self.measure_latency(host)

        # é€‰æ‹©å»¶è¿Ÿæœ€ä½çš„ä¸»æœº
        return min(self.latencies, key=self.latencies.get)
```

---

## 7. ç›‘æ§ä¸è¯Šæ–­

### 7.1 pgpool-II ç›‘æ§

```sql
-- æŸ¥çœ‹åç«¯èŠ‚ç‚¹çŠ¶æ€
SHOW POOL_NODES;

-- æŸ¥çœ‹è¿æ¥æ± çŠ¶æ€
SHOW POOL_PROCESSES;

-- æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
SHOW POOL_STATS;
```

### 7.2 å¤åˆ¶å»¶è¿Ÿç›‘æ§

```sql
-- ç›‘æ§ä¸»ä»å»¶è¿Ÿ
SELECT
  application_name,
  client_addr,
  state,
  pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn)) AS lag,
  EXTRACT(EPOCH FROM (now() - replay_lag)) AS lag_seconds
FROM pg_stat_replication;
```

### 7.3 è¯»å†™åˆ†ç¦»æ•ˆæœç›‘æ§

```sql
-- ä¸»åº“ï¼šå†™æ“ä½œç»Ÿè®¡
SELECT
  datname,
  xact_commit,
  xact_rollback,
  blks_read,
  blks_hit
FROM pg_stat_database
WHERE datname = 'mydb';

-- ä»åº“ï¼šè¯»æ“ä½œç»Ÿè®¡
SELECT
  datname,
  numbackends,
  xact_commit,
  blks_read,
  blks_hit,
  tup_returned,
  tup_fetched
FROM pg_stat_database
WHERE datname = 'mydb';
```

---

## 7. pgpool-IIè¯¦ç»†é…ç½®

### 7.1 ç”Ÿäº§çº§é…ç½®

**å®Œæ•´çš„pgpool.confç”Ÿäº§é…ç½®**:

```conf
# ============================================
# åŸºæœ¬é…ç½®
# ============================================
listen_addresses = '*'
port = 9999
socket_dir = '/var/run/pgpool'
pcp_listen_addresses = '*'
pcp_port = 9898
pcp_socket_dir = '/var/run/pgpool'

# ============================================
# åç«¯æ•°æ®åº“é…ç½®
# ============================================
# ä¸»åº“ï¼ˆå†™æ“ä½œï¼‰
backend_hostname0 = 'primary_host'
backend_port0 = 5432
backend_weight0 = 0                    # ä¸»åº“æƒé‡ä¸º0ï¼ˆä»…å†™æ“ä½œï¼‰
backend_flag0 = 'ALLOW_TO_FAILOVER'
backend_data_directory0 = '/var/lib/postgresql/data'
backend_application_name0 = 'primary'

# ä»åº“1ï¼ˆè¯»æ“ä½œï¼‰
backend_hostname1 = 'standby1_host'
backend_port1 = 5432
backend_weight1 = 1                    # ä»åº“æƒé‡ä¸º1ï¼ˆè¯»æ“ä½œï¼‰
backend_flag1 = 'ALLOW_TO_FAILOVER'
backend_data_directory1 = '/var/lib/postgresql/data'
backend_application_name1 = 'standby1'

# ä»åº“2ï¼ˆè¯»æ“ä½œï¼‰
backend_hostname2 = 'standby2_host'
backend_port2 = 5432
backend_weight2 = 1
backend_flag2 = 'ALLOW_TO_FAILOVER'
backend_data_directory2 = '/var/lib/postgresql/data'
backend_application_name2 = 'standby2'

# ============================================
# è¿æ¥æ± é…ç½®
# ============================================
num_init_children = 32                # åˆå§‹å­è¿›ç¨‹æ•°
max_pool = 4                          # æ¯ä¸ªå­è¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°
child_life_time = 300                  # å­è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸï¼ˆç§’ï¼‰
child_max_connections = 0              # å­è¿›ç¨‹æœ€å¤§è¿æ¥æ•°ï¼ˆ0=æ— é™åˆ¶ï¼‰
connection_life_time = 0               # è¿æ¥ç”Ÿå‘½å‘¨æœŸï¼ˆ0=æ— é™åˆ¶ï¼‰
client_idle_limit = 0                  # å®¢æˆ·ç«¯ç©ºé—²é™åˆ¶ï¼ˆ0=æ— é™åˆ¶ï¼‰

# ============================================
# è´Ÿè½½å‡è¡¡é…ç½®
# ============================================
load_balance_mode = on                 # å¯ç”¨è´Ÿè½½å‡è¡¡
ignore_leading_white_space = on       # å¿½ç•¥å‰å¯¼ç©ºæ ¼

# ============================================
# ä¸»ä»å¤åˆ¶æ¨¡å¼
# ============================================
master_slave_mode = on                 # å¯ç”¨ä¸»ä»æ¨¡å¼
master_slave_sub_mode = 'stream'       # æµå¤åˆ¶æ¨¡å¼
failover_on_backend_error = on         # åç«¯é”™è¯¯æ—¶æ•…éšœè½¬ç§»

# ============================================
# å¥åº·æ£€æŸ¥é…ç½®
# ============================================
health_check_period = 30               # å¥åº·æ£€æŸ¥å‘¨æœŸï¼ˆç§’ï¼‰
health_check_timeout = 10              # å¥åº·æ£€æŸ¥è¶…æ—¶ï¼ˆç§’ï¼‰
health_check_user = 'postgres'         # å¥åº·æ£€æŸ¥ç”¨æˆ·
health_check_password = 'password'     # å¥åº·æ£€æŸ¥å¯†ç 
health_check_database = 'postgres'     # å¥åº·æ£€æŸ¥æ•°æ®åº“
health_check_max_retries = 3           # æœ€å¤§é‡è¯•æ¬¡æ•°
health_check_retry_delay = 1           # é‡è¯•å»¶è¿Ÿï¼ˆç§’ï¼‰

# ============================================
# æ•…éšœè½¬ç§»é…ç½®
# ============================================
failover_command = '/usr/local/bin/failover.sh %h %p %d %H %P %r %R'
failback_command = '/usr/local/bin/failback.sh %h %p %d %H %P %r %R'
follow_master_command = '/usr/local/bin/follow_master.sh %h %p %d %H %P %r %R'

# ============================================
# æ—¥å¿—é…ç½®
# ============================================
log_destination = 'stderr'
logging_collector = on
log_directory = '/var/log/pgpool'
log_filename = 'pgpool-%Y-%m-%d.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_messages = warning
log_connections = on
log_hostname = on
log_statement = on
log_per_node_statement = on

# ============================================
# è®¤è¯é…ç½®
# ============================================
enable_pool_hba = on
pool_passwd = 'pool_passwd'

# ============================================
# æ€§èƒ½ä¼˜åŒ–
# ============================================
memory_cache_enabled = on              # å¯ç”¨å†…å­˜ç¼“å­˜
memqcache_method = 'memcached'         # ä½¿ç”¨Memcached
memqcache_memcached_host = 'memcached_host'
memqcache_memcached_port = 11211
memqcache_total_size = 67108864        # 64MB
memqcache_max_num_cache = 1000000
memqcache_expire = 3600
memqcache_auto_cache_invalidation = on
```

**pool_hba.confé…ç½®**:

```conf
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# æœ¬åœ°è¿æ¥
local   all             all                                     md5

# IPv4æœ¬åœ°è¿æ¥
host    all             all             127.0.0.1/32            md5

# åº”ç”¨æœåŠ¡å™¨è¿æ¥
host    all             app_user        192.168.1.0/24          scram-sha-256

# ç®¡ç†è¿æ¥
host    all             postgres        192.168.1.0/24          scram-sha-256
```

### 7.2 è´Ÿè½½å‡è¡¡é…ç½®

**è´Ÿè½½å‡è¡¡ç­–ç•¥é…ç½®**:

```conf
# pgpool.conf
# è´Ÿè½½å‡è¡¡æ¨¡å¼
load_balance_mode = on

# è´Ÿè½½å‡è¡¡æƒé‡ï¼ˆæ ¹æ®ä»åº“æ€§èƒ½è°ƒæ•´ï¼‰
backend_weight1 = 2                    # é«˜æ€§èƒ½ä»åº“æƒé‡æ›´é«˜
backend_weight2 = 1                    # æ™®é€šä»åº“æƒé‡è¾ƒä½

# åŸºäºè¯­å¥çš„è´Ÿè½½å‡è¡¡
statement_level_load_balance = on      # è¯­å¥çº§è´Ÿè½½å‡è¡¡

# è´Ÿè½½å‡è¡¡ç®—æ³•
# - round_robin: è½®è¯¢ï¼ˆé»˜è®¤ï¼‰
# - weighted_round_robin: åŠ æƒè½®è¯¢
# - least_connections: æœ€å°‘è¿æ¥
load_balance_algorithm = 'round_robin'
```

**è´Ÿè½½å‡è¡¡æµ‹è¯•**:

```sql
-- æµ‹è¯•è´Ÿè½½å‡è¡¡
-- æ‰§è¡Œå¤šæ¬¡æŸ¥è¯¢ï¼Œè§‚å¯Ÿè¿æ¥åˆ†å¸ƒ
SELECT pg_backend_pid(), inet_server_addr(), inet_server_port();

-- æŸ¥çœ‹è´Ÿè½½å‡è¡¡ç»Ÿè®¡
SHOW POOL_STATS;
```

### 7.3 æ•…éšœè½¬ç§»é…ç½®

**æ•…éšœè½¬ç§»è„šæœ¬**:

```bash
#!/bin/bash
# /usr/local/bin/failover.sh
# å‚æ•°: $1=å¤±è´¥èŠ‚ç‚¹ä¸»æœºå $2=å¤±è´¥èŠ‚ç‚¹ç«¯å£ $3=å¤±è´¥èŠ‚ç‚¹æ•°æ®åº“ $4=æ–°ä¸»åº“ä¸»æœºå $5=æ–°ä¸»åº“ç«¯å£ $6=æ—§ä¸»åº“æ•°æ®ç›®å½• $7=æ–°ä¸»åº“æ•°æ®ç›®å½•

FAILED_NODE=$1
FAILED_PORT=$2
FAILED_DB=$3
NEW_PRIMARY=$4
NEW_PRIMARY_PORT=$5
OLD_PRIMARY_DATA=$6
NEW_PRIMARY_DATA=$7

echo "Failover: $FAILED_NODE:$FAILED_PORT -> $NEW_PRIMARY:$NEW_PRIMARY_PORT"

# 1. æå‡æ–°ä¸»åº“
ssh postgres@$NEW_PRIMARY "psql -c 'SELECT pg_promote();'"

# 2. æ›´æ–°åº”ç”¨è¿æ¥å­—ç¬¦ä¸²ï¼ˆå¯é€‰ï¼‰
# curl -X POST http://app-server/api/config/update-db-host -d "host=$NEW_PRIMARY"

# 3. å‘é€é€šçŸ¥
echo "Failover completed: $NEW_PRIMARY is now primary" | mail -s "PostgreSQL Failover Alert" admin@example.com

exit 0
```

**æ•…éšœè½¬ç§»é…ç½®**:

```conf
# pgpool.conf
failover_command = '/usr/local/bin/failover.sh %h %p %d %H %P %r %R'
failback_command = '/usr/local/bin/failback.sh %h %p %d %H %P %r %R'
follow_master_command = '/usr/local/bin/follow_master.sh %h %p %d %H %P %r %R'

# æ•…éšœè½¬ç§»è¶…æ—¶
failover_timeout = 60                  # æ•…éšœè½¬ç§»è¶…æ—¶ï¼ˆç§’ï¼‰

# è‡ªåŠ¨æ•…éšœæ¢å¤
failback_on_backend_error = off       # ä¸è‡ªåŠ¨æ•…éšœæ¢å¤ï¼ˆæ¨èæ‰‹åŠ¨æ¢å¤ï¼‰
```

### 7.4 æ€§èƒ½ä¼˜åŒ–é…ç½®

**è¿æ¥æ± ä¼˜åŒ–**:

```conf
# pgpool.conf
# è¿æ¥æ± å¤§å°ä¼˜åŒ–
num_init_children = 64                # æ ¹æ®å¹¶å‘è¿æ¥æ•°è°ƒæ•´
max_pool = 4                          # æ¯ä¸ªå­è¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°
child_life_time = 300                  # å­è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ

# è¿æ¥å¤ç”¨
connection_life_time = 0               # è¿æ¥ç”Ÿå‘½å‘¨æœŸï¼ˆ0=æ— é™åˆ¶ï¼‰
client_idle_limit = 0                  # å®¢æˆ·ç«¯ç©ºé—²é™åˆ¶

# æŸ¥è¯¢ç¼“å­˜
memory_cache_enabled = on
memqcache_method = 'memcached'
memqcache_total_size = 134217728      # 128MB
memqcache_max_num_cache = 1000000
memqcache_expire = 3600
```

**æŸ¥è¯¢ä¼˜åŒ–**:

```conf
# pgpool.conf
# æŸ¥è¯¢ç¼“å­˜
memory_cache_enabled = on
memqcache_method = 'memcached'
memqcache_total_size = 134217728      # 128MB

# æŸ¥è¯¢é‡å†™
rewrite_query = on                     # å¯ç”¨æŸ¥è¯¢é‡å†™
rewrite_query_list = 'SELECT'          # é‡å†™SELECTæŸ¥è¯¢

# å¹¶è¡ŒæŸ¥è¯¢
parallel_mode = off                    # ç¦ç”¨å¹¶è¡Œæ¨¡å¼ï¼ˆæ¨èï¼‰
```

## 8. åº”ç”¨å±‚è·¯ç”±è¯¦ç»†å®ç°

### 8.1 Djangoå®Œæ•´é…ç½®ç¤ºä¾‹

**å®Œæ•´çš„Djangoé…ç½®**:

```python
# settings.py
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'mydb',
        'USER': 'app_user',
        'PASSWORD': os.getenv('DB_PASSWORD'),
        'HOST': 'primary_host',
        'PORT': '5432',
        'OPTIONS': {
            'connect_timeout': 10,
            'options': '-c statement_timeout=30000'
        },
        'CONN_MAX_AGE': 600,           # è¿æ¥æ± æœ€å¤§å¹´é¾„
    },
    'read': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'mydb',
        'USER': 'app_user',
        'PASSWORD': os.getenv('DB_PASSWORD'),
        'HOST': 'standby1_host',
        'PORT': '5432',
        'OPTIONS': {
            'connect_timeout': 10,
            'options': '-c statement_timeout=30000'
        },
        'CONN_MAX_AGE': 600,
    },
    'read2': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'mydb',
        'USER': 'app_user',
        'PASSWORD': os.getenv('DB_PASSWORD'),
        'HOST': 'standby2_host',
        'PORT': '5432',
        'OPTIONS': {
            'connect_timeout': 10,
            'options': '-c statement_timeout=30000'
        },
        'CONN_MAX_AGE': 600,
    }
}

# æ•°æ®åº“è·¯ç”±
DATABASE_ROUTERS = ['myapp.dbrouter.DatabaseRouter']

# è¿æ¥æ± é…ç½®
DATABASES['default']['CONN_MAX_AGE'] = 600
DATABASES['read']['CONN_MAX_AGE'] = 600
DATABASES['read2']['CONN_MAX_AGE'] = 600
```

**æ•°æ®åº“è·¯ç”±å®ç°**:

```python
# myapp/dbrouter.py
import random
from django.conf import settings

class DatabaseRouter:
    """æ•°æ®åº“è·¯ç”±ï¼šå®ç°è¯»å†™åˆ†ç¦»"""
    
    read_databases = ['read', 'read2']
    
    def db_for_read(self, model, **hints):
        """è¯»æ“ä½œè·¯ç”±åˆ°ä»åº“"""
        # éšæœºé€‰æ‹©ä»åº“ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
        return random.choice(self.read_databases)
    
    def db_for_write(self, model, **hints):
        """å†™æ“ä½œè·¯ç”±åˆ°ä¸»åº“"""
        return 'default'
    
    def allow_relation(self, obj1, obj2, **hints):
        """å…è®¸è·¨æ•°æ®åº“å…³ç³»"""
        return True
    
    def allow_migrate(self, db, app_label, model_name=None, **hints):
        """è¿ç§»åªåœ¨ä¸»åº“æ‰§è¡Œ"""
        if db == 'default':
            return True
        return False
```

**ä½¿ç”¨ç¤ºä¾‹**:

```python
# views.py
from django.db import connections

def get_user_list(request):
    """è¯»æ“ä½œè‡ªåŠ¨è·¯ç”±åˆ°ä»åº“"""
    users = User.objects.all()  # è‡ªåŠ¨è·¯ç”±åˆ°ä»åº“
    return render(request, 'users.html', {'users': users})

def create_user(request):
    """å†™æ“ä½œè‡ªåŠ¨è·¯ç”±åˆ°ä¸»åº“"""
    user = User.objects.create(  # è‡ªåŠ¨è·¯ç”±åˆ°ä¸»åº“
        username=request.POST['username'],
        email=request.POST['email']
    )
    return redirect('user_list')

# æ‰‹åŠ¨æŒ‡å®šæ•°æ®åº“
def get_user_from_primary(request, user_id):
    """å¼ºåˆ¶ä»ä¸»åº“è¯»å–ï¼ˆè¯»å–åˆšå†™å…¥çš„æ•°æ®ï¼‰"""
    user = User.objects.using('default').get(id=user_id)
    return render(request, 'user.html', {'user': user})
```

### 8.2 Spring Bootå®Œæ•´é…ç½®ç¤ºä¾‹

**å®Œæ•´çš„Spring Booté…ç½®**:

```yaml
# application.yml
spring:
  datasource:
    # ä¸»åº“é…ç½®ï¼ˆå†™æ“ä½œï¼‰
    write:
      jdbc-url: jdbc:postgresql://primary_host:5432/mydb?sslmode=require
      username: app_user
      password: ${DB_PASSWORD}
      driver-class-name: org.postgresql.Driver
      hikari:
        maximum-pool-size: 20
        minimum-idle: 5
        connection-timeout: 30000
        idle-timeout: 600000
        max-lifetime: 1800000
    
    # ä»åº“é…ç½®ï¼ˆè¯»æ“ä½œï¼‰
    read:
      - jdbc-url: jdbc:postgresql://standby1_host:5432/mydb?sslmode=require
        username: app_user
        password: ${DB_PASSWORD}
        driver-class-name: org.postgresql.Driver
        hikari:
          maximum-pool-size: 20
          minimum-idle: 5
          connection-timeout: 30000
          idle-timeout: 600000
          max-lifetime: 1800000
      - jdbc-url: jdbc:postgresql://standby2_host:5432/mydb?sslmode=require
        username: app_user
        password: ${DB_PASSWORD}
        driver-class-name: org.postgresql.Driver
        hikari:
          maximum-pool-size: 20
          minimum-idle: 5
          connection-timeout: 30000
          idle-timeout: 600000
          max-lifetime: 1800000

  jpa:
    hibernate:
      ddl-auto: none
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
```

**æ•°æ®æºé…ç½®ç±»**:

```java
// DataSourceConfig.java
@Configuration
public class DataSourceConfig {
    
    @Bean
    @Primary
    @ConfigurationProperties("spring.datasource.write")
    public DataSource writeDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    @Bean
    @ConfigurationProperties("spring.datasource.read")
    public List<DataSource> readDataSources() {
        return Arrays.asList(
            DataSourceBuilder.create().build(),
            DataSourceBuilder.create().build()
        );
    }
    
    @Bean
    public DataSource routingDataSource() {
        RoutingDataSource routingDataSource = new RoutingDataSource();
        Map<Object, Object> dataSourceMap = new HashMap<>();
        dataSourceMap.put("write", writeDataSource());
        for (int i = 0; i < readDataSources().size(); i++) {
            dataSourceMap.put("read" + i, readDataSources().get(i));
        }
        routingDataSource.setTargetDataSources(dataSourceMap);
        routingDataSource.setDefaultTargetDataSource(writeDataSource());
        return routingDataSource;
    }
}
```

**è·¯ç”±æ•°æ®æºå®ç°**:

```java
// RoutingDataSource.java
public class RoutingDataSource extends AbstractRoutingDataSource {
    
    private static final ThreadLocal<String> contextHolder = new ThreadLocal<>();
    private static final Random random = new Random();
    
    @Override
    protected Object determineCurrentLookupKey() {
        return contextHolder.get();
    }
    
    public static void setReadDataSource() {
        // éšæœºé€‰æ‹©ä»åº“
        int index = random.nextInt(2);
        contextHolder.set("read" + index);
    }
    
    public static void setWriteDataSource() {
        contextHolder.set("write");
    }
    
    public static void clear() {
        contextHolder.remove();
    }
}
```

**AOPåˆ‡é¢å®ç°**:

```java
// ReadWriteAspect.java
@Aspect
@Component
public class ReadWriteAspect {
    
    @Around("@annotation(org.springframework.transaction.annotation.Transactional)")
    public Object routeDataSource(ProceedingJoinPoint joinPoint) throws Throwable {
        MethodSignature signature = (MethodSignature) joinPoint.getSignature();
        Transactional transactional = signature.getMethod().getAnnotation(Transactional.class);
        
        if (transactional != null && transactional.readOnly()) {
            RoutingDataSource.setReadDataSource();
        } else {
            RoutingDataSource.setWriteDataSource();
        }
        
        try {
            return joinPoint.proceed();
        } finally {
            RoutingDataSource.clear();
        }
    }
}
```

### 8.3 Node.jsé…ç½®ç¤ºä¾‹

**Node.jsè¿æ¥æ± é…ç½®**:

```javascript
// db.js
const { Pool } = require('pg');
const _ = require('lodash');

// ä¸»åº“è¿æ¥æ± ï¼ˆå†™æ“ä½œï¼‰
const writePool = new Pool({
  host: 'primary_host',
  port: 5432,
  database: 'mydb',
  user: 'app_user',
  password: process.env.DB_PASSWORD,
  max: 20,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 30000,
});

// ä»åº“è¿æ¥æ± ï¼ˆè¯»æ“ä½œï¼‰
const readPools = [
  new Pool({
    host: 'standby1_host',
    port: 5432,
    database: 'mydb',
    user: 'app_user',
    password: process.env.DB_PASSWORD,
    max: 20,
    idleTimeoutMillis: 30000,
    connectionTimeoutMillis: 30000,
  }),
  new Pool({
    host: 'standby2_host',
    port: 5432,
    database: 'mydb',
    user: 'app_user',
    password: process.env.DB_PASSWORD,
    max: 20,
    idleTimeoutMillis: 30000,
    connectionTimeoutMillis: 30000,
  }),
];

// è·å–è¯»è¿æ¥æ± ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
function getReadPool() {
  return _.sample(readPools);
}

// æ•°æ®åº“æ“ä½œå°è£…
const db = {
  // å†™æ“ä½œ
  async query(sql, params) {
    return await writePool.query(sql, params);
  },
  
  // è¯»æ“ä½œ
  async read(sql, params) {
    const pool = getReadPool();
    return await pool.query(sql, params);
  },
  
  // äº‹åŠ¡ï¼ˆå†™æ“ä½œï¼‰
  async transaction(callback) {
    const client = await writePool.connect();
    try {
      await client.query('BEGIN');
      const result = await callback(client);
      await client.query('COMMIT');
      return result;
    } catch (error) {
      await client.query('ROLLBACK');
      throw error;
    } finally {
      client.release();
    }
  },
};

module.exports = db;
```

**ä½¿ç”¨ç¤ºä¾‹**:

```javascript
// routes/users.js
const db = require('../db');

// è¯»æ“ä½œï¼ˆè·¯ç”±åˆ°ä»åº“ï¼‰
router.get('/users', async (req, res) => {
  const result = await db.read('SELECT * FROM users');
  res.json(result.rows);
});

// å†™æ“ä½œï¼ˆè·¯ç”±åˆ°ä¸»åº“ï¼‰
router.post('/users', async (req, res) => {
  const result = await db.query(
    'INSERT INTO users (username, email) VALUES ($1, $2) RETURNING *',
    [req.body.username, req.body.email]
  );
  res.json(result.rows[0]);
});
```

### 8.4 Pythonè¿æ¥æ± é…ç½®

**Pythonè¿æ¥æ± é…ç½®**:

```python
# db.py
import psycopg2
from psycopg2 import pool
import random
import os

# ä¸»åº“è¿æ¥æ± ï¼ˆå†™æ“ä½œï¼‰
write_pool = psycopg2.pool.ThreadedConnectionPool(
    1,
    20,
    host='primary_host',
    port=5432,
    database='mydb',
    user='app_user',
    password=os.getenv('DB_PASSWORD'),
    connect_timeout=10
)

# ä»åº“è¿æ¥æ± ï¼ˆè¯»æ“ä½œï¼‰
read_pools = [
    psycopg2.pool.ThreadedConnectionPool(
        1,
        20,
        host='standby1_host',
        port=5432,
        database='mydb',
        user='app_user',
        password=os.getenv('DB_PASSWORD'),
        connect_timeout=10
    ),
    psycopg2.pool.ThreadedConnectionPool(
        1,
        20,
        host='standby2_host',
        port=5432,
        database='mydb',
        user='app_user',
        password=os.getenv('DB_PASSWORD'),
        connect_timeout=10
    ),
]

def get_read_pool():
    """è·å–è¯»è¿æ¥æ± ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰"""
    return random.choice(read_pools)

def execute_write(query, params=None):
    """æ‰§è¡Œå†™æ“ä½œ"""
    conn = write_pool.getconn()
    try:
        cursor = conn.cursor()
        cursor.execute(query, params)
        result = cursor.fetchall() if cursor.description else None
        conn.commit()
        return result
    except Exception as e:
        conn.rollback()
        raise e
    finally:
        cursor.close()
        write_pool.putconn(conn)

def execute_read(query, params=None):
    """æ‰§è¡Œè¯»æ“ä½œ"""
    pool = get_read_pool()
    conn = pool.getconn()
    try:
        cursor = conn.cursor()
        cursor.execute(query, params)
        result = cursor.fetchall()
        return result
    finally:
        cursor.close()
        pool.putconn(conn)
```

## 9. æ•…éšœæ’æŸ¥å’Œè¯Šæ–­

### 9.1 è¯»å†™åˆ†ç¦»é—®é¢˜è¯Šæ–­

**é—®é¢˜è¯Šæ–­æ­¥éª¤**:

```sql
-- 1. æ£€æŸ¥pgpool-IIçŠ¶æ€
SHOW POOL_NODES;
SHOW POOL_PROCESSES;
SHOW POOL_STATS;

-- 2. æ£€æŸ¥åç«¯èŠ‚ç‚¹çŠ¶æ€
SELECT * FROM pgpool_nodes;

-- 3. æ£€æŸ¥è¯»å†™åˆ†ç¦»æ˜¯å¦ç”Ÿæ•ˆ
-- åœ¨ä¸»åº“æ‰§è¡Œ
SELECT count(*) FROM pg_stat_activity WHERE state = 'active';

-- åœ¨ä»åº“æ‰§è¡Œ
SELECT count(*) FROM pg_stat_activity WHERE state = 'active';

-- 4. æ£€æŸ¥æŸ¥è¯¢è·¯ç”±
-- é€šè¿‡pgpoolè¿æ¥æ‰§è¡ŒæŸ¥è¯¢ï¼ŒæŸ¥çœ‹å®é™…è¿æ¥çš„èŠ‚ç‚¹
SELECT pg_backend_pid(), inet_server_addr(), inet_server_port();
```

**å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ**:

```bash
# é—®é¢˜1: è¯»æ“ä½œä»ç„¶è·¯ç”±åˆ°ä¸»åº“
# åŸå› : pgpool-IIé…ç½®é”™è¯¯æˆ–æŸ¥è¯¢è¢«è¯†åˆ«ä¸ºå†™æ“ä½œ
# è§£å†³: æ£€æŸ¥pgpool.confé…ç½®
grep -i "load_balance_mode\|master_slave_mode" /etc/pgpool2/pgpool.conf

# é—®é¢˜2: è´Ÿè½½å‡è¡¡ä¸å·¥ä½œ
# åŸå› : åç«¯èŠ‚ç‚¹æƒé‡é…ç½®é”™è¯¯
# è§£å†³: æ£€æŸ¥backend_weighté…ç½®
grep -i "backend_weight" /etc/pgpool2/pgpool.conf

# é—®é¢˜3: è¿æ¥æ± è€—å°½
# åŸå› : è¿æ¥æ•°è¶…è¿‡é™åˆ¶
# è§£å†³: å¢åŠ è¿æ¥æ± å¤§å°æˆ–ä¼˜åŒ–è¿æ¥ä½¿ç”¨
SHOW POOL_STATS;
```

### 9.2 è´Ÿè½½å‡è¡¡é—®é¢˜

**è´Ÿè½½å‡è¡¡é—®é¢˜è¯Šæ–­**:

```sql
-- 1. æ£€æŸ¥è´Ÿè½½å‡è¡¡çŠ¶æ€
SHOW POOL_NODES;
-- æŸ¥çœ‹backend_weightå’ŒçŠ¶æ€

-- 2. æ£€æŸ¥è¿æ¥åˆ†å¸ƒ
SELECT
  backend_hostname,
  backend_port,
  count(*) as connection_count
FROM pg_stat_activity
GROUP BY backend_hostname, backend_port;

-- 3. æ£€æŸ¥æŸ¥è¯¢åˆ†å¸ƒ
-- é€šè¿‡pgpoolæ‰§è¡Œå¤šæ¬¡æŸ¥è¯¢ï¼Œè§‚å¯Ÿè¿æ¥èŠ‚ç‚¹
SELECT pg_backend_pid(), inet_server_addr();
```

**è´Ÿè½½å‡è¡¡ä¼˜åŒ–**:

```conf
# pgpool.conf
# æ ¹æ®ä»åº“æ€§èƒ½è°ƒæ•´æƒé‡
backend_weight1 = 2                    # é«˜æ€§èƒ½ä»åº“
backend_weight2 = 1                    # æ™®é€šä»åº“

# ä½¿ç”¨åŠ æƒè½®è¯¢
load_balance_algorithm = 'weighted_round_robin'
```

### 9.3 è¿æ¥æ± é—®é¢˜

**è¿æ¥æ± é—®é¢˜è¯Šæ–­**:

```sql
-- 1. æ£€æŸ¥è¿æ¥æ± çŠ¶æ€
SHOW POOL_PROCESSES;
SHOW POOL_STATS;

-- 2. æ£€æŸ¥è¿æ¥æ•°
SELECT
  datname,
  count(*) as connections,
  count(*) FILTER (WHERE state = 'active') as active_connections,
  count(*) FILTER (WHERE state = 'idle') as idle_connections
FROM pg_stat_activity
GROUP BY datname;

-- 3. æ£€æŸ¥è¿æ¥ç­‰å¾…
SELECT
  pid,
  wait_event_type,
  wait_event,
  state,
  query
FROM pg_stat_activity
WHERE wait_event_type IS NOT NULL;
```

**è¿æ¥æ± ä¼˜åŒ–**:

```conf
# pgpool.conf
# ä¼˜åŒ–è¿æ¥æ± å¤§å°
num_init_children = 64                # æ ¹æ®å¹¶å‘è¿æ¥æ•°è°ƒæ•´
max_pool = 4                          # æ¯ä¸ªå­è¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°

# è¿æ¥å¤ç”¨
connection_life_time = 0               # è¿æ¥ç”Ÿå‘½å‘¨æœŸ
client_idle_limit = 0                  # å®¢æˆ·ç«¯ç©ºé—²é™åˆ¶
```

### 9.4 æ€§èƒ½é—®é¢˜è¯Šæ–­

**æ€§èƒ½è¯Šæ–­è„šæœ¬**:

```bash
#!/bin/bash
# scripts/read_write_performance_diagnosis.sh

echo "=== è¯»å†™åˆ†ç¦»æ€§èƒ½è¯Šæ–­ ==="

# 1. ä¸»åº“å†™æ“ä½œç»Ÿè®¡
echo "=== ä¸»åº“å†™æ“ä½œç»Ÿè®¡ ==="
psql -h primary_host -U postgres -c "
SELECT
  datname,
  xact_commit,
  xact_rollback,
  blks_read,
  blks_hit,
  tup_inserted,
  tup_updated,
  tup_deleted
FROM pg_stat_database
WHERE datname = 'mydb';
"

# 2. ä»åº“è¯»æ“ä½œç»Ÿè®¡
echo "=== ä»åº“è¯»æ“ä½œç»Ÿè®¡ ==="
psql -h standby1_host -U postgres -c "
SELECT
  datname,
  numbackends,
  xact_commit,
  blks_read,
  blks_hit,
  tup_returned,
  tup_fetched
FROM pg_stat_database
WHERE datname = 'mydb';
"

# 3. pgpool-IIç»Ÿè®¡
echo "=== pgpool-IIç»Ÿè®¡ ==="
psql -h pgpool_host -p 9999 -U postgres -c "SHOW POOL_STATS;"

# 4. å¤åˆ¶å»¶è¿Ÿ
echo "=== å¤åˆ¶å»¶è¿Ÿ ==="
psql -h primary_host -U postgres -c "
SELECT
  application_name,
  pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn)) AS lag
FROM pg_stat_replication;
"
```

## 10. ç›‘æ§å’Œå‘Šè­¦

### 10.1 è¯»å†™åˆ†ç¦»æ•ˆæœç›‘æ§

**è¯»å†™åˆ†ç¦»æ•ˆæœç›‘æ§SQL**:

```sql
-- 1. ä¸»åº“å†™æ“ä½œç»Ÿè®¡
SELECT
  datname,
  xact_commit as writes,
  tup_inserted + tup_updated + tup_deleted as rows_written,
  blks_read + blks_hit as total_blocks
FROM pg_stat_database
WHERE datname = 'mydb';

-- 2. ä»åº“è¯»æ“ä½œç»Ÿè®¡
SELECT
  datname,
  numbackends as connections,
  xact_commit as reads,
  tup_returned + tup_fetched as rows_read,
  blks_read + blks_hit as total_blocks
FROM pg_stat_database
WHERE datname = 'mydb';

-- 3. è¯»å†™åˆ†ç¦»æ¯”ä¾‹
-- ä¸»åº“å†™æ“ä½œ / (ä¸»åº“å†™æ“ä½œ + ä»åº“è¯»æ“ä½œ)
SELECT
  (SELECT xact_commit FROM pg_stat_database WHERE datname = 'mydb') as writes,
  (SELECT sum(xact_commit) FROM pg_stat_database WHERE datname = 'mydb') as total_ops,
  round(
    100.0 * (SELECT xact_commit FROM pg_stat_database WHERE datname = 'mydb') /
    (SELECT sum(xact_commit) FROM pg_stat_database WHERE datname = 'mydb'),
    2
  ) as write_percentage;
```

### 10.2 å»¶è¿Ÿç›‘æ§

**å»¶è¿Ÿç›‘æ§é…ç½®**:

```sql
-- åˆ›å»ºå»¶è¿Ÿç›‘æ§è§†å›¾
CREATE OR REPLACE VIEW read_write_lag_monitor AS
SELECT
  'primary' AS node_type,
  datname,
  pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), 
    (SELECT restart_lsn FROM pg_replication_slots WHERE slot_name = 'replica1')
  )) AS lag_size
FROM pg_stat_database
WHERE datname = 'mydb'
UNION ALL
SELECT
  'standby' AS node_type,
  datname,
  pg_size_pretty(pg_wal_lsn_diff(
    (SELECT pg_current_wal_lsn() FROM pg_stat_database WHERE datname = 'mydb'),
    pg_last_wal_replay_lsn()
  )) AS lag_size
FROM pg_stat_database
WHERE datname = 'mydb';
```

### 10.3 å‘Šè­¦è§„åˆ™é…ç½®

**Prometheuså‘Šè­¦è§„åˆ™**:

```yaml
# read-write-split-alerts.yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: postgres-read-write-split-alerts
  namespace: monitoring
spec:
  groups:
  - name: postgres_read_write_split
    interval: 30s
    rules:
    - alert: PostgreSQLReadWriteSplitImbalance
      expr: |
        (pg_stat_database_xact_commit{datname="mydb",instance="primary"} /
         (pg_stat_database_xact_commit{datname="mydb",instance="primary"} +
          sum(pg_stat_database_xact_commit{datname="mydb",instance=~"standby.*"}))) > 0.5
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "PostgreSQL read-write split imbalance"
        description: "Write operations account for {{ $value | humanizePercentage }} of total operations"
    
    - alert: PostgreSQLReplicationLagHigh
      expr: pg_replication_lag > 10485760  # 10MB
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "PostgreSQL replication lag is high"
        description: "Replication lag is {{ $value }} bytes"
```

### 10.4 æ€§èƒ½æŒ‡æ ‡ç›‘æ§

**æ€§èƒ½æŒ‡æ ‡ç›‘æ§**:

```sql
-- 1. pgpool-IIæ€§èƒ½æŒ‡æ ‡
SHOW POOL_STATS;

-- 2. è¿æ¥æ± ä½¿ç”¨ç‡
SELECT
  (SELECT count(*) FROM pg_stat_activity) as current_connections,
  (SELECT setting::int FROM pg_settings WHERE name = 'max_connections') as max_connections,
  round(
    100.0 * (SELECT count(*) FROM pg_stat_activity) /
    (SELECT setting::int FROM pg_settings WHERE name = 'max_connections'),
    2
  ) as connection_usage_percent;

-- 3. æŸ¥è¯¢æ€§èƒ½
SELECT
  query,
  calls,
  mean_time,
  max_time,
  total_time
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 20;
```

---

## 11. äº¤å‰å¼•ç”¨

### ç›¸å…³æ–‡æ¡£

#### éƒ¨ç½²æ¶æ„

- â­â­â­ [ä¸»ä»å¤åˆ¶é…ç½®æŒ‡å—](./05.05-ä¸»ä»å¤åˆ¶.md) - ä¸»ä»å¤åˆ¶åŸºç¡€
- â­â­â­ [é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨](./05.04-é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨.md) - é«˜å¯ç”¨æ¶æ„
- â­â­ [æ€§èƒ½è°ƒä¼˜å®è·µ](../å•æœºéƒ¨ç½²/05.02-æ€§èƒ½è°ƒä¼˜å®è·µ.md) - æ€§èƒ½ä¼˜åŒ–

#### æ ¸å¿ƒè¯¾ç¨‹

- â­â­ [äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§](../../01-æ ¸å¿ƒè¯¾ç¨‹/01.04-äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§.md) - äº‹åŠ¡ç®¡ç†åŸºç¡€
- â­â­ [å¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶](../../01-æ ¸å¿ƒè¯¾ç¨‹/01.05-å¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶.md) - å¹¶å‘æ§åˆ¶

#### æŸ¥è¯¢ä¸ä¼˜åŒ–

- â­â­ [æŸ¥è¯¢ä¼˜åŒ–å™¨åŸç†](../../03-æŸ¥è¯¢ä¸ä¼˜åŒ–/02.01-æŸ¥è¯¢ä¼˜åŒ–å™¨åŸç†.md) - æŸ¥è¯¢ä¼˜åŒ–
- â­ [æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜](../../03-æŸ¥è¯¢ä¸ä¼˜åŒ–/02.04-æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜.md) - æ€§èƒ½åˆ†æ

#### è¿ç»´å®è·µ

- â­â­â­ [ç›‘æ§ä¸è¯Šæ–­](../../06-è¿ç»´å®è·µ/ç›‘æ§ä¸è¯Šæ–­/06.01-ç›‘æ§ä¸è¯Šæ–­.md) - è¯»å†™åˆ†ç¦»ç›‘æ§
- â­â­ [å¤‡ä»½ä¸æ¢å¤](../../06-è¿ç»´å®è·µ/å¤‡ä»½ä¸æ¢å¤/06.06-å¤‡ä»½ä¸æ¢å¤.md) - å¤‡ä»½æ¢å¤

### å¤–éƒ¨èµ„æº

- [pgpool-II å®˜æ–¹æ–‡æ¡£](https://www.pgpool.net/docs/)
- [pgbouncer å®˜æ–¹æ–‡æ¡£](https://www.pgbouncer.org/)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.0
**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: PostgreSQL Documentation Team
