# è¯»å†™åˆ†ç¦»é…ç½®æŒ‡å—

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-13
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²åˆ›å»º

---

## ğŸ“‹ ç›®å½•

- [è¯»å†™åˆ†ç¦»é…ç½®æŒ‡å—](#è¯»å†™åˆ†ç¦»é…ç½®æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [ä¼˜åŠ¿](#ä¼˜åŠ¿)
    - [æŒ‘æˆ˜](#æŒ‘æˆ˜)
  - [2. æ¶æ„è®¾è®¡](#2-æ¶æ„è®¾è®¡)
    - [2.1 åŸºæœ¬æ¶æ„](#21-åŸºæœ¬æ¶æ„)
    - [2.2 ä¸­é—´ä»¶æ¶æ„](#22-ä¸­é—´ä»¶æ¶æ„)
    - [2.3 åº”ç”¨å±‚è·¯ç”±](#23-åº”ç”¨å±‚è·¯ç”±)
  - [3. ä½¿ç”¨ pgpool-II](#3-ä½¿ç”¨-pgpool-ii)
    - [3.1 å®‰è£…é…ç½®](#31-å®‰è£…é…ç½®)
      - [å®‰è£…](#å®‰è£…)
      - [åŸºæœ¬é…ç½®ï¼ˆpgpool.confï¼‰](#åŸºæœ¬é…ç½®pgpoolconf)
    - [3.2 å¯åŠ¨æœåŠ¡](#32-å¯åŠ¨æœåŠ¡)
    - [3.3 è¿æ¥æµ‹è¯•](#33-è¿æ¥æµ‹è¯•)
  - [4. ä½¿ç”¨ pgbouncer](#4-ä½¿ç”¨-pgbouncer)
    - [4.1 é…ç½®ï¼ˆpgbouncer.iniï¼‰](#41-é…ç½®pgbouncerini)
    - [4.2 åº”ç”¨å±‚è·¯ç”±](#42-åº”ç”¨å±‚è·¯ç”±)
  - [5. åº”ç”¨å±‚è·¯ç”±](#5-åº”ç”¨å±‚è·¯ç”±)
    - [5.1 Django é…ç½®](#51-django-é…ç½®)
    - [5.2 Spring Boot é…ç½®](#52-spring-boot-é…ç½®)
  - [6. è´Ÿè½½å‡è¡¡](#6-è´Ÿè½½å‡è¡¡)
    - [6.1 è½®è¯¢ï¼ˆRound Robinï¼‰](#61-è½®è¯¢round-robin)
    - [6.2 åŠ æƒè½®è¯¢](#62-åŠ æƒè½®è¯¢)
    - [6.3 åŸºäºå»¶è¿Ÿçš„è·¯ç”±](#63-åŸºäºå»¶è¿Ÿçš„è·¯ç”±)
  - [7. ç›‘æ§ä¸è¯Šæ–­](#7-ç›‘æ§ä¸è¯Šæ–­)
    - [7.1 pgpool-II ç›‘æ§](#71-pgpool-ii-ç›‘æ§)
    - [7.2 å¤åˆ¶å»¶è¿Ÿç›‘æ§](#72-å¤åˆ¶å»¶è¿Ÿç›‘æ§)
    - [7.3 è¯»å†™åˆ†ç¦»æ•ˆæœç›‘æ§](#73-è¯»å†™åˆ†ç¦»æ•ˆæœç›‘æ§)
  - [8. æ·±å…¥é˜…è¯»](#8-æ·±å…¥é˜…è¯»)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
    - [å¤–éƒ¨èµ„æº](#å¤–éƒ¨èµ„æº)

---

## 1. æ¦‚è¿°

è¯»å†™åˆ†ç¦»ï¼ˆRead-Write Splittingï¼‰æ˜¯å°†è¯»æ“ä½œå’Œå†™æ“ä½œåˆ†å‘åˆ°ä¸åŒçš„æ•°æ®åº“å®ä¾‹ï¼Œä»¥æé«˜ç³»ç»Ÿæ•´ä½“æ€§èƒ½å’Œå¯æ‰©å±•æ€§ã€‚

### ä¼˜åŠ¿

- **æå‡è¯»æ€§èƒ½**: è¯»æ“ä½œåˆ†æ•£åˆ°å¤šä¸ªä»åº“
- **é™ä½ä¸»åº“å‹åŠ›**: ä¸»åº“ä¸“æ³¨äºå†™æ“ä½œ
- **æé«˜å¯ç”¨æ€§**: ä»åº“æ•…éšœä¸å½±å“å†™æ“ä½œ
- **æ°´å¹³æ‰©å±•**: é€šè¿‡å¢åŠ ä»åº“æ‰©å±•è¯»èƒ½åŠ›

### æŒ‘æˆ˜

- **æ•°æ®ä¸€è‡´æ€§**: ä¸»ä»å¤åˆ¶å»¶è¿Ÿå¯¼è‡´è¯»å»¶è¿Ÿ
- **è·¯ç”±å¤æ‚æ€§**: éœ€è¦åŒºåˆ†è¯»å†™æ“ä½œ
- **æ•…éšœå¤„ç†**: ä»åº“æ•…éšœæ—¶çš„è‡ªåŠ¨åˆ‡æ¢

---

## 2. æ¶æ„è®¾è®¡

### 2.1 åŸºæœ¬æ¶æ„

```text
åº”ç”¨å±‚
  â”‚
  â”œâ”€ å†™æ“ä½œ â”€â”€â†’ ä¸»åº“ (Primary)
  â”‚
  â””â”€ è¯»æ“ä½œ â”€â”€â†’ ä»åº“ (Standby) â”€â”€â†’ ä»åº“ (Standby)
```

### 2.2 ä¸­é—´ä»¶æ¶æ„

```text
åº”ç”¨å±‚
  â”‚
  â””â”€ pgpool-II / pgbouncer
      â”‚
      â”œâ”€ å†™æ“ä½œ â”€â”€â†’ ä¸»åº“
      â”‚
      â””â”€ è¯»æ“ä½œ â”€â”€â†’ ä»åº“ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
```

### 2.3 åº”ç”¨å±‚è·¯ç”±

```text
åº”ç”¨å±‚ï¼ˆè¿æ¥æ± ï¼‰
  â”‚
  â”œâ”€ å†™è¿æ¥ â”€â”€â†’ ä¸»åº“
  â”‚
  â””â”€ è¯»è¿æ¥ â”€â”€â†’ ä»åº“ï¼ˆè½®è¯¢/éšæœºï¼‰
```

---

## 3. ä½¿ç”¨ pgpool-II

### 3.1 å®‰è£…é…ç½®

#### å®‰è£…

```bash
# Ubuntu/Debian
sudo apt-get install pgpool2

# æˆ–ä»æºç ç¼–è¯‘
wget https://www.pgpool.net/download.php?f=pgpool-II-4.4.3.tar.gz
tar xzf pgpool-II-4.4.3.tar.gz
cd pgpool-II-4.4.3
./configure --prefix=/usr/local/pgpool
make && make install
```

#### åŸºæœ¬é…ç½®ï¼ˆpgpool.confï¼‰

```text
# ç›‘å¬åœ°å€å’Œç«¯å£
listen_addresses = '*'
port = 9999

# åç«¯æ•°æ®åº“é…ç½®
backend_hostname0 = 'primary_host'
backend_port0 = 5432
backend_weight0 = 0  # ä¸»åº“æƒé‡ï¼ˆå†™æ“ä½œï¼‰
backend_flag0 = 'ALLOW_TO_FAILOVER'

backend_hostname1 = 'standby1_host'
backend_port1 = 5432
backend_weight1 = 1  # ä»åº“æƒé‡ï¼ˆè¯»æ“ä½œï¼‰
backend_flag1 = 'ALLOW_TO_FAILOVER'

backend_hostname2 = 'standby2_host'
backend_port2 = 5432
backend_weight2 = 1
backend_flag2 = 'ALLOW_TO_FAILOVER'

# è´Ÿè½½å‡è¡¡æ¨¡å¼
load_balance_mode = on

# ä¸»ä»å¤åˆ¶æ£€æŸ¥
master_slave_mode = on
master_slave_sub_mode = 'stream'

# å¥åº·æ£€æŸ¥
health_check_period = 30
health_check_timeout = 10
health_check_user = 'postgres'
health_check_password = 'password'
health_check_database = 'postgres'

# æ•…éšœè½¬ç§»
failover_on_backend_error = on
```

### 3.2 å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨ pgpool-II
pgpool -n -f /etc/pgpool2/pgpool.conf -F /etc/pgpool2/pcp.conf

# æˆ–ä½¿ç”¨ systemd
sudo systemctl start pgpool2
sudo systemctl enable pgpool2
```

### 3.3 è¿æ¥æµ‹è¯•

```bash
# é€šè¿‡ pgpool è¿æ¥
psql -h pgpool_host -p 9999 -U postgres -d mydb

# æŸ¥çœ‹åç«¯çŠ¶æ€
psql -h pgpool_host -p 9999 -U postgres -c "SHOW POOL_NODES;"
```

---

## 4. ä½¿ç”¨ pgbouncer

### 4.1 é…ç½®ï¼ˆpgbouncer.iniï¼‰

```ini
[databases]
mydb = host=primary_host port=5432 dbname=mydb
mydb_ro = host=standby1_host port=5432 dbname=mydb

[pgbouncer]
listen_addr = *
listen_port = 6432
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

# è¿æ¥æ± æ¨¡å¼
pool_mode = transaction

# è¿æ¥é™åˆ¶
max_client_conn = 1000
default_pool_size = 25
```

### 4.2 åº”ç”¨å±‚è·¯ç”±

```python
# Python ç¤ºä¾‹
import psycopg2

# å†™æ“ä½œè¿æ¥ï¼ˆä¸»åº“ï¼‰
write_conn = psycopg2.connect(
    host='pgbouncer_host',
    port=6432,
    database='mydb',
    user='app_user',
    password='password'
)

# è¯»æ“ä½œè¿æ¥ï¼ˆä»åº“ï¼‰
read_conn = psycopg2.connect(
    host='pgbouncer_host',
    port=6432,
    database='mydb_ro',
    user='app_user',
    password='password'
)
```

---

## 5. åº”ç”¨å±‚è·¯ç”±

### 5.1 Django é…ç½®

```python
# settings.py
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'mydb',
        'USER': 'app_user',
        'PASSWORD': 'password',
        'HOST': 'primary_host',
        'PORT': '5432',
    },
    'read': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'mydb',
        'USER': 'app_user',
        'PASSWORD': 'password',
        'HOST': 'standby1_host',
        'PORT': '5432',
    }
}

# æ•°æ®åº“è·¯ç”±
DATABASE_ROUTERS = ['myapp.dbrouter.DatabaseRouter']
```

```python
# dbrouter.py
class DatabaseRouter:
    def db_for_read(self, model, **hints):
        return 'read'

    def db_for_write(self, model, **hints):
        return 'default'
```

### 5.2 Spring Boot é…ç½®

```yaml
# application.yml
spring:
  datasource:
    write:
      jdbc-url: jdbc:postgresql://primary_host:5432/mydb
      username: app_user
      password: password
    read:
      - jdbc-url: jdbc:postgresql://standby1_host:5432/mydb
        username: app_user
        password: password
      - jdbc-url: jdbc:postgresql://standby2_host:5432/mydb
        username: app_user
        password: password
```

---

## 6. è´Ÿè½½å‡è¡¡

### 6.1 è½®è¯¢ï¼ˆRound Robinï¼‰

```python
class RoundRobinRouter:
    def __init__(self, read_hosts):
        self.read_hosts = read_hosts
        self.current = 0

    def get_read_host(self):
        host = self.read_hosts[self.current]
        self.current = (self.current + 1) % len(self.read_hosts)
        return host
```

### 6.2 åŠ æƒè½®è¯¢

```python
class WeightedRoundRobinRouter:
    def __init__(self, read_hosts_with_weights):
        self.hosts = read_hosts_with_weights
        self.current_weight = 0
        self.current_index = -1

    def get_read_host(self):
        while True:
            self.current_index = (self.current_index + 1) % len(self.hosts)
            if self.current_index == 0:
                self.current_weight -= sum(w for _, w in self.hosts)
            self.current_weight += self.hosts[self.current_index][1]
            if self.current_weight > 0:
                return self.hosts[self.current_index][0]
```

### 6.3 åŸºäºå»¶è¿Ÿçš„è·¯ç”±

```python
import time

class LatencyBasedRouter:
    def __init__(self, read_hosts):
        self.read_hosts = read_hosts
        self.latencies = {host: 0 for host in read_hosts}

    def measure_latency(self, host):
        start = time.time()
        # æ‰§è¡Œç®€å•æŸ¥è¯¢
        conn = psycopg2.connect(host=host, ...)
        conn.execute("SELECT 1")
        conn.close()
        return time.time() - start

    def get_read_host(self):
        # å®šæœŸæµ‹é‡å»¶è¿Ÿ
        for host in self.read_hosts:
            self.latencies[host] = self.measure_latency(host)

        # é€‰æ‹©å»¶è¿Ÿæœ€ä½çš„ä¸»æœº
        return min(self.latencies, key=self.latencies.get)
```

---

## 7. ç›‘æ§ä¸è¯Šæ–­

### 7.1 pgpool-II ç›‘æ§

```sql
-- æŸ¥çœ‹åç«¯èŠ‚ç‚¹çŠ¶æ€
SHOW POOL_NODES;

-- æŸ¥çœ‹è¿æ¥æ± çŠ¶æ€
SHOW POOL_PROCESSES;

-- æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
SHOW POOL_STATS;
```

### 7.2 å¤åˆ¶å»¶è¿Ÿç›‘æ§

```sql
-- ç›‘æ§ä¸»ä»å»¶è¿Ÿ
SELECT
  application_name,
  client_addr,
  state,
  pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn)) AS lag,
  EXTRACT(EPOCH FROM (now() - replay_lag)) AS lag_seconds
FROM pg_stat_replication;
```

### 7.3 è¯»å†™åˆ†ç¦»æ•ˆæœç›‘æ§

```sql
-- ä¸»åº“ï¼šå†™æ“ä½œç»Ÿè®¡
SELECT
  datname,
  xact_commit,
  xact_rollback,
  blks_read,
  blks_hit
FROM pg_stat_database
WHERE datname = 'mydb';

-- ä»åº“ï¼šè¯»æ“ä½œç»Ÿè®¡
SELECT
  datname,
  numbackends,
  xact_commit,
  blks_read,
  blks_hit,
  tup_returned,
  tup_fetched
FROM pg_stat_database
WHERE datname = 'mydb';
```

---

## 8. æ·±å…¥é˜…è¯»

### ç›¸å…³æ–‡æ¡£

- [ä¸»ä»å¤åˆ¶é…ç½®æŒ‡å—](./05.05-ä¸»ä»å¤åˆ¶.md)
- [é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨](./05.04-é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨.md)
- [ç›‘æ§ä¸è¯Šæ–­](../../06-è¿ç»´å®è·µ/ç›‘æ§ä¸è¯Šæ–­/06.01-ç›‘æ§ä¸è¯Šæ–­.md)

### å¤–éƒ¨èµ„æº

- [pgpool-II å®˜æ–¹æ–‡æ¡£](https://www.pgpool.net/docs/)
- [pgbouncer å®˜æ–¹æ–‡æ¡£](https://www.pgbouncer.org/)

---

**æœ€åæ›´æ–°**: 2025-11-13
