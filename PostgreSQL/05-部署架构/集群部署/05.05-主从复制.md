# ä¸»ä»å¤åˆ¶é…ç½®æŒ‡å—

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-13
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²åˆ›å»º

---

## ğŸ“‹ ç›®å½•

- [ä¸»ä»å¤åˆ¶é…ç½®æŒ‡å—](#ä¸»ä»å¤åˆ¶é…ç½®æŒ‡å—)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. ç‰©ç†å¤åˆ¶é…ç½®](#2-ç‰©ç†å¤åˆ¶é…ç½®)
  - [3. é€»è¾‘å¤åˆ¶é…ç½®](#3-é€»è¾‘å¤åˆ¶é…ç½®)
  - [4. åŒæ­¥ä¸å¼‚æ­¥ç­–ç•¥](#4-åŒæ­¥ä¸å¼‚æ­¥ç­–ç•¥)
  - [5. å¤åˆ¶æ§½ç®¡ç†](#5-å¤åˆ¶æ§½ç®¡ç†)
  - [6. ç›‘æ§ä¸è¯Šæ–­](#6-ç›‘æ§ä¸è¯Šæ–­)
  - [7. æ•…éšœå¤„ç†](#7-æ•…éšœå¤„ç†)
  - [8. æ·±å…¥é˜…è¯»](#8-æ·±å…¥é˜…è¯»)

---

## 1. æ¦‚è¿°

PostgreSQL æ”¯æŒä¸¤ç§å¤åˆ¶æ–¹å¼ï¼š

- **ç‰©ç†å¤åˆ¶ï¼ˆPhysical Replicationï¼‰**: åŸºäº WAL çš„å—çº§å¤åˆ¶ï¼Œé€‚ç”¨äºä¸»ä»é«˜å¯ç”¨åœºæ™¯
- **é€»è¾‘å¤åˆ¶ï¼ˆLogical Replicationï¼‰**: åŸºäºé€»è¾‘å˜æ›´çš„å¤åˆ¶ï¼Œé€‚ç”¨äºè·¨ç‰ˆæœ¬å‡çº§ã€éƒ¨åˆ†è¡¨å¤åˆ¶ç­‰åœºæ™¯

### é€‰æ‹©å»ºè®®

| åœºæ™¯ | æ¨èæ–¹å¼ | è¯´æ˜ |
|------|---------|------|
| é«˜å¯ç”¨ä¸»ä» | ç‰©ç†å¤åˆ¶ | å»¶è¿Ÿä½ã€æ•°æ®ä¸€è‡´æ€§å¼º |
| è·¨ç‰ˆæœ¬å‡çº§ | é€»è¾‘å¤åˆ¶ | æ”¯æŒä¸åŒç‰ˆæœ¬é—´å¤åˆ¶ |
| éƒ¨åˆ†è¡¨å¤åˆ¶ | é€»è¾‘å¤åˆ¶ | å¯é€‰æ‹©ç‰¹å®šè¡¨ |
| è¯»å†™åˆ†ç¦» | ç‰©ç†å¤åˆ¶ | ä»åº“å¯è¯»ï¼Œå»¶è¿Ÿä½ |
| å¤šä¸»å¤åˆ¶ | é€»è¾‘å¤åˆ¶ | æ”¯æŒåŒå‘å¤åˆ¶ |

---

## 2. ç‰©ç†å¤åˆ¶é…ç½®

### 2.1 ä¸»åº“é…ç½®

#### postgresql.conf

```text
# WAL çº§åˆ«
wal_level = replica  # PostgreSQL 18 æ¨èä½¿ç”¨ replica

# æœ€å¤§ WAL å‘é€è¿›ç¨‹æ•°
max_wal_senders = 10

# æœ€å¤§å¤åˆ¶æ§½æ•°
max_replication_slots = 10

# WAL ä¿ç•™å¤§å°ï¼ˆé¿å…å¤åˆ¶å»¶è¿Ÿæ—¶ WAL è¢«å›æ”¶ï¼‰
wal_keep_size = '1GB'  # PostgreSQL 13+ æ¨èä½¿ç”¨ wal_keep_size
# æˆ–ä½¿ç”¨ max_slot_wal_keep_size æ§åˆ¶å¤åˆ¶æ§½ä¿ç•™çš„ WAL

# çƒ­å¤‡æ¨¡å¼ï¼ˆå…è®¸ä»åº“æŸ¥è¯¢ï¼‰
hot_standby = on
```

#### pg_hba.conf

```text
# å…è®¸å¤åˆ¶è¿æ¥
host replication repl 10.0.0.0/24 md5
# æˆ–ä½¿ç”¨ scram-sha-256ï¼ˆæ¨èï¼‰
host replication repl 10.0.0.0/24 scram-sha-256
```

### 2.2 åˆ›å»ºå¤åˆ¶ç”¨æˆ·

```sql
-- åˆ›å»ºå¤åˆ¶ç”¨æˆ·
CREATE USER repl WITH REPLICATION PASSWORD 'secure_password';

-- æˆäºˆå¿…è¦æƒé™
GRANT CONNECT ON DATABASE postgres TO repl;
```

### 2.3 ä»åº“åˆå§‹åŒ–

#### æ–¹æ³•1: ä½¿ç”¨ pg_basebackupï¼ˆæ¨èï¼‰

```bash
# åŸºæœ¬ç”¨æ³•
pg_basebackup \
  -h primary_host \
  -U repl \
  -D /var/lib/postgresql/data \
  -X stream \
  -R \
  -C -S replica1

# å‚æ•°è¯´æ˜ï¼š
# -h: ä¸»åº“åœ°å€
# -U: å¤åˆ¶ç”¨æˆ·
# -D: æ•°æ®ç›®å½•
# -X stream: æµå¼ä¼ è¾“ WAL
# -R: è‡ªåŠ¨åˆ›å»º standby.signal å’Œ postgresql.auto.conf
# -C -S: åˆ›å»ºå¤åˆ¶æ§½ replica1
```

#### æ–¹æ³•2: æ‰‹åŠ¨é…ç½®

```bash
# 1. å¤‡ä»½ä¸»åº“
pg_basebackup -h primary -U repl -D /var/lib/postgresql/data -X stream

# 2. åˆ›å»º standby.signal
touch /var/lib/postgresql/data/standby.signal

# 3. é…ç½® postgresql.conf
primary_conninfo = 'host=primary_host port=5432 user=repl password=secure_password'
```

### 2.4 ä»åº“é…ç½®

#### postgresql.conf

```text
# çƒ­å¤‡æ¨¡å¼
hot_standby = on

# æœ€å¤§çƒ­å¤‡è¿æ¥æ•°
max_standby_streaming_delay = 30s
max_standby_archive_delay = 300s
```

#### standby.signal

```text
# ç©ºæ–‡ä»¶ï¼Œæ ‡è¯†ä¸ºå¤‡ç”¨æœåŠ¡å™¨
```

---

## 3. é€»è¾‘å¤åˆ¶é…ç½®

### 3.1 ä¸»åº“é…ç½®

#### postgresql.conf

```text
# WAL çº§åˆ«ï¼ˆé€»è¾‘å¤åˆ¶éœ€è¦ logicalï¼‰
wal_level = logical

# æœ€å¤§é€»è¾‘å¤åˆ¶å·¥ä½œè¿›ç¨‹
max_logical_replication_workers = 4
max_sync_workers_per_subscription = 2
```

### 3.2 åˆ›å»ºå‘å¸ƒï¼ˆPublicationï¼‰

```sql
-- åˆ›å»ºå‘å¸ƒï¼ŒåŒ…å«æ‰€æœ‰è¡¨
CREATE PUBLICATION pub_all FOR ALL TABLES;

-- åˆ›å»ºå‘å¸ƒï¼ŒåŒ…å«ç‰¹å®šè¡¨
CREATE PUBLICATION pub_specific FOR TABLE users, orders;

-- åˆ›å»ºå‘å¸ƒï¼ŒåŒ…å«ç‰¹å®šæ¨¡å¼
CREATE PUBLICATION pub_schema FOR TABLES IN SCHEMA public;

-- æŸ¥çœ‹å‘å¸ƒ
SELECT * FROM pg_publication;
```

### 3.3 ä»åº“åˆ›å»ºè®¢é˜…ï¼ˆSubscriptionï¼‰

```sql
-- åˆ›å»ºè®¢é˜…
CREATE SUBSCRIPTION sub_replica
CONNECTION 'host=primary_host port=5432 user=repl password=secure_password dbname=mydb'
PUBLICATION pub_all;

-- æŸ¥çœ‹è®¢é˜…çŠ¶æ€
SELECT * FROM pg_subscription;
SELECT * FROM pg_subscription_rel;
```

### 3.4 ç®¡ç†è®¢é˜…

```sql
-- æš‚åœè®¢é˜…
ALTER SUBSCRIPTION sub_replica DISABLE;

-- æ¢å¤è®¢é˜…
ALTER SUBSCRIPTION sub_replica ENABLE;

-- åˆ é™¤è®¢é˜…
DROP SUBSCRIPTION sub_replica;
```

---

## 4. åŒæ­¥ä¸å¼‚æ­¥ç­–ç•¥

### 4.1 åŒæ­¥å¤åˆ¶é…ç½®

#### postgresql.confï¼ˆä¸»åº“ï¼‰

```text
# åŒæ­¥æäº¤çº§åˆ«
synchronous_commit = remote_write  # æˆ– remote_apply

# åŒæ­¥å¤‡ç”¨æœåŠ¡å™¨åˆ—è¡¨
synchronous_standby_names = 'ANY 1 (node_b, node_c)'
# æˆ–ä½¿ç”¨ Quorum æ¨¡å¼
synchronous_standby_names = 'FIRST 2 (node_b, node_c, node_d)'
```

#### åŒæ­¥çº§åˆ«å¯¹æ¯”

| çº§åˆ« | è¯´æ˜ | æ€§èƒ½ | ä¸€è‡´æ€§ |
|------|------|------|--------|
| `local` | æœ¬åœ°æäº¤ | æœ€å¿« | å¼± |
| `remote_write` | è¿œç¨‹å†™å…¥ WAL | å¿« | ä¸­ |
| `remote_apply` | è¿œç¨‹åº”ç”¨ WAL | æ…¢ | å¼º |
| `on` | ç­‰åŒäº `remote_write` | ä¸­ | ä¸­ |
| `off` | å¼‚æ­¥æäº¤ | æœ€å¿« | æœ€å¼± |

### 4.2 å¼‚æ­¥å¤åˆ¶é…ç½®

```text
# å¼‚æ­¥æäº¤ï¼ˆé»˜è®¤ï¼‰
synchronous_commit = local
synchronous_standby_names = ''
```

### 4.3 æ€§èƒ½ä¸ä¸€è‡´æ€§æƒè¡¡

- **å¼ºåŒæ­¥ï¼ˆremote_applyï¼‰**: RPO = 0ï¼Œä½†å†™å»¶è¿Ÿå¢åŠ  2-5 å€
- **å¼±åŒæ­¥ï¼ˆremote_writeï¼‰**: RPO â‰ˆ 0ï¼Œå†™å»¶è¿Ÿå¢åŠ  1-2 å€
- **å¼‚æ­¥**: RPO > 0ï¼ˆå¯èƒ½ä¸¢å¤±å‡ ç§’æ•°æ®ï¼‰ï¼Œä½†å†™å»¶è¿Ÿæœ€ä½

---

## 5. å¤åˆ¶æ§½ç®¡ç†

### 5.1 åˆ›å»ºå¤åˆ¶æ§½

```sql
-- ç‰©ç†å¤åˆ¶æ§½
SELECT * FROM pg_create_physical_replication_slot('replica1');

-- é€»è¾‘å¤åˆ¶æ§½
SELECT * FROM pg_create_logical_replication_slot('logical_slot', 'pgoutput');
```

### 5.2 æŸ¥çœ‹å¤åˆ¶æ§½

```sql
-- æŸ¥çœ‹æ‰€æœ‰å¤åˆ¶æ§½
SELECT * FROM pg_replication_slots;

-- æŸ¥çœ‹å¤åˆ¶æ§½å»¶è¿Ÿ
SELECT
  slot_name,
  slot_type,
  active,
  pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) AS lag
FROM pg_replication_slots;
```

### 5.3 åˆ é™¤å¤åˆ¶æ§½

```sql
-- åˆ é™¤ç‰©ç†å¤åˆ¶æ§½
SELECT pg_drop_replication_slot('replica1');

-- åˆ é™¤é€»è¾‘å¤åˆ¶æ§½
SELECT pg_drop_replication_slot('logical_slot');
```

### 5.4 å¤åˆ¶æ§½ç›‘æ§

```sql
-- ç›‘æ§å¤åˆ¶æ§½ WAL ä¿ç•™
SELECT
  slot_name,
  pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) AS lag_size,
  active,
  restart_lsn,
  confirmed_flush_lsn
FROM pg_replication_slots;
```

---

## 6. ç›‘æ§ä¸è¯Šæ–­

### 6.1 å¤åˆ¶çŠ¶æ€æŸ¥è¯¢

```sql
-- æŸ¥çœ‹å¤åˆ¶çŠ¶æ€
SELECT
  pid,
  usename,
  application_name,
  client_addr,
  state,
  sync_state,
  sync_priority,
  pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) AS sent_lag,
  pg_wal_lsn_diff(sent_lsn, write_lsn) AS write_lag,
  pg_wal_lsn_diff(write_lsn, flush_lsn) AS flush_lag,
  pg_wal_lsn_diff(flush_lsn, replay_lsn) AS replay_lag
FROM pg_stat_replication;
```

### 6.2 ä»åº“çŠ¶æ€æŸ¥è¯¢

```sql
-- åœ¨ä»åº“æ‰§è¡Œ
SELECT
  pg_is_in_recovery() AS is_standby,
  pg_last_wal_receive_lsn() AS receive_lsn,
  pg_last_wal_replay_lsn() AS replay_lsn,
  pg_wal_lsn_diff(pg_last_wal_receive_lsn(), pg_last_wal_replay_lsn()) AS lag_bytes;
```

### 6.3 å»¶è¿Ÿç›‘æ§

```sql
-- ä¸»åº“ï¼šæŸ¥çœ‹å¤åˆ¶å»¶è¿Ÿ
SELECT
  application_name,
  client_addr,
  state,
  pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn)) AS sent_lag,
  pg_size_pretty(pg_wal_lsn_diff(sent_lsn, replay_lsn)) AS replay_lag,
  EXTRACT(EPOCH FROM (now() - write_lag)) AS write_lag_seconds,
  EXTRACT(EPOCH FROM (now() - replay_lag)) AS replay_lag_seconds
FROM pg_stat_replication;
```

---

## 7. æ•…éšœå¤„ç†

### 7.1 å¤åˆ¶ä¸­æ–­æ¢å¤

```sql
-- æ£€æŸ¥å¤åˆ¶çŠ¶æ€
SELECT * FROM pg_stat_replication WHERE state != 'streaming';

-- æ£€æŸ¥ WAL æ–‡ä»¶
SELECT * FROM pg_ls_waldir() ORDER BY modification DESC LIMIT 10;

-- é‡æ–°åŒæ­¥ä»åº“
-- åœ¨ä»åº“æ‰§è¡Œ
SELECT pg_wal_replay_resume();
```

### 7.2 ä»åº“æå‡ä¸ºä¸»åº“

```sql
-- åœ¨ä»åº“æ‰§è¡Œï¼ˆPostgreSQL 12+ï¼‰
SELECT pg_promote();

-- æˆ–æ‰‹åŠ¨æå‡
-- 1. åœæ­¢ä»åº“
-- 2. åˆ é™¤ standby.signal
-- 3. å¯åŠ¨æ•°æ®åº“
```

### 7.3 é€»è¾‘å¤åˆ¶å†²çªå¤„ç†

```sql
-- æŸ¥çœ‹å†²çª
SELECT * FROM pg_stat_subscription_stats;

-- å¤„ç†å†²çªï¼ˆåœ¨è®¢é˜…ç«¯ï¼‰
ALTER SUBSCRIPTION sub_replica SET (slot_name = NONE);
ALTER SUBSCRIPTION sub_replica SET (slot_name = 'sub_replica');
```

---

## 8. æ·±å…¥é˜…è¯»

### ç›¸å…³æ–‡æ¡£

- [é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨](../05-éƒ¨ç½²æ¶æ„/é›†ç¾¤éƒ¨ç½²/05.04-é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨.md)
- [ç›‘æ§ä¸è¯Šæ–­](../../06-è¿ç»´å®è·µ/ç›‘æ§ä¸è¯Šæ–­/06.01-ç›‘æ§ä¸è¯Šæ–­.md)
- [æ•…éšœåˆ‡æ¢ä¸è®¢é˜…é‡å»º](../../../runbook/æ•…éšœåˆ‡æ¢ä¸è®¢é˜…é‡å»º.md)

### å¤–éƒ¨èµ„æº

- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - å¤åˆ¶](https://www.postgresql.org/docs/current/high-availability.html)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£ - é€»è¾‘å¤åˆ¶](https://www.postgresql.org/docs/current/logical-replication.html)

---

**æœ€åæ›´æ–°**: 2025-11-13
