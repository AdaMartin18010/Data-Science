# é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨

> **æ–‡æ¡£ç‰ˆæœ¬**: v2.0
> **æœ€åæ›´æ–°**: 2025-11-12
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²æ›´æ–°

---

## ğŸ“‹ ç›®å½•

- [é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨](#é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. åˆå¹¶æ¥æºä¸æ˜ å°„](#2-åˆå¹¶æ¥æºä¸æ˜ å°„)
  - [3. å¤åˆ¶æ¶æ„](#3-å¤åˆ¶æ¶æ„)
    - [3.1 ç‰©ç†å¤åˆ¶æœ€å°ç¤ºä¾‹](#31-ç‰©ç†å¤åˆ¶æœ€å°ç¤ºä¾‹)
      - [æ­¥éª¤1: ä¸»åº“é…ç½®](#æ­¥éª¤1-ä¸»åº“é…ç½®)
      - [æ­¥éª¤2: ä»åº“åˆå§‹åŒ–](#æ­¥éª¤2-ä»åº“åˆå§‹åŒ–)
      - [æ­¥éª¤3: ä»åº“é…ç½®](#æ­¥éª¤3-ä»åº“é…ç½®)
      - [æ­¥éª¤4: éªŒè¯å¤åˆ¶](#æ­¥éª¤4-éªŒè¯å¤åˆ¶)
    - [3.2 åŒæ­¥ç­–ç•¥ä¸ä»²è£](#32-åŒæ­¥ç­–ç•¥ä¸ä»²è£)
      - [synchronous\_commitçº§åˆ«](#synchronous_commitçº§åˆ«)
      - [synchronous\_standby\_namesé…ç½®](#synchronous_standby_namesé…ç½®)
  - [4. é«˜å¯ç”¨ç»„ä»¶](#4-é«˜å¯ç”¨ç»„ä»¶)
    - [4.1 Patroni åŸºæœ¬é…ç½®ç¤ºä¾‹](#41-patroni-åŸºæœ¬é…ç½®ç¤ºä¾‹)
      - [æ­¥éª¤1: å®‰è£…etcdé›†ç¾¤](#æ­¥éª¤1-å®‰è£…etcdé›†ç¾¤)
      - [æ­¥éª¤2: å®‰è£…Patroni](#æ­¥éª¤2-å®‰è£…patroni)
      - [æ­¥éª¤3: é…ç½®keepalivedï¼ˆVIPï¼‰](#æ­¥éª¤3-é…ç½®keepalivedvip)
      - [æ­¥éª¤4: é…ç½®pgpool-IIï¼ˆè¯»å†™åˆ†ç¦»ï¼‰](#æ­¥éª¤4-é…ç½®pgpool-iiè¯»å†™åˆ†ç¦»)
  - [5. æ•…éšœæ¼”ç»ƒ](#5-æ•…éšœæ¼”ç»ƒ)
    - [5.1 æ•…éšœåˆ‡æ¢SOPï¼ˆPatroniï¼‰](#51-æ•…éšœåˆ‡æ¢soppatroni)
      - [åœºæ™¯1: ä¸»åº“æ•…éšœï¼ˆè‡ªåŠ¨åˆ‡æ¢ï¼‰](#åœºæ™¯1-ä¸»åº“æ•…éšœè‡ªåŠ¨åˆ‡æ¢)
      - [åœºæ™¯2: æ‰‹åŠ¨åˆ‡æ¢ï¼ˆç»´æŠ¤åœºæ™¯ï¼‰](#åœºæ™¯2-æ‰‹åŠ¨åˆ‡æ¢ç»´æŠ¤åœºæ™¯)
      - [åœºæ™¯3: æ—§ä¸»åº“æ¢å¤](#åœºæ™¯3-æ—§ä¸»åº“æ¢å¤)
    - [5.2 åªè¯»å‰¯æœ¬å»¶è¿Ÿç›‘æ§](#52-åªè¯»å‰¯æœ¬å»¶è¿Ÿç›‘æ§)
    - [5.3 RTO/RPOè¯„ä¼°](#53-rtorpoè¯„ä¼°)
  - [6. åç»­æ•´åˆä»»åŠ¡](#6-åç»­æ•´åˆä»»åŠ¡)

---

## 1. æ¦‚è¿°

- ä¸»ä»ã€åŒæ­¥/å¼‚æ­¥å¤åˆ¶ã€æ•…éšœè½¬ç§»ã€è¯»å†™åˆ†ç¦»

## 2. åˆå¹¶æ¥æºä¸æ˜ å°„

- 1.1.5-åˆ†å¸ƒå¼ä¸é«˜å¯ç”¨.md
- 1.1.9-åˆ†å¸ƒå¼PostgreSQLæ¶æ„è®¾è®¡.md

## 3. å¤åˆ¶æ¶æ„

- ç‰©ç†å¤åˆ¶/é€»è¾‘å¤åˆ¶ã€åŒæ­¥ç­–ç•¥ã€ä»²è£ä¸æ¼‚ç§»

### 3.1 ç‰©ç†å¤åˆ¶æœ€å°ç¤ºä¾‹

```sql
-- ä¸»åº“åˆ›å»ºå¤åˆ¶æ§½ï¼ˆå¯é€‰ï¼Œä½†æ¨èé¿å…WALå›æ”¶è¿‡å¿«ï¼‰
SELECT * FROM pg_create_physical_replication_slot('replica1');
```

`postgresql.conf`ï¼ˆä¸»åº“ï¼‰ï¼š

```text
wal_level = replica
max_wal_senders = 10
max_replication_slots = 10
wal_keep_size = '1GB'
```

`pg_hba.conf`ï¼š

```text
host replication repl 10.0.0.0/24 md5
```

ä»åº“åˆå§‹åŒ–ï¼š

```bash
pg_basebackup -h primary -U repl -D $PGDATA -X stream -R -C -S replica1
```

**å®Œæ•´ç‰©ç†å¤åˆ¶é…ç½®æ­¥éª¤**ï¼š

#### æ­¥éª¤1: ä¸»åº“é…ç½®

```bash
# 1. åˆ›å»ºå¤åˆ¶ç”¨æˆ·
sudo -u postgres psql -c "
CREATE USER repl WITH REPLICATION PASSWORD 'secure_password';
"

# 2. é…ç½®postgresql.conf
sudo nano /etc/postgresql/18/main/postgresql.conf
```

```conf
# ä¸»åº“é…ç½®
wal_level = replica
max_wal_senders = 10
max_replication_slots = 10
wal_keep_size = 1GB
hot_standby = on
hot_standby_feedback = on
```

```bash
# 3. é…ç½®pg_hba.conf
sudo nano /etc/postgresql/18/main/pg_hba.conf
```

```conf
# å…è®¸å¤åˆ¶è¿æ¥
host replication repl 192.168.1.0/24 md5
```

```bash
# 4. é‡å¯PostgreSQL
sudo systemctl restart postgresql

# 5. åˆ›å»ºå¤åˆ¶æ§½
sudo -u postgres psql -c "
SELECT pg_create_physical_replication_slot('replica1');
SELECT pg_create_physical_replication_slot('replica2');
"
```

#### æ­¥éª¤2: ä»åº“åˆå§‹åŒ–

```bash
# 1. åœæ­¢ä»åº“ï¼ˆå¦‚æœå·²è¿è¡Œï¼‰
sudo systemctl stop postgresql

# 2. å¤‡ä»½æ•°æ®ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
sudo mv /var/lib/postgresql/18/main /var/lib/postgresql/18/main.backup

# 3. ä½¿ç”¨pg_basebackupåˆå§‹åŒ–
sudo -u postgres pg_basebackup \
    -h 192.168.1.10 \
    -U repl \
    -D /var/lib/postgresql/18/main \
    -X stream \
    -R \
    -C \
    -S replica1 \
    -P \
    -v

# å‚æ•°è¯´æ˜ï¼š
# -h: ä¸»åº“åœ°å€
# -U: å¤åˆ¶ç”¨æˆ·
# -D: æ•°æ®ç›®å½•
# -X stream: æµå¼ä¼ è¾“WAL
# -R: è‡ªåŠ¨é…ç½®recovery
# -C: åˆ›å»ºå¤åˆ¶æ§½
# -S: å¤åˆ¶æ§½åç§°
# -P: æ˜¾ç¤ºè¿›åº¦
# -v: è¯¦ç»†è¾“å‡º
```

#### æ­¥éª¤3: ä»åº“é…ç½®

```bash
# æ£€æŸ¥standby.signalæ–‡ä»¶ï¼ˆpg_basebackup -Rä¼šè‡ªåŠ¨åˆ›å»ºï¼‰
cat /var/lib/postgresql/18/main/standby.signal

# æ£€æŸ¥postgresql.auto.conf
cat /var/lib/postgresql/18/main/postgresql.auto.conf
```

```conf
# postgresql.auto.confï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
primary_conninfo = 'user=repl password=secure_password host=192.168.1.10 port=5432 sslmode=prefer sslcompression=0 gssencmode=prefer krbsrvname=postgres target_session_attrs=any'
primary_slot_name = 'replica1'
```

```bash
# 4. å¯åŠ¨ä»åº“
sudo systemctl start postgresql

# 5. æ£€æŸ¥å¤åˆ¶çŠ¶æ€
sudo -u postgres psql -c "
SELECT application_name, state, sync_state,
       pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS lag_bytes
FROM pg_stat_replication;
"
```

#### æ­¥éª¤4: éªŒè¯å¤åˆ¶

```sql
-- åœ¨ä¸»åº“åˆ›å»ºæµ‹è¯•æ•°æ®
CREATE TABLE test_replication (id SERIAL PRIMARY KEY, data TEXT);
INSERT INTO test_replication (data) VALUES ('test1'), ('test2');

-- åœ¨ä»åº“éªŒè¯ï¼ˆéœ€è¦ç­‰å¾…å¤åˆ¶ï¼‰
SELECT * FROM test_replication;
```

### 3.2 åŒæ­¥ç­–ç•¥ä¸ä»²è£

- `synchronous_commit`ï¼šlocal | remote_write | remote_apply | on | off
- `synchronous_standby_names`ï¼šæŒ‡å®šå€™é€‰ä¸æ³•å®šäººæ•°ï¼ˆQuorumï¼‰ï¼š

  ```text
  synchronous_standby_names = 'ANY 1 (node_b, node_c)'
  ```

- ä¸ä¸šåŠ¡SLAçš„RPO/RTOæƒè¡¡ï¼šå¼ºåŒæ­¥æå‡ä¸€è‡´æ€§ä½†æ‹‰é«˜å†™å»¶è¿Ÿã€‚

**åŒæ­¥ç­–ç•¥è¯¦è§£**ï¼š

#### synchronous_commitçº§åˆ«

```sql
-- 1. localï¼ˆé»˜è®¤ï¼Œå¼‚æ­¥ï¼‰
-- äº‹åŠ¡åœ¨æœ¬åœ°æäº¤å³å¯ï¼Œä¸ç­‰å¾…ä»åº“ç¡®è®¤
ALTER SYSTEM SET synchronous_commit = 'local';
-- ä¼˜ç‚¹ï¼šæ€§èƒ½æœ€å¥½ï¼Œå»¶è¿Ÿæœ€ä½
-- ç¼ºç‚¹ï¼šä¸»åº“æ•…éšœå¯èƒ½ä¸¢å¤±æ•°æ®

-- 2. remote_write
-- ç­‰å¾…WALå†™å…¥ä»åº“æ“ä½œç³»ç»Ÿç¼“å­˜
ALTER SYSTEM SET synchronous_commit = 'remote_write';
-- ä¼˜ç‚¹ï¼šæ€§èƒ½è¾ƒå¥½ï¼Œæ•°æ®å·²åˆ°è¾¾ä»åº“
-- ç¼ºç‚¹ï¼šä»åº“å´©æºƒä»å¯èƒ½ä¸¢å¤±æ•°æ®

-- 3. remote_apply
-- ç­‰å¾…ä»åº“åº”ç”¨WALï¼ˆæœ€ä¸¥æ ¼ï¼‰
ALTER SYSTEM SET synchronous_commit = 'remote_apply';
-- ä¼˜ç‚¹ï¼šæ•°æ®ä¸€è‡´æ€§æœ€å¼º
-- ç¼ºç‚¹ï¼šæ€§èƒ½æœ€å·®ï¼Œå»¶è¿Ÿæœ€é«˜

-- 4. onï¼ˆç­‰åŒäºremote_writeï¼‰
ALTER SYSTEM SET synchronous_commit = 'on';

-- 5. offï¼ˆç­‰åŒäºlocalï¼Œå·²åºŸå¼ƒï¼‰
-- ä¸æ¨èä½¿ç”¨
```

#### synchronous_standby_namesé…ç½®

```conf
# postgresql.conf

# æ–¹å¼1: æŒ‡å®šå•ä¸ªåŒæ­¥ä»åº“
synchronous_standby_names = 'replica1'

# æ–¹å¼2: æŒ‡å®šå¤šä¸ªå€™é€‰ä»åº“ï¼Œä»»æ„ä¸€ä¸ªç¡®è®¤å³å¯
synchronous_standby_names = 'ANY 1 (replica1, replica2, replica3)'

# æ–¹å¼3: æŒ‡å®šå¤šä¸ªå€™é€‰ä»åº“ï¼Œéœ€è¦2ä¸ªç¡®è®¤ï¼ˆQuorumï¼‰
synchronous_standby_names = 'ANY 2 (replica1, replica2, replica3)'

# æ–¹å¼4: æŒ‡å®šä¼˜å…ˆçº§ï¼ˆç¬¬ä¸€ä¸ªæ˜¯åŒæ­¥ï¼Œå…¶ä»–æ˜¯å€™é€‰ï¼‰
synchronous_standby_names = 'FIRST 1 (replica1, replica2, replica3)'

# æ–¹å¼5: éœ€è¦æ‰€æœ‰åˆ—å‡ºçš„ä»åº“ç¡®è®¤
synchronous_standby_names = 'ALL (replica1, replica2)'
```

**é…ç½®ç¤ºä¾‹**ï¼š

```bash
# ä¸»åº“é…ç½®ï¼ˆä¸‰èŠ‚ç‚¹ï¼š1ä¸»2ä»ï¼‰
sudo nano /etc/postgresql/18/main/postgresql.conf
```

```conf
# åŒæ­¥å¤åˆ¶é…ç½®
synchronous_commit = 'remote_write'
synchronous_standby_names = 'ANY 1 (replica1, replica2)'

# ä»åº“é…ç½®ï¼ˆåœ¨ä»åº“çš„postgresql.confä¸­ï¼‰
hot_standby = on
hot_standby_feedback = on
```

```bash
# é‡æ–°åŠ è½½é…ç½®
sudo systemctl reload postgresql

# éªŒè¯åŒæ­¥çŠ¶æ€
sudo -u postgres psql -c "
SELECT application_name, sync_state, sync_priority,
       pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS lag_bytes
FROM pg_stat_replication;
"
```

**RPO/RTOæƒè¡¡**ï¼š

| é…ç½® | RPO | RTO | å†™å»¶è¿Ÿ | é€‚ç”¨åœºæ™¯ |
|------|-----|-----|--------|---------|
| `local` | å¯èƒ½ä¸¢å¤±æ•°æ® | å¿« | æœ€ä½ | éå…³é”®ä¸šåŠ¡ |
| `remote_write` | å‡ ä¹ä¸º0 | ä¸­ç­‰ | ä½ | ä¸€èˆ¬ä¸šåŠ¡ |
| `remote_apply` | 0 | æ…¢ | é«˜ | å…³é”®ä¸šåŠ¡ |
| `ANY 1` | å‡ ä¹ä¸º0 | å¿« | ä½ | é«˜å¯ç”¨åœºæ™¯ |
| `ANY 2` | 0 | ä¸­ç­‰ | ä¸­ | å¼ºä¸€è‡´æ€§åœºæ™¯ |

## 4. é«˜å¯ç”¨ç»„ä»¶

- Patroniã€pgpool-IIã€pgbouncerã€keepalived

### 4.1 Patroni åŸºæœ¬é…ç½®ç¤ºä¾‹

```yaml
scope: pg
namespace: /service/pg
name: node_a

restapi:
  listen: 0.0.0.0:8008
  connect_address: node_a:8008

etcd:
  hosts: [etcd1:2379, etcd2:2379, etcd3:2379]

postgresql:
  listen: 0.0.0.0:5432
  connect_address: node_a:5432
  data_dir: /var/lib/postgresql/data
  bin_dir: /usr/lib/postgresql/16/bin
  parameters:
    wal_level: replica
    max_wal_senders: 10
    max_replication_slots: 10
    synchronous_commit: 'on'
    synchronous_standby_names: 'ANY 1 (node_b, node_c)'
  pg_hba:
    - host all all 0.0.0.0/0 md5
    - host replication repl 0.0.0.0/0 md5
  authentication:
    replication:
      username: repl
      password: "***"
    superuser:
      username: postgres
      password: "***"
```

**å®Œæ•´Patroniéƒ¨ç½²**ï¼š

#### æ­¥éª¤1: å®‰è£…etcdé›†ç¾¤

```bash
# åœ¨æ¯ä¸ªetcdèŠ‚ç‚¹ä¸Š
wget https://github.com/etcd-io/etcd/releases/download/v3.5.9/etcd-v3.5.9-linux-amd64.tar.gz
tar -xzf etcd-v3.5.9-linux-amd64.tar.gz
sudo mv etcd-v3.5.9-linux-amd64/etcd* /usr/local/bin/

# åˆ›å»ºetcdé…ç½®
sudo mkdir -p /etc/etcd
sudo nano /etc/etcd/etcd.conf
```

```conf
# etcd1é…ç½®
ETCD_NAME=etcd1
ETCD_DATA_DIR=/var/lib/etcd
ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
ETCD_ADVERTISE_CLIENT_URLS=http://etcd1:2379
ETCD_INITIAL_CLUSTER="etcd1=http://etcd1:2380,etcd2=http://etcd2:2380,etcd3=http://etcd3:2380"
ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster-1
ETCD_INITIAL_CLUSTER_STATE=new
```

```bash
# å¯åŠ¨etcd
sudo systemctl start etcd
sudo systemctl enable etcd

# éªŒè¯etcdé›†ç¾¤
etcdctl --endpoints=http://etcd1:2379,http://etcd2:2379,http://etcd3:2379 endpoint health
```

#### æ­¥éª¤2: å®‰è£…Patroni

```bash
# å®‰è£…Patroni
sudo pip3 install patroni[etcd]

# åˆ›å»ºPatronié…ç½®ç›®å½•
sudo mkdir -p /etc/patroni
sudo nano /etc/patroni/patroni.yml
```

```yaml
# å®Œæ•´Patronié…ç½®ç¤ºä¾‹
scope: postgres
namespace: /db/postgres
name: node1

restapi:
  listen: 0.0.0.0:8008
  connect_address: node1:8008
  authentication:
    username: admin
    password: admin_password

etcd:
  hosts: etcd1:2379, etcd2:2379, etcd3:2379
  protocol: http

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 30
    maximum_lag_on_failover: 1048576
    postgresql:
      use_pg_rewind: true
      parameters:
        wal_level: replica
        hot_standby: on
        max_connections: 100
        max_wal_senders: 10
        max_replication_slots: 10
        wal_keep_size: 1GB
        synchronous_commit: 'on'
        synchronous_standby_names: 'ANY 1 (node2, node3)'
  initdb:
    - encoding: UTF8
    - data-checksums
  pg_hba:
    - host replication repl 0.0.0.0/0 md5
    - host all all 0.0.0.0/0 md5
  users:
    admin:
      password: admin_password
      options:
        - createrole
        - createdb

postgresql:
  listen: 0.0.0.0:5432
  connect_address: node1:5432
  data_dir: /var/lib/postgresql/18/data
  bin_dir: /usr/lib/postgresql/18/bin
  pgpass: /var/lib/postgresql/.pgpass
  parameters:
    unix_socket_directories: '/var/run/postgresql'
  authentication:
    replication:
      username: repl
      password: repl_password
    superuser:
      username: postgres
      password: postgres_password

tags:
  nofailover: false
  noloadbalance: false
  clonefrom: false
  nosync: false
```

```bash
# åˆ›å»ºsystemdæœåŠ¡
sudo nano /etc/systemd/system/patroni.service
```

```ini
[Unit]
Description=Patroni PostgreSQL High Availability
After=syslog.target network.target

[Service]
Type=simple
User=postgres
Group=postgres
ExecStart=/usr/local/bin/patroni /etc/patroni/patroni.yml
KillMode=process
TimeoutSec=30
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

```bash
# å¯åŠ¨Patroni
sudo systemctl daemon-reload
sudo systemctl enable patroni
sudo systemctl start patroni

# æ£€æŸ¥çŠ¶æ€
patronictl -c /etc/patroni/patroni.yml list
```

#### æ­¥éª¤3: é…ç½®keepalivedï¼ˆVIPï¼‰

```bash
# å®‰è£…keepalived
sudo apt-get install -y keepalived

# ä¸»èŠ‚ç‚¹é…ç½®
sudo nano /etc/keepalived/keepalived.conf
```

```conf
vrrp_script chk_patroni {
    script "/usr/local/bin/check_patroni.sh"
    interval 2
    weight -2
    fall 3
    rise 2
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 101
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass keepalived_pass
    }
    virtual_ipaddress {
        192.168.1.100/24
    }
    track_script {
        chk_patroni
    }
}
```

```bash
# åˆ›å»ºæ£€æŸ¥è„šæœ¬
sudo nano /usr/local/bin/check_patroni.sh
```

```bash
#!/bin/bash
# æ£€æŸ¥Patroniæ˜¯å¦ä¸ºä¸»èŠ‚ç‚¹
if patronictl -c /etc/patroni/patroni.yml list | grep -q "Leader.*node1"; then
    exit 0
else
    exit 1
fi
```

```bash
sudo chmod +x /usr/local/bin/check_patroni.sh
sudo systemctl start keepalived
sudo systemctl enable keepalived
```

#### æ­¥éª¤4: é…ç½®pgpool-IIï¼ˆè¯»å†™åˆ†ç¦»ï¼‰

```bash
# å®‰è£…pgpool-II
sudo apt-get install -y pgpool2

# é…ç½®pgpool.conf
sudo nano /etc/pgpool2/pgpool.conf
```

```conf
listen_addresses = '*'
port = 5432
socket_dir = '/var/run/postgresql'

# åç«¯èŠ‚ç‚¹é…ç½®
backend_hostname0 = '192.168.1.100'  # VIP
backend_port0 = 5432
backend_weight0 = 1
backend_flag0 = 'ALLOW_TO_FAILOVER'

backend_hostname1 = 'node2'
backend_port1 = 5432
backend_weight1 = 1
backend_flag1 = 'ALLOW_TO_FAILOVER'

backend_hostname2 = 'node3'
backend_port2 = 5432
backend_weight2 = 1
backend_flag2 = 'ALLOW_TO_FAILOVER'

# è´Ÿè½½å‡è¡¡
load_balance_mode = on
master_slave_mode = on
master_slave_sub_mode = 'stream'

# æ•…éšœè½¬ç§»
failover_on_backend_error = on
```

```bash
# å¯åŠ¨pgpool-II
sudo systemctl start pgpool2
sudo systemctl enable pgpool2
```

è™šæ‹ŸIP/è´Ÿè½½å‡è¡¡ï¼š

- ä¸»å†™ VIPï¼š`keepalived` ç»‘å®šä¸»èŠ‚ç‚¹ï¼›
- è¯»è´Ÿè½½å‡è¡¡ï¼š`pgpool-II`/`haproxy` è½¬å‘è‡³åªè¯»å‰¯æœ¬ï¼›
- åº”ç”¨ä¾§å¼ºåˆ¶è¯»å†™åˆ†ç¦»ä¸é‡è¯•ç­–ç•¥ã€‚

## 5. æ•…éšœæ¼”ç»ƒ

- å¤±æ•ˆä¸æ¢å¤æµç¨‹ã€RTO/RPO è¯„ä¼°

### 5.1 æ•…éšœåˆ‡æ¢SOPï¼ˆPatroniï¼‰

1) äººä¸ºä¸‹çº¿ä¸»åº“ï¼š`patroni_ctl pause`ï¼ˆæ¼”ç»ƒæ—¶ï¼‰æˆ–åœæ­¢æœåŠ¡ï¼›
2) è§‚å¯ŸLeader é€‰ä¸¾æ—¥å¿—ä¸å¤åˆ¶å»¶è¿Ÿï¼Œç¡®è®¤æ–°ä¸»ï¼›
3) ä¸šåŠ¡ä¾§ï¼šå†™è¿æ¥æŒ‡å‘ä¸»å†™ VIPï¼Œè¯»è¿æ¥æ£€æŸ¥è¿æ¥æ± åˆ·æ–°ï¼›
4) æ—§ä¸»æ¢å¤ä¸ºå‰¯æœ¬ï¼šæ¸…ç†WAL å†²çªã€é‡æ–° `pg_basebackup` æˆ– `recovery` è¿½æ—¥å¿—ã€‚

**å®Œæ•´æ•…éšœåˆ‡æ¢æµç¨‹**ï¼š

#### åœºæ™¯1: ä¸»åº“æ•…éšœï¼ˆè‡ªåŠ¨åˆ‡æ¢ï¼‰

```bash
# 1. æ¨¡æ‹Ÿä¸»åº“æ•…éšœ
sudo systemctl stop patroni  # åœ¨ä¸»åº“èŠ‚ç‚¹

# 2. è§‚å¯ŸPatroniæ—¥å¿—ï¼ˆåœ¨ä»åº“èŠ‚ç‚¹ï¼‰
sudo journalctl -u patroni -f

# 3. æ£€æŸ¥æ–°ä¸»åº“é€‰ä¸¾
patronictl -c /etc/patroni/patroni.yml list

# 4. éªŒè¯VIPåˆ‡æ¢
ip addr show | grep 192.168.1.100

# 5. éªŒè¯åº”ç”¨è¿æ¥
psql -h 192.168.1.100 -U postgres -d mydb -c "SELECT pg_is_in_recovery();"
```

#### åœºæ™¯2: æ‰‹åŠ¨åˆ‡æ¢ï¼ˆç»´æŠ¤åœºæ™¯ï¼‰

```bash
# 1. æš‚åœå½“å‰ä¸»åº“
patronictl -c /etc/patroni/patroni.yml pause

# 2. æ‰‹åŠ¨åˆ‡æ¢
patronictl -c /etc/patroni/patroni.yml switchover

# 3. æ¢å¤æ—§ä¸»åº“ä¸ºä»åº“
patronictl -c /etc/patroni/patroni.yml resume

# 4. éªŒè¯åˆ‡æ¢ç»“æœ
patronictl -c /etc/patroni/patroni.yml list
```

#### åœºæ™¯3: æ—§ä¸»åº“æ¢å¤

```bash
# 1. æ£€æŸ¥æ—§ä¸»åº“çŠ¶æ€
sudo -u postgres psql -c "SELECT pg_is_in_recovery();"

# 2. å¦‚æœWALå†²çªï¼Œä½¿ç”¨pg_rewind
sudo systemctl stop patroni
sudo -u postgres /usr/lib/postgresql/18/bin/pg_rewind \
    --target-server="host=192.168.1.100 port=5432 user=postgres" \
    -D /var/lib/postgresql/18/data

# 3. é…ç½®æ¢å¤
sudo -u postgres cat > /var/lib/postgresql/18/data/standby.signal <<EOF
standby_mode = 'on'
primary_conninfo = 'host=192.168.1.100 port=5432 user=repl'
primary_slot_name = 'node1'
EOF

# 4. å¯åŠ¨Patroni
sudo systemctl start patroni

# 5. éªŒè¯æ¢å¤
patronictl -c /etc/patroni/patroni.yml list
```

### 5.2 åªè¯»å‰¯æœ¬å»¶è¿Ÿç›‘æ§

```sql
SELECT application_name, state, sync_state,
       pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS byte_lag
FROM pg_stat_replication;
```

**å®Œæ•´ç›‘æ§æŸ¥è¯¢**ï¼š

```sql
-- 1. å¤åˆ¶å»¶è¿Ÿç›‘æ§
SELECT
    application_name,
    client_addr,
    state,
    sync_state,
    sync_priority,
    pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) AS sent_lag_bytes,
    pg_wal_lsn_diff(sent_lsn, write_lsn) AS write_lag_bytes,
    pg_wal_lsn_diff(write_lsn, flush_lsn) AS flush_lag_bytes,
    pg_wal_lsn_diff(flush_lsn, replay_lsn) AS replay_lag_bytes,
    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS total_lag_bytes,
    EXTRACT(EPOCH FROM (now() - replay_lag_time)) AS replay_lag_seconds
FROM pg_stat_replication
ORDER BY total_lag_bytes DESC;

-- 2. å¤åˆ¶æ§½çŠ¶æ€
SELECT
    slot_name,
    slot_type,
    database,
    active,
    pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn) AS lag_bytes,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) AS lag_size
FROM pg_replication_slots;

-- 3. WALå‘é€ç»Ÿè®¡
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    state,
    sent_lsn,
    write_lsn,
    flush_lsn,
    replay_lsn,
    sync_state,
    sync_priority
FROM pg_stat_replication;

-- 4. å¤åˆ¶å»¶è¿Ÿå‘Šè­¦æŸ¥è¯¢
SELECT
    application_name,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn)) AS lag_size,
    EXTRACT(EPOCH FROM (now() - replay_lag_time)) AS lag_seconds,
    CASE
        WHEN pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) > 1073741824 THEN 'CRITICAL'  -- >1GB
        WHEN pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) > 536870912 THEN 'WARNING'   -- >512MB
        ELSE 'OK'
    END AS status
FROM pg_stat_replication;
```

**Prometheusç›‘æ§é…ç½®**ï¼š

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'postgres_replication'
    static_configs:
      - targets: ['postgres:5432']
    metrics_path: '/metrics'
    params:
      format: ['prometheus']
```

**Grafanaç›‘æ§é¢æ¿**ï¼š

```promql
# å¤åˆ¶å»¶è¿Ÿï¼ˆå­—èŠ‚ï¼‰
pg_replication_lag_bytes{instance="postgres:5432"}

# å¤åˆ¶å»¶è¿Ÿï¼ˆç§’ï¼‰
pg_replication_lag_seconds{instance="postgres:5432"}

# åŒæ­¥çŠ¶æ€
pg_replication_sync_state{instance="postgres:5432"}
```

### 5.3 RTO/RPOè¯„ä¼°

**RTOï¼ˆRecovery Time Objectiveï¼‰æ¢å¤æ—¶é—´ç›®æ ‡**ï¼š

```bash
# æµ‹é‡æ•…éšœåˆ‡æ¢æ—¶é—´
START_TIME=$(date +%s)
# æ‰§è¡Œæ•…éšœåˆ‡æ¢
sudo systemctl stop patroni
# ç­‰å¾…åˆ‡æ¢å®Œæˆ
while ! patronictl list | grep -q "Leader"; do
    sleep 1
done
END_TIME=$(date +%s)
RTO=$((END_TIME - START_TIME))
echo "RTO: ${RTO} seconds"
```

**RPOï¼ˆRecovery Point Objectiveï¼‰æ¢å¤ç‚¹ç›®æ ‡**ï¼š

```sql
-- æ£€æŸ¥æ•°æ®ä¸¢å¤±é£é™©
SELECT
    application_name,
    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS lag_bytes,
    CASE
        WHEN pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) = 0 THEN 'RPO = 0'
        ELSE 'RPO > 0'
    END AS rpo_status
FROM pg_stat_replication;
```

**æ•…éšœæ¼”ç»ƒè„šæœ¬**ï¼š

```bash
#!/bin/bash
# æ•…éšœæ¼”ç»ƒè„šæœ¬

echo "=== PostgreSQLæ•…éšœæ¼”ç»ƒ ==="

# 1. è®°å½•å½“å‰çŠ¶æ€
echo "1. è®°å½•å½“å‰çŠ¶æ€"
patronictl list > /tmp/before_failover.txt
cat /tmp/before_failover.txt

# 2. æ¨¡æ‹Ÿä¸»åº“æ•…éšœ
echo "2. æ¨¡æ‹Ÿä¸»åº“æ•…éšœ"
read -p "è¾“å…¥ä¸»åº“èŠ‚ç‚¹å: " PRIMARY_NODE
ssh $PRIMARY_NODE "sudo systemctl stop patroni"

# 3. ç­‰å¾…åˆ‡æ¢
echo "3. ç­‰å¾…æ•…éšœåˆ‡æ¢ï¼ˆæœ€å¤š60ç§’ï¼‰"
for i in {1..60}; do
    if patronictl list | grep -q "Leader"; then
        echo "æ•…éšœåˆ‡æ¢å®Œæˆ"
        break
    fi
    sleep 1
    echo -n "."
done

# 4. éªŒè¯æ–°ä¸»åº“
echo "4. éªŒè¯æ–°ä¸»åº“"
patronictl list > /tmp/after_failover.txt
NEW_LEADER=$(patronictl list | grep Leader | awk '{print $2}')
echo "æ–°ä¸»åº“: $NEW_LEADER"

# 5. éªŒè¯åº”ç”¨è¿æ¥
echo "5. éªŒè¯åº”ç”¨è¿æ¥"
psql -h 192.168.1.100 -U postgres -d mydb -c "SELECT pg_is_in_recovery();"

# 6. æ¢å¤æ—§ä¸»åº“
echo "6. æ¢å¤æ—§ä¸»åº“"
read -p "æ˜¯å¦æ¢å¤æ—§ä¸»åº“? (y/n): " RESTORE
if [ "$RESTORE" = "y" ]; then
    ssh $PRIMARY_NODE "sudo systemctl start patroni"
    sleep 10
    patronictl list
fi

echo "=== æ•…éšœæ¼”ç»ƒå®Œæˆ ==="
```

## 6. åç»­æ•´åˆä»»åŠ¡

- ç»Ÿä¸€æœ¯è¯­ï¼Œæä¾›å‚è€ƒæ‹“æ‰‘ä¸è„šæœ¬æ¸…å•
  - ä¸‰èŠ‚ç‚¹ï¼ˆ1ä¸»2ä»ï¼‰å¼ºä¸€è‡´ä¸ä»²è£ç¤ºæ„å›¾
  - Patroni + etcd + VIP + pgbouncer/pgpool-II æœ€å°è½åœ°è„šæœ¬
