# å•æœºéƒ¨ç½²ä¸é…ç½®

> **æ–‡æ¡£ç‰ˆæœ¬**: v2.0
> **æœ€åæ›´æ–°**: 2025-11-12
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²æ›´æ–°

---

## ğŸ“‹ ç›®å½•

- [å•æœºéƒ¨ç½²ä¸é…ç½®](#å•æœºéƒ¨ç½²ä¸é…ç½®)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. åˆå¹¶æ¥æºä¸æ˜ å°„](#2-åˆå¹¶æ¥æºä¸æ˜ å°„)
  - [3. å®‰è£…ä¸åˆå§‹åŒ–](#3-å®‰è£…ä¸åˆå§‹åŒ–)
    - [3.1 åŒ…ç®¡ç†å™¨å®‰è£…](#31-åŒ…ç®¡ç†å™¨å®‰è£…)
      - [Ubuntu/Debian](#ubuntudebian)
      - [CentOS/RHEL](#centosrhel)
      - [macOS](#macos)
    - [3.2 æºç ç¼–è¯‘å®‰è£…](#32-æºç ç¼–è¯‘å®‰è£…)
    - [3.3 æ•°æ®åº“åˆå§‹åŒ–](#33-æ•°æ®åº“åˆå§‹åŒ–)
    - [3.4 æœåŠ¡ç®¡ç†](#34-æœåŠ¡ç®¡ç†)
    - [3.5 éªŒè¯å®‰è£…](#35-éªŒè¯å®‰è£…)
  - [4. é…ç½®è¦ç‚¹](#4-é…ç½®è¦ç‚¹)
    - [4.1 postgresql.confåŸºç¡€é…ç½®](#41-postgresqlconfåŸºç¡€é…ç½®)
      - [è¿æ¥è®¾ç½®](#è¿æ¥è®¾ç½®)
      - [å†…å­˜è®¾ç½®](#å†…å­˜è®¾ç½®)
      - [I/Oè®¾ç½®](#ioè®¾ç½®)
      - [WALè®¾ç½®](#walè®¾ç½®)
      - [æ—¥å¿—è®¾ç½®](#æ—¥å¿—è®¾ç½®)
    - [4.2 pg\_hba.confè®¤è¯é…ç½®](#42-pg_hbaconfè®¤è¯é…ç½®)
      - [è®¤è¯è§„åˆ™ç¤ºä¾‹](#è®¤è¯è§„åˆ™ç¤ºä¾‹)
      - [è®¤è¯æ–¹æ³•è¯´æ˜](#è®¤è¯æ–¹æ³•è¯´æ˜)
    - [4.3 ç³»ç»Ÿå‚æ•°ä¼˜åŒ–](#43-ç³»ç»Ÿå‚æ•°ä¼˜åŒ–)
      - [Linuxå†…æ ¸å‚æ•°](#linuxå†…æ ¸å‚æ•°)
      - [èµ„æºé™åˆ¶](#èµ„æºé™åˆ¶)
    - [4.4 é…ç½®éªŒè¯](#44-é…ç½®éªŒè¯)
  - [5. å®‰å…¨ä¸åˆè§„](#5-å®‰å…¨ä¸åˆè§„)
    - [5.1 ç”¨æˆ·å’Œæƒé™ç®¡ç†](#51-ç”¨æˆ·å’Œæƒé™ç®¡ç†)
    - [5.2 SSL/TLSåŠ å¯†](#52-ssltlsåŠ å¯†)
    - [5.3 å®¡è®¡æ—¥å¿—](#53-å®¡è®¡æ—¥å¿—)
    - [5.4 è¡Œçº§å®‰å…¨ç­–ç•¥](#54-è¡Œçº§å®‰å…¨ç­–ç•¥)
    - [5.5 æ•°æ®åŠ å¯†](#55-æ•°æ®åŠ å¯†)
    - [5.6 å®‰å…¨æœ€ä½³å®è·µ](#56-å®‰å…¨æœ€ä½³å®è·µ)
  - [6. PostgreSQL 18ç”Ÿäº§çº§é…ç½®](#6-postgresql-18ç”Ÿäº§çº§é…ç½®)
    - [6.1 å°è§„æ¨¡éƒ¨ç½²é…ç½®ï¼ˆ\<10GBæ•°æ®ï¼Œ\<100è¿æ¥ï¼‰](#61-å°è§„æ¨¡éƒ¨ç½²é…ç½®10gbæ•°æ®100è¿æ¥)
    - [6.2 ä¸­è§„æ¨¡éƒ¨ç½²é…ç½®ï¼ˆ10-100GBæ•°æ®ï¼Œ100-500è¿æ¥ï¼‰](#62-ä¸­è§„æ¨¡éƒ¨ç½²é…ç½®10-100gbæ•°æ®100-500è¿æ¥)
    - [6.3 å¤§è§„æ¨¡éƒ¨ç½²é…ç½®ï¼ˆ\>100GBæ•°æ®ï¼Œ\>500è¿æ¥ï¼‰](#63-å¤§è§„æ¨¡éƒ¨ç½²é…ç½®100gbæ•°æ®500è¿æ¥)
    - [6.4 PostgreSQL 18æ–°ç‰¹æ€§é…ç½®](#64-postgresql-18æ–°ç‰¹æ€§é…ç½®)
  - [7. æ•…éšœæ’æŸ¥ä¸è¯Šæ–­](#7-æ•…éšœæ’æŸ¥ä¸è¯Šæ–­)
    - [7.1 å¯åŠ¨é—®é¢˜æ’æŸ¥](#71-å¯åŠ¨é—®é¢˜æ’æŸ¥)
    - [7.2 è¿æ¥é—®é¢˜è¯Šæ–­](#72-è¿æ¥é—®é¢˜è¯Šæ–­)
    - [7.3 æ€§èƒ½é—®é¢˜è¯Šæ–­](#73-æ€§èƒ½é—®é¢˜è¯Šæ–­)
    - [7.4 æ—¥å¿—åˆ†ææ–¹æ³•](#74-æ—¥å¿—åˆ†ææ–¹æ³•)
  - [8. æ€§èƒ½ä¼˜åŒ–å®è·µ](#8-æ€§èƒ½ä¼˜åŒ–å®è·µ)
    - [8.1 ç³»ç»Ÿçº§ä¼˜åŒ–](#81-ç³»ç»Ÿçº§ä¼˜åŒ–)
    - [8.2 æ•°æ®åº“å‚æ•°ä¼˜åŒ–](#82-æ•°æ®åº“å‚æ•°ä¼˜åŒ–)
    - [8.3 å­˜å‚¨ä¼˜åŒ–](#83-å­˜å‚¨ä¼˜åŒ–)
    - [8.4 ç½‘ç»œä¼˜åŒ–](#84-ç½‘ç»œä¼˜åŒ–)
  - [9. ç›‘æ§ä¸å‘Šè­¦é…ç½®](#9-ç›‘æ§ä¸å‘Šè­¦é…ç½®)
    - [9.1 å…³é”®æŒ‡æ ‡ç›‘æ§](#91-å…³é”®æŒ‡æ ‡ç›‘æ§)
    - [9.2 Prometheusç›‘æ§é…ç½®](#92-prometheusç›‘æ§é…ç½®)
    - [9.3 å‘Šè­¦è§„åˆ™é…ç½®](#93-å‘Šè­¦è§„åˆ™é…ç½®)
  - [10. å®‰å…¨åŠ å›ºè¯¦ç»†æŒ‡å—](#10-å®‰å…¨åŠ å›ºè¯¦ç»†æŒ‡å—)
    - [10.1 SSL/TLSå®Œæ•´é…ç½®](#101-ssltlså®Œæ•´é…ç½®)
    - [10.2 é˜²ç«å¢™è§„åˆ™é…ç½®](#102-é˜²ç«å¢™è§„åˆ™é…ç½®)
    - [10.3 å®¡è®¡æ—¥å¿—é…ç½®](#103-å®¡è®¡æ—¥å¿—é…ç½®)
    - [10.4 è¡Œçº§å®‰å…¨ç­–ç•¥é…ç½®](#104-è¡Œçº§å®‰å…¨ç­–ç•¥é…ç½®)
  - [11. åç»­æ•´åˆä»»åŠ¡](#11-åç»­æ•´åˆä»»åŠ¡)
    - [11.1 ä¸åŒæ“ä½œç³»ç»Ÿå·®å¼‚](#111-ä¸åŒæ“ä½œç³»ç»Ÿå·®å¼‚)
      - [Ubuntu/Debian](#ubuntudebian-1)
      - [CentOS/RHEL](#centosrhel-1)
      - [macOS (Homebrew)](#macos-homebrew)
    - [11.2 ç³»ç»Ÿå‚æ•°æ¨èè¡¨](#112-ç³»ç»Ÿå‚æ•°æ¨èè¡¨)
    - [11.3 æ€§èƒ½è°ƒä¼˜æ£€æŸ¥æ¸…å•](#113-æ€§èƒ½è°ƒä¼˜æ£€æŸ¥æ¸…å•)
  - [12. äº¤å‰å¼•ç”¨](#12-äº¤å‰å¼•ç”¨)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
      - [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
      - [æ ¸å¿ƒè¯¾ç¨‹](#æ ¸å¿ƒè¯¾ç¨‹)
      - [è¿ç»´å®è·µ](#è¿ç»´å®è·µ)
      - [é«˜çº§ç‰¹æ€§](#é«˜çº§ç‰¹æ€§)

---

## 1. æ¦‚è¿°

- å®‰è£…ã€åˆå§‹åŒ–ã€åŸºç¡€é…ç½®ä¸å®‰å…¨åŠ å›º

## 2. åˆå¹¶æ¥æºä¸æ˜ å°„

- 1.1.15-äº‘åŸç”Ÿä¸å®¹å™¨åŒ–éƒ¨ç½².mdï¼ˆåŸºç¡€é…ç½®ç‰‡æ®µï¼‰
- 1.1.16-æ€§èƒ½è°ƒä¼˜ä¸ç›‘æ§-æ‰©å……ç‰ˆ.mdï¼ˆç›¸å…³é…ç½®ï¼‰

## 3. å®‰è£…ä¸åˆå§‹åŒ–

- åŒ…ç®¡ç†å™¨/æºç å®‰è£…ï¼Œinitdbï¼Œpg_ctl/æœåŠ¡ç®¡ç†

### 3.1 åŒ…ç®¡ç†å™¨å®‰è£…

#### Ubuntu/Debian

```bash
# æ·»åŠ PostgreSQLå®˜æ–¹APTä»“åº“
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
sudo apt-get update

# å®‰è£…PostgreSQL 18
sudo apt-get install -y postgresql-18 postgresql-contrib-18

# å¯åŠ¨æœåŠ¡
sudo systemctl start postgresql
sudo systemctl enable postgresql

# æ£€æŸ¥çŠ¶æ€
sudo systemctl status postgresql
```

#### CentOS/RHEL

```bash
# å®‰è£…PostgreSQLå®˜æ–¹YUMä»“åº“
sudo dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-9-x86_64/pgdg-redhat-repo-latest.noarch.rpm

# å®‰è£…PostgreSQL 18
sudo dnf install -y postgresql18-server postgresql18-contrib

# åˆå§‹åŒ–æ•°æ®åº“
sudo /usr/pgsql-18/bin/postgresql-18-setup initdb

# å¯åŠ¨æœåŠ¡
sudo systemctl start postgresql-18
sudo systemctl enable postgresql-18
```

#### macOS

```bash
# ä½¿ç”¨Homebrewå®‰è£…
brew install postgresql@18

# å¯åŠ¨æœåŠ¡
brew services start postgresql@18

# åˆ›å»ºæ•°æ®åº“
createdb mydb
```

### 3.2 æºç ç¼–è¯‘å®‰è£…

```bash
# 1. å®‰è£…ä¾èµ–
sudo apt-get install -y build-essential libreadline-dev zlib1g-dev libssl-dev libxml2-dev libxslt1-dev

# 2. ä¸‹è½½æºç 
wget https://ftp.postgresql.org/pub/source/v18.0/postgresql-18.0.tar.gz
tar -xzf postgresql-18.0.tar.gz
cd postgresql-18.0

# 3. é…ç½®ç¼–è¯‘é€‰é¡¹
./configure --prefix=/usr/local/pgsql \
    --with-openssl \
    --with-libxml \
    --with-libxslt \
    --enable-nls \
    --with-python \
    --with-perl

# 4. ç¼–è¯‘å’Œå®‰è£…
make -j$(nproc)
sudo make install

# 5. åˆ›å»ºæ•°æ®ç›®å½•
sudo mkdir -p /usr/local/pgsql/data
sudo chown postgres:postgres /usr/local/pgsql/data

# 6. åˆå§‹åŒ–æ•°æ®åº“
sudo -u postgres /usr/local/pgsql/bin/initdb -D /usr/local/pgsql/data
```

### 3.3 æ•°æ®åº“åˆå§‹åŒ–

```bash
# ä½¿ç”¨initdbåˆå§‹åŒ–æ•°æ®åº“
sudo -u postgres /usr/pgsql-18/bin/initdb -D /var/lib/pgsql/18/data \
    --locale=zh_CN.UTF-8 \
    --encoding=UTF8 \
    --data-checksums

# åˆå§‹åŒ–å‚æ•°è¯´æ˜ï¼š
# -D: æ•°æ®ç›®å½•
# --locale: åŒºåŸŸè®¾ç½®
# --encoding: å­—ç¬¦ç¼–ç 
# --data-checksums: å¯ç”¨æ•°æ®æ ¡éªŒå’Œï¼ˆPostgreSQL 9.3+ï¼‰
```

### 3.4 æœåŠ¡ç®¡ç†

```bash
# ä½¿ç”¨systemdç®¡ç†ï¼ˆæ¨èï¼‰
sudo systemctl start postgresql-18
sudo systemctl stop postgresql-18
sudo systemctl restart postgresql-18
sudo systemctl status postgresql-18
sudo systemctl enable postgresql-18

# ä½¿ç”¨pg_ctlç®¡ç†
sudo -u postgres /usr/pgsql-18/bin/pg_ctl -D /var/lib/pgsql/18/data start
sudo -u postgres /usr/pgsql-18/bin/pg_ctl -D /var/lib/pgsql/18/data stop
sudo -u postgres /usr/pgsql-18/bin/pg_ctl -D /var/lib/pgsql/18/data restart
sudo -u postgres /usr/pgsql-18/bin/pg_ctl -D /var/lib/pgsql/18/data status
```

### 3.5 éªŒè¯å®‰è£…

```bash
# æ£€æŸ¥PostgreSQLç‰ˆæœ¬
psql --version

# è¿æ¥åˆ°æ•°æ®åº“
sudo -u postgres psql

# åœ¨psqlä¸­æ‰§è¡Œ
SELECT version();
\conninfo
\l
```

## 4. é…ç½®è¦ç‚¹

- postgresql.conf / pg_hba.confï¼Œå†…å­˜/IO/è¿æ¥æ•°

### 4.1 postgresql.confåŸºç¡€é…ç½®

```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo nano /var/lib/pgsql/18/data/postgresql.conf
```

#### è¿æ¥è®¾ç½®

```conf
# ç›‘å¬åœ°å€ï¼ˆå…è®¸æ‰€æœ‰IPè¿æ¥ï¼‰
listen_addresses = '*'

# ç«¯å£
port = 5432

# æœ€å¤§è¿æ¥æ•°
max_connections = 100

# è¶…çº§ç”¨æˆ·ä¿ç•™è¿æ¥æ•°
superuser_reserved_connections = 3
```

#### å†…å­˜è®¾ç½®

```conf
# å…±äº«ç¼“å†²åŒºï¼ˆå»ºè®®ä¸ºç³»ç»Ÿå†…å­˜çš„25%ï¼‰
shared_buffers = 256MB

# å·¥ä½œå†…å­˜ï¼ˆç”¨äºæ’åºã€å“ˆå¸Œç­‰æ“ä½œï¼‰
work_mem = 4MB

# ç»´æŠ¤å·¥ä½œå†…å­˜ï¼ˆç”¨äºVACUUMã€CREATE INDEXç­‰ï¼‰
maintenance_work_mem = 64MB

# æœ‰æ•ˆç¼“å­˜å¤§å°ï¼ˆå»ºè®®ä¸ºç³»ç»Ÿå†…å­˜çš„50-75%ï¼‰
effective_cache_size = 1GB
```

#### I/Oè®¾ç½®

```conf
# éšæœºé¡µé¢æˆæœ¬ï¼ˆSSDå»ºè®®1.1ï¼ŒHDDå»ºè®®4.0ï¼‰
random_page_cost = 1.1

# æœ‰æ•ˆI/Oå¹¶å‘æ•°ï¼ˆSSDå»ºè®®200ï¼ŒHDDå»ºè®®2ï¼‰
effective_io_concurrency = 200

# å¼‚æ­¥I/Oï¼ˆPostgreSQL 18æ–°ç‰¹æ€§ï¼‰
backend_flush_after = 0
```

#### WALè®¾ç½®

```conf
# WALçº§åˆ«
wal_level = replica

# æœ€å°WALå¤§å°
min_wal_size = 1GB

# æœ€å¤§WALå¤§å°
max_wal_size = 4GB

# æ£€æŸ¥ç‚¹å®Œæˆç›®æ ‡
checkpoint_completion_target = 0.9
```

#### æ—¥å¿—è®¾ç½®

```conf
# æ—¥å¿—æ”¶é›†
logging_collector = on

# æ—¥å¿—ç›®å½•
log_directory = 'log'

# æ—¥å¿—æ–‡ä»¶å
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'

# æ—¥å¿—è½®è½¬
log_rotation_age = 1d
log_rotation_size = 100MB

# æ…¢æŸ¥è¯¢æ—¥å¿—
log_min_duration_statement = 500

# è®°å½•æ£€æŸ¥ç‚¹
log_checkpoints = on

# è®°å½•è¿æ¥
log_connections = on
log_disconnections = on
```

### 4.2 pg_hba.confè®¤è¯é…ç½®

```bash
# ç¼–è¾‘è®¤è¯é…ç½®æ–‡ä»¶
sudo nano /var/lib/pgsql/18/data/pg_hba.conf
```

#### è®¤è¯è§„åˆ™ç¤ºä¾‹

```conf
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# æœ¬åœ°è¿æ¥ä½¿ç”¨peerè®¤è¯
local   all             all                                     peer

# IPv4æœ¬åœ°è¿æ¥ä½¿ç”¨md5è®¤è¯
host    all             all             127.0.0.1/32            md5

# IPv4å±€åŸŸç½‘è¿æ¥ä½¿ç”¨md5è®¤è¯
host    all             all             192.168.1.0/24          md5

# å¤åˆ¶è¿æ¥ä½¿ç”¨md5è®¤è¯
host    replication     replicator      192.168.1.0/24          md5

# SSLè¿æ¥ä½¿ç”¨scram-sha-256è®¤è¯
hostssl all             all             0.0.0.0/0               scram-sha-256
```

#### è®¤è¯æ–¹æ³•è¯´æ˜

- **trust**: æ— æ¡ä»¶å…è®¸è¿æ¥ï¼ˆä»…ç”¨äºæœ¬åœ°å¼€å‘ï¼‰
- **md5**: ä½¿ç”¨MD5åŠ å¯†å¯†ç 
- **scram-sha-256**: ä½¿ç”¨SCRAM-SHA-256åŠ å¯†å¯†ç ï¼ˆæ¨èï¼‰
- **peer**: ä½¿ç”¨æ“ä½œç³»ç»Ÿç”¨æˆ·åè®¤è¯ï¼ˆä»…æœ¬åœ°ï¼‰
- **cert**: ä½¿ç”¨SSLå®¢æˆ·ç«¯è¯ä¹¦è®¤è¯

### 4.3 ç³»ç»Ÿå‚æ•°ä¼˜åŒ–

#### Linuxå†…æ ¸å‚æ•°

```bash
# ç¼–è¾‘sysctl.conf
sudo nano /etc/sysctl.conf

# æ·»åŠ ä»¥ä¸‹å‚æ•°
# å…±äº«å†…å­˜è®¾ç½®
kernel.shmmax = 68719476736
kernel.shmall = 4294967296

# ç½‘ç»œå‚æ•°
net.core.somaxconn = 4096
net.ipv4.tcp_max_syn_backlog = 4096
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl = 15

# è™šæ‹Ÿå†…å­˜å‚æ•°
vm.swappiness = 1
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5

# åº”ç”¨é…ç½®
sudo sysctl -p
```

#### èµ„æºé™åˆ¶

```bash
# ç¼–è¾‘limits.conf
sudo nano /etc/security/limits.conf

# æ·»åŠ ä»¥ä¸‹é™åˆ¶
postgres soft nofile 65536
postgres hard nofile 65536
postgres soft nproc 32768
postgres hard nproc 32768
```

### 4.4 é…ç½®éªŒè¯

```sql
-- æŸ¥çœ‹å½“å‰é…ç½®
SHOW shared_buffers;
SHOW max_connections;
SHOW work_mem;

-- æŸ¥çœ‹æ‰€æœ‰é…ç½®
SELECT name, setting, unit, source FROM pg_settings ORDER BY name;

-- é‡æ–°åŠ è½½é…ç½®ï¼ˆæ— éœ€é‡å¯ï¼‰
SELECT pg_reload_conf();
```

## 5. å®‰å…¨ä¸åˆè§„

- è®¤è¯æ–¹å¼ã€åŠ å¯†ã€å®¡è®¡

### 5.1 ç”¨æˆ·å’Œæƒé™ç®¡ç†

```sql
-- åˆ›å»ºç”¨æˆ·
CREATE USER app_user WITH PASSWORD 'secure_password';

-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE app_db OWNER app_user;

-- æˆäºˆæƒé™
GRANT CONNECT ON DATABASE app_db TO app_user;
GRANT USAGE ON SCHEMA public TO app_user;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_user;

-- è®¾ç½®é»˜è®¤æƒé™
ALTER DEFAULT PRIVILEGES IN SCHEMA public
    GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO app_user;
```

### 5.2 SSL/TLSåŠ å¯†

```bash
# ç”ŸæˆSSLè¯ä¹¦
sudo -u postgres openssl req -new -x509 -days 365 -nodes \
    -text -out /var/lib/pgsql/18/data/server.crt \
    -keyout /var/lib/pgsql/18/data/server.key \
    -subj "/CN=postgresql-server"

# è®¾ç½®æƒé™
sudo chmod 600 /var/lib/pgsql/18/data/server.key
sudo chown postgres:postgres /var/lib/pgsql/18/data/server.key
sudo chown postgres:postgres /var/lib/pgsql/18/data/server.crt
```

```conf
# postgresql.confä¸­å¯ç”¨SSL
ssl = on
ssl_cert_file = 'server.crt'
ssl_key_file = 'server.key'
```

### 5.3 å®¡è®¡æ—¥å¿—

```conf
# postgresql.confä¸­å¯ç”¨å®¡è®¡
log_statement = 'all'  # è®°å½•æ‰€æœ‰SQLè¯­å¥
# æˆ–
log_statement = 'ddl'  # ä»…è®°å½•DDLè¯­å¥
log_statement = 'mod'  # è®°å½•ä¿®æ”¹æ•°æ®çš„è¯­å¥

# è®°å½•å‚æ•°å˜æ›´
log_parameter_max_length = 1024
```

### 5.4 è¡Œçº§å®‰å…¨ç­–ç•¥

```sql
-- å¯ç”¨è¡Œçº§å®‰å…¨
ALTER TABLE sensitive_data ENABLE ROW LEVEL SECURITY;

-- åˆ›å»ºç­–ç•¥
CREATE POLICY user_data_policy ON sensitive_data
    FOR ALL
    TO app_user
    USING (user_id = current_user_id());
```

### 5.5 æ•°æ®åŠ å¯†

```sql
-- ä½¿ç”¨pgcryptoæ‰©å±•åŠ å¯†æ•°æ®
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- åŠ å¯†å­˜å‚¨
INSERT INTO users (username, password_hash)
VALUES ('user1', crypt('password123', gen_salt('bf')));

-- éªŒè¯å¯†ç 
SELECT * FROM users
WHERE username = 'user1'
AND password_hash = crypt('password123', password_hash);
```

### 5.6 å®‰å…¨æœ€ä½³å®è·µ

```bash
# 1. å®šæœŸæ›´æ–°PostgreSQL
sudo apt-get update && sudo apt-get upgrade postgresql-18

# 2. é™åˆ¶ç½‘ç»œè®¿é—®
# åœ¨pg_hba.confä¸­ä»…å…è®¸å¿…è¦çš„IPè®¿é—®

# 3. ä½¿ç”¨å¼ºå¯†ç ç­–ç•¥
# åœ¨åº”ç”¨å±‚æˆ–ä½¿ç”¨passwordcheckæ‰©å±•

# 4. å®šæœŸå¤‡ä»½
# é…ç½®è‡ªåŠ¨å¤‡ä»½è„šæœ¬

# 5. ç›‘æ§å¼‚å¸¸è®¿é—®
# ä½¿ç”¨pg_stat_statementså’Œæ—¥å¿—åˆ†æ
```

## 6. PostgreSQL 18ç”Ÿäº§çº§é…ç½®

### 6.1 å°è§„æ¨¡éƒ¨ç½²é…ç½®ï¼ˆ<10GBæ•°æ®ï¼Œ<100è¿æ¥ï¼‰

**é€‚ç”¨åœºæ™¯**: å°å‹åº”ç”¨ã€å¼€å‘æµ‹è¯•ç¯å¢ƒã€ä¸ªäººé¡¹ç›®

**å®Œæ•´é…ç½®ç¤ºä¾‹**:

```conf
# postgresql.conf - å°è§„æ¨¡éƒ¨ç½²é…ç½®ï¼ˆ2GBå†…å­˜ç³»ç»Ÿï¼‰

# ============================================
# è¿æ¥è®¾ç½®
# ============================================
listen_addresses = '*'
port = 5432
max_connections = 100
superuser_reserved_connections = 3

# ============================================
# å†…å­˜è®¾ç½®
# ============================================
shared_buffers = 512MB              # ç³»ç»Ÿå†…å­˜çš„25%
effective_cache_size = 1GB          # ç³»ç»Ÿå†…å­˜çš„50%
work_mem = 4MB                      # æ¯ä¸ªæ“ä½œçš„å·¥ä½œå†…å­˜
maintenance_work_mem = 64MB         # ç»´æŠ¤æ“ä½œçš„å·¥ä½œå†…å­˜
temp_buffers = 8MB                 # ä¸´æ—¶ç¼“å†²åŒº

# ============================================
# WALè®¾ç½®
# ============================================
wal_level = replica
min_wal_size = 512MB
max_wal_size = 2GB
checkpoint_completion_target = 0.9
checkpoint_timeout = 15min
wal_compression = on                # PostgreSQL 18: WALå‹ç¼©

# ============================================
# I/Oè®¾ç½®ï¼ˆPostgreSQL 18å¼‚æ­¥I/Oï¼‰
# ============================================
random_page_cost = 1.1              # SSD
effective_io_concurrency = 200      # SSD
io_method = aio                     # PostgreSQL 18: å¼‚æ­¥I/O
io_combine_limit = 64               # PostgreSQL 18: I/Oåˆå¹¶é™åˆ¶
maintenance_io_workers = 2          # PostgreSQL 18: ç»´æŠ¤I/Oå·¥ä½œè¿›ç¨‹

# ============================================
# æŸ¥è¯¢ä¼˜åŒ–
# ============================================
default_statistics_target = 100
random_page_cost = 1.1
effective_cache_size = 1GB

# ============================================
# æ—¥å¿—è®¾ç½®
# ============================================
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000  # è®°å½•è¶…è¿‡1ç§’çš„æŸ¥è¯¢
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0

# ============================================
# è‡ªåŠ¨æ¸…ç†
# ============================================
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
```

**pg_hba.confé…ç½®**:

```conf
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# æœ¬åœ°è¿æ¥
local   all             all                                     peer

# IPv4æœ¬åœ°è¿æ¥
host    all             all             127.0.0.1/32            scram-sha-256

# å±€åŸŸç½‘è¿æ¥ï¼ˆä»…å…è®¸ç‰¹å®šç½‘æ®µï¼‰
host    all             all             192.168.1.0/24          scram-sha-256

# SSLè¿æ¥ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
hostssl all             all             0.0.0.0/0               scram-sha-256
```

**ç³»ç»Ÿå‚æ•°é…ç½®**:

```bash
# /etc/sysctl.conf
# å…±äº«å†…å­˜ï¼ˆ2GBç³»ç»Ÿï¼‰
kernel.shmmax = 2147483648
kernel.shmall = 524288

# ç½‘ç»œå‚æ•°
net.core.somaxconn = 1024
net.ipv4.tcp_max_syn_backlog = 2048
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl = 15

# è™šæ‹Ÿå†…å­˜
vm.swappiness = 1
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5

# æ–‡ä»¶ç³»ç»Ÿ
fs.file-max = 2097152
```

### 6.2 ä¸­è§„æ¨¡éƒ¨ç½²é…ç½®ï¼ˆ10-100GBæ•°æ®ï¼Œ100-500è¿æ¥ï¼‰

**é€‚ç”¨åœºæ™¯**: ä¸­å‹åº”ç”¨ã€ç”Ÿäº§ç¯å¢ƒã€å¤šç”¨æˆ·ç³»ç»Ÿ

**å®Œæ•´é…ç½®ç¤ºä¾‹**:

```conf
# postgresql.conf - ä¸­è§„æ¨¡éƒ¨ç½²é…ç½®ï¼ˆ8GBå†…å­˜ç³»ç»Ÿï¼‰

# ============================================
# è¿æ¥è®¾ç½®
# ============================================
listen_addresses = '*'
port = 5432
max_connections = 300
superuser_reserved_connections = 5

# ============================================
# å†…å­˜è®¾ç½®
# ============================================
shared_buffers = 2GB                # ç³»ç»Ÿå†…å­˜çš„25%
effective_cache_size = 6GB          # ç³»ç»Ÿå†…å­˜çš„75%
work_mem = 16MB                     # æ¯ä¸ªæ“ä½œçš„å·¥ä½œå†…å­˜
maintenance_work_mem = 512MB        # ç»´æŠ¤æ“ä½œçš„å·¥ä½œå†…å­˜
temp_buffers = 16MB                 # ä¸´æ—¶ç¼“å†²åŒº
max_prepared_transactions = 100     # é¢„å‡†å¤‡äº‹åŠ¡

# ============================================
# WALè®¾ç½®
# ============================================
wal_level = replica
min_wal_size = 1GB
max_wal_size = 4GB
checkpoint_completion_target = 0.9
checkpoint_timeout = 15min
wal_compression = on
wal_buffers = 16MB                  # WALç¼“å†²åŒº

# ============================================
# I/Oè®¾ç½®ï¼ˆPostgreSQL 18å¼‚æ­¥I/Oï¼‰
# ============================================
random_page_cost = 1.1
effective_io_concurrency = 200
io_method = aio                     # PostgreSQL 18: å¼‚æ­¥I/O
io_combine_limit = 128              # PostgreSQL 18: I/Oåˆå¹¶é™åˆ¶
maintenance_io_workers = 4          # PostgreSQL 18: ç»´æŠ¤I/Oå·¥ä½œè¿›ç¨‹
max_io_workers = 10                 # PostgreSQL 18: æœ€å¤§I/Oå·¥ä½œè¿›ç¨‹

# ============================================
# æŸ¥è¯¢ä¼˜åŒ–
# ============================================
default_statistics_target = 100
random_page_cost = 1.1
effective_cache_size = 6GB
enable_hashjoin = on
enable_mergejoin = on
enable_nestloop = on

# ============================================
# å¹¶è¡ŒæŸ¥è¯¢ï¼ˆPostgreSQL 18å¢å¼ºï¼‰
# ============================================
max_parallel_workers_per_gather = 4
max_parallel_workers = 8
max_parallel_maintenance_workers = 4
parallel_leader_participation = on  # PostgreSQL 18: Leaderå‚ä¸å·¥ä½œ

# ============================================
# æ—¥å¿—è®¾ç½®
# ============================================
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 500   # è®°å½•è¶…è¿‡500msçš„æŸ¥è¯¢
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# ============================================
# è‡ªåŠ¨æ¸…ç†
# ============================================
autovacuum = on
autovacuum_max_workers = 4
autovacuum_naptime = 30s
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05
autovacuum_vacuum_cost_delay = 2ms
autovacuum_vacuum_cost_limit = 200

# ============================================
# ç»Ÿè®¡ä¿¡æ¯
# ============================================
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
pg_stat_statements.max = 10000
pg_stat_statements.track = all
```

**ç³»ç»Ÿå‚æ•°é…ç½®**:

```bash
# /etc/sysctl.conf
# å…±äº«å†…å­˜ï¼ˆ8GBç³»ç»Ÿï¼‰
kernel.shmmax = 8589934592
kernel.shmall = 2097152

# ç½‘ç»œå‚æ•°
net.core.somaxconn = 4096
net.ipv4.tcp_max_syn_backlog = 4096
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl = 15
net.ipv4.tcp_fin_timeout = 30

# è™šæ‹Ÿå†…å­˜
vm.swappiness = 1
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5
vm.overcommit_memory = 2

# æ–‡ä»¶ç³»ç»Ÿ
fs.file-max = 2097152
fs.aio-max-nr = 1048576
```

### 6.3 å¤§è§„æ¨¡éƒ¨ç½²é…ç½®ï¼ˆ>100GBæ•°æ®ï¼Œ>500è¿æ¥ï¼‰

**é€‚ç”¨åœºæ™¯**: å¤§å‹åº”ç”¨ã€é«˜å¹¶å‘ç³»ç»Ÿã€ä¼ä¸šçº§ç”Ÿäº§ç¯å¢ƒ

**å®Œæ•´é…ç½®ç¤ºä¾‹**:

```conf
# postgresql.conf - å¤§è§„æ¨¡éƒ¨ç½²é…ç½®ï¼ˆ32GBå†…å­˜ç³»ç»Ÿï¼‰

# ============================================
# è¿æ¥è®¾ç½®
# ============================================
listen_addresses = '*'
port = 5432
max_connections = 1000
superuser_reserved_connections = 10

# ============================================
# å†…å­˜è®¾ç½®
# ============================================
shared_buffers = 8GB                # ç³»ç»Ÿå†…å­˜çš„25%
effective_cache_size = 24GB         # ç³»ç»Ÿå†…å­˜çš„75%
work_mem = 64MB                     # æ¯ä¸ªæ“ä½œçš„å·¥ä½œå†…å­˜ï¼ˆæ³¨æ„ï¼šmax_connections * work_memä¸èƒ½å¤ªå¤§ï¼‰
maintenance_work_mem = 2GB          # ç»´æŠ¤æ“ä½œçš„å·¥ä½œå†…å­˜
temp_buffers = 32MB                 # ä¸´æ—¶ç¼“å†²åŒº
max_prepared_transactions = 200     # é¢„å‡†å¤‡äº‹åŠ¡
huge_pages = try                     # å°è¯•ä½¿ç”¨å¤§é¡µ

# ============================================
# WALè®¾ç½®
# ============================================
wal_level = replica
min_wal_size = 2GB
max_wal_size = 8GB
checkpoint_completion_target = 0.9
checkpoint_timeout = 15min
wal_compression = on
wal_buffers = 32MB                  # WALç¼“å†²åŒº
wal_writer_delay = 200ms
wal_writer_flush_after = 1MB

# ============================================
# I/Oè®¾ç½®ï¼ˆPostgreSQL 18å¼‚æ­¥I/Oï¼‰
# ============================================
random_page_cost = 1.1
effective_io_concurrency = 300      # NVMe SSD
io_method = aio                     # PostgreSQL 18: å¼‚æ­¥I/O
io_combine_limit = 256              # PostgreSQL 18: I/Oåˆå¹¶é™åˆ¶
maintenance_io_workers = 8          # PostgreSQL 18: ç»´æŠ¤I/Oå·¥ä½œè¿›ç¨‹
max_io_workers = 16                 # PostgreSQL 18: æœ€å¤§I/Oå·¥ä½œè¿›ç¨‹

# ============================================
# æŸ¥è¯¢ä¼˜åŒ–
# ============================================
default_statistics_target = 100
random_page_cost = 1.1
effective_cache_size = 24GB
enable_hashjoin = on
enable_mergejoin = on
enable_nestloop = on
join_collapse_limit = 12
from_collapse_limit = 12

# ============================================
# å¹¶è¡ŒæŸ¥è¯¢ï¼ˆPostgreSQL 18å¢å¼ºï¼‰
# ============================================
max_parallel_workers_per_gather = 8
max_parallel_workers = 16
max_parallel_maintenance_workers = 8
parallel_leader_participation = on  # PostgreSQL 18: Leaderå‚ä¸å·¥ä½œ
parallel_tuple_cost = 0.1
parallel_setup_cost = 1000

# ============================================
# æ—¥å¿—è®¾ç½®
# ============================================
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 200    # è®°å½•è¶…è¿‡200msçš„æŸ¥è¯¢
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_autovacuum_min_duration = 0     # è®°å½•æ‰€æœ‰autovacuumæ“ä½œ

# ============================================
# è‡ªåŠ¨æ¸…ç†
# ============================================
autovacuum = on
autovacuum_max_workers = 6
autovacuum_naptime = 10s
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.05
autovacuum_analyze_scale_factor = 0.02
autovacuum_vacuum_cost_delay = 2ms
autovacuum_vacuum_cost_limit = 2000

# ============================================
# ç»Ÿè®¡ä¿¡æ¯
# ============================================
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
pg_stat_statements.max = 50000
pg_stat_statements.track = all
pg_stat_statements.track_utility = on
```

**ç³»ç»Ÿå‚æ•°é…ç½®**:

```bash
# /etc/sysctl.conf
# å…±äº«å†…å­˜ï¼ˆ32GBç³»ç»Ÿï¼‰
kernel.shmmax = 34359738368
kernel.shmall = 8388608

# ç½‘ç»œå‚æ•°
net.core.somaxconn = 8192
net.ipv4.tcp_max_syn_backlog = 8192
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl = 15
net.ipv4.tcp_fin_timeout = 30
net.ipv4.ip_local_port_range = 10000 65535

# è™šæ‹Ÿå†…å­˜
vm.swappiness = 1
vm.dirty_ratio = 10
vm.dirty_background_ratio = 3
vm.overcommit_memory = 2
vm.overcommit_ratio = 80

# æ–‡ä»¶ç³»ç»Ÿ
fs.file-max = 4194304
fs.aio-max-nr = 1048576
fs.nr_open = 1048576

# å¤§é¡µæ”¯æŒï¼ˆå¯é€‰ï¼Œæå‡æ€§èƒ½ï¼‰
vm.nr_hugepages = 4096
```

### 6.4 PostgreSQL 18æ–°ç‰¹æ€§é…ç½®

**å¼‚æ­¥I/Oé…ç½®**:

```conf
# postgresql.conf
# å¯ç”¨å¼‚æ­¥I/Oï¼ˆPostgreSQL 18ï¼‰
io_method = aio                     # ä½¿ç”¨å¼‚æ­¥I/O
io_combine_limit = 128              # I/Oè¯·æ±‚åˆå¹¶é™åˆ¶
maintenance_io_workers = 4          # ç»´æŠ¤æ“ä½œçš„I/Oå·¥ä½œè¿›ç¨‹æ•°
max_io_workers = 10                 # æœ€å¤§I/Oå·¥ä½œè¿›ç¨‹æ•°

# æ€§èƒ½æå‡ï¼š
# - é¡ºåºæ‰«ææ€§èƒ½æå‡2-3å€
# - VACUUMæ€§èƒ½æå‡2-3å€
# - ç´¢å¼•æ„å»ºæ€§èƒ½æå‡40%+
```

**è™šæ‹Ÿç”Ÿæˆåˆ—é…ç½®**:

```sql
-- åˆ›å»ºå¸¦è™šæ‹Ÿç”Ÿæˆåˆ—çš„è¡¨
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    price DECIMAL(10,2),
    discount DECIMAL(5,2),
    final_price DECIMAL(10,2) GENERATED ALWAYS AS (price * (1 - discount/100)) VIRTUAL
);

-- åœ¨è™šæ‹Ÿç”Ÿæˆåˆ—ä¸Šåˆ›å»ºç´¢å¼•ï¼ˆPostgreSQL 18æ”¯æŒï¼‰
CREATE INDEX idx_products_final_price ON products (final_price);

-- æŸ¥è¯¢ä¼˜åŒ–å™¨è‡ªåŠ¨åˆ©ç”¨è™šæ‹Ÿç”Ÿæˆåˆ—ç´¢å¼•
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM products WHERE final_price BETWEEN 50 AND 100;
```

**OAuth 2.0è®¤è¯é…ç½®**:

```conf
# pg_hba.conf
# OAuth 2.0è®¤è¯ï¼ˆPostgreSQL 18ï¼‰
host    all             all             0.0.0.0/0               oauth

# postgresql.conf
# OAuth 2.0é…ç½®
oauth_issuer = 'https://auth.example.com'
oauth_client_id = 'postgresql-client'
oauth_client_secret = 'client-secret'
oauth_scope = 'openid profile email'
```

## 7. æ•…éšœæ’æŸ¥ä¸è¯Šæ–­

### 7.1 å¯åŠ¨é—®é¢˜æ’æŸ¥

**å¸¸è§å¯åŠ¨é—®é¢˜**:

```bash
# 1. æ£€æŸ¥PostgreSQLè¿›ç¨‹
ps aux | grep postgres

# 2. æ£€æŸ¥æ•°æ®ç›®å½•æƒé™
ls -la /var/lib/pgsql/18/data
# åº”è¯¥å±äºpostgresç”¨æˆ·

# 3. æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
sudo -u postgres /usr/pgsql-18/bin/postgres -D /var/lib/pgsql/18/data --check-config

# 4. æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tlnp | grep 5432
# æˆ–
sudo ss -tlnp | grep 5432

# 5. æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
sudo tail -f /var/lib/pgsql/18/data/log/postgresql-*.log

# 6. æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•ï¼ˆå‰å°è¿è¡Œï¼ŒæŸ¥çœ‹è¯¦ç»†é”™è¯¯ï¼‰
sudo -u postgres /usr/pgsql-18/bin/postgres -D /var/lib/pgsql/18/data
```

**å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ**:

```bash
# é”™è¯¯1: "could not create shared memory segment"
# åŸå› : å…±äº«å†…å­˜ä¸è¶³
# è§£å†³: å¢åŠ kernel.shmmaxå’Œkernel.shmall
sudo sysctl -w kernel.shmmax=68719476736
sudo sysctl -w kernel.shmall=4294967296

# é”™è¯¯2: "FATAL: lock file "postmaster.pid" already exists"
# åŸå› : ä¹‹å‰çš„PostgreSQLè¿›ç¨‹å¼‚å¸¸é€€å‡º
# è§£å†³: æ£€æŸ¥å¹¶åˆ é™¤é”æ–‡ä»¶
sudo -u postgres rm /var/lib/pgsql/18/data/postmaster.pid

# é”™è¯¯3: "FATAL: could not open directory "pg_wal": Permission denied"
# åŸå› : ç›®å½•æƒé™é—®é¢˜
# è§£å†³: ä¿®å¤æƒé™
sudo chown -R postgres:postgres /var/lib/pgsql/18/data
sudo chmod 700 /var/lib/pgsql/18/data

# é”™è¯¯4: "FATAL: password authentication failed"
# åŸå› : å¯†ç é”™è¯¯æˆ–pg_hba.confé…ç½®é—®é¢˜
# è§£å†³: æ£€æŸ¥pg_hba.confé…ç½®å’Œç”¨æˆ·å¯†ç 
```

### 7.2 è¿æ¥é—®é¢˜è¯Šæ–­

**è¿æ¥é—®é¢˜æ’æŸ¥æ­¥éª¤**:

```bash
# 1. æ£€æŸ¥PostgreSQLæœåŠ¡çŠ¶æ€
sudo systemctl status postgresql

# 2. æ£€æŸ¥ç›‘å¬åœ°å€å’Œç«¯å£
sudo netstat -tlnp | grep postgres
# æˆ–
sudo ss -tlnp | grep postgres

# 3. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
sudo iptables -L -n | grep 5432
# æˆ–
sudo firewall-cmd --list-all

# 4. æµ‹è¯•æœ¬åœ°è¿æ¥
psql -h localhost -U postgres -d postgres

# 5. æµ‹è¯•è¿œç¨‹è¿æ¥
psql -h <server_ip> -U postgres -d postgres

# 6. æ£€æŸ¥pg_hba.confé…ç½®
sudo cat /var/lib/pgsql/18/data/pg_hba.conf | grep -v "^#"

# 7. æ£€æŸ¥è¿æ¥æ—¥å¿—
sudo tail -f /var/lib/pgsql/18/data/log/postgresql-*.log | grep -i connection
```

**å¸¸è§è¿æ¥é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ**:

```sql
-- é—®é¢˜1: "too many connections"
-- åŸå› : è¿æ¥æ•°è¾¾åˆ°max_connectionsé™åˆ¶
-- è§£å†³: å¢åŠ max_connectionsæˆ–ä½¿ç”¨è¿æ¥æ± 

-- æŸ¥çœ‹å½“å‰è¿æ¥æ•°
SELECT count(*) FROM pg_stat_activity;

-- æŸ¥çœ‹è¿æ¥è¯¦æƒ…
SELECT
    datname,
    usename,
    application_name,
    client_addr,
    state,
    query_start,
    state_change
FROM pg_stat_activity
ORDER BY query_start;

-- æŸ¥çœ‹è¿æ¥æ•°é™åˆ¶
SHOW max_connections;

-- é—®é¢˜2: "connection refused"
-- åŸå› : PostgreSQLæœªå¯åŠ¨æˆ–ç›‘å¬åœ°å€é…ç½®é”™è¯¯
-- è§£å†³: æ£€æŸ¥æœåŠ¡çŠ¶æ€å’Œlisten_addressesé…ç½®

-- é—®é¢˜3: "password authentication failed"
-- åŸå› : å¯†ç é”™è¯¯æˆ–è®¤è¯æ–¹æ³•é…ç½®é”™è¯¯
-- è§£å†³: æ£€æŸ¥pg_hba.confå’Œç”¨æˆ·å¯†ç 

-- é‡ç½®å¯†ç 
ALTER USER postgres WITH PASSWORD 'new_password';
```

### 7.3 æ€§èƒ½é—®é¢˜è¯Šæ–­

**æ€§èƒ½é—®é¢˜æ’æŸ¥æ­¥éª¤**:

```sql
-- 1. æ£€æŸ¥æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    total_time,
    mean_time,
    max_time,
    stddev_time,
    rows
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 20;

-- 2. æ£€æŸ¥é”ç­‰å¾…
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted
AND blocking_locks.granted;

-- 3. æ£€æŸ¥I/Oæ€§èƒ½
SELECT * FROM pg_stat_io
ORDER BY reads DESC
LIMIT 20;

-- 4. æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
SELECT
    'index hit rate' AS name,
    (sum(idx_blks_hit)) / nullif(sum(idx_blks_hit + idx_blks_read), 0) AS ratio
FROM pg_statio_user_indexes
UNION ALL
SELECT
    'table hit rate' AS name,
    sum(heap_blks_hit) / nullif(sum(heap_blks_hit) + sum(heap_blks_read), 0) AS ratio
FROM pg_statio_user_tables;

-- 5. æ£€æŸ¥è¡¨å¤§å°å’Œè†¨èƒ€
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) - pg_relation_size(schemaname||'.'||tablename)) AS indexes_size,
    n_dead_tup,
    n_live_tup,
    round(n_dead_tup * 100.0 / nullif(n_live_tup + n_dead_tup, 0), 2) AS dead_ratio
FROM pg_stat_user_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
LIMIT 20;

-- 6. æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE idx_scan = 0
ORDER BY pg_relation_size(indexrelid) DESC;
```

**æ€§èƒ½ä¼˜åŒ–è¯Šæ–­è„šæœ¬**:

```bash
#!/bin/bash
# performance_diagnosis.sh - PostgreSQLæ€§èƒ½è¯Šæ–­è„šæœ¬

echo "=== PostgreSQLæ€§èƒ½è¯Šæ–­æŠ¥å‘Š ==="
echo "ç”Ÿæˆæ—¶é—´: $(date)"
echo ""

echo "=== 1. ç³»ç»Ÿèµ„æº ==="
echo "å†…å­˜ä½¿ç”¨:"
free -h
echo ""
echo "ç£ç›˜ä½¿ç”¨:"
df -h
echo ""
echo "I/Oç»Ÿè®¡:"
iostat -x 1 3
echo ""

echo "=== 2. PostgreSQLè¿æ¥æ•° ==="
psql -c "SELECT count(*) as total_connections, count(*) FILTER (WHERE state = 'active') as active_connections FROM pg_stat_activity;"
echo ""

echo "=== 3. æ…¢æŸ¥è¯¢Top 10 ==="
psql -c "SELECT query, calls, mean_time, max_time FROM pg_stat_statements ORDER BY mean_time DESC LIMIT 10;"
echo ""

echo "=== 4. é”ç­‰å¾… ==="
psql -c "SELECT count(*) as lock_waits FROM pg_stat_activity WHERE wait_event_type = 'Lock';"
echo ""

echo "=== 5. ç¼“å­˜å‘½ä¸­ç‡ ==="
psql -c "SELECT 'index hit rate' AS name, (sum(idx_blks_hit)) / nullif(sum(idx_blks_hit + idx_blks_read), 0) AS ratio FROM pg_statio_user_indexes UNION ALL SELECT 'table hit rate' AS name, sum(heap_blks_hit) / nullif(sum(heap_blks_hit) + sum(heap_blks_read), 0) AS ratio FROM pg_statio_user_tables;"
echo ""

echo "=== 6. è¡¨å¤§å°Top 10 ==="
psql -c "SELECT schemaname, tablename, pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size FROM pg_stat_user_tables ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC LIMIT 10;"
```

### 7.4 æ—¥å¿—åˆ†ææ–¹æ³•

**æ—¥å¿—é…ç½®ä¼˜åŒ–**:

```conf
# postgresql.conf - è¯¦ç»†æ—¥å¿—é…ç½®

# åŸºæœ¬æ—¥å¿—è®¾ç½®
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB

# æ—¥å¿—çº§åˆ«
log_min_messages = warning          # è®°å½•è­¦å‘ŠåŠä»¥ä¸Šçº§åˆ«
log_min_error_statement = error     # è®°å½•é”™è¯¯è¯­å¥

# æŸ¥è¯¢æ—¥å¿—
log_min_duration_statement = 500    # è®°å½•è¶…è¿‡500msçš„æŸ¥è¯¢
log_statement = 'ddl'               # è®°å½•DDLè¯­å¥
log_duration = off                  # ä¸è®°å½•æ¯ä¸ªè¯­å¥çš„æŒç»­æ—¶é—´ï¼ˆé¿å…æ—¥å¿—è¿‡å¤§ï¼‰

# è¿æ¥æ—¥å¿—
log_connections = on
log_disconnections = on
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# æ£€æŸ¥ç‚¹å’ŒWALæ—¥å¿—
log_checkpoints = on
log_autovacuum_min_duration = 0     # è®°å½•æ‰€æœ‰autovacuumæ“ä½œ

# é”ç­‰å¾…æ—¥å¿—
log_lock_waits = on

# ä¸´æ—¶æ–‡ä»¶æ—¥å¿—
log_temp_files = 0                  # è®°å½•æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶åˆ›å»º
```

**æ—¥å¿—åˆ†æå·¥å…·**:

```bash
# 1. åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
grep "duration:" /var/lib/pgsql/18/data/log/postgresql-*.log | \
    awk '{print $NF}' | \
    sort -n | \
    tail -20

# 2. åˆ†æé”™è¯¯æ—¥å¿—
grep -i "error\|fatal\|panic" /var/lib/pgsql/18/data/log/postgresql-*.log | \
    tail -50

# 3. åˆ†æè¿æ¥æ—¥å¿—
grep "connection" /var/lib/pgsql/18/data/log/postgresql-*.log | \
    awk '{print $1, $2, $NF}' | \
    sort | uniq -c | sort -rn | head -20

# 4. åˆ†æé”ç­‰å¾…æ—¥å¿—
grep "lock" /var/lib/pgsql/18/data/log/postgresql-*.log | \
    tail -50

# 5. ä½¿ç”¨pgBadgeråˆ†ææ—¥å¿—ï¼ˆæ¨èï¼‰
# å®‰è£…pgBadger
sudo apt-get install pgbadger

# ç”ŸæˆHTMLæŠ¥å‘Š
pgbadger /var/lib/pgsql/18/data/log/postgresql-*.log -o report.html

# 6. å®æ—¶ç›‘æ§æ—¥å¿—
tail -f /var/lib/pgsql/18/data/log/postgresql-*.log | \
    grep -E "ERROR|FATAL|duration|connection"
```

## 8. æ€§èƒ½ä¼˜åŒ–å®è·µ

### 8.1 ç³»ç»Ÿçº§ä¼˜åŒ–

**æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–**:

```bash
# 1. ä½¿ç”¨XFSæ–‡ä»¶ç³»ç»Ÿï¼ˆæ¨èç”¨äºPostgreSQLï¼‰
# åˆ›å»ºXFSæ–‡ä»¶ç³»ç»Ÿ
sudo mkfs.xfs /dev/sdb1

# æŒ‚è½½æ—¶ä¼˜åŒ–å‚æ•°
sudo mount -o noatime,nodiratime /dev/sdb1 /var/lib/pgsql

# 2. è°ƒæ•´I/Oè°ƒåº¦å™¨ï¼ˆSSDæ¨èä½¿ç”¨noneæˆ–noopï¼‰
echo none | sudo tee /sys/block/sdb/queue/scheduler

# 3. ç¦ç”¨æ–‡ä»¶ç³»ç»Ÿè®¿é—®æ—¶é—´æ›´æ–°ï¼ˆæå‡æ€§èƒ½ï¼‰
# åœ¨/etc/fstabä¸­æ·»åŠ noatimeé€‰é¡¹
/dev/sdb1 /var/lib/pgsql xfs defaults,noatime,nodiratime 0 0
```

**ç½‘ç»œä¼˜åŒ–**:

```bash
# /etc/sysctl.conf
# TCPå‚æ•°ä¼˜åŒ–
net.core.somaxconn = 4096
net.ipv4.tcp_max_syn_backlog = 4096
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl = 15
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_max_tw_buckets = 2000000
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_sack = 1
net.ipv4.tcp_window_scaling = 1
```

### 8.2 æ•°æ®åº“å‚æ•°ä¼˜åŒ–

**å…³é”®å‚æ•°è°ƒä¼˜æŒ‡å—**:

```conf
# ============================================
# å†…å­˜å‚æ•°è°ƒä¼˜
# ============================================
# shared_buffers: ç³»ç»Ÿå†…å­˜çš„25%
# - å¤ªå°ï¼šé¢‘ç¹ç£ç›˜I/O
# - å¤ªå¤§ï¼šå ç”¨è¿‡å¤šç³»ç»Ÿå†…å­˜ï¼Œå½±å“å…¶ä»–è¿›ç¨‹
# æ¨èå€¼ï¼š2GB-8GBï¼ˆæ ¹æ®ç³»ç»Ÿå†…å­˜è°ƒæ•´ï¼‰

# effective_cache_size: ç³»ç»Ÿå†…å­˜çš„50-75%
# - å‘Šè¯‰ä¼˜åŒ–å™¨ç³»ç»Ÿæœ‰å¤šå°‘å†…å­˜å¯ç”¨äºç¼“å­˜
# - ä¸å½±å“å®é™…å†…å­˜ä½¿ç”¨ï¼Œä»…ç”¨äºæŸ¥è¯¢è§„åˆ’
# æ¨èå€¼ï¼šç³»ç»Ÿå†…å­˜çš„75%

# work_mem: æ¯ä¸ªæ“ä½œçš„å·¥ä½œå†…å­˜
# - æ³¨æ„ï¼šmax_connections * work_memä¸èƒ½è¶…è¿‡ç³»ç»Ÿå†…å­˜
# - ç”¨äºæ’åºã€å“ˆå¸Œè¿æ¥ã€åˆå¹¶è¿æ¥ç­‰æ“ä½œ
# æ¨èå€¼ï¼š4MB-64MBï¼ˆæ ¹æ®è¿æ¥æ•°è°ƒæ•´ï¼‰

# ============================================
# I/Oå‚æ•°è°ƒä¼˜ï¼ˆPostgreSQL 18ï¼‰
# ============================================
# io_method = aio: å¯ç”¨å¼‚æ­¥I/O
# - æ€§èƒ½æå‡2-3å€ï¼ˆé¡ºåºæ‰«æã€VACUUMç­‰ï¼‰
# - éœ€è¦Linuxå†…æ ¸æ”¯æŒio_uring

# effective_io_concurrency: I/Oå¹¶å‘æ•°
# - SSD: 200-300
# - NVMe: 300-500
# - HDD: 2-4

# ============================================
# WALå‚æ•°è°ƒä¼˜
# ============================================
# max_wal_size: æœ€å¤§WALå¤§å°
# - å½±å“æ£€æŸ¥ç‚¹é¢‘ç‡
# - æ¨èå€¼ï¼šç³»ç»Ÿå†…å­˜çš„25-50%
# - å¤ªå¤§ï¼šæ¢å¤æ—¶é—´é•¿
# - å¤ªå°ï¼šé¢‘ç¹æ£€æŸ¥ç‚¹ï¼Œå½±å“æ€§èƒ½

# checkpoint_completion_target: æ£€æŸ¥ç‚¹å®Œæˆç›®æ ‡
# - æ¨èå€¼ï¼š0.9ï¼ˆåœ¨æ£€æŸ¥ç‚¹æ—¶é—´çª—å£çš„90%å†…å®Œæˆï¼‰
# - å¹³æ»‘I/Oè´Ÿè½½
```

### 8.3 å­˜å‚¨ä¼˜åŒ–

**è¡¨ç©ºé—´ä¼˜åŒ–**:

```sql
-- 1. åˆ›å»ºä¸“ç”¨è¡¨ç©ºé—´ï¼ˆä½¿ç”¨é«˜æ€§èƒ½å­˜å‚¨ï¼‰
CREATE TABLESPACE fast_storage
LOCATION '/fast_storage/postgresql';

-- 2. åœ¨è¡¨ç©ºé—´ä¸Šåˆ›å»ºè¡¨
CREATE TABLE large_table (
    id SERIAL PRIMARY KEY,
    data TEXT
) TABLESPACE fast_storage;

-- 3. ç§»åŠ¨ç°æœ‰è¡¨åˆ°æ–°è¡¨ç©ºé—´
ALTER TABLE large_table SET TABLESPACE fast_storage;

-- 4. æŸ¥çœ‹è¡¨ç©ºé—´ä½¿ç”¨æƒ…å†µ
SELECT
    spcname,
    pg_size_pretty(pg_tablespace_size(spcname)) AS size
FROM pg_tablespace;
```

**åˆ†åŒºè¡¨ä¼˜åŒ–**:

```sql
-- 1. åˆ›å»ºåˆ†åŒºè¡¨ï¼ˆæŒ‰æ—¶é—´åˆ†åŒºï¼‰
CREATE TABLE sales (
    id SERIAL,
    sale_date DATE,
    amount DECIMAL(10,2)
) PARTITION BY RANGE (sale_date);

-- 2. åˆ›å»ºåˆ†åŒº
CREATE TABLE sales_2024_01 PARTITION OF sales
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01')
TABLESPACE fast_storage;

-- 3. ä¸ºåˆ†åŒºåˆ›å»ºç´¢å¼•
CREATE INDEX idx_sales_date ON sales (sale_date);

-- 4. è‡ªåŠ¨åˆ›å»ºåˆ†åŒºï¼ˆä½¿ç”¨å‡½æ•°ï¼‰
CREATE OR REPLACE FUNCTION create_monthly_partition(table_name text, start_date date)
RETURNS void AS $$
DECLARE
    partition_name text;
    end_date date;
BEGIN
    partition_name := table_name || '_' || to_char(start_date, 'YYYY_MM');
    end_date := start_date + interval '1 month';

    EXECUTE format('CREATE TABLE IF NOT EXISTS %I PARTITION OF %I
                    FOR VALUES FROM (%L) TO (%L)',
                    partition_name, table_name, start_date, end_date);
END;
$$ LANGUAGE plpgsql;
```

### 8.4 ç½‘ç»œä¼˜åŒ–

**è¿æ¥æ± é…ç½®**:

```sql
-- ä½¿ç”¨PgBouncerè¿æ¥æ± 
-- pgbouncer.inié…ç½®
[databases]
mydb = host=localhost port=5432 dbname=mydb

[pgbouncer]
pool_mode = transaction          # äº‹åŠ¡çº§è¿æ¥æ± 
max_client_conn = 1000           # æœ€å¤§å®¢æˆ·ç«¯è¿æ¥æ•°
default_pool_size = 25           # é»˜è®¤è¿æ¥æ± å¤§å°
min_pool_size = 5                # æœ€å°è¿æ¥æ± å¤§å°
reserve_pool_size = 5            # ä¿ç•™è¿æ¥æ± å¤§å°
reserve_pool_timeout = 3         # ä¿ç•™è¿æ¥æ± è¶…æ—¶
max_db_connections = 100         # æ¯ä¸ªæ•°æ®åº“æœ€å¤§è¿æ¥æ•°
max_user_connections = 100       # æ¯ä¸ªç”¨æˆ·æœ€å¤§è¿æ¥æ•°
```

## 9. ç›‘æ§ä¸å‘Šè­¦é…ç½®

### 9.1 å…³é”®æŒ‡æ ‡ç›‘æ§

**æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**:

```sql
-- 1. è¿æ¥æ•°ç›‘æ§
SELECT
    count(*) as total_connections,
    count(*) FILTER (WHERE state = 'active') as active_connections,
    count(*) FILTER (WHERE state = 'idle') as idle_connections,
    count(*) FILTER (WHERE state = 'idle in transaction') as idle_in_transaction,
    max_conn - count(*) as available_connections
FROM pg_stat_activity, (SELECT setting::int as max_conn FROM pg_settings WHERE name = 'max_connections') mc;

-- 2. æ•°æ®åº“å¤§å°ç›‘æ§
SELECT
    datname,
    pg_size_pretty(pg_database_size(datname)) AS size
FROM pg_database
ORDER BY pg_database_size(datname) DESC;

-- 3. è¡¨å¤§å°å’Œè†¨èƒ€ç›‘æ§
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    n_live_tup,
    n_dead_tup,
    round(n_dead_tup * 100.0 / nullif(n_live_tup + n_dead_tup, 0), 2) AS dead_ratio,
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables
WHERE n_dead_tup > 1000
ORDER BY n_dead_tup DESC;

-- 4. å¤åˆ¶å»¶è¿Ÿç›‘æ§ï¼ˆå¦‚æœæœ‰ä»åº“ï¼‰
SELECT
    client_addr,
    state,
    sync_state,
    pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) AS sent_lag_bytes,
    pg_wal_lsn_diff(pg_current_wal_lsn(), write_lsn) AS write_lag_bytes,
    pg_wal_lsn_diff(pg_current_wal_lsn(), flush_lsn) AS flush_lag_bytes,
    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS replay_lag_bytes
FROM pg_stat_replication;

-- 5. æ£€æŸ¥ç‚¹ç›‘æ§
SELECT
    checkpoints_timed,
    checkpoints_req,
    checkpoint_write_time,
    checkpoint_sync_time,
    buffers_checkpoint,
    buffers_clean,
    maxwritten_clean,
    buffers_backend,
    buffers_backend_fsync,
    buffers_alloc
FROM pg_stat_bgwriter;

-- 6. I/Oæ€§èƒ½ç›‘æ§ï¼ˆPostgreSQL 18ï¼‰
SELECT
    object,
    context,
    reads,
    writes,
    extends,
    fsyncs,
    read_time,
    write_time,
    sync_time
FROM pg_stat_io
ORDER BY reads DESC;
```

### 9.2 Prometheusç›‘æ§é…ç½®

**PostgreSQL Exporteré…ç½®**:

```yaml
# docker-compose.yml
version: '3.8'
services:
  postgres:
    image: postgres:18
    environment:
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  postgres_exporter:
    image: prometheuscommunity/postgres-exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://postgres:password@postgres:5432/postgres?sslmode=disable"
    ports:
      - "9187:9187"
    depends_on:
      - postgres

volumes:
  postgres_data:
```

**Prometheusé…ç½®**:

```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres_exporter:9187']
    metrics_path: /metrics
```

**Grafanaä»ªè¡¨æ¿é…ç½®**:

```json
{
  "dashboard": {
    "title": "PostgreSQLç›‘æ§",
    "panels": [
      {
        "title": "è¿æ¥æ•°",
        "targets": [
          {
            "expr": "pg_stat_database_numbackends{datname=\"postgres\"}"
          }
        ]
      },
      {
        "title": "æŸ¥è¯¢QPS",
        "targets": [
          {
            "expr": "rate(pg_stat_database_xact_commit[5m]) + rate(pg_stat_database_xact_rollback[5m])"
          }
        ]
      },
      {
        "title": "ç¼“å­˜å‘½ä¸­ç‡",
        "targets": [
          {
            "expr": "sum(rate(pg_stat_database_blks_hit[5m])) / (sum(rate(pg_stat_database_blks_hit[5m])) + sum(rate(pg_stat_database_blks_read[5m])))"
          }
        ]
      }
    ]
  }
}
```

### 9.3 å‘Šè­¦è§„åˆ™é…ç½®

**Prometheuså‘Šè­¦è§„åˆ™**:

```yaml
# alerts.yml
groups:
  - name: postgresql_alerts
    interval: 30s
    rules:
      # è¿æ¥æ•°å‘Šè­¦
      - alert: PostgreSQLHighConnections
        expr: pg_stat_database_numbackends > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLè¿æ¥æ•°è¿‡é«˜"
          description: "æ•°æ®åº“ {{ $labels.datname }} è¿æ¥æ•°ä¸º {{ $value }}ï¼Œè¶…è¿‡é˜ˆå€¼80"

      # æ…¢æŸ¥è¯¢å‘Šè­¦
      - alert: PostgreSQLSlowQueries
        expr: rate(pg_stat_statements_mean_exec_time[5m]) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLæ…¢æŸ¥è¯¢"
          description: "æŸ¥è¯¢å¹³å‡æ‰§è¡Œæ—¶é—´ {{ $value }}ç§’ï¼Œè¶…è¿‡é˜ˆå€¼1ç§’"

      # å¤åˆ¶å»¶è¿Ÿå‘Šè­¦
      - alert: PostgreSQLReplicationLag
        expr: pg_replication_lag > 10485760  # 10MB
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQLå¤åˆ¶å»¶è¿Ÿ"
          description: "å¤åˆ¶å»¶è¿Ÿ {{ $value }} å­—èŠ‚ï¼Œè¶…è¿‡é˜ˆå€¼10MB"

      # ç£ç›˜ç©ºé—´å‘Šè­¦
      - alert: PostgreSQLDiskSpace
        expr: (node_filesystem_avail_bytes{mountpoint="/var/lib/postgresql"} / node_filesystem_size_bytes{mountpoint="/var/lib/postgresql"}) < 0.1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQLç£ç›˜ç©ºé—´ä¸è¶³"
          description: "ç£ç›˜ä½¿ç”¨ç‡è¶…è¿‡90%"

      # æ£€æŸ¥ç‚¹å‘Šè­¦
      - alert: PostgreSQLCheckpointTooFrequent
        expr: rate(pg_stat_bgwriter_checkpoints_timed[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQLæ£€æŸ¥ç‚¹è¿‡äºé¢‘ç¹"
          description: "æ£€æŸ¥ç‚¹é¢‘ç‡ {{ $value }}ï¼Œå¯èƒ½å½±å“æ€§èƒ½"
```

## 10. å®‰å…¨åŠ å›ºè¯¦ç»†æŒ‡å—

### 10.1 SSL/TLSå®Œæ•´é…ç½®

**ç”ŸæˆSSLè¯ä¹¦**:

```bash
# 1. åˆ›å»ºè¯ä¹¦ç›®å½•
sudo mkdir -p /var/lib/pgsql/18/data/ssl
sudo chown postgres:postgres /var/lib/pgsql/18/data/ssl
cd /var/lib/pgsql/18/data/ssl

# 2. ç”ŸæˆCAç§é’¥
sudo -u postgres openssl genrsa -out ca.key 4096

# 3. ç”ŸæˆCAè¯ä¹¦
sudo -u postgres openssl req -new -x509 -days 3650 -key ca.key -out ca.crt \
    -subj "/CN=PostgreSQL-CA"

# 4. ç”ŸæˆæœåŠ¡å™¨ç§é’¥
sudo -u postgres openssl genrsa -out server.key 4096

# 5. ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦è¯·æ±‚
sudo -u postgres openssl req -new -key server.key -out server.csr \
    -subj "/CN=postgresql-server"

# 6. ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦
sudo -u postgres openssl x509 -req -days 365 -in server.csr -CA ca.crt -CAkey ca.key \
    -CAcreateserial -out server.crt

# 7. è®¾ç½®æƒé™
sudo chmod 600 server.key
sudo chown postgres:postgres server.key server.crt

# 8. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
sudo rm server.csr
```

**PostgreSQL SSLé…ç½®**:

```conf
# postgresql.conf
ssl = on
ssl_cert_file = 'server.crt'
ssl_key_file = 'server.key'
ssl_ca_file = 'ca.crt'              # å¯é€‰ï¼šå®¢æˆ·ç«¯è¯ä¹¦éªŒè¯
ssl_crl_file = ''                   # å¯é€‰ï¼šè¯ä¹¦æ’¤é”€åˆ—è¡¨
ssl_prefer_server_ciphers = on      # ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨å¯†ç å¥—ä»¶
ssl_ciphers = 'HIGH:!aNULL:!MD5'    # å…è®¸çš„å¯†ç å¥—ä»¶
ssl_min_protocol_version = 'TLSv1.2'  # æœ€å°TLSç‰ˆæœ¬
```

**pg_hba.conf SSLé…ç½®**:

```conf
# å¼ºåˆ¶SSLè¿æ¥
hostssl all             all             0.0.0.0/0               scram-sha-256

# å®¢æˆ·ç«¯è¯ä¹¦è®¤è¯ï¼ˆæ›´å®‰å…¨ï¼‰
hostssl all             all             0.0.0.0/0               cert
```

**å®¢æˆ·ç«¯è¿æ¥æµ‹è¯•**:

```bash
# ä½¿ç”¨SSLè¿æ¥
psql "postgresql://user:password@host:5432/dbname?sslmode=require"

# éªŒè¯SSLè¿æ¥
psql -h host -U user -d dbname -c "\conninfo"
# åº”è¯¥æ˜¾ç¤º: SSL connection (protocol: TLSv1.3, cipher: ...)
```

### 10.2 é˜²ç«å¢™è§„åˆ™é…ç½®

**iptablesé˜²ç«å¢™é…ç½®**:

```bash
# 1. å…è®¸æœ¬åœ°è¿æ¥
sudo iptables -A INPUT -i lo -j ACCEPT

# 2. å…è®¸ç‰¹å®šIPè®¿é—®PostgreSQL
sudo iptables -A INPUT -p tcp --dport 5432 -s 192.168.1.0/24 -j ACCEPT

# 3. æ‹’ç»å…¶ä»–IPè®¿é—®PostgreSQL
sudo iptables -A INPUT -p tcp --dport 5432 -j DROP

# 4. ä¿å­˜è§„åˆ™
sudo iptables-save > /etc/iptables/rules.v4

# 5. æŸ¥çœ‹è§„åˆ™
sudo iptables -L -n -v | grep 5432
```

**firewalldé˜²ç«å¢™é…ç½®**:

```bash
# 1. æ·»åŠ PostgreSQLæœåŠ¡
sudo firewall-cmd --permanent --add-service=postgresql

# 2. æˆ–æ·»åŠ è‡ªå®šä¹‰ç«¯å£
sudo firewall-cmd --permanent --add-port=5432/tcp

# 3. é™åˆ¶æºIPï¼ˆå¯é€‰ï¼‰
sudo firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="192.168.1.0/24" port port="5432" protocol="tcp" accept'

# 4. é‡æ–°åŠ è½½é˜²ç«å¢™
sudo firewall-cmd --reload

# 5. æŸ¥çœ‹è§„åˆ™
sudo firewall-cmd --list-all
```

### 10.3 å®¡è®¡æ—¥å¿—é…ç½®

**å¯ç”¨è¯¦ç»†å®¡è®¡æ—¥å¿—**:

```conf
# postgresql.conf
# è®°å½•æ‰€æœ‰DDLè¯­å¥
log_statement = 'ddl'

# è®°å½•æ‰€æœ‰æ•°æ®ä¿®æ”¹è¯­å¥
log_statement = 'mod'

# è®°å½•æ‰€æœ‰è¯­å¥ï¼ˆç”Ÿäº§ç¯å¢ƒè°¨æ…ä½¿ç”¨ï¼Œä¼šäº§ç”Ÿå¤§é‡æ—¥å¿—ï¼‰
# log_statement = 'all'

# è®°å½•å‚æ•°å€¼
log_parameter_max_length = 1024
log_parameter = on

# è®°å½•è¿æ¥å’Œæ–­å¼€
log_connections = on
log_disconnections = on

# è®°å½•è¿æ¥æŒç»­æ—¶é—´
log_duration = on

# è®°å½•é”ç­‰å¾…
log_lock_waits = on

# è®°å½•ä¸´æ—¶æ–‡ä»¶
log_temp_files = 0
```

**ä½¿ç”¨pgAuditæ‰©å±•ï¼ˆæ¨èï¼‰**:

```sql
-- 1. å®‰è£…pgAuditæ‰©å±•
CREATE EXTENSION IF NOT EXISTS pgaudit;

-- 2. é…ç½®å®¡è®¡çº§åˆ«
ALTER SYSTEM SET pgaudit.log = 'read,write,ddl';
ALTER SYSTEM SET pgaudit.log_catalog = off;
ALTER SYSTEM SET pgaudit.log_parameter = on;
ALTER SYSTEM SET pgaudit.log_statement_once = on;

-- 3. é‡æ–°åŠ è½½é…ç½®
SELECT pg_reload_conf();

-- 4. æŸ¥çœ‹å®¡è®¡æ—¥å¿—
SELECT * FROM pg_stat_statements WHERE query LIKE '%DELETE%' OR query LIKE '%UPDATE%';
```

### 10.4 è¡Œçº§å®‰å…¨ç­–ç•¥é…ç½®

**è¡Œçº§å®‰å…¨ç­–ç•¥è¯¦ç»†é…ç½®**:

```sql
-- 1. åˆ›å»ºç¤ºä¾‹è¡¨
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INTEGER,
    order_date DATE,
    amount DECIMAL(10,2),
    status VARCHAR(20)
);

-- 2. å¯ç”¨è¡Œçº§å®‰å…¨
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;

-- 3. åˆ›å»ºç­–ç•¥ï¼šç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®¢å•
CREATE POLICY user_orders_policy ON orders
    FOR SELECT
    TO app_user
    USING (user_id = current_setting('app.current_user_id')::INTEGER);

-- 4. åˆ›å»ºç­–ç•¥ï¼šç”¨æˆ·åªèƒ½æ’å…¥è‡ªå·±çš„è®¢å•
CREATE POLICY user_orders_insert_policy ON orders
    FOR INSERT
    TO app_user
    WITH CHECK (user_id = current_setting('app.current_user_id')::INTEGER);

-- 5. åˆ›å»ºç­–ç•¥ï¼šç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±çš„è®¢å•
CREATE POLICY user_orders_update_policy ON orders
    FOR UPDATE
    TO app_user
    USING (user_id = current_setting('app.current_user_id')::INTEGER)
    WITH CHECK (user_id = current_setting('app.current_user_id')::INTEGER);

-- 6. åˆ›å»ºç­–ç•¥ï¼šç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰è®¢å•
CREATE POLICY admin_orders_policy ON orders
    FOR ALL
    TO admin_user
    USING (true)
    WITH CHECK (true);

-- 7. æµ‹è¯•ç­–ç•¥
SET app.current_user_id = '123';
SELECT * FROM orders;  -- åªèƒ½çœ‹åˆ°user_id=123çš„è®¢å•
```

## 11. åç»­æ•´åˆä»»åŠ¡

- è¡¥å……ç³»ç»Ÿå‚æ•°æ¨èè¡¨ä¸ä¸åŒOSå·®å¼‚

### 11.1 ä¸åŒæ“ä½œç³»ç»Ÿå·®å¼‚

#### Ubuntu/Debian

```bash
# æ•°æ®ç›®å½•ä½ç½®
/var/lib/postgresql/18/main

# é…ç½®æ–‡ä»¶ä½ç½®
/etc/postgresql/18/main/postgresql.conf
/etc/postgresql/18/main/pg_hba.conf

# æ—¥å¿—ç›®å½•
/var/log/postgresql/
```

#### CentOS/RHEL

```bash
# æ•°æ®ç›®å½•ä½ç½®
/var/lib/pgsql/18/data

# é…ç½®æ–‡ä»¶ä½ç½®
/var/lib/pgsql/18/data/postgresql.conf
/var/lib/pgsql/18/data/pg_hba.conf

# æ—¥å¿—ç›®å½•
/var/lib/pgsql/18/data/log
```

#### macOS (Homebrew)

```bash
# æ•°æ®ç›®å½•ä½ç½®
/opt/homebrew/var/postgresql@18

# é…ç½®æ–‡ä»¶ä½ç½®
/opt/homebrew/var/postgresql@18/postgresql.conf
/opt/homebrew/var/postgresql@18/pg_hba.conf
```

### 11.2 ç³»ç»Ÿå‚æ•°æ¨èè¡¨

| ç³»ç»Ÿå†…å­˜ | shared_buffers | effective_cache_size | work_mem | maintenance_work_mem |
|---------|----------------|---------------------|----------|---------------------|
| 1GB     | 256MB         | 512MB              | 2MB      | 32MB                |
| 2GB     | 512MB         | 1GB                | 4MB      | 64MB                |
| 4GB     | 1GB           | 2GB                | 8MB      | 128MB               |
| 8GB     | 2GB           | 4GB                | 16MB     | 256MB               |
| 16GB    | 4GB           | 8GB                | 32MB     | 512MB               |
| 32GB    | 8GB           | 16GB               | 64MB     | 1GB                 |
| 64GB    | 16GB          | 32GB               | 128MB    | 2GB                 |

### 11.3 æ€§èƒ½è°ƒä¼˜æ£€æŸ¥æ¸…å•

```bash
# 1. æ£€æŸ¥PostgreSQLç‰ˆæœ¬
psql --version

# 2. æ£€æŸ¥æ•°æ®ç›®å½•æƒé™
ls -la /var/lib/pgsql/18/data

# 3. æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
sudo -u postgres /usr/pgsql-18/bin/postgres -D /var/lib/pgsql/18/data -C config_file

# 4. æ£€æŸ¥å…±äº«å†…å­˜
ipcs -m

# 5. æ£€æŸ¥ç³»ç»Ÿèµ„æº
free -h
df -h
iostat -x 1

# 6. æ£€æŸ¥è¿æ¥æ•°
psql -c "SELECT count(*) FROM pg_stat_activity;"

# 7. æ£€æŸ¥æ…¢æŸ¥è¯¢
psql -c "SELECT * FROM pg_stat_statements ORDER BY mean_exec_time DESC LIMIT 10;"
```

---

## 12. äº¤å‰å¼•ç”¨

### ç›¸å…³æ–‡æ¡£

#### éƒ¨ç½²æ¶æ„

- â­â­â­ [æ€§èƒ½è°ƒä¼˜å®è·µ](./05.02-æ€§èƒ½è°ƒä¼˜å®è·µ.md) - æ€§èƒ½ä¼˜åŒ–æŒ‡å—
- â­â­ [é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨](../é›†ç¾¤éƒ¨ç½²/05.04-é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨.md) - é«˜å¯ç”¨æ¶æ„
- â­â­ [Dockeréƒ¨ç½²](../å®¹å™¨åŒ–éƒ¨ç½²/05.12-Dockeréƒ¨ç½².md) - å®¹å™¨åŒ–éƒ¨ç½²

#### æ ¸å¿ƒè¯¾ç¨‹

- â­â­â­ [ç³»ç»Ÿæ¶æ„ä¸è®¾è®¡åŸç†](../../01-æ ¸å¿ƒè¯¾ç¨‹/01.01-ç³»ç»Ÿæ¶æ„ä¸è®¾è®¡åŸç†.md) - ç³»ç»Ÿæ¶æ„åŸºç¡€
- â­â­ [å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–](../../01-æ ¸å¿ƒè¯¾ç¨‹/01.06-å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–.md) - å­˜å‚¨ç®¡ç†
- â­â­ [å®‰å…¨æœºåˆ¶ä¸è®¿é—®æ§åˆ¶](../../04-é«˜çº§ç‰¹æ€§/03.02-å®‰å…¨æœºåˆ¶ä¸è®¿é—®æ§åˆ¶.md) - å®‰å…¨é…ç½®

#### è¿ç»´å®è·µ

- â­â­â­ [ç›‘æ§ä¸è¯Šæ–­](../../06-è¿ç»´å®è·µ/ç›‘æ§ä¸è¯Šæ–­/06.01-ç›‘æ§ä¸è¯Šæ–­.md) - ç³»ç»Ÿç›‘æ§
- â­â­ [å¤‡ä»½ä¸æ¢å¤](../../06-è¿ç»´å®è·µ/å¤‡ä»½ä¸æ¢å¤/06.06-å¤‡ä»½ä¸æ¢å¤.md) - å¤‡ä»½æ¢å¤

#### é«˜çº§ç‰¹æ€§

- â­â­ [å®‰å…¨æœºåˆ¶ä¸è®¿é—®æ§åˆ¶](../../04-é«˜çº§ç‰¹æ€§/03.02-å®‰å…¨æœºåˆ¶ä¸è®¿é—®æ§åˆ¶.md) - å®‰å…¨æœ€ä½³å®è·µ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.0
**æœ€åæ›´æ–°**: 2025-01-16
**ç»´æŠ¤è€…**: PostgreSQL Documentation Team
