# Kubernetes éƒ¨ç½²æŒ‡å—

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-13
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²åˆ›å»º

---

## ğŸ“‹ ç›®å½•

- [Kubernetes éƒ¨ç½²æŒ‡å—](#kubernetes-éƒ¨ç½²æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [é€‰æ‹©å»ºè®®](#é€‰æ‹©å»ºè®®)
  - [2. ä½¿ç”¨ PostgreSQL Operator](#2-ä½¿ç”¨-postgresql-operator)
    - [2.1 å®‰è£… Crunchy PostgreSQL Operator](#21-å®‰è£…-crunchy-postgresql-operator)
    - [2.2 åˆ›å»º PostgreSQL é›†ç¾¤](#22-åˆ›å»º-postgresql-é›†ç¾¤)
    - [2.3 è¿æ¥æ•°æ®åº“](#23-è¿æ¥æ•°æ®åº“)
  - [3. ä½¿ç”¨ StatefulSet](#3-ä½¿ç”¨-statefulset)
    - [3.1 åˆ›å»º ConfigMap](#31-åˆ›å»º-configmap)
    - [3.2 åˆ›å»º Secret](#32-åˆ›å»º-secret)
    - [3.3 åˆ›å»º StatefulSet](#33-åˆ›å»º-statefulset)
    - [3.4 åˆ›å»º Service](#34-åˆ›å»º-service)
  - [4. é«˜å¯ç”¨é…ç½®](#4-é«˜å¯ç”¨é…ç½®)
    - [4.1 ä½¿ç”¨ Patroni](#41-ä½¿ç”¨-patroni)
    - [4.2 é…ç½®è‡ªåŠ¨æ•…éšœè½¬ç§»](#42-é…ç½®è‡ªåŠ¨æ•…éšœè½¬ç§»)
  - [5. å­˜å‚¨é…ç½®](#5-å­˜å‚¨é…ç½®)
    - [5.1 ä½¿ç”¨ PersistentVolume](#51-ä½¿ç”¨-persistentvolume)
    - [5.2 ä½¿ç”¨ StorageClass](#52-ä½¿ç”¨-storageclass)
  - [6. ç›‘æ§ä¸æ—¥å¿—](#6-ç›‘æ§ä¸æ—¥å¿—)
    - [6.1 ä½¿ç”¨ Prometheus Operator](#61-ä½¿ç”¨-prometheus-operator)
    - [6.2 é…ç½®æ—¥å¿—æ”¶é›†](#62-é…ç½®æ—¥å¿—æ”¶é›†)
  - [7. å¤‡ä»½ä¸æ¢å¤](#7-å¤‡ä»½ä¸æ¢å¤)
    - [7.1 ä½¿ç”¨ pgBackRest](#71-ä½¿ç”¨-pgbackrest)
    - [7.2 æ¢å¤å¤‡ä»½](#72-æ¢å¤å¤‡ä»½)
  - [8. æ·±å…¥é˜…è¯»](#8-æ·±å…¥é˜…è¯»)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
    - [å¤–éƒ¨èµ„æº](#å¤–éƒ¨èµ„æº)

---

## 1. æ¦‚è¿°

åœ¨ Kubernetes ä¸Šéƒ¨ç½² PostgreSQL æœ‰å¤šç§æ–¹å¼ï¼š

- **PostgreSQL Operator**: è‡ªåŠ¨åŒ–ç®¡ç† PostgreSQL é›†ç¾¤ï¼ˆæ¨èï¼‰
- **StatefulSet**: æ‰‹åŠ¨ç®¡ç† PostgreSQL å®ä¾‹
- **Helm Chart**: ä½¿ç”¨ Helm éƒ¨ç½² PostgreSQL

### é€‰æ‹©å»ºè®®

| åœºæ™¯ | æ¨èæ–¹å¼ | è¯´æ˜ |
|------|---------|------|
| ç”Ÿäº§ç¯å¢ƒ | PostgreSQL Operator | è‡ªåŠ¨åŒ–ç®¡ç†ã€é«˜å¯ç”¨ã€å¤‡ä»½æ¢å¤ |
| å¼€å‘æµ‹è¯• | Helm Chart | å¿«é€Ÿéƒ¨ç½²ã€ç®€å•é…ç½® |
| è‡ªå®šä¹‰éœ€æ±‚ | StatefulSet | å®Œå…¨æ§åˆ¶ã€çµæ´»é…ç½® |

---

## 2. ä½¿ç”¨ PostgreSQL Operator

### 2.1 å®‰è£… Crunchy PostgreSQL Operator

```bash
# æ·»åŠ  Helm ä»“åº“
helm repo add postgres-operator https://opensource.crunchydata.com/postgres-operator
helm repo update

# å®‰è£… Operator
helm install postgres-operator postgres-operator/postgres-operator \
  --namespace postgres-operator \
  --create-namespace
```

### 2.2 åˆ›å»º PostgreSQL é›†ç¾¤

```yaml
# postgres-cluster.yaml
apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
  name: postgres-cluster
  namespace: postgres
spec:
  image: registry.developers.crunchydata.com/crunchydata/crunchy-postgres:ubi8-18.0-0
  postgresVersion: 18
  instances:
    - name: instance1
      replicas: 3
      resources:
        requests:
          memory: 1Gi
          cpu: 500m
        limits:
          memory: 2Gi
          cpu: 2000m
      dataVolumeClaimSpec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 10Gi
  backups:
    pgbackrest:
      image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbackrest:ubi8-2.48-0
      repos:
      - name: repo1
        volume:
          volumeClaimSpec:
            accessModes:
            - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
  proxy:
    pgBouncer:
      image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbouncer:ubi8-1.19-0
      replicas: 2
      resources:
        requests:
          memory: 64Mi
          cpu: 100m
```

```bash
# åº”ç”¨é…ç½®
kubectl apply -f postgres-cluster.yaml

# æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
kubectl get postgresclusters -n postgres
```

### 2.3 è¿æ¥æ•°æ®åº“

```bash
# è·å–è¿æ¥ä¿¡æ¯
kubectl get secrets postgres-cluster-pguser-postgres -n postgres -o jsonpath='{.data.password}' | base64 -d

# ç«¯å£è½¬å‘
kubectl port-forward -n postgres svc/postgres-cluster-pgbouncer 5432:5432

# è¿æ¥
psql -h localhost -U postgres -d postgres
```

---

## 3. ä½¿ç”¨ StatefulSet

### 3.1 åˆ›å»º ConfigMap

```yaml
# postgres-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
  namespace: postgres
data:
  postgresql.conf: |
    max_connections = 200
    shared_buffers = 256MB
    effective_cache_size = 1GB
    maintenance_work_mem = 64MB
    checkpoint_completion_target = 0.9
    wal_buffers = 16MB
    default_statistics_target = 100
    random_page_cost = 1.1
    effective_io_concurrency = 200
    work_mem = 4MB
    min_wal_size = 1GB
    max_wal_size = 4GB
```

### 3.2 åˆ›å»º Secret

```yaml
# postgres-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: postgres-secret
  namespace: postgres
type: Opaque
stringData:
  postgres-password: "your-secure-password"
  replication-password: "your-replication-password"
```

### 3.3 åˆ›å»º StatefulSet

```yaml
# postgres-statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: postgres
spec:
  serviceName: postgres
  replicas: 3
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:18
        env:
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: postgres-password
        - name: POSTGRES_REPLICATION_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: replication-password
        - name: PGDATA
          value: /var/lib/postgresql/data/pgdata
        ports:
        - containerPort: 5432
          name: postgres
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
        - name: postgres-config
          mountPath: /etc/postgresql/postgresql.conf
          subPath: postgresql.conf
      volumes:
      - name: postgres-config
        configMap:
          name: postgres-config
  volumeClaimTemplates:
  - metadata:
      name: postgres-storage
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 10Gi
```

### 3.4 åˆ›å»º Service

```yaml
# postgres-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: postgres
spec:
  clusterIP: None
  selector:
    app: postgres
  ports:
  - port: 5432
    name: postgres
---
apiVersion: v1
kind: Service
metadata:
  name: postgres-read
  namespace: postgres
spec:
  selector:
    app: postgres
  ports:
  - port: 5432
    name: postgres
```

---

## 4. é«˜å¯ç”¨é…ç½®

### 4.1 ä½¿ç”¨ Patroni

```yaml
# patroni-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: patroni-config
  namespace: postgres
data:
  patroni.yml: |
    scope: postgres
    namespace: /service/postgres
    name: ${POD_NAME}

    restapi:
      listen: 0.0.0.0:8008
      connect_address: ${POD_IP}:8008

    etcd:
      hosts: etcd-0.etcd:2379,etcd-1.etcd:2379,etcd-2.etcd:2379

    bootstrap:
      dcs:
        ttl: 30
        loop_wait: 10
        retry_timeout: 30
        maximum_lag_on_failover: 1048576
        postgresql:
          use_pg_rewind: true
          parameters:
            wal_level: replica
            hot_standby: "on"
            max_connections: 100
            max_wal_senders: 10
            wal_keep_size: 1GB
            max_replication_slots: 10

    postgresql:
      listen: 0.0.0.0:5432
      connect_address: ${POD_IP}:5432
      data_dir: /var/lib/postgresql/data/pgdata
      pgpass: /tmp/pgpass
      authentication:
        replication:
          username: replicator
          password: ${REPLICATION_PASSWORD}
        superuser:
          username: postgres
          password: ${POSTGRES_PASSWORD}
      parameters:
        unix_socket_directories: '/var/run/postgresql'
```

### 4.2 é…ç½®è‡ªåŠ¨æ•…éšœè½¬ç§»

```yaml
# åœ¨ Patroni é…ç½®ä¸­æ·»åŠ 
bootstrap:
  dcs:
    master_start_timeout: 300
    master_stop_timeout: 0
    postgresql:
      use_slots: true
      parameters:
        synchronous_commit: "on"
        synchronous_standby_names: "ANY 1 (standby1,standby2)"
```

---

## 5. å­˜å‚¨é…ç½®

### 5.1 ä½¿ç”¨ PersistentVolume

```yaml
# pv.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: postgres-pv
spec:
  capacity:
    storage: 100Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: fast-ssd
  hostPath:
    path: /data/postgres
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-pvc
  namespace: postgres
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
  storageClassName: fast-ssd
```

### 5.2 ä½¿ç”¨ StorageClass

```yaml
# storageclass.yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp3
  iops: "3000"
  throughput: "125"
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true
```

---

## 6. ç›‘æ§ä¸æ—¥å¿—

### 6.1 ä½¿ç”¨ Prometheus Operator

```yaml
# postgres-monitor.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: postgres-monitor
  namespace: postgres
spec:
  selector:
    matchLabels:
      app: postgres
  endpoints:
  - port: postgres
    interval: 30s
    path: /metrics
```

### 6.2 é…ç½®æ—¥å¿—æ”¶é›†

```yaml
# åœ¨ StatefulSet ä¸­æ·»åŠ  sidecar
containers:
- name: postgres-exporter
  image: prometheuscommunity/postgres-exporter
  env:
  - name: DATA_SOURCE_NAME
    value: "postgresql://postgres:password@localhost:5432/postgres?sslmode=disable"
  ports:
  - containerPort: 9187
    name: metrics
```

---

## 7. å¤‡ä»½ä¸æ¢å¤

### 7.1 ä½¿ç”¨ pgBackRest

```yaml
# åœ¨ PostgreSQL Operator ä¸­å·²åŒ…å« pgBackRest
# æ‰‹åŠ¨é…ç½®å¤‡ä»½
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup
  namespace: postgres
spec:
  schedule: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: backup
            image: postgres:18
            command:
            - /bin/bash
            - -c
            - |
              pg_dump -h postgres -U postgres -Fc postgres > /backup/postgres-$(date +%Y%m%d).dump
            volumeMounts:
            - name: backup-storage
              mountPath: /backup
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: postgres-backup-pvc
          restartPolicy: OnFailure
```

### 7.2 æ¢å¤å¤‡ä»½

```bash
# ä»å¤‡ä»½æ¢å¤
kubectl exec -it postgres-0 -n postgres -- \
  pg_restore -h localhost -U postgres -d postgres /backup/postgres-20251113.dump
```

---

## 8. æ·±å…¥é˜…è¯»

### ç›¸å…³æ–‡æ¡£

#### éƒ¨ç½²æ¶æ„

- â­â­â­ [äº‘åŸç”Ÿä¸å®¹å™¨åŒ–](./05.12-äº‘åŸç”Ÿä¸å®¹å™¨åŒ–.md) - äº‘åŸç”Ÿæ¶æ„
- â­â­â­ [Docker éƒ¨ç½²æŒ‡å—](./05.12-Dockeréƒ¨ç½².md) - Dockeréƒ¨ç½²
- â­â­ [é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨](../é›†ç¾¤éƒ¨ç½²/05.04-é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨.md) - é«˜å¯ç”¨æ¶æ„
- â­â­ [Serverlesséƒ¨ç½²](./05.15-Serverlesséƒ¨ç½².md) - Serverlessæ¶æ„

#### è¿ç»´å®è·µ

- â­â­â­ [ç›‘æ§ä¸è¯Šæ–­](../../06-è¿ç»´å®è·µ/ç›‘æ§ä¸è¯Šæ–­/06.01-ç›‘æ§ä¸è¯Šæ–­.md) - ç³»ç»Ÿç›‘æ§
- â­â­â­ [å¤‡ä»½ä¸æ¢å¤](../../06-è¿ç»´å®è·µ/å¤‡ä»½ä¸æ¢å¤/06.06-å¤‡ä»½ä¸æ¢å¤.md) - å¤‡ä»½æ¢å¤

### å¤–éƒ¨èµ„æº

- [Crunchy PostgreSQL Operator æ–‡æ¡£](https://access.crunchydata.com/documentation/postgres-operator/)
- [Kubernetes StatefulSet æ–‡æ¡£](https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/)
- [PostgreSQL on Kubernetes æœ€ä½³å®è·µ](https://www.postgresql.org/docs/current/)

---

**æœ€åæ›´æ–°**: 2025-11-13
