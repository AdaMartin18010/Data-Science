# äº‘åŸç”Ÿä¸å®¹å™¨åŒ–

> **æ–‡æ¡£ç‰ˆæœ¬**: v2.0
> **æœ€åæ›´æ–°**: 2025-11-12
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²æ›´æ–°

---

## ğŸ“‹ ç›®å½•

- [äº‘åŸç”Ÿä¸å®¹å™¨åŒ–](#äº‘åŸç”Ÿä¸å®¹å™¨åŒ–)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. åˆå¹¶æ¥æºä¸æ˜ å°„](#2-åˆå¹¶æ¥æºä¸æ˜ å°„)
  - [3. å®¹å™¨åŒ–è¦ç‚¹](#3-å®¹å™¨åŒ–è¦ç‚¹)
  - [4. Kubernetes](#4-kubernetes)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
  - [6. åç»­æ•´åˆä»»åŠ¡](#6-åç»­æ•´åˆä»»åŠ¡)

---

## 1. æ¦‚è¿°

- å®¹å™¨é•œåƒã€Kubernetesç¼–æ’ã€æŒä¹…åŒ–ä¸è¿ç»´

## 2. åˆå¹¶æ¥æºä¸æ˜ å°„

- 1.1.15-äº‘åŸç”Ÿä¸å®¹å™¨åŒ–éƒ¨ç½²-æ‰©å……ç‰ˆ.md
- 1.1.15-äº‘åŸç”Ÿä¸å®¹å™¨åŒ–éƒ¨ç½².md

## 3. å®¹å™¨åŒ–è¦ç‚¹

- é•œåƒæ„å»ºã€å‚æ•°æ³¨å…¥ã€å¥åº·æ£€æŸ¥ã€æ—¥å¿—

### 3.1 Dockeré•œåƒæ„å»º

#### åŸºç¡€Dockerfile

```dockerfile
# ä½¿ç”¨å®˜æ–¹PostgreSQLé•œåƒ
FROM postgres:18

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV POSTGRES_DB=mydb
ENV POSTGRES_USER=postgres
ENV POSTGRES_PASSWORD=changeme

# å¤åˆ¶è‡ªå®šä¹‰é…ç½®
COPY postgresql.conf /etc/postgresql/postgresql.conf
COPY pg_hba.conf /etc/postgresql/pg_hba.conf

# å¤åˆ¶åˆå§‹åŒ–è„šæœ¬
COPY init.sql /docker-entrypoint-initdb.d/

# è®¾ç½®æ•°æ®ç›®å½•æƒé™
RUN chown -R postgres:postgres /var/lib/postgresql/data

# æš´éœ²ç«¯å£
EXPOSE 5432

# ä½¿ç”¨è‡ªå®šä¹‰å¯åŠ¨è„šæœ¬
COPY docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh
ENTRYPOINT ["docker-entrypoint.sh"]
CMD ["postgres"]
```

#### å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM postgres:18 AS builder

# å®‰è£…æ‰©å±•
RUN apt-get update && apt-get install -y \
    postgresql-18-pgvector \
    postgresql-18-pg-stat-statements \
    && rm -rf /var/lib/apt/lists/*

# è¿è¡Œé˜¶æ®µ
FROM postgres:18

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶æ‰©å±•
COPY --from=builder /usr/share/postgresql/18/extension/* \
    /usr/share/postgresql/18/extension/
COPY --from=builder /usr/lib/postgresql/18/lib/* \
    /usr/lib/postgresql/18/lib/

# å¤åˆ¶é…ç½®å’Œè„šæœ¬
COPY postgresql.conf /etc/postgresql/
COPY init-extensions.sql /docker-entrypoint-initdb.d/
```

### 3.2 å‚æ•°æ³¨å…¥

#### ä½¿ç”¨ç¯å¢ƒå˜é‡

```bash
# docker-compose.yml
version: '3.8'
services:
  postgres:
    image: postgres:18
    environment:
      POSTGRES_DB: mydb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=zh_CN.UTF-8"
      # è‡ªå®šä¹‰é…ç½®å‚æ•°
      POSTGRES_SHARED_BUFFERS: 256MB
      POSTGRES_MAX_CONNECTIONS: 100
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
```

#### ä½¿ç”¨ConfigMapï¼ˆKubernetesï¼‰

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
data:
  postgresql.conf: |
    shared_buffers = 256MB
    max_connections = 100
    work_mem = 4MB
    effective_cache_size = 1GB
  pg_hba.conf: |
    host all all 0.0.0.0/0 md5
```

### 3.3 å¥åº·æ£€æŸ¥

#### Dockerå¥åº·æ£€æŸ¥

```dockerfile
# Dockerfile
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD pg_isready -U postgres -d mydb || exit 1
```

#### Docker Composeå¥åº·æ£€æŸ¥

```yaml
services:
  postgres:
    image: postgres:18
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
```

#### Kuberneteså¥åº·æ£€æŸ¥

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
spec:
  template:
    spec:
      containers:
      - name: postgres
        image: postgres:18
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - pg_isready -U postgres
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - pg_isready -U postgres
          initialDelaySeconds: 5
          periodSeconds: 5
```

### 3.4 æ—¥å¿—ç®¡ç†

#### Dockeræ—¥å¿—é…ç½®

```yaml
services:
  postgres:
    image: postgres:18
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=postgres"
```

#### æ—¥å¿—æ”¶é›†ï¼ˆFluentdï¼‰

```yaml
# docker-compose.yml
services:
  postgres:
    image: postgres:18
    logging:
      driver: "fluentd"
      options:
        fluentd-address: localhost:24224
        tag: "postgres.{{.Name}}"

  fluentd:
    image: fluent/fluentd:latest
    volumes:
      - ./fluentd.conf:/fluentd/etc/fluent.conf
    ports:
      - "24224:24224"
```

## 4. Kubernetes

- StatefulSetã€PV/PVCã€Operatorã€å¤‡ä»½ä¸ä¼¸ç¼©

### 4.1 StatefulSetéƒ¨ç½²

#### åŸºç¡€StatefulSet

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
spec:
  serviceName: postgres
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:18
        env:
        - name: POSTGRES_DB
          value: mydb
        - name: POSTGRES_USER
          value: postgres
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: password
        ports:
        - containerPort: 5432
          name: postgres
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
  volumeClaimTemplates:
  - metadata:
      name: postgres-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 20Gi
```

### 4.2 PersistentVolumeå’ŒPersistentVolumeClaim

#### åˆ›å»ºStorageClass

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp3
  fsType: ext4
  encrypted: "true"
```

#### ä½¿ç”¨PVC

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-pvc
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: fast-ssd
  resources:
    requests:
      storage: 50Gi
```

### 4.3 PostgreSQL Operator

#### Crunchy PostgreSQL Operator

```bash
# å®‰è£…Operator
kubectl apply -f https://raw.githubusercontent.com/CrunchyData/postgres-operator/v5.3.0/install/kubectl/postgres-operator.yaml

# åˆ›å»ºPostgreSQLé›†ç¾¤
kubectl apply -f - <<EOF
apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
  name: postgres-cluster
spec:
  image: registry.developers.crunchydata.com/crunchydata/crunchy-postgres:ubi8-18.0-0
  postgresVersion: 18
  instances:
    - name: instance1
      replicas: 2
      dataVolumeClaimSpec:
        accessModes:
        - "ReadWriteOnce"
        resources:
          requests:
            storage: 10Gi
  backups:
    pgbackrest:
      image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbackrest:ubi8-2.48-0
      repos:
      - name: repo1
        volume:
          volumeClaimSpec:
            accessModes:
            - "ReadWriteOnce"
            resources:
              requests:
                storage: 20Gi
EOF
```

#### Zalando PostgreSQL Operator

```yaml
apiVersion: "acid.zalan.do/v1"
kind: postgresql
metadata:
  name: postgres-cluster
spec:
  teamId: "myteam"
  volume:
    size: 10Gi
  numberOfInstances: 2
  users:
    zalando:
    - superuser
    - createdb
  databases:
    foo: zalando
  postgresql:
    version: "18"
```

### 4.4 è‡ªåŠ¨å¤‡ä»½

#### CronJobå¤‡ä»½

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup
spec:
  schedule: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: pg-dump
            image: postgres:18
            command:
            - /bin/sh
            - -c
            - |
              pg_dump -h postgres -U postgres mydb > /backup/mydb-$(date +%Y%m%d).sql
            env:
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: password
            volumeMounts:
            - name: backup-volume
              mountPath: /backup
          volumes:
          - name: backup-volume
            persistentVolumeClaim:
              claimName: backup-pvc
          restartPolicy: OnFailure
```

### 4.5 è‡ªåŠ¨æ‰©ç¼©å®¹

#### HPAé…ç½®

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: postgres-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: postgres
  minReplicas: 1
  maxReplicas: 3
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
```

## 5. æœ€ä½³å®è·µ

- èµ„æºè¯·æ±‚/é™åˆ¶ã€äº²å’Œ/åäº²å’Œã€æ»šåŠ¨å‡çº§

### 5.1 èµ„æºè¯·æ±‚å’Œé™åˆ¶

```yaml
spec:
  containers:
  - name: postgres
    image: postgres:18
    resources:
      requests:
        memory: "2Gi"
        cpu: "1000m"
      limits:
        memory: "4Gi"
        cpu: "2000m"
```

### 5.2 äº²å’Œæ€§å’Œåäº²å’Œæ€§

#### Podåäº²å’Œæ€§ï¼ˆé¿å…åŒä¸€èŠ‚ç‚¹ï¼‰

```yaml
spec:
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
            - key: app
              operator: In
              values:
              - postgres
          topologyKey: kubernetes.io/hostname
```

#### èŠ‚ç‚¹äº²å’Œæ€§ï¼ˆæŒ‡å®šèŠ‚ç‚¹ç±»å‹ï¼‰

```yaml
spec:
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: node-type
            operator: In
            values:
            - database
```

### 5.3 æ»šåŠ¨å‡çº§

#### æ›´æ–°ç­–ç•¥

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
spec:
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      partition: 0  # ä»ç¬¬0ä¸ªPodå¼€å§‹æ›´æ–°
  template:
    spec:
      containers:
      - name: postgres
        image: postgres:18  # æ›´æ–°é•œåƒç‰ˆæœ¬
```

#### é‡‘ä¸é›€å‘å¸ƒ

```yaml
# 1. åˆ›å»ºé‡‘ä¸é›€ç‰ˆæœ¬
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-canary
spec:
  replicas: 1
  template:
    spec:
      containers:
      - name: postgres
        image: postgres:18-new

# 2. é€æ­¥å¢åŠ é‡‘ä¸é›€æµé‡
# ä½¿ç”¨Serviceå’ŒTraffic Splitting
```

### 5.4 ç½‘ç»œç­–ç•¥

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-netpol
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: myapp
    ports:
    - protocol: TCP
      port: 5432
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: backup
    ports:
    - protocol: TCP
      port: 5432
```

### 5.5 é…ç½®ç®¡ç†

#### ä½¿ç”¨ConfigMapå’ŒSecret

```yaml
# ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
data:
  postgresql.conf: |
    shared_buffers = 256MB
    max_connections = 100

# Secret
apiVersion: v1
kind: Secret
metadata:
  name: postgres-secret
type: Opaque
stringData:
  password: changeme
  username: postgres
```

### 5.6 ç›‘æ§é›†æˆ

#### Prometheusç›‘æ§

```yaml
apiVersion: v1
kind: Service
metadata:
  name: postgres
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9187"
spec:
  ports:
  - name: metrics
    port: 9187
    targetPort: 9187
```

## 6. åç»­æ•´åˆä»»åŠ¡

- å¢è¡¥Helmç¤ºä¾‹ä¸Operatorå¯¹æ¯”

### 6.1 Helm Chartç¤ºä¾‹

```yaml
# values.yaml
postgresql:
  image:
    repository: postgres
    tag: "18"
  auth:
    postgresPassword: changeme
    database: mydb
  persistence:
    enabled: true
    size: 20Gi
  resources:
    requests:
      memory: "2Gi"
      cpu: "1000m"
    limits:
      memory: "4Gi"
      cpu: "2000m"
```

```bash
# å®‰è£…Helm Chart
helm repo add bitnami https://charts.bitnami.com/bitnami
helm install postgres bitnami/postgresql -f values.yaml
```

### 6.2 Operatorå¯¹æ¯”

| ç‰¹æ€§ | Crunchy Operator | Zalando Operator | CloudNativePG |
|------|-----------------|-----------------|---------------|
| é«˜å¯ç”¨ | âœ… | âœ… | âœ… |
| è‡ªåŠ¨å¤‡ä»½ | âœ… (pgBackRest) | âœ… | âœ… |
| ç›‘æ§é›†æˆ | âœ… | âœ… | âœ… |
| æ‰©å±•æ”¯æŒ | âœ… | âœ… | âœ… |
| ç¤¾åŒºæ´»è·ƒåº¦ | é«˜ | ä¸­ | é«˜ |
| æ˜“ç”¨æ€§ | ä¸­ | é«˜ | é«˜ |

### 6.3 é€‰æ‹©å»ºè®®

- **å°å‹é¡¹ç›®**: ä½¿ç”¨StatefulSet + ConfigMap/Secret
- **ä¸­å‹é¡¹ç›®**: ä½¿ç”¨Helm Chartï¼ˆå¦‚Bitnamiï¼‰
- **å¤§å‹é¡¹ç›®**: ä½¿ç”¨Operatorï¼ˆæ¨èCrunchyæˆ–CloudNativePGï¼‰
- **äº‘ç¯å¢ƒ**: ä½¿ç”¨äº‘æœåŠ¡å•†çš„æ‰˜ç®¡æœåŠ¡
