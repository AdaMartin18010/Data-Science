# Docker éƒ¨ç½²æŒ‡å—

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æœ€åŽæ›´æ–°**: 2025-11-13
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æŽ¨è) â­ | 17.x (æŽ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²åˆ›å»º

---

## ðŸ“‹ ç›®å½•

- [Docker éƒ¨ç½²æŒ‡å—](#docker-éƒ¨ç½²æŒ‡å—)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. å•å®¹å™¨éƒ¨ç½²](#2-å•å®¹å™¨éƒ¨ç½²)
  - [3. Docker Compose éƒ¨ç½²](#3-docker-compose-éƒ¨ç½²)
  - [4. æ•°æ®æŒä¹…åŒ–](#4-æ•°æ®æŒä¹…åŒ–)
  - [5. ç½‘ç»œé…ç½®](#5-ç½‘ç»œé…ç½®)
  - [6. çŽ¯å¢ƒå˜é‡é…ç½®](#6-çŽ¯å¢ƒå˜é‡é…ç½®)
  - [7. è‡ªå®šä¹‰é…ç½®](#7-è‡ªå®šä¹‰é…ç½®)
  - [8. é«˜å¯ç”¨éƒ¨ç½²](#8-é«˜å¯ç”¨éƒ¨ç½²)
  - [9. ç›‘æŽ§ä¸Žæ—¥å¿—](#9-ç›‘æŽ§ä¸Žæ—¥å¿—)
  - [10. æ·±å…¥é˜…è¯»](#10-æ·±å…¥é˜…è¯»)

---

## 1. æ¦‚è¿°

ä½¿ç”¨ Docker éƒ¨ç½² PostgreSQL çš„ä¼˜åŠ¿ï¼š

- **å¿«é€Ÿéƒ¨ç½²**: ä¸€é”®å¯åŠ¨ PostgreSQL å®žä¾‹
- **çŽ¯å¢ƒéš”ç¦»**: å®¹å™¨åŒ–éƒ¨ç½²ï¼Œé¿å…çŽ¯å¢ƒå†²çª
- **æ˜“äºŽç®¡ç†**: ä½¿ç”¨ Docker Compose ç®¡ç†å¤šå®¹å™¨åº”ç”¨
- **ç‰ˆæœ¬æŽ§åˆ¶**: è½»æ¾åˆ‡æ¢ PostgreSQL ç‰ˆæœ¬

---

## 2. å•å®¹å™¨éƒ¨ç½²

### 2.1 åŸºæœ¬éƒ¨ç½²

```bash
# æ‹‰å–é•œåƒ
docker pull postgres:18

# è¿è¡Œå®¹å™¨
docker run -d \
  --name postgres \
  -e POSTGRES_PASSWORD=mysecretpassword \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_DB=mydb \
  -p 5432:5432 \
  postgres:18
```

### 2.2 æ•°æ®æŒä¹…åŒ–

```bash
# ä½¿ç”¨å‘½åå·
docker run -d \
  --name postgres \
  -e POSTGRES_PASSWORD=mysecretpassword \
  -v postgres_data:/var/lib/postgresql/data \
  -p 5432:5432 \
  postgres:18

# ä½¿ç”¨ç»‘å®šæŒ‚è½½
docker run -d \
  --name postgres \
  -e POSTGRES_PASSWORD=mysecretpassword \
  -v /host/path:/var/lib/postgresql/data \
  -p 5432:5432 \
  postgres:18
```

### 2.3 è¿žæŽ¥æµ‹è¯•

```bash
# ä»Žå®¹å™¨å†…è¿žæŽ¥
docker exec -it postgres psql -U postgres -d mydb

# ä»Žä¸»æœºè¿žæŽ¥
psql -h localhost -U postgres -d mydb
```

---

## 3. Docker Compose éƒ¨ç½²

### 3.1 åŸºæœ¬é…ç½®

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:18
    container_name: postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: mysecretpassword
      POSTGRES_DB: mydb
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
```

```bash
# å¯åŠ¨æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f postgres

# åœæ­¢æœåŠ¡
docker-compose down

# åœæ­¢å¹¶åˆ é™¤æ•°æ®å·
docker-compose down -v
```

### 3.2 å®Œæ•´é…ç½®ç¤ºä¾‹

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:18
    container_name: postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-mysecretpassword}
      POSTGRES_DB: ${POSTGRES_DB:-mydb}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
      - ./postgresql.conf:/etc/postgresql/postgresql.conf
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    restart: unless-stopped
    networks:
      - postgres_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - postgres_network
    restart: unless-stopped

volumes:
  postgres_data:
  pgadmin_data:

networks:
  postgres_network:
    driver: bridge
```

---

## 4. æ•°æ®æŒä¹…åŒ–

### 4.1 ä½¿ç”¨å‘½åå·ï¼ˆæŽ¨èï¼‰

```yaml
volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /host/path/to/data
```

### 4.2 ä½¿ç”¨ç»‘å®šæŒ‚è½½

```yaml
volumes:
  - /host/path:/var/lib/postgresql/data
```

### 4.3 å¤‡ä»½æ•°æ®å·

```bash
# å¤‡ä»½æ•°æ®å·
docker run --rm \
  -v postgres_data:/data \
  -v $(pwd):/backup \
  alpine tar czf /backup/postgres_backup.tar.gz /data

# æ¢å¤æ•°æ®å·
docker run --rm \
  -v postgres_data:/data \
  -v $(pwd):/backup \
  alpine tar xzf /backup/postgres_backup.tar.gz -C /
```

---

## 5. ç½‘ç»œé…ç½®

### 5.1 è‡ªå®šä¹‰ç½‘ç»œ

```yaml
networks:
  postgres_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

### 5.2 è¿žæŽ¥å…¶ä»–å®¹å™¨

```yaml
services:
  app:
    image: myapp:latest
    depends_on:
      - postgres
    environment:
      DATABASE_URL: postgresql://postgres:password@postgres:5432/mydb
    networks:
      - postgres_network
```

---

## 6. çŽ¯å¢ƒå˜é‡é…ç½®

### 6.1 å¸¸ç”¨çŽ¯å¢ƒå˜é‡

| å˜é‡ | è¯´æ˜Ž | é»˜è®¤å€¼ |
|------|------|--------|
| `POSTGRES_USER` | æ•°æ®åº“è¶…çº§ç”¨æˆ· | `postgres` |
| `POSTGRES_PASSWORD` | æ•°æ®åº“å¯†ç  | éšæœºç”Ÿæˆ |
| `POSTGRES_DB` | åˆå§‹æ•°æ®åº“å | `POSTGRES_USER` |
| `POSTGRES_INITDB_ARGS` | initdb å‚æ•° | - |
| `POSTGRES_HOST_AUTH_METHOD` | è®¤è¯æ–¹æ³• | `scram-sha-256` |

### 6.2 ä½¿ç”¨ .env æ–‡ä»¶

```bash
# .env
POSTGRES_USER=postgres
POSTGRES_PASSWORD=mysecretpassword
POSTGRES_DB=mydb
POSTGRES_PORT=5432
```

```yaml
# docker-compose.yml
services:
  postgres:
    env_file:
      - .env
```

---

## 7. è‡ªå®šä¹‰é…ç½®

### 7.1 è‡ªå®šä¹‰ postgresql.conf

```bash
# åˆ›å»ºè‡ªå®šä¹‰é…ç½®æ–‡ä»¶
cat > postgresql.conf <<EOF
max_connections = 200
shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 64MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
random_page_cost = 1.1
effective_io_concurrency = 200
work_mem = 4MB
min_wal_size = 1GB
max_wal_size = 4GB
EOF
```

```yaml
# docker-compose.yml
services:
  postgres:
    volumes:
      - ./postgresql.conf:/etc/postgresql/postgresql.conf
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
```

### 7.2 åˆå§‹åŒ–è„šæœ¬

```sql
-- init.sql
CREATE DATABASE myapp;
CREATE USER myapp_user WITH PASSWORD 'password';
GRANT ALL PRIVILEGES ON DATABASE myapp TO myapp_user;
```

```yaml
# docker-compose.yml
services:
  postgres:
    volumes:
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
```

---

## 8. é«˜å¯ç”¨éƒ¨ç½²

### 8.1 ä¸»ä»Žå¤åˆ¶

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres-primary:
    image: postgres:18
    container_name: postgres-primary
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: replicator_password
    volumes:
      - primary_data:/var/lib/postgresql/data
      - ./primary.conf:/etc/postgresql/postgresql.conf
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    ports:
      - "5432:5432"
    networks:
      - postgres_network

  postgres-replica:
    image: postgres:18
    container_name: postgres-replica
    environment:
      PGUSER: replicator
      PGPASSWORD: replicator_password
      POSTGRES_MASTER_SERVICE: postgres-primary
    volumes:
      - replica_data:/var/lib/postgresql/data
    depends_on:
      - postgres-primary
    ports:
      - "5433:5432"
    networks:
      - postgres_network

volumes:
  primary_data:
  replica_data:

networks:
  postgres_network:
```

---

## 9. ç›‘æŽ§ä¸Žæ—¥å¿—

### 9.1 æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs postgres

# å®žæ—¶æŸ¥çœ‹æ—¥å¿—
docker logs -f postgres

# æŸ¥çœ‹æœ€åŽ100è¡Œ
docker logs --tail 100 postgres
```

### 9.2 ä½¿ç”¨ Prometheus ç›‘æŽ§

```yaml
# docker-compose.yml
services:
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter
    environment:
      DATA_SOURCE_NAME: postgresql://postgres:password@postgres:5432/postgres?sslmode=disable
    ports:
      - "9187:9187"
    depends_on:
      - postgres
    networks:
      - postgres_network
```

---

## 10. æ·±å…¥é˜…è¯»

### ç›¸å…³æ–‡æ¡£

- [Kubernetes éƒ¨ç½²æŒ‡å—](./05.13-Kuberneteséƒ¨ç½².md)
- [äº‘åŽŸç”Ÿä¸Žå®¹å™¨åŒ–](./05.12-äº‘åŽŸç”Ÿä¸Žå®¹å™¨åŒ–.md)
- [å•æœºéƒ¨ç½²ä¸Žé…ç½®](../å•æœºéƒ¨ç½²/05.01-å•æœºéƒ¨ç½²ä¸Žé…ç½®.md)
- [ç›‘æŽ§ä¸Žè¯Šæ–­](../../06-è¿ç»´å®žè·µ/ç›‘æŽ§ä¸Žè¯Šæ–­/06.01-ç›‘æŽ§ä¸Žè¯Šæ–­.md)

### å¤–éƒ¨èµ„æº

- [PostgreSQL Docker å®˜æ–¹é•œåƒ](https://hub.docker.com/_/postgres)
- [Docker Compose æ–‡æ¡£](https://docs.docker.com/compose/)
- [PostgreSQL å®˜æ–¹æ–‡æ¡£](https://www.postgresql.org/docs/)

---

**æœ€åŽæ›´æ–°**: 2025-11-13
