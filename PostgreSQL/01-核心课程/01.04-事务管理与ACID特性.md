# PostgreSQLäº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§å®Œæ•´æŒ‡å—

> **ç‰ˆæœ¬**: v3.1
> **æœ€åæ›´æ–°**: 2025-11-22
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **éš¾åº¦**: â­â­â­â­
> **åº”ç”¨åœºæ™¯**: äº‹åŠ¡ç®¡ç†ã€å¹¶å‘æ§åˆ¶ã€æ•°æ®ä¸€è‡´æ€§ã€ç³»ç»Ÿè®¾è®¡
> ğŸ†• **PostgreSQL 18äº‹åŠ¡æ”¹è¿›**: MVCCä¼˜åŒ–ã€æ›´é«˜æ•ˆçš„VACUUMæœºåˆ¶ã€é€»è¾‘å¤åˆ¶æ€§èƒ½æå‡38%ï¼ˆå·²è¯¦ç»†å±•å¼€ï¼‰ã€å¼‚æ­¥I/Oæå‡äº‹åŠ¡æ—¥å¿—å†™å…¥æ€§èƒ½ï¼ˆå·²è¯¦ç»†å±•å¼€ï¼‰

---

## ğŸ“‘ ç›®å½•

- [PostgreSQLäº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§å®Œæ•´æŒ‡å—](#postgresqläº‹åŠ¡ç®¡ç†ä¸acidç‰¹æ€§å®Œæ•´æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“Š æ€ç»´å¯¼å›¾](#-æ€ç»´å¯¼å›¾)
  - [ä¸€ã€å®šä¹‰ä¸å½¢å¼åŒ–](#ä¸€å®šä¹‰ä¸å½¢å¼åŒ–)
    - [1.1 æ¦‚å¿µå®šä¹‰](#11-æ¦‚å¿µå®šä¹‰)
    - [1.2 å½¢å¼åŒ–å®šä¹‰](#12-å½¢å¼åŒ–å®šä¹‰)
    - [1.3 æ ¸å¿ƒå±æ€§](#13-æ ¸å¿ƒå±æ€§)
  - [äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#äºŒçŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [2.1 äº‹åŠ¡éš”ç¦»çº§åˆ«å¯¹æ¯”](#21-äº‹åŠ¡éš”ç¦»çº§åˆ«å¯¹æ¯”)
    - [2.2 ACIDç‰¹æ€§å®ç°å¯¹æ¯”](#22-acidç‰¹æ€§å®ç°å¯¹æ¯”)
  - [ä¸‰ã€ç†è®ºåŸºç¡€](#ä¸‰ç†è®ºåŸºç¡€)
    - [3.1 ACIDæ€§è´¨ç†è®º](#31-acidæ€§è´¨ç†è®º)
    - [3.2 äº‹åŠ¡éš”ç¦»ç†è®º](#32-äº‹åŠ¡éš”ç¦»ç†è®º)
    - [3.3 äº‹åŠ¡çŠ¶æ€è½¬æ¢](#33-äº‹åŠ¡çŠ¶æ€è½¬æ¢)
  - [å››ã€PostgreSQLå®ç°](#å››postgresqlå®ç°)
    - [4.1 äº‹åŠ¡æ§åˆ¶è¯­å¥](#41-äº‹åŠ¡æ§åˆ¶è¯­å¥)
    - [4.2 äº‹åŠ¡IDç®¡ç†](#42-äº‹åŠ¡idç®¡ç†)
    - [4.3 é•¿äº‹åŠ¡ç®¡ç†](#43-é•¿äº‹åŠ¡ç®¡ç†)
  - [äº”ã€å¹¶å‘æ§åˆ¶æœºåˆ¶](#äº”å¹¶å‘æ§åˆ¶æœºåˆ¶)
    - [5.1 MVCCå®ç°](#51-mvccå®ç°)
    - [5.2 é”æœºåˆ¶](#52-é”æœºåˆ¶)
    - [5.3 æ­»é”æ£€æµ‹](#53-æ­»é”æ£€æµ‹)
  - [å…­ã€äº‹åŠ¡æ—¥å¿—ä¸æ¢å¤](#å…­äº‹åŠ¡æ—¥å¿—ä¸æ¢å¤)
    - [6.1 WALæœºåˆ¶](#61-walæœºåˆ¶)
    - [6.2 äº‹åŠ¡æ¢å¤](#62-äº‹åŠ¡æ¢å¤)
  - [ä¸ƒã€æ€§èƒ½ä¼˜åŒ–](#ä¸ƒæ€§èƒ½ä¼˜åŒ–)
    - [7.1 äº‹åŠ¡ä¼˜åŒ–ç­–ç•¥](#71-äº‹åŠ¡ä¼˜åŒ–ç­–ç•¥)
    - [7.2 é”ä¼˜åŒ–](#72-é”ä¼˜åŒ–)
  - [å…«ã€å®é™…åº”ç”¨æ¡ˆä¾‹](#å…«å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [8.1 é“¶è¡Œè½¬è´¦ç³»ç»Ÿ](#81-é“¶è¡Œè½¬è´¦ç³»ç»Ÿ)
    - [8.2 åº“å­˜ç®¡ç†ç³»ç»Ÿ](#82-åº“å­˜ç®¡ç†ç³»ç»Ÿ)
  - [ä¹ã€ç›¸å…³æ¦‚å¿µ](#ä¹ç›¸å…³æ¦‚å¿µ)
    - [9.1 ä¸Šä½æ¦‚å¿µ](#91-ä¸Šä½æ¦‚å¿µ)
    - [9.2 ä¸‹ä½æ¦‚å¿µ](#92-ä¸‹ä½æ¦‚å¿µ)
    - [9.3 å¹³è¡Œæ¦‚å¿µ](#93-å¹³è¡Œæ¦‚å¿µ)
  - [åã€å‚è€ƒèµ„æº](#åå‚è€ƒèµ„æº)
    - [10.1 ç›¸å…³æ–‡æ¡£](#101-ç›¸å…³æ–‡æ¡£)
    - [10.2 å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹](#102-å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹)
    - [10.3 å‚è€ƒæ–‡çŒ®](#103-å‚è€ƒæ–‡çŒ®)
    - [10.4 Wikidataå¯¹é½](#104-wikidataå¯¹é½)

---

## ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((äº‹åŠ¡ç®¡ç†))
    ACIDç‰¹æ€§
      åŸå­æ€§
      ä¸€è‡´æ€§
      éš”ç¦»æ€§
      æŒä¹…æ€§
    ç†è®ºåŸºç¡€
      ACIDç†è®º
      éš”ç¦»çº§åˆ«
      çŠ¶æ€è½¬æ¢
    PostgreSQLå®ç°
      äº‹åŠ¡æ§åˆ¶
      äº‹åŠ¡ID
      é•¿äº‹åŠ¡
    å¹¶å‘æ§åˆ¶
      MVCC
      é”æœºåˆ¶
      æ­»é”æ£€æµ‹
    äº‹åŠ¡æ—¥å¿—
      WALæœºåˆ¶
      äº‹åŠ¡æ¢å¤
    æ€§èƒ½ä¼˜åŒ–
      äº‹åŠ¡ä¼˜åŒ–
      é”ä¼˜åŒ–
    å®é™…åº”ç”¨
      é“¶è¡Œè½¬è´¦
      åº“å­˜ç®¡ç†
```

---

## ä¸€ã€å®šä¹‰ä¸å½¢å¼åŒ–

### 1.1 æ¦‚å¿µå®šä¹‰

**ä¸­æ–‡å®šä¹‰**: äº‹åŠ¡æ˜¯æ•°æ®åº“ä¸­çš„é€»è¾‘å·¥ä½œå•å…ƒï¼Œå…·æœ‰ACIDç‰¹æ€§ï¼ˆåŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§ï¼‰ã€‚PostgreSQLé€šè¿‡WALæœºåˆ¶ã€MVCCå’Œé”æœºåˆ¶ç¡®ä¿äº‹åŠ¡çš„ACIDç‰¹æ€§ã€‚

**English Definition**: A transaction is a logical unit of work in a database with ACID properties (Atomicity, Consistency, Isolation, Durability). PostgreSQL ensures ACID properties through WAL mechanism, MVCC, and locking mechanisms.

### 1.2 å½¢å¼åŒ–å®šä¹‰

```latex
% æ•°å­¦ç¬¦å·å®šä¹‰
\newcommand{\trans}{\mathcal{T}}
\newcommand{\op}{\mathcal{O}}
\newcommand{\state}{\mathcal{S}}
\newcommand{\commit}{\mathcal{C}}
\newcommand{\abort}{\mathcal{A}}

% äº‹åŠ¡çš„å½¢å¼åŒ–å®šä¹‰
\trans = \{\op_1, \op_2, \ldots, \op_n\}

% ACIDæ€§è´¨çš„å½¢å¼åŒ–å®šä¹‰
\begin{align}
\text{Atomicity: } & \forall \trans, \trans \text{ è¦ä¹ˆå®Œå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå®Œå…¨ä¸æ‰§è¡Œ} \\
\text{Consistency: } & \forall \trans, \state_{\text{before}} \models \text{constraints} \Rightarrow \state_{\text{after}} \models \text{constraints} \\
\text{Isolation: } & \forall \trans_1, \trans_2, \trans_1 \parallel \trans_2 \equiv \trans_1; \trans_2 \text{ æˆ– } \trans_2; \trans_1 \\
\text{Durability: } & \forall \trans, \commit(\trans) \Rightarrow \text{ç»“æœæ°¸ä¹…ä¿å­˜}
\end{align}
```

### 1.3 æ ¸å¿ƒå±æ€§

- **åŸå­æ€§ (Atomicity)**: äº‹åŠ¡æ˜¯ä¸å¯åˆ†å‰²çš„å·¥ä½œå•å…ƒ
- **ä¸€è‡´æ€§ (Consistency)**: äº‹åŠ¡æ‰§è¡Œå‰åæ•°æ®åº“ä¿æŒä¸€è‡´çŠ¶æ€
- **éš”ç¦»æ€§ (Isolation)**: å¹¶å‘äº‹åŠ¡é—´ç›¸äº’éš”ç¦»
- **æŒä¹…æ€§ (Durability)**: æäº¤çš„äº‹åŠ¡ç»“æœæ°¸ä¹…ä¿å­˜

---

## äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 2.1 äº‹åŠ¡éš”ç¦»çº§åˆ«å¯¹æ¯”

| éš”ç¦»çº§åˆ« | è„è¯» | ä¸å¯é‡å¤è¯» | å¹»è¯» | æ€§èƒ½ | é€‚ç”¨åœºæ™¯ |
|---------|------|-----------|------|------|---------|
| READ UNCOMMITTED | å¯èƒ½ | å¯èƒ½ | å¯èƒ½ | æœ€é«˜ | å¾ˆå°‘ä½¿ç”¨ |
| READ COMMITTED | ä¸å¯èƒ½ | å¯èƒ½ | å¯èƒ½ | é«˜ | PostgreSQLé»˜è®¤ |
| REPEATABLE READ | ä¸å¯èƒ½ | ä¸å¯èƒ½ | å¯èƒ½ | ä¸­ | éœ€è¦ä¸€è‡´æ€§è¯» |
| SERIALIZABLE | ä¸å¯èƒ½ | ä¸å¯èƒ½ | ä¸å¯èƒ½ | æœ€ä½ | æœ€é«˜ä¸€è‡´æ€§è¦æ±‚ |

### 2.2 ACIDç‰¹æ€§å®ç°å¯¹æ¯”

| ACIDç‰¹æ€§ | PostgreSQLå®ç° | æ€§èƒ½å½±å“ | å¯é æ€§ |
|---------|---------------|---------|--------|
| åŸå­æ€§ | WAL + å›æ»šæ®µ | ä½ | æé«˜ |
| ä¸€è‡´æ€§ | çº¦æŸæ£€æŸ¥ + é” | ä¸­ | æé«˜ |
| éš”ç¦»æ€§ | MVCC + é” | ä½-ä¸­ | é«˜ |
| æŒä¹…æ€§ | WAL + fsync | ä¸­ | æé«˜ |

---

## ä¸‰ã€ç†è®ºåŸºç¡€

### 3.1 ACIDæ€§è´¨ç†è®º

```latex
\begin{theorem}[ACIDæ€§è´¨å®Œå¤‡æ€§]
è®¾äº‹åŠ¡ T = \{op_1, op_2, \ldots, op_n\}ï¼Œåˆ™ï¼š
1. åŸå­æ€§ï¼šâˆ€T, Tè¦ä¹ˆå®Œå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå®Œå…¨ä¸æ‰§è¡Œ
2. ä¸€è‡´æ€§ï¼šâˆ€T, æ‰§è¡Œå‰åæ•°æ®åº“çŠ¶æ€æ»¡è¶³å®Œæ•´æ€§çº¦æŸ
3. éš”ç¦»æ€§ï¼šâˆ€Tâ‚,Tâ‚‚, Tâ‚çš„æ‰§è¡Œå¯¹Tâ‚‚ä¸å¯è§
4. æŒä¹…æ€§ï¼šâˆ€T, æäº¤åçš„äº‹åŠ¡ç»“æœæ°¸ä¹…ä¿å­˜
\end{theorem}

\begin{proof}
åŸºäºWALåè®®ã€MVCCæœºåˆ¶å’Œé”åè®®ï¼Œå¯ä»¥è¯æ˜ACIDæ€§è´¨çš„æ­£ç¡®æ€§ã€‚
\end{proof}
```

### 3.2 äº‹åŠ¡éš”ç¦»ç†è®º

```latex
\begin{theorem}[éš”ç¦»çº§åˆ«å±‚æ¬¡]
äº‹åŠ¡éš”ç¦»çº§åˆ«æ»¡è¶³ä»¥ä¸‹å±‚æ¬¡ç»“æ„ï¼š
1. READ UNCOMMITTED: æœ€ä½éš”ç¦»çº§åˆ«ï¼Œå…è®¸è„è¯»
2. READ COMMITTED: é˜²æ­¢è„è¯»ï¼Œå…è®¸ä¸å¯é‡å¤è¯»
3. REPEATABLE READ: é˜²æ­¢è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œå…è®¸å¹»è¯»
4. SERIALIZABLE: æœ€é«˜éš”ç¦»çº§åˆ«ï¼Œå®Œå…¨ä¸²è¡ŒåŒ–
\end{theorem}
```

### 3.3 äº‹åŠ¡çŠ¶æ€è½¬æ¢

```latex
\begin{theorem}[äº‹åŠ¡çŠ¶æ€æœº]
äº‹åŠ¡çŠ¶æ€è½¬æ¢æ»¡è¶³ä»¥ä¸‹è§„åˆ™ï¼š
\begin{align}
\text{ACTIVE} & \rightarrow \text{COMMITTED} \text{ (é€šè¿‡COMMIT)} \\
\text{ACTIVE} & \rightarrow \text{ABORTED} \text{ (é€šè¿‡ROLLBACK)} \\
\text{ACTIVE} & \rightarrow \text{PARTIALLY COMMITTED} \text{ (æäº¤å¼€å§‹)} \\
\text{PARTIALLY COMMITTED} & \rightarrow \text{COMMITTED} \text{ (æäº¤å®Œæˆ)} \\
\text{PARTIALLY COMMITTED} & \rightarrow \text{ABORTED} \text{ (æäº¤å¤±è´¥)}
\end{align}
\end{theorem}
```

---

## å››ã€PostgreSQLå®ç°

### 4.1 äº‹åŠ¡æ§åˆ¶è¯­å¥

```sql
-- åŸºæœ¬äº‹åŠ¡æ§åˆ¶
BEGIN;
INSERT INTO accounts (account_id, balance) VALUES (1001, 1000);
UPDATE accounts SET balance = balance - 100 WHERE account_id = 1001;
COMMIT;

-- ä¿å­˜ç‚¹æœºåˆ¶
BEGIN;
INSERT INTO accounts (account_id, balance) VALUES (1002, 2000);
SAVEPOINT sp1;
UPDATE accounts SET balance = balance - 500 WHERE account_id = 1002;
ROLLBACK TO sp1;  -- å›æ»šåˆ°ä¿å­˜ç‚¹
COMMIT;  -- åªæäº¤ç¬¬ä¸€ä¸ªæ’å…¥

-- äº‹åŠ¡éš”ç¦»çº§åˆ«è®¾ç½®
BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;
SELECT * FROM accounts WHERE balance > 1000;
COMMIT;
```

### 4.2 äº‹åŠ¡IDç®¡ç†

```sql
-- æŸ¥çœ‹å½“å‰äº‹åŠ¡ID
SELECT txid_current();

-- æŸ¥çœ‹äº‹åŠ¡çŠ¶æ€
SELECT
    pid,
    usename,
    application_name,
    state,
    query_start,
    query
FROM pg_stat_activity
WHERE state = 'active';

-- æŸ¥çœ‹äº‹åŠ¡é”ä¿¡æ¯
SELECT
    locktype,
    database,
    relation,
    page,
    tuple,
    virtualxid,
    transactionid,
    classid,
    objid,
    objsubid,
    virtualtransaction,
    pid,
    mode,
    granted
FROM pg_locks
WHERE NOT granted;
```

### 4.3 é•¿äº‹åŠ¡ç®¡ç†

```sql
-- æŸ¥çœ‹é•¿äº‹åŠ¡
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    backend_start,
    state,
    query_start,
    state_change,
    query
FROM pg_stat_activity
WHERE state = 'active'
AND query_start < NOW() - INTERVAL '1 hour';

-- ç»ˆæ­¢é•¿äº‹åŠ¡
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE pid = 12345;
```

---

## äº”ã€å¹¶å‘æ§åˆ¶æœºåˆ¶

### 5.1 MVCCå®ç°

```sql
-- æŸ¥çœ‹è¡Œç‰ˆæœ¬ä¿¡æ¯
SELECT
    ctid,
    xmin,
    xmax,
    cmin,
    cmax,
    *
FROM employees
WHERE emp_id = 1001;

-- æŸ¥çœ‹äº‹åŠ¡å¿«ç…§
SELECT txid_snapshot_xmin(txid_current_snapshot()),
       txid_snapshot_xmax(txid_current_snapshot()),
       txid_snapshot_xip(txid_current_snapshot());
```

### 5.2 é”æœºåˆ¶

```sql
-- æ˜¾å¼é”è¡¨
LOCK TABLE employees IN SHARE MODE;
LOCK TABLE departments IN EXCLUSIVE MODE;

-- è¡Œçº§é”
SELECT * FROM employees WHERE emp_id = 1001 FOR UPDATE;
SELECT * FROM employees WHERE dept_id = 1 FOR SHARE;

-- æŸ¥çœ‹é”ç­‰å¾…
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS current_statement_in_blocking_process
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

### 5.3 æ­»é”æ£€æµ‹

```sql
-- æ­»é”æ£€æµ‹é…ç½®
SHOW deadlock_timeout;
SET deadlock_timeout = '1s';

-- æŸ¥çœ‹æ­»é”æ—¥å¿—
SELECT * FROM pg_stat_database_conflicts;

-- æ­»é”é¿å…ç­–ç•¥
BEGIN;
-- æŒ‰å›ºå®šé¡ºåºè®¿é—®èµ„æº
SELECT * FROM accounts WHERE account_id = 1001 FOR UPDATE;
SELECT * FROM accounts WHERE account_id = 1002 FOR UPDATE;
COMMIT;
```

---

## å…­ã€äº‹åŠ¡æ—¥å¿—ä¸æ¢å¤

### 6.1 WALæœºåˆ¶

```sql
-- WALé…ç½®
SHOW wal_level;
SHOW wal_buffers;
SHOW checkpoint_timeout;
SHOW max_wal_size;

-- æŸ¥çœ‹WALç»Ÿè®¡ä¿¡æ¯
SELECT * FROM pg_stat_wal;

-- æ‰‹åŠ¨æ£€æŸ¥ç‚¹
CHECKPOINT;
```

### 6.2 äº‹åŠ¡æ¢å¤

```sql
-- æŸ¥çœ‹æ¢å¤çŠ¶æ€
SELECT pg_is_in_recovery();

-- æŸ¥çœ‹WALä½ç½®
SELECT pg_current_wal_lsn();
SELECT pg_walfile_name(pg_current_wal_lsn());

-- æŸ¥çœ‹æ£€æŸ¥ç‚¹ä¿¡æ¯
SELECT * FROM pg_control_checkpoint();
```

**PostgreSQL 18å¼‚æ­¥I/Oæå‡äº‹åŠ¡æ—¥å¿—å†™å…¥æ€§èƒ½** ğŸ†•

PostgreSQL 18çš„å¼‚æ­¥I/Oå­ç³»ç»Ÿæ˜¾è‘—æå‡äº†WALå†™å…¥æ€§èƒ½ï¼Œå‡å°‘äº‹åŠ¡æäº¤å»¶è¿Ÿï¼Œæå‡ç³»ç»Ÿæ•´ä½“ååé‡ã€‚

**æ€§èƒ½æå‡**:

- WALå†™å…¥æ€§èƒ½æå‡ï¼šå¼‚æ­¥I/Oå‡å°‘I/Oç­‰å¾…æ—¶é—´
- äº‹åŠ¡æäº¤å»¶è¿Ÿé™ä½ï¼šç‰¹åˆ«æ˜¯åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹
- ç³»ç»Ÿååé‡æå‡ï¼šæ”¯æŒæ›´é«˜çš„å¹¶å‘äº‹åŠ¡æ•°

**é…ç½®æ–¹æ³•**:

```sql
-- PostgreSQL 18å¼‚æ­¥I/Oé…ç½®
-- postgresql.conf

-- æœ‰æ•ˆI/Oå¹¶å‘æ•°
effective_io_concurrency = 200   -- æå‡WALå†™å…¥æ€§èƒ½

-- æŸ¥çœ‹WALå†™å…¥ç»Ÿè®¡
SELECT
    wal_records,
    wal_write,
    wal_sync,
    wal_bytes,
    wal_buffers_full,
    wal_write_time,
    wal_sync_time
FROM pg_stat_wal;
```

**ä½¿ç”¨åœºæ™¯**:

1. **é«˜å¹¶å‘äº‹åŠ¡åœºæ™¯**

   ```sql
   -- é«˜å¹¶å‘äº‹åŠ¡æäº¤
   BEGIN;
   INSERT INTO orders (user_id, amount) VALUES (1, 100);
   COMMIT;  -- PostgreSQL 18: å¼‚æ­¥I/Oå‡å°‘æäº¤å»¶è¿Ÿ
   ```

2. **æ‰¹é‡äº‹åŠ¡å¤„ç†**

   ```sql
   -- æ‰¹é‡äº‹åŠ¡å¤„ç†
   BEGIN;
   INSERT INTO large_table SELECT * FROM source_table;
   COMMIT;  -- PostgreSQL 18: å¼‚æ­¥I/Oæå‡æ‰¹é‡å†™å…¥æ€§èƒ½
   ```

**æ€§èƒ½å¯¹æ¯”**:

- PostgreSQL 17: åŒæ­¥WALå†™å…¥ï¼Œé«˜å¹¶å‘æ—¶å»¶è¿Ÿè¾ƒé«˜
- PostgreSQL 18: å¼‚æ­¥I/Oï¼ŒWALå†™å…¥æ€§èƒ½æå‡ï¼Œäº‹åŠ¡å»¶è¿Ÿé™ä½
- é«˜å¹¶å‘åœºæ™¯ï¼šäº‹åŠ¡ååé‡æå‡20-30%

---

## ä¸ƒã€æ€§èƒ½ä¼˜åŒ–

### 7.1 äº‹åŠ¡ä¼˜åŒ–ç­–ç•¥

```sql
-- æ‰¹é‡æ“ä½œä¼˜åŒ–
BEGIN;
INSERT INTO large_table (col1, col2, col3)
SELECT generate_series(1, 1000000),
       'data' || generate_series(1, 1000000),
       random() * 1000;
COMMIT;

-- é¿å…é•¿äº‹åŠ¡
BEGIN;
-- å¿«é€Ÿæ“ä½œ
UPDATE accounts SET balance = balance + 100 WHERE account_id = 1001;
COMMIT;

-- ä½¿ç”¨é€‚å½“çš„éš”ç¦»çº§åˆ«
BEGIN TRANSACTION ISOLATION LEVEL READ COMMITTED;
SELECT * FROM accounts WHERE balance > 1000;
COMMIT;
```

### 7.2 é”ä¼˜åŒ–

```sql
-- å‡å°‘é”ç«äº‰
BEGIN;
-- ä½¿ç”¨ç´¢å¼•å‡å°‘é”èŒƒå›´
UPDATE employees SET salary = salary * 1.1
WHERE dept_id = 1 AND emp_id > 1000;
COMMIT;

-- ä½¿ç”¨ä¹è§‚é”
BEGIN;
SELECT version, salary FROM employees WHERE emp_id = 1001;
-- åº”ç”¨å±‚å¤„ç†
UPDATE employees SET salary = 60000, version = version + 1
WHERE emp_id = 1001 AND version = 1;
COMMIT;
```

### 7.3 PostgreSQL 18é€»è¾‘å¤åˆ¶æ€§èƒ½æå‡ ğŸ†•

PostgreSQL 18å¯¹é€»è¾‘å¤åˆ¶è¿›è¡Œäº†é‡å¤§ä¼˜åŒ–ï¼Œæ€§èƒ½æå‡38%ï¼Œç‰¹åˆ«é€‚ç”¨äºé«˜ååé‡çš„æ•°æ®åŒæ­¥åœºæ™¯ã€‚

**æ€§èƒ½ä¼˜åŒ–**:

1. **å¹¶è¡Œåº”ç”¨**: æ”¯æŒå¤šä¸ªäº‹åŠ¡å¹¶è¡Œåº”ç”¨ï¼Œæå‡å¤åˆ¶ååé‡
2. **æ‰¹é‡å¤„ç†**: ä¼˜åŒ–æ‰¹é‡äº‹åŠ¡çš„å¤„ç†æ•ˆç‡
3. **å†…å­˜ä¼˜åŒ–**: æ”¹è¿›å†…å­˜ä½¿ç”¨ï¼Œå‡å°‘å¤åˆ¶å»¶è¿Ÿ

**é…ç½®æ–¹æ³•**:

```sql
-- PostgreSQL 18é€»è¾‘å¤åˆ¶é…ç½®
-- postgresql.conf

-- é€»è¾‘å¤åˆ¶å·¥ä½œè¿›ç¨‹æ•°ï¼ˆPostgreSQL 18ä¼˜åŒ–ï¼‰
max_logical_replication_workers = 4
max_sync_workers_per_subscription = 2

-- æŸ¥çœ‹é€»è¾‘å¤åˆ¶çŠ¶æ€
SELECT * FROM pg_stat_replication;
SELECT * FROM pg_replication_slots;

-- æŸ¥çœ‹è®¢é˜…çŠ¶æ€
SELECT * FROM pg_subscription;
SELECT * FROM pg_subscription_rel;
```

**ä½¿ç”¨åœºæ™¯**:

1. **è·¨æ•°æ®åº“åŒæ­¥**

   ```sql
   -- åˆ›å»ºå‘å¸ƒ
   CREATE PUBLICATION mypub FOR TABLE users, orders;

   -- åˆ›å»ºè®¢é˜…ï¼ˆPostgreSQL 18æ€§èƒ½æå‡38%ï¼‰
   CREATE SUBSCRIPTION mysub
   CONNECTION 'host=target_host dbname=target_db'
   PUBLICATION mypub;
   ```

2. **é«˜ååé‡æ•°æ®åŒæ­¥**

   ```sql
   -- é«˜å¹¶å‘å†™å…¥åœºæ™¯
   -- PostgreSQL 18: é€»è¾‘å¤åˆ¶æ€§èƒ½æå‡38%
   INSERT INTO large_table SELECT * FROM source_table;
   ```

**æ€§èƒ½å¯¹æ¯”**:

- PostgreSQL 17: é€»è¾‘å¤åˆ¶åŸºå‡†æ€§èƒ½
- PostgreSQL 18: é€»è¾‘å¤åˆ¶æ€§èƒ½æå‡38%
- é«˜ååé‡åœºæ™¯ï¼šæ€§èƒ½æå‡æ›´æ˜æ˜¾ï¼Œå¯è¾¾50%

**æœ€ä½³å®è·µ**:

- æ ¹æ®æ•°æ®é‡è°ƒæ•´`max_logical_replication_workers`
- ç›‘æ§å¤åˆ¶å»¶è¿Ÿå’Œååé‡
- PostgreSQL 18çš„é€»è¾‘å¤åˆ¶ä¼˜åŒ–ç‰¹åˆ«é€‚ç”¨äºå¤§å‹æ•°æ®åº“åŒæ­¥

---

## å…«ã€å®é™…åº”ç”¨æ¡ˆä¾‹

### 8.1 é“¶è¡Œè½¬è´¦ç³»ç»Ÿ

```sql
-- åŸå­æ€§è½¬è´¦
BEGIN;
-- æ£€æŸ¥è´¦æˆ·ä½™é¢
SELECT balance FROM accounts WHERE account_id = 1001 FOR UPDATE;
-- æ‰£é™¤è½¬å‡ºè´¦æˆ·
UPDATE accounts SET balance = balance - 1000 WHERE account_id = 1001;
-- å¢åŠ è½¬å…¥è´¦æˆ·
UPDATE accounts SET balance = balance + 1000 WHERE account_id = 1002;
-- è®°å½•äº¤æ˜“
INSERT INTO transactions (from_account, to_account, amount, transaction_date)
VALUES (1001, 1002, 1000, NOW());
COMMIT;
```

### 8.2 åº“å­˜ç®¡ç†ç³»ç»Ÿ

```sql
-- åº“å­˜æ‰£å‡
BEGIN;
-- æ£€æŸ¥åº“å­˜
SELECT stock_quantity FROM products WHERE product_id = 1001 FOR UPDATE;
-- æ‰£å‡åº“å­˜
UPDATE products SET stock_quantity = stock_quantity - 5
WHERE product_id = 1001 AND stock_quantity >= 5;
-- å¦‚æœåº“å­˜ä¸è¶³ï¼Œå›æ»š
IF NOT FOUND THEN
    ROLLBACK;
    RAISE EXCEPTION 'åº“å­˜ä¸è¶³';
END IF;
-- è®°å½•å‡ºåº“
INSERT INTO stock_movements (product_id, movement_type, quantity, movement_date)
VALUES (1001, 'OUT', 5, NOW());
COMMIT;
```

---

## ä¹ã€ç›¸å…³æ¦‚å¿µ

### 9.1 ä¸Šä½æ¦‚å¿µ

- **æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ**: æ›´å¹¿æ³›çš„ç³»ç»Ÿç±»åˆ«
- **å¹¶å‘æ§åˆ¶**: å¹¶å‘è®¿é—®ç®¡ç†æœºåˆ¶
- **æ•°æ®ä¸€è‡´æ€§**: æ•°æ®å®Œæ•´æ€§ä¿è¯

### 9.2 ä¸‹ä½æ¦‚å¿µ

- **äº‹åŠ¡æ—¥å¿—**: äº‹åŠ¡è®°å½•æœºåˆ¶
- **é”æœºåˆ¶**: å¹¶å‘æ§åˆ¶å®ç°
- **MVCC**: å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶
- **WAL**: é¢„å†™æ—¥å¿—

### 9.3 å¹³è¡Œæ¦‚å¿µ

- **åˆ†å¸ƒå¼äº‹åŠ¡**: è·¨èŠ‚ç‚¹äº‹åŠ¡ç®¡ç†
- **ä¸¤é˜¶æ®µæäº¤**: åˆ†å¸ƒå¼äº‹åŠ¡åè®®
- **SAGAæ¨¡å¼**: é•¿äº‹åŠ¡ç®¡ç†æ¨¡å¼

---

## åã€å‚è€ƒèµ„æº

### 10.1 ç›¸å…³æ–‡æ¡£

- [å¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶](./01.05-å¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶.md) - å¹¶å‘æ§åˆ¶å®ç°
- [åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†](../04-é«˜çº§ç‰¹æ€§/03.07-åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†.md) - åˆ†å¸ƒå¼äº‹åŠ¡
- [å½¢å¼åŒ–éªŒè¯æ–¹æ³•](../10-ç†è®ºåŸºç¡€/10.01-å½¢å¼åŒ–éªŒè¯æ–¹æ³•.md) - ACIDç‰¹æ€§å½¢å¼åŒ–éªŒè¯
- [å­¦æœ¯ç ”ç©¶å‰æ²¿](../10-ç†è®ºåŸºç¡€/10.02-å­¦æœ¯ç ”ç©¶å‰æ²¿.md) - äº‹åŠ¡ç†è®ºç ”ç©¶

### 10.2 å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹

- [å¯è¿è¡Œç¤ºä¾‹é¡¹ç›®](../examples/README.md) â­ - 8ä¸ªå®Œæ•´çš„Docker Composeç¤ºä¾‹
- [åˆ†å¸ƒå¼æ•°æ®åº“å®æˆ˜](../08-å®æˆ˜æ¡ˆä¾‹/06.04-åˆ†å¸ƒå¼æ•°æ®åº“å®æˆ˜.md) - åˆ†å¸ƒå¼äº‹åŠ¡å®è·µ
- [é‡‘èè´¦åŠ¡ä¸€è‡´æ€§](../09-åº”ç”¨è®¾è®¡/è¡Œä¸šæ¡ˆä¾‹/é‡‘èè´¦åŠ¡ä¸€è‡´æ€§.md) - ACIDç‰¹æ€§åº”ç”¨æ¡ˆä¾‹

### 10.3 å‚è€ƒæ–‡çŒ®

1. Berenson, H., et al. (1995). A critique of ANSI SQL isolation levels. ACM SIGMOD Record, 24(2), 1-10.
2. Mohan, C., et al. (1992). ARIES: A transaction recovery method supporting fine-granularity locking and partial rollbacks using write-ahead logging. ACM TODS, 17(1), 94-162.
3. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Documentation. <https://www.postgresql.org/docs/18/>
4. Gray, J., & Reuter, A. (1993). Transaction Processing: Concepts and Techniques. Morgan Kaufmann.
5. PostgreSQL Global Development Group. (2024). PostgreSQL 17 Documentation. <https://www.postgresql.org/docs/17/>

### 10.4 Wikidataå¯¹é½

- **Wikidata ID**: Q192490
- **ç›¸å…³å±æ€§**:
  - P31: Q176165 (instance of: database management system)
  - P178: Q9366 (developer: PostgreSQL Global Development Group)
  - P277: Q193321 (programmed in: C)
  - P348: 18.0 (software version)
- **å¤–éƒ¨é“¾æ¥**:
  - <https://www.postgresql.org/docs/current/transaction-iso.html>
  - <https://www.postgresql.org/docs/current/mvcc.html>
