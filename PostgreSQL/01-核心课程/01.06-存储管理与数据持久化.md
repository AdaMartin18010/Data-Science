# PostgreSQLå­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–å®Œæ•´æŒ‡å—

> **ç‰ˆæœ¬**: v3.1
> **æœ€åæ›´æ–°**: 2025-11-22
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **éš¾åº¦**: â­â­â­â­
> **åº”ç”¨åœºæ™¯**: å­˜å‚¨ç®¡ç†ã€æ•°æ®æŒä¹…åŒ–ã€I/Oä¼˜åŒ–ã€æ€§èƒ½è°ƒä¼˜ã€é«˜å¯ç”¨è®¾è®¡
> ğŸ†• **PostgreSQL 18å­˜å‚¨æ”¹è¿›**: å¼‚æ­¥I/Oå­ç³»ç»Ÿï¼ˆI/Oæ€§èƒ½æå‡2-3å€ï¼Œå·²è¯¦ç»†å±•å¼€ï¼‰ã€å¢é‡å¤‡ä»½ï¼ˆèŠ‚çœ94%æ—¶é—´ï¼Œå·²è¯¦ç»†å±•å¼€ï¼‰ã€WALæ±‡æ€»æœºåˆ¶ã€åŠ¨æ€å…±äº«å†…å­˜ï¼ˆæå‡20%æ•ˆç‡ï¼‰

---

## ğŸ“‘ ç›®å½•

- [PostgreSQLå­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–å®Œæ•´æŒ‡å—](#postgresqlå­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–å®Œæ•´æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“Š æ€ç»´å¯¼å›¾](#-æ€ç»´å¯¼å›¾)
  - [ä¸€ã€å®šä¹‰ä¸å½¢å¼åŒ–](#ä¸€å®šä¹‰ä¸å½¢å¼åŒ–)
    - [1.1 æ¦‚å¿µå®šä¹‰](#11-æ¦‚å¿µå®šä¹‰)
    - [1.2 å½¢å¼åŒ–å®šä¹‰](#12-å½¢å¼åŒ–å®šä¹‰)
    - [1.3 æ ¸å¿ƒå±æ€§](#13-æ ¸å¿ƒå±æ€§)
  - [äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#äºŒçŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [2.1 å­˜å‚¨ç®¡ç†æœºåˆ¶å¯¹æ¯”](#21-å­˜å‚¨ç®¡ç†æœºåˆ¶å¯¹æ¯”)
    - [2.2 ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥å¯¹æ¯”](#22-ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥å¯¹æ¯”)
  - [ä¸‰ã€ç†è®ºåŸºç¡€](#ä¸‰ç†è®ºåŸºç¡€)
    - [3.1 ç¼“å†²åŒºç®¡ç†ç†è®º](#31-ç¼“å†²åŒºç®¡ç†ç†è®º)
    - [3.2 WALç†è®º](#32-walç†è®º)
    - [3.3 æ£€æŸ¥ç‚¹ç†è®º](#33-æ£€æŸ¥ç‚¹ç†è®º)
  - [å››ã€PostgreSQLå­˜å‚¨æ¶æ„](#å››postgresqlå­˜å‚¨æ¶æ„)
    - [4.1 å­˜å‚¨ç»“æ„](#41-å­˜å‚¨ç»“æ„)
    - [4.2 é¡µé¢ç»“æ„](#42-é¡µé¢ç»“æ„)
    - [4.3 æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€](#43-æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€)
  - [äº”ã€ç¼“å†²åŒºç®¡ç†](#äº”ç¼“å†²åŒºç®¡ç†)
    - [5.1 ç¼“å†²åŒºé…ç½®](#51-ç¼“å†²åŒºé…ç½®)
    - [5.2 ç¼“å†²åŒºä¼˜åŒ–](#52-ç¼“å†²åŒºä¼˜åŒ–)
  - [å…­ã€WALæœºåˆ¶](#å…­walæœºåˆ¶)
    - [6.1 WALé…ç½®](#61-walé…ç½®)
    - [6.2 WALå½’æ¡£](#62-walå½’æ¡£)
    - [6.3 æµå¤åˆ¶](#63-æµå¤åˆ¶)
  - [ä¸ƒã€æ£€æŸ¥ç‚¹æœºåˆ¶](#ä¸ƒæ£€æŸ¥ç‚¹æœºåˆ¶)
    - [7.1 æ£€æŸ¥ç‚¹é…ç½®](#71-æ£€æŸ¥ç‚¹é…ç½®)
    - [7.2 æ£€æŸ¥ç‚¹ä¼˜åŒ–](#72-æ£€æŸ¥ç‚¹ä¼˜åŒ–)
  - [å…«ã€å­˜å‚¨ä¼˜åŒ–](#å…«å­˜å‚¨ä¼˜åŒ–)
    - [8.1 è¡¨ç©ºé—´ç®¡ç†](#81-è¡¨ç©ºé—´ç®¡ç†)
    - [8.2 åˆ†åŒºè¡¨ä¼˜åŒ–](#82-åˆ†åŒºè¡¨ä¼˜åŒ–)
    - [8.3 å‹ç¼©å’ŒTOAST](#83-å‹ç¼©å’Œtoast)
  - [ä¹ã€æ€§èƒ½ç›‘æ§](#ä¹æ€§èƒ½ç›‘æ§)
    - [9.1 I/Oæ€§èƒ½ç›‘æ§](#91-ioæ€§èƒ½ç›‘æ§)
    - [9.2 å­˜å‚¨æ€§èƒ½åˆ†æ](#92-å­˜å‚¨æ€§èƒ½åˆ†æ)
  - [åã€å®é™…åº”ç”¨æ¡ˆä¾‹](#åå®é™…åº”ç”¨æ¡ˆä¾‹)
    - [10.1 å¤§æ•°æ®è¡¨ä¼˜åŒ–](#101-å¤§æ•°æ®è¡¨ä¼˜åŒ–)
    - [10.2 é«˜å¹¶å‘å†™å…¥ä¼˜åŒ–](#102-é«˜å¹¶å‘å†™å…¥ä¼˜åŒ–)
  - [åä¸€ã€ç›¸å…³æ¦‚å¿µ](#åä¸€ç›¸å…³æ¦‚å¿µ)
    - [11.1 ä¸Šä½æ¦‚å¿µ](#111-ä¸Šä½æ¦‚å¿µ)
    - [11.2 ä¸‹ä½æ¦‚å¿µ](#112-ä¸‹ä½æ¦‚å¿µ)
    - [11.3 å¹³è¡Œæ¦‚å¿µ](#113-å¹³è¡Œæ¦‚å¿µ)
  - [åäºŒã€å‚è€ƒèµ„æº](#åäºŒå‚è€ƒèµ„æº)
    - [12.1 ç›¸å…³æ–‡æ¡£](#121-ç›¸å…³æ–‡æ¡£)
    - [12.2 å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹](#122-å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹)
    - [12.3 å‚è€ƒæ–‡çŒ®](#123-å‚è€ƒæ–‡çŒ®)
    - [12.4 Wikidataå¯¹é½](#124-wikidataå¯¹é½)

---

## ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((å­˜å‚¨ç®¡ç†))
    ç†è®ºåŸºç¡€
      ç¼“å†²åŒºç®¡ç†
      WALç†è®º
      æ£€æŸ¥ç‚¹ç†è®º
    å­˜å‚¨æ¶æ„
      å­˜å‚¨ç»“æ„
      é¡µé¢ç»“æ„
      æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€
    ç¼“å†²åŒºç®¡ç†
      é…ç½®
      ä¼˜åŒ–
    WALæœºåˆ¶
      é…ç½®
      å½’æ¡£
      æµå¤åˆ¶
    æ£€æŸ¥ç‚¹
      é…ç½®
      ä¼˜åŒ–
    å­˜å‚¨ä¼˜åŒ–
      è¡¨ç©ºé—´
      åˆ†åŒºè¡¨
      å‹ç¼©TOAST
    æ€§èƒ½ç›‘æ§
      I/Oç›‘æ§
      æ€§èƒ½åˆ†æ
    å®é™…åº”ç”¨
      å¤§æ•°æ®è¡¨
      é«˜å¹¶å‘å†™å…¥
```

---

## ä¸€ã€å®šä¹‰ä¸å½¢å¼åŒ–

### 1.1 æ¦‚å¿µå®šä¹‰

**ä¸­æ–‡å®šä¹‰**: å­˜å‚¨ç®¡ç†æ˜¯æ•°æ®åº“ç³»ç»Ÿä¸­ç®¡ç†æ•°æ®æŒä¹…åŒ–å­˜å‚¨çš„æœºåˆ¶ï¼ŒåŒ…æ‹¬ç¼“å†²åŒºç®¡ç†ã€WALæ—¥å¿—ã€æ£€æŸ¥ç‚¹ç­‰æ ¸å¿ƒç»„ä»¶ã€‚PostgreSQLé€šè¿‡é«˜æ•ˆçš„å­˜å‚¨ç®¡ç†ç¡®ä¿æ•°æ®çš„æŒä¹…æ€§å’Œç³»ç»Ÿçš„é«˜æ€§èƒ½ã€‚

**English Definition**: Storage management is a mechanism in database systems that manages persistent data storage, including buffer management, WAL logging, checkpoints, and other core components. PostgreSQL ensures data durability and high system performance through efficient storage management.

### 1.2 å½¢å¼åŒ–å®šä¹‰

```latex
% æ•°å­¦ç¬¦å·å®šä¹‰
\newcommand{\storage}{\mathcal{S}}
\newcommand{\buffer}{\mathcal{B}}
\newcommand{\wal}{\mathcal{W}}
\newcommand{\page}{\mathcal{P}}
\newcommand{\disk}{\mathcal{D}}

% å­˜å‚¨ç³»ç»Ÿçš„å½¢å¼åŒ–å®šä¹‰
\storage = (\buffer, \wal, \page, \disk)

å…¶ä¸­ï¼š
\buffer = \{b_1, b_2, \ldots, b_n\}: ç¼“å†²åŒºé¡µé¢é›†åˆ
\wal = \{w_1, w_2, \ldots, w_m\}: WALæ—¥å¿—è®°å½•é›†åˆ
\page = \{p_1, p_2, \ldots, p_k\}: ç£ç›˜é¡µé¢é›†åˆ
\disk = \{d_1, d_2, \ldots, d_l\}: ç£ç›˜å­˜å‚¨é›†åˆ
```

### 1.3 æ ¸å¿ƒå±æ€§

- **æŒä¹…æ€§**: ç¡®ä¿æ•°æ®æ°¸ä¹…ä¿å­˜
- **ä¸€è‡´æ€§**: ä¿è¯æ•°æ®å®Œæ•´æ€§
- **æ€§èƒ½**: ä¼˜åŒ–I/Oæ“ä½œæ•ˆç‡
- **å¯æ¢å¤æ€§**: æ”¯æŒæ•…éšœæ¢å¤

---

## äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 2.1 å­˜å‚¨ç®¡ç†æœºåˆ¶å¯¹æ¯”

| å­˜å‚¨ç®¡ç†æœºåˆ¶ | å®ç°æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------------|---------|------|------|---------|
| ç›´æ¥I/O | ç»•è¿‡OSç¼“å­˜ | æ§åˆ¶ç²¾ç¡® | æ€§èƒ½è¾ƒä½ | ç‰¹æ®Šéœ€æ±‚ |
| ç¼“å†²I/O | OSç¼“å­˜ | æ€§èƒ½é«˜ | æ§åˆ¶æœ‰é™ | é€šç”¨åœºæ™¯ |
| å¼‚æ­¥I/O | å¼‚æ­¥æ“ä½œ | é«˜å¹¶å‘ | å®ç°å¤æ‚ | PostgreSQL 18+ |
| åŒæ­¥I/O | åŒæ­¥æ“ä½œ | å¯é æ€§é«˜ | æ€§èƒ½è¾ƒä½ | å…³é”®æ•°æ® |

### 2.2 ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥å¯¹æ¯”

| æ›¿æ¢ç­–ç•¥ | ç®—æ³•å¤æ‚åº¦ | å‘½ä¸­ç‡ | å®ç°éš¾åº¦ | é€‚ç”¨åœºæ™¯ |
|---------|-----------|--------|---------|---------|
| LRU | O(1) | é«˜ | ä¸­ | é€šç”¨åœºæ™¯ |
| LFU | O(log n) | ä¸­ | é«˜ | è®¿é—®æ¨¡å¼ç¨³å®š |
| FIFO | O(1) | ä½ | ä½ | ç®€å•åœºæ™¯ |
| Clock | O(1) | ä¸­ | ä¸­ | å†…å­˜å—é™ |

---

## ä¸‰ã€ç†è®ºåŸºç¡€

### 3.1 ç¼“å†²åŒºç®¡ç†ç†è®º

```latex
\begin{theorem}[ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥]
LRU (Least Recently Used) ç­–ç•¥ï¼š
1. æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„é¡µé¢ä¼˜å…ˆè¢«æ›¿æ¢
2. æ—¶é—´å¤æ‚åº¦ï¼šO(1) æŸ¥æ‰¾å’Œæ›´æ–°
3. ç©ºé—´å¤æ‚åº¦ï¼šO(n) å­˜å‚¨å¼€é”€
\end{theorem}

\begin{proof}
åŸºäºè®¿é—®æ—¶é—´æˆ³å’ŒåŒå‘é“¾è¡¨ç»“æ„ï¼Œå¯ä»¥è¯æ˜LRUç­–ç•¥çš„æ­£ç¡®æ€§ã€‚
\end{proof}
```

### 3.2 WALç†è®º

```latex
\begin{theorem}[WALåè®®]
Write-Ahead Loggingåè®®è¦æ±‚ï¼š
1. åœ¨ä¿®æ”¹æ•°æ®é¡µé¢å‰ï¼Œå¿…é¡»å…ˆå†™WALæ—¥å¿—
2. æ—¥å¿—è®°å½•å¿…é¡»æŒä¹…åŒ–åˆ°ç£ç›˜
3. æ£€æŸ¥ç‚¹æœºåˆ¶ç¡®ä¿æ•°æ®é¡µé¢çš„æŒä¹…åŒ–
\end{theorem}

\begin{proof}
åŸºäºæ•…éšœæ¢å¤çš„éœ€æ±‚å’Œæ—¥å¿—çš„å®Œæ•´æ€§ï¼Œå¯ä»¥è¯æ˜WALåè®®çš„æ­£ç¡®æ€§ã€‚
\end{proof}
```

### 3.3 æ£€æŸ¥ç‚¹ç†è®º

```latex
\begin{theorem}[æ£€æŸ¥ç‚¹ä¸€è‡´æ€§]
æ£€æŸ¥ç‚¹ç¡®ä¿ï¼š
1. æ‰€æœ‰è„é¡µè¢«å†™å…¥ç£ç›˜
2. WALæ—¥å¿—è¢«æˆªæ–­
3. ç³»ç»ŸçŠ¶æ€ä¸€è‡´
\end{theorem}
```

---

## å››ã€PostgreSQLå­˜å‚¨æ¶æ„

### 4.1 å­˜å‚¨ç»“æ„

```sql
-- æŸ¥çœ‹æ•°æ®åº“å¤§å°
SELECT
    datname,
    pg_size_pretty(pg_database_size(datname)) as size
FROM pg_database
ORDER BY pg_database_size(datname) DESC;

-- æŸ¥çœ‹è¡¨å¤§å°
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) as table_size,
    pg_size_pretty(pg_indexes_size(schemaname||'.'||tablename)) as indexes_size
FROM pg_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- æŸ¥çœ‹è¡¨ç©ºé—´
SELECT
    spcname,
    pg_size_pretty(pg_tablespace_size(spcname)) as size
FROM pg_tablespace;
```

### 4.2 é¡µé¢ç»“æ„

```sql
-- æŸ¥çœ‹é¡µé¢ä¿¡æ¯
SELECT
    relname,
    relpages,
    reltuples,
    relallvisible,
    relfrozenxid
FROM pg_class
WHERE relkind = 'r'
ORDER BY relpages DESC;

-- æŸ¥çœ‹é¡µé¢ç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    n_tup_ins,
    n_tup_upd,
    n_tup_del,
    n_live_tup,
    n_dead_tup,
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables;
```

### 4.3 æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€

```sql
-- æŸ¥çœ‹æ•°æ®ç›®å½•
SHOW data_directory;

-- æŸ¥çœ‹WALç›®å½•
SHOW log_directory;

-- æŸ¥çœ‹é…ç½®æ–‡ä»¶ä½ç½®
SHOW config_file;
SHOW hba_file;
SHOW ident_file;
```

---

## äº”ã€ç¼“å†²åŒºç®¡ç†

### 5.1 ç¼“å†²åŒºé…ç½®

```sql
-- æŸ¥çœ‹ç¼“å†²åŒºé…ç½®
SHOW shared_buffers;
SHOW effective_cache_size;
SHOW work_mem;
SHOW maintenance_work_mem;

-- æŸ¥çœ‹ç¼“å†²åŒºç»Ÿè®¡
SELECT * FROM pg_stat_bgwriter;

-- æŸ¥çœ‹ç¼“å†²åŒºä½¿ç”¨æƒ…å†µ
SELECT
    c.relname,
    c.relkind,
    pg_size_pretty(pg_relation_size(c.oid)) as size,
    pg_stat_get_tuples_returned(c.oid) as tuples_returned,
    pg_stat_get_tuples_fetched(c.oid) as tuples_fetched,
    pg_stat_get_tuples_inserted(c.oid) as tuples_inserted,
    pg_stat_get_tuples_updated(c.oid) as tuples_updated,
    pg_stat_get_tuples_deleted(c.oid) as tuples_deleted
FROM pg_class c
WHERE c.relkind IN ('r', 'i')
ORDER BY pg_relation_size(c.oid) DESC;
```

### 5.2 ç¼“å†²åŒºä¼˜åŒ–

```sql
-- ç¼“å†²åŒºå‘½ä¸­ç‡
SELECT
    round(100.0 * sum(blks_hit) / (sum(blks_hit) + sum(blks_read)), 2) as hit_ratio
FROM pg_stat_database;

-- è¡¨çº§ç¼“å†²åŒºç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    heap_blks_read,
    heap_blks_hit,
    round(100.0 * heap_blks_hit / (heap_blks_hit + heap_blks_read), 2) as hit_ratio
FROM pg_statio_user_tables
WHERE heap_blks_hit + heap_blks_read > 0
ORDER BY hit_ratio ASC;
```

---

## å…­ã€WALæœºåˆ¶

### 6.1 WALé…ç½®

```sql
-- WALé…ç½®å‚æ•°
SHOW wal_level;
SHOW wal_buffers;
SHOW checkpoint_timeout;
SHOW max_wal_size;
SHOW min_wal_size;
SHOW wal_compression;
SHOW wal_log_hints;

-- WALç»Ÿè®¡ä¿¡æ¯
SELECT * FROM pg_stat_wal;

-- WALä½ç½®ä¿¡æ¯
SELECT pg_current_wal_lsn();
SELECT pg_walfile_name(pg_current_wal_lsn());
SELECT pg_walfile_name_offset(pg_current_wal_lsn());
```

### 6.2 WALå½’æ¡£

```sql
-- WALå½’æ¡£é…ç½®
SHOW archive_mode;
SHOW archive_command;
SHOW archive_timeout;

-- æŸ¥çœ‹å½’æ¡£çŠ¶æ€
SELECT * FROM pg_stat_archiver;

-- æ‰‹åŠ¨å½’æ¡£
SELECT pg_switch_wal();

-- æŸ¥çœ‹WALæ–‡ä»¶
SELECT
    name,
    size,
    modification
FROM pg_ls_waldir()
ORDER BY modification DESC;
```

### 6.3 æµå¤åˆ¶

```sql
-- æµå¤åˆ¶é…ç½®
SHOW wal_sender_timeout;
SHOW wal_receiver_timeout;
SHOW max_wal_senders;
SHOW max_replication_slots;

-- æŸ¥çœ‹å¤åˆ¶çŠ¶æ€
SELECT * FROM pg_stat_replication;

-- æŸ¥çœ‹å¤åˆ¶æ§½
SELECT * FROM pg_replication_slots;
```

### 6.4 PostgreSQL 18å¼‚æ­¥I/Oå­ç³»ç»Ÿ ğŸ†•

PostgreSQL 18å¼•å…¥äº†å…¨æ–°çš„å¼‚æ­¥I/Oå­ç³»ç»Ÿï¼Œæ˜¾è‘—æå‡äº†I/Oå¯†é›†å‹æ“ä½œçš„æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨å‘é‡æ£€ç´¢ã€å¤§è¡¨æ‰«æå’Œç´¢å¼•æ„å»ºåœºæ™¯ä¸­ï¼Œæ€§èƒ½æå‡2-3å€ã€‚

**æŠ€æœ¯åŸç†**:

PostgreSQL 18çš„å¼‚æ­¥I/Oå­ç³»ç»Ÿé€šè¿‡ä»¥ä¸‹æ–¹å¼æå‡æ€§èƒ½ï¼š

1. **å¼‚æ­¥é¢„è¯»**: åœ¨é¡ºåºæ‰«ææ—¶å¼‚æ­¥é¢„è¯»åç»­é¡µé¢ï¼Œå‡å°‘I/Oç­‰å¾…æ—¶é—´
2. **å¹¶å‘I/O**: æ”¯æŒå¤šä¸ªI/Oæ“ä½œå¹¶å‘æ‰§è¡Œï¼Œå……åˆ†åˆ©ç”¨å­˜å‚¨è®¾å¤‡æ€§èƒ½
3. **æ™ºèƒ½è°ƒåº¦**: æ ¹æ®I/Oè´Ÿè½½åŠ¨æ€è°ƒæ•´I/Oç­–ç•¥

**é…ç½®æ–¹æ³•**:

```sql
-- PostgreSQL 18å¼‚æ­¥I/Oé…ç½®
-- postgresql.conf

-- æœ‰æ•ˆI/Oå¹¶å‘æ•°ï¼ˆPostgreSQL 18æ–°å¢ï¼‰
effective_io_concurrency = 200   -- SSDæ¨èå€¼ï¼š200-300
                                  -- NVMeæ¨èå€¼ï¼š300-500
                                  -- HDDæ¨èå€¼ï¼š50-100

-- ç»´æŠ¤æ“ä½œI/Oå¹¶å‘æ•°ï¼ˆPostgreSQL 18æ–°å¢ï¼‰
maintenance_io_concurrency = 200  -- VACUUMã€CREATE INDEXç­‰æ“ä½œ

-- æŸ¥çœ‹I/Oç»Ÿè®¡ä¿¡æ¯ï¼ˆPostgreSQL 18æ–°å¢ï¼‰
SELECT
    object,
    context,
    reads,
    writes,
    extends,
    fsyncs,
    read_time,
    write_time,
    sync_time
FROM pg_stat_io
ORDER BY reads DESC;
```

**ä½¿ç”¨åœºæ™¯**:

1. **å‘é‡æ£€ç´¢**

   ```sql
   -- pgvectorå‘é‡æ£€ç´¢å—ç›Šäºå¼‚æ­¥I/O
   SELECT id, content,
          1 - (embedding <=> query_vector) as similarity
   FROM documents
   ORDER BY embedding <=> query_vector
   LIMIT 100;
   -- PostgreSQL 18: å¼‚æ­¥I/Oæå‡æ€§èƒ½2-3å€
   ```

2. **å¤§è¡¨æ‰«æ**

   ```sql
   -- å¤§è¡¨å…¨è¡¨æ‰«æ
   SELECT COUNT(*) FROM large_table;
   -- PostgreSQL 18: å¼‚æ­¥é¢„è¯»æå‡æ‰«æé€Ÿåº¦
   ```

3. **ç´¢å¼•æ„å»º**

   ```sql
   -- åˆ›å»ºç´¢å¼•
   CREATE INDEX CONCURRENTLY idx_large ON large_table(column1);
   -- PostgreSQL 18: å¼‚æ­¥I/OåŠ é€Ÿç´¢å¼•æ„å»º
   ```

**æ€§èƒ½å¯¹æ¯”**:

- PostgreSQL 17: åŒæ­¥I/Oï¼Œé¡ºåºæ‰§è¡Œ
- PostgreSQL 18: å¼‚æ­¥I/Oï¼Œå¹¶å‘æ‰§è¡Œï¼Œæ€§èƒ½æå‡2-3å€
- å‘é‡æ£€ç´¢åœºæ™¯ï¼šæ€§èƒ½æå‡2-3å€
- å¤§è¡¨æ‰«æåœºæ™¯ï¼šæ€§èƒ½æå‡1.5-2å€
- ç´¢å¼•æ„å»ºåœºæ™¯ï¼šæ€§èƒ½æå‡2-3å€

**æœ€ä½³å®è·µ**:

- æ ¹æ®å­˜å‚¨ç±»å‹è°ƒæ•´`effective_io_concurrency`
  - SSD: 200-300
  - NVMe: 300-500
  - HDD: 50-100
- ç›‘æ§`pg_stat_io`è§†å›¾äº†è§£I/Oæ¨¡å¼
- ç»“åˆ`shared_buffers`è°ƒä¼˜æ•´ä½“æ€§èƒ½
- PostgreSQL 18çš„å¼‚æ­¥I/Oåœ¨å‘é‡æ£€ç´¢å’Œå¤§è¡¨æ‰«æåœºæ™¯ä¸­æ•ˆæœæœ€æ˜æ˜¾

---

## ä¸ƒã€æ£€æŸ¥ç‚¹æœºåˆ¶

### 7.1 æ£€æŸ¥ç‚¹é…ç½®

```sql
-- æ£€æŸ¥ç‚¹é…ç½®
SHOW checkpoint_timeout;
SHOW checkpoint_completion_target;
SHOW max_wal_size;
SHOW min_wal_size;

-- æŸ¥çœ‹æ£€æŸ¥ç‚¹ç»Ÿè®¡
SELECT * FROM pg_stat_bgwriter;

-- æ‰‹åŠ¨æ£€æŸ¥ç‚¹
CHECKPOINT;
```

### 7.2 æ£€æŸ¥ç‚¹ä¼˜åŒ–

```sql
-- æ£€æŸ¥ç‚¹æ€§èƒ½åˆ†æ
SELECT
    checkpoints_timed,
    checkpoints_req,
    checkpoint_write_time,
    checkpoint_sync_time,
    buffers_checkpoint,
    buffers_clean,
    buffers_backend,
    buffers_backend_fsync,
    buffers_alloc
FROM pg_stat_bgwriter;

-- æ£€æŸ¥ç‚¹é¢‘ç‡åˆ†æ
SELECT
    checkpoints_timed + checkpoints_req as total_checkpoints,
    round(extract(epoch from now() - pg_postmaster_start_time()) / (checkpoints_timed + checkpoints_req), 2) as avg_interval_seconds
FROM pg_stat_bgwriter;
```

---

## å…«ã€å­˜å‚¨ä¼˜åŒ–

### 8.0 PostgreSQL 18å¢é‡å¤‡ä»½å¢å¼º ğŸ†•

PostgreSQL 18å¯¹å¢é‡å¤‡ä»½è¿›è¡Œäº†é‡å¤§å¢å¼ºï¼Œé€šè¿‡WAL Summarizerè¿›ç¨‹æ˜¾è‘—æå‡å¤‡ä»½æ€§èƒ½ï¼ŒèŠ‚çœ94%çš„å¤‡ä»½æ—¶é—´ã€‚

**WAL Summarizerè¿›ç¨‹**:

PostgreSQL 18å¼•å…¥äº†WAL Summarizeråå°è¿›ç¨‹ï¼ŒæŒç»­æ±‡æ€»WALä¿¡æ¯ï¼Œä¸ºå¢é‡å¤‡ä»½æä¾›é«˜æ•ˆçš„æ•°æ®å˜æ›´æ‘˜è¦ã€‚

**å·¥ä½œåŸç†**:

1. **WALæ±‡æ€»**: WAL Summarizerè¿›ç¨‹æŒç»­æ‰«æWALæ–‡ä»¶ï¼Œç”Ÿæˆæ•°æ®å˜æ›´æ‘˜è¦
2. **å¢é‡è¯†åˆ«**: åŸºäºæ‘˜è¦ä¿¡æ¯å¿«é€Ÿè¯†åˆ«éœ€è¦å¤‡ä»½çš„æ•°æ®é¡µ
3. **é«˜æ•ˆå¤‡ä»½**: åªå¤‡ä»½å˜æ›´çš„æ•°æ®é¡µï¼Œå¤§å¹…å‡å°‘å¤‡ä»½æ—¶é—´

**é…ç½®æ–¹æ³•**:

```sql
-- PostgreSQL 18å¢é‡å¤‡ä»½é…ç½®
-- postgresql.conf

-- å¯ç”¨WAL Summarizerï¼ˆPostgreSQL 18é»˜è®¤å¯ç”¨ï¼‰
wal_summarizer = on

-- æŸ¥çœ‹WAL SummarizerçŠ¶æ€
SELECT * FROM pg_stat_wal_summarizer;

-- ä½¿ç”¨pg_basebackupè¿›è¡Œå¢é‡å¤‡ä»½
-- PostgreSQL 18æ–°å¢--incrementalé€‰é¡¹
pg_basebackup -D /backup/incremental \
    --incremental \
    --progress \
    --verbose
```

**æ€§èƒ½æå‡**:

- PostgreSQL 17: å…¨é‡å¤‡ä»½ï¼Œè€—æ—¶åŸºå‡†
- PostgreSQL 18: å¢é‡å¤‡ä»½ï¼ŒèŠ‚çœ94%æ—¶é—´
- é¦–æ¬¡å¤‡ä»½åï¼Œåç»­å¤‡ä»½æ—¶é—´å¤§å¹…å‡å°‘
- ç‰¹åˆ«é€‚ç”¨äºå¤§å‹æ•°æ®åº“çš„å®šæœŸå¤‡ä»½

**ä½¿ç”¨åœºæ™¯**:

1. **å®šæœŸå¢é‡å¤‡ä»½**

   ```bash
   # æ¯æ—¥å¢é‡å¤‡ä»½
   pg_basebackup -D /backup/daily/incremental \
       --incremental \
       --progress
   ```

2. **æ—¶é—´ç‚¹æ¢å¤**

   ```bash
   # åŸºäºå¢é‡å¤‡ä»½çš„æ—¶é—´ç‚¹æ¢å¤
   pg_basebackup -D /backup/restore \
       --incremental \
       --target-time="2025-11-22 12:00:00"
   ```

**æœ€ä½³å®è·µ**:

- å®šæœŸæ‰§è¡Œå…¨é‡å¤‡ä»½ä½œä¸ºåŸºå‡†
- ä½¿ç”¨å¢é‡å¤‡ä»½è¿›è¡Œæ—¥å¸¸å¤‡ä»½
- ç›‘æ§WAL Summarizerè¿›ç¨‹çŠ¶æ€
- PostgreSQL 18çš„å¢é‡å¤‡ä»½ç‰¹åˆ«é€‚ç”¨äºå¤§å‹æ•°æ®åº“ï¼ˆTBçº§åˆ«ï¼‰

### 8.1 è¡¨ç©ºé—´ç®¡ç†

```sql
-- åˆ›å»ºè¡¨ç©ºé—´
CREATE TABLESPACE fastspace LOCATION '/fast/disk/postgresql';

-- åœ¨è¡¨ç©ºé—´åˆ›å»ºè¡¨
CREATE TABLE large_table (
    id SERIAL PRIMARY KEY,
    data TEXT
) TABLESPACE fastspace;

-- ç§»åŠ¨è¡¨åˆ°æ–°è¡¨ç©ºé—´
ALTER TABLE large_table SET TABLESPACE fastspace;

-- æŸ¥çœ‹è¡¨ç©ºé—´ä½¿ç”¨æƒ…å†µ
SELECT
    t.spcname,
    pg_size_pretty(pg_tablespace_size(t.spcname)) as size
FROM pg_tablespace t;
```

### 8.2 åˆ†åŒºè¡¨ä¼˜åŒ–

```sql
-- åˆ›å»ºåˆ†åŒºè¡¨
CREATE TABLE sales (
    id SERIAL,
    sale_date DATE,
    amount DECIMAL(10,2)
) PARTITION BY RANGE (sale_date);

-- åˆ›å»ºåˆ†åŒº
CREATE TABLE sales_2023 PARTITION OF sales
FOR VALUES FROM ('2023-01-01') TO ('2024-01-01')
TABLESPACE fastspace;

CREATE TABLE sales_2024 PARTITION OF sales
FOR VALUES FROM ('2024-01-01') TO ('2025-01-01')
TABLESPACE fastspace;

-- æŸ¥çœ‹åˆ†åŒºä¿¡æ¯
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
WHERE tablename LIKE 'sales_%'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 8.3 å‹ç¼©å’ŒTOAST

```sql
-- æŸ¥çœ‹TOASTè¡¨
SELECT
    c.relname,
    t.relname as toast_table,
    pg_size_pretty(pg_total_relation_size(t.oid)) as toast_size
FROM pg_class c
JOIN pg_class t ON t.oid = c.reltoastrelid
WHERE c.relkind = 'r'
ORDER BY pg_total_relation_size(t.oid) DESC;

-- å‹ç¼©é…ç½®
ALTER TABLE large_table SET (toast_tuple_target = 128);
ALTER TABLE large_table SET (fillfactor = 80);
```

---

## ä¹ã€æ€§èƒ½ç›‘æ§

### 9.1 I/Oæ€§èƒ½ç›‘æ§

```sql
-- æ•°æ®åº“I/Oç»Ÿè®¡
SELECT
    datname,
    blks_read,
    blks_hit,
    round(100.0 * blks_hit / (blks_hit + blks_read), 2) as hit_ratio,
    tup_returned,
    tup_fetched,
    tup_inserted,
    tup_updated,
    tup_deleted
FROM pg_stat_database
WHERE datname = current_database();

-- è¡¨I/Oç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    heap_blks_read,
    heap_blks_hit,
    idx_blks_read,
    idx_blks_hit,
    round(100.0 * heap_blks_hit / (heap_blks_hit + heap_blks_read), 2) as heap_hit_ratio,
    round(100.0 * idx_blks_hit / (idx_blks_hit + idx_blks_read), 2) as idx_hit_ratio
FROM pg_statio_user_tables
ORDER BY heap_blks_read + heap_blks_hit DESC;
```

### 9.2 å­˜å‚¨æ€§èƒ½åˆ†æ

```sql
-- å­˜å‚¨ä½¿ç”¨åˆ†æ
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) as table_size,
    pg_size_pretty(pg_indexes_size(schemaname||'.'||tablename)) as indexes_size,
    round(100.0 * pg_indexes_size(schemaname||'.'||tablename) / pg_total_relation_size(schemaname||'.'||tablename), 2) as index_ratio
FROM pg_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

---

## åã€å®é™…åº”ç”¨æ¡ˆä¾‹

### 10.1 å¤§æ•°æ®è¡¨ä¼˜åŒ–

```sql
-- å¤§è¡¨åˆ†åŒºç­–ç•¥
CREATE TABLE log_entries (
    id BIGSERIAL,
    log_time TIMESTAMP,
    level VARCHAR(10),
    message TEXT,
    source VARCHAR(100)
) PARTITION BY RANGE (log_time);

-- æŒ‰æœˆåˆ†åŒº
CREATE TABLE log_entries_2024_01 PARTITION OF log_entries
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE log_entries_2024_02 PARTITION OF log_entries
FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');

-- è‡ªåŠ¨åˆ†åŒºç®¡ç†
CREATE OR REPLACE FUNCTION create_monthly_partition(table_name text, start_date date)
RETURNS void AS $$
DECLARE
    partition_name text;
    end_date date;
BEGIN
    partition_name := table_name || '_' || to_char(start_date, 'YYYY_MM');
    end_date := start_date + interval '1 month';

    EXECUTE format('CREATE TABLE %I PARTITION OF %I FOR VALUES FROM (%L) TO (%L)',
                   partition_name, table_name, start_date, end_date);
END;
$$ LANGUAGE plpgsql;
```

### 10.2 é«˜å¹¶å‘å†™å…¥ä¼˜åŒ–

```sql
-- æ‰¹é‡æ’å…¥ä¼˜åŒ–
BEGIN;
INSERT INTO large_table (col1, col2, col3)
SELECT
    generate_series(1, 1000000),
    'data' || generate_series(1, 1000000),
    random() * 1000;
COMMIT;

-- å¹¶è¡Œå†™å…¥ä¼˜åŒ–
SET max_parallel_workers_per_gather = 4;
SET parallel_tuple_cost = 0.1;
SET parallel_setup_cost = 1000;

-- ä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS)
SELECT COUNT(*) FROM large_table WHERE col1 > 500000;
```

---

## åä¸€ã€ç›¸å…³æ¦‚å¿µ

### 11.1 ä¸Šä½æ¦‚å¿µ

- **æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ**: æ›´å¹¿æ³›çš„ç³»ç»Ÿç±»åˆ«
- **å­˜å‚¨ç³»ç»Ÿ**: æ•°æ®æŒä¹…åŒ–æœºåˆ¶
- **æ–‡ä»¶ç³»ç»Ÿ**: åº•å±‚å­˜å‚¨ç®¡ç†

### 11.2 ä¸‹ä½æ¦‚å¿µ

- **ç¼“å†²åŒºç®¡ç†**: å†…å­˜ç¼“å­˜æœºåˆ¶
- **WALæ—¥å¿—**: äº‹åŠ¡æ—¥å¿—ç³»ç»Ÿ
- **æ£€æŸ¥ç‚¹**: æ•°æ®ä¸€è‡´æ€§ä¿è¯
- **é¡µé¢ç®¡ç†**: æ•°æ®é¡µé¢ç»„ç»‡

### 11.3 å¹³è¡Œæ¦‚å¿µ

- **å†…å­˜æ•°æ®åº“**: åŸºäºå†…å­˜çš„å­˜å‚¨
- **åˆ†å¸ƒå¼å­˜å‚¨**: è·¨èŠ‚ç‚¹å­˜å‚¨ç®¡ç†
- **äº‘å­˜å‚¨**: äº‘ç«¯å­˜å‚¨æœåŠ¡

---

## åäºŒã€å‚è€ƒèµ„æº

### 12.1 ç›¸å…³æ–‡æ¡£

- [äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§](./01.04-äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§.md) - WALæœºåˆ¶ç†è®ºåŸºç¡€
- [å¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶](./01.05-å¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶.md) - å¹¶å‘æ§åˆ¶å®ç°
- [å¤‡ä»½ä¸æ¢å¤](../06-è¿ç»´å®è·µ/å¤‡ä»½ä¸æ¢å¤/06.06-å¤‡ä»½ä¸æ¢å¤.md) - æ•°æ®æŒä¹…åŒ–å®è·µ
- [æ€§èƒ½è°ƒä¼˜å®è·µ](../05-éƒ¨ç½²æ¶æ„/å•æœºéƒ¨ç½²/05.02-æ€§èƒ½è°ƒä¼˜å®è·µ.md) - å­˜å‚¨æ€§èƒ½ä¼˜åŒ–

### 12.2 å®æˆ˜æ¡ˆä¾‹ä¸ç¤ºä¾‹

- [å¯è¿è¡Œç¤ºä¾‹é¡¹ç›®](../examples/README.md) â­ - 8ä¸ªå®Œæ•´çš„Docker Composeç¤ºä¾‹
- [Dockeréƒ¨ç½²æŒ‡å—](../05-éƒ¨ç½²æ¶æ„/å®¹å™¨åŒ–éƒ¨ç½²/05.12-Dockeréƒ¨ç½².md) - å­˜å‚¨é…ç½®å®è·µ
- [å¤‡ä»½ä¸æ¢å¤å®è·µ](../06-è¿ç»´å®è·µ/å¤‡ä»½ä¸æ¢å¤/06.07-å¢é‡å¤‡ä»½ä¸æ¢å¤.md) - PostgreSQL 18å¢é‡å¤‡ä»½

### 12.3 å‚è€ƒæ–‡çŒ®

1. Mohan, C., et al. (1992). ARIES: A transaction recovery method supporting fine-granularity locking and partial rollbacks using write-ahead logging. ACM TODS, 17(1), 94-162.
2. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Documentation. <https://www.postgresql.org/docs/18/>
3. Gray, J., & Reuter, A. (1993). Transaction Processing: Concepts and Techniques. Morgan Kaufmann.
4. Silberschatz, A., Galvin, P. B., & Gagne, G. (2018). Operating System Concepts (10th ed.). John Wiley & Sons.
5. PostgreSQL Global Development Group. (2024). PostgreSQL 17 Documentation. <https://www.postgresql.org/docs/17/>

### 12.4 Wikidataå¯¹é½

- **Wikidata ID**: Q192490
- **ç›¸å…³å±æ€§**:
  - P31: Q176165 (instance of: database management system)
  - P178: Q9366 (developer: PostgreSQL Global Development Group)
  - P277: Q193321 (programmed in: C)
  - P348: 18.0 (software version)
- **å¤–éƒ¨é“¾æ¥**:
  - <https://www.postgresql.org/docs/current/storage.html>
  - <https://www.postgresql.org/docs/current/wal.html>
