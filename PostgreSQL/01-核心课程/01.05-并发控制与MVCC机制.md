# PostgreSQLå¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶å®Œæ•´æŒ‡å—

> **ç‰ˆæœ¬**: v3.0
> **æœ€åæ›´æ–°**: 2025-01-15
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **éš¾åº¦**: â­â­â­â­
> **åº”ç”¨åœºæ™¯**: å¹¶å‘æ§åˆ¶ã€MVCCã€é”æœºåˆ¶ã€æ€§èƒ½ä¼˜åŒ–ã€é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡
> ğŸ†• **PostgreSQL 18 MVCCæ”¹è¿›**: æ›´é«˜æ•ˆçš„VACUUMã€æ›´å¥½çš„æ­»é”æ£€æµ‹ã€é€»è¾‘å¤åˆ¶æ€§èƒ½æå‡38%ã€å¼‚æ­¥I/Oæå‡å¹¶å‘æ€§èƒ½

---

## ğŸ“‘ ç›®å½•

- [PostgreSQLå¹¶å‘æ§åˆ¶ä¸MVCCæœºåˆ¶å®Œæ•´æŒ‡å—](#postgresqlå¹¶å‘æ§åˆ¶ä¸mvccæœºåˆ¶å®Œæ•´æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“Š æ€ç»´å¯¼å›¾](#-æ€ç»´å¯¼å›¾)
  - [ä¸€ã€å®šä¹‰ä¸å½¢å¼åŒ–](#ä¸€å®šä¹‰ä¸å½¢å¼åŒ–)
    - [1.1 æ¦‚å¿µå®šä¹‰](#11-æ¦‚å¿µå®šä¹‰)
    - [1.2 å½¢å¼åŒ–å®šä¹‰](#12-å½¢å¼åŒ–å®šä¹‰)
    - [1.3 æ ¸å¿ƒå±æ€§](#13-æ ¸å¿ƒå±æ€§)
  - [äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#äºŒçŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [2.1 å¹¶å‘æ§åˆ¶æœºåˆ¶å¯¹æ¯”](#21-å¹¶å‘æ§åˆ¶æœºåˆ¶å¯¹æ¯”)
    - [2.2 é”ç±»å‹å¯¹æ¯”](#22-é”ç±»å‹å¯¹æ¯”)
  - [ä¸‰ã€ç†è®ºåŸºç¡€](#ä¸‰ç†è®ºåŸºç¡€)
    - [3.1 é”æœºåˆ¶ç†è®º](#31-é”æœºåˆ¶ç†è®º)
    - [3.2 MVCCç†è®º](#32-mvccç†è®º)
    - [3.3 å¯ä¸²è¡ŒåŒ–ç†è®º](#33-å¯ä¸²è¡ŒåŒ–ç†è®º)
  - [å››ã€PostgreSQL MVCCå®ç°](#å››postgresql-mvccå®ç°)
    - [4.1 è¡Œç‰ˆæœ¬ç®¡ç†](#41-è¡Œç‰ˆæœ¬ç®¡ç†)
    - [4.2 äº‹åŠ¡å¿«ç…§](#42-äº‹åŠ¡å¿«ç…§)
    - [4.3 ç‰ˆæœ¬æ¸…ç†æœºåˆ¶](#43-ç‰ˆæœ¬æ¸…ç†æœºåˆ¶)
  - [äº”ã€é”æœºåˆ¶å®ç°](#äº”é”æœºåˆ¶å®ç°)
    - [5.1 é”ç±»å‹å’Œæ¨¡å¼](#51-é”ç±»å‹å’Œæ¨¡å¼)
    - [5.2 é”ç›‘æ§](#52-é”ç›‘æ§)
    - [5.3 æ­»é”æ£€æµ‹å’Œå¤„ç†](#53-æ­»é”æ£€æµ‹å’Œå¤„ç†)
  - [å…­ã€éš”ç¦»çº§åˆ«å®ç°](#å…­éš”ç¦»çº§åˆ«å®ç°)
    - [6.1 éš”ç¦»çº§åˆ«é…ç½®](#61-éš”ç¦»çº§åˆ«é…ç½®)
    - [6.2 éš”ç¦»çº§åˆ«æµ‹è¯•](#62-éš”ç¦»çº§åˆ«æµ‹è¯•)
  - [ä¸ƒã€æ€§èƒ½ä¼˜åŒ–](#ä¸ƒæ€§èƒ½ä¼˜åŒ–)
    - [7.1 MVCCä¼˜åŒ–](#71-mvccä¼˜åŒ–)
    - [7.2 é”ä¼˜åŒ–](#72-é”ä¼˜åŒ–)
  - [å…«ã€å®é™…åº”ç”¨æ¡ˆä¾‹](#å…«å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [8.1 é«˜å¹¶å‘è®¢å•ç³»ç»Ÿ](#81-é«˜å¹¶å‘è®¢å•ç³»ç»Ÿ)
    - [8.2 å®æ—¶æ•°æ®æ›´æ–°](#82-å®æ—¶æ•°æ®æ›´æ–°)
  - [ä¹ã€ç›¸å…³æ¦‚å¿µ](#ä¹ç›¸å…³æ¦‚å¿µ)
    - [9.1 ä¸Šä½æ¦‚å¿µ](#91-ä¸Šä½æ¦‚å¿µ)
    - [9.2 ä¸‹ä½æ¦‚å¿µ](#92-ä¸‹ä½æ¦‚å¿µ)
    - [9.3 å¹³è¡Œæ¦‚å¿µ](#93-å¹³è¡Œæ¦‚å¿µ)
  - [åã€å‚è€ƒèµ„æº](#åå‚è€ƒèµ„æº)
    - [10.1 ç›¸å…³æ–‡æ¡£](#101-ç›¸å…³æ–‡æ¡£)
    - [10.2 å‚è€ƒæ–‡çŒ®](#102-å‚è€ƒæ–‡çŒ®)
    - [10.3 Wikidataå¯¹é½](#103-wikidataå¯¹é½)

---

## ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((å¹¶å‘æ§åˆ¶))
    ç†è®ºåŸºç¡€
      é”æœºåˆ¶ç†è®º
      MVCCç†è®º
      å¯ä¸²è¡ŒåŒ–ç†è®º
    MVCCå®ç°
      è¡Œç‰ˆæœ¬ç®¡ç†
      äº‹åŠ¡å¿«ç…§
      ç‰ˆæœ¬æ¸…ç†
    é”æœºåˆ¶
      é”ç±»å‹
      é”ç›‘æ§
      æ­»é”æ£€æµ‹
    éš”ç¦»çº§åˆ«
      é…ç½®
      æµ‹è¯•
    æ€§èƒ½ä¼˜åŒ–
      MVCCä¼˜åŒ–
      é”ä¼˜åŒ–
    å®é™…åº”ç”¨
      é«˜å¹¶å‘è®¢å•
      å®æ—¶æ•°æ®æ›´æ–°
```

---

## ä¸€ã€å®šä¹‰ä¸å½¢å¼åŒ–

### 1.1 æ¦‚å¿µå®šä¹‰

**ä¸­æ–‡å®šä¹‰**: å¹¶å‘æ§åˆ¶æ˜¯æ•°æ®åº“ç³»ç»Ÿä¸­ç®¡ç†å¤šä¸ªäº‹åŠ¡åŒæ—¶è®¿é—®å…±äº«æ•°æ®çš„æœºåˆ¶ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§å’Œäº‹åŠ¡éš”ç¦»æ€§ã€‚PostgreSQLé‡‡ç”¨MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰æœºåˆ¶å®ç°é«˜æ•ˆçš„å¹¶å‘æ§åˆ¶ã€‚

**English Definition**: Concurrency control is a mechanism in database systems that manages multiple transactions accessing shared data simultaneously, ensuring data consistency and transaction isolation. PostgreSQL uses MVCC (Multi-Version Concurrency Control) mechanism for efficient concurrency control.

### 1.2 å½¢å¼åŒ–å®šä¹‰

```latex
% æ•°å­¦ç¬¦å·å®šä¹‰
\newcommand{\lock}{\mathcal{L}}
\newcommand{\trans}{\mathcal{T}}
\newcommand{\resource}{\mathcal{R}}
\newcommand{\version}{\mathcal{V}}
\newcommand{\snapshot}{\mathcal{S}}

% é”çš„å½¢å¼åŒ–å®šä¹‰
\lock = \{l_1, l_2, \ldots, l_n\}

å…¶ä¸­æ¯ä¸ªé” l_i = (r_i, t_i, mode_i) è¡¨ç¤ºï¼š
- r_i \in \resource: è¢«é”å®šçš„èµ„æº
- t_i \in \trans: æŒæœ‰é”çš„äº‹åŠ¡
- mode_i \in \{S, X\}: é”æ¨¡å¼ï¼ˆå…±äº«/æ’ä»–ï¼‰

% MVCCçš„å½¢å¼åŒ–å®šä¹‰
\version = \{v_1, v_2, \ldots, v_m\}

å…¶ä¸­æ¯ä¸ªç‰ˆæœ¬ v_i = (data_i, xmin_i, xmax_i) è¡¨ç¤ºï¼š
- data_i: ç‰ˆæœ¬æ•°æ®
- xmin_i: åˆ›å»ºç‰ˆæœ¬çš„äº‹åŠ¡ID
- xmax_i: åˆ é™¤ç‰ˆæœ¬çš„äº‹åŠ¡ID
```

### 1.3 æ ¸å¿ƒå±æ€§

- **éš”ç¦»æ€§**: å¹¶å‘äº‹åŠ¡é—´ç›¸äº’éš”ç¦»
- **ä¸€è‡´æ€§**: ä¿è¯æ•°æ®å®Œæ•´æ€§
- **æ­»é”é¿å…**: é˜²æ­¢æ­»é”å‘ç”Ÿ
- **æ€§èƒ½ä¼˜åŒ–**: æœ€å¤§åŒ–å¹¶å‘åº¦

---

## äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 2.1 å¹¶å‘æ§åˆ¶æœºåˆ¶å¯¹æ¯”

| å¹¶å‘æ§åˆ¶æœºåˆ¶ | å®ç°æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------------|---------|------|------|---------|
| ä¸¤é˜¶æ®µé”ï¼ˆ2PLï¼‰ | é”æœºåˆ¶ | ç®€å•ã€å¯é  | æ­»é”é£é™©ã€æ€§èƒ½è¾ƒä½ | ä¼ ç»Ÿæ•°æ®åº“ |
| MVCC | å¤šç‰ˆæœ¬ | é«˜å¹¶å‘ã€æ— é”è¯» | å­˜å‚¨å¼€é”€ã€ç‰ˆæœ¬æ¸…ç† | PostgreSQLã€Oracle |
| æ—¶é—´æˆ³æ’åº | æ—¶é—´æˆ³ | æ— æ­»é” | å›æ»šå¼€é”€å¤§ | ç ”ç©¶ç³»ç»Ÿ |
| ä¹è§‚å¹¶å‘æ§åˆ¶ | ç‰ˆæœ¬å· | é«˜å¹¶å‘è¯» | å†²çªæ—¶å›æ»š | è¯»å¤šå†™å°‘åœºæ™¯ |

### 2.2 é”ç±»å‹å¯¹æ¯”

| é”ç±»å‹ | ç²’åº¦ | å…¼å®¹æ€§ | æ€§èƒ½å½±å“ | ä½¿ç”¨åœºæ™¯ |
|-------|------|--------|---------|---------|
| è¡¨çº§é” | è¡¨ | ä½ | é«˜ | DDLæ“ä½œ |
| è¡Œçº§é” | è¡Œ | é«˜ | ä½ | DMLæ“ä½œ |
| é¡µçº§é” | é¡µ | ä¸­ | ä¸­ | è¾ƒå°‘ä½¿ç”¨ |
| æ„å‘é” | è¡¨+è¡Œ | ä¸­ | ä¸­ | é”å‡çº§ |

---

## ä¸‰ã€ç†è®ºåŸºç¡€

### 3.1 é”æœºåˆ¶ç†è®º

```latex
\begin{theorem}[ä¸¤é˜¶æ®µåŠ é”åè®®]
äº‹åŠ¡Tæ»¡è¶³ä¸¤é˜¶æ®µåŠ é”åè®®ï¼Œå½“ä¸”ä»…å½“ï¼š
1. å¢é•¿é˜¶æ®µï¼šTåªèƒ½è·å¾—é”ï¼Œä¸èƒ½é‡Šæ”¾é”
2. æ”¶ç¼©é˜¶æ®µï¼šTåªèƒ½é‡Šæ”¾é”ï¼Œä¸èƒ½è·å¾—é”
\end{theorem}

\begin{proof}
åŸºäºé”çš„å…¼å®¹æ€§çŸ©é˜µå’Œäº‹åŠ¡çŠ¶æ€è½¬æ¢ï¼Œå¯ä»¥è¯æ˜ä¸¤é˜¶æ®µåŠ é”åè®®çš„æ­£ç¡®æ€§ã€‚
\end{proof}
```

### 3.2 MVCCç†è®º

```latex
\begin{theorem}[å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶]
MVCCé€šè¿‡ä»¥ä¸‹æœºåˆ¶å®ç°å¹¶å‘æ§åˆ¶ï¼š
1. æ¯ä¸ªäº‹åŠ¡çœ‹åˆ°æ•°æ®çš„ä¸€è‡´æ€§å¿«ç…§
2. å†™æ“ä½œåˆ›å»ºæ–°ç‰ˆæœ¬ï¼Œä¸é˜»å¡è¯»æ“ä½œ
3. åƒåœ¾å›æ”¶æœºåˆ¶æ¸…ç†è¿‡æœŸç‰ˆæœ¬
4. ç‰ˆæœ¬å¯è§æ€§åŸºäºäº‹åŠ¡IDæ¯”è¾ƒ
\end{theorem}

\begin{proof}
åŸºäºäº‹åŠ¡IDçš„ååºå…³ç³»å’Œç‰ˆæœ¬å¯è§æ€§è§„åˆ™ï¼Œå¯ä»¥è¯æ˜MVCCçš„æ­£ç¡®æ€§ã€‚
\end{proof}
```

### 3.3 å¯ä¸²è¡ŒåŒ–ç†è®º

```latex
\begin{theorem}[å¯ä¸²è¡ŒåŒ–åˆ¤å®š]
è°ƒåº¦Sæ˜¯å¯ä¸²è¡ŒåŒ–çš„ï¼Œå½“ä¸”ä»…å½“ï¼š
1. å†²çªå›¾æ˜¯æ— ç¯çš„
2. å­˜åœ¨æ‹“æ‰‘æ’åº
3. æ‹“æ‰‘æ’åºå¯¹åº”ä¸²è¡Œè°ƒåº¦
\end{theorem}
```

---

## å››ã€PostgreSQL MVCCå®ç°

### 4.1 è¡Œç‰ˆæœ¬ç®¡ç†

```sql
-- æŸ¥çœ‹è¡Œç‰ˆæœ¬ä¿¡æ¯
SELECT
    ctid,
    xmin,
    xmax,
    cmin,
    cmax,
    *
FROM employees
WHERE emp_id = 1001;

-- æŸ¥çœ‹äº‹åŠ¡ID
SELECT txid_current();
SELECT txid_current_snapshot();

-- æŸ¥çœ‹ç‰ˆæœ¬å¯è§æ€§
SELECT
    xmin,
    xmax,
    CASE
        WHEN xmin = 0 THEN 'invalid'
        WHEN xmax != 0 THEN 'deleted'
        ELSE 'visible'
    END as status
FROM employees
WHERE emp_id = 1001;
```

### 4.2 äº‹åŠ¡å¿«ç…§

```sql
-- åˆ›å»ºäº‹åŠ¡å¿«ç…§
BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SELECT txid_current_snapshot();

-- æŸ¥çœ‹å¿«ç…§ä¿¡æ¯
SELECT
    txid_snapshot_xmin(txid_current_snapshot()) as xmin,
    txid_snapshot_xmax(txid_current_snapshot()) as xmax,
    txid_snapshot_xip(txid_current_snapshot()) as active_xids;

-- å¿«ç…§éš”ç¦»ç¤ºä¾‹
BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SELECT * FROM employees WHERE dept_id = 1;
-- åœ¨å¦ä¸€ä¸ªä¼šè¯ä¸­æ’å…¥æ•°æ®
SELECT * FROM employees WHERE dept_id = 1; -- ä»ç„¶çœ‹åˆ°ç›¸åŒç»“æœ
COMMIT;
```

### 4.3 ç‰ˆæœ¬æ¸…ç†æœºåˆ¶

```sql
-- æŸ¥çœ‹VACUUMç»Ÿè®¡ä¿¡æ¯
SELECT * FROM pg_stat_user_tables;

-- æ‰‹åŠ¨VACUUM
VACUUM employees;
VACUUM ANALYZE employees;

-- æŸ¥çœ‹æ­»å…ƒç»„
SELECT
    schemaname,
    tablename,
    n_dead_tup,
    n_live_tup,
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables
WHERE n_dead_tup > 0;

-- é…ç½®è‡ªåŠ¨VACUUM
ALTER TABLE employees SET (autovacuum_vacuum_threshold = 50);
ALTER TABLE employees SET (autovacuum_analyze_threshold = 50);
```

---

## äº”ã€é”æœºåˆ¶å®ç°

### 5.1 é”ç±»å‹å’Œæ¨¡å¼

```sql
-- è¡¨çº§é”
LOCK TABLE employees IN SHARE MODE;
LOCK TABLE departments IN EXCLUSIVE MODE;

-- è¡Œçº§é”
SELECT * FROM employees WHERE emp_id = 1001 FOR UPDATE;
SELECT * FROM employees WHERE dept_id = 1 FOR SHARE;

-- é¡µçº§é”ï¼ˆè‡ªåŠ¨ï¼‰
UPDATE employees SET salary = salary * 1.1 WHERE dept_id = 1;

-- å’¨è¯¢é”
SELECT pg_advisory_lock(12345);
SELECT pg_advisory_unlock(12345);
```

### 5.2 é”ç›‘æ§

```sql
-- æŸ¥çœ‹å½“å‰é”
SELECT
    locktype,
    database,
    relation,
    page,
    tuple,
    virtualxid,
    transactionid,
    classid,
    objid,
    objsubid,
    virtualtransaction,
    pid,
    mode,
    granted
FROM pg_locks
WHERE NOT granted;

-- æŸ¥çœ‹é”ç­‰å¾…
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS current_statement_in_blocking_process
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

### 5.3 æ­»é”æ£€æµ‹å’Œå¤„ç†

```sql
-- æ­»é”æ£€æµ‹é…ç½®
SHOW deadlock_timeout;
SET deadlock_timeout = '1s';

-- æŸ¥çœ‹æ­»é”ç»Ÿè®¡
SELECT * FROM pg_stat_database_conflicts;

-- æ­»é”é¿å…ç­–ç•¥
BEGIN;
-- æŒ‰å›ºå®šé¡ºåºè®¿é—®èµ„æº
SELECT * FROM accounts WHERE account_id = 1001 FOR UPDATE;
SELECT * FROM accounts WHERE account_id = 1002 FOR UPDATE;
COMMIT;
```

---

## å…­ã€éš”ç¦»çº§åˆ«å®ç°

### 6.1 éš”ç¦»çº§åˆ«é…ç½®

```sql
-- è®¾ç½®ä¼šè¯éš”ç¦»çº§åˆ«
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SET SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE;

-- è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«
BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;
SELECT * FROM employees WHERE dept_id = 1;
COMMIT;

-- æŸ¥çœ‹å½“å‰éš”ç¦»çº§åˆ«
SHOW transaction_isolation;
```

### 6.2 éš”ç¦»çº§åˆ«æµ‹è¯•

```sql
-- è„è¯»æµ‹è¯•ï¼ˆPostgreSQLä¸æ”¯æŒï¼‰
-- ä¸å¯é‡å¤è¯»æµ‹è¯•
BEGIN TRANSACTION ISOLATION LEVEL READ COMMITTED;
SELECT * FROM employees WHERE emp_id = 1001;
-- åœ¨å¦ä¸€ä¸ªä¼šè¯ä¸­æ›´æ–°æ•°æ®
SELECT * FROM employees WHERE emp_id = 1001; -- å¯èƒ½çœ‹åˆ°ä¸åŒç»“æœ
COMMIT;

-- å¹»è¯»æµ‹è¯•
BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SELECT COUNT(*) FROM employees WHERE dept_id = 1;
-- åœ¨å¦ä¸€ä¸ªä¼šè¯ä¸­æ’å…¥æ•°æ®
SELECT COUNT(*) FROM employees WHERE dept_id = 1; -- ä»ç„¶çœ‹åˆ°ç›¸åŒç»“æœ
COMMIT;
```

---

## ä¸ƒã€æ€§èƒ½ä¼˜åŒ–

### 7.1 MVCCä¼˜åŒ–

```sql
-- å‡å°‘ç‰ˆæœ¬åˆ›å»º
BEGIN;
-- æ‰¹é‡æ“ä½œå‡å°‘ç‰ˆæœ¬æ•°é‡
UPDATE employees SET salary = salary * 1.1 WHERE dept_id = 1;
COMMIT;

-- ä¼˜åŒ–VACUUMç­–ç•¥
ALTER TABLE employees SET (autovacuum_vacuum_scale_factor = 0.1);
ALTER TABLE employees SET (autovacuum_analyze_scale_factor = 0.05);

-- ç›‘æ§ç‰ˆæœ¬è†¨èƒ€
SELECT
    schemaname,
    tablename,
    n_dead_tup,
    n_live_tup,
    ROUND(n_dead_tup::numeric / (n_live_tup + n_dead_tup) * 100, 2) as dead_ratio
FROM pg_stat_user_tables
WHERE n_dead_tup > 0
ORDER BY dead_ratio DESC;
```

### 7.2 é”ä¼˜åŒ–

```sql
-- å‡å°‘é”ç«äº‰
BEGIN;
-- ä½¿ç”¨ç´¢å¼•å‡å°‘é”èŒƒå›´
UPDATE employees SET salary = salary * 1.1
WHERE dept_id = 1 AND emp_id > 1000;
COMMIT;

-- ä½¿ç”¨ä¹è§‚é”
BEGIN;
SELECT version, salary FROM employees WHERE emp_id = 1001;
-- åº”ç”¨å±‚å¤„ç†
UPDATE employees SET salary = 60000, version = version + 1
WHERE emp_id = 1001 AND version = 1;
COMMIT;

-- é”å‡çº§é¿å…
BEGIN;
-- é¿å…é•¿æ—¶é—´æŒæœ‰é”
SELECT * FROM employees WHERE dept_id = 1 FOR UPDATE;
-- å¿«é€Ÿå¤„ç†
UPDATE employees SET last_updated = NOW() WHERE dept_id = 1;
COMMIT;
```

---

## å…«ã€å®é™…åº”ç”¨æ¡ˆä¾‹

### 8.1 é«˜å¹¶å‘è®¢å•ç³»ç»Ÿ

```sql
-- ä¹è§‚é”å®ç°åº“å­˜æ‰£å‡
BEGIN;
-- æ£€æŸ¥åº“å­˜
SELECT stock_quantity, version FROM products WHERE product_id = 1001;
-- åº”ç”¨å±‚æ£€æŸ¥åº“å­˜æ˜¯å¦è¶³å¤Ÿ
-- æ‰£å‡åº“å­˜
UPDATE products
SET stock_quantity = stock_quantity - 5, version = version + 1
WHERE product_id = 1001 AND stock_quantity >= 5 AND version = :current_version;
-- æ£€æŸ¥æ›´æ–°æ˜¯å¦æˆåŠŸ
IF NOT FOUND THEN
    ROLLBACK;
    RAISE EXCEPTION 'åº“å­˜ä¸è¶³æˆ–ç‰ˆæœ¬å†²çª';
END IF;
COMMIT;
```

### 8.2 å®æ—¶æ•°æ®æ›´æ–°

```sql
-- ä½¿ç”¨MVCCå®ç°å®æ—¶æ•°æ®è¯»å–
BEGIN TRANSACTION ISOLATION LEVEL READ COMMITTED;
-- è¯»å–å½“å‰æ•°æ®
SELECT * FROM real_time_data WHERE sensor_id = 1001;
-- åœ¨å¦ä¸€ä¸ªä¼šè¯ä¸­æ›´æ–°æ•°æ®
-- è¯»å–æœ€æ–°æ•°æ®
SELECT * FROM real_time_data WHERE sensor_id = 1001;
COMMIT;
```

---

## ä¹ã€ç›¸å…³æ¦‚å¿µ

### 9.1 ä¸Šä½æ¦‚å¿µ

- **å¹¶å‘æ§åˆ¶**: æ›´å¹¿æ³›çš„å¹¶å‘ç®¡ç†æœºåˆ¶
- **äº‹åŠ¡ç®¡ç†**: äº‹åŠ¡å¤„ç†æœºåˆ¶
- **æ•°æ®ä¸€è‡´æ€§**: æ•°æ®å®Œæ•´æ€§ä¿è¯

### 9.2 ä¸‹ä½æ¦‚å¿µ

- **MVCC**: å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶
- **é”æœºåˆ¶**: å¹¶å‘æ§åˆ¶å®ç°
- **äº‹åŠ¡éš”ç¦»**: éš”ç¦»çº§åˆ«ç®¡ç†
- **æ­»é”æ£€æµ‹**: æ­»é”å¤„ç†æœºåˆ¶

### 9.3 å¹³è¡Œæ¦‚å¿µ

- **ä¸¤é˜¶æ®µåŠ é”**: ä¼ ç»Ÿé”åè®®
- **æ—¶é—´æˆ³æ’åº**: åŸºäºæ—¶é—´æˆ³çš„å¹¶å‘æ§åˆ¶
- **ä¹è§‚å¹¶å‘æ§åˆ¶**: ä¹è§‚é”æœºåˆ¶

---

## åã€å‚è€ƒèµ„æº

### 10.1 ç›¸å…³æ–‡æ¡£

- [äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§](./01.04-äº‹åŠ¡ç®¡ç†ä¸ACIDç‰¹æ€§.md) - äº‹åŠ¡ç†è®ºåŸºç¡€
- [åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†](../04-é«˜çº§ç‰¹æ€§/03.07-åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†.md) - åˆ†å¸ƒå¼å¹¶å‘æ§åˆ¶
- [å½¢å¼åŒ–éªŒè¯æ–¹æ³•](../10-ç†è®ºåŸºç¡€/10.01-å½¢å¼åŒ–éªŒè¯æ–¹æ³•.md) - MVCCæœºåˆ¶å½¢å¼åŒ–éªŒè¯
- [å­¦æœ¯ç ”ç©¶å‰æ²¿](../10-ç†è®ºåŸºç¡€/10.02-å­¦æœ¯ç ”ç©¶å‰æ²¿.md) - å¹¶å‘æ§åˆ¶ç†è®ºç ”ç©¶

### 10.2 å‚è€ƒæ–‡çŒ®

1. Berenson, H., et al. (1995). A critique of ANSI SQL isolation levels. ACM SIGMOD Record, 24(2), 1-10.
2. Mohan, C., et al. (1992). ARIES: A transaction recovery method supporting fine-granularity locking and partial rollbacks using write-ahead logging. ACM TODS, 17(1), 94-162.
3. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Documentation. <https://www.postgresql.org/docs/18/>
4. Gray, J., & Reuter, A. (1993). Transaction Processing: Concepts and Techniques. Morgan Kaufmann.
5. PostgreSQL Global Development Group. (2024). PostgreSQL 17 Documentation. <https://www.postgresql.org/docs/17/>

### 10.3 Wikidataå¯¹é½

- **Wikidata ID**: Q192490
- **ç›¸å…³å±æ€§**:
  - P31: Q176165 (instance of: database management system)
  - P178: Q9366 (developer: PostgreSQL Global Development Group)
  - P277: Q193321 (programmed in: C)
  - P348: 18.0 (software version)
- **å¤–éƒ¨é“¾æ¥**:
  - <https://www.postgresql.org/docs/current/mvcc.html>
  - <https://www.postgresql.org/docs/current/explicit-locking.html>
