# 集群部署与高可用

## 1. 概述

- 主从、同步/异步复制、故障转移、读写分离

## 2. 合并来源与映射

- 1.1.5-分布式与高可用.md
- 1.1.9-分布式PostgreSQL架构设计.md

## 3. 复制架构

- 物理复制/逻辑复制、同步策略、仲裁与漂移

### 3.1 物理复制最小示例

```sql
-- 主库创建复制槽（可选，但推荐避免WAL回收过快）
SELECT * FROM pg_create_physical_replication_slot('replica1');
```

`postgresql.conf`（主库）：

```text
wal_level = replica
max_wal_senders = 10
max_replication_slots = 10
wal_keep_size = '1GB'
```

`pg_hba.conf`：

```text
host replication repl 10.0.0.0/24 md5
```

从库初始化：

```bash
pg_basebackup -h primary -U repl -D $PGDATA -X stream -R -C -S replica1
```

### 3.2 同步策略与仲裁

- `synchronous_commit`：local | remote_write | remote_apply | on | off
- `synchronous_standby_names`：指定候选与法定人数（Quorum）：

  ```text
  synchronous_standby_names = 'ANY 1 (node_b, node_c)'
  ```

- 与业务SLA的RPO/RTO权衡：强同步提升一致性但拉高写延迟。

## 4. 高可用组件

- Patroni、pgpool-II、pgbouncer、keepalived

### 4.1 Patroni 基本配置示例

```yaml
scope: pg
namespace: /service/pg
name: node_a

restapi:
  listen: 0.0.0.0:8008
  connect_address: node_a:8008

etcd:
  hosts: [etcd1:2379, etcd2:2379, etcd3:2379]

postgresql:
  listen: 0.0.0.0:5432
  connect_address: node_a:5432
  data_dir: /var/lib/postgresql/data
  bin_dir: /usr/lib/postgresql/16/bin
  parameters:
    wal_level: replica
    max_wal_senders: 10
    max_replication_slots: 10
    synchronous_commit: 'on'
    synchronous_standby_names: 'ANY 1 (node_b, node_c)'
  pg_hba:
    - host all all 0.0.0.0/0 md5
    - host replication repl 0.0.0.0/0 md5
  authentication:
    replication:
      username: repl
      password: "***"
    superuser:
      username: postgres
      password: "***"
```

虚拟IP/负载均衡：

- 主写 VIP：`keepalived` 绑定主节点；
- 读负载均衡：`pgpool-II`/`haproxy` 转发至只读副本；
- 应用侧强制读写分离与重试策略。

## 5. 故障演练

- 失效与恢复流程、RTO/RPO 评估

### 5.1 故障切换SOP（Patroni）

1) 人为下线主库：`patroni_ctl pause`（演练时）或停止服务；
2) 观察Leader 选举日志与复制延迟，确认新主；
3) 业务侧：写连接指向主写 VIP，读连接检查连接池刷新；
4) 旧主恢复为副本：清理WAL 冲突、重新 `pg_basebackup` 或 `recovery` 追日志。

### 5.2 只读副本延迟监控

```sql
SELECT application_name, state, sync_state,
       pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS byte_lag
FROM pg_stat_replication;
```

## 6. 后续整合任务

- 统一术语，提供参考拓扑与脚本清单
  - 三节点（1主2从）强一致与仲裁示意图
  - Patroni + etcd + VIP + pgbouncer/pgpool-II 最小落地脚本
