# 07.06-数据科学实践

> 面向 PostgreSQL 的数据科学流水线：特征抽取、样本构建、离线训练、在线推理与回收学习。

## 概述

PG 既可作为特征与标签的存取层，也可承担少量在线推理与近库计算；与外部计算（Spark/Ray）协同完成训练与评估。

## 关键概念

- 特征一致性：训练/推理一致的变换与时态
- 样本构建：窗口聚合、标签对齐与时间旅行
- 推理路径：同步（UDF/HTTP）与异步（消息/回写）
- 回收学习：推理结果与反馈写回，闭环

## 实践要点

```sql
-- 示例：构建7日点击率特征
WITH e AS (
  SELECT user_id, date_trunc('day', ts) AS d, count(*) AS cnt
  FROM events WHERE action = 'click' AND ts >= now() - interval '30 day'
  GROUP BY 1,2
), roll AS (
  SELECT user_id, d,
         sum(cnt) OVER (PARTITION BY user_id ORDER BY d ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS ctr7
  FROM e
)
SELECT * FROM roll;

-- 在线推理（plpythonu 简化）
CREATE EXTENSION IF NOT EXISTS plpythonu;
CREATE OR REPLACE FUNCTION score_ctr(x double precision)
RETURNS double precision AS $$
  return 1.0/(1.0+pow(2.71828, -0.1*(x-10)))
$$ LANGUAGE plpythonu IMMUTABLE;
```

SOP：

- 特征层：规范化函数库、时间对齐策略、数据质量校验
- 训练层：特征快照导出、版本管理、评估指标
- 推理层：近库服务/只读副本、熔断与超时
- 回收：写回推理结果/反馈，供下一轮训练

## 参考

- `03-高级特性/03.04-机器学习集成.md`
- `runbook/02-监控与诊断-落地指南.md`
