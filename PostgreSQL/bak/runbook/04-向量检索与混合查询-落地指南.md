# 向量检索与混合查询-落地指南（Runbook）

对齐：`03-高级特性/03.05-向量数据库支持.md`

## 1. 目标

- 建立“向量召回 + 结构化过滤 + 全文权重”的混合检索流水线，支持在线查询与离线重排。

## 2. 前置

- 安装 `pgvector`；准备 `docs(id, text, embedding vector(n))`；
- 选择索引（HNSW/IVFFlat/PQ）并 ANALYZE。

## 3. 步骤

1) 创建索引：

    ```sql
    CREATE INDEX IF NOT EXISTS docs_hnsw ON docs USING hnsw (embedding vector_l2_ops) WITH (m=32, ef_construction=200);
    ```

2) 在线查询（结构化 + 向量）：

    ```sql
    SELECT id, text
    FROM docs
    WHERE created_at >= now() - interval '7 day'
    ORDER BY embedding <-> $1
    LIMIT 50;
    ```

3) 全文 + 向量融合：

    ```sql
    WITH s AS (
    SELECT id, ts_rank(to_tsvector('simple', text), plainto_tsquery('simple',$2)) AS tr
    FROM docs
    WHERE to_tsvector('simple', text) @@ plainto_tsquery('simple',$2)
    ORDER BY tr DESC LIMIT 500
    ), v AS (
    SELECT id, embedding <-> $1 AS dist FROM docs WHERE id IN (SELECT id FROM s) ORDER BY dist ASC LIMIT 100
    )
    SELECT d.id, d.text, 0.6*(1.0/v.dist) + 0.4*s.tr AS score
    FROM v d JOIN s ON d.id = s.id
    ORDER BY score DESC LIMIT 50;
    ```

## 4. 运行参数

- `SET ivfflat.probes = 10;` 查询高召回时调大；
- 控制 `work_mem`，避免ANN与排序内存爆；
- 监控延迟TP95/TP99 与召回指标。

## 5. 验证

- 与暴力真值对比 Recall@k；性能基线记录与回归检查。
