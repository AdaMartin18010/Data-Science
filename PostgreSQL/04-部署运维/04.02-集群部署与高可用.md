# é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨

> **æ–‡æ¡£ç‰ˆæœ¬**: v2.0
> **æœ€åæ›´æ–°**: 2025-11-12
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²æ›´æ–°

---

## ğŸ“‹ ç›®å½•

- [é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨](#é›†ç¾¤éƒ¨ç½²ä¸é«˜å¯ç”¨)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. åˆå¹¶æ¥æºä¸æ˜ å°„](#2-åˆå¹¶æ¥æºä¸æ˜ å°„)
  - [3. å¤åˆ¶æ¶æ„](#3-å¤åˆ¶æ¶æ„)
    - [3.1 ç‰©ç†å¤åˆ¶æœ€å°ç¤ºä¾‹](#31-ç‰©ç†å¤åˆ¶æœ€å°ç¤ºä¾‹)
    - [3.2 åŒæ­¥ç­–ç•¥ä¸ä»²è£](#32-åŒæ­¥ç­–ç•¥ä¸ä»²è£)
  - [4. é«˜å¯ç”¨ç»„ä»¶](#4-é«˜å¯ç”¨ç»„ä»¶)
    - [4.1 Patroni åŸºæœ¬é…ç½®ç¤ºä¾‹](#41-patroni-åŸºæœ¬é…ç½®ç¤ºä¾‹)
  - [5. æ•…éšœæ¼”ç»ƒ](#5-æ•…éšœæ¼”ç»ƒ)
    - [5.1 æ•…éšœåˆ‡æ¢SOPï¼ˆPatroniï¼‰](#51-æ•…éšœåˆ‡æ¢soppatroni)
    - [5.2 åªè¯»å‰¯æœ¬å»¶è¿Ÿç›‘æ§](#52-åªè¯»å‰¯æœ¬å»¶è¿Ÿç›‘æ§)
  - [6. åç»­æ•´åˆä»»åŠ¡](#6-åç»­æ•´åˆä»»åŠ¡)

---

## 1. æ¦‚è¿°

- ä¸»ä»ã€åŒæ­¥/å¼‚æ­¥å¤åˆ¶ã€æ•…éšœè½¬ç§»ã€è¯»å†™åˆ†ç¦»

## 2. åˆå¹¶æ¥æºä¸æ˜ å°„

- 1.1.5-åˆ†å¸ƒå¼ä¸é«˜å¯ç”¨.md
- 1.1.9-åˆ†å¸ƒå¼PostgreSQLæ¶æ„è®¾è®¡.md

## 3. å¤åˆ¶æ¶æ„

- ç‰©ç†å¤åˆ¶/é€»è¾‘å¤åˆ¶ã€åŒæ­¥ç­–ç•¥ã€ä»²è£ä¸æ¼‚ç§»

### 3.1 ç‰©ç†å¤åˆ¶æœ€å°ç¤ºä¾‹

```sql
-- ä¸»åº“åˆ›å»ºå¤åˆ¶æ§½ï¼ˆå¯é€‰ï¼Œä½†æ¨èé¿å…WALå›æ”¶è¿‡å¿«ï¼‰
SELECT * FROM pg_create_physical_replication_slot('replica1');
```

`postgresql.conf`ï¼ˆä¸»åº“ï¼‰ï¼š

```text
wal_level = replica
max_wal_senders = 10
max_replication_slots = 10
wal_keep_size = '1GB'
```

`pg_hba.conf`ï¼š

```text
host replication repl 10.0.0.0/24 md5
```

ä»åº“åˆå§‹åŒ–ï¼š

```bash
pg_basebackup -h primary -U repl -D $PGDATA -X stream -R -C -S replica1
```

### 3.2 åŒæ­¥ç­–ç•¥ä¸ä»²è£

- `synchronous_commit`ï¼šlocal | remote_write | remote_apply | on | off
- `synchronous_standby_names`ï¼šæŒ‡å®šå€™é€‰ä¸æ³•å®šäººæ•°ï¼ˆQuorumï¼‰ï¼š

  ```text
  synchronous_standby_names = 'ANY 1 (node_b, node_c)'
  ```

- ä¸ä¸šåŠ¡SLAçš„RPO/RTOæƒè¡¡ï¼šå¼ºåŒæ­¥æå‡ä¸€è‡´æ€§ä½†æ‹‰é«˜å†™å»¶è¿Ÿã€‚

## 4. é«˜å¯ç”¨ç»„ä»¶

- Patroniã€pgpool-IIã€pgbouncerã€keepalived

### 4.1 Patroni åŸºæœ¬é…ç½®ç¤ºä¾‹

```yaml
scope: pg
namespace: /service/pg
name: node_a

restapi:
  listen: 0.0.0.0:8008
  connect_address: node_a:8008

etcd:
  hosts: [etcd1:2379, etcd2:2379, etcd3:2379]

postgresql:
  listen: 0.0.0.0:5432
  connect_address: node_a:5432
  data_dir: /var/lib/postgresql/data
  bin_dir: /usr/lib/postgresql/16/bin
  parameters:
    wal_level: replica
    max_wal_senders: 10
    max_replication_slots: 10
    synchronous_commit: 'on'
    synchronous_standby_names: 'ANY 1 (node_b, node_c)'
  pg_hba:
    - host all all 0.0.0.0/0 md5
    - host replication repl 0.0.0.0/0 md5
  authentication:
    replication:
      username: repl
      password: "***"
    superuser:
      username: postgres
      password: "***"
```

è™šæ‹ŸIP/è´Ÿè½½å‡è¡¡ï¼š

- ä¸»å†™ VIPï¼š`keepalived` ç»‘å®šä¸»èŠ‚ç‚¹ï¼›
- è¯»è´Ÿè½½å‡è¡¡ï¼š`pgpool-II`/`haproxy` è½¬å‘è‡³åªè¯»å‰¯æœ¬ï¼›
- åº”ç”¨ä¾§å¼ºåˆ¶è¯»å†™åˆ†ç¦»ä¸é‡è¯•ç­–ç•¥ã€‚

## 5. æ•…éšœæ¼”ç»ƒ

- å¤±æ•ˆä¸æ¢å¤æµç¨‹ã€RTO/RPO è¯„ä¼°

### 5.1 æ•…éšœåˆ‡æ¢SOPï¼ˆPatroniï¼‰

1) äººä¸ºä¸‹çº¿ä¸»åº“ï¼š`patroni_ctl pause`ï¼ˆæ¼”ç»ƒæ—¶ï¼‰æˆ–åœæ­¢æœåŠ¡ï¼›
2) è§‚å¯ŸLeader é€‰ä¸¾æ—¥å¿—ä¸å¤åˆ¶å»¶è¿Ÿï¼Œç¡®è®¤æ–°ä¸»ï¼›
3) ä¸šåŠ¡ä¾§ï¼šå†™è¿æ¥æŒ‡å‘ä¸»å†™ VIPï¼Œè¯»è¿æ¥æ£€æŸ¥è¿æ¥æ± åˆ·æ–°ï¼›
4) æ—§ä¸»æ¢å¤ä¸ºå‰¯æœ¬ï¼šæ¸…ç†WAL å†²çªã€é‡æ–° `pg_basebackup` æˆ– `recovery` è¿½æ—¥å¿—ã€‚

### 5.2 åªè¯»å‰¯æœ¬å»¶è¿Ÿç›‘æ§

```sql
SELECT application_name, state, sync_state,
       pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS byte_lag
FROM pg_stat_replication;
```

## 6. åç»­æ•´åˆä»»åŠ¡

- ç»Ÿä¸€æœ¯è¯­ï¼Œæä¾›å‚è€ƒæ‹“æ‰‘ä¸è„šæœ¬æ¸…å•
  - ä¸‰èŠ‚ç‚¹ï¼ˆ1ä¸»2ä»ï¼‰å¼ºä¸€è‡´ä¸ä»²è£ç¤ºæ„å›¾
  - Patroni + etcd + VIP + pgbouncer/pgpool-II æœ€å°è½åœ°è„šæœ¬
