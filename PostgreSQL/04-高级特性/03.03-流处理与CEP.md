# æµå¤„ç†ä¸ŽCEP

> **æ–‡æ¡£ç‰ˆæœ¬**: v2.0
> **æœ€åŽæ›´æ–°**: 2025-11-12
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 17+ | PostgreSQL 18 â­
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²æ›´æ–°
> ðŸ“– **æ–‡æ¡£è¯´æ˜Ž**
>
> æœ¬æ–‡æ¡£æä¾›æµå¤„ç†ä¸ŽCEPçš„åŸºç¡€å®žçŽ°æ–¹æ³•ã€‚å¦‚éœ€è¯¦ç»†å†…å®¹ï¼Œè¯·å‚è€ƒï¼š
>
> - ðŸš€ [æµå¤„ç†è½åœ°æŒ‡å—](../runbook/03-é›†ç¾¤ä¸Žé«˜å¯ç”¨-æ¼”ç»ƒSOP.md) - ç”Ÿäº§éƒ¨ç½²æŒ‡å—
> - ðŸ“‹ [AI æ—¶ä»£ä¸“é¢˜](../ai_view.md) â­â­â­ (v3.0, 2025-11-11)

---

## 1. æ¦‚è¿°

PostgreSQLå¯ä»¥é€šè¿‡å¤šç§æ–¹å¼å®žçŽ°æµå¼æ•°æ®å¤„ç†å’Œå¤æ‚äº‹ä»¶å¤„ç†ï¼ˆCEPï¼‰ï¼š

**ç›®æ ‡**: ä»¥ PostgreSQL ç”Ÿæ€å®žçŽ°åŸºç¡€æµå¼åˆ†æžä¸Žç®€åŒ–CEPæ¨¡å¼åŒ¹é…ï¼ˆä¸Žå¤–éƒ¨é˜Ÿåˆ—/å¼•æ“ŽååŒï¼‰

**é€‚ç”¨åœºæ™¯**:

- ðŸ“Š æ—¥å¿—å®žæ—¶ç»Ÿè®¡
- ðŸš¨ å‘Šè­¦æ£€æµ‹
- ðŸ“¦ è®¢å•çŠ¶æ€æµ
- ðŸ”Œ IoT äº‹ä»¶æ±‡èš
- ðŸ“ˆ å®žæ—¶æŒ‡æ ‡è®¡ç®—

---

## 2. æ—¶é—´ä¸Žçª—å£æ¨¡åž‹

- æ—¶é—´è¯­ä¹‰ï¼šäº‹ä»¶æ—¶é—´ï¼ˆevent timeï¼‰ä¸Žå¤„ç†æ—¶é—´ï¼ˆprocessing timeï¼‰ï¼›
- æ°´å°ï¼ˆwatermarkï¼‰ï¼šè¿‘ä¼¼ç•Œå®šè¿Ÿåˆ°æ•°æ®çš„é˜ˆå€¼ï¼›
- çª—å£ï¼šæ»šåŠ¨/æ»‘åŠ¨/ä¼šè¯çª—å£ä¸Žè¿Ÿåˆ°å¤„ç†ç­–ç•¥ï¼ˆè¡¥å‘/ä¸¢å¼ƒ/æ›´æ­£ï¼‰ã€‚

```sql
-- æ»šåŠ¨çª—å£ï¼ˆæŒ‰åˆ†é’Ÿèšåˆï¼‰ç¤ºæ„
SELECT date_trunc('minute', ts) AS win,
       count(*) AS cnt
FROM events
WHERE ts >= now() - interval '10 minutes'
GROUP BY 1
ORDER BY 1;
```

## 3. PostgreSQL å®žçŽ°è·¯å¾„

- å¢žé‡ç‰©åŒ–ï¼šåŸºäºŽç‰©åŒ–è§†å›¾ + å®šæ—¶åˆ·æ–°/è§¦å‘å™¨ï¼Œç»“åˆ `1.1.47` å¢žé‡è§„åˆ™ï¼›
- é€šçŸ¥é€šé“ï¼š`LISTEN/NOTIFY` é©±åŠ¨åº”ç”¨å±‚å¢žé‡å¤„ç†ï¼›
- å¤–éƒ¨é˜Ÿåˆ—/FDWï¼šKafka/Redpanda + FDW å¯¼å…¥ï¼›
- æµå¼è§†å›¾ï¼šåŸºäºŽæ—¶é—´åˆ†åŒº + ç´¢å¼•æ‰«æå®žçŽ°è¿‘å®žæ—¶æ»‘åŠ¨çª—å£ã€‚

```sql
-- è¿‘å®žæ—¶æ»‘åŠ¨çª—å£èšåˆï¼ˆæŒ‰5åˆ†é’Ÿï¼‰
WITH w AS (
  SELECT date_trunc('minute', ts) AS m, payload
  FROM events
  WHERE ts >= now() - interval '30 minutes'
)
SELECT date_trunc('minute', m) - (EXTRACT(MINUTE FROM m)::int % 5) * interval '1 minute' AS win,
       count(*)
FROM w
GROUP BY 1
ORDER BY 1;
```

## 4. ç®€åŒ–CEPæ¨¡å¼ï¼ˆç¤ºæ„ï¼‰

- æ¨¡å¼ï¼šA äº‹ä»¶åŽ T å†…å‡ºçŽ° Bï¼ˆåŒ keyï¼‰è§¦å‘å‘Šè­¦ï¼›

```sql
-- A->B æ¨¡å¼ï¼šåŒç”¨æˆ· 1 åˆ†é’Ÿå†…
WITH a AS (
  SELECT user_id, ts FROM events WHERE type = 'A'
), b AS (
  SELECT user_id, ts FROM events WHERE type = 'B'
)
SELECT a.user_id, a.ts AS a_ts, b.ts AS b_ts
FROM a JOIN b USING (user_id)
WHERE b.ts >= a.ts AND b.ts < a.ts + interval '1 minute';
```

- æ›´å¤šå¤æ‚åºåˆ—å¯å€Ÿé€’å½’CTE/çª—å£å‡½æ•°è¡¨è¾¾ï¼Œæˆ–å°†æ¨¡å¼å¼•æ“Žï¼ˆFlink/Esperï¼‰ä¸ŽPGè”åŠ¨ã€‚

## 5. æœ€ä½³å®žè·µ

- åˆ†åŒºä¸Žç´¢å¼•ï¼šæ—¶é—´åˆ†åŒº + `(key, ts)` ç´¢å¼•ï¼›
- è¿Ÿåˆ°ç­–ç•¥ï¼šä¿ç•™ä¸€æ®µå®½æ¾çª—å£ï¼Œå‘¨æœŸå›žè¡¥å†å‘å¸ƒï¼ˆå¹‚ç­‰å†™ï¼‰ï¼›
- å¯è§‚æµ‹ï¼šå»¶è¿Ÿã€åžåã€ä¸¢å¼ƒ/è¡¥å‘æ¯”çŽ‡ã€åˆ·æ–°è€—æ—¶ï¼›
- ä¸€è‡´æ€§ï¼šExactly-Once é€šè¿‡å¹‚ç­‰å†™ + åŽ»é‡é”®å®žçŽ°ã€‚

## 6. å®žæˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1: å®žæ—¶è®¢å•çŠ¶æ€ç›‘æŽ§

```sql
-- âœ… [å¯è¿è¡Œ] å®žæ—¶è®¢å•çŠ¶æ€æµå¤„ç†
CREATE TABLE orders (
    order_id UUID PRIMARY KEY,
    user_id UUID,
    status VARCHAR(50),
    amount DECIMAL(10,2),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç‰©åŒ–è§†å›¾ç”¨äºŽå®žæ—¶ç»Ÿè®¡
CREATE MATERIALIZED VIEW order_stats_5min AS
SELECT
    date_trunc('minute', created_at) -
    (EXTRACT(MINUTE FROM created_at)::int % 5) * interval '1 minute' AS time_window,
    status,
    COUNT(*) AS order_count,
    SUM(amount) AS total_amount
FROM orders
WHERE created_at >= now() - interval '1 hour'
GROUP BY 1, 2;

CREATE UNIQUE INDEX ON order_stats_5min (time_window, status);

-- å®šæ—¶åˆ·æ–°ï¼ˆé€šè¿‡pg_cronæˆ–å¤–éƒ¨è°ƒåº¦ï¼‰
REFRESH MATERIALIZED VIEW CONCURRENTLY order_stats_5min;
```

### æ¡ˆä¾‹2: IoTè®¾å¤‡å¼‚å¸¸æ£€æµ‹

```sql
-- âœ… [å¯è¿è¡Œ] IoTè®¾å¤‡å¼‚å¸¸æ£€æµ‹CEP
CREATE TABLE device_events (
    device_id VARCHAR(100),
    event_type VARCHAR(50),
    value FLOAT,
    event_time TIMESTAMPTZ DEFAULT NOW()
);

-- æ£€æµ‹æ¨¡å¼ï¼šæ¸©åº¦å¼‚å¸¸åŽ5åˆ†é’Ÿå†…å‡ºçŽ°å‘Šè­¦
WITH temp_anomaly AS (
    SELECT device_id, event_time AS anomaly_time
    FROM device_events
    WHERE event_type = 'temperature' AND value > 80
),
alert_events AS (
    SELECT device_id, event_time AS alert_time
    FROM device_events
    WHERE event_type = 'alert'
)
SELECT
    t.device_id,
    t.anomaly_time,
    a.alert_time,
    a.alert_time - t.anomaly_time AS time_to_alert
FROM temp_anomaly t
JOIN alert_events a USING (device_id)
WHERE a.alert_time >= t.anomaly_time
  AND a.alert_time < t.anomaly_time + interval '5 minutes';
```

### æ¡ˆä¾‹3: ç”¨æˆ·è¡Œä¸ºåºåˆ—åˆ†æž

```sql
-- âœ… [å¯è¿è¡Œ] ç”¨æˆ·è¡Œä¸ºåºåˆ—æ¨¡å¼åŒ¹é…
CREATE TABLE user_actions (
    user_id UUID,
    action_type VARCHAR(50),
    action_time TIMESTAMPTZ DEFAULT NOW()
);

-- æ£€æµ‹æ¨¡å¼ï¼šç”¨æˆ·ç™»å½•åŽ1å°æ—¶å†…å®Œæˆè´­ä¹°
WITH login_events AS (
    SELECT user_id, action_time AS login_time
    FROM user_actions
    WHERE action_type = 'login'
),
purchase_events AS (
    SELECT user_id, action_time AS purchase_time
    FROM user_actions
    WHERE action_type = 'purchase'
)
SELECT
    l.user_id,
    l.login_time,
    p.purchase_time,
    p.purchase_time - l.login_time AS conversion_time
FROM login_events l
JOIN purchase_events p USING (user_id)
WHERE p.purchase_time >= l.login_time
  AND p.purchase_time < l.login_time + interval '1 hour';
```

---

## 7. æ·±å…¥é˜…è¯»

### ç›¸å…³æ–‡æ¡£

#### ç†è®ºåŸºç¡€

- â­â­ [å½¢å¼åŒ–éªŒè¯æ–¹æ³•](../../10-ç†è®ºåŸºç¡€/10.01-å½¢å¼åŒ–éªŒè¯æ–¹æ³•.md) - æµå¤„ç†å½¢å¼åŒ–ç†è®º
- â­ [å­¦æœ¯ç ”ç©¶å‰æ²¿](../../10-ç†è®ºåŸºç¡€/10.02-å­¦æœ¯ç ”ç©¶å‰æ²¿.md) - æµå¤„ç†ç ”ç©¶

#### æŸ¥è¯¢ä¸Žä¼˜åŒ–

- â­â­ [æ‰§è¡Œè®¡åˆ’ä¸Žæ€§èƒ½è°ƒä¼˜](../../03-æŸ¥è¯¢ä¸Žä¼˜åŒ–/02.04-æ‰§è¡Œè®¡åˆ’ä¸Žæ€§èƒ½è°ƒä¼˜.md) - å¢žé‡æ›´æ–°ç­–ç•¥
- â­ [å¹¶è¡ŒæŸ¥è¯¢å¤„ç†](../../03-æŸ¥è¯¢ä¸Žä¼˜åŒ–/02.05-å¹¶è¡ŒæŸ¥è¯¢å¤„ç†.md) - å¹¶è¡Œæµå¤„ç†

#### æ•°æ®æ¨¡åž‹è®¾è®¡

- â­â­ [ETLæµç¨‹å®Œæ•´æŒ‡å—](../../09-åº”ç”¨è®¾è®¡/æ•°æ®æ¨¡åž‹è®¾è®¡/09.04-ETLæµç¨‹å®Œæ•´æŒ‡å—.md) - æµå¼ETLå¤„ç†

#### è¿ç»´å®žè·µ

- â­â­ [ç›‘æŽ§ä¸Žè¯Šæ–­](../../06-è¿ç»´å®žè·µ/ç›‘æŽ§ä¸Žè¯Šæ–­/06.01-ç›‘æŽ§ä¸Žè¯Šæ–­.md) - æµå¤„ç†ç›‘æŽ§

#### å‰æ²¿æŠ€æœ¯

- â­â­ [AI æ—¶ä»£ä¸“é¢˜](../../ai_view.md) - å¤šæ¨¡ä¸€ä½“åŒ–åœºæ™¯

### å¤–éƒ¨èµ„æº

- [PostgreSQL LISTEN/NOTIFY](https://www.postgresql.org/docs/current/sql-notify.html)
- [TimescaleDB Continuous Aggregates](https://docs.timescale.com/timescaledb/latest/how-to-guides/continuous-aggregates/)
- [Apache Flink CEP](https://nightlies.apache.org/flink/flink-docs-release-1.17/docs/libs/cep/)

---

## 8. å‚è€ƒæ–‡çŒ®

1. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Documentation. <https://www.postgresql.org/docs/18/>
2. PostgreSQLå®˜æ–¹æ–‡æ¡£ - [LISTEN/NOTIFY](https://www.postgresql.org/docs/current/sql-notify.html)
3. TimescaleDBæ–‡æ¡£ - [Continuous Aggregates](https://docs.timescale.com/timescaledb/latest/how-to-guides/continuous-aggregates/)
4. Apache Flink - [Complex Event Processing](https://nightlies.apache.org/flink/flink-docs-release-1.17/docs/libs/cep/)
5. PostgreSQLå®˜æ–¹æ–‡æ¡£ - [Materialized Views](https://www.postgresql.org/docs/current/sql-creatematerializedview.html)
6. PostgreSQL Global Development Group. (2024). PostgreSQL 17 Documentation. <https://www.postgresql.org/docs/17/>
