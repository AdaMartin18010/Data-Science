# 向量数据库支持

> **文档版本**: v2.0
> **最后更新**: 2025-11-12
> **版本覆盖**: PostgreSQL 17+ | PostgreSQL 18 ⭐
> **文档状态**: ✅ 基础概述文档
> 📖 **文档说明**
>
> 本文档提供向量数据库的**基础概述**。如需详细内容，请参考：
>
> - 🚀 [向量检索性能调优指南](../07-前沿技术/05.05-向量检索性能调优指南.md) - 完整的性能调优方法 (PG 18+ ⭐)
> - 🔍 [向量与混合搜索](../07-前沿技术/AI-时代/01-向量与混合搜索-pgvector与RRF.md) - pgvector 2.0 + RRF 融合 (PG 18+ ⭐)
> - 📋 [AI 时代专题](../ai_view.md) ⭐⭐⭐ (v3.0, 2025-11-11)
> - 🛠️ [向量检索落地指南](../runbook/04-向量检索与混合查询-落地指南.md) - 生产部署指南

---

## 1. 概述

PostgreSQL通过pgvector扩展提供向量数据库支持，包括：

- **向量类型**: `vector(n)` 类型存储高维向量
- **相似度检索**: L2、内积、余弦相似度
- **混合查询**: 向量+结构化/全文搜索融合

## 2. 类型与距离

### 2.1 向量类型

**密集向量（Dense Vector）**:

```sql
-- vector(n)类型：存储n维密集向量
CREATE TABLE docs (
    id BIGSERIAL PRIMARY KEY,
    text TEXT,
    embedding vector(768)  -- 768维向量
);

-- pgvector 2.0支持的最大维度：16000
```

**稀疏向量（Sparse Vector，pgvector 2.0新特性）**:

```sql
-- sparsevec(n)类型：存储n维稀疏向量
CREATE TABLE sparse_docs (
    id BIGSERIAL PRIMARY KEY,
    text TEXT,
    sparse_embedding sparsevec(768)  -- 768维稀疏向量
);

-- 稀疏向量格式：{index:value, index:value, ...}
-- 只存储非零元素，节省存储空间
INSERT INTO sparse_docs VALUES (
    1,
    'Document',
    '{1:0.5, 5:0.3, 10:0.8}'::sparsevec(768)
);
```

### 2.2 距离度量

PostgreSQL pgvector支持三种距离度量：

**1. L2距离（欧氏距离）**:

```sql
-- 使用 <-> 操作符
SELECT id, text, embedding <-> query_vector AS l2_distance
FROM docs
ORDER BY embedding <-> query_vector
LIMIT 10;

-- L2距离：sqrt(sum((a_i - b_i)^2))
-- 值越小越相似
```

**2. 内积（Inner Product）**:

```sql
-- 使用 <#> 操作符
SELECT id, text, embedding <#> query_vector AS inner_product
FROM docs
ORDER BY embedding <#> query_vector
LIMIT 10;

-- 内积：sum(a_i * b_i)
-- 值越大越相似（注意：需要归一化向量）
```

**3. 余弦相似度（Cosine Similarity）**:

```sql
-- 使用 <=> 操作符
SELECT id, text, embedding <=> query_vector AS cosine_distance
FROM docs
ORDER BY embedding <=> query_vector
LIMIT 10;

-- 余弦距离：1 - cosine_similarity
-- 值越小越相似（范围0-2）

-- 转换为相似度（0-1）
SELECT id, text, 1 - (embedding <=> query_vector) AS cosine_similarity
FROM docs
ORDER BY embedding <=> query_vector
LIMIT 10;
```

**距离度量选择指南**:

| 场景 | 推荐度量 | 原因 |
|------|---------|------|
| 归一化向量 | 余弦相似度 | 不受向量长度影响 |
| 未归一化向量 | L2距离 | 考虑向量长度 |
| 推荐系统 | 内积 | 考虑向量长度和方向 |
| 文本相似度 | 余弦相似度 | 标准做法 |

### 2.3 pgvector 2.0性能优化

**SIMD优化**:

pgvector 2.0使用SIMD（单指令多数据）指令优化向量计算，性能提升2-3倍。

```sql
-- pgvector 2.0自动使用SIMD优化
-- 无需额外配置，自动检测CPU支持
-- 支持的指令集：SSE、AVX、AVX2、AVX-512

-- 查看pgvector版本
SELECT * FROM pg_available_extensions WHERE name = 'vector';
```

**并行查询支持**:

PostgreSQL 18 + pgvector 2.0支持并行向量查询。

```sql
-- 启用并行查询
SET max_parallel_workers_per_gather = 4;

-- 并行向量查询
EXPLAIN (ANALYZE, BUFFERS)
SELECT id, text, embedding <-> query_vector AS distance
FROM docs
ORDER BY embedding <-> query_vector
LIMIT 100;
```

## 3. 索引与算法

### 3.1 HNSW索引（Hierarchical Navigable Small World）

HNSW是pgvector 2.0推荐的默认索引类型，提供高召回率和低延迟。

**特点**:

- 近似最近邻图检索算法
- 召回率高（接近100%）
- 查询速度快（O(log N)）
- 内存占用较大
- 适合高维向量（100+维度）

**参数调优**:

```sql
-- HNSW索引创建
CREATE INDEX ON docs USING hnsw (embedding vector_l2_ops)
WITH (
    m = 16,              -- 每个节点的最大连接数（默认16，范围4-64）
    ef_construction = 64 -- 构建时的候选集大小（默认64，范围4-1000）
);

-- pgvector 2.0改进：
-- - SIMD优化：性能提升2-3倍
-- - 更好的内存管理
-- - 支持并行构建（PostgreSQL 18）
```

**查询参数**:

```sql
-- 设置查询时的ef_search参数（影响召回率和延迟）
SET hnsw.ef_search = 100;  -- 默认40，越大召回率越高但延迟增加

-- 查询示例
SELECT id, text, embedding <-> query_vector AS distance
FROM docs
ORDER BY embedding <-> query_vector
LIMIT 10;
```

### 3.2 IVFFlat索引（Inverted File with Flat Compression）

IVFFlat适合大规模数据集和批量查询场景。

**特点**:

- 倒排索引 + 扁平量化
- 内存占用较小
- 适合批量查询
- 需要足够的ANALYZE统计信息
- 召回率略低于HNSW

**参数调优**:

```sql
-- IVFFlat索引创建
CREATE INDEX ON docs USING ivfflat (embedding vector_cosine_ops)
WITH (
    lists = 100  -- 分桶数量（默认100，建议：rows/1000）
);

-- 重要：创建索引前需要ANALYZE
ANALYZE docs;

-- 查询参数
SET ivfflat.probes = 10;  -- 查询时检查的桶数（默认1，范围1-lists）
-- probes越大，召回率越高但延迟增加
```

### 3.3 pgvector 2.0新特性：稀疏向量（sparsevec）⭐⭐⭐

pgvector 2.0引入了稀疏向量类型，用于存储和检索稀疏向量（大部分元素为0）。

**稀疏向量类型**:

```sql
-- 安装pgvector 2.0
CREATE EXTENSION IF NOT EXISTS vector;

-- 创建稀疏向量列
CREATE TABLE sparse_docs (
    id BIGSERIAL PRIMARY KEY,
    text TEXT,
    sparse_embedding sparsevec(768)  -- pgvector 2.0新类型
);

-- 稀疏向量操作
-- 插入稀疏向量（只存储非零元素）
INSERT INTO sparse_docs (text, sparse_embedding)
VALUES (
    'Document text',
    '{1:0.5, 5:0.3, 10:0.8}'::sparsevec(768)  -- 格式：{index:value, ...}
);

-- 稀疏向量相似度查询
SELECT id, text,
       sparse_embedding <=> query_sparse_vec AS distance
FROM sparse_docs
ORDER BY sparse_embedding <=> query_sparse_vec
LIMIT 10;
```

**稀疏向量优势**:

- **存储效率**: 只存储非零元素，节省存储空间
- **计算效率**: 只计算非零元素，提升查询速度
- **适用场景**:
  - TF-IDF向量
  - 词袋模型
  - 稀疏特征向量

**索引支持**:

```sql
-- 稀疏向量索引（pgvector 2.0）
CREATE INDEX ON sparse_docs USING hnsw (sparse_embedding sparsevec_l2_ops)
WITH (m = 16, ef_construction = 64);
```

### 3.4 索引选择指南

| 场景 | 推荐索引 | 原因 |
|------|---------|------|
| 高召回率要求 | HNSW | 召回率接近100% |
| 大规模数据（百万+） | IVFFlat | 内存占用小 |
| 批量查询 | IVFFlat | 批量查询性能好 |
| 低延迟要求 | HNSW | 查询速度快 |
| 稀疏向量 | HNSW (sparsevec) | pgvector 2.0支持 |
| 高维向量（1000+） | HNSW | 高维性能好 |

**pgvector 2.0性能改进**:

- SIMD优化：HNSW性能提升2-3倍
- 并行索引构建：PostgreSQL 18支持
- 更好的内存管理：减少内存碎片
- 稀疏向量支持：新增sparsevec类型

```sql
-- 安装与类型
CREATE EXTENSION IF NOT EXISTS vector;

-- 基础表
CREATE TABLE docs (
  id bigserial PRIMARY KEY,
  text text,
  embedding vector(768)
);

-- 索引：HNSW/IVFFlat/PQ
CREATE INDEX ON docs USING hnsw (embedding vector_l2_ops);
-- 或
CREATE INDEX ON docs USING ivfflat (embedding vector_cosine_ops) WITH (lists = 200);
-- 或
CREATE INDEX ON docs USING ivfflat (embedding vector_ip_ops) WITH (lists = 100);

-- 典型查询
WITH q AS (
  SELECT '[0.1,0.2,...]'::vector AS qv
)
SELECT id, text
FROM docs, q
ORDER BY embedding <-> q.qv
LIMIT 20;
```

## 4. 混合检索（结构化/全文/向量）

- 与结构化过滤：先用结构化谓词裁剪候选，再进行ANN；或以 ANN 返回候选后再做结构化过滤/重排。
- 与全文搜索：`to_tsvector` + GIN 与向量召回的交集/加权融合。

```sql
-- 结构化 + 向量
SELECT id, text
FROM docs
WHERE created_at >= now() - interval '7 day'
ORDER BY embedding <-> '[...]'::vector
LIMIT 50;

-- 全文 + 向量（粗召回 + 精重排）
WITH s AS (
  SELECT id, ts_rank(to_tsvector('simple', text), plainto_tsquery('simple','postgres')) AS tr
  FROM docs
  WHERE to_tsvector('simple', text) @@ plainto_tsquery('simple','postgres')
  ORDER BY tr DESC
  LIMIT 500
), v AS (
  SELECT id, embedding <-> '[...]'::vector AS dist
  FROM docs WHERE id IN (SELECT id FROM s)
  ORDER BY dist ASC LIMIT 100
)
SELECT * FROM v ORDER BY dist ASC;
```

## 5. 存储布局与冷热分层

- 行存 + 大向量：考虑 `TOAST` 与I/O；热字段与向量分表或列化（如外部对象存储/FDW）。
- 冷热分层：热集合保留高精度HNSW，冷集合采用IVFPQ压缩，统一在视图/UNION层聚合。

## 6. 参数与调优

- HNSW：`M`、`ef_construction`（建索引质量）、`ef_search`（查询召回/延迟权衡）。
- IVFFlat：`lists`（分桶数）与 `probes`（查询桶数）；分桶需 `ANALYZE` 充足统计。
- PQ：`m`（子空间数）、`nbits`（码本位数）。
- 维度与归一化：余弦相似度常需单位化；内积需向量中心化/归一化以稳定排序。

### 6.1 训练与索引构建流程

```sql
-- 1) 向量生成（外部/UDF），写入 docs(embedding)
-- 2) 统计信息
ANALYZE docs;

-- 3) 选择索引
CREATE INDEX IF NOT EXISTS docs_hnsw ON docs USING hnsw (embedding vector_l2_ops) WITH (m=32, ef_construction=200);
-- 或者
CREATE INDEX IF NOT EXISTS docs_ivf ON docs USING ivfflat (embedding vector_cosine_ops) WITH (lists=100);

-- 4) 运行时权衡
SET ivfflat.probes = 10;  -- 提升召回降低延迟；按查询动态调整
```

### 6.2 版本特性提示（PG15/16/17）

- 并行扫描与JIT 对 ANN 影响有限，更多落在算子与扩展层；
- PG17 起 pgvector 引入更快的 build/search 优化（根据扩展版本）；
- 注意 `shared_buffers` 与 `work_mem` 对 ANN 的缓存与内存占用约束。

## 7. 基准与正确性

- 召回/精度：与暴力真值（Brute-Force）对比；评估 Recall@k、MRR、延迟TP50/TP99。
- 可重复性：固定随机种子、记录版本与参数；离线批量重建评估。

## 8. 深入阅读

### 性能调优

- 📊 [向量检索性能调优指南](../07-前沿技术/05.05-向量检索性能调优指南.md) - HNSW vs IVFFlat对比、参数调优、性能基准
- 🔍 [向量与混合搜索](../07-前沿技术/AI-时代/01-向量与混合搜索-pgvector与RRF.md) - pgvector 2.0 + RRF 融合算法

### 实战应用

- 🚀 [RAG架构实战指南](../../07-前沿技术/05.04-RAG架构实战指南.md) - 完整的RAG系统实现
- 🛠️ [向量检索落地指南](../../runbook/04-向量检索与混合查询-落地指南.md) - 生产部署最佳实践
- 📋 [AI 时代专题](../../ai_view.md) - PostgreSQL在AI时代的全面演进
- 🐳 [可运行示例项目](../../examples/README.md) ⭐ - 8个完整的Docker Compose示例
  - [基础向量搜索示例](../../examples/01-basic-vector-search/README.md) - 快速入门
  - [混合搜索RRF示例](../../examples/02-hybrid-search-rrf/README.md) - RRF融合搜索
  - [RAG知识库示例](../../examples/03-rag-knowledge-base/README.md) - 完整RAG系统

### 相关主题

- [查询优化器原理](../03-查询与优化/02.01-查询优化器原理.md) - 查询优化基础
- [索引结构与优化](../03-查询与优化/02.02-索引结构与优化.md) - 索引设计原理
- [执行计划与性能调优](../03-查询与优化/02.04-执行计划与性能调优.md) - 性能分析

## 9. 参考文献

1. PostgreSQL Global Development Group. (2025). PostgreSQL 18 Documentation. <https://www.postgresql.org/docs/18/>
2. PostgreSQL Global Development Group. (2024). PostgreSQL 17 Documentation. <https://www.postgresql.org/docs/17/>
3. pgvector官方文档 - [pgvector GitHub](https://github.com/pgvector/pgvector)
4. PostgreSQL官方文档 - [索引类型](https://www.postgresql.org/docs/current/indexes-types.html)
