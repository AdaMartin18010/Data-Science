# PostgreSQL 18 æ€§èƒ½ç¼–ç¨‹æŠ€å·§

> **ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-15
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‘ ç›®å½•

- [PostgreSQL 18 æ€§èƒ½ç¼–ç¨‹æŠ€å·§](#postgresql-18-æ€§èƒ½ç¼–ç¨‹æŠ€å·§)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“Š æ€ç»´å¯¼å›¾](#-æ€ç»´å¯¼å›¾)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
  - [äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#äºŒçŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [2.1 æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§å¯¹æ¯”](#21-æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§å¯¹æ¯”)
    - [2.2 æ‰¹é‡æ“ä½œæŠ€å·§å¯¹æ¯”](#22-æ‰¹é‡æ“ä½œæŠ€å·§å¯¹æ¯”)
  - [ä¸‰ã€æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§](#ä¸‰æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§)
    - [3.1 ç´¢å¼•ä½¿ç”¨æŠ€å·§](#31-ç´¢å¼•ä½¿ç”¨æŠ€å·§)
      - [3.1.1 ç´¢å¼•çš„é‡è¦æ€§](#311-ç´¢å¼•çš„é‡è¦æ€§)
      - [3.1.2 ç´¢å¼•é€‰æ‹©åŸåˆ™](#312-ç´¢å¼•é€‰æ‹©åŸåˆ™)
    - [3.2 JOINä¼˜åŒ–æŠ€å·§](#32-joinä¼˜åŒ–æŠ€å·§)
    - [3.3 å­æŸ¥è¯¢ä¼˜åŒ–](#33-å­æŸ¥è¯¢ä¼˜åŒ–)
    - [3.4 èšåˆæŸ¥è¯¢ä¼˜åŒ–](#34-èšåˆæŸ¥è¯¢ä¼˜åŒ–)
  - [å››ã€æ‰¹é‡æ“ä½œä¼˜åŒ–](#å››æ‰¹é‡æ“ä½œä¼˜åŒ–)
    - [4.1 æ‰¹é‡æ’å…¥ä¼˜åŒ–](#41-æ‰¹é‡æ’å…¥ä¼˜åŒ–)
    - [4.2 æ‰¹é‡æ›´æ–°ä¼˜åŒ–](#42-æ‰¹é‡æ›´æ–°ä¼˜åŒ–)
    - [4.3 æ‰¹é‡åˆ é™¤ä¼˜åŒ–](#43-æ‰¹é‡åˆ é™¤ä¼˜åŒ–)
  - [äº”ã€è¿æ¥å’Œäº‹åŠ¡ä¼˜åŒ–](#äº”è¿æ¥å’Œäº‹åŠ¡ä¼˜åŒ–)
    - [5.1 è¿æ¥æ± ä¼˜åŒ–](#51-è¿æ¥æ± ä¼˜åŒ–)
    - [5.2 äº‹åŠ¡ä¼˜åŒ–](#52-äº‹åŠ¡ä¼˜åŒ–)
    - [5.3 é¢„å¤„ç†è¯­å¥](#53-é¢„å¤„ç†è¯­å¥)
  - [å…­ã€æ•°æ®ç±»å‹ä¼˜åŒ–](#å…­æ•°æ®ç±»å‹ä¼˜åŒ–)
    - [6.1 æ•°æ®ç±»å‹é€‰æ‹©](#61-æ•°æ®ç±»å‹é€‰æ‹©)
    - [6.2 JSON/JSONBä¼˜åŒ–](#62-jsonjsonbä¼˜åŒ–)
    - [6.3 æ•°ç»„ä¼˜åŒ–](#63-æ•°ç»„ä¼˜åŒ–)
  - [ä¸ƒã€PostgreSQL 18æ–°ç‰¹æ€§ä¼˜åŒ–](#ä¸ƒpostgresql-18æ–°ç‰¹æ€§ä¼˜åŒ–)
    - [7.1 è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–](#71-è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–)
    - [7.2 å¼‚æ­¥I/Oä¼˜åŒ–](#72-å¼‚æ­¥ioä¼˜åŒ–)
    - [7.3 MERGEä¼˜åŒ–](#73-mergeä¼˜åŒ–)
  - [å…«ã€ç¼“å­˜ç­–ç•¥](#å…«ç¼“å­˜ç­–ç•¥)
    - [8.1 åº”ç”¨å±‚ç¼“å­˜](#81-åº”ç”¨å±‚ç¼“å­˜)
    - [8.2 æŸ¥è¯¢ç»“æœç¼“å­˜](#82-æŸ¥è¯¢ç»“æœç¼“å­˜)
    - [8.3 ç‰©åŒ–è§†å›¾](#83-ç‰©åŒ–è§†å›¾)
  - [ä¹ã€æ€§èƒ½ç›‘æ§](#ä¹æ€§èƒ½ç›‘æ§)
    - [9.1 æ€§èƒ½æŒ‡æ ‡ç›‘æ§](#91-æ€§èƒ½æŒ‡æ ‡ç›‘æ§)
    - [9.2 æ…¢æŸ¥è¯¢åˆ†æ](#92-æ…¢æŸ¥è¯¢åˆ†æ)
    - [9.3 æ€§èƒ½æµ‹è¯•](#93-æ€§èƒ½æµ‹è¯•)
  - [åã€ç›¸å…³æ–‡æ¡£](#åç›¸å…³æ–‡æ¡£)

---

## ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ€§èƒ½ç¼–ç¨‹æŠ€å·§))
    æŸ¥è¯¢ä¼˜åŒ–
      ç´¢å¼•ä½¿ç”¨
      JOINä¼˜åŒ–
      å­æŸ¥è¯¢ä¼˜åŒ–
      èšåˆä¼˜åŒ–
    æ‰¹é‡æ“ä½œ
      æ‰¹é‡æ’å…¥
      æ‰¹é‡æ›´æ–°
      æ‰¹é‡åˆ é™¤
    è¿æ¥äº‹åŠ¡
      è¿æ¥æ± 
      äº‹åŠ¡ä¼˜åŒ–
      é¢„å¤„ç†è¯­å¥
    æ•°æ®ç±»å‹
      ç±»å‹é€‰æ‹©
      JSON/JSONB
      æ•°ç»„ä¼˜åŒ–
    PostgreSQL 18
      è™šæ‹Ÿç”Ÿæˆåˆ—
      å¼‚æ­¥I/O
      MERGEä¼˜åŒ–
    ç¼“å­˜ç­–ç•¥
      åº”ç”¨ç¼“å­˜
      æŸ¥è¯¢ç¼“å­˜
      ç‰©åŒ–è§†å›¾
    æ€§èƒ½ç›‘æ§
      æŒ‡æ ‡ç›‘æ§
      æ…¢æŸ¥è¯¢åˆ†æ
      æ€§èƒ½æµ‹è¯•
```

---

## ä¸€ã€æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç»PostgreSQLå¼€å‘ä¸­çš„æ€§èƒ½ç¼–ç¨‹æŠ€å·§ï¼Œå¸®åŠ©å¼€å‘è€…ç¼–å†™é«˜æ€§èƒ½çš„æ•°æ®åº“ä»£ç ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š

- **å®ç”¨æŠ€å·§**ï¼šåŸºäºå®é™…é¡¹ç›®ç»éªŒæ€»ç»“
- **æ€§èƒ½å¯¼å‘**ï¼šé‡ç‚¹å…³æ³¨æ€§èƒ½æå‡
- **PostgreSQL 18**ï¼šå……åˆ†åˆ©ç”¨æ–°ç‰¹æ€§
- **æœ€ä½³å®è·µ**ï¼šæä¾›å¯å¤ç”¨çš„ä¼˜åŒ–æ¨¡å¼

**PostgreSQL 18 æ–°ç‰¹æ€§æ”¯æŒ**ï¼š

- âœ… **è™šæ‹Ÿç”Ÿæˆåˆ—**ï¼šå‡å°‘é‡å¤è®¡ç®—ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
- âœ… **å¼‚æ­¥I/O**ï¼šæå‡æ‰¹é‡æ“ä½œå’ŒI/Oå¯†é›†å‹æ“ä½œæ€§èƒ½
- âœ… **MERGEä¼˜åŒ–**ï¼šæ›´é«˜æ•ˆçš„æ•°æ®åŒæ­¥æ“ä½œ
- âœ… **JSONBå¢å¼º**ï¼šæ›´å¿«çš„JSONBæ“ä½œæ€§èƒ½

---

## äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 2.1 æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§å¯¹æ¯”

| æŠ€å·§ | æ€§èƒ½æå‡ | é€‚ç”¨åœºæ™¯ | å¤æ‚åº¦ | æ¨èåº¦ |
|-----|---------|---------|--------|--------|
| **ç´¢å¼•ä¼˜åŒ–** | 10-100å€ | é¢‘ç¹æŸ¥è¯¢ | â­â­ | â­â­â­â­â­ |
| **JOINä¼˜åŒ–** | 2-10å€ | å¤šè¡¨å…³è” | â­â­â­ | â­â­â­â­â­ |
| **å­æŸ¥è¯¢ä¼˜åŒ–** | 2-5å€ | å¤æ‚æŸ¥è¯¢ | â­â­â­ | â­â­â­â­ |
| **èšåˆä¼˜åŒ–** | 2-5å€ | ç»Ÿè®¡æŸ¥è¯¢ | â­â­ | â­â­â­â­ |

### 2.2 æ‰¹é‡æ“ä½œæŠ€å·§å¯¹æ¯”

| æŠ€å·§ | æ€§èƒ½æå‡ | é€‚ç”¨åœºæ™¯ | å¤æ‚åº¦ | æ¨èåº¦ |
|-----|---------|---------|--------|--------|
| **COPY** | 10-50å€ | å¤§é‡æ•°æ®å¯¼å…¥ | â­â­ | â­â­â­â­â­ |
| **æ‰¹é‡INSERT** | 5-20å€ | æ‰¹é‡æ’å…¥ | â­â­ | â­â­â­â­â­ |
| **æ‰¹é‡UPDATE** | 3-10å€ | æ‰¹é‡æ›´æ–° | â­â­â­ | â­â­â­â­ |
| **äº‹åŠ¡æ‰¹é‡** | 2-5å€ | æ‰¹é‡æ“ä½œ | â­â­ | â­â­â­â­ |

---

## ä¸‰ã€æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§

### 3.1 ç´¢å¼•ä½¿ç”¨æŠ€å·§

#### 3.1.1 ç´¢å¼•çš„é‡è¦æ€§

**ä¸ºä»€ä¹ˆéœ€è¦ç´¢å¼•**ï¼š

ç´¢å¼•æ˜¯æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–çš„åŸºç¡€ï¼Œå®ƒæä¾›äº†ä»¥ä¸‹ä¼˜åŠ¿ï¼š

1. **å¿«é€ŸæŸ¥æ‰¾**ï¼šç´¢å¼•å¯ä»¥å°†æŸ¥æ‰¾æ—¶é—´ä»O(n)é™ä½åˆ°O(log n)
2. **æ’åºä¼˜åŒ–**ï¼šç´¢å¼•å¯ä»¥é¿å…æ’åºæ“ä½œï¼Œç›´æ¥è¿”å›æœ‰åºç»“æœ
3. **JOINä¼˜åŒ–**ï¼šç´¢å¼•å¯ä»¥æ˜¾è‘—æå‡JOINæ“ä½œçš„æ€§èƒ½
4. **å”¯ä¸€æ€§ä¿è¯**ï¼šå”¯ä¸€ç´¢å¼•å¯ä»¥ä¿è¯æ•°æ®å”¯ä¸€æ€§ï¼ŒåŒæ—¶æä¾›å¿«é€ŸæŸ¥æ‰¾

**ç´¢å¼•çš„æ€§èƒ½å½±å“**ï¼š

| æ“ä½œç±»å‹ | æ— ç´¢å¼• | æœ‰ç´¢å¼• | æ€§èƒ½æå‡ |
|---------|--------|--------|---------|
| **ç²¾ç¡®æŸ¥æ‰¾** | O(n) å…¨è¡¨æ‰«æ | O(log n) ç´¢å¼•æŸ¥æ‰¾ | 10-1000å€ |
| **èŒƒå›´æŸ¥æ‰¾** | O(n) å…¨è¡¨æ‰«æ | O(log n + m) ç´¢å¼•èŒƒå›´æ‰«æ | 10-100å€ |
| **æ’åº** | O(n log n) æ’åº | O(log n) ç´¢å¼•æ‰«æ | 10-100å€ |
| **JOIN** | O(n*m) åµŒå¥—å¾ªç¯ | O(n*log m) ç´¢å¼•æŸ¥æ‰¾ | 10-1000å€ |

**ç´¢å¼•çš„ä»£ä»·**ï¼š

| ä»£ä»· | è¯´æ˜ | å½±å“ |
|-----|------|------|
| **å­˜å‚¨ç©ºé—´** | ç´¢å¼•éœ€è¦é¢å¤–å­˜å‚¨ç©ºé—´ | é€šå¸¸ä¸ºè¡¨å¤§å°çš„10-30% |
| **å†™å…¥æ€§èƒ½** | æ’å…¥/æ›´æ–°/åˆ é™¤éœ€è¦ç»´æŠ¤ç´¢å¼• | å†™å…¥æ€§èƒ½é™ä½5-20% |
| **ç»´æŠ¤æˆæœ¬** | éœ€è¦å®šæœŸVACUUMå’ŒREINDEX | å¢åŠ ç»´æŠ¤å·¥ä½œé‡ |

#### 3.1.2 ç´¢å¼•é€‰æ‹©åŸåˆ™

**ç´¢å¼•é€‰æ‹©çš„æ ¸å¿ƒåŸåˆ™**ï¼š

1. **ä¸ºWHEREå­å¥ä¸­çš„åˆ—åˆ›å»ºç´¢å¼•**ï¼šWHEREå­å¥æ˜¯æœ€å¸¸ç”¨çš„è¿‡æ»¤æ¡ä»¶
2. **ä¸ºJOINæ¡ä»¶åˆ›å»ºç´¢å¼•**ï¼šJOINæ“ä½œæ˜¯æ€§èƒ½ç“¶é¢ˆï¼Œç´¢å¼•å¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½
3. **ä¸ºORDER BYåˆ›å»ºç´¢å¼•**ï¼šé¿å…æ’åºæ“ä½œï¼Œç›´æ¥è¿”å›æœ‰åºç»“æœ
4. **ä¸ºGROUP BYåˆ›å»ºç´¢å¼•**ï¼šæå‡åˆ†ç»„æ“ä½œçš„æ€§èƒ½
5. **è€ƒè™‘é€‰æ‹©æ€§**ï¼šé€‰æ‹©æ€§é«˜çš„åˆ—æ›´é€‚åˆåˆ›å»ºç´¢å¼•

**å®é™…åº”ç”¨ç¤ºä¾‹**ï¼š

```sql
-- åŸåˆ™1ï¼šä¸ºWHEREå­å¥ä¸­çš„åˆ—åˆ›å»ºç´¢å¼•
-- åœºæ™¯ï¼šæ ¹æ®é‚®ç®±æŸ¥æ‰¾ç”¨æˆ·ï¼ˆé«˜é¢‘æ“ä½œï¼‰
-- åˆ†æï¼šemailåˆ—é€‰æ‹©æ€§é«˜ï¼ŒæŸ¥è¯¢é¢‘ç¹ï¼Œé€‚åˆåˆ›å»ºç´¢å¼•

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_users_email ON users(email);

-- æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•
EXPLAIN ANALYZE
SELECT * FROM users WHERE email = 'user@example.com';
-- æ‰§è¡Œè®¡åˆ’ï¼šIndex Scan using idx_users_email

-- æ€§èƒ½å¯¹æ¯”ï¼š
-- æ— ç´¢å¼•ï¼šSeq Scanï¼Œæ‰«æ100ä¸‡è¡Œï¼Œè€—æ—¶500ms
-- æœ‰ç´¢å¼•ï¼šIndex Scanï¼Œæ‰«æ1è¡Œï¼Œè€—æ—¶0.5ms
-- æ€§èƒ½æå‡ï¼š1000å€

-- åŸåˆ™2ï¼šä¸ºJOINæ¡ä»¶åˆ›å»ºç´¢å¼•
-- åœºæ™¯ï¼šæŸ¥è¯¢è®¢å•åŠå…¶ç”¨æˆ·ä¿¡æ¯ï¼ˆé«˜é¢‘æ“ä½œï¼‰
-- åˆ†æï¼šorders.user_idæ˜¯å¤–é”®ï¼ŒJOINæ“ä½œé¢‘ç¹ï¼Œå¿…é¡»åˆ›å»ºç´¢å¼•

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_orders_user_id ON orders(user_id);

-- æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•
EXPLAIN ANALYZE
SELECT
    o.id as order_id,
    o.total_amount,
    u.username,
    u.email
FROM orders o
JOIN users u ON o.user_id = u.id
WHERE o.created_at >= '2024-01-01';
-- æ‰§è¡Œè®¡åˆ’ï¼šHash Joinï¼Œä½¿ç”¨ç´¢å¼•æŸ¥æ‰¾users

-- æ€§èƒ½å¯¹æ¯”ï¼š
-- æ— ç´¢å¼•ï¼šNested Loopï¼Œ100ä¸‡æ¬¡æŸ¥æ‰¾ï¼Œè€—æ—¶10ç§’
-- æœ‰ç´¢å¼•ï¼šHash Joinï¼Œ1000æ¬¡æŸ¥æ‰¾ï¼Œè€—æ—¶100ms
-- æ€§èƒ½æå‡ï¼š100å€

-- åŸåˆ™3ï¼šä¸ºORDER BYåˆ›å»ºç´¢å¼•
-- åœºæ™¯ï¼šæŸ¥è¯¢æœ€æ–°è®¢å•ï¼ˆé«˜é¢‘æ“ä½œï¼‰
-- åˆ†æï¼šcreated_atåˆ—ç”¨äºæ’åºï¼Œåˆ›å»ºç´¢å¼•å¯ä»¥é¿å…æ’åºæ“ä½œ

-- åˆ›å»ºç´¢å¼•ï¼ˆæ³¨æ„æ’åºæ–¹å‘ï¼‰
CREATE INDEX idx_orders_created_at_desc ON orders(created_at DESC);

-- æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•
EXPLAIN ANALYZE
SELECT * FROM orders
ORDER BY created_at DESC
LIMIT 10;
-- æ‰§è¡Œè®¡åˆ’ï¼šIndex Scan using idx_orders_created_at_desc

-- æ€§èƒ½å¯¹æ¯”ï¼š
-- æ— ç´¢å¼•ï¼šSeq Scan + Sortï¼Œæ‰«æ100ä¸‡è¡Œå¹¶æ’åºï¼Œè€—æ—¶2ç§’
-- æœ‰ç´¢å¼•ï¼šIndex Scanï¼Œç›´æ¥è¿”å›æœ‰åºç»“æœï¼Œè€—æ—¶5ms
-- æ€§èƒ½æå‡ï¼š400å€

-- åŸåˆ™4ï¼šä¸ºGROUP BYåˆ›å»ºç´¢å¼•
-- åœºæ™¯ï¼šæŒ‰ç”¨æˆ·ç»Ÿè®¡è®¢å•æ•°é‡ï¼ˆåˆ†ææŸ¥è¯¢ï¼‰
-- åˆ†æï¼šuser_idç”¨äºåˆ†ç»„ï¼Œåˆ›å»ºç´¢å¼•å¯ä»¥æå‡åˆ†ç»„æ€§èƒ½

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_orders_user_id ON orders(user_id);

-- æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•
EXPLAIN ANALYZE
SELECT
    user_id,
    COUNT(*) as order_count,
    SUM(total_amount) as total_amount
FROM orders
GROUP BY user_id;
-- æ‰§è¡Œè®¡åˆ’ï¼šGroupAggregateï¼Œä½¿ç”¨ç´¢å¼•æ‰«æ

-- æ€§èƒ½å¯¹æ¯”ï¼š
-- æ— ç´¢å¼•ï¼šHashAggregateï¼Œå…¨è¡¨æ‰«æï¼Œè€—æ—¶5ç§’
-- æœ‰ç´¢å¼•ï¼šGroupAggregateï¼Œç´¢å¼•æ‰«æï¼Œè€—æ—¶500ms
-- æ€§èƒ½æå‡ï¼š10å€
```

**ç´¢å¼•é€‰æ‹©æ€§åˆ†æ**ï¼š

```sql
-- åœºæ™¯ï¼šåˆ†æåˆ—çš„é€‰æ‹©æ€§ï¼Œå†³å®šæ˜¯å¦åˆ›å»ºç´¢å¼•
-- é€‰æ‹©æ€§ = ä¸åŒå€¼çš„æ•°é‡ / æ€»è¡Œæ•°
-- é€‰æ‹©æ€§ > 0.1 çš„åˆ—é€‚åˆåˆ›å»ºç´¢å¼•

-- åˆ†æemailåˆ—çš„é€‰æ‹©æ€§
SELECT
    COUNT(DISTINCT email) as distinct_values,
    COUNT(*) as total_rows,
    ROUND(COUNT(DISTINCT email)::NUMERIC / COUNT(*), 4) as selectivity
FROM users;
-- ç»“æœï¼šdistinct_values=100000, total_rows=100000, selectivity=1.0
-- ç»“è®ºï¼šé€‰æ‹©æ€§é«˜ï¼Œé€‚åˆåˆ›å»ºç´¢å¼•

-- åˆ†æstatusåˆ—çš„é€‰æ‹©æ€§
SELECT
    COUNT(DISTINCT status) as distinct_values,
    COUNT(*) as total_rows,
    ROUND(COUNT(DISTINCT status)::NUMERIC / COUNT(*), 4) as selectivity
FROM orders;
-- ç»“æœï¼šdistinct_values=5, total_rows=1000000, selectivity=0.000005
-- ç»“è®ºï¼šé€‰æ‹©æ€§ä½ï¼Œä¸é€‚åˆå•ç‹¬åˆ›å»ºç´¢å¼•ï¼Œä½†å¯ä»¥ä½œä¸ºå¤åˆç´¢å¼•çš„ä¸€éƒ¨åˆ†
```

**å¤åˆç´¢å¼•è®¾è®¡**ï¼š

```sql
-- åœºæ™¯ï¼šå¤šæ¡ä»¶æŸ¥è¯¢ï¼Œéœ€è¦å¤åˆç´¢å¼•
-- éœ€æ±‚ï¼šæŸ¥è¯¢æŸä¸ªç”¨æˆ·åœ¨æŸæ®µæ—¶é—´å†…çš„è®¢å•

-- åˆ›å»ºå¤åˆç´¢å¼•ï¼ˆæ³¨æ„åˆ—çš„é¡ºåºï¼‰
-- åŸåˆ™ï¼šé€‰æ‹©æ€§é«˜çš„åˆ—åœ¨å‰ï¼Œç»å¸¸ä¸€èµ·æŸ¥è¯¢çš„åˆ—ç»„åˆ
CREATE INDEX idx_orders_user_date
ON orders(user_id, created_at DESC);

-- æŸ¥è¯¢ä½¿ç”¨å¤åˆç´¢å¼•
EXPLAIN ANALYZE
SELECT * FROM orders
WHERE user_id = 12345
  AND created_at >= '2024-01-01'
ORDER BY created_at DESC;
-- æ‰§è¡Œè®¡åˆ’ï¼šIndex Scan using idx_orders_user_date

-- ç´¢å¼•åˆ—é¡ºåºçš„é‡è¦æ€§ï¼š
-- æ­£ç¡®é¡ºåºï¼šuser_id, created_atï¼ˆé€‰æ‹©æ€§é«˜çš„åœ¨å‰ï¼‰
-- é”™è¯¯é¡ºåºï¼šcreated_at, user_idï¼ˆä¼šå¯¼è‡´ç´¢å¼•æ•ˆç‡é™ä½ï¼‰

-- éªŒè¯ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan as index_scans,
    idx_tup_read as tuples_read,
    idx_tup_fetch as tuples_fetched
FROM pg_stat_user_indexes
WHERE tablename = 'orders'
ORDER BY idx_scan DESC;
```

-- 4. å¤åˆç´¢å¼•ï¼šæœ€å·¦å‰ç¼€åŸåˆ™
CREATE INDEX idx_orders_user_date ON orders(user_id, created_at);
-- å¯ä»¥ä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢
SELECT _FROM orders WHERE user_id = 1;
SELECT_ FROM orders WHERE user_id = 1 AND created_at > '2024-01-01';
-- ä¸èƒ½ä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢
SELECT * FROM orders WHERE created_at > '2024-01-01';

```

**éƒ¨åˆ†ç´¢å¼•**ï¼š

```sql
-- åªä¸ºæ´»è·ƒç”¨æˆ·åˆ›å»ºç´¢å¼•
CREATE INDEX idx_users_active_email ON users(email)
WHERE active = TRUE;

-- æŸ¥è¯¢æ´»è·ƒç”¨æˆ·æ—¶ä½¿ç”¨ç´¢å¼•
SELECT * FROM users WHERE active = TRUE AND email = 'user@example.com';
```

**è¦†ç›–ç´¢å¼•**ï¼š

```sql
-- åŒ…å«æ‰€æœ‰æŸ¥è¯¢åˆ—çš„ç´¢å¼•ï¼ˆPostgreSQLæ”¯æŒINCLUDEï¼‰
CREATE INDEX idx_orders_user_cover ON orders(user_id)
INCLUDE (total_amount, created_at);

-- æŸ¥è¯¢å¯ä»¥ç›´æ¥ä»ç´¢å¼•è·å–æ•°æ®ï¼Œæ— éœ€è®¿é—®è¡¨
SELECT user_id, total_amount, created_at
FROM orders
WHERE user_id = 1;
```

### 3.2 JOINä¼˜åŒ–æŠ€å·§

**JOINé¡ºåºä¼˜åŒ–**ï¼š

```sql
-- ä¼˜åŒ–å‰ï¼šå°è¡¨åœ¨å
SELECT * FROM large_table l
JOIN small_table s ON l.id = s.id;

-- ä¼˜åŒ–åï¼šå°è¡¨åœ¨å‰ï¼ˆPostgreSQLä¼šè‡ªåŠ¨ä¼˜åŒ–ï¼Œä½†æ˜ç¡®æŒ‡å®šæ›´å¥½ï¼‰
SELECT * FROM small_table s
JOIN large_table l ON s.id = l.id;
```

**ä½¿ç”¨EXISTSæ›¿ä»£JOIN**ï¼š

```sql
-- ä¼˜åŒ–å‰ï¼šJOINå¯èƒ½äº§ç”Ÿé‡å¤
SELECT DISTINCT u.*
FROM users u
JOIN orders o ON u.id = o.user_id
WHERE o.total_amount > 1000;

-- ä¼˜åŒ–åï¼šEXISTSæ›´é«˜æ•ˆ
SELECT u.*
FROM users u
WHERE EXISTS (
    SELECT 1 FROM orders o
    WHERE o.user_id = u.id AND o.total_amount > 1000
);
```

### 3.3 å­æŸ¥è¯¢ä¼˜åŒ–

**ä½¿ç”¨CTEä¼˜åŒ–å¤æ‚å­æŸ¥è¯¢**ï¼š

```sql
-- ä¼˜åŒ–å‰ï¼šåµŒå¥—å­æŸ¥è¯¢
SELECT *
FROM (
    SELECT user_id, SUM(total_amount) as total
    FROM orders
    GROUP BY user_id
) sub
WHERE total > 1000;

-- ä¼˜åŒ–åï¼šä½¿ç”¨CTE
WITH user_totals AS (
    SELECT user_id, SUM(total_amount) as total
    FROM orders
    GROUP BY user_id
)
SELECT * FROM user_totals WHERE total > 1000;
```

**ä½¿ç”¨LATERAL JOIN**ï¼š

```sql
-- ä¼˜åŒ–å‰ï¼šç›¸å…³å­æŸ¥è¯¢
SELECT u.*, (
    SELECT total_amount
    FROM orders
    WHERE user_id = u.id
    ORDER BY created_at DESC
    LIMIT 1
) as last_order_amount
FROM users u;

-- ä¼˜åŒ–åï¼šLATERAL JOIN
SELECT u.*, o.total_amount as last_order_amount
FROM users u
CROSS JOIN LATERAL (
    SELECT total_amount
    FROM orders
    WHERE user_id = u.id
    ORDER BY created_at DESC
    LIMIT 1
) o;
```

### 3.4 èšåˆæŸ¥è¯¢ä¼˜åŒ–

**ä½¿ç”¨çª—å£å‡½æ•°æ›¿ä»£è‡ªè¿æ¥**ï¼š

```sql
-- ä¼˜åŒ–å‰ï¼šè‡ªè¿æ¥
SELECT u1.*, u2.total_amount as prev_total
FROM (
    SELECT user_id, SUM(total_amount) as total_amount, created_at
    FROM orders
    GROUP BY user_id, created_at
) u1
LEFT JOIN (
    SELECT user_id, SUM(total_amount) as total_amount, created_at
    FROM orders
    GROUP BY user_id, created_at
) u2 ON u1.user_id = u2.user_id
    AND u2.created_at < u1.created_at;

-- ä¼˜åŒ–åï¼šçª—å£å‡½æ•°
SELECT user_id, created_at, total_amount,
    LAG(total_amount) OVER (PARTITION BY user_id ORDER BY created_at) as prev_total
FROM (
    SELECT user_id, created_at, SUM(total_amount) as total_amount
    FROM orders
    GROUP BY user_id, created_at
) sub;
```

---

## å››ã€æ‰¹é‡æ“ä½œä¼˜åŒ–

### 4.1 æ‰¹é‡æ’å…¥ä¼˜åŒ–

**ä½¿ç”¨COPYï¼ˆæœ€å¿«ï¼‰**ï¼š

```sql
-- COPYæ–¹å¼ï¼ˆæœ€å¿«ï¼‰
COPY users (username, email, created_at)
FROM '/path/to/users.csv' WITH (FORMAT CSV, HEADER);

-- æˆ–ä»ç¨‹åºä¸­ä½¿ç”¨COPY
-- Pythonç¤ºä¾‹
import psycopg2
from io import StringIO

data = StringIO()
for user in users:
    data.write(f"{user.username},{user.email},{user.created_at}\n")
data.seek(0)

cursor.copy_from(data, 'users', columns=('username', 'email', 'created_at'))
```

**æ‰¹é‡INSERT**ï¼š

```sql
-- æ‰¹é‡INSERTï¼ˆæ¨èï¼‰
INSERT INTO users (username, email, created_at)
VALUES
    ('user1', 'user1@example.com', NOW()),
    ('user2', 'user2@example.com', NOW()),
    ('user3', 'user3@example.com', NOW());

-- æˆ–ä½¿ç”¨SELECT
INSERT INTO users (username, email, created_at)
SELECT
    'user' || generate_series(1, 1000),
    'user' || generate_series(1, 1000) || '@example.com',
    NOW();
```

**PostgreSQL 18å¼‚æ­¥I/Oä¼˜åŒ–**ï¼š

```sql
-- PostgreSQL 18: å¼‚æ­¥I/Oæå‡æ‰¹é‡æ’å…¥æ€§èƒ½
-- é…ç½®å¼‚æ­¥I/O
SET max_io_concurrency = 10;

-- æ‰¹é‡æ’å…¥ä¼šè‡ªåŠ¨ä½¿ç”¨å¼‚æ­¥I/O
INSERT INTO large_table SELECT * FROM source_table;
```

### 4.2 æ‰¹é‡æ›´æ–°ä¼˜åŒ–

**ä½¿ç”¨UPDATE FROM**ï¼š

```sql
-- ä¼˜åŒ–å‰ï¼šé€æ¡æ›´æ–°
UPDATE users SET email = 'new@example.com' WHERE id = 1;
UPDATE users SET email = 'new@example.com' WHERE id = 2;

-- ä¼˜åŒ–åï¼šæ‰¹é‡æ›´æ–°
UPDATE users u
SET email = u2.new_email
FROM (VALUES
    (1, 'new1@example.com'),
    (2, 'new2@example.com')
) AS u2(id, new_email)
WHERE u.id = u2.id;
```

**ä½¿ç”¨MERGEï¼ˆPostgreSQL 18ä¼˜åŒ–ï¼‰**ï¼š

```sql
-- PostgreSQL 18: MERGEè¯­å¥æ€§èƒ½ä¼˜åŒ–
MERGE INTO users AS u
USING (VALUES
    (1, 'new1@example.com'),
    (2, 'new2@example.com')
) AS updates(id, new_email)
ON u.id = updates.id
WHEN MATCHED THEN
    UPDATE SET email = updates.new_email;
```

### 4.3 æ‰¹é‡åˆ é™¤ä¼˜åŒ–

**ä½¿ç”¨æ‰¹é‡DELETE**ï¼š

```sql
-- ä¼˜åŒ–å‰ï¼šé€æ¡åˆ é™¤
DELETE FROM users WHERE id = 1;
DELETE FROM users WHERE id = 2;

-- ä¼˜åŒ–åï¼šæ‰¹é‡åˆ é™¤
DELETE FROM users WHERE id IN (1, 2, 3, 4, 5);

-- æˆ–ä½¿ç”¨EXISTS
DELETE FROM users u
WHERE EXISTS (
    SELECT 1 FROM ids_to_delete i
    WHERE i.id = u.id
);
```

---

## äº”ã€è¿æ¥å’Œäº‹åŠ¡ä¼˜åŒ–

### 5.1 è¿æ¥æ± ä¼˜åŒ–

**è¿æ¥æ± é…ç½®**ï¼š

```python
# Python: ä½¿ç”¨è¿æ¥æ± 
from psycopg2 import pool

connection_pool = pool.SimpleConnectionPool(
    minconn=1,
    maxconn=20,  # æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´
    host="localhost",
    database="mydb",
    user="myuser",
    password="mypassword"
)
```

**è¿æ¥å‚æ•°ä¼˜åŒ–**ï¼š

```python
# ä¼˜åŒ–è¿æ¥å‚æ•°
conn = psycopg2.connect(
    host="localhost",
    database="mydb",
    # è¿æ¥è¶…æ—¶
    connect_timeout=10,
    # åº”ç”¨åç§°ï¼ˆç”¨äºç›‘æ§ï¼‰
    application_name="my_app",
    # æ—¶åŒº
    options="-c timezone=UTC"
)
```

### 5.2 äº‹åŠ¡ä¼˜åŒ–

**äº‹åŠ¡èŒƒå›´ä¼˜åŒ–**ï¼š

```sql
-- ä¼˜åŒ–å‰ï¼šé•¿äº‹åŠ¡
BEGIN;
    -- å¤§é‡æ“ä½œ
    INSERT INTO table1 ...;
    INSERT INTO table2 ...;
    -- ... æ›´å¤šæ“ä½œ
COMMIT;

-- ä¼˜åŒ–åï¼šçŸ­äº‹åŠ¡
BEGIN;
    INSERT INTO table1 ...;
COMMIT;

BEGIN;
    INSERT INTO table2 ...;
COMMIT;
```

**æ‰¹é‡æäº¤**ï¼š

```sql
-- æ‰¹é‡æäº¤
DO $$
DECLARE
    batch_size INTEGER := 1000;
    i INTEGER;
BEGIN
    FOR i IN 1..10000 LOOP
        INSERT INTO users (username, email) VALUES (...);

        IF i % batch_size = 0 THEN
            COMMIT;
            BEGIN;
        END IF;
    END LOOP;
    COMMIT;
END $$;
```

### 5.3 é¢„å¤„ç†è¯­å¥

**ä½¿ç”¨é¢„å¤„ç†è¯­å¥**ï¼š

```python
# Python: ä½¿ç”¨é¢„å¤„ç†è¯­å¥
cursor.execute("PREPARE get_user AS SELECT * FROM users WHERE id = $1")
cursor.execute("EXECUTE get_user (%s)", (user_id,))

# æˆ–ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆè‡ªåŠ¨é¢„å¤„ç†ï¼‰
cursor.execute("SELECT * FROM users WHERE id = %s", (user_id,))
```

---

## å…­ã€æ•°æ®ç±»å‹ä¼˜åŒ–

### 6.1 æ•°æ®ç±»å‹é€‰æ‹©

**é€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹**ï¼š

```sql
-- ä¼˜åŒ–å‰ï¼šä½¿ç”¨TEXTå­˜å‚¨å°å­—ç¬¦ä¸²
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    status TEXT  -- åªå­˜å‚¨'active'æˆ–'inactive'
);

-- ä¼˜åŒ–åï¼šä½¿ç”¨VARCHARæˆ–ENUM
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    status VARCHAR(20)  -- æˆ–ä½¿ç”¨ENUMç±»å‹
);

-- æˆ–ä½¿ç”¨ENUM
CREATE TYPE user_status AS ENUM ('active', 'inactive');
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    status user_status
);
```

### 6.2 JSON/JSONBä¼˜åŒ–

**JSONBç´¢å¼•ä¼˜åŒ–**ï¼š

```sql
-- åˆ›å»ºGINç´¢å¼•
CREATE INDEX idx_users_profile_gin ON users USING GIN (profile);

-- æŸ¥è¯¢ä¼˜åŒ–
SELECT * FROM users WHERE profile @> '{"city": "New York"}'::jsonb;

-- PostgreSQL 18: JSONBæ€§èƒ½æå‡
-- JSONBæ“ä½œæ€§èƒ½æå‡15-20%
```

**JSONBè·¯å¾„æŸ¥è¯¢ä¼˜åŒ–**ï¼š

```sql
-- ä½¿ç”¨è·¯å¾„æ“ä½œç¬¦
SELECT * FROM users WHERE profile->>'city' = 'New York';

-- æˆ–ä½¿ç”¨JSONBåŒ…å«æ“ä½œç¬¦ï¼ˆæ›´é«˜æ•ˆï¼‰
SELECT * FROM users WHERE profile @> '{"city": "New York"}'::jsonb;
```

### 6.3 æ•°ç»„ä¼˜åŒ–

**æ•°ç»„ç´¢å¼•**ï¼š

```sql
-- åˆ›å»ºGINç´¢å¼•
CREATE INDEX idx_posts_tags_gin ON posts USING GIN (tags);

-- æŸ¥è¯¢ä¼˜åŒ–
SELECT * FROM posts WHERE 'python' = ANY(tags);
```

---

## ä¸ƒã€PostgreSQL 18æ–°ç‰¹æ€§ä¼˜åŒ–

### 7.1 è™šæ‹Ÿç”Ÿæˆåˆ—ä¼˜åŒ–

**ä½¿ç”¨è™šæ‹Ÿç”Ÿæˆåˆ—å‡å°‘é‡å¤è®¡ç®—**ï¼š

```sql
-- PostgreSQL 18: è™šæ‹Ÿç”Ÿæˆåˆ—
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    price DECIMAL(10,2),
    discount DECIMAL(5,2),
    final_price DECIMAL(10,2) GENERATED ALWAYS AS (
        price * (1 - discount / 100)
    ) STORED
);

-- å¯ä»¥ç´¢å¼•è™šæ‹Ÿç”Ÿæˆåˆ—
CREATE INDEX idx_products_final_price ON products(final_price);

-- æŸ¥è¯¢æ—¶è‡ªåŠ¨ä½¿ç”¨è®¡ç®—å€¼
SELECT * FROM products WHERE final_price > 100;
```

### 7.2 å¼‚æ­¥I/Oä¼˜åŒ–

**å¯ç”¨å¼‚æ­¥I/O**ï¼š

```sql
-- PostgreSQL 18: é…ç½®å¼‚æ­¥I/O
-- postgresql.conf
max_io_concurrency = 10

-- å¼‚æ­¥I/Oè‡ªåŠ¨åº”ç”¨äºï¼š
-- - æ‰¹é‡æ’å…¥
-- - æ‰¹é‡æ›´æ–°
-- - å‘é‡æ£€ç´¢
-- - å¤§æ–‡ä»¶æ“ä½œ
```

### 7.3 MERGEä¼˜åŒ–

**ä½¿ç”¨MERGEæ›¿ä»£UPSERT**ï¼š

```sql
-- PostgreSQL 18: MERGEæ€§èƒ½ä¼˜åŒ–
MERGE INTO customers AS c
USING new_customer_data AS n
ON c.email = n.email
WHEN MATCHED THEN
    UPDATE SET
        name = n.name,
        updated_at = CURRENT_TIMESTAMP
WHEN NOT MATCHED THEN
    INSERT (email, name, created_at)
    VALUES (n.email, n.name, CURRENT_TIMESTAMP);

-- æ€§èƒ½æå‡ï¼šæ¯”INSERT ... ON CONFLICTå¿«20%
```

---

## å…«ã€ç¼“å­˜ç­–ç•¥

### 8.1 åº”ç”¨å±‚ç¼“å­˜

**ä½¿ç”¨Redisç¼“å­˜**ï¼š

```python
# Python: Redisç¼“å­˜ç¤ºä¾‹
import redis
import json

redis_client = redis.Redis(host='localhost', port=6379)

def get_user_cached(user_id):
    # æ£€æŸ¥ç¼“å­˜
    cached = redis_client.get(f"user:{user_id}")
    if cached:
        return json.loads(cached)

    # æŸ¥è¯¢æ•°æ®åº“
    user = query_user_from_db(user_id)

    # å†™å…¥ç¼“å­˜
    redis_client.setex(
        f"user:{user_id}",
        3600,  # TTL: 1å°æ—¶
        json.dumps(user)
    )

    return user
```

### 8.2 æŸ¥è¯¢ç»“æœç¼“å­˜

**ä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜**ï¼š

```sql
-- åˆ›å»ºç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW user_order_stats AS
SELECT
    u.id as user_id,
    u.username,
    COUNT(o.id) as order_count,
    SUM(o.total_amount) as total_amount
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
GROUP BY u.id, u.username;

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_user_order_stats_user_id ON user_order_stats(user_id);

-- åˆ·æ–°ç‰©åŒ–è§†å›¾
REFRESH MATERIALIZED VIEW CONCURRENTLY user_order_stats;
```

### 8.3 ç‰©åŒ–è§†å›¾

**ç‰©åŒ–è§†å›¾ä¼˜åŒ–**ï¼š

```sql
-- ä½¿ç”¨CONCURRENTLYåˆ·æ–°ï¼ˆä¸é˜»å¡æŸ¥è¯¢ï¼‰
REFRESH MATERIALIZED VIEW CONCURRENTLY user_order_stats;

-- å®šæœŸåˆ·æ–°ï¼ˆä½¿ç”¨pg_cronæ‰©å±•ï¼‰
SELECT cron.schedule(
    'refresh-user-stats',
    '0 * * * *',  -- æ¯å°æ—¶
    'REFRESH MATERIALIZED VIEW CONCURRENTLY user_order_stats;'
);
```

---

## ä¹ã€æ€§èƒ½ç›‘æ§

### 9.1 æ€§èƒ½æŒ‡æ ‡ç›‘æ§

**ä½¿ç”¨pg_stat_statements**ï¼š

```sql
-- æŸ¥çœ‹æœ€è€—æ—¶çš„æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    (100 * total_exec_time / sum(total_exec_time) OVER ()) AS percent_total_time
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 10;
```

### 9.2 æ…¢æŸ¥è¯¢åˆ†æ

**è¯†åˆ«æ…¢æŸ¥è¯¢**ï¼š

```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 1000  -- è¶…è¿‡1ç§’
ORDER BY mean_exec_time DESC;
```

### 9.3 æ€§èƒ½æµ‹è¯•

**ä½¿ç”¨EXPLAIN ANALYZE**ï¼š

```sql
-- åˆ†ææŸ¥è¯¢æ€§èƒ½
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT * FROM users WHERE email = 'user@example.com';
```

---

## åã€ç›¸å…³æ–‡æ¡£

- [APIä½¿ç”¨æŒ‡å—](./01.02-APIä½¿ç”¨æŒ‡å—.md)
- [ä»£ç æ¨¡å¼ä¸æœ€ä½³å®è·µ](./01.03-ä»£ç æ¨¡å¼ä¸æœ€ä½³å®è·µ.md)
- [å¼€å‘å·¥å…·ä¸è°ƒè¯•](./01.04-å¼€å‘å·¥å…·ä¸è°ƒè¯•.md)
- [æŸ¥è¯¢ä¼˜åŒ–å™¨åŸç†](../../03-æŸ¥è¯¢ä¸ä¼˜åŒ–/03.01-æŸ¥è¯¢ä¼˜åŒ–å™¨åŸç†.md)
- [æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜](../../03-æŸ¥è¯¢ä¸ä¼˜åŒ–/03.03-æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜.md)

---

**æœ€åæ›´æ–°**: 2025-01-15
**ç»´æŠ¤è€…**: PostgreSQL Documentation Team
