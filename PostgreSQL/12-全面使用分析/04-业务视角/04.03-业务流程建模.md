# PostgreSQL 18 ä¸šåŠ¡æµç¨‹å»ºæ¨¡

> **ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-15
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‘ ç›®å½•

- [PostgreSQL 18 ä¸šåŠ¡æµç¨‹å»ºæ¨¡](#postgresql-18-ä¸šåŠ¡æµç¨‹å»ºæ¨¡)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“Š æ€ç»´å¯¼å›¾](#-æ€ç»´å¯¼å›¾)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
  - [äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#äºŒçŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [2.1 æµç¨‹å»ºæ¨¡æ–¹æ³•å¯¹æ¯”](#21-æµç¨‹å»ºæ¨¡æ–¹æ³•å¯¹æ¯”)
    - [2.2 å·¥ä½œæµå¼•æ“å¯¹æ¯”](#22-å·¥ä½œæµå¼•æ“å¯¹æ¯”)
  - [ä¸‰ã€æµç¨‹è¯†åˆ«](#ä¸‰æµç¨‹è¯†åˆ«)
    - [3.1 ä¸šåŠ¡æµç¨‹åˆ†æ](#31-ä¸šåŠ¡æµç¨‹åˆ†æ)
      - [3.1.1 ä¸šåŠ¡æµç¨‹åˆ†æçš„é‡è¦æ€§](#311-ä¸šåŠ¡æµç¨‹åˆ†æçš„é‡è¦æ€§)
      - [3.1.2 ä¸šåŠ¡æµç¨‹åˆ†æå®ç°](#312-ä¸šåŠ¡æµç¨‹åˆ†æå®ç°)
    - [3.2 æµç¨‹æ­¥éª¤è¯†åˆ«](#32-æµç¨‹æ­¥éª¤è¯†åˆ«)
      - [3.2.1 æµç¨‹æ­¥éª¤è¯†åˆ«çš„é‡è¦æ€§](#321-æµç¨‹æ­¥éª¤è¯†åˆ«çš„é‡è¦æ€§)
      - [3.2.2 æµç¨‹æ­¥éª¤è¯†åˆ«å®ç°](#322-æµç¨‹æ­¥éª¤è¯†åˆ«å®ç°)
    - [3.3 æµç¨‹çŠ¶æ€è®¾è®¡](#33-æµç¨‹çŠ¶æ€è®¾è®¡)
      - [3.3.1 æµç¨‹çŠ¶æ€è®¾è®¡çš„é‡è¦æ€§](#331-æµç¨‹çŠ¶æ€è®¾è®¡çš„é‡è¦æ€§)
      - [3.3.2 æµç¨‹çŠ¶æ€è®¾è®¡å®ç°](#332-æµç¨‹çŠ¶æ€è®¾è®¡å®ç°)
  - [å››ã€æµç¨‹è®¾è®¡](#å››æµç¨‹è®¾è®¡)
    - [4.1 çŠ¶æ€æœºè®¾è®¡](#41-çŠ¶æ€æœºè®¾è®¡)
    - [4.2 å·¥ä½œæµè®¾è®¡](#42-å·¥ä½œæµè®¾è®¡)
    - [4.3 æµç¨‹è§„åˆ™](#43-æµç¨‹è§„åˆ™)
  - [äº”ã€æµç¨‹å®ç°](#äº”æµç¨‹å®ç°)
    - [5.1 çŠ¶æ€è½¬æ¢](#51-çŠ¶æ€è½¬æ¢)
    - [5.2 æµç¨‹æ§åˆ¶](#52-æµç¨‹æ§åˆ¶)
    - [5.3 æµç¨‹ç›‘æ§](#53-æµç¨‹ç›‘æ§)
  - [å…­ã€PostgreSQLå®ç°](#å…­postgresqlå®ç°)
    - [6.1 çŠ¶æ€è¡¨è®¾è®¡](#61-çŠ¶æ€è¡¨è®¾è®¡)
    - [6.2 æµç¨‹è¡¨è®¾è®¡](#62-æµç¨‹è¡¨è®¾è®¡)
    - [6.3 è§¦å‘å™¨å®ç°](#63-è§¦å‘å™¨å®ç°)
  - [ä¸ƒã€æœ€ä½³å®è·µ](#ä¸ƒæœ€ä½³å®è·µ)
    - [7.1 è®¾è®¡åŸåˆ™](#71-è®¾è®¡åŸåˆ™)
    - [7.2 å®æ–½æ­¥éª¤](#72-å®æ–½æ­¥éª¤)
    - [7.3 ä¼˜åŒ–å»ºè®®](#73-ä¼˜åŒ–å»ºè®®)
  - [å…«ã€ç›¸å…³æ–‡æ¡£](#å…«ç›¸å…³æ–‡æ¡£)

---

## ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((ä¸šåŠ¡æµç¨‹å»ºæ¨¡))
    æµç¨‹è¯†åˆ«
      æµç¨‹åˆ†æ
      æ­¥éª¤è¯†åˆ«
      çŠ¶æ€è®¾è®¡
    æµç¨‹è®¾è®¡
      çŠ¶æ€æœº
      å·¥ä½œæµ
      æµç¨‹è§„åˆ™
    æµç¨‹å®ç°
      çŠ¶æ€è½¬æ¢
      æµç¨‹æ§åˆ¶
      æµç¨‹ç›‘æ§
    PostgreSQL
      çŠ¶æ€è¡¨
      æµç¨‹è¡¨
      è§¦å‘å™¨
    æœ€ä½³å®è·µ
      è®¾è®¡åŸåˆ™
      å®æ–½æ­¥éª¤
      ä¼˜åŒ–å»ºè®®
```

---

## ä¸€ã€æ¦‚è¿°

æœ¬æ–‡æ¡£ä»ä¸šåŠ¡è§†è§’ä»‹ç»PostgreSQL 18ä¸­çš„ä¸šåŠ¡æµç¨‹å»ºæ¨¡æ–¹æ³•ï¼Œå¸®åŠ©ä¸šåŠ¡åˆ†æå¸ˆè®¾è®¡å’Œç®¡ç†ä¸šåŠ¡æµç¨‹ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š

- **æµç¨‹å¯¼å‘**ï¼šä»¥ä¸šåŠ¡æµç¨‹ä¸ºä¸­å¿ƒ
- **çŠ¶æ€ç®¡ç†**ï¼šå®Œå–„çš„çŠ¶æ€è½¬æ¢æœºåˆ¶
- **è§„åˆ™é©±åŠ¨**ï¼šåŸºäºè§„åˆ™çš„æµç¨‹æ§åˆ¶
- **PostgreSQLå®ç°**ï¼šåœ¨PostgreSQLä¸­å®ç°æµç¨‹

---

## äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 2.1 æµç¨‹å»ºæ¨¡æ–¹æ³•å¯¹æ¯”

| æ–¹æ³• | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ | å¤æ‚åº¦ | æ¨èåº¦ |
|-----|------|---------|--------|--------|
| **çŠ¶æ€æœº** | ç®€å•ç›´è§‚ | ç®€å•æµç¨‹ | â­â­ | â­â­â­â­ |
| **å·¥ä½œæµå¼•æ“** | åŠŸèƒ½å¼ºå¤§ | å¤æ‚æµç¨‹ | â­â­â­â­â­ | â­â­â­â­ |
| **è§„åˆ™å¼•æ“** | çµæ´» | è§„åˆ™å¤æ‚ | â­â­â­â­ | â­â­â­â­ |

### 2.2 å·¥ä½œæµå¼•æ“å¯¹æ¯”

| å¼•æ“ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ | æ¨èåº¦ |
|-----|------|---------|--------|
| **PostgreSQLå†…ç½®** | ç®€å• | åŸºç¡€æµç¨‹ | â­â­â­ |
| **å¤–éƒ¨å·¥ä½œæµå¼•æ“** | åŠŸèƒ½å…¨ | å¤æ‚æµç¨‹ | â­â­â­â­ |

---

## ä¸‰ã€æµç¨‹è¯†åˆ«

### 3.1 ä¸šåŠ¡æµç¨‹åˆ†æ

#### 3.1.1 ä¸šåŠ¡æµç¨‹åˆ†æçš„é‡è¦æ€§

**ä¸ºä»€ä¹ˆéœ€è¦ä¸šåŠ¡æµç¨‹åˆ†æ**ï¼š

ä¸šåŠ¡æµç¨‹åˆ†ææ˜¯ä¸šåŠ¡å»ºæ¨¡çš„åŸºç¡€ï¼Œå®ƒæä¾›äº†ï¼š

1. **ä¸šåŠ¡ç†è§£**ï¼šæ·±å…¥ç†è§£ä¸šåŠ¡æµç¨‹å’Œè§„åˆ™
2. **ç³»ç»Ÿè®¾è®¡**ï¼šä¸ºç³»ç»Ÿè®¾è®¡æä¾›ä¾æ®
3. **ä¼˜åŒ–æ”¹è¿›**ï¼šè¯†åˆ«æµç¨‹ä¸­çš„é—®é¢˜å’Œæ”¹è¿›ç‚¹
4. **æ ‡å‡†åŒ–**ï¼šå»ºç«‹æ ‡å‡†åŒ–çš„ä¸šåŠ¡æµç¨‹

**ä¸šåŠ¡æµç¨‹åˆ†æçš„æ­¥éª¤**ï¼š

| æ­¥éª¤ | è¯´æ˜ | é‡è¦æ€§ |
|-----|------|--------|
| **è¯†åˆ«ä¸šåŠ¡æµç¨‹** | è¯†åˆ«æ ¸å¿ƒä¸šåŠ¡æµç¨‹ | â­â­â­â­â­ |
| **è¯†åˆ«æµç¨‹æ­¥éª¤** | è¯†åˆ«æµç¨‹ä¸­çš„å…³é”®æ­¥éª¤ | â­â­â­â­â­ |
| **è¯†åˆ«æµç¨‹çŠ¶æ€** | è¯†åˆ«æµç¨‹ä¸­çš„çŠ¶æ€è½¬æ¢ | â­â­â­â­â­ |
| **è¯†åˆ«æµç¨‹è§„åˆ™** | è¯†åˆ«æµç¨‹ä¸­çš„ä¸šåŠ¡è§„åˆ™ | â­â­â­â­ |

#### 3.1.2 ä¸šåŠ¡æµç¨‹åˆ†æå®ç°

**æµç¨‹åˆ†ææ­¥éª¤**ï¼š

```text
ä¸šåŠ¡æµç¨‹åˆ†ææµç¨‹ï¼š

1. è¯†åˆ«ä¸šåŠ¡æµç¨‹
   - æ ¸å¿ƒä¸šåŠ¡æµç¨‹ï¼ˆå¦‚è®¢å•å¤„ç†ã€æ”¯ä»˜æµç¨‹ï¼‰
   - æ”¯æŒä¸šåŠ¡æµç¨‹ï¼ˆå¦‚ç”¨æˆ·æ³¨å†Œã€æ•°æ®åŒæ­¥ï¼‰
   - ç®¡ç†ä¸šåŠ¡æµç¨‹ï¼ˆå¦‚æƒé™ç®¡ç†ã€é…ç½®ç®¡ç†ï¼‰

2. è¯†åˆ«æµç¨‹æ­¥éª¤
   - æ¯ä¸ªæµç¨‹çš„å…³é”®æ­¥éª¤
   - æ­¥éª¤ä¹‹é—´çš„ä¾èµ–å…³ç³»
   - æ­¥éª¤çš„æ‰§è¡Œé¡ºåº

3. è¯†åˆ«æµç¨‹çŠ¶æ€
   - æ¯ä¸ªæ­¥éª¤çš„çŠ¶æ€
   - çŠ¶æ€ä¹‹é—´çš„è½¬æ¢è§„åˆ™
   - çŠ¶æ€çš„ä¸šåŠ¡å«ä¹‰

4. è¯†åˆ«æµç¨‹è§„åˆ™
   - æµç¨‹æ‰§è¡Œçš„ä¸šåŠ¡è§„åˆ™
   - å¼‚å¸¸å¤„ç†è§„åˆ™
   - æƒé™æ§åˆ¶è§„åˆ™
```

### 3.2 æµç¨‹æ­¥éª¤è¯†åˆ«

#### 3.2.1 æµç¨‹æ­¥éª¤è¯†åˆ«çš„é‡è¦æ€§

**ä¸ºä»€ä¹ˆéœ€è¦æµç¨‹æ­¥éª¤è¯†åˆ«**ï¼š

æµç¨‹æ­¥éª¤è¯†åˆ«å¸®åŠ©ç†è§£ä¸šåŠ¡æµç¨‹çš„ç»†èŠ‚ï¼š

1. **æµç¨‹æ¸…æ™°**ï¼šæ˜ç¡®æµç¨‹çš„æ¯ä¸ªæ­¥éª¤
2. **ç³»ç»Ÿè®¾è®¡**ï¼šä¸ºç³»ç»Ÿè®¾è®¡æä¾›è¯¦ç»†ä¾æ®
3. **é—®é¢˜å®šä½**ï¼šå¯ä»¥å¿«é€Ÿå®šä½æµç¨‹ä¸­çš„é—®é¢˜
4. **ä¼˜åŒ–æ”¹è¿›**ï¼šè¯†åˆ«å¯ä»¥ä¼˜åŒ–çš„æ­¥éª¤

#### 3.2.2 æµç¨‹æ­¥éª¤è¯†åˆ«å®ç°

**è®¢å•æµç¨‹ç¤ºä¾‹**ï¼š

```text
è®¢å•æµç¨‹æ­¥éª¤è¯¦ç»†åˆ†æï¼š

1. åˆ›å»ºè®¢å•ï¼ˆpendingï¼‰
   - ç”¨æˆ·é€‰æ‹©å•†å“
   - å¡«å†™æ”¶è´§ä¿¡æ¯
   - ç¡®è®¤è®¢å•ä¿¡æ¯
   - åˆ›å»ºè®¢å•è®°å½•
   - çŠ¶æ€ï¼špendingï¼ˆå¾…æ”¯ä»˜ï¼‰

2. æ”¯ä»˜è®¢å•ï¼ˆpaidï¼‰
   - ç”¨æˆ·é€‰æ‹©æ”¯ä»˜æ–¹å¼
   - è°ƒç”¨æ”¯ä»˜æ¥å£
   - æ”¯ä»˜æˆåŠŸç¡®è®¤
   - æ›´æ–°è®¢å•çŠ¶æ€
   - çŠ¶æ€ï¼špaidï¼ˆå·²æ”¯ä»˜ï¼‰

3. å‘è´§ï¼ˆshippedï¼‰
   - å•†å®¶ç¡®è®¤è®¢å•
   - å‡†å¤‡å•†å“
   - ç”Ÿæˆç‰©æµå•
   - æ›´æ–°è®¢å•çŠ¶æ€
   - çŠ¶æ€ï¼šshippedï¼ˆå·²å‘è´§ï¼‰

4. ç¡®è®¤æ”¶è´§ï¼ˆdeliveredï¼‰
   - ç‰©æµé…é€
   - ç”¨æˆ·ç¡®è®¤æ”¶è´§
   - æ›´æ–°è®¢å•çŠ¶æ€
   - çŠ¶æ€ï¼šdeliveredï¼ˆå·²é€è¾¾ï¼‰

5. å®Œæˆè®¢å•ï¼ˆcompletedï¼‰
   - è®¢å•è¯„ä»·ï¼ˆå¯é€‰ï¼‰
   - è®¢å•å½’æ¡£
   - æ›´æ–°è®¢å•çŠ¶æ€
   - çŠ¶æ€ï¼šcompletedï¼ˆå·²å®Œæˆï¼‰

å¼‚å¸¸æµç¨‹ï¼š
- å–æ¶ˆè®¢å•ï¼ˆcancelledï¼‰ï¼šåœ¨pendingæˆ–paidçŠ¶æ€å¯ä»¥å–æ¶ˆ
- é€€æ¬¾æµç¨‹ï¼šåœ¨paidæˆ–shippedçŠ¶æ€å¯ä»¥ç”³è¯·é€€æ¬¾
```

### 3.3 æµç¨‹çŠ¶æ€è®¾è®¡

#### 3.3.1 æµç¨‹çŠ¶æ€è®¾è®¡çš„é‡è¦æ€§

**ä¸ºä»€ä¹ˆéœ€è¦æµç¨‹çŠ¶æ€è®¾è®¡**ï¼š

æµç¨‹çŠ¶æ€è®¾è®¡æ˜¯ä¸šåŠ¡æµç¨‹å»ºæ¨¡çš„æ ¸å¿ƒï¼š

1. **çŠ¶æ€ç®¡ç†**ï¼šæ˜ç¡®æµç¨‹ä¸­çš„çŠ¶æ€
2. **çŠ¶æ€è½¬æ¢**ï¼šå®šä¹‰çŠ¶æ€ä¹‹é—´çš„è½¬æ¢è§„åˆ™
3. **ä¸šåŠ¡è§„åˆ™**ï¼šé€šè¿‡çŠ¶æ€å®ç°ä¸šåŠ¡è§„åˆ™
4. **ç³»ç»Ÿå®ç°**ï¼šä¸ºç³»ç»Ÿå®ç°æä¾›ä¾æ®

**çŠ¶æ€è®¾è®¡çš„åŸåˆ™**ï¼š

| åŸåˆ™ | è¯´æ˜ | é‡è¦æ€§ |
|-----|------|--------|
| **çŠ¶æ€æ˜ç¡®** | æ¯ä¸ªçŠ¶æ€æœ‰æ˜ç¡®çš„ä¸šåŠ¡å«ä¹‰ | â­â­â­â­â­ |
| **çŠ¶æ€å®Œæ•´** | è¦†ç›–æµç¨‹çš„æ‰€æœ‰çŠ¶æ€ | â­â­â­â­â­ |
| **çŠ¶æ€äº’æ–¥** | çŠ¶æ€ä¹‹é—´äº’æ–¥ï¼Œä¸èƒ½åŒæ—¶å­˜åœ¨ | â­â­â­â­â­ |
| **çŠ¶æ€å¯è½¬æ¢** | å®šä¹‰æ¸…æ™°çš„çŠ¶æ€è½¬æ¢è§„åˆ™ | â­â­â­â­â­ |

#### 3.3.2 æµç¨‹çŠ¶æ€è®¾è®¡å®ç°

**çŠ¶æ€è®¾è®¡**ï¼š

```sql
-- åœºæ™¯ï¼šè®¢å•æµç¨‹çŠ¶æ€è®¾è®¡
-- éœ€æ±‚ï¼šè®¾è®¡è®¢å•æµç¨‹çš„çŠ¶æ€å’ŒçŠ¶æ€è½¬æ¢
-- ç”¨é€”ï¼šä¸šåŠ¡æµç¨‹å»ºæ¨¡ã€ç³»ç»Ÿå®ç°

-- è®¢å•çŠ¶æ€æšä¸¾
CREATE TYPE order_status AS ENUM (
    'pending',      -- å¾…æ”¯ä»˜
    'paid',         -- å·²æ”¯ä»˜
    'shipped',      -- å·²å‘è´§
    'delivered',    -- å·²é€è¾¾
    'completed',    -- å·²å®Œæˆ
    'cancelled'     -- å·²å–æ¶ˆ
);

-- è®¢å•è¡¨
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,
    status order_status NOT NULL DEFAULT 'pending',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    cancelled_at TIMESTAMP,
    cancelled_reason TEXT
);

-- çŠ¶æ€è½¬æ¢è§„åˆ™ï¼š
-- 1. pending -> paid: æ”¯ä»˜æˆåŠŸ
-- 2. pending -> cancelled: å–æ¶ˆè®¢å•
-- 3. paid -> shipped: å•†å®¶å‘è´§
-- 4. paid -> cancelled: ç”³è¯·é€€æ¬¾
-- 5. shipped -> delivered: ç”¨æˆ·ç¡®è®¤æ”¶è´§
-- 6. delivered -> completed: è®¢å•å®Œæˆ

-- çŠ¶æ€è½¬æ¢å‡½æ•°
CREATE OR REPLACE FUNCTION update_order_status(
    p_order_id INTEGER,
    p_new_status order_status,
    p_reason TEXT DEFAULT NULL
)
RETURNS BOOLEAN AS $$
DECLARE
    v_current_status order_status;
BEGIN
    -- è·å–å½“å‰çŠ¶æ€
    SELECT status INTO v_current_status
    FROM orders
    WHERE id = p_order_id;

    -- éªŒè¯çŠ¶æ€è½¬æ¢æ˜¯å¦åˆæ³•
    IF NOT (
        (v_current_status = 'pending' AND p_new_status IN ('paid', 'cancelled')) OR
        (v_current_status = 'paid' AND p_new_status IN ('shipped', 'cancelled')) OR
        (v_current_status = 'shipped' AND p_new_status = 'delivered') OR
        (v_current_status = 'delivered' AND p_new_status = 'completed')
    ) THEN
        RAISE EXCEPTION 'Invalid status transition from % to %', v_current_status, p_new_status;
    END IF;

    -- æ›´æ–°çŠ¶æ€
    UPDATE orders
    SET
        status = p_new_status,
        updated_at = CURRENT_TIMESTAMP,
        cancelled_at = CASE WHEN p_new_status = 'cancelled' THEN CURRENT_TIMESTAMP ELSE cancelled_at END,
        cancelled_reason = CASE WHEN p_new_status = 'cancelled' THEN p_reason ELSE cancelled_reason END
    WHERE id = p_order_id;

    RETURN TRUE;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹ï¼š
-- SELECT update_order_status(1, 'paid');  -- æ”¯ä»˜è®¢å•
-- SELECT update_order_status(1, 'shipped');  -- å‘è´§
-- SELECT update_order_status(1, 'cancelled', 'ç”¨æˆ·å–æ¶ˆ');  -- å–æ¶ˆè®¢å•
```

---

## å››ã€æµç¨‹è®¾è®¡

### 4.1 çŠ¶æ€æœºè®¾è®¡

**çŠ¶æ€è½¬æ¢è¡¨**ï¼š

```sql
-- çŠ¶æ€è½¬æ¢è§„åˆ™è¡¨
CREATE TABLE state_transitions (
    id SERIAL PRIMARY KEY,
    entity_type VARCHAR(50) NOT NULL,
    from_status VARCHAR(50) NOT NULL,
    to_status VARCHAR(50) NOT NULL,
    condition TEXT,
    UNIQUE(entity_type, from_status, to_status)
);

-- è®¢å•çŠ¶æ€è½¬æ¢è§„åˆ™
INSERT INTO state_transitions (entity_type, from_status, to_status) VALUES
('order', 'pending', 'paid'),
('order', 'paid', 'shipped'),
('order', 'shipped', 'delivered'),
('order', 'delivered', 'completed'),
('order', 'pending', 'cancelled'),
('order', 'paid', 'cancelled');
```

### 4.2 å·¥ä½œæµè®¾è®¡

**å·¥ä½œæµè¡¨è®¾è®¡**ï¼š

```sql
-- å·¥ä½œæµå®šä¹‰è¡¨
CREATE TABLE workflows (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    definition JSONB NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å·¥ä½œæµå®ä¾‹è¡¨
CREATE TABLE workflow_instances (
    id SERIAL PRIMARY KEY,
    workflow_id INTEGER NOT NULL REFERENCES workflows(id),
    entity_type VARCHAR(50) NOT NULL,
    entity_id INTEGER NOT NULL,
    current_step VARCHAR(100) NOT NULL,
    status VARCHAR(50) NOT NULL,
    context JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 4.3 æµç¨‹è§„åˆ™

**æµç¨‹è§„åˆ™è®¾è®¡**ï¼š

```sql
-- æµç¨‹è§„åˆ™è¡¨
CREATE TABLE workflow_rules (
    id SERIAL PRIMARY KEY,
    workflow_id INTEGER NOT NULL REFERENCES workflows(id),
    step_name VARCHAR(100) NOT NULL,
    rule_type VARCHAR(50) NOT NULL,  -- 'condition', 'action', 'validation'
    rule_expression TEXT NOT NULL,
    priority INTEGER NOT NULL DEFAULT 0
);
```

---

## äº”ã€æµç¨‹å®ç°

### 5.1 çŠ¶æ€è½¬æ¢

**çŠ¶æ€è½¬æ¢å‡½æ•°**ï¼š

```sql
-- çŠ¶æ€è½¬æ¢å‡½æ•°
CREATE OR REPLACE FUNCTION transition_state(
    p_entity_type VARCHAR,
    p_entity_id INTEGER,
    p_from_status VARCHAR,
    p_to_status VARCHAR
) RETURNS BOOLEAN AS $$
DECLARE
    v_valid BOOLEAN;
BEGIN
    -- æ£€æŸ¥çŠ¶æ€è½¬æ¢æ˜¯å¦æœ‰æ•ˆ
    SELECT EXISTS(
        SELECT 1 FROM state_transitions
        WHERE entity_type = p_entity_type
        AND from_status = p_from_status
        AND to_status = p_to_status
    ) INTO v_valid;

    IF NOT v_valid THEN
        RAISE EXCEPTION 'Invalid state transition from % to %', p_from_status, p_to_status;
    END IF;

    -- æ‰§è¡ŒçŠ¶æ€è½¬æ¢
    EXECUTE format('UPDATE %I SET status = $1, updated_at = CURRENT_TIMESTAMP WHERE id = $2', p_entity_type)
    USING p_to_status, p_entity_id;

    RETURN TRUE;
END;
$$ LANGUAGE plpgsql;
```

### 5.2 æµç¨‹æ§åˆ¶

**æµç¨‹æ§åˆ¶å‡½æ•°**ï¼š

```sql
-- æµç¨‹æ§åˆ¶å‡½æ•°
CREATE OR REPLACE FUNCTION execute_workflow_step(
    p_workflow_instance_id INTEGER,
    p_step_name VARCHAR,
    p_action VARCHAR
) RETURNS BOOLEAN AS $$
DECLARE
    v_instance RECORD;
    v_next_step VARCHAR;
BEGIN
    -- è·å–å·¥ä½œæµå®ä¾‹
    SELECT * INTO v_instance
    FROM workflow_instances
    WHERE id = p_workflow_instance_id;

    -- æ‰§è¡Œæ­¥éª¤
    -- ...

    -- æ›´æ–°å·¥ä½œæµå®ä¾‹
    UPDATE workflow_instances
    SET current_step = v_next_step,
        updated_at = CURRENT_TIMESTAMP
    WHERE id = p_workflow_instance_id;

    RETURN TRUE;
END;
$$ LANGUAGE plpgsql;
```

### 5.3 æµç¨‹ç›‘æ§

**æµç¨‹ç›‘æ§æŸ¥è¯¢**ï¼š

```sql
-- æµç¨‹ç›‘æ§
SELECT
    w.name as workflow_name,
    COUNT(*) as total_instances,
    COUNT(*) FILTER (WHERE wi.status = 'active') as active_instances,
    COUNT(*) FILTER (WHERE wi.status = 'completed') as completed_instances,
    AVG(EXTRACT(EPOCH FROM (wi.updated_at - wi.created_at))) as avg_duration_seconds
FROM workflows w
LEFT JOIN workflow_instances wi ON w.id = wi.workflow_id
GROUP BY w.id, w.name;
```

---

## å…­ã€PostgreSQLå®ç°

### 6.1 çŠ¶æ€è¡¨è®¾è®¡

**çŠ¶æ€å†å²è¡¨**ï¼š

```sql
-- çŠ¶æ€å†å²è¡¨
CREATE TABLE state_history (
    id SERIAL PRIMARY KEY,
    entity_type VARCHAR(50) NOT NULL,
    entity_id INTEGER NOT NULL,
    from_status VARCHAR(50),
    to_status VARCHAR(50) NOT NULL,
    changed_by VARCHAR(100),
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    reason TEXT
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_state_history_entity ON state_history(entity_type, entity_id);
```

### 6.2 æµç¨‹è¡¨è®¾è®¡

**æµç¨‹è¡¨è®¾è®¡**ï¼š

```sql
-- æµç¨‹æ­¥éª¤è¡¨
CREATE TABLE workflow_steps (
    id SERIAL PRIMARY KEY,
    workflow_id INTEGER NOT NULL REFERENCES workflows(id),
    step_name VARCHAR(100) NOT NULL,
    step_type VARCHAR(50) NOT NULL,  -- 'start', 'task', 'decision', 'end'
    next_steps JSONB,  -- ä¸‹ä¸€æ­¥éª¤é…ç½®
    conditions JSONB   -- æ¡ä»¶é…ç½®
);
```

### 6.3 è§¦å‘å™¨å®ç°

**çŠ¶æ€å˜æ›´è§¦å‘å™¨**ï¼š

```sql
-- çŠ¶æ€å˜æ›´è§¦å‘å™¨
CREATE OR REPLACE FUNCTION log_state_change()
RETURNS TRIGGER AS $$
BEGIN
    IF OLD.status IS DISTINCT FROM NEW.status THEN
        INSERT INTO state_history (
            entity_type,
            entity_id,
            from_status,
            to_status,
            changed_at
        ) VALUES (
            TG_TABLE_NAME,
            NEW.id,
            OLD.status,
            NEW.status,
            CURRENT_TIMESTAMP
        );
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER order_state_change_trigger
AFTER UPDATE ON orders
FOR EACH ROW
EXECUTE FUNCTION log_state_change();
```

---

## ä¸ƒã€æœ€ä½³å®è·µ

### 7.1 è®¾è®¡åŸåˆ™

**è®¾è®¡åŸåˆ™**ï¼š

- æµç¨‹æ¸…æ™°
- çŠ¶æ€æ˜ç¡®
- è§„åˆ™å¯é…ç½®
- å¯è¿½æº¯

### 7.2 å®æ–½æ­¥éª¤

**å®æ–½æ­¥éª¤**ï¼š

1. æµç¨‹åˆ†æ
2. çŠ¶æ€è®¾è®¡
3. è§„åˆ™å®šä¹‰
4. å®ç°å¼€å‘
5. æµ‹è¯•éªŒè¯

### 7.3 ä¼˜åŒ–å»ºè®®

**ä¼˜åŒ–å»ºè®®**ï¼š

- ç®€åŒ–æµç¨‹
- å‡å°‘çŠ¶æ€æ•°
- ä¼˜åŒ–æŸ¥è¯¢
- ç›‘æ§æ€§èƒ½

---

## å…«ã€ç›¸å…³æ–‡æ¡£

- [ä¸šåŠ¡å»ºæ¨¡æ–¹æ³•è®º](./04.01-ä¸šåŠ¡å»ºæ¨¡æ–¹æ³•è®º.md)
- [é¢†åŸŸé©±åŠ¨è®¾è®¡](./04.02-é¢†åŸŸé©±åŠ¨è®¾è®¡.md)
- [ä¸šåŠ¡è§„åˆ™å¼•æ“](./04.04-ä¸šåŠ¡è§„åˆ™å¼•æ“.md)
- [å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡](./04.05-å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡.md)

---

**æœ€åæ›´æ–°**: 2025-01-15
**ç»´æŠ¤è€…**: PostgreSQL Documentation Team
