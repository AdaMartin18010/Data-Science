# PostgreSQL 18 ä¸šåŠ¡è§„åˆ™å¼•æ“

> **ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-15
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‘ ç›®å½•

- [PostgreSQL 18 ä¸šåŠ¡è§„åˆ™å¼•æ“](#postgresql-18-ä¸šåŠ¡è§„åˆ™å¼•æ“)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“Š æ€ç»´å¯¼å›¾](#-æ€ç»´å¯¼å›¾)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
  - [äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#äºŒçŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [2.1 è§„åˆ™å¼•æ“æ–¹æ¡ˆå¯¹æ¯”](#21-è§„åˆ™å¼•æ“æ–¹æ¡ˆå¯¹æ¯”)
    - [2.2 è§„åˆ™å®ç°æ–¹å¼å¯¹æ¯”](#22-è§„åˆ™å®ç°æ–¹å¼å¯¹æ¯”)
  - [ä¸‰ã€è§„åˆ™è¯†åˆ«](#ä¸‰è§„åˆ™è¯†åˆ«)
    - [3.1 ä¸šåŠ¡è§„åˆ™åˆ†ç±»](#31-ä¸šåŠ¡è§„åˆ™åˆ†ç±»)
      - [3.1.1 ä¸šåŠ¡è§„åˆ™åˆ†ç±»çš„é‡è¦æ€§](#311-ä¸šåŠ¡è§„åˆ™åˆ†ç±»çš„é‡è¦æ€§)
      - [3.1.2 ä¸šåŠ¡è§„åˆ™åˆ†ç±»å®ç°](#312-ä¸šåŠ¡è§„åˆ™åˆ†ç±»å®ç°)
    - [3.2 è§„åˆ™æå–](#32-è§„åˆ™æå–)
      - [3.2.1 è§„åˆ™æå–çš„é‡è¦æ€§](#321-è§„åˆ™æå–çš„é‡è¦æ€§)
      - [3.2.2 è§„åˆ™æå–å®ç°](#322-è§„åˆ™æå–å®ç°)
    - [3.3 è§„åˆ™å»ºæ¨¡](#33-è§„åˆ™å»ºæ¨¡)
      - [3.3.1 è§„åˆ™å»ºæ¨¡çš„é‡è¦æ€§](#331-è§„åˆ™å»ºæ¨¡çš„é‡è¦æ€§)
      - [3.3.2 è§„åˆ™å»ºæ¨¡å®ç°](#332-è§„åˆ™å»ºæ¨¡å®ç°)
  - [å››ã€è§„åˆ™è®¾è®¡](#å››è§„åˆ™è®¾è®¡)
    - [4.1 è§„åˆ™è¡¨è®¾è®¡](#41-è§„åˆ™è¡¨è®¾è®¡)
    - [4.2 è§„åˆ™è¡¨è¾¾å¼](#42-è§„åˆ™è¡¨è¾¾å¼)
    - [4.3 è§„åˆ™ä¼˜å…ˆçº§](#43-è§„åˆ™ä¼˜å…ˆçº§)
  - [äº”ã€è§„åˆ™å®ç°](#äº”è§„åˆ™å®ç°)
    - [5.1 æ•°æ®åº“çº¦æŸ](#51-æ•°æ®åº“çº¦æŸ)
    - [5.2 è§¦å‘å™¨è§„åˆ™](#52-è§¦å‘å™¨è§„åˆ™)
    - [5.3 å‡½æ•°è§„åˆ™](#53-å‡½æ•°è§„åˆ™)
  - [å…­ã€è§„åˆ™æ‰§è¡Œ](#å…­è§„åˆ™æ‰§è¡Œ)
    - [6.1 è§„åˆ™å¼•æ“](#61-è§„åˆ™å¼•æ“)
    - [6.2 è§„åˆ™è¯„ä¼°](#62-è§„åˆ™è¯„ä¼°)
    - [6.3 è§„åˆ™å†²çªå¤„ç†](#63-è§„åˆ™å†²çªå¤„ç†)
  - [ä¸ƒã€PostgreSQLå®ç°](#ä¸ƒpostgresqlå®ç°)
    - [7.1 è§„åˆ™å­˜å‚¨](#71-è§„åˆ™å­˜å‚¨)
    - [7.2 è§„åˆ™æ‰§è¡Œ](#72-è§„åˆ™æ‰§è¡Œ)
    - [7.3 è§„åˆ™ç®¡ç†](#73-è§„åˆ™ç®¡ç†)
  - [å…«ã€æœ€ä½³å®è·µ](#å…«æœ€ä½³å®è·µ)
    - [8.1 è®¾è®¡åŸåˆ™](#81-è®¾è®¡åŸåˆ™)
    - [8.2 å®æ–½å»ºè®®](#82-å®æ–½å»ºè®®)
    - [8.3 ç»´æŠ¤ç­–ç•¥](#83-ç»´æŠ¤ç­–ç•¥)
  - [ä¹ã€ç›¸å…³æ–‡æ¡£](#ä¹ç›¸å…³æ–‡æ¡£)

---

## ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((ä¸šåŠ¡è§„åˆ™å¼•æ“))
    è§„åˆ™è¯†åˆ«
      è§„åˆ™åˆ†ç±»
      è§„åˆ™æå–
      è§„åˆ™å»ºæ¨¡
    è§„åˆ™è®¾è®¡
      è§„åˆ™è¡¨
      è§„åˆ™è¡¨è¾¾å¼
      è§„åˆ™ä¼˜å…ˆçº§
    è§„åˆ™å®ç°
      æ•°æ®åº“çº¦æŸ
      è§¦å‘å™¨
      å‡½æ•°
    è§„åˆ™æ‰§è¡Œ
      è§„åˆ™å¼•æ“
      è§„åˆ™è¯„ä¼°
      å†²çªå¤„ç†
    PostgreSQL
      è§„åˆ™å­˜å‚¨
      è§„åˆ™æ‰§è¡Œ
      è§„åˆ™ç®¡ç†
    æœ€ä½³å®è·µ
      è®¾è®¡åŸåˆ™
      å®æ–½å»ºè®®
      ç»´æŠ¤ç­–ç•¥
```

---

## ä¸€ã€æ¦‚è¿°

æœ¬æ–‡æ¡£ä»ä¸šåŠ¡è§†è§’ä»‹ç»PostgreSQL 18ä¸­çš„ä¸šåŠ¡è§„åˆ™å¼•æ“è®¾è®¡ï¼Œå¸®åŠ©ä¸šåŠ¡åˆ†æå¸ˆå®ç°çµæ´»çš„ä¸šåŠ¡è§„åˆ™ç®¡ç†ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š

- **è§„åˆ™é©±åŠ¨**ï¼šåŸºäºè§„åˆ™çš„ä¸šåŠ¡é€»è¾‘
- **çµæ´»é…ç½®**ï¼šæ”¯æŒåŠ¨æ€è§„åˆ™é…ç½®
- **å¯ç»´æŠ¤æ€§**ï¼šè§„åˆ™æ˜“äºç®¡ç†å’Œä¿®æ”¹
- **PostgreSQLå®ç°**ï¼šåœ¨PostgreSQLä¸­å®ç°è§„åˆ™å¼•æ“

---

## äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 2.1 è§„åˆ™å¼•æ“æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ | å¤æ‚åº¦ | æ¨èåº¦ |
|-----|------|---------|--------|--------|
| **æ•°æ®åº“çº¦æŸ** | ç®€å•ç›´æ¥ | ç®€å•è§„åˆ™ | â­ | â­â­â­â­ |
| **è§¦å‘å™¨** | è‡ªåŠ¨åŒ– | æ•°æ®è§„åˆ™ | â­â­ | â­â­â­â­ |
| **è§„åˆ™è¡¨** | çµæ´» | å¤æ‚è§„åˆ™ | â­â­â­ | â­â­â­â­â­ |
| **å¤–éƒ¨å¼•æ“** | åŠŸèƒ½å…¨ | ä¼ä¸šçº§ | â­â­â­â­â­ | â­â­â­ |

### 2.2 è§„åˆ™å®ç°æ–¹å¼å¯¹æ¯”

| æ–¹å¼ | æ€§èƒ½ | çµæ´»æ€§ | å¯ç»´æŠ¤æ€§ | æ¨èåº¦ |
|-----|------|--------|---------|--------|
| **CHECKçº¦æŸ** | â­â­â­â­â­ | â­â­ | â­â­ | â­â­â­ |
| **è§¦å‘å™¨** | â­â­â­â­ | â­â­â­ | â­â­â­ | â­â­â­â­ |
| **è§„åˆ™è¡¨** | â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |

---

## ä¸‰ã€è§„åˆ™è¯†åˆ«

### 3.1 ä¸šåŠ¡è§„åˆ™åˆ†ç±»

#### 3.1.1 ä¸šåŠ¡è§„åˆ™åˆ†ç±»çš„é‡è¦æ€§

**ä¸ºä»€ä¹ˆéœ€è¦ä¸šåŠ¡è§„åˆ™åˆ†ç±»**ï¼š

ä¸šåŠ¡è§„åˆ™åˆ†ç±»å¸®åŠ©ç†è§£å’Œç®¡ç†ä¸šåŠ¡è§„åˆ™ï¼š

1. **è§„åˆ™ç†è§£**ï¼šæ˜ç¡®ä¸åŒç±»å‹çš„è§„åˆ™
2. **è§„åˆ™ç®¡ç†**ï¼šä¾¿äºè§„åˆ™çš„ç»„ç»‡å’Œç®¡ç†
3. **è§„åˆ™å®ç°**ï¼šä¸åŒç±»å‹çš„è§„åˆ™æœ‰ä¸åŒçš„å®ç°æ–¹å¼
4. **è§„åˆ™ä¼˜åŒ–**ï¼šå¯ä»¥é’ˆå¯¹ä¸åŒç±»å‹çš„è§„åˆ™è¿›è¡Œä¼˜åŒ–

**ä¸šåŠ¡è§„åˆ™åˆ†ç±»**ï¼š

| è§„åˆ™ç±»å‹ | è¯´æ˜ | å®ç°æ–¹å¼ | é‡è¦æ€§ |
|---------|------|---------|--------|
| **æ•°æ®è§„åˆ™** | æ•°æ®çº¦æŸã€æ ¼å¼éªŒè¯ | CHECKçº¦æŸã€è§¦å‘å™¨ | â­â­â­â­â­ |
| **ä¸šåŠ¡è§„åˆ™** | ä¸šåŠ¡é€»è¾‘ã€è®¡ç®—è§„åˆ™ | å‡½æ•°ã€è§¦å‘å™¨ | â­â­â­â­â­ |
| **å·¥ä½œæµè§„åˆ™** | æµç¨‹æ§åˆ¶ã€çŠ¶æ€è½¬æ¢ | çŠ¶æ€æœºã€è§¦å‘å™¨ | â­â­â­â­ |
| **æƒé™è§„åˆ™** | è®¿é—®æ§åˆ¶ã€æƒé™éªŒè¯ | RLSã€æƒé™ç®¡ç† | â­â­â­â­â­ |

#### 3.1.2 ä¸šåŠ¡è§„åˆ™åˆ†ç±»å®ç°

**è§„åˆ™åˆ†ç±»ç¤ºä¾‹**ï¼š

```text
ä¸šåŠ¡è§„åˆ™åˆ†ç±»ä½“ç³»ï¼š

1. æ•°æ®è§„åˆ™ï¼ˆData Rulesï¼‰
   - æ•°æ®æ ¼å¼éªŒè¯ï¼ˆé‚®ç®±æ ¼å¼ã€ç”µè¯å·ç æ ¼å¼ï¼‰
   - æ•°æ®èŒƒå›´éªŒè¯ï¼ˆé‡‘é¢èŒƒå›´ã€æ•°é‡èŒƒå›´ï¼‰
   - æ•°æ®å®Œæ•´æ€§ï¼ˆå¿…å¡«å­—æ®µã€å¤–é”®çº¦æŸï¼‰
   - æ•°æ®å”¯ä¸€æ€§ï¼ˆå”¯ä¸€çº¦æŸï¼‰

2. ä¸šåŠ¡è§„åˆ™ï¼ˆBusiness Rulesï¼‰
   - è®¡ç®—è§„åˆ™ï¼ˆæŠ˜æ‰£è®¡ç®—ã€ç¨è´¹è®¡ç®—ï¼‰
   - ä¸šåŠ¡é€»è¾‘ï¼ˆè®¢å•çŠ¶æ€è½¬æ¢ã€åº“å­˜æ‰£å‡ï¼‰
   - ä¸šåŠ¡çº¦æŸï¼ˆæœ€å°è®¢å•é‡‘é¢ã€æœ€å¤§è´­ä¹°æ•°é‡ï¼‰
   - ä¸šåŠ¡éªŒè¯ï¼ˆç”¨æˆ·æƒé™éªŒè¯ã€ä¸šåŠ¡çŠ¶æ€éªŒè¯ï¼‰

3. å·¥ä½œæµè§„åˆ™ï¼ˆWorkflow Rulesï¼‰
   - æµç¨‹æ§åˆ¶ï¼ˆå®¡æ‰¹æµç¨‹ã€çŠ¶æ€è½¬æ¢ï¼‰
   - æµç¨‹æ¡ä»¶ï¼ˆæ¡ä»¶åˆ†æ”¯ã€å¹¶è¡Œå¤„ç†ï¼‰
   - æµç¨‹å¼‚å¸¸ï¼ˆå¼‚å¸¸å¤„ç†ã€å›æ»šè§„åˆ™ï¼‰
   - æµç¨‹é€šçŸ¥ï¼ˆé€šçŸ¥è§„åˆ™ã€æé†’è§„åˆ™ï¼‰

4. æƒé™è§„åˆ™ï¼ˆPermission Rulesï¼‰
   - è®¿é—®æ§åˆ¶ï¼ˆç”¨æˆ·æƒé™ã€è§’è‰²æƒé™ï¼‰
   - æ•°æ®éš”ç¦»ï¼ˆç§Ÿæˆ·éš”ç¦»ã€éƒ¨é—¨éš”ç¦»ï¼‰
   - æ“ä½œæƒé™ï¼ˆè¯»ã€å†™ã€åˆ é™¤æƒé™ï¼‰
   - å­—æ®µæƒé™ï¼ˆå­—æ®µçº§åˆ«çš„æƒé™æ§åˆ¶ï¼‰
```

### 3.2 è§„åˆ™æå–

#### 3.2.1 è§„åˆ™æå–çš„é‡è¦æ€§

**ä¸ºä»€ä¹ˆéœ€è¦è§„åˆ™æå–**ï¼š

è§„åˆ™æå–æ˜¯ä¸šåŠ¡è§„åˆ™å¼•æ“çš„åŸºç¡€ï¼š

1. **è§„åˆ™å‘ç°**ï¼šä»ä¸šåŠ¡ä¸­æå–è§„åˆ™
2. **è§„åˆ™æ•´ç†**ï¼šæ•´ç†å’Œè§„èŒƒåŒ–è§„åˆ™
3. **è§„åˆ™éªŒè¯**ï¼šéªŒè¯è§„åˆ™çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§
4. **è§„åˆ™å®ç°**ï¼šä¸ºè§„åˆ™å®ç°æä¾›ä¾æ®

**è§„åˆ™æå–çš„æ–¹æ³•**ï¼š

| æ–¹æ³• | è¯´æ˜ | é€‚ç”¨åœºæ™¯ | æ¨èåº¦ |
|-----|------|---------|--------|
| **ä¸šåŠ¡æ–‡æ¡£åˆ†æ** | ä»ä¸šåŠ¡æ–‡æ¡£ä¸­æå–è§„åˆ™ | æœ‰å®Œæ•´æ–‡æ¡£ | â­â­â­â­ |
| **ä¸šåŠ¡è®¿è°ˆ** | é€šè¿‡è®¿è°ˆæå–è§„åˆ™ | è§„åˆ™å¤æ‚ | â­â­â­â­â­ |
| **ä»£ç åˆ†æ** | ä»ç°æœ‰ä»£ç ä¸­æå–è§„åˆ™ | å·²æœ‰ç³»ç»Ÿ | â­â­â­â­ |
| **æ•°æ®æ¨¡å¼åˆ†æ** | ä»æ•°æ®æ¨¡å¼ä¸­æå–è§„åˆ™ | æ•°æ®é©±åŠ¨ | â­â­â­ |

#### 3.2.2 è§„åˆ™æå–å®ç°

**è§„åˆ™æå–æ–¹æ³•**ï¼š

```text
è§„åˆ™æå–æµç¨‹ï¼š

1. ä¸šåŠ¡æ–‡æ¡£åˆ†æ
   - é˜…è¯»ä¸šåŠ¡éœ€æ±‚æ–‡æ¡£
   - è¯†åˆ«ä¸šåŠ¡è§„åˆ™æè¿°
   - æå–è§„åˆ™æ¡ä»¶å’ŒåŠ¨ä½œ
   - éªŒè¯è§„åˆ™çš„å®Œæ•´æ€§

2. ä¸šåŠ¡è®¿è°ˆ
   - ä¸ä¸šåŠ¡ä¸“å®¶è®¿è°ˆ
   - äº†è§£ä¸šåŠ¡è§„åˆ™ç»†èŠ‚
   - ç¡®è®¤è§„åˆ™çš„æ­£ç¡®æ€§
   - è¡¥å……é—æ¼çš„è§„åˆ™

3. ä»£ç åˆ†æ
   - åˆ†æç°æœ‰ä»£ç é€»è¾‘
   - æå–éšå«çš„ä¸šåŠ¡è§„åˆ™
   - è¯†åˆ«è§„åˆ™å®ç°æ–¹å¼
   - æ•´ç†è§„åˆ™æ–‡æ¡£

4. æ•°æ®æ¨¡å¼åˆ†æ
   - åˆ†ææ•°æ®åº“çº¦æŸ
   - è¯†åˆ«æ•°æ®è§„åˆ™
   - åˆ†æè§¦å‘å™¨é€»è¾‘
   - æå–ä¸šåŠ¡è§„åˆ™
```

### 3.3 è§„åˆ™å»ºæ¨¡

#### 3.3.1 è§„åˆ™å»ºæ¨¡çš„é‡è¦æ€§

**ä¸ºä»€ä¹ˆéœ€è¦è§„åˆ™å»ºæ¨¡**ï¼š

è§„åˆ™å»ºæ¨¡å¸®åŠ©è§„èŒƒåŒ–ä¸šåŠ¡è§„åˆ™ï¼š

1. **è§„åˆ™æ ‡å‡†åŒ–**ï¼šç»Ÿä¸€è§„åˆ™çš„è¡¨ç¤ºæ–¹å¼
2. **è§„åˆ™ç†è§£**ï¼šä¾¿äºç†è§£å’Œæ²Ÿé€šè§„åˆ™
3. **è§„åˆ™å®ç°**ï¼šä¸ºè§„åˆ™å®ç°æä¾›æ ‡å‡†
4. **è§„åˆ™ç®¡ç†**ï¼šä¾¿äºè§„åˆ™çš„ç®¡ç†å’Œç»´æŠ¤

#### 3.3.2 è§„åˆ™å»ºæ¨¡å®ç°

**è§„åˆ™æ¨¡å‹**ï¼š

```text
ä¸šåŠ¡è§„åˆ™æ¨¡å‹ï¼š

ä¸šåŠ¡è§„åˆ™
  â”œâ”€â”€ è§„åˆ™æ ‡è¯†ï¼ˆRule IDï¼‰
  â”‚   â””â”€â”€ å”¯ä¸€æ ‡è¯†è§„åˆ™
  â”œâ”€â”€ è§„åˆ™åç§°ï¼ˆRule Nameï¼‰
  â”‚   â””â”€â”€ è§„åˆ™çš„ä¸šåŠ¡åç§°
  â”œâ”€â”€ è§„åˆ™ç±»å‹ï¼ˆRule Typeï¼‰
  â”‚   â”œâ”€â”€ validationï¼ˆéªŒè¯è§„åˆ™ï¼‰
  â”‚   â”œâ”€â”€ calculationï¼ˆè®¡ç®—è§„åˆ™ï¼‰
  â”‚   â”œâ”€â”€ workflowï¼ˆå·¥ä½œæµè§„åˆ™ï¼‰
  â”‚   â””â”€â”€ permissionï¼ˆæƒé™è§„åˆ™ï¼‰
  â”œâ”€â”€ å®ä½“ç±»å‹ï¼ˆEntity Typeï¼‰
  â”‚   â””â”€â”€ è§„åˆ™é€‚ç”¨çš„å®ä½“ï¼ˆå¦‚orderã€userï¼‰
  â”œâ”€â”€ æ¡ä»¶ï¼ˆConditionï¼‰
  â”‚   â”œâ”€â”€ æ¡ä»¶è¡¨è¾¾å¼
  â”‚   â””â”€â”€ æ¡ä»¶å‚æ•°
  â”œâ”€â”€ åŠ¨ä½œï¼ˆActionï¼‰
  â”‚   â”œâ”€â”€ åŠ¨ä½œç±»å‹ï¼ˆéªŒè¯ã€è®¡ç®—ã€é€šçŸ¥ï¼‰
  â”‚   â””â”€â”€ åŠ¨ä½œè¡¨è¾¾å¼
  â”œâ”€â”€ ä¼˜å…ˆçº§ï¼ˆPriorityï¼‰
  â”‚   â””â”€â”€ è§„åˆ™æ‰§è¡Œä¼˜å…ˆçº§
  â”œâ”€â”€ çŠ¶æ€ï¼ˆStatusï¼‰
  â”‚   â”œâ”€â”€ activeï¼ˆæ¿€æ´»ï¼‰
  â”‚   â””â”€â”€ inactiveï¼ˆåœç”¨ï¼‰
  â””â”€â”€ å…ƒæ•°æ®ï¼ˆMetadataï¼‰
      â”œâ”€â”€ åˆ›å»ºæ—¶é—´
      â”œâ”€â”€ æ›´æ–°æ—¶é—´
      â””â”€â”€ æè¿°ä¿¡æ¯
```

**è§„åˆ™æ¨¡å‹ç¤ºä¾‹**ï¼š

```sql
-- è§„åˆ™æ¨¡å‹åœ¨æ•°æ®åº“ä¸­çš„è¡¨ç¤º
CREATE TABLE business_rules (
    id SERIAL PRIMARY KEY,
    rule_name VARCHAR(100) NOT NULL UNIQUE,
    rule_type VARCHAR(50) NOT NULL,  -- 'validation', 'calculation', 'workflow', 'permission'
    entity_type VARCHAR(50) NOT NULL,  -- 'order', 'user', etc.
    condition_expression TEXT NOT NULL,  -- æ¡ä»¶è¡¨è¾¾å¼
    action_expression TEXT,  -- åŠ¨ä½œè¡¨è¾¾å¼
    priority INTEGER NOT NULL DEFAULT 0,  -- ä¼˜å…ˆçº§
    is_active BOOLEAN NOT NULL DEFAULT TRUE,  -- æ˜¯å¦æ¿€æ´»
    description TEXT,  -- æè¿°
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- è§„åˆ™æ¨¡å‹ç¤ºä¾‹
INSERT INTO business_rules (rule_name, rule_type, entity_type, condition_expression, action_expression, priority) VALUES
('è®¢å•é‡‘é¢éªŒè¯', 'validation', 'order', 'amount > 0 AND amount <= 1000000', 'RAISE EXCEPTION ''Invalid order amount''', 100),
('æŠ˜æ‰£è®¡ç®—', 'calculation', 'order', 'user_type = ''premium'' AND total_amount > 1000', 'discount = total_amount * 0.1', 50);
```

---

## å››ã€è§„åˆ™è®¾è®¡

### 4.1 è§„åˆ™è¡¨è®¾è®¡

**è§„åˆ™è¡¨è®¾è®¡**ï¼š

```sql
-- ä¸šåŠ¡è§„åˆ™è¡¨
CREATE TABLE business_rules (
    id SERIAL PRIMARY KEY,
    rule_name VARCHAR(100) NOT NULL UNIQUE,
    rule_type VARCHAR(50) NOT NULL,  -- 'validation', 'calculation', 'workflow'
    entity_type VARCHAR(50) NOT NULL,  -- 'order', 'user', etc.
    condition_expression TEXT NOT NULL,
    action_expression TEXT,
    priority INTEGER NOT NULL DEFAULT 0,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- è§„åˆ™æ‰§è¡Œå†å²
CREATE TABLE rule_execution_log (
    id SERIAL PRIMARY KEY,
    rule_id INTEGER NOT NULL REFERENCES business_rules(id),
    entity_type VARCHAR(50) NOT NULL,
    entity_id INTEGER NOT NULL,
    execution_result VARCHAR(50) NOT NULL,  -- 'passed', 'failed', 'error'
    execution_message TEXT,
    executed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 4.2 è§„åˆ™è¡¨è¾¾å¼

**è§„åˆ™è¡¨è¾¾å¼ç¤ºä¾‹**ï¼š

```sql
-- è§„åˆ™è¡¨è¾¾å¼ç¤ºä¾‹
INSERT INTO business_rules (rule_name, rule_type, entity_type, condition_expression, action_expression) VALUES
('Order Amount Validation', 'validation', 'order',
 'amount > 0 AND amount <= 1000000',
 NULL),
('Discount Calculation', 'calculation', 'order',
 'user_type = ''premium'' AND total_amount > 1000',
 'discount = total_amount * 0.1');
```

### 4.3 è§„åˆ™ä¼˜å…ˆçº§

**è§„åˆ™ä¼˜å…ˆçº§**ï¼š

```sql
-- è§„åˆ™æŒ‰ä¼˜å…ˆçº§æ’åº
SELECT * FROM business_rules
WHERE entity_type = 'order'
AND is_active = TRUE
ORDER BY priority DESC, id;
```

---

## äº”ã€è§„åˆ™å®ç°

### 5.1 æ•°æ®åº“çº¦æŸ

**çº¦æŸè§„åˆ™**ï¼š

```sql
-- CHECKçº¦æŸ
ALTER TABLE orders
ADD CONSTRAINT orders_amount_positive CHECK (total_amount > 0),
ADD CONSTRAINT orders_status_valid CHECK (status IN ('pending', 'paid', 'shipped', 'delivered', 'completed', 'cancelled'));

-- å¤–é”®çº¦æŸ
ALTER TABLE orders
ADD CONSTRAINT orders_user_fk FOREIGN KEY (user_id) REFERENCES users(id);
```

### 5.2 è§¦å‘å™¨è§„åˆ™

**è§¦å‘å™¨è§„åˆ™**ï¼š

```sql
-- ä¸šåŠ¡è§„åˆ™è§¦å‘å™¨
CREATE OR REPLACE FUNCTION apply_business_rules()
RETURNS TRIGGER AS $$
DECLARE
    v_rule RECORD;
    v_result BOOLEAN;
BEGIN
    -- è·å–é€‚ç”¨çš„è§„åˆ™
    FOR v_rule IN
        SELECT * FROM business_rules
        WHERE entity_type = TG_TABLE_NAME
        AND is_active = TRUE
        ORDER BY priority DESC
    LOOP
        -- è¯„ä¼°è§„åˆ™æ¡ä»¶
        EXECUTE format('SELECT (%s)', v_rule.condition_expression)
        USING NEW
        INTO v_result;

        IF NOT v_result THEN
            RAISE EXCEPTION 'Business rule violation: %', v_rule.rule_name;
        END IF;

        -- æ‰§è¡Œè§„åˆ™åŠ¨ä½œ
        IF v_rule.action_expression IS NOT NULL THEN
            EXECUTE format('SELECT (%s)', v_rule.action_expression)
            USING NEW;
        END IF;
    END LOOP;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER order_business_rules_trigger
BEFORE INSERT OR UPDATE ON orders
FOR EACH ROW
EXECUTE FUNCTION apply_business_rules();
```

### 5.3 å‡½æ•°è§„åˆ™

**è§„åˆ™å‡½æ•°**ï¼š

```sql
-- è§„åˆ™è¯„ä¼°å‡½æ•°
CREATE OR REPLACE FUNCTION evaluate_rule(
    p_rule_id INTEGER,
    p_entity_data JSONB
) RETURNS BOOLEAN AS $$
DECLARE
    v_rule RECORD;
    v_result BOOLEAN;
BEGIN
    SELECT * INTO v_rule
    FROM business_rules
    WHERE id = p_rule_id;

    -- è¯„ä¼°è§„åˆ™
    EXECUTE format('SELECT (%s)', v_rule.condition_expression)
    USING p_entity_data
    INTO v_result;

    RETURN v_result;
END;
$$ LANGUAGE plpgsql;
```

---

## å…­ã€è§„åˆ™æ‰§è¡Œ

### 6.1 è§„åˆ™å¼•æ“

**è§„åˆ™å¼•æ“å‡½æ•°**ï¼š

```sql
-- è§„åˆ™å¼•æ“
CREATE OR REPLACE FUNCTION execute_rules(
    p_entity_type VARCHAR,
    p_entity_data JSONB
) RETURNS JSONB AS $$
DECLARE
    v_rule RECORD;
    v_result JSONB := '{}'::JSONB;
    v_passed BOOLEAN;
BEGIN
    FOR v_rule IN
        SELECT * FROM business_rules
        WHERE entity_type = p_entity_type
        AND is_active = TRUE
        ORDER BY priority DESC
    LOOP
        -- è¯„ä¼°è§„åˆ™
        EXECUTE format('SELECT (%s)', v_rule.condition_expression)
        USING p_entity_data
        INTO v_passed;

        v_result := v_result || jsonb_build_object(
            v_rule.rule_name,
            jsonb_build_object(
                'passed', v_passed,
                'priority', v_rule.priority
            )
        );

        IF NOT v_passed THEN
            EXIT;  -- è§„åˆ™å¤±è´¥ï¼Œåœæ­¢æ‰§è¡Œ
        END IF;
    END LOOP;

    RETURN v_result;
END;
$$ LANGUAGE plpgsql;
```

### 6.2 è§„åˆ™è¯„ä¼°

**è§„åˆ™è¯„ä¼°ç¤ºä¾‹**ï¼š

```sql
-- è¯„ä¼°è®¢å•è§„åˆ™
SELECT execute_rules(
    'order',
    jsonb_build_object(
        'amount', 1000,
        'user_type', 'premium',
        'status', 'pending'
    )
);
```

### 6.3 è§„åˆ™å†²çªå¤„ç†

**å†²çªå¤„ç†ç­–ç•¥**ï¼š

- ä¼˜å…ˆçº§å¤„ç†
- è§„åˆ™ç»„åˆ
- è§„åˆ™äº’æ–¥
- è§„åˆ™è¦†ç›–

---

## ä¸ƒã€PostgreSQLå®ç°

### 7.1 è§„åˆ™å­˜å‚¨

**è§„åˆ™å­˜å‚¨è®¾è®¡**ï¼š

```sql
-- è§„åˆ™ç‰ˆæœ¬ç®¡ç†
CREATE TABLE rule_versions (
    id SERIAL PRIMARY KEY,
    rule_id INTEGER NOT NULL REFERENCES business_rules(id),
    version_number INTEGER NOT NULL,
    condition_expression TEXT NOT NULL,
    action_expression TEXT,
    effective_from TIMESTAMP NOT NULL,
    effective_to TIMESTAMP,
    UNIQUE(rule_id, version_number)
);
```

### 7.2 è§„åˆ™æ‰§è¡Œ

**è§„åˆ™æ‰§è¡Œä¼˜åŒ–**ï¼š

- è§„åˆ™ç¼“å­˜
- è§„åˆ™é¢„ç¼–è¯‘
- æ‰¹é‡æ‰§è¡Œ
- å¹¶è¡Œæ‰§è¡Œ

### 7.3 è§„åˆ™ç®¡ç†

**è§„åˆ™ç®¡ç†åŠŸèƒ½**ï¼š

- è§„åˆ™CRUD
- è§„åˆ™ç‰ˆæœ¬ç®¡ç†
- è§„åˆ™æµ‹è¯•
- è§„åˆ™éƒ¨ç½²

---

## å…«ã€æœ€ä½³å®è·µ

### 8.1 è®¾è®¡åŸåˆ™

**è®¾è®¡åŸåˆ™**ï¼š

- è§„åˆ™ç‹¬ç«‹
- è§„åˆ™å¯é…ç½®
- è§„åˆ™å¯æµ‹è¯•
- è§„åˆ™å¯è¿½æº¯

### 8.2 å®æ–½å»ºè®®

**å®æ–½å»ºè®®**ï¼š

- ä»ç®€å•è§„åˆ™å¼€å§‹
- é€æ­¥å¢åŠ å¤æ‚åº¦
- è§„åˆ™æ–‡æ¡£åŒ–
- è§„åˆ™æµ‹è¯•

### 8.3 ç»´æŠ¤ç­–ç•¥

**ç»´æŠ¤ç­–ç•¥**ï¼š

- å®šæœŸå®¡æŸ¥è§„åˆ™
- è§„åˆ™ç‰ˆæœ¬æ§åˆ¶
- è§„åˆ™æ€§èƒ½ç›‘æ§
- è§„åˆ™ä¼˜åŒ–

---

## ä¹ã€ç›¸å…³æ–‡æ¡£

- [ä¸šåŠ¡å»ºæ¨¡æ–¹æ³•è®º](./04.01-ä¸šåŠ¡å»ºæ¨¡æ–¹æ³•è®º.md)
- [ä¸šåŠ¡æµç¨‹å»ºæ¨¡](./04.03-ä¸šåŠ¡æµç¨‹å»ºæ¨¡.md)
- [å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡](./04.05-å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡.md)

---

**æœ€åæ›´æ–°**: 2025-01-15
**ç»´æŠ¤è€…**: PostgreSQL Documentation Team
