# PostgreSQL 18 é¢†åŸŸé©±åŠ¨è®¾è®¡

> **ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-01-15
> **ç‰ˆæœ¬è¦†ç›–**: PostgreSQL 18.x (æ¨è) â­ | 17.x (æ¨è) | 16.x (å…¼å®¹)
> **æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‘ ç›®å½•

- [PostgreSQL 18 é¢†åŸŸé©±åŠ¨è®¾è®¡](#postgresql-18-é¢†åŸŸé©±åŠ¨è®¾è®¡)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“Š æ€ç»´å¯¼å›¾](#-æ€ç»´å¯¼å›¾)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
  - [äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”](#äºŒçŸ¥è¯†çŸ©é˜µå¯¹æ¯”)
    - [2.1 DDDæ¨¡å¼å¯¹æ¯”](#21-dddæ¨¡å¼å¯¹æ¯”)
    - [2.2 å®ç°æ–¹å¼å¯¹æ¯”](#22-å®ç°æ–¹å¼å¯¹æ¯”)
  - [ä¸‰ã€DDDæ ¸å¿ƒæ¦‚å¿µ](#ä¸‰dddæ ¸å¿ƒæ¦‚å¿µ)
    - [3.1 å®ä½“ä¸å€¼å¯¹è±¡](#31-å®ä½“ä¸å€¼å¯¹è±¡)
      - [3.1.1 å®ä½“ä¸å€¼å¯¹è±¡çš„åŒºåˆ«](#311-å®ä½“ä¸å€¼å¯¹è±¡çš„åŒºåˆ«)
      - [3.1.2 å®ä½“è®¾è®¡å®ç°](#312-å®ä½“è®¾è®¡å®ç°)
    - [3.2 èšåˆä¸èšåˆæ ¹](#32-èšåˆä¸èšåˆæ ¹)
    - [3.3 é¢†åŸŸæœåŠ¡](#33-é¢†åŸŸæœåŠ¡)
  - [å››ã€èšåˆè®¾è®¡](#å››èšåˆè®¾è®¡)
    - [4.1 èšåˆè¾¹ç•Œ](#41-èšåˆè¾¹ç•Œ)
    - [4.2 èšåˆæ ¹è®¾è®¡](#42-èšåˆæ ¹è®¾è®¡)
    - [4.3 èšåˆå†…å®ä½“](#43-èšåˆå†…å®ä½“)
  - [äº”ã€é¢†åŸŸäº‹ä»¶](#äº”é¢†åŸŸäº‹ä»¶)
    - [5.1 äº‹ä»¶è®¾è®¡](#51-äº‹ä»¶è®¾è®¡)
    - [5.2 äº‹ä»¶å­˜å‚¨](#52-äº‹ä»¶å­˜å‚¨)
    - [5.3 äº‹ä»¶å¤„ç†](#53-äº‹ä»¶å¤„ç†)
  - [å…­ã€ä»“å‚¨æ¨¡å¼](#å…­ä»“å‚¨æ¨¡å¼)
    - [6.1 ä»“å‚¨æ¥å£](#61-ä»“å‚¨æ¥å£)
    - [6.2 ä»“å‚¨å®ç°](#62-ä»“å‚¨å®ç°)
    - [6.3 ä»“å‚¨ä½¿ç”¨](#63-ä»“å‚¨ä½¿ç”¨)
  - [ä¸ƒã€PostgreSQLå®ç°](#ä¸ƒpostgresqlå®ç°)
    - [7.1 å®ä½“æ˜ å°„](#71-å®ä½“æ˜ å°„)
    - [7.2 èšåˆæŒä¹…åŒ–](#72-èšåˆæŒä¹…åŒ–)
    - [7.3 äº‹ä»¶æº¯æº](#73-äº‹ä»¶æº¯æº)
  - [å…«ã€æœ€ä½³å®è·µ](#å…«æœ€ä½³å®è·µ)
    - [8.1 DDDåŸåˆ™](#81-dddåŸåˆ™)
    - [8.2 è®¾è®¡æ¨¡å¼](#82-è®¾è®¡æ¨¡å¼)
    - [8.3 å®æ–½å»ºè®®](#83-å®æ–½å»ºè®®)
  - [ä¹ã€ç›¸å…³æ–‡æ¡£](#ä¹ç›¸å…³æ–‡æ¡£)

---

## ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((é¢†åŸŸé©±åŠ¨è®¾è®¡))
    DDDæ¦‚å¿µ
      å®ä½“å€¼å¯¹è±¡
      èšåˆèšåˆæ ¹
      é¢†åŸŸæœåŠ¡
    èšåˆè®¾è®¡
      èšåˆè¾¹ç•Œ
      èšåˆæ ¹
      èšåˆå®ä½“
    é¢†åŸŸäº‹ä»¶
      äº‹ä»¶è®¾è®¡
      äº‹ä»¶å­˜å‚¨
      äº‹ä»¶å¤„ç†
    ä»“å‚¨æ¨¡å¼
      ä»“å‚¨æ¥å£
      ä»“å‚¨å®ç°
      ä»“å‚¨ä½¿ç”¨
    PostgreSQL
      å®ä½“æ˜ å°„
      èšåˆæŒä¹…åŒ–
      äº‹ä»¶æº¯æº
    æœ€ä½³å®è·µ
      DDDåŸåˆ™
      è®¾è®¡æ¨¡å¼
      å®æ–½å»ºè®®
```

---

## ä¸€ã€æ¦‚è¿°

æœ¬æ–‡æ¡£ä»ä¸šåŠ¡è§†è§’ä»‹ç»PostgreSQL 18ä¸­çš„é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰å®è·µï¼Œå¸®åŠ©æ¶æ„å¸ˆè®¾è®¡ç¬¦åˆä¸šåŠ¡é¢†åŸŸçš„æ•°æ®åº“æ¨¡å‹ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š

- **é¢†åŸŸé©±åŠ¨**ï¼šä»¥ä¸šåŠ¡é¢†åŸŸä¸ºä¸­å¿ƒ
- **æ¨¡å¼å®Œæ•´**ï¼šæ¶µç›–DDDæ ¸å¿ƒæ¨¡å¼
- **PostgreSQLå®ç°**ï¼šåœ¨PostgreSQLä¸­å®ç°DDD
- **å®è·µæ€§å¼º**ï¼šæä¾›å®é™…æ¡ˆä¾‹

---

## äºŒã€çŸ¥è¯†çŸ©é˜µå¯¹æ¯”

### 2.1 DDDæ¨¡å¼å¯¹æ¯”

| æ¨¡å¼ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ | å¤æ‚åº¦ | æ¨èåº¦ |
|-----|------|---------|--------|--------|
| **èšåˆæ¨¡å¼** | ä¸€è‡´æ€§è¾¹ç•Œ | å¤æ‚ä¸šåŠ¡ | â­â­â­â­ | â­â­â­â­â­ |
| **äº‹ä»¶æº¯æº** | äº‹ä»¶å­˜å‚¨ | å®¡è®¡éœ€æ±‚ | â­â­â­â­â­ | â­â­â­â­ |
| **CQRS** | è¯»å†™åˆ†ç¦» | é«˜æ€§èƒ½ | â­â­â­â­â­ | â­â­â­â­ |
| **ä»“å‚¨æ¨¡å¼** | æ•°æ®æŠ½è±¡ | é€šç”¨ | â­â­â­ | â­â­â­â­â­ |

### 2.2 å®ç°æ–¹å¼å¯¹æ¯”

| æ–¹å¼ | ç‰¹ç‚¹ | æ€§èƒ½ | å¤æ‚åº¦ | æ¨èåº¦ |
|-----|------|------|--------|--------|
| **å…³ç³»æ¨¡å‹** | ä¼ ç»Ÿæ–¹å¼ | â­â­â­â­ | â­â­â­ | â­â­â­â­ |
| **JSONBæ¨¡å‹** | çµæ´» | â­â­â­ | â­â­ | â­â­â­ |
| **æ··åˆæ¨¡å‹** | å¹³è¡¡ | â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |

---

## ä¸‰ã€DDDæ ¸å¿ƒæ¦‚å¿µ

### 3.1 å®ä½“ä¸å€¼å¯¹è±¡

#### 3.1.1 å®ä½“ä¸å€¼å¯¹è±¡çš„åŒºåˆ«

**ä¸ºä»€ä¹ˆéœ€è¦åŒºåˆ†å®ä½“å’Œå€¼å¯¹è±¡**ï¼š

DDDä¸­å®ä½“å’Œå€¼å¯¹è±¡æœ‰ä¸åŒçš„ç‰¹å¾å’Œç”¨é€”ï¼š

1. **å®ä½“ï¼ˆEntityï¼‰**ï¼šæœ‰å”¯ä¸€æ ‡è¯†ï¼Œç”Ÿå‘½å‘¨æœŸå†…æ ‡è¯†ä¸å˜
2. **å€¼å¯¹è±¡ï¼ˆValue Objectï¼‰**ï¼šæ²¡æœ‰å”¯ä¸€æ ‡è¯†ï¼Œé€šè¿‡å±æ€§å€¼ç›¸ç­‰åˆ¤æ–­ç›¸ç­‰

**å®ä½“ vs å€¼å¯¹è±¡å¯¹æ¯”**ï¼š

| ç‰¹å¾ | å®ä½“ï¼ˆEntityï¼‰ | å€¼å¯¹è±¡ï¼ˆValue Objectï¼‰ |
|-----|--------------|---------------------|
| **æ ‡è¯†** | æœ‰å”¯ä¸€æ ‡è¯† | æ— å”¯ä¸€æ ‡è¯† |
| **ç›¸ç­‰æ€§** | é€šè¿‡IDåˆ¤æ–­ | é€šè¿‡å±æ€§å€¼åˆ¤æ–­ |
| **å¯å˜æ€§** | å¯ä»¥ä¿®æ”¹ | é€šå¸¸ä¸å¯å˜ |
| **ç”Ÿå‘½å‘¨æœŸ** | ç‹¬ç«‹ç”Ÿå‘½å‘¨æœŸ | ä¾é™„äºå®ä½“ |
| **ç¤ºä¾‹** | ç”¨æˆ·ã€è®¢å• | åœ°å€ã€é‡‘é¢ |

#### 3.1.2 å®ä½“è®¾è®¡å®ç°

**å®ä½“è®¾è®¡**ï¼š

```sql
-- åœºæ™¯ï¼šç”¨æˆ·å®ä½“è®¾è®¡
-- éœ€æ±‚ï¼šè®¾è®¡æœ‰å”¯ä¸€æ ‡è¯†çš„ç”¨æˆ·å®ä½“
-- åŸåˆ™ï¼šå®ä½“æœ‰å”¯ä¸€æ ‡è¯†ï¼Œç”Ÿå‘½å‘¨æœŸå†…æ ‡è¯†ä¸å˜

-- ç”¨æˆ·å®ä½“ï¼šæœ‰å”¯ä¸€æ ‡è¯†
CREATE TABLE users (
    id SERIAL PRIMARY KEY,  -- å®ä½“æ ‡è¯†ï¼ˆå”¯ä¸€ã€ä¸å˜ï¼‰
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- å®ä½“ç‰¹å¾ï¼š
-- 1. æœ‰å”¯ä¸€æ ‡è¯†ï¼ˆidï¼‰
-- 2. æ ‡è¯†åœ¨ç”Ÿå‘½å‘¨æœŸå†…ä¸å˜
-- 3. å¯ä»¥é€šè¿‡æ ‡è¯†æŸ¥æ‰¾å’Œå¼•ç”¨
-- 4. å¯ä»¥ä¿®æ”¹å±æ€§ï¼ˆusernameã€emailç­‰ï¼‰

-- å®ä½“æ“ä½œç¤ºä¾‹ï¼š
-- 1. åˆ›å»ºå®ä½“
INSERT INTO users (username, email) VALUES ('alice', 'alice@example.com');

-- 2. é€šè¿‡æ ‡è¯†æŸ¥æ‰¾å®ä½“
SELECT * FROM users WHERE id = 1;

-- 3. ä¿®æ”¹å®ä½“å±æ€§
UPDATE users SET email = 'newemail@example.com' WHERE id = 1;

-- 4. åˆ é™¤å®ä½“
DELETE FROM users WHERE id = 1;
```

**å€¼å¯¹è±¡è®¾è®¡**ï¼š

```sql
-- åœºæ™¯ï¼šåœ°å€å€¼å¯¹è±¡è®¾è®¡
-- éœ€æ±‚ï¼šè®¾è®¡åœ°å€å€¼å¯¹è±¡ï¼ˆæ— å”¯ä¸€æ ‡è¯†ï¼Œé€šè¿‡å±æ€§å€¼åˆ¤æ–­ç›¸ç­‰ï¼‰
-- åŸåˆ™ï¼šå€¼å¯¹è±¡æ²¡æœ‰å”¯ä¸€æ ‡è¯†ï¼Œé€šå¸¸ä¸å¯å˜

-- æ–¹æ³•1ï¼šä½¿ç”¨å¤åˆç±»å‹ï¼ˆPostgreSQLç‰¹æœ‰ï¼‰
CREATE TYPE address AS (
    street VARCHAR(100),
    city VARCHAR(50),
    zip_code VARCHAR(10),
    country VARCHAR(50)
);

CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    shipping_address address,  -- å€¼å¯¹è±¡
    billing_address address    -- å€¼å¯¹è±¡
);

-- å€¼å¯¹è±¡ç‰¹å¾ï¼š
-- 1. æ²¡æœ‰å”¯ä¸€æ ‡è¯†
-- 2. é€šè¿‡å±æ€§å€¼åˆ¤æ–­ç›¸ç­‰
-- 3. é€šå¸¸ä¸å¯å˜ï¼ˆä¿®æ”¹æ—¶åˆ›å»ºæ–°å€¼å¯¹è±¡ï¼‰
-- 4. ä¾é™„äºå®ä½“

-- å€¼å¯¹è±¡ä½¿ç”¨ç¤ºä¾‹ï¼š
-- 1. æ’å…¥å€¼å¯¹è±¡
INSERT INTO users (username, shipping_address)
VALUES (
    'alice',
    ROW('123 Main St', 'New York', '10001', 'USA')::address
);

-- 2. æŸ¥è¯¢å€¼å¯¹è±¡
SELECT
    id,
    username,
    (shipping_address).street,
    (shipping_address).city
FROM users;

-- 3. æ¯”è¾ƒå€¼å¯¹è±¡ï¼ˆé€šè¿‡å±æ€§å€¼ï¼‰
SELECT *
FROM users
WHERE (shipping_address).city = 'New York';

-- æ–¹æ³•2ï¼šä½¿ç”¨JSONBï¼ˆæ›´çµæ´»ï¼‰
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    shipping_address JSONB,  -- å€¼å¯¹è±¡ï¼ˆJSONBæ ¼å¼ï¼‰
    billing_address JSONB    -- å€¼å¯¹è±¡ï¼ˆJSONBæ ¼å¼ï¼‰
);

-- JSONBå€¼å¯¹è±¡ä½¿ç”¨ç¤ºä¾‹ï¼š
INSERT INTO users (username, shipping_address)
VALUES (
    'alice',
    '{"street": "123 Main St", "city": "New York", "zip_code": "10001", "country": "USA"}'::JSONB
);

-- æŸ¥è¯¢JSONBå€¼å¯¹è±¡
SELECT
    id,
    username,
    shipping_address->>'street' as street,
    shipping_address->>'city' as city
FROM users;

-- æ–¹æ³•3ï¼šä½¿ç”¨å•ç‹¬çš„è¡¨ï¼ˆè§„èŒƒåŒ–è®¾è®¡ï¼‰
CREATE TABLE addresses (
    id SERIAL PRIMARY KEY,
    street VARCHAR(100) NOT NULL,
    city VARCHAR(50) NOT NULL,
    zip_code VARCHAR(10) NOT NULL,
    country VARCHAR(50) NOT NULL,
    UNIQUE(street, city, zip_code, country)  -- å”¯ä¸€çº¦æŸä¿è¯å€¼å¯¹è±¡å”¯ä¸€æ€§
);

CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    shipping_address_id INTEGER REFERENCES addresses(id),
    billing_address_id INTEGER REFERENCES addresses(id)
);

-- å€¼å¯¹è±¡è®¾è®¡é€‰æ‹©ï¼š
-- - å¤åˆç±»å‹ï¼šç®€å•ã€æ€§èƒ½å¥½ï¼Œä½†ä¸å¤Ÿçµæ´»
-- - JSONBï¼šçµæ´»ã€æ˜“æ‰©å±•ï¼Œä½†æŸ¥è¯¢æ€§èƒ½ç•¥å·®
-- - å•ç‹¬è¡¨ï¼šè§„èŒƒåŒ–ã€æ˜“æŸ¥è¯¢ï¼Œä½†å¤æ‚åº¦é«˜
```

### 3.2 èšåˆä¸èšåˆæ ¹

**èšåˆè®¾è®¡**ï¼š

```sql
-- èšåˆæ ¹ï¼šè®¢å•
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,  -- èšåˆæ ¹ID
    user_id INTEGER NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL,
    status VARCHAR(20) NOT NULL,
    version INTEGER NOT NULL DEFAULT 1  -- ä¹è§‚é”
);

-- èšåˆå†…å®ä½“ï¼šè®¢å•é¡¹ï¼ˆé€šè¿‡èšåˆæ ¹IDå¼•ç”¨ï¼‰
CREATE TABLE order_items (
    id SERIAL PRIMARY KEY,
    order_id INTEGER NOT NULL REFERENCES orders(id),  -- èšåˆå†…å¼•ç”¨
    product_id INTEGER NOT NULL,
    quantity INTEGER NOT NULL,
    price DECIMAL(10,2) NOT NULL
);
```

### 3.3 é¢†åŸŸæœåŠ¡

**é¢†åŸŸæœåŠ¡å®ç°**ï¼š

```sql
-- é¢†åŸŸæœåŠ¡ï¼šè®¢å•è®¡ç®—
CREATE OR REPLACE FUNCTION calculate_order_total(p_order_id INTEGER)
RETURNS DECIMAL AS $$
DECLARE
    v_total DECIMAL;
BEGIN
    SELECT COALESCE(SUM(quantity * price), 0)
    INTO v_total
    FROM order_items
    WHERE order_id = p_order_id;

    RETURN v_total;
END;
$$ LANGUAGE plpgsql;
```

---

## å››ã€èšåˆè®¾è®¡

### 4.1 èšåˆè¾¹ç•Œ

**èšåˆè¾¹ç•ŒåŸåˆ™**ï¼š

- èšåˆå†…å¼ºä¸€è‡´æ€§
- èšåˆé—´æœ€ç»ˆä¸€è‡´æ€§
- é€šè¿‡èšåˆæ ¹è®¿é—®
- äº‹åŠ¡è¾¹ç•Œåœ¨èšåˆ

### 4.2 èšåˆæ ¹è®¾è®¡

**èšåˆæ ¹ç¤ºä¾‹**ï¼š

```sql
-- è®¢å•èšåˆæ ¹
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL,
    status VARCHAR(20) NOT NULL,
    version INTEGER NOT NULL DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 4.3 èšåˆå†…å®ä½“

**èšåˆå†…å®ä½“è®¾è®¡**ï¼š

```sql
-- èšåˆå†…å®ä½“ï¼šè®¢å•é¡¹
CREATE TABLE order_items (
    id SERIAL PRIMARY KEY,
    order_id INTEGER NOT NULL REFERENCES orders(id),
    product_id INTEGER NOT NULL,
    quantity INTEGER NOT NULL,
    price DECIMAL(10,2) NOT NULL
);
```

---

## äº”ã€é¢†åŸŸäº‹ä»¶

### 5.1 äº‹ä»¶è®¾è®¡

**é¢†åŸŸäº‹ä»¶è¡¨**ï¼š

```sql
-- é¢†åŸŸäº‹ä»¶è¡¨
CREATE TABLE domain_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    aggregate_type VARCHAR(100) NOT NULL,
    aggregate_id INTEGER NOT NULL,
    event_type VARCHAR(100) NOT NULL,
    event_data JSONB NOT NULL,
    event_version INTEGER NOT NULL DEFAULT 1,
    occurred_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_events_aggregate ON domain_events(aggregate_type, aggregate_id);
CREATE INDEX idx_events_type ON domain_events(event_type);
CREATE INDEX idx_events_time ON domain_events(occurred_at);
```

### 5.2 äº‹ä»¶å­˜å‚¨

**äº‹ä»¶å‘å¸ƒ**ï¼š

```sql
-- äº‹ä»¶å‘å¸ƒå‡½æ•°
CREATE OR REPLACE FUNCTION publish_domain_event(
    p_aggregate_type VARCHAR,
    p_aggregate_id INTEGER,
    p_event_type VARCHAR,
    p_event_data JSONB
) RETURNS UUID AS $$
DECLARE
    v_event_id UUID;
BEGIN
    INSERT INTO domain_events (
        aggregate_type,
        aggregate_id,
        event_type,
        event_data
    ) VALUES (
        p_aggregate_type,
        p_aggregate_id,
        p_event_type,
        p_event_data
    ) RETURNING id INTO v_event_id;

    RETURN v_event_id;
END;
$$ LANGUAGE plpgsql;
```

### 5.3 äº‹ä»¶å¤„ç†

**äº‹ä»¶å¤„ç†**ï¼š

```sql
-- äº‹ä»¶å¤„ç†å‡½æ•°
CREATE OR REPLACE FUNCTION process_domain_event(p_event_id UUID)
RETURNS VOID AS $$
DECLARE
    v_event RECORD;
BEGIN
    SELECT * INTO v_event
    FROM domain_events
    WHERE id = p_event_id;

    -- æ ¹æ®äº‹ä»¶ç±»å‹å¤„ç†
    CASE v_event.event_type
        WHEN 'OrderCreated' THEN
            -- å¤„ç†è®¢å•åˆ›å»ºäº‹ä»¶
            PERFORM handle_order_created(v_event.event_data);
        WHEN 'OrderPaid' THEN
            -- å¤„ç†è®¢å•æ”¯ä»˜äº‹ä»¶
            PERFORM handle_order_paid(v_event.event_data);
        ELSE
            RAISE NOTICE 'Unknown event type: %', v_event.event_type;
    END CASE;
END;
$$ LANGUAGE plpgsql;
```

---

## å…­ã€ä»“å‚¨æ¨¡å¼

### 6.1 ä»“å‚¨æ¥å£

**ä»“å‚¨å‡½æ•°å®šä¹‰**ï¼š

```sql
-- è®¢å•ä»“å‚¨æ¥å£
CREATE OR REPLACE FUNCTION order_repository_find_by_id(p_order_id INTEGER)
RETURNS TABLE (
    id INTEGER,
    user_id INTEGER,
    total_amount DECIMAL,
    status VARCHAR,
    created_at TIMESTAMP
) AS $$
BEGIN
    RETURN QUERY
    SELECT o.id, o.user_id, o.total_amount, o.status, o.created_at
    FROM orders o
    WHERE o.id = p_order_id;
END;
$$ LANGUAGE plpgsql;
```

### 6.2 ä»“å‚¨å®ç°

**ä»“å‚¨å®ç°ç¤ºä¾‹**ï¼š

```sql
-- ä¿å­˜è®¢å•
CREATE OR REPLACE FUNCTION order_repository_save(
    p_order_id INTEGER,
    p_user_id INTEGER,
    p_total_amount DECIMAL,
    p_status VARCHAR
) RETURNS INTEGER AS $$
DECLARE
    v_order_id INTEGER;
BEGIN
    IF p_order_id IS NULL THEN
        INSERT INTO orders (user_id, total_amount, status)
        VALUES (p_user_id, p_total_amount, p_status)
        RETURNING id INTO v_order_id;
    ELSE
        UPDATE orders
        SET user_id = p_user_id,
            total_amount = p_total_amount,
            status = p_status,
            version = version + 1
        WHERE id = p_order_id;
        v_order_id := p_order_id;
    END IF;

    RETURN v_order_id;
END;
$$ LANGUAGE plpgsql;
```

### 6.3 ä»“å‚¨ä½¿ç”¨

**ä½¿ç”¨ä»“å‚¨**ï¼š

```sql
-- ä½¿ç”¨ä»“å‚¨æŸ¥æ‰¾è®¢å•
SELECT * FROM order_repository_find_by_id(1);

-- ä½¿ç”¨ä»“å‚¨ä¿å­˜è®¢å•
SELECT order_repository_save(NULL, 1, 100.00, 'pending');
```

---

## ä¸ƒã€PostgreSQLå®ç°

### 7.1 å®ä½“æ˜ å°„

**å®ä½“åˆ°è¡¨çš„æ˜ å°„**ï¼š

```sql
-- å®ä½“æ˜ å°„ç¤ºä¾‹
-- é¢†åŸŸå®ä½“ï¼šUser
-- æ•°æ®åº“è¡¨ï¼šusers
CREATE TABLE users (
    id SERIAL PRIMARY KEY,  -- å®ä½“ID
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL
);
```

### 7.2 èšåˆæŒä¹…åŒ–

**èšåˆæŒä¹…åŒ–**ï¼š

```sql
-- èšåˆæŒä¹…åŒ–å‡½æ•°
CREATE OR REPLACE FUNCTION save_order_aggregate(
    p_order JSONB,
    p_order_items JSONB[]
) RETURNS INTEGER AS $$
DECLARE
    v_order_id INTEGER;
    v_item JSONB;
BEGIN
    -- ä¿å­˜èšåˆæ ¹
    INSERT INTO orders (user_id, total_amount, status)
    VALUES (
        (p_order->>'user_id')::INTEGER,
        (p_order->>'total_amount')::DECIMAL,
        p_order->>'status'
    ) RETURNING id INTO v_order_id;

    -- ä¿å­˜èšåˆå†…å®ä½“
    FOREACH v_item IN ARRAY p_order_items
    LOOP
        INSERT INTO order_items (order_id, product_id, quantity, price)
        VALUES (
            v_order_id,
            (v_item->>'product_id')::INTEGER,
            (v_item->>'quantity')::INTEGER,
            (v_item->>'price')::DECIMAL
        );
    END LOOP;

    RETURN v_order_id;
END;
$$ LANGUAGE plpgsql;
```

### 7.3 äº‹ä»¶æº¯æº

**äº‹ä»¶æº¯æºå®ç°**ï¼š

```sql
-- ä»äº‹ä»¶é‡å»ºèšåˆçŠ¶æ€
CREATE OR REPLACE FUNCTION rebuild_aggregate_from_events(
    p_aggregate_type VARCHAR,
    p_aggregate_id INTEGER
) RETURNS JSONB AS $$
DECLARE
    v_state JSONB := '{}'::JSONB;
    v_event RECORD;
BEGIN
    FOR v_event IN
        SELECT event_data
        FROM domain_events
        WHERE aggregate_type = p_aggregate_type
        AND aggregate_id = p_aggregate_id
        ORDER BY occurred_at
    LOOP
        -- åº”ç”¨äº‹ä»¶åˆ°çŠ¶æ€
        v_state := apply_event_to_state(v_state, v_event.event_data);
    END LOOP;

    RETURN v_state;
END;
$$ LANGUAGE plpgsql;
```

---

## å…«ã€æœ€ä½³å®è·µ

### 8.1 DDDåŸåˆ™

**DDDåŸåˆ™**ï¼š

- é¢†åŸŸé©±åŠ¨
- èšåˆè¾¹ç•Œæ¸…æ™°
- é€šè¿‡èšåˆæ ¹è®¿é—®
- äº‹ä»¶é©±åŠ¨é€šä¿¡

### 8.2 è®¾è®¡æ¨¡å¼

**æ¨èæ¨¡å¼**ï¼š

- èšåˆæ¨¡å¼
- ä»“å‚¨æ¨¡å¼
- é¢†åŸŸäº‹ä»¶
- äº‹ä»¶æº¯æº

### 8.3 å®æ–½å»ºè®®

**å®æ–½å»ºè®®**ï¼š

- ä»å°èšåˆå¼€å§‹
- é€æ­¥æ¼”è¿›
- æŒç»­é‡æ„
- æ–‡æ¡£å®Œå–„

---

## ä¹ã€ç›¸å…³æ–‡æ¡£

- [ä¸šåŠ¡å»ºæ¨¡æ–¹æ³•è®º](./04.01-ä¸šåŠ¡å»ºæ¨¡æ–¹æ³•è®º.md)
- [ä¸šåŠ¡æµç¨‹å»ºæ¨¡](./04.03-ä¸šåŠ¡æµç¨‹å»ºæ¨¡.md)
- [ä¸šåŠ¡è§„åˆ™å¼•æ“](./04.04-ä¸šåŠ¡è§„åˆ™å¼•æ“.md)
- [æ•°æ®å»ºæ¨¡æ–¹æ³•è®º](../03-æ•°æ®è§†è§’/03.01-æ•°æ®å»ºæ¨¡æ–¹æ³•è®º.md)

---

**æœ€åæ›´æ–°**: 2025-01-15
**ç»´æŠ¤è€…**: PostgreSQL Documentation Team
