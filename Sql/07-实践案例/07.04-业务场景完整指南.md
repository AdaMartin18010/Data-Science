# ä¸šåŠ¡åœºæ™¯å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-01-15
> **ç‰ˆæœ¬**ï¼šv1.0.0
> **éš¾åº¦**ï¼šâ­â­â­â­
> **åº”ç”¨åœºæ™¯**ï¼šä¸šåŠ¡ç³»ç»Ÿè®¾è®¡ã€SQLå®è·µã€æœ€ä½³å®è·µ

---

## ğŸ“‹ ç›®å½•

- [ä¸šåŠ¡åœºæ™¯å®Œæ•´æŒ‡å—](#ä¸šåŠ¡åœºæ™¯å®Œæ•´æŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
    - [1.1 ä¸šåŠ¡åœºæ™¯åˆ†ç±»æ€ç»´å¯¼å›¾](#11-ä¸šåŠ¡åœºæ™¯åˆ†ç±»æ€ç»´å¯¼å›¾)
    - [1.2 ä¸šåŠ¡åœºæ™¯å¯¹æ¯”çŸ©é˜µ](#12-ä¸šåŠ¡åœºæ™¯å¯¹æ¯”çŸ©é˜µ)
  - [äºŒã€ç”µå•†ç³»ç»Ÿåœºæ™¯](#äºŒç”µå•†ç³»ç»Ÿåœºæ™¯)
    - [2.1 ç³»ç»Ÿæ¶æ„ERå›¾](#21-ç³»ç»Ÿæ¶æ„erå›¾)
    - [2.2 å•†å“ç®¡ç†ï¼ˆCRUDæ“ä½œï¼‰](#22-å•†å“ç®¡ç†crudæ“ä½œ)
    - [2.3 è®¢å•å¤„ç†ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰](#23-è®¢å•å¤„ç†äº‹åŠ¡å¤„ç†)
    - [2.4 åº“å­˜ç®¡ç†ï¼ˆå¹¶å‘æ§åˆ¶ï¼‰](#24-åº“å­˜ç®¡ç†å¹¶å‘æ§åˆ¶)
    - [2.5 ç”¨æˆ·åˆ†æï¼ˆæ•°æ®åˆ†æï¼‰](#25-ç”¨æˆ·åˆ†ææ•°æ®åˆ†æ)
    - [2.6 æ¨èç³»ç»Ÿï¼ˆå¤æ‚æŸ¥è¯¢ï¼‰](#26-æ¨èç³»ç»Ÿå¤æ‚æŸ¥è¯¢)
  - [ä¸‰ã€é‡‘èç³»ç»Ÿåœºæ™¯](#ä¸‰é‡‘èç³»ç»Ÿåœºæ™¯)
    - [3.1 ç³»ç»Ÿæ¶æ„ERå›¾](#31-ç³»ç»Ÿæ¶æ„erå›¾)
    - [3.2 è´¦æˆ·ç®¡ç†ï¼ˆACIDç‰¹æ€§ï¼‰](#32-è´¦æˆ·ç®¡ç†acidç‰¹æ€§)
    - [3.3 äº¤æ˜“å¤„ç†ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰](#33-äº¤æ˜“å¤„ç†äº‹åŠ¡å¤„ç†)
    - [3.4 é£é™©åˆ†æï¼ˆæ•°æ®åˆ†æï¼‰](#34-é£é™©åˆ†ææ•°æ®åˆ†æ)
    - [3.5 æŠ¥è¡¨ç”Ÿæˆï¼ˆèšåˆæŸ¥è¯¢ï¼‰](#35-æŠ¥è¡¨ç”ŸæˆèšåˆæŸ¥è¯¢)
  - [å››ã€ç¤¾äº¤ç½‘ç»œåœºæ™¯](#å››ç¤¾äº¤ç½‘ç»œåœºæ™¯)
    - [4.1 ç³»ç»Ÿæ¶æ„ERå›¾](#41-ç³»ç»Ÿæ¶æ„erå›¾)
    - [4.2 ç”¨æˆ·å…³ç³»ï¼ˆå›¾æŸ¥è¯¢ï¼‰](#42-ç”¨æˆ·å…³ç³»å›¾æŸ¥è¯¢)
    - [4.3 å†…å®¹æ¨èï¼ˆå¤æ‚æŸ¥è¯¢ï¼‰](#43-å†…å®¹æ¨èå¤æ‚æŸ¥è¯¢)
    - [4.4 æ•°æ®åˆ†æï¼ˆçª—å£å‡½æ•°ï¼‰](#44-æ•°æ®åˆ†æçª—å£å‡½æ•°)
    - [4.5 å®æ—¶ç»Ÿè®¡ï¼ˆæµå¤„ç†ï¼‰](#45-å®æ—¶ç»Ÿè®¡æµå¤„ç†)
  - [äº”ã€ç‰©è”ç½‘åœºæ™¯](#äº”ç‰©è”ç½‘åœºæ™¯)
    - [5.1 ç³»ç»Ÿæ¶æ„ERå›¾](#51-ç³»ç»Ÿæ¶æ„erå›¾)
    - [5.2 ä¼ æ„Ÿå™¨æ•°æ®å­˜å‚¨ï¼ˆæ—¶åºæ•°æ®ï¼‰](#52-ä¼ æ„Ÿå™¨æ•°æ®å­˜å‚¨æ—¶åºæ•°æ®)
    - [5.3 æ•°æ®åˆ†æï¼ˆèšåˆæŸ¥è¯¢ï¼‰](#53-æ•°æ®åˆ†æèšåˆæŸ¥è¯¢)
    - [5.4 å®æ—¶ç›‘æ§ï¼ˆæµå¤„ç†ï¼‰](#54-å®æ—¶ç›‘æ§æµå¤„ç†)
    - [5.5 æ•°æ®å½’æ¡£ï¼ˆåˆ†åŒºè¡¨ï¼‰](#55-æ•°æ®å½’æ¡£åˆ†åŒºè¡¨)
  - [å…­ã€ç›¸å…³èµ„æº](#å…­ç›¸å…³èµ„æº)

---

## ä¸€ã€æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›å®Œæ•´çš„ä¸šåŠ¡åœºæ™¯SQLå®è·µæŒ‡å—ï¼Œæ¶µç›–ç”µå•†ã€é‡‘èã€ç¤¾äº¤ç½‘ç»œã€ç‰©è”ç½‘ç­‰å…¸å‹ä¸šåŠ¡åœºæ™¯ã€‚

### 1.1 ä¸šåŠ¡åœºæ™¯åˆ†ç±»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((ä¸šåŠ¡åœºæ™¯))
    ç”µå•†ç³»ç»Ÿ
      å•†å“ç®¡ç†
        CRUDæ“ä½œ
        åˆ†ç±»ç®¡ç†
        å±æ€§ç®¡ç†
      è®¢å•å¤„ç†
        è®¢å•åˆ›å»º
        è®¢å•æ”¯ä»˜
        è®¢å•é…é€
        äº‹åŠ¡å¤„ç†
      åº“å­˜ç®¡ç†
        åº“å­˜æŸ¥è¯¢
        åº“å­˜æ‰£å‡
        å¹¶å‘æ§åˆ¶
        é”æœºåˆ¶
      ç”¨æˆ·åˆ†æ
        è´­ä¹°è¡Œä¸º
        ç”¨æˆ·ç”»åƒ
        æ•°æ®åˆ†æ
      æ¨èç³»ç»Ÿ
        ååŒè¿‡æ»¤
        å†…å®¹æ¨è
        å¤æ‚æŸ¥è¯¢
    é‡‘èç³»ç»Ÿ
      è´¦æˆ·ç®¡ç†
        ACIDç‰¹æ€§
        è´¦æˆ·åˆ›å»º
        è´¦æˆ·æŸ¥è¯¢
        ä½™é¢ç®¡ç†
      äº¤æ˜“å¤„ç†
        è½¬è´¦äº¤æ˜“
        æ”¯ä»˜äº¤æ˜“
        äº‹åŠ¡å¤„ç†
        ä¸€è‡´æ€§ä¿è¯
      é£é™©åˆ†æ
        å¼‚å¸¸æ£€æµ‹
        é£é™©è¯„ä¼°
        æ•°æ®åˆ†æ
      æŠ¥è¡¨ç”Ÿæˆ
        è´¢åŠ¡æŠ¥è¡¨
        ç»Ÿè®¡æŠ¥è¡¨
        èšåˆæŸ¥è¯¢
    ç¤¾äº¤ç½‘ç»œ
      ç”¨æˆ·å…³ç³»
        å¥½å‹å…³ç³»
        å…³æ³¨å…³ç³»
        å›¾æŸ¥è¯¢
        é€’å½’æŸ¥è¯¢
      å†…å®¹æ¨è
        å†…å®¹æ¨è
        ä¸ªæ€§åŒ–æ¨è
        å¤æ‚æŸ¥è¯¢
      æ•°æ®åˆ†æ
        ç”¨æˆ·æ´»è·ƒåº¦
        å†…å®¹çƒ­åº¦
        çª—å£å‡½æ•°
      å®æ—¶ç»Ÿè®¡
        åœ¨çº¿ç»Ÿè®¡
        å®æ—¶è®¡æ•°
        æµå¤„ç†
    ç‰©è”ç½‘
      ä¼ æ„Ÿå™¨æ•°æ®
        æ—¶åºæ•°æ®
        æ•°æ®å­˜å‚¨
        æ—¶é—´åºåˆ—
      æ•°æ®åˆ†æ
        èšåˆæŸ¥è¯¢
        è¶‹åŠ¿åˆ†æ
        å¼‚å¸¸æ£€æµ‹
      å®æ—¶ç›‘æ§
        å®æ—¶æŸ¥è¯¢
        å‘Šè­¦å¤„ç†
        æµå¤„ç†
      æ•°æ®å½’æ¡£
        åˆ†åŒºè¡¨
        æ•°æ®å½’æ¡£
        å†å²æ•°æ®
```

### 1.2 ä¸šåŠ¡åœºæ™¯å¯¹æ¯”çŸ©é˜µ

| ä¸šåŠ¡åœºæ™¯ | ä¸»è¦ç‰¹ç‚¹ | SQLç‰¹æ€§ | æ€§èƒ½è¦æ±‚ | æ•°æ®é‡ | å…¸å‹æ“ä½œ |
|---------|---------|---------|---------|--------|---------|
| **ç”µå•†ç³»ç»Ÿ** | é«˜å¹¶å‘ã€äº‹åŠ¡æ€§å¼º | äº‹åŠ¡ã€é”ã€ç´¢å¼• | é«˜ | å¤§ | CRUDã€JOINã€èšåˆ |
| **é‡‘èç³»ç»Ÿ** | å¼ºä¸€è‡´æ€§ã€é«˜å¯é æ€§ | ACIDã€äº‹åŠ¡ã€çº¦æŸ | æé«˜ | ä¸­-å¤§ | äº‹åŠ¡ã€èšåˆã€æŠ¥è¡¨ |
| **ç¤¾äº¤ç½‘ç»œ** | å…³ç³»å¤æ‚ã€å®æ—¶æ€§ | é€’å½’æŸ¥è¯¢ã€çª—å£å‡½æ•° | ä¸­-é«˜ | æå¤§ | å›¾æŸ¥è¯¢ã€æ¨èã€ç»Ÿè®¡ |
| **ç‰©è”ç½‘** | æ—¶åºæ•°æ®ã€é«˜å†™å…¥ | åˆ†åŒºè¡¨ã€æ—¶åºæŸ¥è¯¢ | ä¸­ | æå¤§ | æ’å…¥ã€èšåˆã€å½’æ¡£ |

---

## äºŒã€ç”µå•†ç³»ç»Ÿåœºæ™¯

### 2.1 ç³»ç»Ÿæ¶æ„ERå›¾

```mermaid
erDiagram
    User ||--o{ Order : "ä¸‹å•"
    User ||--o{ Cart : "è´­ç‰©è½¦"
    Product ||--o{ OrderItem : "è®¢å•é¡¹"
    Product ||--o{ CartItem : "è´­ç‰©è½¦é¡¹"
    Product ||--o{ Inventory : "åº“å­˜"
    Category ||--o{ Product : "åˆ†ç±»"
    Order ||--o{ OrderItem : "åŒ…å«"
    Order ||--o{ Payment : "æ”¯ä»˜"
    Order ||--o{ Shipping : "é…é€"

    User {
        int user_id PK
        string username
        string email
        string phone
        date register_date
    }
    Product {
        int product_id PK
        string product_name
        int category_id FK
        decimal price
        string description
    }
    Category {
        int category_id PK
        string category_name
        int parent_id FK
    }
    Order {
        int order_id PK
        int user_id FK
        date order_date
        decimal total_amount
        string status
    }
    OrderItem {
        int order_id FK
        int product_id FK
        int quantity
        decimal price
    }
    Inventory {
        int product_id FK
        int quantity
        int reserved_quantity
    }
    Cart {
        int cart_id PK
        int user_id FK
    }
    CartItem {
        int cart_id FK
        int product_id FK
        int quantity
    }
```

### 2.2 å•†å“ç®¡ç†ï¼ˆCRUDæ“ä½œï¼‰

#### 2.2.1 å•†å“åˆ›å»º

```sql
-- åˆ›å»ºå•†å“
INSERT INTO Product (product_name, category_id, price, description)
VALUES ('iPhone 15 Pro', 1, 8999.00, 'Apple iPhone 15 Pro 256GB');

-- åˆ›å»ºå•†å“åº“å­˜
INSERT INTO Inventory (product_id, quantity, reserved_quantity)
VALUES (LAST_INSERT_ID(), 100, 0);
```

#### 2.2.2 å•†å“æŸ¥è¯¢

```sql
-- æŸ¥è¯¢å•†å“åˆ—è¡¨ï¼ˆå¸¦åˆ†ç±»ä¿¡æ¯ï¼‰
SELECT
    p.product_id,
    p.product_name,
    c.category_name,
    p.price,
    i.quantity as stock_quantity
FROM Product p
JOIN Category c ON p.category_id = c.category_id
LEFT JOIN Inventory i ON p.product_id = i.product_id
WHERE p.price BETWEEN 1000 AND 10000
ORDER BY p.price DESC
LIMIT 20;
```

#### 2.2.3 å•†å“æ›´æ–°

```sql
-- æ›´æ–°å•†å“ä»·æ ¼
UPDATE Product
SET price = 7999.00
WHERE product_id = 1;

-- æ‰¹é‡æ›´æ–°å•†å“åˆ†ç±»
UPDATE Product
SET category_id = 2
WHERE category_id = 1 AND price < 1000;
```

#### 2.2.4 å•†å“åˆ é™¤

```sql
-- è½¯åˆ é™¤å•†å“ï¼ˆæ¨èï¼‰
UPDATE Product
SET status = 'deleted'
WHERE product_id = 1;

-- ç¡¬åˆ é™¤å•†å“ï¼ˆéœ€å…ˆåˆ é™¤å…³è”æ•°æ®ï¼‰
DELETE FROM Inventory WHERE product_id = 1;
DELETE FROM Product WHERE product_id = 1;
```

### 2.3 è®¢å•å¤„ç†ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰

#### 2.3.1 è®¢å•åˆ›å»ºäº‹åŠ¡

```sql
-- è®¢å•åˆ›å»ºäº‹åŠ¡ï¼ˆä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼‰
BEGIN TRANSACTION;

-- 1. åˆ›å»ºè®¢å•
INSERT INTO Order (user_id, order_date, total_amount, status)
VALUES (1, CURRENT_DATE, 8999.00, 'pending');

SET @order_id = LAST_INSERT_ID();

-- 2. åˆ›å»ºè®¢å•é¡¹
INSERT INTO OrderItem (order_id, product_id, quantity, price)
VALUES (@order_id, 1, 1, 8999.00);

-- 3. æ‰£å‡åº“å­˜
UPDATE Inventory
SET quantity = quantity - 1,
    reserved_quantity = reserved_quantity + 1
WHERE product_id = 1 AND quantity >= 1;

-- 4. æ£€æŸ¥åº“å­˜æ˜¯å¦è¶³å¤Ÿ
IF (SELECT quantity FROM Inventory WHERE product_id = 1) < 0 THEN
    ROLLBACK;
ELSE
    COMMIT;
END IF;
```

#### 2.3.2 è®¢å•æ”¯ä»˜äº‹åŠ¡

```sql
-- è®¢å•æ”¯ä»˜äº‹åŠ¡
BEGIN TRANSACTION;

-- 1. æ›´æ–°è®¢å•çŠ¶æ€
UPDATE Order
SET status = 'paid',
    payment_date = CURRENT_TIMESTAMP
WHERE order_id = 1 AND status = 'pending';

-- 2. åˆ›å»ºæ”¯ä»˜è®°å½•
INSERT INTO Payment (order_id, amount, payment_method, payment_date)
VALUES (1, 8999.00, 'credit_card', CURRENT_TIMESTAMP);

-- 3. ç¡®è®¤åº“å­˜æ‰£å‡
UPDATE Inventory
SET reserved_quantity = reserved_quantity - 1
WHERE product_id = 1;

COMMIT;
```

### 2.4 åº“å­˜ç®¡ç†ï¼ˆå¹¶å‘æ§åˆ¶ï¼‰

#### 2.4.1 åº“å­˜æŸ¥è¯¢ï¼ˆå¸¦é”ï¼‰

```sql
-- æŸ¥è¯¢å¯ç”¨åº“å­˜ï¼ˆä½¿ç”¨è¡Œé”ï¼‰
SELECT
    product_id,
    quantity - reserved_quantity as available_quantity
FROM Inventory
WHERE product_id = 1
FOR UPDATE;  -- è¡Œçº§é”ï¼Œé˜²æ­¢å¹¶å‘ä¿®æ”¹
```

#### 2.4.2 åº“å­˜æ‰£å‡ï¼ˆä¹è§‚é”ï¼‰

```sql
-- ä½¿ç”¨ç‰ˆæœ¬å·å®ç°ä¹è§‚é”
UPDATE Inventory
SET quantity = quantity - 1,
    version = version + 1
WHERE product_id = 1
  AND version = @current_version  -- æ£€æŸ¥ç‰ˆæœ¬å·
  AND quantity >= 1;

-- æ£€æŸ¥æ›´æ–°æ˜¯å¦æˆåŠŸ
IF ROW_COUNT() = 0 THEN
    -- ç‰ˆæœ¬å†²çªï¼Œé‡è¯•æˆ–è¿”å›é”™è¯¯
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'åº“å­˜æ›´æ–°å†²çªï¼Œè¯·é‡è¯•';
END IF;
```

#### 2.4.3 åº“å­˜æ‰£å‡ï¼ˆæ‚²è§‚é”ï¼‰

```sql
-- ä½¿ç”¨SELECT FOR UPDATEå®ç°æ‚²è§‚é”
BEGIN TRANSACTION;

SELECT quantity, reserved_quantity
FROM Inventory
WHERE product_id = 1
FOR UPDATE;  -- è·å–è¡Œé”

-- æ£€æŸ¥åº“å­˜
IF quantity - reserved_quantity >= 1 THEN
    UPDATE Inventory
    SET quantity = quantity - 1,
        reserved_quantity = reserved_quantity + 1
    WHERE product_id = 1;
    COMMIT;
ELSE
    ROLLBACK;
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'åº“å­˜ä¸è¶³';
END IF;
```

### 2.5 ç”¨æˆ·åˆ†æï¼ˆæ•°æ®åˆ†æï¼‰

#### 2.5.1 ç”¨æˆ·è´­ä¹°è¡Œä¸ºåˆ†æ

```sql
-- ç”¨æˆ·è´­ä¹°è¡Œä¸ºåˆ†æ
WITH user_purchase_stats AS (
    SELECT
        u.user_id,
        u.username,
        COUNT(DISTINCT o.order_id) as order_count,
        SUM(o.total_amount) as total_spent,
        AVG(o.total_amount) as avg_order_amount,
        MAX(o.order_date) as last_purchase_date,
        MIN(o.order_date) as first_purchase_date
    FROM User u
    LEFT JOIN Order o ON u.user_id = o.user_id
    WHERE o.status = 'completed'
    GROUP BY u.user_id, u.username
)
SELECT
    user_id,
    username,
    order_count,
    total_spent,
    avg_order_amount,
    DATEDIFF(CURRENT_DATE, last_purchase_date) as days_since_last_purchase,
    CASE
        WHEN total_spent >= 10000 THEN 'VIP'
        WHEN total_spent >= 5000 THEN 'Gold'
        WHEN total_spent >= 1000 THEN 'Silver'
        ELSE 'Regular'
    END as user_level
FROM user_purchase_stats
ORDER BY total_spent DESC;
```

#### 2.5.2 ç”¨æˆ·ç”»åƒåˆ†æ

```sql
-- ç”¨æˆ·ç”»åƒåˆ†æï¼ˆä½¿ç”¨çª—å£å‡½æ•°ï¼‰
SELECT
    u.user_id,
    u.username,
    COUNT(DISTINCT o.order_id) as order_count,
    SUM(o.total_amount) as total_spent,
    -- è®¡ç®—ç”¨æˆ·è´­ä¹°é¢‘ç‡æ’å
    RANK() OVER (ORDER BY COUNT(DISTINCT o.order_id) DESC) as frequency_rank,
    -- è®¡ç®—ç”¨æˆ·æ¶ˆè´¹é‡‘é¢æ’å
    RANK() OVER (ORDER BY SUM(o.total_amount) DESC) as spending_rank,
    -- è®¡ç®—æœ€è¿‘è´­ä¹°æ—¶é—´
    MAX(o.order_date) as last_purchase_date,
    -- è®¡ç®—è´­ä¹°é—´éš”
    AVG(DATEDIFF(o.order_date, LAG(o.order_date) OVER (PARTITION BY u.user_id ORDER BY o.order_date))) as avg_purchase_interval
FROM User u
LEFT JOIN Order o ON u.user_id = o.user_id
WHERE o.status = 'completed'
GROUP BY u.user_id, u.username;
```

### 2.6 æ¨èç³»ç»Ÿï¼ˆå¤æ‚æŸ¥è¯¢ï¼‰

#### 2.6.1 åŸºäºååŒè¿‡æ»¤çš„å•†å“æ¨è

```sql
-- åŸºäºç”¨æˆ·è´­ä¹°å†å²çš„å•†å“æ¨è
WITH user_similarity AS (
    -- è®¡ç®—ç”¨æˆ·ç›¸ä¼¼åº¦ï¼ˆåŸºäºå…±åŒè´­ä¹°çš„å•†å“ï¼‰
    SELECT
        o1.user_id as user1,
        o2.user_id as user2,
        COUNT(DISTINCT oi1.product_id) as common_products,
        COUNT(DISTINCT oi1.product_id) * 1.0 /
        (SELECT COUNT(DISTINCT product_id) FROM OrderItem WHERE order_id IN (SELECT order_id FROM Order WHERE user_id = o1.user_id)) as similarity
    FROM Order o1
    JOIN OrderItem oi1 ON o1.order_id = oi1.order_id
    JOIN OrderItem oi2 ON oi1.product_id = oi2.product_id
    JOIN Order o2 ON oi2.order_id = o2.order_id
    WHERE o1.user_id != o2.user_id
      AND o1.status = 'completed'
      AND o2.status = 'completed'
    GROUP BY o1.user_id, o2.user_id
    HAVING common_products >= 3
),
recommended_products AS (
    -- åŸºäºç›¸ä¼¼ç”¨æˆ·æ¨èå•†å“
    SELECT
        us.user1 as target_user,
        oi.product_id,
        SUM(us.similarity * oi.quantity) as recommendation_score
    FROM user_similarity us
    JOIN Order o ON us.user2 = o.user_id
    JOIN OrderItem oi ON o.order_id = oi.order_id
    WHERE o.status = 'completed'
      AND oi.product_id NOT IN (
          SELECT product_id
          FROM OrderItem oi2
          JOIN Order o2 ON oi2.order_id = o2.order_id
          WHERE o2.user_id = us.user1
      )
    GROUP BY us.user1, oi.product_id
)
SELECT
    rp.target_user,
    p.product_name,
    p.price,
    rp.recommendation_score
FROM recommended_products rp
JOIN Product p ON rp.product_id = p.product_id
WHERE rp.target_user = 1
ORDER BY rp.recommendation_score DESC
LIMIT 10;
```

---

## ä¸‰ã€é‡‘èç³»ç»Ÿåœºæ™¯

### 3.1 ç³»ç»Ÿæ¶æ„ERå›¾

```mermaid
erDiagram
    Account ||--o{ Transaction : "äº¤æ˜“"
    Account ||--o{ Balance : "ä½™é¢"
    Transaction ||--o{ TransactionDetail : "äº¤æ˜“æ˜ç»†"
    Account ||--o{ Loan : "è´·æ¬¾"
    Account ||--o{ Deposit : "å­˜æ¬¾"

    Account {
        int account_id PK
        string account_number
        int customer_id FK
        string account_type
        date open_date
        string status
    }
    Transaction {
        int transaction_id PK
        int account_id FK
        string transaction_type
        decimal amount
        timestamp transaction_date
        string status
    }
    Balance {
        int account_id FK
        decimal balance
        decimal available_balance
        timestamp last_updated
    }
    Loan {
        int loan_id PK
        int account_id FK
        decimal principal
        decimal interest_rate
        date start_date
        date end_date
    }
```

### 3.2 è´¦æˆ·ç®¡ç†ï¼ˆACIDç‰¹æ€§ï¼‰

#### 3.2.1 è´¦æˆ·åˆ›å»º

```sql
-- åˆ›å»ºè´¦æˆ·ï¼ˆä¿è¯ACIDç‰¹æ€§ï¼‰
BEGIN TRANSACTION;

-- 1. åˆ›å»ºè´¦æˆ·
INSERT INTO Account (account_number, customer_id, account_type, open_date, status)
VALUES ('ACC001', 1, 'checking', CURRENT_DATE, 'active');

SET @account_id = LAST_INSERT_ID();

-- 2. åˆå§‹åŒ–ä½™é¢
INSERT INTO Balance (account_id, balance, available_balance, last_updated)
VALUES (@account_id, 0.00, 0.00, CURRENT_TIMESTAMP);

COMMIT;
```

#### 3.2.2 è´¦æˆ·æŸ¥è¯¢

```sql
-- æŸ¥è¯¢è´¦æˆ·ä¿¡æ¯ï¼ˆå¸¦ä½™é¢ï¼‰
SELECT
    a.account_id,
    a.account_number,
    a.account_type,
    b.balance,
    b.available_balance,
    b.last_updated
FROM Account a
JOIN Balance b ON a.account_id = b.account_id
WHERE a.customer_id = 1
  AND a.status = 'active';
```

### 3.3 äº¤æ˜“å¤„ç†ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰

#### 3.3.1 è½¬è´¦äº¤æ˜“

```sql
-- è½¬è´¦äº¤æ˜“ï¼ˆä¿è¯ACIDç‰¹æ€§ï¼‰
BEGIN TRANSACTION;

-- 1. æ£€æŸ¥è½¬å‡ºè´¦æˆ·ä½™é¢
SELECT balance, available_balance
INTO @from_balance, @from_available
FROM Balance
WHERE account_id = 1
FOR UPDATE;  -- è¡Œçº§é”

-- 2. æ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤Ÿ
IF @from_available < 1000.00 THEN
    ROLLBACK;
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'ä½™é¢ä¸è¶³';
END IF;

-- 3. æ‰£å‡è½¬å‡ºè´¦æˆ·ä½™é¢
UPDATE Balance
SET balance = balance - 1000.00,
    available_balance = available_balance - 1000.00,
    last_updated = CURRENT_TIMESTAMP
WHERE account_id = 1;

-- 4. å¢åŠ è½¬å…¥è´¦æˆ·ä½™é¢
UPDATE Balance
SET balance = balance + 1000.00,
    available_balance = available_balance + 1000.00,
    last_updated = CURRENT_TIMESTAMP
WHERE account_id = 2;

-- 5. åˆ›å»ºäº¤æ˜“è®°å½•
INSERT INTO Transaction (account_id, transaction_type, amount, transaction_date, status)
VALUES (1, 'transfer_out', -1000.00, CURRENT_TIMESTAMP, 'completed'),
       (2, 'transfer_in', 1000.00, CURRENT_TIMESTAMP, 'completed');

COMMIT;
```

#### 3.3.2 æ”¯ä»˜äº¤æ˜“

```sql
-- æ”¯ä»˜äº¤æ˜“ï¼ˆä¿è¯ä¸€è‡´æ€§ï¼‰
BEGIN TRANSACTION;

-- 1. æ‰£å‡è´¦æˆ·ä½™é¢
UPDATE Balance
SET balance = balance - 500.00,
    available_balance = available_balance - 500.00,
    last_updated = CURRENT_TIMESTAMP
WHERE account_id = 1
  AND available_balance >= 500.00;

-- 2. æ£€æŸ¥æ›´æ–°æ˜¯å¦æˆåŠŸ
IF ROW_COUNT() = 0 THEN
    ROLLBACK;
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'ä½™é¢ä¸è¶³';
END IF;

-- 3. åˆ›å»ºäº¤æ˜“è®°å½•
INSERT INTO Transaction (account_id, transaction_type, amount, transaction_date, status)
VALUES (1, 'payment', -500.00, CURRENT_TIMESTAMP, 'completed');

COMMIT;
```

### 3.4 é£é™©åˆ†æï¼ˆæ•°æ®åˆ†æï¼‰

#### 3.4.1 å¼‚å¸¸äº¤æ˜“æ£€æµ‹

```sql
-- å¼‚å¸¸äº¤æ˜“æ£€æµ‹ï¼ˆä½¿ç”¨çª—å£å‡½æ•°ï¼‰
WITH transaction_stats AS (
    SELECT
        account_id,
        transaction_date,
        amount,
        -- è®¡ç®—å¹³å‡äº¤æ˜“é‡‘é¢
        AVG(amount) OVER (PARTITION BY account_id ORDER BY transaction_date ROWS BETWEEN 29 PRECEDING AND CURRENT ROW) as avg_amount_30d,
        -- è®¡ç®—äº¤æ˜“é‡‘é¢æ ‡å‡†å·®
        STDDEV(amount) OVER (PARTITION BY account_id ORDER BY transaction_date ROWS BETWEEN 29 PRECEDING AND CURRENT ROW) as stddev_amount_30d,
        -- è®¡ç®—äº¤æ˜“é¢‘ç‡
        COUNT(*) OVER (PARTITION BY account_id ORDER BY transaction_date ROWS BETWEEN 23 PRECEDING AND CURRENT ROW) as transaction_count_24h
    FROM Transaction
    WHERE transaction_date >= DATE_SUB(CURRENT_TIMESTAMP, INTERVAL 30 DAY)
      AND status = 'completed'
)
SELECT
    account_id,
    transaction_date,
    amount,
    avg_amount_30d,
    stddev_amount_30d,
    transaction_count_24h,
    CASE
        WHEN ABS(amount) > avg_amount_30d + 3 * stddev_amount_30d THEN 'é‡‘é¢å¼‚å¸¸'
        WHEN transaction_count_24h > 20 THEN 'é¢‘ç‡å¼‚å¸¸'
        ELSE 'æ­£å¸¸'
    END as risk_level
FROM transaction_stats
WHERE ABS(amount) > avg_amount_30d + 3 * stddev_amount_30d
   OR transaction_count_24h > 20
ORDER BY transaction_date DESC;
```

### 3.5 æŠ¥è¡¨ç”Ÿæˆï¼ˆèšåˆæŸ¥è¯¢ï¼‰

#### 3.5.1 è´¢åŠ¡æŠ¥è¡¨ç”Ÿæˆ

```sql
-- è´¢åŠ¡æŠ¥è¡¨ç”Ÿæˆï¼ˆæŒ‰æ—¥æœŸã€ç±»å‹ç»Ÿè®¡ï¼‰
SELECT
    DATE(transaction_date) as transaction_date,
    transaction_type,
    COUNT(*) as transaction_count,
    SUM(amount) as total_amount,
    AVG(amount) as avg_amount,
    MIN(amount) as min_amount,
    MAX(amount) as max_amount
FROM Transaction
WHERE transaction_date >= DATE_SUB(CURRENT_DATE, INTERVAL 30 DAY)
  AND status = 'completed'
GROUP BY DATE(transaction_date), transaction_type
ORDER BY transaction_date DESC, transaction_type;
```

---

## å››ã€ç¤¾äº¤ç½‘ç»œåœºæ™¯

### 4.1 ç³»ç»Ÿæ¶æ„ERå›¾

```mermaid
erDiagram
    User ||--o{ Post : "å‘å¸ƒ"
    User ||--o{ Comment : "è¯„è®º"
    User ||--o{ Like : "ç‚¹èµ"
    User ||--o{ Follow : "å…³æ³¨"
    Post ||--o{ Comment : "è¯„è®º"
    Post ||--o{ Like : "ç‚¹èµ"

    User {
        int user_id PK
        string username
        string email
        date register_date
    }
    Post {
        int post_id PK
        int user_id FK
        string content
        timestamp created_at
        int like_count
        int comment_count
    }
    Comment {
        int comment_id PK
        int post_id FK
        int user_id FK
        string content
        timestamp created_at
    }
    Follow {
        int follower_id FK
        int followee_id FK
        timestamp created_at
    }
```

### 4.2 ç”¨æˆ·å…³ç³»ï¼ˆå›¾æŸ¥è¯¢ï¼‰

#### 4.2.1 å¥½å‹å…³ç³»æŸ¥è¯¢

```sql
-- æŸ¥è¯¢ç”¨æˆ·çš„å¥½å‹ï¼ˆåŒå‘å…³æ³¨ï¼‰
SELECT
    u1.user_id as user1,
    u2.user_id as user2,
    u1.username as user1_name,
    u2.username as user2_name
FROM Follow f1
JOIN Follow f2 ON f1.follower_id = f2.followee_id AND f1.followee_id = f2.follower_id
JOIN User u1 ON f1.follower_id = u1.user_id
JOIN User u2 ON f1.followee_id = u2.user_id
WHERE f1.follower_id = 1;
```

#### 4.2.2 å…±åŒå¥½å‹æŸ¥è¯¢

```sql
-- æŸ¥è¯¢ä¸¤ä¸ªç”¨æˆ·çš„å…±åŒå¥½å‹
SELECT
    u.user_id,
    u.username
FROM Follow f1
JOIN Follow f2 ON f1.followee_id = f2.followee_id
JOIN User u ON f1.followee_id = u.user_id
WHERE f1.follower_id = 1
  AND f2.follower_id = 2
  AND f1.followee_id = f2.followee_id;
```

#### 4.2.3 å¥½å‹æ¨èï¼ˆåŸºäºå…±åŒå¥½å‹ï¼‰

```sql
-- åŸºäºå…±åŒå¥½å‹çš„å¥½å‹æ¨è
WITH common_friends AS (
    SELECT
        f2.follower_id as recommended_user,
        COUNT(*) as common_friend_count
    FROM Follow f1
    JOIN Follow f2 ON f1.followee_id = f2.followee_id
    WHERE f1.follower_id = 1
      AND f2.follower_id != 1
      AND f2.follower_id NOT IN (
          SELECT followee_id FROM Follow WHERE follower_id = 1
      )
    GROUP BY f2.follower_id
)
SELECT
    u.user_id,
    u.username,
    cf.common_friend_count
FROM common_friends cf
JOIN User u ON cf.recommended_user = u.user_id
ORDER BY cf.common_friend_count DESC
LIMIT 10;
```

### 4.3 å†…å®¹æ¨èï¼ˆå¤æ‚æŸ¥è¯¢ï¼‰

#### 4.3.1 åŸºäºå…³æ³¨çš„å†…å®¹æ¨è

```sql
-- åŸºäºå…³æ³¨ç”¨æˆ·çš„å†…å®¹æ¨è
SELECT
    p.post_id,
    p.content,
    u.username as author,
    p.created_at,
    p.like_count,
    p.comment_count,
    -- è®¡ç®—æ¨èåˆ†æ•°ï¼ˆåŸºäºå…³æ³¨ç”¨æˆ·çš„äº’åŠ¨ï¼‰
    (p.like_count * 1.0 + p.comment_count * 2.0) as recommendation_score
FROM Post p
JOIN User u ON p.user_id = u.user_id
WHERE p.user_id IN (
    SELECT followee_id
    FROM Follow
    WHERE follower_id = 1
)
  AND p.created_at >= DATE_SUB(CURRENT_TIMESTAMP, INTERVAL 7 DAY)
ORDER BY recommendation_score DESC, p.created_at DESC
LIMIT 20;
```

### 4.4 æ•°æ®åˆ†æï¼ˆçª—å£å‡½æ•°ï¼‰

#### 4.4.1 ç”¨æˆ·æ´»è·ƒåº¦åˆ†æ

```sql
-- ç”¨æˆ·æ´»è·ƒåº¦åˆ†æï¼ˆä½¿ç”¨çª—å£å‡½æ•°ï¼‰
SELECT
    user_id,
    DATE(created_at) as activity_date,
    COUNT(*) as post_count,
    -- è®¡ç®—ç´¯è®¡å‘å¸–æ•°
    SUM(COUNT(*)) OVER (PARTITION BY user_id ORDER BY DATE(created_at)) as cumulative_posts,
    -- è®¡ç®—7æ—¥ç§»åŠ¨å¹³å‡
    AVG(COUNT(*)) OVER (PARTITION BY user_id ORDER BY DATE(created_at) ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) as avg_posts_7d,
    -- è®¡ç®—æ’å
    RANK() OVER (PARTITION BY DATE(created_at) ORDER BY COUNT(*) DESC) as daily_rank
FROM Post
WHERE created_at >= DATE_SUB(CURRENT_DATE, INTERVAL 30 DAY)
GROUP BY user_id, DATE(created_at)
ORDER BY user_id, activity_date;
```

### 4.5 å®æ—¶ç»Ÿè®¡ï¼ˆæµå¤„ç†ï¼‰

#### 4.5.1 å®æ—¶çƒ­é—¨å†…å®¹ç»Ÿè®¡

```sql
-- å®æ—¶çƒ­é—¨å†…å®¹ç»Ÿè®¡ï¼ˆæœ€è¿‘1å°æ—¶ï¼‰
SELECT
    p.post_id,
    p.content,
    u.username as author,
    p.like_count,
    p.comment_count,
    -- è®¡ç®—çƒ­åº¦åˆ†æ•°
    (p.like_count * 1.0 + p.comment_count * 2.0) /
    (TIMESTAMPDIFF(HOUR, p.created_at, CURRENT_TIMESTAMP) + 1) as hot_score
FROM Post p
JOIN User u ON p.user_id = u.user_id
WHERE p.created_at >= DATE_SUB(CURRENT_TIMESTAMP, INTERVAL 1 HOUR)
ORDER BY hot_score DESC
LIMIT 10;
```

---

## äº”ã€ç‰©è”ç½‘åœºæ™¯

### 5.1 ç³»ç»Ÿæ¶æ„ERå›¾

```mermaid
erDiagram
    Device ||--o{ SensorData : "ä¼ æ„Ÿå™¨æ•°æ®"
    Device ||--o{ Alert : "å‘Šè­¦"
    Sensor ||--o{ SensorData : "æ•°æ®"

    Device {
        int device_id PK
        string device_name
        string device_type
        string location
        date install_date
        string status
    }
    Sensor {
        int sensor_id PK
        int device_id FK
        string sensor_type
        string unit
    }
    SensorData {
        int data_id PK
        int sensor_id FK
        decimal value
        timestamp collected_at
    }
    Alert {
        int alert_id PK
        int device_id FK
        string alert_type
        string message
        timestamp created_at
    }
```

### 5.2 ä¼ æ„Ÿå™¨æ•°æ®å­˜å‚¨ï¼ˆæ—¶åºæ•°æ®ï¼‰

#### 5.2.1 æ—¶åºæ•°æ®è¡¨è®¾è®¡

```sql
-- åˆ›å»ºæ—¶åºæ•°æ®è¡¨ï¼ˆä½¿ç”¨åˆ†åŒºè¡¨ä¼˜åŒ–ï¼‰
CREATE TABLE SensorData (
    data_id BIGINT AUTO_INCREMENT,
    sensor_id INT NOT NULL,
    value DECIMAL(10,2) NOT NULL,
    collected_at TIMESTAMP NOT NULL,
    PRIMARY KEY (data_id, collected_at),
    INDEX idx_sensor_time (sensor_id, collected_at)
) PARTITION BY RANGE (UNIX_TIMESTAMP(collected_at)) (
    PARTITION p202501 VALUES LESS THAN (UNIX_TIMESTAMP('2025-02-01')),
    PARTITION p202502 VALUES LESS THAN (UNIX_TIMESTAMP('2025-03-01')),
    PARTITION p202503 VALUES LESS THAN (UNIX_TIMESTAMP('2025-04-01')),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 5.2.2 æ‰¹é‡æ’å…¥ä¼ æ„Ÿå™¨æ•°æ®

```sql
-- æ‰¹é‡æ’å…¥ä¼ æ„Ÿå™¨æ•°æ®ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰
INSERT INTO SensorData (sensor_id, value, collected_at)
VALUES
    (1, 25.5, '2025-01-15 10:00:00'),
    (1, 25.6, '2025-01-15 10:01:00'),
    (1, 25.7, '2025-01-15 10:02:00'),
    (2, 60.0, '2025-01-15 10:00:00'),
    (2, 60.1, '2025-01-15 10:01:00'),
    (2, 60.2, '2025-01-15 10:02:00');
```

### 5.3 æ•°æ®åˆ†æï¼ˆèšåˆæŸ¥è¯¢ï¼‰

#### 5.3.1 ä¼ æ„Ÿå™¨æ•°æ®ç»Ÿè®¡

```sql
-- ä¼ æ„Ÿå™¨æ•°æ®ç»Ÿè®¡ï¼ˆæŒ‰å°æ—¶èšåˆï¼‰
SELECT
    sensor_id,
    DATE_FORMAT(collected_at, '%Y-%m-%d %H:00:00') as hour,
    COUNT(*) as data_count,
    AVG(value) as avg_value,
    MIN(value) as min_value,
    MAX(value) as max_value,
    STDDEV(value) as stddev_value
FROM SensorData
WHERE collected_at >= DATE_SUB(CURRENT_TIMESTAMP, INTERVAL 24 HOUR)
GROUP BY sensor_id, DATE_FORMAT(collected_at, '%Y-%m-%d %H:00:00')
ORDER BY sensor_id, hour;
```

#### 5.3.2 è¶‹åŠ¿åˆ†æ

```sql
-- ä¼ æ„Ÿå™¨æ•°æ®è¶‹åŠ¿åˆ†æï¼ˆä½¿ç”¨çª—å£å‡½æ•°ï¼‰
SELECT
    sensor_id,
    collected_at,
    value,
    -- è®¡ç®—ç§»åŠ¨å¹³å‡
    AVG(value) OVER (PARTITION BY sensor_id ORDER BY collected_at ROWS BETWEEN 9 PRECEDING AND CURRENT ROW) as moving_avg_10,
    -- è®¡ç®—å˜åŒ–ç‡
    (value - LAG(value) OVER (PARTITION BY sensor_id ORDER BY collected_at)) /
    LAG(value) OVER (PARTITION BY sensor_id ORDER BY collected_at) * 100 as change_rate
FROM SensorData
WHERE sensor_id = 1
  AND collected_at >= DATE_SUB(CURRENT_TIMESTAMP, INTERVAL 1 DAY)
ORDER BY collected_at;
```

### 5.4 å®æ—¶ç›‘æ§ï¼ˆæµå¤„ç†ï¼‰

#### 5.4.1 å¼‚å¸¸å€¼æ£€æµ‹

```sql
-- å¼‚å¸¸å€¼æ£€æµ‹ï¼ˆå®æ—¶ç›‘æ§ï¼‰
WITH sensor_stats AS (
    SELECT
        sensor_id,
        AVG(value) as avg_value,
        STDDEV(value) as stddev_value
    FROM SensorData
    WHERE collected_at >= DATE_SUB(CURRENT_TIMESTAMP, INTERVAL 1 HOUR)
    GROUP BY sensor_id
)
SELECT
    sd.sensor_id,
    sd.value,
    sd.collected_at,
    ss.avg_value,
    ss.stddev_value,
    CASE
        WHEN ABS(sd.value - ss.avg_value) > 3 * ss.stddev_value THEN 'å¼‚å¸¸'
        ELSE 'æ­£å¸¸'
    END as status
FROM SensorData sd
JOIN sensor_stats ss ON sd.sensor_id = ss.sensor_id
WHERE sd.collected_at >= DATE_SUB(CURRENT_TIMESTAMP, INTERVAL 5 MINUTE)
  AND ABS(sd.value - ss.avg_value) > 3 * ss.stddev_value
ORDER BY sd.collected_at DESC;
```

### 5.5 æ•°æ®å½’æ¡£ï¼ˆåˆ†åŒºè¡¨ï¼‰

#### 5.5.1 æ•°æ®å½’æ¡£ç­–ç•¥

```sql
-- å½’æ¡£å†å²æ•°æ®ï¼ˆç§»åŠ¨åˆ°å½’æ¡£è¡¨ï¼‰
CREATE TABLE SensorDataArchive LIKE SensorData;

-- å½’æ¡£3ä¸ªæœˆå‰çš„æ•°æ®
INSERT INTO SensorDataArchive
SELECT * FROM SensorData
WHERE collected_at < DATE_SUB(CURRENT_DATE, INTERVAL 3 MONTH);

-- åˆ é™¤å·²å½’æ¡£çš„æ•°æ®
DELETE FROM SensorData
WHERE collected_at < DATE_SUB(CURRENT_DATE, INTERVAL 3 MONTH);
```

---

## å…­ã€ç›¸å…³èµ„æº

### ç›¸å…³æ–‡æ¡£

- [å¤æ‚æŸ¥è¯¢æ¡ˆä¾‹](./07.01-å¤æ‚æŸ¥è¯¢æ¡ˆä¾‹.md) - å¤æ‚æŸ¥è¯¢è®¾è®¡
- [æ•°æ®åˆ†ææ¡ˆä¾‹](./07.02-æ•°æ®åˆ†ææ¡ˆä¾‹.md) - æ•°æ®åˆ†æå®è·µ
- [ETLæµç¨‹æ¡ˆä¾‹](./07.03-ETLæµç¨‹æ¡ˆä¾‹.md) - ETLæµç¨‹è®¾è®¡

---

**ç»´æŠ¤è€…**: SQL Standards Team
**æœ€åæ›´æ–°**: 2025-01-15
