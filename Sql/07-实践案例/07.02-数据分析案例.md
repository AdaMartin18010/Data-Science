# æ•°æ®åˆ†ææ¡ˆä¾‹

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-01-16
> **ç‰ˆæœ¬**ï¼šv1.0.0
> **éš¾åº¦**ï¼šâ­â­â­â­
> **åº”ç”¨åœºæ™¯**ï¼šæ•°æ®åˆ†æã€æŠ¥è¡¨ç”Ÿæˆã€æ•°æ®æŒ–æ˜

---

## ğŸ“‹ ç›®å½•

- [æ•°æ®åˆ†ææ¡ˆä¾‹](#æ•°æ®åˆ†ææ¡ˆä¾‹)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
    - [1.1 æ•°æ®åˆ†æåœºæ™¯åˆ†ç±»æ€ç»´å¯¼å›¾](#11-æ•°æ®åˆ†æåœºæ™¯åˆ†ç±»æ€ç»´å¯¼å›¾)
    - [1.2 æ•°æ®åˆ†ææ–¹æ³•å¯¹æ¯”çŸ©é˜µ](#12-æ•°æ®åˆ†ææ–¹æ³•å¯¹æ¯”çŸ©é˜µ)
  - [äºŒã€èšåˆåˆ†æ](#äºŒèšåˆåˆ†æ)
    - [2.1 æ¡ˆä¾‹ï¼šé”€å”®ç»Ÿè®¡](#21-æ¡ˆä¾‹é”€å”®ç»Ÿè®¡)
  - [ä¸‰ã€æ—¶é—´åºåˆ—åˆ†æ](#ä¸‰æ—¶é—´åºåˆ—åˆ†æ)
    - [3.1 æ¡ˆä¾‹ï¼šæœˆåº¦é”€å”®è¶‹åŠ¿](#31-æ¡ˆä¾‹æœˆåº¦é”€å”®è¶‹åŠ¿)
  - [å››ã€åˆ†ç»„åˆ†æ](#å››åˆ†ç»„åˆ†æ)
    - [4.1 æ¡ˆä¾‹ï¼šå®¢æˆ·åˆ†ç¾¤ï¼ˆRFMæ¨¡å‹ï¼‰](#41-æ¡ˆä¾‹å®¢æˆ·åˆ†ç¾¤rfmæ¨¡å‹)
  - [äº”ã€ç›¸å…³èµ„æº](#äº”ç›¸å…³èµ„æº)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)

---

## ä¸€ã€æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›æ•°æ®åˆ†æSQLæŸ¥è¯¢çš„å®é™…æ¡ˆä¾‹ï¼Œæ¶µç›–èšåˆåˆ†æã€æ—¶é—´åºåˆ—åˆ†æã€åˆ†ç»„åˆ†æç­‰åœºæ™¯ã€‚

### 1.1 æ•°æ®åˆ†æåœºæ™¯åˆ†ç±»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ•°æ®åˆ†æ))
    èšåˆåˆ†æ
      ç»Ÿè®¡æŒ‡æ ‡
        COUNT
        SUM
        AVG
        MAX/MIN
      åˆ†ç»„ç»Ÿè®¡
        GROUP BY
        HAVINGè¿‡æ»¤
      å¤šç»´åº¦åˆ†æ
        äº¤å‰åˆ†æ
        é’»å–åˆ†æ
    æ—¶é—´åºåˆ—åˆ†æ
      è¶‹åŠ¿åˆ†æ
        çº¿æ€§è¶‹åŠ¿
        å‘¨æœŸæ€§è¶‹åŠ¿
      åŒæ¯”ç¯æ¯”
        æœˆåº¦å¯¹æ¯”
        å¹´åº¦å¯¹æ¯”
      ç§»åŠ¨å¹³å‡
        ç®€å•ç§»åŠ¨å¹³å‡
        åŠ æƒç§»åŠ¨å¹³å‡
    åˆ†ç»„åˆ†æ
      å®¢æˆ·åˆ†ç¾¤
        RFMæ¨¡å‹
        ä»·å€¼åˆ†å±‚
      äº§å“åˆ†ç±»
        é”€å”®åˆ†ç±»
        åº“å­˜åˆ†ç±»
      åŒºåŸŸåˆ†æ
        åœ°ç†åˆ†å¸ƒ
        åŒºåŸŸå¯¹æ¯”
    æ’ååˆ†æ
      ç»å¯¹æ’å
        TOP N
        BOTTOM N
      ç›¸å¯¹æ’å
        ç™¾åˆ†æ¯”æ’å
        åˆ†ä½æ•°
    å¯¹æ¯”åˆ†æ
      åŒæœŸå¯¹æ¯”
        åŒæ¯”åˆ†æ
        ç¯æ¯”åˆ†æ
      ç›®æ ‡å¯¹æ¯”
        å®Œæˆç‡
        å¢é•¿ç‡
```

### 1.2 æ•°æ®åˆ†ææ–¹æ³•å¯¹æ¯”çŸ©é˜µ

| åˆ†ææ–¹æ³• | SQLå®ç° | å¤æ‚åº¦ | æ€§èƒ½ | é€‚ç”¨åœºæ™¯ |
|---------|---------|--------|------|---------|
| **èšåˆåˆ†æ** | GROUP BY + èšåˆå‡½æ•° | â­â­ | â­â­â­â­ | ç»Ÿè®¡æ±‡æ€» |
| **æ—¶é—´åºåˆ—** | çª—å£å‡½æ•° + æ—¥æœŸå‡½æ•° | â­â­â­ | â­â­â­ | è¶‹åŠ¿åˆ†æ |
| **åˆ†ç»„åˆ†æ** | CASE WHEN + GROUP BY | â­â­ | â­â­â­ | å®¢æˆ·åˆ†ç¾¤ |
| **æ’ååˆ†æ** | çª—å£å‡½æ•° RANK | â­â­â­ | â­â­â­ | TOP NæŸ¥è¯¢ |
| **å¯¹æ¯”åˆ†æ** | LAG/LEAD + è®¡ç®— | â­â­â­â­ | â­â­ | åŒæ¯”ç¯æ¯” |

---

## äºŒã€èšåˆåˆ†æ

### 2.1 æ¡ˆä¾‹ï¼šé”€å”®ç»Ÿè®¡

**åœºæ™¯æè¿°**ï¼šç”µå•†å¹³å°éœ€è¦æŒ‰å•†å“ç±»åˆ«ç»Ÿè®¡é”€å”®æ•°æ®ï¼Œç”¨äºç”Ÿæˆé”€å”®æŠ¥è¡¨å’Œåˆ¶å®šè¥é”€ç­–ç•¥ã€‚

**ä¸šåŠ¡éœ€æ±‚**ï¼š

- æŒ‰å•†å“ç±»åˆ«ç»Ÿè®¡æ€»é”€å”®é¢
- è®¡ç®—å¹³å‡è®¢å•é‡‘é¢
- ç»Ÿè®¡è®¢å•æ•°é‡
- æŒ‰é”€å”®é¢é™åºæ’åˆ—

**æ•°æ®æ¨¡å‹**ï¼š

```mermaid
erDiagram
    Product ||--o{ OrderItem : "åŒ…å«"
    Order ||--o{ OrderItem : "åŒ…å«"
    Product {
        int product_id PK
        string product_name
        string category
        decimal price
    }
    Order {
        int order_id PK
        date order_date
        int customer_id FK
        decimal total_amount
    }
    OrderItem {
        int order_id FK
        int product_id FK
        int quantity
        decimal amount
    }
```

**æŸ¥è¯¢**ï¼š

```sql
SELECT
    product_category,
    SUM(amount) as total_sales,
    AVG(amount) as avg_sales,
    COUNT(*) as order_count,
    COUNT(DISTINCT order_id) as unique_orders,
    MAX(amount) as max_order,
    MIN(amount) as min_order
FROM Sales
GROUP BY product_category
HAVING SUM(amount) > 10000  -- åªæ˜¾ç¤ºé”€å”®é¢å¤§äº10000çš„ç±»åˆ«
ORDER BY total_sales DESC;
```

**å…³ç³»ä»£æ•°è¡¨ç¤º**ï¼š

```latex
Î³_{product_category, SUM(amount), AVG(amount), COUNT(*)}(Sales)
```

**æŸ¥è¯¢ç»“æœç¤ºä¾‹**ï¼š

```text
| product_category | total_sales | avg_sales | order_count | unique_orders | max_order | min_order |
|------------------|-------------|-----------|-------------|---------------|-----------|-----------|
| ç”µå­äº§å“        | 500000      | 5000      | 100         | 80            | 20000     | 1000      |
| æœè£…            | 300000      | 3000      | 100         | 90            | 15000     | 500       |
| å›¾ä¹¦            | 100000      | 1000      | 100         | 95            | 5000      | 200       |
```

**æ€§èƒ½ä¼˜åŒ–**ï¼š

```sql
-- åˆ›å»ºç´¢å¼•ä¼˜åŒ–GROUP BY
CREATE INDEX idx_sales_category ON Sales(product_category);
CREATE INDEX idx_sales_amount ON Sales(amount);

-- ä½¿ç”¨ç‰©åŒ–è§†å›¾ï¼ˆå¦‚æœæ•°æ®åº“æ”¯æŒï¼‰
CREATE MATERIALIZED VIEW mv_category_sales AS
SELECT
    product_category,
    SUM(amount) as total_sales,
    AVG(amount) as avg_sales,
    COUNT(*) as order_count
FROM Sales
GROUP BY product_category;
```

---

## ä¸‰ã€æ—¶é—´åºåˆ—åˆ†æ

### 3.1 æ¡ˆä¾‹ï¼šæœˆåº¦é”€å”®è¶‹åŠ¿

**æŸ¥è¯¢**ï¼š

```sql
SELECT
    DATE_TRUNC('month', sale_date) as month,
    SUM(amount) as monthly_sales,
    LAG(SUM(amount)) OVER (ORDER BY DATE_TRUNC('month', sale_date)) as prev_month_sales
FROM Sales
GROUP BY DATE_TRUNC('month', sale_date)
ORDER BY month;
```

---

## å››ã€åˆ†ç»„åˆ†æ

### 4.1 æ¡ˆä¾‹ï¼šå®¢æˆ·åˆ†ç¾¤ï¼ˆRFMæ¨¡å‹ï¼‰

**åœºæ™¯æè¿°**ï¼šç”µå•†å¹³å°ä½¿ç”¨RFMæ¨¡å‹å¯¹å®¢æˆ·è¿›è¡Œåˆ†ç¾¤ï¼Œåˆ¶å®šç²¾å‡†è¥é”€ç­–ç•¥ã€‚

**RFMæ¨¡å‹**ï¼š

- **R (Recency)**ï¼šæœ€è¿‘ä¸€æ¬¡è´­ä¹°æ—¶é—´
- **F (Frequency)**ï¼šè´­ä¹°é¢‘ç‡
- **M (Monetary)**ï¼šè´­ä¹°é‡‘é¢

**æ•°æ®æ¨¡å‹**ï¼š

```mermaid
erDiagram
    Customer ||--o{ Order : "ä¸‹å•"
    Customer {
        int customer_id PK
        string name
        string email
        date register_date
    }
    Order {
        int order_id PK
        int customer_id FK
        date order_date
        decimal total_amount
        string status
    }
```

**RFMåˆ†ç¾¤æŸ¥è¯¢**ï¼š

```sql
WITH customer_rfm AS (
    SELECT
        customer_id,
        -- R: æœ€è¿‘ä¸€æ¬¡è´­ä¹°è·ç¦»ç°åœ¨çš„å¤©æ•°
        DATEDIFF(DAY, MAX(order_date), CURRENT_DATE) as recency,
        -- F: è´­ä¹°é¢‘ç‡ï¼ˆè®¢å•æ•°ï¼‰
        COUNT(*) as frequency,
        -- M: è´­ä¹°é‡‘é¢
        SUM(total_amount) as monetary
    FROM Orders
    WHERE status = 'completed'
    GROUP BY customer_id
),
rfm_scores AS (
    SELECT
        customer_id,
        recency,
        frequency,
        monetary,
        -- Råˆ†æ•°ï¼ˆè¶Šå°è¶Šå¥½ï¼Œæœ€è¿‘è´­ä¹°å¾—åˆ†é«˜ï¼‰
        CASE
            WHEN recency <= 30 THEN 5
            WHEN recency <= 60 THEN 4
            WHEN recency <= 90 THEN 3
            WHEN recency <= 180 THEN 2
            ELSE 1
        END as r_score,
        -- Fåˆ†æ•°ï¼ˆè¶Šå¤§è¶Šå¥½ï¼‰
        CASE
            WHEN frequency >= 20 THEN 5
            WHEN frequency >= 10 THEN 4
            WHEN frequency >= 5 THEN 3
            WHEN frequency >= 2 THEN 2
            ELSE 1
        END as f_score,
        -- Måˆ†æ•°ï¼ˆè¶Šå¤§è¶Šå¥½ï¼‰
        CASE
            WHEN monetary >= 10000 THEN 5
            WHEN monetary >= 5000 THEN 4
            WHEN monetary >= 2000 THEN 3
            WHEN monetary >= 1000 THEN 2
            ELSE 1
        END as m_score
    FROM customer_rfm
)
SELECT
    customer_id,
    recency,
    frequency,
    monetary,
    r_score,
    f_score,
    m_score,
    r_score + f_score + m_score as rfm_score,
    CASE
        WHEN r_score >= 4 AND f_score >= 4 AND m_score >= 4 THEN 'VIPå®¢æˆ·'
        WHEN r_score >= 3 AND f_score >= 3 AND m_score >= 3 THEN 'é‡è¦å®¢æˆ·'
        WHEN r_score >= 2 AND f_score >= 2 THEN 'æ™®é€šå®¢æˆ·'
        WHEN r_score >= 4 AND f_score <= 2 THEN 'æ–°å®¢æˆ·'
        WHEN r_score <= 2 AND f_score >= 4 THEN 'æµå¤±å®¢æˆ·'
        ELSE 'ä½ä»·å€¼å®¢æˆ·'
    END as customer_segment
FROM rfm_scores
ORDER BY rfm_score DESC;
```

**å®¢æˆ·åˆ†ç¾¤å†³ç­–æ ‘**ï¼š

```mermaid
flowchart TD
    A[è®¡ç®—RFMåˆ†æ•°] --> B{Råˆ†æ•°}
    B -->|>=4| C{æœ€è¿‘è´­ä¹°}
    B -->|<4| D{é•¿æœŸæœªè´­ä¹°}
    C --> E{Fåˆ†æ•°}
    E -->|>=4| F{Måˆ†æ•°}
    E -->|<4| G[æ–°å®¢æˆ·]
    F -->|>=4| H[VIPå®¢æˆ·]
    F -->|<4| I[é‡è¦å®¢æˆ·]
    D --> J{Fåˆ†æ•°}
    J -->|>=4| K[æµå¤±å®¢æˆ·]
    J -->|<4| L[ä½ä»·å€¼å®¢æˆ·]
```

**å®¢æˆ·åˆ†ç¾¤çŸ©é˜µ**ï¼š

| Råˆ†æ•° | Fåˆ†æ•° | Måˆ†æ•° | å®¢æˆ·ç±»å‹ | è¥é”€ç­–ç•¥ |
|-------|-------|-------|---------|---------|
| 5 | 5 | 5 | VIPå®¢æˆ· | ä¸“å±æœåŠ¡ã€é«˜ä»·å€¼ä¼˜æƒ  |
| 4-5 | 4-5 | 4-5 | é‡è¦å®¢æˆ· | å®šæœŸä¼˜æƒ ã€ä¼šå‘˜æƒç›Š |
| 3-4 | 3-4 | 3-4 | æ™®é€šå®¢æˆ· | å¸¸è§„è¥é”€ã€æå‡å¤è´­ |
| 4-5 | 1-2 | 1-2 | æ–°å®¢æˆ· | æ–°å®¢ä¼˜æƒ ã€å¼•å¯¼å¤è´­ |
| 1-2 | 4-5 | 4-5 | æµå¤±å®¢æˆ· | å¬å›æ´»åŠ¨ã€æŒ½å›ç­–ç•¥ |
| 1-2 | 1-2 | 1-2 | ä½ä»·å€¼å®¢æˆ· | åŸºç¡€ç»´æŠ¤ã€æˆæœ¬æ§åˆ¶ |

**æŸ¥è¯¢ç»“æœç¤ºä¾‹**ï¼š

```text
| customer_id | recency | frequency | monetary | r_score | f_score | m_score | rfm_score | customer_segment |
|-------------|---------|-----------|----------|---------|---------|---------|-----------|------------------|
| 1001        | 15      | 25        | 15000    | 5       | 5       | 5       | 15        | VIPå®¢æˆ·          |
| 1002        | 45      | 12        | 8000     | 4       | 4       | 4       | 12        | é‡è¦å®¢æˆ·         |
| 1003        | 200     | 8         | 6000     | 2       | 3       | 3       | 8         | æµå¤±å®¢æˆ·         |
```

---

## äº”ã€ç›¸å…³èµ„æº

### ç›¸å…³æ–‡æ¡£

- [å¤æ‚æŸ¥è¯¢æ¡ˆä¾‹](./07.01-å¤æ‚æŸ¥è¯¢æ¡ˆä¾‹.md) - å¤æ‚æŸ¥è¯¢
- [ETLæµç¨‹æ¡ˆä¾‹](./07.03-ETLæµç¨‹æ¡ˆä¾‹.md) - ETLæŸ¥è¯¢

---

**ç»´æŠ¤è€…**: SQL Standards Team
**æœ€åæ›´æ–°**: 2025-01-16
