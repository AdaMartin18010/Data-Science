# SQLæœ€ä½³å®è·µæŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-01-15
> **ç‰ˆæœ¬**ï¼šv1.0.0
> **éš¾åº¦**ï¼šâ­â­â­â­
> **åº”ç”¨åœºæ™¯**ï¼šSQLç¼–ç è§„èŒƒã€æ•°æ®åº“è®¾è®¡ã€æ€§èƒ½è°ƒä¼˜

---

## ğŸ“‹ ç›®å½•

- [SQLæœ€ä½³å®è·µæŒ‡å—](#sqlæœ€ä½³å®è·µæŒ‡å—)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
    - [1.1 æœ€ä½³å®è·µåˆ†ç±»æ€ç»´å¯¼å›¾](#11-æœ€ä½³å®è·µåˆ†ç±»æ€ç»´å¯¼å›¾)
    - [1.2 æœ€ä½³å®è·µå¯¹æ¯”çŸ©é˜µ](#12-æœ€ä½³å®è·µå¯¹æ¯”çŸ©é˜µ)
  - [äºŒã€SQLç¼–ç æœ€ä½³å®è·µ](#äºŒsqlç¼–ç æœ€ä½³å®è·µ)
    - [2.1 å‘½åè§„èŒƒ](#21-å‘½åè§„èŒƒ)
    - [2.2 ä»£ç é£æ ¼](#22-ä»£ç é£æ ¼)
    - [2.3 æ³¨é‡Šè§„èŒƒ](#23-æ³¨é‡Šè§„èŒƒ)
    - [2.4 é”™è¯¯å¤„ç†](#24-é”™è¯¯å¤„ç†)
    - [2.5 æ€§èƒ½è€ƒè™‘](#25-æ€§èƒ½è€ƒè™‘)
  - [ä¸‰ã€æ•°æ®åº“è®¾è®¡æœ€ä½³å®è·µ](#ä¸‰æ•°æ®åº“è®¾è®¡æœ€ä½³å®è·µ)
    - [3.1 è¡¨è®¾è®¡åŸåˆ™](#31-è¡¨è®¾è®¡åŸåˆ™)
    - [3.2 ç´¢å¼•è®¾è®¡åŸåˆ™](#32-ç´¢å¼•è®¾è®¡åŸåˆ™)
    - [3.3 çº¦æŸè®¾è®¡åŸåˆ™](#33-çº¦æŸè®¾è®¡åŸåˆ™)
    - [3.4 å®‰å…¨è®¾è®¡åŸåˆ™](#34-å®‰å…¨è®¾è®¡åŸåˆ™)
  - [å››ã€æ€§èƒ½è°ƒä¼˜æœ€ä½³å®è·µ](#å››æ€§èƒ½è°ƒä¼˜æœ€ä½³å®è·µ)
    - [4.1 ç›‘æ§æŒ‡æ ‡](#41-ç›‘æ§æŒ‡æ ‡)
    - [4.2 è°ƒä¼˜æµç¨‹](#42-è°ƒä¼˜æµç¨‹)
    - [4.3 é—®é¢˜è¯Šæ–­](#43-é—®é¢˜è¯Šæ–­)
    - [4.4 ä¼˜åŒ–ç­–ç•¥](#44-ä¼˜åŒ–ç­–ç•¥)
  - [äº”ã€ç›¸å…³èµ„æº](#äº”ç›¸å…³èµ„æº)

---

## ä¸€ã€æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›SQLç¼–ç ã€æ•°æ®åº“è®¾è®¡å’Œæ€§èƒ½è°ƒä¼˜çš„æœ€ä½³å®è·µæŒ‡å—ï¼Œå¸®åŠ©å¼€å‘è€…ç¼–å†™é«˜è´¨é‡ã€é«˜æ€§èƒ½çš„SQLä»£ç ã€‚

### 1.1 æœ€ä½³å®è·µåˆ†ç±»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((SQLæœ€ä½³å®è·µ))
    SQLç¼–ç 
      å‘½åè§„èŒƒ
        è¡¨å‘½å
        åˆ—å‘½å
        ç´¢å¼•å‘½å
        å‡½æ•°å‘½å
      ä»£ç é£æ ¼
        ç¼©è¿›æ ¼å¼
        å…³é”®å­—å¤§å°å†™
        è¯­å¥åˆ†éš”
        ä»£ç ç»„ç»‡
      æ³¨é‡Šè§„èŒƒ
        å•è¡Œæ³¨é‡Š
        å¤šè¡Œæ³¨é‡Š
        æ–‡æ¡£æ³¨é‡Š
        TODOæ³¨é‡Š
      é”™è¯¯å¤„ç†
        å¼‚å¸¸æ•è·
        é”™è¯¯æ—¥å¿—
        å›æ»šæœºåˆ¶
        é”™è¯¯æç¤º
      æ€§èƒ½è€ƒè™‘
        é¿å…SELECT *
        ä½¿ç”¨ç´¢å¼•
        é¿å…N+1æŸ¥è¯¢
        æ‰¹é‡æ“ä½œ
    æ•°æ®åº“è®¾è®¡
      è¡¨è®¾è®¡åŸåˆ™
        èŒƒå¼è®¾è®¡
        åèŒƒå¼åŒ–
        æ•°æ®ç±»å‹é€‰æ‹©
        å­—æ®µè®¾è®¡
      ç´¢å¼•è®¾è®¡åŸåˆ™
        ç´¢å¼•é€‰æ‹©
        å¤åˆç´¢å¼•
        ç´¢å¼•ç»´æŠ¤
        ç´¢å¼•ç›‘æ§
      çº¦æŸè®¾è®¡åŸåˆ™
        ä¸»é”®è®¾è®¡
        å¤–é”®è®¾è®¡
        æ£€æŸ¥çº¦æŸ
        å”¯ä¸€çº¦æŸ
      å®‰å…¨è®¾è®¡åŸåˆ™
        æƒé™æ§åˆ¶
        æ•°æ®åŠ å¯†
        SQLæ³¨å…¥é˜²æŠ¤
        å®¡è®¡æ—¥å¿—
    æ€§èƒ½è°ƒä¼˜
      ç›‘æ§æŒ‡æ ‡
        æŸ¥è¯¢æ€§èƒ½
        èµ„æºä½¿ç”¨
        è¿æ¥æ•°
        é”ç­‰å¾…
      è°ƒä¼˜æµç¨‹
        é—®é¢˜è¯†åˆ«
        æ€§èƒ½åˆ†æ
        ä¼˜åŒ–å®æ–½
        æ•ˆæœéªŒè¯
      é—®é¢˜è¯Šæ–­
        æ…¢æŸ¥è¯¢åˆ†æ
        æ‰§è¡Œè®¡åˆ’åˆ†æ
        ç»Ÿè®¡ä¿¡æ¯åˆ†æ
        èµ„æºç“¶é¢ˆåˆ†æ
      ä¼˜åŒ–ç­–ç•¥
        ç´¢å¼•ä¼˜åŒ–
        æŸ¥è¯¢é‡å†™
        åˆ†åŒºç­–ç•¥
        ç¼“å­˜ç­–ç•¥
```

### 1.2 æœ€ä½³å®è·µå¯¹æ¯”çŸ©é˜µ

| å®è·µç±»åˆ« | é‡è¦æ€§ | éš¾åº¦ | å½±å“èŒƒå›´ | å®æ–½ä¼˜å…ˆçº§ |
|---------|--------|------|---------|-----------|
| **SQLç¼–ç è§„èŒƒ** | â­â­â­â­ | â­â­ | ä»£ç è´¨é‡ | P0 |
| **æ•°æ®åº“è®¾è®¡** | â­â­â­â­â­ | â­â­â­â­ | ç³»ç»Ÿæ€§èƒ½ | P0 |
| **æ€§èƒ½è°ƒä¼˜** | â­â­â­â­â­ | â­â­â­â­â­ | ç³»ç»Ÿæ€§èƒ½ | P1 |

---

## äºŒã€SQLç¼–ç æœ€ä½³å®è·µ

### 2.1 å‘½åè§„èŒƒ

#### 2.1.1 è¡¨å‘½åè§„èŒƒ

**åŸåˆ™**ï¼š

- ä½¿ç”¨å¤æ•°å½¢å¼æˆ–å•æ•°å½¢å¼ï¼ˆä¿æŒä¸€è‡´æ€§ï¼‰
- ä½¿ç”¨ä¸‹åˆ’çº¿åˆ†éš”å•è¯
- é¿å…ä½¿ç”¨SQLå…³é”®å­—
- è¡¨ååº”å…·æœ‰æè¿°æ€§

**ç¤ºä¾‹**ï¼š

```sql
-- âœ… å¥½çš„å‘½å
CREATE TABLE users (...);
CREATE TABLE order_items (...);
CREATE TABLE product_categories (...);

-- âŒ ä¸å¥½çš„å‘½å
CREATE TABLE user (...);  -- å•å¤æ•°ä¸ä¸€è‡´
CREATE TABLE OrderItems (...);  -- é©¼å³°å‘½åï¼ˆä¸ç»Ÿä¸€ï¼‰
CREATE TABLE tbl_users (...);  -- ä¸å¿…è¦çš„å‰ç¼€
CREATE TABLE select (...);  -- SQLå…³é”®å­—
```

#### 2.1.2 åˆ—å‘½åè§„èŒƒ

**åŸåˆ™**ï¼š

- ä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿
- åˆ—ååº”å…·æœ‰æè¿°æ€§
- å¸ƒå°”ç±»å‹ä½¿ç”¨is_ã€has_ã€can_ç­‰å‰ç¼€
- å¤–é”®åˆ—ååº”ä¸è¢«å¼•ç”¨è¡¨çš„ä¸»é”®åˆ—åä¸€è‡´

**ç¤ºä¾‹**ï¼š

```sql
-- âœ… å¥½çš„å‘½å
CREATE TABLE users (
    user_id INTEGER PRIMARY KEY,
    first_name VARCHAR(50),
    last_name VARCHAR(50),
    email_address VARCHAR(100),
    is_active BOOLEAN,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- âŒ ä¸å¥½çš„å‘½å
CREATE TABLE users (
    id INTEGER PRIMARY KEY,  -- ä¸å¤Ÿæè¿°æ€§
    name VARCHAR(50),  -- ä¸å¤Ÿå…·ä½“
    email VARCHAR(100),  -- å¯ä»¥ï¼Œä½†email_addressæ›´å¥½
    active BOOLEAN,  -- åº”è¯¥ç”¨is_active
    date TIMESTAMP  -- ä¸å¤Ÿæè¿°æ€§
);
```

#### 2.1.3 ç´¢å¼•å‘½åè§„èŒƒ

**åŸåˆ™**ï¼š

- ä½¿ç”¨idx_å‰ç¼€
- åŒ…å«è¡¨åå’Œåˆ—å
- å”¯ä¸€ç´¢å¼•ä½¿ç”¨uk_å‰ç¼€
- å¤–é”®ç´¢å¼•ä½¿ç”¨fk_å‰ç¼€

**ç¤ºä¾‹**ï¼š

```sql
-- âœ… å¥½çš„å‘½å
CREATE INDEX idx_users_email ON users(email);
CREATE UNIQUE INDEX uk_users_email ON users(email);
CREATE INDEX idx_order_items_order_id ON order_items(order_id);
CREATE INDEX fk_orders_user_id ON orders(user_id);

-- âŒ ä¸å¥½çš„å‘½å
CREATE INDEX email ON users(email);  -- ç¼ºå°‘å‰ç¼€
CREATE INDEX idx1 ON users(email);  -- ä¸å¤Ÿæè¿°æ€§
```

### 2.2 ä»£ç é£æ ¼

#### 2.2.1 ç¼©è¿›æ ¼å¼

**åŸåˆ™**ï¼š

- ä½¿ç”¨4ä¸ªç©ºæ ¼æˆ–2ä¸ªç©ºæ ¼ç¼©è¿›ï¼ˆä¿æŒä¸€è‡´æ€§ï¼‰
- å…³é”®å­—å¤§å†™
- å­å¥æ¢è¡Œå¯¹é½

**ç¤ºä¾‹**ï¼š

```sql
-- âœ… å¥½çš„æ ¼å¼
SELECT
    u.user_id,
    u.username,
    u.email,
    COUNT(o.order_id) as order_count
FROM users u
LEFT JOIN orders o ON u.user_id = o.user_id
WHERE u.is_active = TRUE
  AND u.created_at >= '2024-01-01'
GROUP BY u.user_id, u.username, u.email
HAVING COUNT(o.order_id) > 0
ORDER BY order_count DESC
LIMIT 10;

-- âŒ ä¸å¥½çš„æ ¼å¼
SELECT u.user_id, u.username, u.email, COUNT(o.order_id) as order_count FROM users u LEFT JOIN orders o ON u.user_id = o.user_id WHERE u.is_active = TRUE AND u.created_at >= '2024-01-01' GROUP BY u.user_id, u.username, u.email HAVING COUNT(o.order_id) > 0 ORDER BY order_count DESC LIMIT 10;
```

#### 2.2.2 å…³é”®å­—å¤§å°å†™

**åŸåˆ™**ï¼š

- SQLå…³é”®å­—ä½¿ç”¨å¤§å†™ï¼ˆSELECT, FROM, WHEREç­‰ï¼‰
- è¡¨åå’Œåˆ—åä½¿ç”¨å°å†™
- å‡½æ•°åä½¿ç”¨å¤§å†™ï¼ˆCOUNT, SUM, AVGç­‰ï¼‰

**ç¤ºä¾‹**ï¼š

```sql
-- âœ… å¥½çš„é£æ ¼
SELECT
    user_id,
    username,
    COUNT(*) as total
FROM users
WHERE is_active = TRUE
GROUP BY user_id, username
ORDER BY total DESC;

-- âŒ ä¸å¥½çš„é£æ ¼
select user_id, username, count(*) as total from users where is_active = true group by user_id, username order by total desc;
```

#### 2.2.3 ä»£ç ç»„ç»‡

**åŸåˆ™**ï¼š

- å¤æ‚æŸ¥è¯¢ä½¿ç”¨CTEåˆ†è§£
- ç›¸å…³æŸ¥è¯¢åˆ†ç»„
- ä½¿ç”¨æ³¨é‡Šè¯´æ˜å¤æ‚é€»è¾‘

**ç¤ºä¾‹**ï¼š

```sql
-- âœ… å¥½çš„ç»„ç»‡
WITH active_users AS (
    SELECT user_id, username, email
    FROM users
    WHERE is_active = TRUE
),
user_orders AS (
    SELECT
        u.user_id,
        COUNT(o.order_id) as order_count,
        SUM(o.total_amount) as total_spent
    FROM active_users u
    LEFT JOIN orders o ON u.user_id = o.user_id
    GROUP BY u.user_id
)
SELECT
    u.user_id,
    u.username,
    u.email,
    uo.order_count,
    uo.total_spent
FROM active_users u
JOIN user_orders uo ON u.user_id = uo.user_id
ORDER BY uo.total_spent DESC;
```

### 2.3 æ³¨é‡Šè§„èŒƒ

#### 2.3.1 å•è¡Œæ³¨é‡Š

**åŸåˆ™**ï¼š

- ä½¿ç”¨`--`è¿›è¡Œå•è¡Œæ³¨é‡Š
- æ³¨é‡Šåº”è§£é‡Š"ä¸ºä»€ä¹ˆ"è€Œä¸æ˜¯"åšä»€ä¹ˆ"
- å¤æ‚é€»è¾‘å¿…é¡»æ·»åŠ æ³¨é‡Š

**ç¤ºä¾‹**ï¼š

```sql
-- æŸ¥è¯¢æ´»è·ƒç”¨æˆ·åœ¨è¿‡å»30å¤©çš„è®¢å•ç»Ÿè®¡
-- åªç»Ÿè®¡å·²å®Œæˆå’Œå·²æ”¯ä»˜çš„è®¢å•
SELECT
    u.user_id,
    u.username,
    COUNT(o.order_id) as order_count,
    SUM(o.total_amount) as total_spent
FROM users u
LEFT JOIN orders o ON u.user_id = o.user_id
WHERE u.is_active = TRUE
  AND o.status IN ('completed', 'paid')  -- æ’é™¤å–æ¶ˆå’Œå¾…æ”¯ä»˜çš„è®¢å•
  AND o.order_date >= DATE_SUB(CURRENT_DATE, INTERVAL 30 DAY)
GROUP BY u.user_id, u.username;
```

#### 2.3.2 å¤šè¡Œæ³¨é‡Š

**åŸåˆ™**ï¼š

- ä½¿ç”¨`/* */`è¿›è¡Œå¤šè¡Œæ³¨é‡Š
- ç”¨äºå‡½æ•°ã€å­˜å‚¨è¿‡ç¨‹çš„æ–‡æ¡£è¯´æ˜
- åŒ…å«å‚æ•°è¯´æ˜ã€è¿”å›å€¼è¯´æ˜ã€ç¤ºä¾‹

**ç¤ºä¾‹**ï¼š

```sql
/*
 * å‡½æ•°ï¼šè®¡ç®—ç”¨æˆ·çš„æ€»æ¶ˆè´¹é‡‘é¢
 *
 * å‚æ•°ï¼š
 *   @user_id: ç”¨æˆ·ID
 *   @start_date: å¼€å§‹æ—¥æœŸï¼ˆå¯é€‰ï¼‰
 *   @end_date: ç»“æŸæ—¥æœŸï¼ˆå¯é€‰ï¼‰
 *
 * è¿”å›ï¼š
 *   ç”¨æˆ·çš„æ€»æ¶ˆè´¹é‡‘é¢
 *
 * ç¤ºä¾‹ï¼š
 *   SELECT calculate_user_total_spent(1, '2024-01-01', '2024-12-31');
 */
CREATE FUNCTION calculate_user_total_spent(
    user_id INT,
    start_date DATE DEFAULT NULL,
    end_date DATE DEFAULT NULL
) RETURNS DECIMAL(10,2)
BEGIN
    -- å‡½æ•°å®ç°
END;
```

### 2.4 é”™è¯¯å¤„ç†

#### 2.4.1 å¼‚å¸¸æ•è·

**åŸåˆ™**ï¼š

- ä½¿ç”¨TRY-CATCHå—å¤„ç†å¼‚å¸¸
- è®°å½•é”™è¯¯æ—¥å¿—
- æä¾›æœ‰æ„ä¹‰çš„é”™è¯¯æ¶ˆæ¯

**ç¤ºä¾‹**ï¼š

```sql
-- SQL Server
BEGIN TRY
    BEGIN TRANSACTION;

    UPDATE accounts
    SET balance = balance - 1000
    WHERE account_id = 1;

    UPDATE accounts
    SET balance = balance + 1000
    WHERE account_id = 2;

    COMMIT TRANSACTION;
END TRY
BEGIN CATCH
    IF @@TRANCOUNT > 0
        ROLLBACK TRANSACTION;

    -- è®°å½•é”™è¯¯æ—¥å¿—
    INSERT INTO error_log (error_message, error_time)
    VALUES (ERROR_MESSAGE(), CURRENT_TIMESTAMP);

    -- æŠ›å‡ºé”™è¯¯
    THROW;
END CATCH;
```

#### 2.4.2 æ•°æ®éªŒè¯

**åŸåˆ™**ï¼š

- åœ¨åº”ç”¨å±‚å’Œæ•°æ®åº“å±‚éƒ½è¿›è¡ŒéªŒè¯
- ä½¿ç”¨çº¦æŸç¡®ä¿æ•°æ®å®Œæ•´æ€§
- æä¾›æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯

**ç¤ºä¾‹**ï¼š

```sql
-- ä½¿ç”¨çº¦æŸè¿›è¡Œæ•°æ®éªŒè¯
CREATE TABLE users (
    user_id INTEGER PRIMARY KEY,
    email VARCHAR(100) NOT NULL,
    age INTEGER CHECK (age >= 0 AND age <= 150),
    CONSTRAINT chk_email_format CHECK (email LIKE '%@%')
);

-- æ’å…¥å‰éªŒè¯
INSERT INTO users (email, age)
VALUES ('invalid-email', 200);  -- âŒ è¿åçº¦æŸ
```

### 2.5 æ€§èƒ½è€ƒè™‘

#### 2.5.1 é¿å…SELECT *

**åŸåˆ™**ï¼š

- åªé€‰æ‹©éœ€è¦çš„åˆ—
- å‡å°‘æ•°æ®ä¼ è¾“é‡
- æé«˜æŸ¥è¯¢æ€§èƒ½

**ç¤ºä¾‹**ï¼š

```sql
-- âŒ ä¸å¥½çš„åšæ³•
SELECT * FROM users WHERE user_id = 1;

-- âœ… å¥½çš„åšæ³•
SELECT user_id, username, email FROM users WHERE user_id = 1;
```

#### 2.5.2 ä½¿ç”¨ç´¢å¼•

**åŸåˆ™**ï¼š

- ä¸ºWHEREã€JOINã€ORDER BYå­å¥ä¸­çš„åˆ—åˆ›å»ºç´¢å¼•
- é¿å…åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨å‡½æ•°
- ä½¿ç”¨è¦†ç›–ç´¢å¼•å‡å°‘å›è¡¨

**ç¤ºä¾‹**ï¼š

```sql
-- âŒ ä¸å¥½çš„åšæ³•ï¼ˆç´¢å¼•å¤±æ•ˆï¼‰
SELECT * FROM users WHERE UPPER(email) = 'USER@EXAMPLE.COM';

-- âœ… å¥½çš„åšæ³•
SELECT * FROM users WHERE email = 'user@example.com';

-- å¦‚æœéœ€è¦å¤§å°å†™ä¸æ•æ„Ÿï¼Œä½¿ç”¨å‡½æ•°ç´¢å¼•
CREATE INDEX idx_users_email_upper ON users(UPPER(email));
SELECT * FROM users WHERE UPPER(email) = 'USER@EXAMPLE.COM';
```

#### 2.5.3 é¿å…N+1æŸ¥è¯¢

**åŸåˆ™**ï¼š

- ä½¿ç”¨JOINä»£æ›¿å¤šæ¬¡æŸ¥è¯¢
- ä½¿ç”¨INä»£æ›¿å¾ªç¯æŸ¥è¯¢
- æ‰¹é‡æŸ¥è¯¢ä»£æ›¿é€æ¡æŸ¥è¯¢

**ç¤ºä¾‹**ï¼š

```sql
-- âŒ ä¸å¥½çš„åšæ³•ï¼ˆN+1æŸ¥è¯¢ï¼‰
-- åº”ç”¨å±‚å¾ªç¯
FOR EACH user_id IN user_list:
    SELECT * FROM orders WHERE user_id = user_id;

-- âœ… å¥½çš„åšæ³•ï¼ˆä¸€æ¬¡æŸ¥è¯¢ï¼‰
SELECT * FROM orders WHERE user_id IN (1, 2, 3, 4, 5);
```

#### 2.5.4 æ‰¹é‡æ“ä½œ

**åŸåˆ™**ï¼š

- ä½¿ç”¨æ‰¹é‡INSERTä»£æ›¿é€æ¡INSERT
- ä½¿ç”¨æ‰¹é‡UPDATEä»£æ›¿é€æ¡UPDATE
- ä½¿ç”¨äº‹åŠ¡åŒ…è£…æ‰¹é‡æ“ä½œ

**ç¤ºä¾‹**ï¼š

```sql
-- âŒ ä¸å¥½çš„åšæ³•
INSERT INTO users (username, email) VALUES ('user1', 'user1@example.com');
INSERT INTO users (username, email) VALUES ('user2', 'user2@example.com');
INSERT INTO users (username, email) VALUES ('user3', 'user3@example.com');

-- âœ… å¥½çš„åšæ³•
INSERT INTO users (username, email) VALUES
    ('user1', 'user1@example.com'),
    ('user2', 'user2@example.com'),
    ('user3', 'user3@example.com');
```

---

## ä¸‰ã€æ•°æ®åº“è®¾è®¡æœ€ä½³å®è·µ

### 3.1 è¡¨è®¾è®¡åŸåˆ™

#### 3.1.1 èŒƒå¼è®¾è®¡

**åŸåˆ™**ï¼š

- è‡³å°‘æ»¡è¶³3NF
- æ ¹æ®ä¸šåŠ¡éœ€æ±‚å†³å®šæ˜¯å¦ä½¿ç”¨BCNF
- è€ƒè™‘æŸ¥è¯¢æ€§èƒ½ï¼Œå¿…è¦æ—¶åèŒƒå¼åŒ–

**ç¤ºä¾‹**ï¼š

```sql
-- âœ… ç¬¦åˆ3NFçš„è®¾è®¡
CREATE TABLE users (
    user_id INTEGER PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE
);

CREATE TABLE orders (
    order_id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    order_date DATE NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);

CREATE TABLE order_items (
    order_id INTEGER NOT NULL,
    product_id INTEGER NOT NULL,
    quantity INTEGER NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    PRIMARY KEY (order_id, product_id),
    FOREIGN KEY (order_id) REFERENCES orders(order_id)
);
```

#### 3.1.2 æ•°æ®ç±»å‹é€‰æ‹©

**åŸåˆ™**ï¼š

- é€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹
- é¿å…è¿‡åº¦ä½¿ç”¨VARCHAR
- ä½¿ç”¨DECIMALå¤„ç†é‡‘é¢
- ä½¿ç”¨TIMESTAMPå¤„ç†æ—¶é—´

**ç¤ºä¾‹**ï¼š

```sql
-- âœ… å¥½çš„æ•°æ®ç±»å‹é€‰æ‹©
CREATE TABLE products (
    product_id INTEGER PRIMARY KEY,
    product_name VARCHAR(100) NOT NULL,
    price DECIMAL(10,2) NOT NULL,  -- é‡‘é¢ä½¿ç”¨DECIMAL
    stock_quantity INTEGER NOT NULL,  -- æ•´æ•°ä½¿ç”¨INTEGER
    is_active BOOLEAN NOT NULL DEFAULT TRUE,  -- å¸ƒå°”å€¼ä½¿ç”¨BOOLEAN
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,  -- æ—¶é—´ä½¿ç”¨TIMESTAMP
    description TEXT  -- é•¿æ–‡æœ¬ä½¿ç”¨TEXT
);

-- âŒ ä¸å¥½çš„æ•°æ®ç±»å‹é€‰æ‹©
CREATE TABLE products (
    product_id VARCHAR(50) PRIMARY KEY,  -- IDåº”è¯¥ç”¨INTEGER
    price VARCHAR(20),  -- é‡‘é¢åº”è¯¥ç”¨DECIMAL
    stock_quantity VARCHAR(10),  -- æ•°é‡åº”è¯¥ç”¨INTEGER
    is_active VARCHAR(5),  -- å¸ƒå°”å€¼åº”è¯¥ç”¨BOOLEAN
    created_at VARCHAR(50)  -- æ—¶é—´åº”è¯¥ç”¨TIMESTAMP
);
```

### 3.2 ç´¢å¼•è®¾è®¡åŸåˆ™

#### 3.2.1 ç´¢å¼•é€‰æ‹©å†³ç­–æ ‘

```mermaid
flowchart TD
    A[éœ€è¦åˆ›å»ºç´¢å¼•?] --> B{åˆ—çš„ä½¿ç”¨åœºæ™¯}
    B -->|WHEREæ¡ä»¶| C[åˆ›å»ºç´¢å¼•]
    B -->|JOINæ¡ä»¶| C
    B -->|ORDER BY| D{æ˜¯å¦é¢‘ç¹æ’åº?}
    B -->|GROUP BY| E{æ˜¯å¦é¢‘ç¹åˆ†ç»„?}
    B -->|SELECT| F[ä¸åˆ›å»ºç´¢å¼•]

    D -->|æ˜¯| C
    D -->|å¦| F
    E -->|æ˜¯| C
    E -->|å¦| F

    C --> G{åˆ—çš„é€‰æ‹©æ€§}
    G -->|é«˜é€‰æ‹©æ€§| H[åˆ›å»ºB-treeç´¢å¼•]
    G -->|ä½é€‰æ‹©æ€§| I{åˆ—çš„å”¯ä¸€å€¼æ•°é‡}
    I -->|å¾ˆå°‘| J[è€ƒè™‘ä½å›¾ç´¢å¼•]
    I -->|å¾ˆå¤š| H

    H --> K{æ˜¯å¦é¢‘ç¹æ›´æ–°?}
    K -->|æ˜¯| L[è°¨æ…åˆ›å»ºç´¢å¼•]
    K -->|å¦| M[åˆ›å»ºç´¢å¼•]
```

#### 3.2.2 å¤åˆç´¢å¼•è®¾è®¡

**åŸåˆ™**ï¼š

- éµå¾ªæœ€å·¦å‰ç¼€åŸåˆ™
- å°†é€‰æ‹©æ€§é«˜çš„åˆ—æ”¾åœ¨å‰é¢
- è€ƒè™‘æŸ¥è¯¢æ¨¡å¼

**ç¤ºä¾‹**ï¼š

```sql
-- âœ… å¥½çš„å¤åˆç´¢å¼•è®¾è®¡
-- æŸ¥è¯¢ï¼šWHERE user_id = ? AND order_date >= ? ORDER BY order_date DESC
CREATE INDEX idx_orders_user_date ON orders(user_id, order_date DESC);

-- âŒ ä¸å¥½çš„å¤åˆç´¢å¼•è®¾è®¡
-- å¦‚æœæŸ¥è¯¢åªæœ‰order_dateæ¡ä»¶ï¼Œç´¢å¼•æ— æ³•ä½¿ç”¨
CREATE INDEX idx_orders_date_user ON orders(order_date, user_id);
```

### 3.3 çº¦æŸè®¾è®¡åŸåˆ™

#### 3.3.1 ä¸»é”®è®¾è®¡

**åŸåˆ™**ï¼š

- æ¯ä¸ªè¡¨å¿…é¡»æœ‰ä¸»é”®
- ä¸»é”®åº”è¯¥æ˜¯ç¨³å®šçš„ã€ä¸å¯å˜çš„
- ä¼˜å…ˆä½¿ç”¨è‡ªå¢æ•´æ•°æˆ–UUID

**ç¤ºä¾‹**ï¼š

```sql
-- âœ… å¥½çš„ä¸»é”®è®¾è®¡
CREATE TABLE users (
    user_id INTEGER PRIMARY KEY AUTO_INCREMENT,  -- è‡ªå¢ä¸»é”®
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE
);

-- âŒ ä¸å¥½çš„ä¸»é”®è®¾è®¡
CREATE TABLE users (
    username VARCHAR(50) PRIMARY KEY,  -- ç”¨æˆ·åå¯èƒ½æ”¹å˜
    email VARCHAR(100) NOT NULL
);
```

#### 3.3.2 å¤–é”®è®¾è®¡

**åŸåˆ™**ï¼š

- ä¸ºæ‰€æœ‰å¤–é”®å…³ç³»åˆ›å»ºå¤–é”®çº¦æŸ
- è®¾ç½®åˆé€‚çš„çº§è”æ“ä½œ
- åˆ›å»ºå¤–é”®ç´¢å¼•

**ç¤ºä¾‹**ï¼š

```sql
-- âœ… å¥½çš„å¤–é”®è®¾è®¡
CREATE TABLE orders (
    order_id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(user_id)
        ON DELETE RESTRICT  -- é˜²æ­¢åˆ é™¤æœ‰è®¢å•çš„ç”¨æˆ·
        ON UPDATE CASCADE,  -- ç”¨æˆ·IDæ›´æ–°æ—¶çº§è”æ›´æ–°
    INDEX idx_orders_user_id (user_id)  -- ä¸ºå¤–é”®åˆ›å»ºç´¢å¼•
);
```

### 3.4 å®‰å…¨è®¾è®¡åŸåˆ™

#### 3.4.1 SQLæ³¨å…¥é˜²æŠ¤

**åŸåˆ™**ï¼š

- ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
- éªŒè¯å’Œæ¸…ç†ç”¨æˆ·è¾“å…¥
- ä½¿ç”¨æœ€å°æƒé™åŸåˆ™

**ç¤ºä¾‹**ï¼š

```sql
-- âŒ ä¸å¥½çš„åšæ³•ï¼ˆSQLæ³¨å…¥é£é™©ï¼‰
-- åº”ç”¨å±‚ä»£ç 
query = "SELECT * FROM users WHERE username = '" + user_input + "'";

-- âœ… å¥½çš„åšæ³•ï¼ˆå‚æ•°åŒ–æŸ¥è¯¢ï¼‰
-- åº”ç”¨å±‚ä»£ç 
query = "SELECT * FROM users WHERE username = ?";
parameters = [user_input];
```

#### 3.4.2 æƒé™æ§åˆ¶

**åŸåˆ™**ï¼š

- ä½¿ç”¨æœ€å°æƒé™åŸåˆ™
- ä¸ºä¸åŒè§’è‰²åˆ›å»ºä¸åŒçš„ç”¨æˆ·
- å®šæœŸå®¡æŸ¥æƒé™

**ç¤ºä¾‹**ï¼š

```sql
-- åˆ›å»ºåªè¯»ç”¨æˆ·
CREATE USER readonly_user IDENTIFIED BY 'password';
GRANT SELECT ON database_name.* TO readonly_user;

-- åˆ›å»ºåº”ç”¨ç”¨æˆ·ï¼ˆåªæœ‰å¿…è¦çš„æƒé™ï¼‰
CREATE USER app_user IDENTIFIED BY 'password';
GRANT SELECT, INSERT, UPDATE ON database_name.orders TO app_user;
GRANT SELECT ON database_name.users TO app_user;
```

---

## å››ã€æ€§èƒ½è°ƒä¼˜æœ€ä½³å®è·µ

### 4.1 ç›‘æ§æŒ‡æ ‡

#### 4.1.1 æŸ¥è¯¢æ€§èƒ½æŒ‡æ ‡

**å…³é”®æŒ‡æ ‡**ï¼š

- æŸ¥è¯¢æ‰§è¡Œæ—¶é—´
- æŸ¥è¯¢é¢‘ç‡
- æ…¢æŸ¥è¯¢æ•°é‡
- ç´¢å¼•ä½¿ç”¨ç‡

**ç›‘æ§æŸ¥è¯¢**ï¼š

```sql
-- PostgreSQL: æŸ¥è¯¢æ…¢æŸ¥è¯¢
SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    max_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;

-- MySQL: æŸ¥è¯¢æ…¢æŸ¥è¯¢æ—¥å¿—
SELECT * FROM mysql.slow_log
ORDER BY start_time DESC
LIMIT 10;
```

#### 4.1.2 èµ„æºä½¿ç”¨æŒ‡æ ‡

**å…³é”®æŒ‡æ ‡**ï¼š

- CPUä½¿ç”¨ç‡
- å†…å­˜ä½¿ç”¨ç‡
- ç£ç›˜I/O
- è¿æ¥æ•°

**ç›‘æ§æŸ¥è¯¢**ï¼š

```sql
-- PostgreSQL: æŸ¥è¯¢è¿æ¥æ•°
SELECT
    count(*) as total_connections,
    count(*) FILTER (WHERE state = 'active') as active_connections,
    count(*) FILTER (WHERE state = 'idle') as idle_connections
FROM pg_stat_activity;

-- MySQL: æŸ¥è¯¢è¿æ¥æ•°
SHOW STATUS LIKE 'Threads_connected';
SHOW STATUS LIKE 'Threads_running';
```

### 4.2 è°ƒä¼˜æµç¨‹

#### 4.2.1 æ€§èƒ½è°ƒä¼˜å†³ç­–æ ‘

```mermaid
flowchart TD
    A[æ€§èƒ½é—®é¢˜] --> B{é—®é¢˜ç±»å‹}
    B -->|æ…¢æŸ¥è¯¢| C[åˆ†ææ‰§è¡Œè®¡åˆ’]
    B -->|é«˜èµ„æº| D[åˆ†æèµ„æºä½¿ç”¨]
    B -->|é”ç­‰å¾…| E[åˆ†æé”æƒ…å†µ]

    C --> F{æ˜¯å¦æœ‰ç´¢å¼•?}
    F -->|å¦| G[åˆ›å»ºç´¢å¼•]
    F -->|æ˜¯| H{ç´¢å¼•æ˜¯å¦ä½¿ç”¨?}
    H -->|å¦| I[ä¼˜åŒ–æŸ¥è¯¢]
    H -->|æ˜¯| J[åˆ†æç»Ÿè®¡ä¿¡æ¯]

    D --> K{CPUé«˜?}
    K -->|æ˜¯| L[ä¼˜åŒ–æŸ¥è¯¢]
    K -->|å¦| M{å†…å­˜é«˜?}
    M -->|æ˜¯| N[ä¼˜åŒ–ç¼“å­˜]
    M -->|å¦| O{ç£ç›˜I/Oé«˜?}
    O -->|æ˜¯| P[ä¼˜åŒ–ç´¢å¼•/åˆ†åŒº]

    E --> Q[åˆ†æé”ç­‰å¾…]
    Q --> R[ä¼˜åŒ–äº‹åŠ¡]
    R --> S[å‡å°‘é”æŒæœ‰æ—¶é—´]

    G --> T[éªŒè¯æ•ˆæœ]
    I --> T
    J --> T
    L --> T
    N --> T
    P --> T
    S --> T
```

#### 4.2.2 è°ƒä¼˜æ­¥éª¤

**æ­¥éª¤**ï¼š

1. è¯†åˆ«æ€§èƒ½é—®é¢˜
2. æ”¶é›†æ€§èƒ½æ•°æ®
3. åˆ†æé—®é¢˜åŸå› 
4. åˆ¶å®šä¼˜åŒ–æ–¹æ¡ˆ
5. å®æ–½ä¼˜åŒ–
6. éªŒè¯æ•ˆæœ
7. ç›‘æ§æŒç»­æ”¹è¿›

**ç¤ºä¾‹**ï¼š

```sql
-- æ­¥éª¤1: è¯†åˆ«æ…¢æŸ¥è¯¢
SELECT query, mean_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 1000  -- æ‰§è¡Œæ—¶é—´è¶…è¿‡1ç§’
ORDER BY mean_exec_time DESC;

-- æ­¥éª¤2: åˆ†ææ‰§è¡Œè®¡åˆ’
EXPLAIN ANALYZE
SELECT * FROM orders o
JOIN users u ON o.user_id = u.user_id
WHERE o.order_date >= '2024-01-01';

-- æ­¥éª¤3: åˆ›å»ºç´¢å¼•
CREATE INDEX idx_orders_user_date ON orders(user_id, order_date);

-- æ­¥éª¤4: éªŒè¯æ•ˆæœ
EXPLAIN ANALYZE
SELECT * FROM orders o
JOIN users u ON o.user_id = u.user_id
WHERE o.order_date >= '2024-01-01';
```

### 4.3 é—®é¢˜è¯Šæ–­

#### 4.3.1 æ…¢æŸ¥è¯¢åˆ†æ

**åˆ†ææ–¹æ³•**ï¼š

- ä½¿ç”¨EXPLAINåˆ†ææ‰§è¡Œè®¡åˆ’
- æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
- åˆ†æè¡¨æ‰«ææƒ…å†µ
- æ£€æŸ¥è¿æ¥é¡ºåº

**ç¤ºä¾‹**ï¼š

```sql
-- åˆ†ææ…¢æŸ¥è¯¢
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT
    u.user_id,
    u.username,
    COUNT(o.order_id) as order_count
FROM users u
LEFT JOIN orders o ON u.user_id = o.user_id
WHERE u.created_at >= '2024-01-01'
GROUP BY u.user_id, u.username
HAVING COUNT(o.order_id) > 10;

-- å¦‚æœçœ‹åˆ°Seq Scanï¼Œè€ƒè™‘åˆ›å»ºç´¢å¼•
CREATE INDEX idx_users_created_at ON users(created_at);
CREATE INDEX idx_orders_user_id ON orders(user_id);
```

#### 4.3.2 ç»Ÿè®¡ä¿¡æ¯åˆ†æ

**åŸåˆ™**ï¼š

- å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
- æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯å‡†ç¡®æ€§
- åˆ†ææ•°æ®åˆ†å¸ƒ

**ç¤ºä¾‹**ï¼š

```sql
-- PostgreSQL: æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE users;
ANALYZE orders;

-- æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
SELECT
    schemaname,
    tablename,
    n_live_tup,
    n_dead_tup,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
WHERE tablename IN ('users', 'orders');
```

### 4.4 ä¼˜åŒ–ç­–ç•¥

#### 4.4.1 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥

**ç­–ç•¥**ï¼š

- ä¸ºé¢‘ç¹æŸ¥è¯¢çš„åˆ—åˆ›å»ºç´¢å¼•
- ä½¿ç”¨è¦†ç›–ç´¢å¼•å‡å°‘å›è¡¨
- å®šæœŸç»´æŠ¤ç´¢å¼•
- åˆ é™¤æœªä½¿ç”¨çš„ç´¢å¼•

**ç¤ºä¾‹**ï¼š

```sql
-- åˆ›å»ºè¦†ç›–ç´¢å¼•
CREATE INDEX idx_orders_covering ON orders(user_id, order_date, total_amount);

-- æŸ¥è¯¢å¯ä»¥ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œæ— éœ€å›è¡¨
SELECT user_id, order_date, total_amount
FROM orders
WHERE user_id = 1
ORDER BY order_date DESC;
```

#### 4.4.2 æŸ¥è¯¢é‡å†™ç­–ç•¥

**ç­–ç•¥**ï¼š

- å°†å­æŸ¥è¯¢è½¬æ¢ä¸ºJOIN
- ä½¿ç”¨çª—å£å‡½æ•°ä»£æ›¿ç›¸å…³å­æŸ¥è¯¢
- åˆå¹¶å¤šä¸ªæŸ¥è¯¢
- ä½¿ç”¨CTEæé«˜å¯è¯»æ€§

**ç¤ºä¾‹**ï¼š

```sql
-- âŒ åŸå§‹æŸ¥è¯¢ï¼ˆç›¸å…³å­æŸ¥è¯¢ï¼‰
SELECT
    u.user_id,
    u.username,
    (SELECT COUNT(*) FROM orders WHERE user_id = u.user_id) as order_count
FROM users u;

-- âœ… ä¼˜åŒ–åï¼ˆLEFT JOINï¼‰
SELECT
    u.user_id,
    u.username,
    COUNT(o.order_id) as order_count
FROM users u
LEFT JOIN orders o ON u.user_id = o.user_id
GROUP BY u.user_id, u.username;
```

---

## äº”ã€ç›¸å…³èµ„æº

### ç›¸å…³æ–‡æ¡£

- [å¤æ‚æŸ¥è¯¢æ¡ˆä¾‹](./07.01-å¤æ‚æŸ¥è¯¢æ¡ˆä¾‹.md) - å¤æ‚æŸ¥è¯¢è®¾è®¡
- [æ•°æ®åˆ†ææ¡ˆä¾‹](./07.02-æ•°æ®åˆ†ææ¡ˆä¾‹.md) - æ•°æ®åˆ†æå®è·µ
- [ä¸šåŠ¡åœºæ™¯å®Œæ•´æŒ‡å—](./07.04-ä¸šåŠ¡åœºæ™¯å®Œæ•´æŒ‡å—.md) - ä¸šåŠ¡åœºæ™¯å®è·µ

---

**ç»´æŠ¤è€…**: SQL Standards Team
**æœ€åæ›´æ–°**: 2025-01-15
