# 云数据库最佳实践（AWS-Azure-GCP）

> **创建日期**: 2025-12-05
> **云厂商**: AWS/Azure/GCP
> **难度**: ⭐⭐⭐⭐⭐

---

## AWS RDS/Aurora最佳实践

### RDS配置优化

```text
RDS PostgreSQL配置决策树
══════════════════════════════════════════════════════════════════════════════

问题: 选择实例类型？
    │
    ├─ 工作负载类型？
    │   ├─ 内存密集（大查询）→ r6i (内存优化)
    │   │   • r6i.2xlarge: 8 vCPU, 64GB RAM
    │   │   • 适合：复杂JOIN、大量聚合
    │   │
    │   ├─ CPU密集（高并发）→ c6i (计算优化)
    │   │   • c6i.4xlarge: 16 vCPU, 32GB RAM
    │   │   • 适合：简单查询、高QPS
    │   │
    │   ├─ 均衡负载 → m6i (通用)
    │   │   • m6i.2xlarge: 8 vCPU, 32GB RAM
    │   │   • 适合：Web应用
    │   │
    │   └─ 突发流量 → t4g (可突发)
    │       • t4g.medium: 2 vCPU, 4GB RAM
    │       • 适合：开发/测试环境
    │
    ├─ 存储类型？
    │   ├─ 通用SSD（gp3）→ 大多数场景
    │   │   • IOPS: 3,000-16,000
    │   │   • 吞吐: 125-1,000 MB/s
    │   │   • 成本: $0.115/GB-month
    │   │
    │   ├─ 预配置IOPS（io2）→ 高性能
    │   │   • IOPS: 64,000+
    │   │   • 延迟: 亚毫秒级
    │   │   • 成本: $0.145/GB-month + $0.065/IOPS
    │   │
    │   └─ 磁盘（standard）→ 归档
    │       • 不推荐（性能差）
    │
    └─ 高可用？
        ├─ Multi-AZ（强烈推荐）
        │   • 自动故障切换
        │   • 同步复制
        │   • RTO < 2分钟
        │   • 成本: +100%
        │
        └─ Single-AZ
            • 成本低
            • 不适合生产
```

### Aurora Serverless v3配置

```sql
-- 创建Aurora Serverless集群
aws rds create-db-cluster \
    --db-cluster-identifier myapp-cluster \
    --engine aurora-postgresql \
    --engine-version 15.4 \
    --master-username postgres \
    --master-user-password SecurePassword123 \
    --serverlessv2-scaling-configuration \
        MinCapacity=0.5,MaxCapacity=16 \
    --enable-http-endpoint

-- ACU（Aurora Capacity Units）配置
-- 1 ACU = 2GB RAM + vCPU

-- 最佳实践配置
{
  "MinCapacity": 0.5,    // 闲时缩到最小（节省成本）
  "MaxCapacity": 16,      // 高峰扩展上限
  "AutoPause": false,     // 生产环境不暂停（避免冷启动）
  "TimeoutAction": "ForceApplyCapacityChange"
}

-- 监控扩缩容
SELECT
    timestamp,
    value as acu_usage
FROM cloudwatch_metrics
WHERE metric_name = 'ServerlessDatabaseCapacity'
    AND timestamp > NOW() - INTERVAL '1 hour';

-- 成本对比（月度，100GB数据）
-- RDS (db.r6i.xlarge): $500
-- Aurora Serverless: $150-$300（取决于负载）
-- 节省: 40-70%
```

### RDS Proxy（连接池）

```yaml
# 配置RDS Proxy
Resources:
  DBProxy:
    Type: AWS::RDS::DBProxy
    Properties:
      DBProxyName: myapp-proxy
      EngineFamily: POSTGRESQL
      Auth:
        - AuthScheme: SECRETS
          SecretArn: arn:aws:secretsmanager:...
      RoleArn: arn:aws:iam::...
      VpcSubnetIds:
        - subnet-xxx
        - subnet-yyy
      RequireTLS: true
      # 连接池配置
      MaxConnectionsPercent: 100
      MaxIdleConnectionsPercent: 50
      ConnectionBorrowTimeout: 120

优势:
• 连接复用（减少连接开销）
• 自动故障切换（无需DNS更新）
• Lambda友好（无状态函数）
• 安全性（IAM认证）

性能提升:
• 连接建立时间: 100ms → 1ms
• 支持连接数: 100 → 10,000+
• Lambda冷启动: 减少80%失败
```

---

## Azure SQL Database最佳实践

### 服务层级选择

```text
Azure SQL服务层级决策
══════════════════════════════════════════════════════════════════════════════

DTU模型（Database Transaction Units）:
├─ Basic（5 DTU）
│   • 适合：开发/测试
│   • 存储：2GB
│   • 成本：$5/月
│
├─ Standard（10-3000 DTU）
│   • S0: 10 DTU, 250GB, $15/月
│   • S3: 100 DTU, 1TB, $200/月
│   • S12: 3000 DTU, 1TB, $3000/月
│   • 适合：中小型应用
│
└─ Premium（125-4000 DTU）
    • P1: 125 DTU, 1TB, $500/月
    • P6: 1000 DTU, 4TB, $3750/月
    • 适合：关键业务

vCore模型（推荐）:
├─ General Purpose
│   • 2-80 vCore
│   • 5-640GB RAM
│   • 最大32TB存储
│   • 成本：$0.5-$20/vCore-hour
│
├─ Business Critical
│   • 内存优化
│   • 本地SSD
│   • 只读副本（免费）
│   • 成本：$1-$40/vCore-hour
│
└─ Hyperscale
    • 100TB+ 存储
    • 快速扩展（秒级）
    • 快照备份（秒级）
    • 成本：$1-$30/vCore-hour
```

### 弹性池（Elastic Pools）

```sql
-- 场景：多个小数据库，负载互补

-- 创建弹性池
az sql elastic-pool create \
    --resource-group mygroup \
    --server myserver \
    --name mypool \
    --edition Standard \
    --dtu 400 \
    --database-dtu-max 100 \
    --database-dtu-min 10

-- 将数据库加入池
az sql db update \
    --resource-group mygroup \
    --server myserver \
    --name db1 \
    --elastic-pool mypool

-- 优势
成本对比（10个数据库）:
• 独立配置: $200 × 10 = $2000/月
• 弹性池: $600/月（共享400 DTU）
• 节省: 70%

适用场景:
✓ SaaS应用（多租户）
✓ 负载互补（白天/夜晚）
✓ 小数据库（<100GB）
✗ 大数据库（独立配置更好）
```

### 智能性能（Intelligent Performance）

```sql
-- 自动调优（Automatic Tuning）
ALTER DATABASE mydb
SET AUTOMATIC_TUNING = AUTO;

-- 自动创建索引
-- Azure会分析查询模式，自动创建/删除索引

-- 查看推荐
SELECT
    type_desc,
    reason,
    state_desc,
    script
FROM sys.dm_db_tuning_recommendations;

-- 输出示例:
-- type_desc | reason | state_desc | script
-- ----------|--------|-----------|--------
-- CREATE_INDEX | 查询xyz慢 | Active | CREATE INDEX idx_...
-- DROP_INDEX | 索引未使用 | Pending | DROP INDEX idx_...

-- Query Performance Insight
-- 自动识别慢查询并给出建议

-- 实际效果:
• 自动创建索引: 平均提升3-5倍性能
• 自动删除索引: 节省20-30%存储
• 无需DBA干预: 节省运维成本
```

---

## GCP Cloud SQL/Spanner最佳实践

### Cloud SQL高可用配置

```yaml
# Terraform配置
resource "google_sql_database_instance" "postgres" {
  name             = "myapp-db"
  database_version = "POSTGRES_15"
  region           = "us-central1"

  settings {
    tier = "db-custom-4-16384"  # 4 vCPU, 16GB RAM

    # 高可用配置
    availability_type = "REGIONAL"  # 区域高可用（vs ZONAL）

    # 备份配置
    backup_configuration {
      enabled                        = true
      start_time                     = "03:00"
      point_in_time_recovery_enabled = true  # PITR
      transaction_log_retention_days = 7
      backup_retention_settings {
        retained_backups = 30
      }
    }

    # 维护窗口
    maintenance_window {
      day          = 1  # Monday
      hour         = 3
      update_track = "stable"
    }

    # 洞察配置
    insights_config {
      query_insights_enabled  = true
      query_plans_per_minute  = 5
      query_string_length     = 1024
      record_application_tags = true
    }

    # 数据库标志
    database_flags {
      name  = "max_connections"
      value = "500"
    }
    database_flags {
      name  = "shared_buffers"
      value = "4194304"  # 4GB (单位：8KB页)
    }
    database_flags {
      name  = "effective_cache_size"
      value = "12582912"  # 12GB
    }
  }

  # 只读副本
  replica_configuration {
    failover_target = false
  }
}

# 创建只读副本
resource "google_sql_database_instance" "read_replica" {
  name                 = "myapp-db-replica"
  master_instance_name = google_sql_database_instance.postgres.name
  region               = "us-west1"  # 不同区域
  database_version     = "POSTGRES_15"

  settings {
    tier = "db-custom-2-8192"  # 副本可以用更小实例
    availability_type = "ZONAL"
  }
}
```

### Cloud Spanner（全球分布式）

```sql
-- Spanner DDL（特殊语法）

-- 创建数据库
gcloud spanner databases create mydb \
    --instance=myinstance \
    --database-dialect=GOOGLE_STANDARD_SQL

-- 创建表（带交错表）
CREATE TABLE users (
    user_id INT64 NOT NULL,
    username STRING(100),
    email STRING(200),
    created_at TIMESTAMP,
) PRIMARY KEY (user_id);

-- 交错表（Interleaved Table）
CREATE TABLE orders (
    user_id INT64 NOT NULL,
    order_id INT64 NOT NULL,
    total NUMERIC,
    created_at TIMESTAMP,
) PRIMARY KEY (user_id, order_id),
  INTERLEAVE IN PARENT users ON DELETE CASCADE;

-- 交错优势：
-- • orders和users物理上存储在一起
-- • JOIN性能提升10x（无需跨节点）
-- • 自动co-located（同一分片）

-- 全局索引 vs 本地索引
CREATE INDEX idx_email ON users(email);  -- 全局索引（跨所有节点）
CREATE INDEX idx_local ON orders(created_at)
    STORING (total)  -- STORING = INCLUDE
    INTERLEAVE IN users;  -- 本地索引（每个user分片）

-- 查询性能
-- 本地索引：单分片查询，延迟 < 10ms
-- 全局索引：可能跨分片，延迟 10-100ms

-- 读写配置
-- 强一致性读取（默认）
SELECT * FROM users WHERE user_id = @user_id;
-- 延迟：跨区域50-200ms

-- 陈旧读取（stale read）
SELECT * FROM users WHERE user_id = @user_id
    WITH STALENESS = EXACT_STALENESS 10s;
-- 延迟：本地读取 < 10ms
-- 数据可能延迟10秒

-- 只读事务（快照）
BEGIN TRANSACTION READ ONLY;
SELECT ... ;  -- 多个查询，一致快照
COMMIT;

-- 事务配置建议
操作类型 | 配置 | 理由
--------|------|-----
点查询 | Stale Read (10s) | 本地读取，快
实时数据 | Strong Read | 一致性优先
批量查询 | Read-Only Txn | 快照一致性
写入 | Read-Write Txn | 默认
```

### Aurora全局数据库

```sql
-- 创建Aurora全局数据库
aws rds create-global-cluster \
    --global-cluster-identifier myapp-global \
    --engine aurora-postgresql \
    --engine-version 15.4

-- 主区域（us-east-1）
aws rds create-db-cluster \
    --db-cluster-identifier myapp-primary \
    --engine aurora-postgresql \
    --global-cluster-identifier myapp-global \
    --region us-east-1

-- 次区域（eu-west-1）
aws rds create-db-cluster \
    --db-cluster-identifier myapp-secondary \
    --engine aurora-postgresql \
    --global-cluster-identifier myapp-global \
    --region eu-west-1

-- 架构
┌─────────────────────────────────────────┐
│  us-east-1 (主区域)                      │
│  ┌───────────────┐                      │
│  │ Primary Cluster│                     │
│  │  • Read/Write │                      │
│  └───────┬───────┘                      │
└──────────┼─────────────────────────────┘
           │ 异步复制（< 1秒）
┌──────────▼─────────────────────────────┐
│  eu-west-1 (次区域)                     │
│  ┌───────────────┐                      │
│  │Secondary Cluster│                    │
│  │  • Read-Only  │                      │
│  └───────────────┘                      │
└─────────────────────────────────────────┘

故障切换:
-- 计划内切换（维护）
aws rds failover-global-cluster \
    --global-cluster-identifier myapp-global \
    --target-db-cluster-identifier myapp-secondary
-- RTO: < 1分钟
-- RPO: < 1秒

-- 非计划（灾难）
-- 自动检测并切换
-- RTO: < 5分钟

成本:
• 主区域：$500/月
• 次区域：$500/月（只读副本）
• 跨区域传输：$0.02/GB
• 总计：≈$1100/月（包含全球冗余）
```

---

## Azure SQL最佳实践

### Hyperscale层级

```text
Hyperscale架构（100TB+数据库）
══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────┐
│       Compute Nodes (计算)               │
│  ┌──────┐  ┌──────┐  ┌──────┐          │
│  │Primary│  │Second│  │Second│          │
│  └───┬──┘  └───┬──┘  └───┬──┘          │
└──────┼──────────┼──────────┼────────────┘
       │          │          │
       │    ┌─────┴────┐     │
       │    │   Log    │     │
       │    │  Service │     │
       │    └─────┬────┘     │
       │          │          │
┌──────┼──────────┼──────────┼────────────┐
│      │  Page Servers (存储)             │
│  ┌───▼──┐  ┌──▼───┐  ┌───▼──┐          │
│  │Pages │  │Pages │  │Pages │          │
│  │ 1-10K│  │10K+  │  │20K+  │          │
│  └──────┘  └──────┘  └──────┘          │
└─────────────────────────────────────────┘

特点:
• 计算存储分离
• 存储自动扩展（最大100TB）
• 4个只读副本（免费）
• 快照备份（文件级，秒级）

性能:
• 扩展时间：< 5分钟（vs 传统数小时）
• 备份时间：瞬间（快照）
• 恢复时间：< 10分钟（任意时间点）

配置:
az sql db create \
    --resource-group mygroup \
    --server myserver \
    --name mydb \
    --service-objective HS_Gen5_4  # 4 vCore
    --read-scale Enabled \
    --zone-redundant

-- 只读路由
-- 连接字符串添加：ApplicationIntent=ReadOnly
Server=myserver.database.windows.net;
Database=mydb;
ApplicationIntent=ReadOnly;  # 自动路由到只读副本
```

### 自动故障切换组

```sql
-- 创建故障切换组
az sql failover-group create \
    --name myapp-fog \
    --resource-group mygroup \
    --server myserver-primary \
    --partner-server myserver-secondary \
    --partner-resource-group mygroup-secondary \
    --failover-policy Automatic \
    --grace-period 1  # 1小时检测窗口

-- 连接字符串（应用层）
-- 主端点（读写）
Server=myapp-fog.database.windows.net;
Database=mydb;

-- 次端点（只读）
Server=myapp-fog.secondary.database.windows.net;
Database=mydb;

-- 自动故障切换
-- 主区域故障 → 次区域自动提升为主
-- RTO: < 1小时（可配置）
-- RPO: 0秒（同步复制）

-- 监控
SELECT
    role_desc,
    synchronization_state_desc,
    synchronization_health_desc
FROM sys.dm_geo_replication_link_status;
```

---

## GCP最佳实践

### Cloud SQL企业级配置

```yaml
# Terraform配置
resource "google_sql_database_instance" "postgres" {
  name             = "myapp-db"
  database_version = "POSTGRES_15"
  region           = "us-central1"

  settings {
    tier = "db-custom-8-32768"  # 8 vCPU, 32GB RAM

    # 高可用（区域冗余）
    availability_type = "REGIONAL"

    # 启用Private IP（VPC内部访问）
    ip_configuration {
      ipv4_enabled    = false  # 禁用公网IP
      private_network = "projects/myproject/global/networks/default"
      require_ssl     = true
    }

    # 自动扩展存储
    disk_autoresize       = true
    disk_autoresize_limit = 2000  # 最大2TB
    disk_size             = 100   # 初始100GB
    disk_type             = "PD_SSD"

    # 数据库标志
    database_flags {
      name  = "max_connections"
      value = "500"
    }
    database_flags {
      name  = "work_mem"
      value = "16384"  # 16MB
    }

    # 洞察配置
    insights_config {
      query_insights_enabled  = true
      query_plans_per_minute  = 5
      query_string_length     = 1024
      record_application_tags = true
    }

    # 备份
    backup_configuration {
      enabled                        = true
      start_time                     = "03:00"
      point_in_time_recovery_enabled = true
      transaction_log_retention_days = 7
      backup_retention_settings {
        retained_backups = 30
      }
    }

    # 维护窗口
    maintenance_window {
      day          = 1  # Monday
      hour         = 3
      update_track = "stable"
    }
  }
}
```

### Cloud Spanner全球部署

```sql
-- 创建实例（多区域）
gcloud spanner instances create myinstance \
    --config=nam-eur-asia1 \  # 北美+欧洲+亚洲
    --description="Global instance" \
    --nodes=3

-- 区域配置说明
nam-eur-asia1:
• us-central1（主）
• europe-west1（副本）
• asia-southeast1（副本）
• 一致性：强一致（线性化）
• 延迟：跨区域写入100-300ms

-- 读取优化（就近路由）
SELECT * FROM users WHERE user_id = @user_id;
-- 自动路由到最近区域，延迟 < 10ms

-- 写入（需要全局共识）
INSERT INTO users (user_id, name) VALUES (123, 'Alice');
-- 延迟：100-300ms（取决于区域距离）

-- 性能调优
-- 1. 热点键（Hotspot Key）避免
-- 错误：用自增ID（所有写入集中在最后一个分片）
CREATE TABLE orders (
    order_id INT64 NOT NULL,  -- 自增
    ...
) PRIMARY KEY (order_id);

-- 正确：使用UUID或哈希
CREATE TABLE orders (
    order_id STRING(36) NOT NULL,  -- UUID
    ...
) PRIMARY KEY (order_id);

-- 2. 分片键选择
-- 按user_id分片（相关数据在同一节点）
CREATE TABLE orders (
    user_id INT64 NOT NULL,
    order_id INT64 NOT NULL,
    ...
) PRIMARY KEY (user_id, order_id);

成本:
• 3节点（nam-eur-asia1）: $2700/月
• 存储: $0.30/GB-month
• 网络（跨区域）: $0.01/GB
```

---

## 成本对比矩阵

```text
云数据库成本对比（月度，生产级配置）
══════════════════════════════════════════════════════════════════════════════

配置：100GB存储，4 vCPU，16GB RAM，Multi-AZ

服务 | 计算 | 存储 | 备份 | 高可用 | 总计
-----|------|------|------|--------|------
AWS RDS PostgreSQL | $250 | $12 | $20 | +100% | $564
AWS Aurora | $350 | $10 | $10 | 免费 | $370
Azure SQL (vCore) | $280 | $15 | $15 | +50% | $465
GCP Cloud SQL | $240 | $17 | $17 | +100% | $548

Serverless对比（间歇负载，20%活跃时间）:
AWS Aurora Serverless | $150 | $10 | $10 | 免费 | $170 (节省54%)
Azure SQL Serverless | $160 | $15 | $15 | +50% | $280 (节省40%)

大规模对比（1TB存储，32 vCPU，128GB RAM）:
AWS Aurora | $2800 | $100 | $50 | 免费 | $2950
Azure SQL Hyperscale | $3200 | $150 | $50 | +50% | $5250
GCP Spanner (3节点) | $2700 | $300 | 免费 | 免费 | $3000

结论:
• 中小规模：Aurora最优
• 大规模：Spanner（全球分布）或Aurora
• 间歇负载：Serverless节省50%+
• 自建：中小规模不划算，大规模可考虑
```

---

**文档版本**: v1.0
**最后更新**: 2025-12-05
**成本数据**: 2024年12月定价
