# ETLæµç¨‹æ¡ˆä¾‹

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-01-15
> **ç‰ˆæœ¬**ï¼šv1.0.0
> **éš¾åº¦**ï¼šâ­â­â­â­
> **åº”ç”¨åœºæ™¯**ï¼šETLæµç¨‹ã€æ•°æ®è½¬æ¢ã€æ•°æ®åŠ è½½

---

## ğŸ“‹ ç›®å½•

- [ETLæµç¨‹æ¡ˆä¾‹](#etlæµç¨‹æ¡ˆä¾‹)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
    - [1.1 ETLæµç¨‹æ€ç»´å¯¼å›¾](#11-etlæµç¨‹æ€ç»´å¯¼å›¾)
    - [1.2 ETLæµç¨‹æ—¶åºå›¾](#12-etlæµç¨‹æ—¶åºå›¾)
  - [äºŒã€æ•°æ®æå–](#äºŒæ•°æ®æå–)
    - [2.1 æ¡ˆä¾‹ï¼šå¢é‡æ•°æ®æå–](#21-æ¡ˆä¾‹å¢é‡æ•°æ®æå–)
  - [ä¸‰ã€æ•°æ®è½¬æ¢](#ä¸‰æ•°æ®è½¬æ¢)
    - [3.1 æ¡ˆä¾‹ï¼šæ•°æ®æ¸…æ´—å’Œè½¬æ¢](#31-æ¡ˆä¾‹æ•°æ®æ¸…æ´—å’Œè½¬æ¢)
  - [å››ã€æ•°æ®åŠ è½½](#å››æ•°æ®åŠ è½½)
    - [4.1 æ¡ˆä¾‹ï¼šæ‰¹é‡æ•°æ®åŠ è½½](#41-æ¡ˆä¾‹æ‰¹é‡æ•°æ®åŠ è½½)
  - [äº”ã€ç›¸å…³èµ„æº](#äº”ç›¸å…³èµ„æº)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)

---

## ä¸€ã€æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›ETLæµç¨‹ä¸­SQLæŸ¥è¯¢çš„å®é™…æ¡ˆä¾‹ï¼Œæ¶µç›–æ•°æ®æå–ã€è½¬æ¢ã€åŠ è½½çš„å®Œæ•´æµç¨‹ã€‚

### 1.1 ETLæµç¨‹æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((ETLæµç¨‹))
    æ•°æ®æå–(Extract)
      å…¨é‡æå–
        ä¸€æ¬¡æ€§å¯¼å…¥
        å†å²æ•°æ®è¿ç§»
      å¢é‡æå–
        æ—¶é—´æˆ³æå–
        å˜æ›´æ•°æ®æ•è·CDC
        æ—¥å¿—æå–
      æ•°æ®æº
        å…³ç³»æ•°æ®åº“
        æ–‡ä»¶ç³»ç»Ÿ
        APIæ¥å£
        æ¶ˆæ¯é˜Ÿåˆ—
    æ•°æ®è½¬æ¢(Transform)
      æ•°æ®æ¸…æ´—
        å»é‡å¤„ç†
        ç©ºå€¼å¤„ç†
        æ ¼å¼è½¬æ¢
      æ•°æ®éªŒè¯
        å®Œæ•´æ€§æ£€æŸ¥
        ä¸€è‡´æ€§æ£€æŸ¥
        ä¸šåŠ¡è§„åˆ™éªŒè¯
      æ•°æ®è½¬æ¢
        æ•°æ®ç±»å‹è½¬æ¢
        è®¡ç®—å­—æ®µ
        æ•°æ®èšåˆ
      æ•°æ®æ ‡å‡†åŒ–
        ç¼–ç ç»Ÿä¸€
        æ ¼å¼ç»Ÿä¸€
        å‘½åè§„èŒƒ
    æ•°æ®åŠ è½½(Load)
      å…¨é‡åŠ è½½
        æ¸…ç©ºååŠ è½½
        è¦†ç›–åŠ è½½
      å¢é‡åŠ è½½
        INSERT
        UPDATE
        UPSERT
      æ‰¹é‡åŠ è½½
        æ‰¹é‡æ’å…¥
        æ‰¹é‡æ›´æ–°
        äº‹åŠ¡æ§åˆ¶
```

### 1.2 ETLæµç¨‹æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant Source
    participant Extract
    participant Transform
    participant Validate
    participant Load
    participant Target

    Source->>Extract: æå–æ•°æ®
    Extract->>Extract: å¢é‡/å…¨é‡åˆ¤æ–­
    Extract->>Transform: åŸå§‹æ•°æ®

    Transform->>Transform: æ•°æ®æ¸…æ´—
    Transform->>Transform: æ•°æ®è½¬æ¢
    Transform->>Validate: è½¬æ¢åæ•°æ®

    Validate->>Validate: æ•°æ®éªŒè¯
    Validate->>Validate: è´¨é‡æ£€æŸ¥
    Validate->>Load: éªŒè¯é€šè¿‡æ•°æ®

    Load->>Target: åŠ è½½æ•°æ®
    Target-->>Load: åŠ è½½ç»“æœ
    Load-->>Transform: åŠ è½½çŠ¶æ€
    Transform-->>Extract: å¤„ç†çŠ¶æ€
    Extract-->>Source: æå–çŠ¶æ€
```

---

## äºŒã€æ•°æ®æå–

### 2.1 æ¡ˆä¾‹ï¼šå¢é‡æ•°æ®æå–

**åœºæ™¯æè¿°**ï¼šç”µå•†ç³»ç»Ÿéœ€è¦æ¯å¤©ä»è®¢å•ç³»ç»Ÿæå–æ–°å¢è®¢å•æ•°æ®åˆ°æ•°æ®ä»“åº“ï¼Œç”¨äºåˆ†æå’ŒæŠ¥è¡¨ã€‚

**ä¸šåŠ¡éœ€æ±‚**ï¼š

- åªæå–ä¸Šæ¬¡æå–åæ–°å¢æˆ–æ›´æ–°çš„è®¢å•
- è®°å½•æå–æ—¶é—´ç‚¹
- æ”¯æŒæ–­ç‚¹ç»­ä¼ 
- å¤„ç†æ•°æ®é‡ï¼šæ¯å¤©çº¦10ä¸‡æ¡è®¢å•

**æ–¹æ¡ˆå¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | å®ç°æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|---------|------|------|---------|
| **æ—¶é—´æˆ³æå–** | WHERE last_updated > :last_time | ç®€å•ã€é«˜æ•ˆ | ä¾èµ–æ—¶é—´æˆ³å­—æ®µ | æœ‰æ›´æ–°æ—¶é—´æˆ³ |
| **CDCå˜æ›´æ•è·** | è¯»å–å˜æ›´æ—¥å¿— | å®æ—¶ã€å‡†ç¡® | å®ç°å¤æ‚ | éœ€è¦CDCæ”¯æŒ |
| **å…¨é‡å¯¹æ¯”** | å…¨é‡æå–åå¯¹æ¯” | å‡†ç¡® | æ€§èƒ½å·® | å°æ•°æ®é‡ |

**æ–¹æ¡ˆ1ï¼šæ—¶é—´æˆ³æå–ï¼ˆæ¨èï¼‰**:

```sql
-- æå–æ–°å¢å’Œæ›´æ–°çš„è®¢å•
SELECT
    order_id,
    customer_id,
    order_date,
    total_amount,
    status,
    last_updated
FROM Orders
WHERE last_updated > :last_extract_time
ORDER BY last_updated;

-- æ›´æ–°æå–æ—¶é—´ç‚¹
UPDATE ETL_Config
SET last_extract_time = CURRENT_TIMESTAMP
WHERE table_name = 'Orders';
```

**æ–¹æ¡ˆ2ï¼šå˜æ›´æ•°æ®æ•è·ï¼ˆCDCï¼‰**:

```sql
-- ä»å˜æ›´æ—¥å¿—è¡¨æå–
SELECT
    order_id,
    customer_id,
    order_date,
    total_amount,
    status,
    change_type,  -- INSERT, UPDATE, DELETE
    change_time
FROM Orders_CDC
WHERE change_time > :last_extract_time
  AND change_type IN ('INSERT', 'UPDATE')
ORDER BY change_time;
```

**ETLæµç¨‹æ—¶åºå›¾**ï¼š

```mermaid
sequenceDiagram
    participant Scheduler
    participant Extract
    participant SourceDB
    participant Staging
    participant Transform
    participant TargetDB

    Scheduler->>Extract: è§¦å‘ETLä»»åŠ¡
    Extract->>SourceDB: æŸ¥è¯¢å¢é‡æ•°æ®
    SourceDB-->>Extract: è¿”å›è®¢å•æ•°æ®
    Extract->>Staging: å†™å…¥ä¸´æ—¶è¡¨
    Staging-->>Extract: å†™å…¥å®Œæˆ

    Extract->>Transform: é€šçŸ¥è½¬æ¢å¼€å§‹
    Transform->>Staging: è¯»å–ä¸´æ—¶æ•°æ®
    Transform->>Transform: æ•°æ®æ¸…æ´—è½¬æ¢
    Transform->>TargetDB: å†™å…¥ç›®æ ‡è¡¨
    TargetDB-->>Transform: å†™å…¥å®Œæˆ

    Transform->>Extract: æ›´æ–°æå–æ—¶é—´
    Extract-->>Scheduler: ETLå®Œæˆ
```

**æ€§èƒ½ä¼˜åŒ–**ï¼š

```sql
-- åˆ›å»ºç´¢å¼•ä¼˜åŒ–æå–
CREATE INDEX idx_orders_last_updated ON Orders(last_updated);

-- åˆ†åŒºè¡¨ä¼˜åŒ–ï¼ˆå¦‚æœæ”¯æŒï¼‰
CREATE TABLE Orders (
    ...
) PARTITION BY RANGE (last_updated);

-- æ‰¹é‡æå–ä¼˜åŒ–
SELECT * FROM Orders
WHERE last_updated > :last_extract_time
ORDER BY last_updated
LIMIT 10000;  -- åˆ†æ‰¹æå–
```

---

## ä¸‰ã€æ•°æ®è½¬æ¢

### 3.1 æ¡ˆä¾‹ï¼šæ•°æ®æ¸…æ´—å’Œè½¬æ¢

**æŸ¥è¯¢**ï¼š

```sql
SELECT
    TRIM(UPPER(name)) as clean_name,
    CAST(age AS INTEGER) as age_int,
    CASE
        WHEN status = 'A' THEN 'Active'
        WHEN status = 'I' THEN 'Inactive'
        ELSE 'Unknown'
    END as status_desc
FROM RawData
WHERE age IS NOT NULL;
```

---

## å››ã€æ•°æ®åŠ è½½

### 4.1 æ¡ˆä¾‹ï¼šæ‰¹é‡æ•°æ®åŠ è½½

**æŸ¥è¯¢**ï¼š

```sql
INSERT INTO TargetTable (id, name, age, status)
SELECT id, name, age, status
FROM StagingTable
WHERE NOT EXISTS (
    SELECT 1 FROM TargetTable
    WHERE TargetTable.id = StagingTable.id
);
```

---

## äº”ã€ç›¸å…³èµ„æº

### ç›¸å…³æ–‡æ¡£

- [å¤æ‚æŸ¥è¯¢æ¡ˆä¾‹](./07.01-å¤æ‚æŸ¥è¯¢æ¡ˆä¾‹.md) - å¤æ‚æŸ¥è¯¢
- [æ•°æ®åˆ†ææ¡ˆä¾‹](./07.02-æ•°æ®åˆ†ææ¡ˆä¾‹.md) - æ•°æ®åˆ†æ

---

**ç»´æŠ¤è€…**: SQL Standards Team
**æœ€åæ›´æ–°**: 2025-01-15
