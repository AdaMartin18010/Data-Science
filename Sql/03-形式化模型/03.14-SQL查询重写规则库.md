# SQLæŸ¥è¯¢é‡å†™è§„åˆ™åº“

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-12-04
> **é€‚ç”¨æ€§**ï¼šæ‰€æœ‰SQLæ•°æ®åº“
> **éš¾åº¦**ï¼šâ­â­â­â­

---

## ğŸ“‹ æ¦‚è¿°

æŸ¥è¯¢ä¼˜åŒ–å™¨ä½¿ç”¨çš„æŸ¥è¯¢é‡å†™è§„åˆ™ï¼Œç†è§£è¿™äº›è§„åˆ™å¯ä»¥ç¼–å†™æ›´é«˜æ•ˆçš„SQLã€‚

---

## è§„åˆ™1ï¼šè°“è¯ä¸‹æ¨ï¼ˆPredicate Pushdownï¼‰

```sql
-- åŸæŸ¥è¯¢ï¼ˆä½æ•ˆï¼‰
SELECT *
FROM (
    SELECT u.*, o.order_count
    FROM users u
    LEFT JOIN (
        SELECT user_id, COUNT(*) AS order_count
        FROM orders
        GROUP BY user_id
    ) o ON u.user_id = o.user_id
) sub
WHERE sub.age > 25;

-- é‡å†™åï¼ˆé«˜æ•ˆï¼‰
SELECT u.*, o.order_count
FROM users u
LEFT JOIN (
    SELECT user_id, COUNT(*) AS order_count
    FROM orders
    GROUP BY user_id
) o ON u.user_id = o.user_id
WHERE u.age > 25;  -- è°“è¯ä¸‹æ¨åˆ°usersè¡¨

-- è§„åˆ™ï¼šWHEREæ¡ä»¶åº”è¯¥å°½æ—©åº”ç”¨ï¼Œå‡å°‘å¤„ç†çš„æ•°æ®é‡
```

### å½¢å¼åŒ–è¡¨è¾¾

```text
è°“è¯ä¸‹æ¨è§„åˆ™
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

è§„åˆ™ï¼šÏƒ_p(R â¨ S) â‡’ Ïƒ_p(R) â¨ S  ï¼ˆå¦‚æœpåªæ¶‰åŠRçš„å±æ€§ï¼‰

è¯æ˜ï¼š
  è®¾R = {râ‚, râ‚‚, ..., râ‚™}, S = {sâ‚, sâ‚‚, ..., sâ‚˜}

  Ïƒ_p(R â¨ S)
  = {(r, s) | r âˆˆ R, s âˆˆ S, r.key = s.fk, p(r)}

  Ïƒ_p(R) â¨ S
  = {r | r âˆˆ R, p(r)} â¨ S
  = {(r, s) | r âˆˆ {r | r âˆˆ R, p(r)}, s âˆˆ S, r.key = s.fk}
  = {(r, s) | r âˆˆ R, p(r), s âˆˆ S, r.key = s.fk}

  âˆ´ Ïƒ_p(R â¨ S) = Ïƒ_p(R) â¨ S â–¡

æ€§èƒ½æå‡ï¼š
â€¢ å‡å°‘JOINçš„æ•°æ®é‡
â€¢ æ—©æœŸè¿‡æ»¤ï¼Œå‡å°‘å†…å­˜ä½¿ç”¨
â€¢ å¯èƒ½æ”¹å˜JOINç®—æ³•é€‰æ‹©
```

---

## è§„åˆ™2ï¼šæŠ•å½±æ¶ˆé™¤ï¼ˆProjection Eliminationï¼‰

```sql
-- åŸæŸ¥è¯¢
SELECT u.user_id, u.name
FROM (
    SELECT user_id, name, email, created_at
    FROM users
) u
WHERE u.user_id = 1001;

-- é‡å†™åï¼ˆæ¶ˆé™¤ä¸å¿…è¦çš„æŠ•å½±ï¼‰
SELECT user_id, name
FROM users
WHERE user_id = 1001;
-- ç›´æ¥è¯»å–éœ€è¦çš„åˆ—ï¼Œé¿å…å¤šä½™çš„æŠ•å½±æ“ä½œ
```

---

## è§„åˆ™3ï¼šå­æŸ¥è¯¢æ‰å¹³åŒ–

```sql
-- åŸæŸ¥è¯¢ï¼ˆç›¸å…³å­æŸ¥è¯¢ï¼‰
SELECT
    u.name,
    (SELECT COUNT(*) FROM orders o WHERE o.user_id = u.user_id) AS order_count
FROM users u;

-- é‡å†™ä¸ºJOIN
SELECT
    u.name,
    COUNT(o.order_id) AS order_count
FROM users u
LEFT JOIN orders o ON u.user_id = o.user_id
GROUP BY u.user_id, u.name;

-- æ€§èƒ½ï¼šO(nÂ²) â†’ O(n)
```

---

## è§„åˆ™4ï¼šå¸¸é‡æŠ˜å 

```sql
-- åŸæŸ¥è¯¢
SELECT * FROM orders WHERE created_at > DATE('2025-12-04') - INTERVAL '30 days';

-- ä¼˜åŒ–å™¨é‡å†™ä¸º
SELECT * FROM orders WHERE created_at > '2025-11-04';
-- ç¼–è¯‘æ—¶è®¡ç®—å¸¸é‡ï¼Œé¿å…è¿è¡Œæ—¶é‡å¤è®¡ç®—
```

---

## è§„åˆ™5ï¼šJOINæ¶ˆé™¤

```sql
-- åŸæŸ¥è¯¢ï¼ˆä¸å¿…è¦çš„JOINï¼‰
SELECT u.name
FROM users u
JOIN user_profiles p ON u.user_id = p.user_id
WHERE u.user_id = 1001;

-- å¦‚æœä¸ä½¿ç”¨pè¡¨çš„ä»»ä½•åˆ—ï¼Œä¸”æœ‰å¤–é”®ä¿è¯ï¼Œåˆ™æ¶ˆé™¤JOIN
SELECT u.name
FROM users u
WHERE u.user_id = 1001;
```

---

## è§„åˆ™6ï¼šORé‡å†™ä¸ºUNION

```sql
-- åŸæŸ¥è¯¢
SELECT * FROM products
WHERE category = 'Electronics' OR price > 1000;

-- å¦‚æœä¸¤ä¸ªæ¡ä»¶éƒ½æœ‰ç´¢å¼•ï¼Œé‡å†™ä¸ºUNION
(SELECT * FROM products WHERE category = 'Electronics')
UNION ALL
(SELECT * FROM products WHERE price > 1000 AND category != 'Electronics');

-- æ¯ä¸ªåˆ†æ”¯éƒ½èƒ½ä½¿ç”¨ç´¢å¼•
```

---

## è§„åˆ™7ï¼šINè½¬æ¢ä¸ºEXISTS

```sql
-- åŸæŸ¥è¯¢
SELECT * FROM orders
WHERE user_id IN (SELECT user_id FROM premium_users);

-- é‡å†™ä¸ºEXISTSï¼ˆå¯èƒ½æ›´å¿«ï¼‰
SELECT * FROM orders o
WHERE EXISTS (
    SELECT 1 FROM premium_users p WHERE p.user_id = o.user_id
);

-- æˆ–é‡å†™ä¸ºSemi-Join
SELECT o.*
FROM orders o
SEMI JOIN premium_users p ON o.user_id = p.user_id;
```

---

## è§„åˆ™8ï¼šèšåˆä¸‹æ¨

```sql
-- åŸæŸ¥è¯¢
SELECT user_id, SUM(total)
FROM (
    SELECT user_id, order_id, SUM(item_price) AS total
    FROM order_items
    GROUP BY user_id, order_id
) sub
GROUP BY user_id;

-- é‡å†™åï¼ˆåˆå¹¶èšåˆï¼‰
SELECT user_id, SUM(item_price) AS total
FROM order_items
GROUP BY user_id;
-- ç›´æ¥èšåˆï¼Œé¿å…ä¸¤æ¬¡èšåˆæ“ä½œ
```

---

## å®æˆ˜ï¼šæ‰‹åŠ¨ä¼˜åŒ–SQL

```sql
-- åŸå§‹æŸ¥è¯¢ï¼ˆå¤šä¸ªé—®é¢˜ï¼‰
SELECT *
FROM orders o
WHERE o.user_id IN (
    SELECT user_id FROM users WHERE age > 25
)
AND o.created_at > DATE('2025-01-01') - INTERVAL '30 days'
AND (o.status = 'pending' OR o.status = 'processing')
ORDER BY o.created_at DESC;

-- é—®é¢˜1ï¼šSELECT *ï¼ˆä¸å¿…è¦çš„åˆ—ï¼‰
-- é—®é¢˜2ï¼šINå­æŸ¥è¯¢ï¼ˆå¯èƒ½æ…¢ï¼‰
-- é—®é¢˜3ï¼šæ—¥æœŸè®¡ç®—ï¼ˆåº”è¯¥å¸¸é‡æŠ˜å ï¼‰
-- é—®é¢˜4ï¼šORæ¡ä»¶ï¼ˆå¯èƒ½ä¸ç”¨ç´¢å¼•ï¼‰

-- ä¼˜åŒ–å
SELECT o.order_id, o.user_id, o.total, o.status, o.created_at
FROM orders o
INNER JOIN users u ON o.user_id = u.user_id  -- å­æŸ¥è¯¢æ‰å¹³åŒ–
WHERE u.age > 25  -- è°“è¯ä¸‹æ¨
    AND o.created_at > '2024-12-04'  -- å¸¸é‡æŠ˜å 
    AND o.status IN ('pending', 'processing')  -- ORæ”¹ä¸ºIN
ORDER BY o.created_at DESC;

-- è¿›ä¸€æ­¥ä¼˜åŒ–ï¼šæ·»åŠ ç´¢å¼•
CREATE INDEX idx_orders_status_created
ON orders(status, created_at DESC)
WHERE status IN ('pending', 'processing');

CREATE INDEX idx_users_age ON users(age);

-- æ€§èƒ½æå‡ï¼š10-100å€
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
**æœ€åæ›´æ–°**: 2025-12-04
