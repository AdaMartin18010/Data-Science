# æ•°æ®æ“ä½œè¯­è¨€(DML)

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-01-15
> **ç‰ˆæœ¬**ï¼šv1.0.0
> **éš¾åº¦**ï¼šâ­â­â­
> **åº”ç”¨åœºæ™¯**ï¼šæ•°æ®æ’å…¥ã€æ›´æ–°ã€åˆ é™¤æ“ä½œ

---

## ğŸ“‹ ç›®å½•

- [æ•°æ®æ“ä½œè¯­è¨€(DML)](#æ•°æ®æ“ä½œè¯­è¨€dml)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
    - [1.1 DMLæ“ä½œæ€ç»´å¯¼å›¾](#11-dmlæ“ä½œæ€ç»´å¯¼å›¾)
    - [1.2 DMLæ“ä½œå†³ç­–æ ‘](#12-dmlæ“ä½œå†³ç­–æ ‘)
    - [1.3 DMLæ“ä½œå¯¹æ¯”çŸ©é˜µ](#13-dmlæ“ä½œå¯¹æ¯”çŸ©é˜µ)
  - [äºŒã€INSERT](#äºŒinsert)
    - [2.1 åŸºæœ¬è¯­æ³•](#21-åŸºæœ¬è¯­æ³•)
    - [2.2 åœºæ™¯ç¤ºä¾‹ï¼šå­¦ç”Ÿæ•°æ®å½•å…¥](#22-åœºæ™¯ç¤ºä¾‹å­¦ç”Ÿæ•°æ®å½•å…¥)
  - [ä¸‰ã€UPDATE](#ä¸‰update)
    - [3.1 åŸºæœ¬è¯­æ³•](#31-åŸºæœ¬è¯­æ³•)
    - [3.2 åœºæ™¯ç¤ºä¾‹ï¼šå­¦ç”Ÿä¿¡æ¯æ›´æ–°](#32-åœºæ™¯ç¤ºä¾‹å­¦ç”Ÿä¿¡æ¯æ›´æ–°)
  - [å››ã€DELETE](#å››delete)
    - [4.1 åŸºæœ¬è¯­æ³•](#41-åŸºæœ¬è¯­æ³•)
    - [4.2 åœºæ™¯ç¤ºä¾‹ï¼šå­¦ç”Ÿæ•°æ®åˆ é™¤](#42-åœºæ™¯ç¤ºä¾‹å­¦ç”Ÿæ•°æ®åˆ é™¤)
  - [äº”ã€MERGE](#äº”merge)
    - [5.1 åŸºæœ¬è¯­æ³•](#51-åŸºæœ¬è¯­æ³•)
    - [5.2 åœºæ™¯ç¤ºä¾‹ï¼šå­¦ç”Ÿæ•°æ®åŒæ­¥](#52-åœºæ™¯ç¤ºä¾‹å­¦ç”Ÿæ•°æ®åŒæ­¥)
  - [å…­ã€ç›¸å…³èµ„æº](#å…­ç›¸å…³èµ„æº)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)

---

## ä¸€ã€æ¦‚è¿°

**æ•°æ®æ“ä½œè¯­è¨€ï¼ˆDML, Data Manipulation Languageï¼‰**ç”¨äºå¯¹æ•°æ®åº“ä¸­çš„æ•°æ®è¿›è¡Œæ“ä½œï¼ŒåŒ…æ‹¬æ’å…¥ã€æ›´æ–°ã€åˆ é™¤ç­‰ã€‚

**DMLä¸»è¦è¯­å¥**ï¼š

- INSERTï¼šæ’å…¥æ•°æ®
- UPDATEï¼šæ›´æ–°æ•°æ®
- DELETEï¼šåˆ é™¤æ•°æ®
- MERGEï¼šåˆå¹¶æ•°æ®

### 1.1 DMLæ“ä½œæ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((DMLæ“ä½œ))
    INSERT
      å•è¡Œæ’å…¥
        VALUESå­å¥
        ç›´æ¥æ’å…¥
      å¤šè¡Œæ’å…¥
        æ‰¹é‡VALUES
        å­æŸ¥è¯¢æ’å…¥
      INSERT ... SELECT
        ä»æŸ¥è¯¢æ’å…¥
        æ•°æ®è¿ç§»
    UPDATE
      å•è¡¨æ›´æ–°
        æ¡ä»¶æ›´æ–°
        æ‰¹é‡æ›´æ–°
      å¤šè¡¨æ›´æ–°
        JOINæ›´æ–°
        å­æŸ¥è¯¢æ›´æ–°
    DELETE
      æ¡ä»¶åˆ é™¤
        WHEREå­å¥
        æ‰¹é‡åˆ é™¤
      çº§è”åˆ é™¤
        å¤–é”®çº§è”
        è§¦å‘å™¨åˆ é™¤
    MERGE
      UPSERTæ“ä½œ
        å­˜åœ¨åˆ™æ›´æ–°
        ä¸å­˜åœ¨åˆ™æ’å…¥
      æ•°æ®åŒæ­¥
        å¢é‡åŒæ­¥
        å…¨é‡åŒæ­¥
```

### 1.2 DMLæ“ä½œå†³ç­–æ ‘

```mermaid
flowchart TD
    A[éœ€è¦DMLæ“ä½œ?] --> B{æ“ä½œç±»å‹}
    B -->|æ’å…¥| C{æ’å…¥æ–¹å¼}
    B -->|æ›´æ–°| D{æ›´æ–°æ–¹å¼}
    B -->|åˆ é™¤| E[DELETE]
    B -->|åˆå¹¶| F[MERGE]

    C -->|å•è¡Œ| G[INSERT VALUES]
    C -->|å¤šè¡Œ| H[INSERT VALUESå¤šè¡Œ]
    C -->|æŸ¥è¯¢| I[INSERT SELECT]

    D -->|å•è¡¨| J[UPDATEå•è¡¨]
    D -->|å¤šè¡¨| K[UPDATE JOIN]

    G --> L[æ‰§è¡ŒDML]
    H --> L
    I --> L
    J --> L
    K --> L
    E --> L
    F --> L
```

### 1.3 DMLæ“ä½œå¯¹æ¯”çŸ©é˜µ

| æ“ä½œ | è¯­å¥ | å¯å›æ»š | æ€§èƒ½ | å½±å“è¡Œæ•° | ä½¿ç”¨åœºæ™¯ |
|------|------|--------|------|---------|---------|
| **INSERT** | INSERT INTO ... VALUES | âœ… | ä¸­ | å•è¡Œ/å¤šè¡Œ | æ–°å¢æ•°æ® |
| **INSERT SELECT** | INSERT INTO ... SELECT | âœ… | ä¸­-é«˜ | å¤šè¡Œ | æ•°æ®è¿ç§» |
| **UPDATE** | UPDATE ... SET ... WHERE | âœ… | ä¸­-é«˜ | å•è¡Œ/å¤šè¡Œ | ä¿®æ”¹æ•°æ® |
| **DELETE** | DELETE FROM ... WHERE | âœ… | ä¸­-é«˜ | å•è¡Œ/å¤šè¡Œ | åˆ é™¤æ•°æ® |
| **MERGE** | MERGE INTO ... | âœ… | é«˜ | å¤šè¡Œ | æ•°æ®åŒæ­¥ |

---

## äºŒã€INSERT

### 2.1 åŸºæœ¬è¯­æ³•

**INSERTè¯­æ³•**ï¼š

```sql
INSERT INTO table_name [(column_list)]
VALUES (value_list);
```

### 2.2 åœºæ™¯ç¤ºä¾‹ï¼šå­¦ç”Ÿæ•°æ®å½•å…¥

**ä¸šåŠ¡éœ€æ±‚**ï¼šå‘å­¦ç”Ÿç®¡ç†ç³»ç»Ÿå½•å…¥å­¦ç”Ÿã€è¯¾ç¨‹å’Œé€‰è¯¾æ•°æ®ã€‚

**DMLå®ç°**ï¼š

```sql
-- æ’å…¥å­¦ç”Ÿæ•°æ®ï¼ˆå•è¡Œï¼‰
INSERT INTO Student (student_id, name, age, major, email)
VALUES (1, 'Alice', 20, 'Computer Science', 'alice@example.com');

-- æ’å…¥å­¦ç”Ÿæ•°æ®ï¼ˆå¤šè¡Œï¼‰
INSERT INTO Student (student_id, name, age, major, email)
VALUES
    (2, 'Bob', 21, 'Mathematics', 'bob@example.com'),
    (3, 'Charlie', 19, 'Physics', 'charlie@example.com');

-- ä»æŸ¥è¯¢æ’å…¥ï¼ˆæ•°æ®è¿ç§»ï¼‰
INSERT INTO Student (student_id, name, age, major, email)
SELECT
    old_id,
    old_name,
    old_age,
    old_major,
    old_email
FROM OldStudentTable
WHERE old_status = 'active';
```

**æ•°æ®æ’å…¥æ‰§è¡Œæµç¨‹æ—¶åºå›¾**ï¼š

```mermaid
sequenceDiagram
    participant Client
    participant Parser
    participant Validator
    participant Storage

    Client->>Parser: INSERT INTO Student VALUES (...)
    Parser->>Parser: è¯­æ³•è§£æ
    Parser->>Validator: éªŒè¯è¡¨ç»“æ„
    Validator->>Validator: æ£€æŸ¥çº¦æŸ
    Validator->>Validator: éªŒè¯æ•°æ®ç±»å‹
    Validator->>Storage: æ‰§è¡ŒINSERT
    Storage->>Storage: å†™å…¥æ•°æ®
    Storage->>Storage: æ›´æ–°ç´¢å¼•
    Storage-->>Client: è¿”å›æ’å…¥è¡Œæ•°
```

---

## ä¸‰ã€UPDATE

### 3.1 åŸºæœ¬è¯­æ³•

**UPDATEè¯­æ³•**ï¼š

```sql
UPDATE table_name
SET column_name = value [, column_name = value ...]
WHERE condition;
```

### 3.2 åœºæ™¯ç¤ºä¾‹ï¼šå­¦ç”Ÿä¿¡æ¯æ›´æ–°

**ä¸šåŠ¡éœ€æ±‚**ï¼šæ›´æ–°å­¦ç”Ÿä¿¡æ¯ï¼ŒåŒ…æ‹¬å¹´é¾„ã€ä¸“ä¸šå’Œé‚®ç®±ã€‚

**UPDATEå®ç°**ï¼š

```sql
-- å•è¡Œæ›´æ–°
UPDATE Student
SET age = 21, major = 'Data Science'
WHERE student_id = 1;

-- æ‰¹é‡æ›´æ–°
UPDATE Student
SET age = age + 1
WHERE major = 'Computer Science';

-- ä½¿ç”¨å­æŸ¥è¯¢æ›´æ–°
UPDATE Enrollment
SET score = score + 5
WHERE course_id IN (
    SELECT course_id
    FROM Course
    WHERE instructor = 'Dr. Smith'
);
```

---

## å››ã€DELETE

### 4.1 åŸºæœ¬è¯­æ³•

**DELETEè¯­æ³•**ï¼š

```sql
DELETE FROM table_name
WHERE condition;
```

### 4.2 åœºæ™¯ç¤ºä¾‹ï¼šå­¦ç”Ÿæ•°æ®åˆ é™¤

**ä¸šåŠ¡éœ€æ±‚**ï¼šåˆ é™¤å·²æ¯•ä¸šå­¦ç”Ÿçš„é€‰è¯¾è®°å½•ï¼Œä¿ç•™å­¦ç”ŸåŸºæœ¬ä¿¡æ¯ã€‚

**DELETEå®ç°**ï¼š

```sql
-- æ¡ä»¶åˆ é™¤
DELETE FROM Enrollment
WHERE student_id IN (
    SELECT student_id
    FROM Student
    WHERE graduation_date < '2023-01-01'
);

-- çº§è”åˆ é™¤ï¼ˆå¦‚æœå¤–é”®è®¾ç½®äº†CASCADEï¼‰
DELETE FROM Student
WHERE student_id = 1;
-- è‡ªåŠ¨åˆ é™¤ç›¸å…³çš„Enrollmentè®°å½•
```

---

## äº”ã€MERGE

### 5.1 åŸºæœ¬è¯­æ³•

**MERGEè¯­æ³•**ï¼š

```sql
MERGE INTO target_table AS target
USING source_table AS source
ON target.key = source.key
WHEN MATCHED THEN
    UPDATE SET ...
WHEN NOT MATCHED THEN
    INSERT ...;
```

### 5.2 åœºæ™¯ç¤ºä¾‹ï¼šå­¦ç”Ÿæ•°æ®åŒæ­¥

**ä¸šåŠ¡éœ€æ±‚**ï¼šä»å¤–éƒ¨ç³»ç»ŸåŒæ­¥å­¦ç”Ÿæ•°æ®ï¼Œå¦‚æœå­¦ç”Ÿå·²å­˜åœ¨åˆ™æ›´æ–°ï¼Œä¸å­˜åœ¨åˆ™æ’å…¥ã€‚

**MERGEå®ç°**ï¼š

```sql
MERGE INTO Student AS target
USING ExternalStudent AS source
ON target.student_id = source.student_id
WHEN MATCHED THEN
    UPDATE SET
        name = source.name,
        age = source.age,
        major = source.major,
        email = source.email
WHEN NOT MATCHED THEN
    INSERT (student_id, name, age, major, email)
    VALUES (source.student_id, source.name, source.age, source.major, source.email);
```

**MERGEæ‰§è¡Œæµç¨‹æ—¶åºå›¾**ï¼š

```mermaid
sequenceDiagram
    participant Client
    participant Parser
    participant Optimizer
    participant Storage

    Client->>Parser: MERGE INTO Student USING ...
    Parser->>Parser: è¯­æ³•è§£æ
    Parser->>Optimizer: ç”Ÿæˆæ‰§è¡Œè®¡åˆ’
    Optimizer->>Storage: è¯»å–sourceè¡¨
    Storage-->>Optimizer: è¿”å›sourceæ•°æ®
    Optimizer->>Storage: è¯»å–targetè¡¨
    Storage-->>Optimizer: è¿”å›targetæ•°æ®
    Optimizer->>Optimizer: åŒ¹é…è®°å½•
    Optimizer->>Storage: æ‰§è¡ŒUPDATE/INSERT
    Storage-->>Client: è¿”å›å½±å“è¡Œæ•°
```

---

## å…­ã€ç›¸å…³èµ„æº

### ç›¸å…³æ–‡æ¡£

- [æ•°æ®å®šä¹‰è¯­è¨€(DDL)](./04.01-æ•°æ®å®šä¹‰è¯­è¨€(DDL).md) - DDLè¯­æ³•
- [æ•°æ®æŸ¥è¯¢è¯­è¨€(DQL)](./04.03-æ•°æ®æŸ¥è¯¢è¯­è¨€(DQL).md) - DQLè¯­æ³•

---

**ç»´æŠ¤è€…**: SQL Standards Team
**æœ€åæ›´æ–°**: 2025-01-15
