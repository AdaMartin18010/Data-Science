# æ—¶æ€æ•°æ®å¤„ç†

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-01-16
> **ç‰ˆæœ¬**ï¼šv1.0.0
> **æ ‡å‡†ç‰ˆæœ¬**ï¼šSQL:2011, SQL:2023
> **éš¾åº¦**ï¼šâ­â­â­â­
> **åº”ç”¨åœºæ™¯**ï¼šå†å²æ•°æ®æŸ¥è¯¢ã€æ—¶æ€æ•°æ®åˆ†æã€æ•°æ®ç‰ˆæœ¬ç®¡ç†

---

## ğŸ“‹ ç›®å½•

- [æ—¶æ€æ•°æ®å¤„ç†](#æ—¶æ€æ•°æ®å¤„ç†)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
    - [1.0 æ—¶æ€æ•°æ®å†å²èƒŒæ™¯](#10-æ—¶æ€æ•°æ®å†å²èƒŒæ™¯)
    - [1.1 æ—¶æ€æ•°æ®çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾](#11-æ—¶æ€æ•°æ®çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾)
    - [1.2 æ—¶æ€æ•°æ®åº”ç”¨å†³ç­–æ ‘](#12-æ—¶æ€æ•°æ®åº”ç”¨å†³ç­–æ ‘)
    - [1.3 æ—¶æ€æ•°æ® vs å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ](#13-æ—¶æ€æ•°æ®-vs-å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ)
  - [äºŒã€æ—¶æ€æ•°æ®ç±»å‹](#äºŒæ—¶æ€æ•°æ®ç±»å‹)
    - [2.1 æ—¶æ€è¡¨](#21-æ—¶æ€è¡¨)
  - [ä¸‰ã€æ—¶æ€æŸ¥è¯¢](#ä¸‰æ—¶æ€æŸ¥è¯¢)
    - [3.1 æ—¶æ€æŸ¥è¯¢è¯­æ³•](#31-æ—¶æ€æŸ¥è¯¢è¯­æ³•)
    - [3.2 åœºæ™¯ç¤ºä¾‹1ï¼šå‘˜å·¥è–ªèµ„å†å²æŸ¥è¯¢](#32-åœºæ™¯ç¤ºä¾‹1å‘˜å·¥è–ªèµ„å†å²æŸ¥è¯¢)
    - [3.3 åœºæ™¯ç¤ºä¾‹2ï¼šäº§å“ä»·æ ¼å†å²è¿½è¸ª](#33-åœºæ™¯ç¤ºä¾‹2äº§å“ä»·æ ¼å†å²è¿½è¸ª)
  - [å››ã€æ—¶æ€çº¦æŸ](#å››æ—¶æ€çº¦æŸ)
    - [4.1 æ—¶æ€çº¦æŸ](#41-æ—¶æ€çº¦æŸ)
  - [äº”ã€æ—¶æ€ç´¢å¼•](#äº”æ—¶æ€ç´¢å¼•)
    - [5.1 æ—¶æ€ç´¢å¼•](#51-æ—¶æ€ç´¢å¼•)
  - [å…­ã€PostgreSQL 18 æ—¶æ€æ•°æ®å®ç° ğŸ†•](#å…­postgresql-18-æ—¶æ€æ•°æ®å®ç°-)
    - [6.1 PostgreSQLæ—¶æ€è¡¨å®ç°](#61-postgresqlæ—¶æ€è¡¨å®ç°)
    - [6.2 PostgreSQL 18 æ—¶æ€æŸ¥è¯¢ç¤ºä¾‹](#62-postgresql-18-æ—¶æ€æŸ¥è¯¢ç¤ºä¾‹)
  - [ä¸ƒã€SQLite 3.45+ æ—¶æ€æ•°æ®å®ç° ğŸ†•](#ä¸ƒsqlite-345-æ—¶æ€æ•°æ®å®ç°-)
    - [7.1 SQLiteæ—¶æ€è¡¨å®ç°](#71-sqliteæ—¶æ€è¡¨å®ç°)
    - [7.2 SQLiteæ—¶æ€æŸ¥è¯¢](#72-sqliteæ—¶æ€æŸ¥è¯¢)
  - [å…«ã€æ—¶æ€æ•°æ®å½¢å¼åŒ–ç†è®º ğŸ†•](#å…«æ—¶æ€æ•°æ®å½¢å¼åŒ–ç†è®º-)
    - [8.1 æ—¶æ€å…³ç³»å½¢å¼åŒ–å®šä¹‰](#81-æ—¶æ€å…³ç³»å½¢å¼åŒ–å®šä¹‰)
    - [8.2 æ—¶æ€æ“ä½œè¯­ä¹‰](#82-æ—¶æ€æ“ä½œè¯­ä¹‰)
  - [ä¹ã€ç›¸å…³èµ„æº](#ä¹ç›¸å…³èµ„æº)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)
    - [å¤–éƒ¨èµ„æº](#å¤–éƒ¨èµ„æº)

---

## ä¸€ã€æ¦‚è¿°

**æ—¶æ€æ•°æ®ï¼ˆTemporal Dataï¼‰**æ˜¯SQL:2011å¼•å…¥çš„ç‰¹æ€§ï¼Œç”¨äºå¤„ç†å…·æœ‰æ—¶é—´ç»´åº¦çš„æ•°æ®ã€‚

**æ—¶æ€æ•°æ®ç‰¹ç‚¹**ï¼š

- æ”¯æŒå†å²æ•°æ®æŸ¥è¯¢
- è‡ªåŠ¨ç»´æŠ¤æ•°æ®ç‰ˆæœ¬
- æ”¯æŒæ—¶é—´ç‚¹æŸ¥è¯¢

### 1.0 æ—¶æ€æ•°æ®å†å²èƒŒæ™¯

**æ—¶æ€æ•°æ®çš„å‘å±•å†ç¨‹**ï¼š

- **SQL:2011**ï¼šæ­£å¼å¼•å…¥æ—¶æ€æ•°æ®æ”¯æŒï¼ŒåŒ…æ‹¬æ—¶æ€è¡¨ï¼ˆTemporal Tablesï¼‰ã€æ—¶æ€æŸ¥è¯¢ï¼ˆTemporal Queriesï¼‰
- **SQL:2016**ï¼šå¢å¼ºäº†æ—¶æ€æ•°æ®çš„åŠŸèƒ½ï¼Œæ”¹è¿›äº†æ—¶æ€æŸ¥è¯¢çš„æ€§èƒ½
- **SQL:2023**ï¼šè¿›ä¸€æ­¥å®Œå–„äº†æ—¶æ€æ•°æ®çš„è¯­æ³•å’ŒåŠŸèƒ½

**æ—¶æ€æ•°æ®çš„è®¾è®¡åŠ¨æœº**ï¼š

æ—¶æ€æ•°æ®çš„è®¾è®¡æ˜¯ä¸ºäº†è§£å†³ä¼ ç»ŸSQLåœ¨å¤„ç†å†å²æ•°æ®å’Œæ•°æ®ç‰ˆæœ¬ç®¡ç†æ—¶çš„å±€é™æ€§ï¼š

1. **å†å²æ•°æ®æŸ¥è¯¢éœ€æ±‚**ï¼šéœ€è¦æŸ¥è¯¢æ•°æ®åœ¨ç‰¹å®šæ—¶é—´ç‚¹çš„çŠ¶æ€
2. **æ•°æ®ç‰ˆæœ¬ç®¡ç†éœ€æ±‚**ï¼šéœ€è¦è‡ªåŠ¨ç»´æŠ¤æ•°æ®çš„ç‰ˆæœ¬å†å²
3. **å®¡è®¡è¿½è¸ªéœ€æ±‚**ï¼šéœ€è¦è¿½è¸ªæ•°æ®çš„å˜æ›´å†å²
4. **æ—¶é—´åºåˆ—åˆ†æéœ€æ±‚**ï¼šéœ€è¦åˆ†ææ•°æ®éšæ—¶é—´çš„å˜åŒ–è¶‹åŠ¿

**æ—¶æ€æ•°æ®ä¸å…³ç³»æ¨¡å‹çš„å…³ç³»**ï¼š

æ—¶æ€æ•°æ®æ‰©å±•äº†å…³ç³»æ¨¡å‹ï¼Œå¼•å…¥äº†"æ—¶é—´ç»´åº¦"çš„æ¦‚å¿µã€‚åœ¨å…³ç³»æ¨¡å‹ä¸­ï¼Œå…³ç³»æ˜¯é™æ€çš„ï¼Œè€Œæ—¶æ€å…³ç³»æ˜¯åŠ¨æ€çš„ï¼ŒåŒ…å«äº†æ—¶é—´ä¿¡æ¯ã€‚è¿™å¯ä»¥çœ‹ä½œæ˜¯å…³ç³»æ¨¡å‹çš„ä¸€ç§æ‰©å±•ï¼Œæä¾›äº†å¤„ç†æ—¶é—´ç»´åº¦æ•°æ®çš„èƒ½åŠ›ã€‚

### 1.1 æ—¶æ€æ•°æ®çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((æ—¶æ€æ•°æ®))
    æ—¶æ€è¡¨
      SYSTEM VERSIONING
        ç³»ç»Ÿç‰ˆæœ¬æ§åˆ¶
        è‡ªåŠ¨æ—¶é—´æˆ³
      APPLICATION VERSIONING
        åº”ç”¨ç‰ˆæœ¬æ§åˆ¶
        ä¸šåŠ¡æ—¶é—´
    æ—¶æ€æŸ¥è¯¢
      AS OF
        æ—¶é—´ç‚¹æŸ¥è¯¢
        å†å²å¿«ç…§
      BETWEEN
        æ—¶é—´èŒƒå›´æŸ¥è¯¢
        æ—¶é—´æ®µæŸ¥è¯¢
      FROM ... TO
        æ—¶é—´åŒºé—´æŸ¥è¯¢
        ç‰ˆæœ¬æŸ¥è¯¢
    æ—¶æ€çº¦æŸ
      æ—¶é—´èŒƒå›´çº¦æŸ
        æœ‰æ•ˆæ€§çº¦æŸ
        é‡å æ£€æŸ¥
      æ—¶æ€å®Œæ•´æ€§
        å‚ç…§å®Œæ•´æ€§
        æ—¶æ€å¤–é”®
    åº”ç”¨åœºæ™¯
      å®¡è®¡è¿½è¸ª
        å˜æ›´å†å²
        æ“ä½œæ—¥å¿—
      ç‰ˆæœ¬ç®¡ç†
        é…ç½®ç‰ˆæœ¬
        æ–‡æ¡£ç‰ˆæœ¬
      æ—¶é—´åºåˆ—
        å†å²æ•°æ®
        è¶‹åŠ¿åˆ†æ
```

### 1.2 æ—¶æ€æ•°æ®åº”ç”¨å†³ç­–æ ‘

```mermaid
flowchart TD
    A[éœ€è¦æ—¶æ€æ•°æ®?] --> B{éœ€æ±‚ç±»å‹}
    B -->|å†å²æŸ¥è¯¢| C{æŸ¥è¯¢æ–¹å¼}
    B -->|ç‰ˆæœ¬ç®¡ç†| D[æ—¶æ€è¡¨]
    B -->|å®¡è®¡è¿½è¸ª| D

    C -->|æ—¶é—´ç‚¹| E[AS OFæŸ¥è¯¢]
    C -->|æ—¶é—´èŒƒå›´| F[BETWEENæŸ¥è¯¢]
    C -->|æ—¶é—´æ®µ| G[FROM ... TOæŸ¥è¯¢]

    D --> H{ç‰ˆæœ¬æ§åˆ¶ç±»å‹}
    H -->|ç³»ç»Ÿæ—¶é—´| I[SYSTEM VERSIONING]
    H -->|ä¸šåŠ¡æ—¶é—´| J[APPLICATION VERSIONING]

    E --> K[æ‰§è¡Œæ—¶æ€æŸ¥è¯¢]
    F --> K
    G --> K
    I --> K
    J --> K
```

### 1.3 æ—¶æ€æ•°æ® vs å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ

| æ–¹æ¡ˆ | å®ç°æ–¹å¼ | è‡ªåŠ¨ç»´æŠ¤ | æŸ¥è¯¢æ€§èƒ½ | å­˜å‚¨å¼€é”€ | é€‚ç”¨åœºæ™¯ |
|------|---------|---------|---------|---------|---------|
| **æ—¶æ€è¡¨** | SYSTEM VERSIONING | âœ… è‡ªåŠ¨ | â­â­â­â­ | ä¸­ | å†å²æ•°æ®ç®¡ç† |
| **å†å²è¡¨** | æ‰‹åŠ¨ç»´æŠ¤ | âŒ æ‰‹åŠ¨ | â­â­â­ | é«˜ | ç®€å•å†å²è®°å½• |
| **ç‰ˆæœ¬å­—æ®µ** | ç‰ˆæœ¬å·å­—æ®µ | âŒ æ‰‹åŠ¨ | â­â­â­â­ | ä½ | ç‰ˆæœ¬æ§åˆ¶ |
| **æ—¶é—´æˆ³å­—æ®µ** | æ—¶é—´æˆ³å­—æ®µ | âŒ æ‰‹åŠ¨ | â­â­â­ | ä½ | ç®€å•æ—¶é—´æŸ¥è¯¢ |

---

## äºŒã€æ—¶æ€æ•°æ®ç±»å‹

### 2.1 æ—¶æ€è¡¨

**æ—¶æ€è¡¨å®šä¹‰**ï¼š

```sql
CREATE TABLE Employee (
    id INTEGER,
    name VARCHAR(50),
    salary DECIMAL(10,2),
    PERIOD FOR SYSTEM_TIME (start_time, end_time)
) WITH SYSTEM VERSIONING;
```

---

## ä¸‰ã€æ—¶æ€æŸ¥è¯¢

### 3.1 æ—¶æ€æŸ¥è¯¢è¯­æ³•

### 3.2 åœºæ™¯ç¤ºä¾‹1ï¼šå‘˜å·¥è–ªèµ„å†å²æŸ¥è¯¢

**ä¸šåŠ¡éœ€æ±‚**ï¼šè·Ÿè¸ªå‘˜å·¥è–ªèµ„å˜æ›´å†å²ï¼Œæ”¯æŒæŸ¥è¯¢ä»»æ„æ—¶é—´ç‚¹çš„è–ªèµ„ä¿¡æ¯ã€‚

**æ•°æ®æ¨¡å‹**ï¼š

```mermaid
erDiagram
    Employee ||--o{ SalaryHistory : "æ‹¥æœ‰"
    Employee {
        int employee_id PK
        string name
        string department
    }
    SalaryHistory {
        int employee_id FK
        decimal salary
        timestamp start_time
        timestamp end_time
    }
```

**æ—¶æ€è¡¨å®šä¹‰**ï¼š

```sql
-- åˆ›å»ºæ—¶æ€è¡¨
CREATE TABLE Employee (
    employee_id INTEGER PRIMARY KEY,
    name VARCHAR(50),
    department VARCHAR(50),
    salary DECIMAL(10,2),
    PERIOD FOR SYSTEM_TIME (start_time, end_time)
) WITH SYSTEM VERSIONING;

-- æ’å…¥æ•°æ®
INSERT INTO Employee (employee_id, name, department, salary)
VALUES (1, 'Alice', 'Engineering', 50000);

-- æ›´æ–°è–ªèµ„ï¼ˆç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºå†å²è®°å½•ï¼‰
UPDATE Employee
SET salary = 55000
WHERE employee_id = 1;
```

**æ—¶æ€æŸ¥è¯¢ç¤ºä¾‹**ï¼š

```sql
-- æŸ¥è¯¢å½“å‰æ•°æ®
SELECT * FROM Employee;

-- æŸ¥è¯¢2023-01-01çš„è–ªèµ„
SELECT
    employee_id,
    name,
    salary
FROM Employee
FOR SYSTEM_TIME AS OF '2023-01-01'
WHERE employee_id = 1;

-- æŸ¥è¯¢2023å¹´å…¨å¹´çš„è–ªèµ„å˜æ›´
SELECT
    employee_id,
    name,
    salary,
    start_time,
    end_time
FROM Employee
FOR SYSTEM_TIME BETWEEN '2023-01-01' AND '2023-12-31'
WHERE employee_id = 1
ORDER BY start_time;
```

**æŸ¥è¯¢æ‰§è¡Œæµç¨‹æ—¶åºå›¾**ï¼š

```mermaid
sequenceDiagram
    participant Client
    participant QueryEngine
    participant TemporalTable
    participant HistoryTable

    Client->>QueryEngine: FOR SYSTEM_TIME AS OF '2023-01-01'
    QueryEngine->>TemporalTable: æŸ¥è¯¢å½“å‰è¡¨
    TemporalTable-->>QueryEngine: è¿”å›å½“å‰æ•°æ®
    QueryEngine->>HistoryTable: æŸ¥è¯¢å†å²è¡¨
    HistoryTable-->>QueryEngine: è¿”å›å†å²æ•°æ®
    QueryEngine->>QueryEngine: åˆå¹¶æ—¶æ€æ•°æ®
    QueryEngine->>QueryEngine: åº”ç”¨æ—¶é—´ç‚¹è¿‡æ»¤
    QueryEngine-->>Client: è¿”å›æ—¶æ€æŸ¥è¯¢ç»“æœ
```

### 3.3 åœºæ™¯ç¤ºä¾‹2ï¼šäº§å“ä»·æ ¼å†å²è¿½è¸ª

**ä¸šåŠ¡éœ€æ±‚**ï¼šè¿½è¸ªäº§å“ä»·æ ¼å˜æ›´å†å²ï¼Œæ”¯æŒä»·æ ¼è¶‹åŠ¿åˆ†æã€‚

**æ—¶æ€è¡¨å®šä¹‰**ï¼š

```sql
CREATE TABLE Product (
    product_id INTEGER PRIMARY KEY,
    product_name VARCHAR(100),
    price DECIMAL(10,2),
    PERIOD FOR SYSTEM_TIME (start_time, end_time)
) WITH SYSTEM VERSIONING;
```

**æ—¶æ€æŸ¥è¯¢ç¤ºä¾‹**ï¼š

```sql
-- æŸ¥è¯¢äº§å“ä»·æ ¼å†å²
SELECT
    product_id,
    product_name,
    price,
    start_time,
    end_time
FROM Product
FOR SYSTEM_TIME FROM '2023-01-01' TO '2023-12-31'
WHERE product_id = 101
ORDER BY start_time;

-- æŸ¥è¯¢ä»·æ ¼å˜æ›´æ¬¡æ•°
SELECT
    product_id,
    product_name,
    COUNT(*) - 1 AS price_change_count
FROM Product
FOR SYSTEM_TIME ALL
WHERE product_id = 101
GROUP BY product_id, product_name;
```

---

## å››ã€æ—¶æ€çº¦æŸ

### 4.1 æ—¶æ€çº¦æŸ

**æ—¶æ€çº¦æŸ**ï¼š

æ—¶æ€è¡¨æ”¯æŒæ—¶æ€å®Œæ•´æ€§çº¦æŸï¼Œç¡®ä¿æ—¶é—´èŒƒå›´çš„æœ‰æ•ˆæ€§ã€‚

---

## äº”ã€æ—¶æ€ç´¢å¼•

### 5.1 æ—¶æ€ç´¢å¼•

**æ—¶æ€ç´¢å¼•**ï¼š

æ—¶æ€è¡¨å¯ä»¥ä½¿ç”¨æ—¶é—´èŒƒå›´ç´¢å¼•ï¼Œæé«˜æ—¶æ€æŸ¥è¯¢æ€§èƒ½ã€‚

---

## å…­ã€PostgreSQL 18 æ—¶æ€æ•°æ®å®ç° ğŸ†•

### 6.1 PostgreSQLæ—¶æ€è¡¨å®ç°

PostgreSQLä¸ç›´æ¥æ”¯æŒSQL:2011çš„SYSTEM VERSIONINGè¯­æ³•ï¼Œä½†å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ç­‰æ•ˆåŠŸèƒ½ï¼š

**æ–¹æ¡ˆ1ï¼šä½¿ç”¨è§¦å‘å™¨å®ç°**:

```sql
-- PostgreSQL 18: æ‰‹åŠ¨å®ç°æ—¶æ€è¡¨
CREATE TABLE employees_history (
    emp_id INTEGER NOT NULL,
    emp_name VARCHAR(100),
    salary DECIMAL(10,2),
    department VARCHAR(50),
    valid_from TIMESTAMPTZ NOT NULL,
    valid_to TIMESTAMPTZ NOT NULL DEFAULT '9999-12-31',
    PRIMARY KEY (emp_id, valid_from)
);

-- å½“å‰æ•°æ®è§†å›¾
CREATE VIEW employees_current AS
SELECT emp_id, emp_name, salary, department, valid_from
FROM employees_history
WHERE valid_to = '9999-12-31';

-- æ›´æ–°è§¦å‘å™¨
CREATE OR REPLACE FUNCTION update_employee_history()
RETURNS TRIGGER AS $$
BEGIN
    -- å…³é—­æ—§è®°å½•
    UPDATE employees_history
    SET valid_to = NOW()
    WHERE emp_id = NEW.emp_id AND valid_to = '9999-12-31';

    -- æ’å…¥æ–°è®°å½•
    INSERT INTO employees_history (emp_id, emp_name, salary, department, valid_from)
    VALUES (NEW.emp_id, NEW.emp_name, NEW.salary, NEW.department, NOW());

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

**æ–¹æ¡ˆ2ï¼šä½¿ç”¨temporal_tablesæ‰©å±•**:

```sql
-- å®‰è£…temporal_tablesæ‰©å±•
CREATE EXTENSION IF NOT EXISTS temporal_tables;

-- åˆ›å»ºæ—¶æ€è¡¨
CREATE TABLE employees (
    emp_id INTEGER PRIMARY KEY,
    emp_name VARCHAR(100),
    salary DECIMAL(10,2),
    sys_period tstzrange NOT NULL
);

-- åˆ›å»ºå†å²è¡¨
CREATE TABLE employees_history (LIKE employees);

-- è®¾ç½®ç³»ç»Ÿç‰ˆæœ¬æ§åˆ¶
CREATE TRIGGER versioning_trigger
BEFORE INSERT OR UPDATE OR DELETE ON employees
FOR EACH ROW EXECUTE PROCEDURE versioning(
    'sys_period', 'employees_history', true
);
```

### 6.2 PostgreSQL 18 æ—¶æ€æŸ¥è¯¢ç¤ºä¾‹

```sql
-- æŸ¥è¯¢ç‰¹å®šæ—¶é—´ç‚¹çš„æ•°æ®
SELECT * FROM employees_history
WHERE emp_id = 1
  AND valid_from <= '2024-06-01'
  AND valid_to > '2024-06-01';

-- æŸ¥è¯¢æ—¶é—´èŒƒå›´å†…çš„æ‰€æœ‰ç‰ˆæœ¬
SELECT
    emp_id,
    emp_name,
    salary,
    valid_from,
    valid_to,
    -- è®¡ç®—æ¯ä¸ªç‰ˆæœ¬çš„æœ‰æ•ˆæ—¶é•¿
    valid_to - valid_from AS duration
FROM employees_history
WHERE emp_id = 1
  AND valid_from < '2025-01-01'
  AND valid_to > '2024-01-01'
ORDER BY valid_from;

-- è–ªèµ„å˜åŒ–åˆ†æï¼ˆä½¿ç”¨çª—å£å‡½æ•°ï¼‰
WITH salary_changes AS (
    SELECT
        emp_id,
        emp_name,
        salary,
        valid_from,
        LAG(salary) OVER (PARTITION BY emp_id ORDER BY valid_from) AS prev_salary
    FROM employees_history
    WHERE emp_id = 1
)
SELECT
    emp_name,
    valid_from AS change_date,
    prev_salary,
    salary AS new_salary,
    salary - prev_salary AS change_amount,
    ROUND((salary - prev_salary) * 100.0 / prev_salary, 2) AS change_pct
FROM salary_changes
WHERE prev_salary IS NOT NULL;
```

---

## ä¸ƒã€SQLite 3.45+ æ—¶æ€æ•°æ®å®ç° ğŸ†•

### 7.1 SQLiteæ—¶æ€è¡¨å®ç°

```sql
-- SQLite 3.45+: ä½¿ç”¨è§¦å‘å™¨å®ç°æ—¶æ€è¡¨
CREATE TABLE employees (
    emp_id INTEGER PRIMARY KEY,
    emp_name TEXT NOT NULL,
    salary REAL,
    department TEXT,
    updated_at TEXT DEFAULT (datetime('now'))
);

CREATE TABLE employees_history (
    history_id INTEGER PRIMARY KEY AUTOINCREMENT,
    emp_id INTEGER NOT NULL,
    emp_name TEXT,
    salary REAL,
    department TEXT,
    valid_from TEXT NOT NULL,
    valid_to TEXT NOT NULL,
    operation TEXT NOT NULL  -- 'INSERT', 'UPDATE', 'DELETE'
);

-- æ›´æ–°è§¦å‘å™¨
CREATE TRIGGER employees_update_history
AFTER UPDATE ON employees
BEGIN
    INSERT INTO employees_history (emp_id, emp_name, salary, department, valid_from, valid_to, operation)
    VALUES (
        OLD.emp_id,
        OLD.emp_name,
        OLD.salary,
        OLD.department,
        OLD.updated_at,
        datetime('now'),
        'UPDATE'
    );

    UPDATE employees SET updated_at = datetime('now') WHERE emp_id = NEW.emp_id;
END;

-- åˆ é™¤è§¦å‘å™¨
CREATE TRIGGER employees_delete_history
BEFORE DELETE ON employees
BEGIN
    INSERT INTO employees_history (emp_id, emp_name, salary, department, valid_from, valid_to, operation)
    VALUES (
        OLD.emp_id,
        OLD.emp_name,
        OLD.salary,
        OLD.department,
        OLD.updated_at,
        datetime('now'),
        'DELETE'
    );
END;
```

### 7.2 SQLiteæ—¶æ€æŸ¥è¯¢

```sql
-- æŸ¥è¯¢ç‰¹å®šæ—¶é—´ç‚¹çš„æ•°æ®
SELECT * FROM employees_history
WHERE emp_id = 1
  AND valid_from <= '2024-06-01'
  AND valid_to > '2024-06-01';

-- æŸ¥è¯¢å®Œæ•´å†å²
SELECT
    emp_id,
    emp_name,
    salary,
    valid_from,
    valid_to,
    operation,
    -- è®¡ç®—æœ‰æ•ˆå¤©æ•°
    julianday(valid_to) - julianday(valid_from) AS duration_days
FROM employees_history
WHERE emp_id = 1
ORDER BY valid_from;

-- SQLite 3.45+: ä½¿ç”¨JSONèšåˆè¿”å›å†å²
SELECT
    emp_id,
    json_group_array(
        json_object(
            'salary', salary,
            'from', valid_from,
            'to', valid_to
        )
    ) AS salary_history
FROM employees_history
GROUP BY emp_id;
```

---

## å…«ã€æ—¶æ€æ•°æ®å½¢å¼åŒ–ç†è®º ğŸ†•

### 8.1 æ—¶æ€å…³ç³»å½¢å¼åŒ–å®šä¹‰

```text
å®šä¹‰ï¼šæ—¶æ€å…³ç³» (Temporal Relation)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ—¶æ€å…³ç³» R_T æ˜¯ä¸€ä¸ªä¸‰å…ƒç»„ (R, T_s, T_e)ï¼Œå…¶ä¸­ï¼š
- R æ˜¯åŸºç¡€å…³ç³»
- T_s æ˜¯æœ‰æ•ˆèµ·å§‹æ—¶é—´å±æ€§
- T_e æ˜¯æœ‰æ•ˆç»“æŸæ—¶é—´å±æ€§

æ—¶æ€å…ƒç»„çš„æœ‰æ•ˆæœŸï¼š
  valid(t) = [t.T_s, t.T_e)

æ—¶æ€å¿«ç…§ï¼š
  Snapshot(R_T, Ï„) = { t | t âˆˆ R_T âˆ§ Ï„ âˆˆ [t.T_s, t.T_e) }

å®šç†ï¼šæ—¶æ€å¿«ç…§ä¸ä¼ ç»Ÿå…³ç³»çš„ç­‰ä»·æ€§
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å¯¹äºä»»æ„æ—¶é—´ç‚¹Ï„ï¼ŒSnapshot(R_T, Ï„) æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„å…³ç³»å®ä¾‹ã€‚

è¯æ˜ï¼š
1. Snapshot(R_T, Ï„) åŒ…å«æœ‰é™ä¸ªå…ƒç»„ï¼ˆç”±R_Tæœ‰é™æ€§ï¼‰
2. æ¯ä¸ªå…ƒç»„çš„ç»“æ„ä¸Rçš„æ¨¡å¼ä¸€è‡´
3. æ»¡è¶³Rçš„æ‰€æœ‰å®Œæ•´æ€§çº¦æŸï¼ˆåœ¨è¯¥æ—¶é—´ç‚¹ï¼‰
âˆ´ Snapshot(R_T, Ï„) æ˜¯æœ‰æ•ˆå…³ç³»å®ä¾‹ âˆ
```

### 8.2 æ—¶æ€æ“ä½œè¯­ä¹‰

```text
æ—¶æ€é€‰æ‹© (Temporal Selection):
  Ïƒ_T[t1,t2](R_T) = { r | r âˆˆ R_T âˆ§ valid(r) âˆ© [t1,t2) â‰  âˆ… }

æ—¶æ€æŠ•å½± (Temporal Projection):
  Ï€_T_A(R_T) = { (a, T_s, T_e) | âˆƒr âˆˆ R_T: r.A = a âˆ§ T_s = r.T_s âˆ§ T_e = r.T_e }

æ—¶æ€åˆå¹¶ (Temporal Coalescing):
  åˆå¹¶ç›¸é‚»ä¸”å±æ€§ç›¸åŒçš„æ—¶æ€å…ƒç»„

  Coalesce(R_T) = æœ€å°åŒ–æ—¶æ€å…ƒç»„æ•°é‡ï¼Œä¿æŒè¯­ä¹‰ç­‰ä»·

å®šç†ï¼šæ—¶æ€åˆå¹¶çš„æ­£ç¡®æ€§
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âˆ€Ï„: Snapshot(R_T, Ï„) = Snapshot(Coalesce(R_T), Ï„)

è¯æ˜ç•¥ï¼ˆé€šè¿‡æ—¶é—´åŒºé—´çš„å¹¶é›†è¿ç®—ï¼‰
```

---

## ä¹ã€ç›¸å…³èµ„æº

### ç›¸å…³æ–‡æ¡£

- [SQL:2011æ ‡å‡†](../02-SQLæ ‡å‡†æ¼”è¿›/02.03-SQL-1999åˆ°SQL-2011æ ‡å‡†.md#äº”sql2011æ ‡å‡†) - SQL:2011æ ‡å‡†
- [SQL:2023æ ‡å‡†è¯¦è§£](../02-SQLæ ‡å‡†æ¼”è¿›/02.05-SQL-2023æ ‡å‡†è¯¦è§£.md) - SQL:2023æ ‡å‡†
- [äº‹åŠ¡ç†è®º](../01-ç†è®ºåŸºç¡€/01.05-äº‹åŠ¡ç†è®º.md) - æ—¶æ€ä¸äº‹åŠ¡çš„å…³ç³»

### å¤–éƒ¨èµ„æº

- [PostgreSQL temporal_tablesæ‰©å±•](https://github.com/arkhipov/temporal_tables)
- [SQL:2011 Temporal Features](https://en.wikipedia.org/wiki/SQL:2011)

---

**ç»´æŠ¤è€…**: SQL Standards Team
**æœ€åæ›´æ–°**: 2025-12-01
