# JSON支持详解

> **创建日期**：2025-01-15
> **最后更新**：2025-01-16
> **版本**：v1.0.0
> **标准版本**：SQL:2016, SQL:2023
> **难度**：⭐⭐⭐⭐
> **应用场景**：JSON数据处理、半结构化数据存储、现代应用集成

---

## 📋 目录

- [JSON支持详解](#json支持详解)
  - [📋 目录](#-目录)
  - [一、概述](#一概述)
    - [1.0 JSON支持历史背景](#10-json支持历史背景)
    - [1.1 JSON支持知识体系思维导图](#11-json支持知识体系思维导图)
    - [1.2 JSON操作选择决策树](#12-json操作选择决策树)
    - [1.3 JSON函数对比矩阵](#13-json函数对比矩阵)
  - [二、JSON数据类型](#二json数据类型)
    - [2.1 JSON类型](#21-json类型)
  - [三、JSON函数](#三json函数)
    - [3.1 JSON函数列表](#31-json函数列表)
  - [四、JSON查询](#四json查询)
    - [4.1 JSON查询示例](#41-json查询示例)
    - [4.3 场景示例2：用户配置系统 - 用户偏好查询](#43-场景示例2用户配置系统---用户偏好查询)
  - [五、JSON索引](#五json索引)
    - [5.1 JSON索引](#51-json索引)
  - [六、相关资源](#六相关资源)
    - [相关文档](#相关文档)

---

## 一、概述

**JSON支持**是SQL:2016引入的重要特性，允许在SQL中存储和查询JSON数据。

**JSON支持版本**：

- SQL:2016：基础JSON支持
- SQL:2023：增强JSON支持（JSON_TABLE等）

### 1.0 JSON支持历史背景

**JSON支持的发展历程**：

- **SQL:2016**：正式引入JSON支持，包括JSON数据类型、JSON函数（JSON_VALUE、JSON_QUERY、JSON_EXISTS等）
- **SQL:2023**：增强了JSON支持，添加了JSON_TABLE函数、改进了JSON_OBJECT和JSON_ARRAY函数

**JSON支持的设计动机**：

JSON支持的设计是为了解决传统SQL在处理半结构化数据时的局限性：

1. **半结构化数据需求**：现代应用需要处理JSON、XML等半结构化数据
2. **NoSQL集成需求**：需要与NoSQL数据库集成，处理JSON文档
3. **API集成需求**：REST API通常使用JSON格式，需要在数据库中存储和查询JSON数据
4. **灵活数据模型需求**：某些场景需要灵活的数据模型，JSON提供了这种灵活性

**JSON支持与关系模型的关系**：

JSON支持扩展了关系模型，允许在关系表中存储和查询JSON数据。JSON可以看作是关系模型的一种扩展，提供了处理半结构化数据的能力。

### 1.1 JSON支持知识体系思维导图

```mermaid
mindmap
  root((JSON支持))
    数据类型
      JSON
        文本存储
        验证支持
      JSONB
        二进制存储
        索引支持
        查询优化
    函数操作
      JSON_VALUE
        提取标量值
        类型转换
      JSON_QUERY
        提取对象/数组
        保持JSON格式
      JSON_EXISTS
        路径存在检查
        条件过滤
      JSON_TABLE
        转换为关系表
        列定义
    构造函数
      JSON_OBJECT
        对象构造
        键值对
      JSON_ARRAY
        数组构造
        元素列表
    路径表达式
      JSONPath
        路径语法
        通配符
        过滤器
    应用场景
      半结构化数据
        配置存储
        元数据存储
      文档存储
        NoSQL集成
        文档数据库
      API集成
        REST API
        微服务
```

### 1.2 JSON操作选择决策树

```mermaid
flowchart TD
    A[需要JSON操作?] --> B{操作类型}
    B -->|提取值| C{值类型}
    B -->|检查存在| D[JSON_EXISTS]
    B -->|转换为表| E[JSON_TABLE]
    B -->|构造JSON| F{构造类型}

    C -->|标量值| G[JSON_VALUE]
    C -->|对象/数组| H[JSON_QUERY]

    F -->|对象| I[JSON_OBJECT]
    F -->|数组| J[JSON_ARRAY]

    G --> K[执行操作]
    H --> K
    D --> K
    E --> K
    I --> K
    J --> K
```

### 1.3 JSON函数对比矩阵

| 函数 | 输入 | 输出 | 用途 | SQL标准版本 |
|------|------|------|------|------------|
| **JSON_VALUE** | JSON, Path | 标量值 | 提取单个值 | SQL:2016 |
| **JSON_QUERY** | JSON, Path | JSON | 提取JSON片段 | SQL:2016 |
| **JSON_EXISTS** | JSON, Path | Boolean | 检查路径存在 | SQL:2016 |
| **JSON_TABLE** | JSON, Path | 关系表 | 转换为表 | SQL:2023 |
| **JSON_OBJECT** | 键值对 | JSON对象 | 构造对象 | SQL:2016 |
| **JSON_ARRAY** | 值列表 | JSON数组 | 构造数组 | SQL:2016 |

---

## 二、JSON数据类型

### 2.1 JSON类型

**JSON类型定义**：

```sql
CREATE TABLE products (
    id INTEGER,
    name VARCHAR(100),
    attributes JSON
);
```

---

## 三、JSON函数

### 3.1 JSON函数列表

**JSON函数**：

- JSON_VALUE()：提取JSON值
- JSON_QUERY()：提取JSON对象
- JSON_EXISTS()：检查JSON路径
- JSON_OBJECT()：创建JSON对象
- JSON_ARRAY()：创建JSON数组
- JSON_TABLE()：将JSON转换为表（SQL:2023）

---

## 四、JSON查询

### 4.1 JSON查询示例

**场景示例1：电商系统 - 商品属性查询**:

**业务需求**：在电商系统中，商品属性以JSON格式存储，需要查询特定属性的商品。

**数据模型**：

```mermaid
erDiagram
    Product ||--o{ OrderItem : "包含"
    Product {
        int product_id PK
        string product_name
        decimal price
        json attributes
    }
    OrderItem {
        int order_id FK
        int product_id FK
        int quantity
    }
```

**ER图说明**：

- Product表存储商品信息，attributes字段为JSON类型
- attributes包含color、size、brand等动态属性

**查询示例**：

```sql
-- 查询红色商品
SELECT
    product_id,
    product_name,
    price,
    JSON_VALUE(attributes, '$.color') AS color,
    JSON_VALUE(attributes, '$.size') AS size,
    JSON_QUERY(attributes, '$.specs') AS specs
FROM Product
WHERE JSON_VALUE(attributes, '$.color') = 'red';

-- 查询有折扣的商品
SELECT
    product_id,
    product_name,
    price,
    JSON_VALUE(attributes, '$.discount') AS discount
FROM Product
WHERE JSON_EXISTS(attributes, '$.discount')
  AND CAST(JSON_VALUE(attributes, '$.discount') AS DECIMAL) > 0.1;
```

### 4.3 场景示例2：用户配置系统 - 用户偏好查询

**业务需求**：用户偏好设置以JSON格式存储，需要查询和更新用户配置。

**数据模型**：

```mermaid
erDiagram
    User ||--o{ UserPreference : "拥有"
    User {
        int user_id PK
        string username
        string email
    }
    UserPreference {
        int user_id FK
        json preferences
    }
```

**查询示例**：

```sql
-- 查询用户偏好
SELECT
    u.user_id,
    u.username,
    JSON_VALUE(up.preferences, '$.theme') AS theme,
    JSON_VALUE(up.preferences, '$.language') AS language,
    JSON_VALUE(up.preferences, '$.notifications.email') AS email_notification
FROM User u
JOIN UserPreference up ON u.user_id = up.user_id
WHERE JSON_VALUE(up.preferences, '$.theme') = 'dark';

-- 更新用户偏好
UPDATE UserPreference
SET preferences = JSON_MODIFY(
    preferences,
    '$.theme',
    'light'
)
WHERE user_id = 1;
```

**查询执行流程时序图**：

```mermaid
sequenceDiagram
    participant Client
    participant QueryEngine
    participant JSONParser
    participant Storage

    Client->>QueryEngine: SELECT with JSON_VALUE
    QueryEngine->>Storage: 读取Product表
    Storage-->>QueryEngine: 返回JSON数据
    QueryEngine->>JSONParser: 解析JSON路径
    JSONParser->>JSONParser: 提取$.color值
    JSONParser-->>QueryEngine: 返回color值
    QueryEngine->>QueryEngine: 应用WHERE条件
    QueryEngine-->>Client: 返回结果集
```

---

## 五、JSON索引

### 5.1 JSON索引

**JSON索引**：

某些数据库支持JSON路径索引，提高JSON查询性能。

---

## 六、相关资源

### 相关文档

- [SQL:2016标准详解](../02-SQL标准演进/02.04-SQL-2016标准详解.md) - SQL:2016标准
- [SQL:2023标准详解](../02-SQL标准演进/02.05-SQL-2023标准详解.md) - SQL:2023标准

---

**维护者**: SQL Standards Team
**最后更新**: 2025-01-16
