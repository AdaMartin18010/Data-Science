# çª—å£å‡½æ•°è¯¦è§£

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-01-15
> **ç‰ˆæœ¬**ï¼šv1.0.0
> **éš¾åº¦**ï¼šâ­â­â­â­
> **åº”ç”¨åœºæ™¯**ï¼šæ•°æ®åˆ†æã€æ’åè®¡ç®—ã€ç´¯è®¡ç»Ÿè®¡

---

## ğŸ“‹ ç›®å½•

- [çª—å£å‡½æ•°è¯¦è§£](#çª—å£å‡½æ•°è¯¦è§£)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
    - [1.1 çª—å£å‡½æ•°çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾](#11-çª—å£å‡½æ•°çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾)
    - [1.2 çª—å£å‡½æ•°é€‰æ‹©å†³ç­–æ ‘](#12-çª—å£å‡½æ•°é€‰æ‹©å†³ç­–æ ‘)
  - [äºŒã€çª—å£å‡½æ•°è¯­æ³•](#äºŒçª—å£å‡½æ•°è¯­æ³•)
    - [2.1 åŸºæœ¬è¯­æ³•](#21-åŸºæœ¬è¯­æ³•)
    - [2.2 ç¤ºä¾‹](#22-ç¤ºä¾‹)
  - [ä¸‰ã€çª—å£å‡½æ•°ç±»å‹](#ä¸‰çª—å£å‡½æ•°ç±»å‹)
    - [3.1 æ’åå‡½æ•°](#31-æ’åå‡½æ•°)
    - [3.2 èšåˆå‡½æ•°](#32-èšåˆå‡½æ•°)
    - [3.3 å€¼å‡½æ•°](#33-å€¼å‡½æ•°)
  - [å››ã€çª—å£å‡½æ•°åº”ç”¨](#å››çª—å£å‡½æ•°åº”ç”¨)
    - [4.1 æ’ååº”ç”¨](#41-æ’ååº”ç”¨)
    - [4.1.1 åœºæ™¯ç¤ºä¾‹ï¼šå­¦ç”Ÿæˆç»©æ’ååˆ†æ](#411-åœºæ™¯ç¤ºä¾‹å­¦ç”Ÿæˆç»©æ’ååˆ†æ)
    - [4.2 ç´¯è®¡ç»Ÿè®¡](#42-ç´¯è®¡ç»Ÿè®¡)
    - [4.2.1 åœºæ™¯ç¤ºä¾‹ï¼šé”€å”®ç´¯è®¡ç»Ÿè®¡å’Œç§»åŠ¨å¹³å‡](#421-åœºæ™¯ç¤ºä¾‹é”€å”®ç´¯è®¡ç»Ÿè®¡å’Œç§»åŠ¨å¹³å‡)
    - [4.2.2 åœºæ™¯ç¤ºä¾‹ï¼šåŒæ¯”ç¯æ¯”åˆ†æ](#422-åœºæ™¯ç¤ºä¾‹åŒæ¯”ç¯æ¯”åˆ†æ)
  - [äº”ã€æ€§èƒ½ä¼˜åŒ–](#äº”æ€§èƒ½ä¼˜åŒ–)
    - [5.1 ä¼˜åŒ–å»ºè®®](#51-ä¼˜åŒ–å»ºè®®)
  - [å…­ã€ç›¸å…³èµ„æº](#å…­ç›¸å…³èµ„æº)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)

---

## ä¸€ã€æ¦‚è¿°

**çª—å£å‡½æ•°ï¼ˆWindow Functionsï¼‰**æ˜¯SQL:2003å¼•å…¥çš„é«˜çº§ç‰¹æ€§ï¼Œç”¨äºåœ¨æŸ¥è¯¢ç»“æœé›†çš„çª—å£ä¸Šæ‰§è¡Œè®¡ç®—ã€‚

**çª—å£å‡½æ•°ç‰¹ç‚¹**ï¼š

- ä¸æ”¹å˜ç»“æœé›†è¡Œæ•°
- å¯ä»¥è®¿é—®åŒä¸€æŸ¥è¯¢ä¸­å…¶ä»–è¡Œçš„æ•°æ®
- æ”¯æŒåˆ†åŒºå’Œæ’åº

### 1.1 çª—å£å‡½æ•°çŸ¥è¯†ä½“ç³»æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((çª—å£å‡½æ•°))
    å‡½æ•°ç±»å‹
      æ’åå‡½æ•°
        ROW_NUMBER
        RANK
        DENSE_RANK
        PERCENT_RANK
      èšåˆå‡½æ•°
        SUM OVER
        AVG OVER
        COUNT OVER
        MAX/MIN OVER
      å€¼å‡½æ•°
        LAG
        LEAD
        FIRST_VALUE
        LAST_VALUE
    çª—å£å®šä¹‰
      PARTITION BY
        åˆ†åŒºåˆ’åˆ†
        ç‹¬ç«‹è®¡ç®—
      ORDER BY
        æ’åºè§„åˆ™
        è®¡ç®—é¡ºåº
      ROWS/RANGE
        è¡ŒèŒƒå›´
        å€¼èŒƒå›´
    åº”ç”¨åœºæ™¯
      æ’åç»Ÿè®¡
        å­¦ç”Ÿæ’å
        é”€å”®æ’å
      ç´¯è®¡ç»Ÿè®¡
        ç´¯è®¡é”€å”®é¢
        ç´¯è®¡ç”¨æˆ·æ•°
      ç§»åŠ¨å¹³å‡
        è‚¡ç¥¨ä»·æ ¼
        æ¸©åº¦è¶‹åŠ¿
      åŒæ¯”ç¯æ¯”
        æœˆåº¦å¯¹æ¯”
        å¹´åº¦å¯¹æ¯”
    æ€§èƒ½ä¼˜åŒ–
      åˆ†åŒºä¼˜åŒ–
        å‡å°‘è®¡ç®—é‡
        å¹¶è¡Œå¤„ç†
      ç´¢å¼•ä½¿ç”¨
        æ’åºä¼˜åŒ–
        èŒƒå›´æŸ¥è¯¢
```

### 1.2 çª—å£å‡½æ•°é€‰æ‹©å†³ç­–æ ‘

```mermaid
flowchart TD
    A[éœ€è¦çª—å£å‡½æ•°?] --> B{éœ€è¦æ’å?}
    B -->|æ˜¯| C{å…è®¸å¹¶åˆ—?}
    C -->|å¦| D[ä½¿ç”¨ROW_NUMBER]
    C -->|æ˜¯| E{å¹¶åˆ—åè¿ç»­?}
    E -->|æ˜¯| F[ä½¿ç”¨DENSE_RANK]
    E -->|å¦| G[ä½¿ç”¨RANK]
    B -->|å¦| H{éœ€è¦èšåˆ?}
    H -->|æ˜¯| I{éœ€è¦ç´¯è®¡?}
    I -->|æ˜¯| J[ä½¿ç”¨SUM/AVG OVER ORDER BY]
    I -->|å¦| K[ä½¿ç”¨SUM/AVG OVER PARTITION BY]
    H -->|å¦| L{éœ€è¦å‰åå€¼?}
    L -->|æ˜¯| M{å‰ä¸€è¡Œ?}
    M -->|æ˜¯| N[ä½¿ç”¨LAG]
    M -->|å¦| O[ä½¿ç”¨LEAD]
    L -->|å¦| P{éœ€è¦é¦–å°¾å€¼?}
    P -->|æ˜¯| Q{ç¬¬ä¸€ä¸ªå€¼?}
    Q -->|æ˜¯| R[ä½¿ç”¨FIRST_VALUE]
    Q -->|å¦| S[ä½¿ç”¨LAST_VALUE]
```

---

## äºŒã€çª—å£å‡½æ•°è¯­æ³•

### 2.1 åŸºæœ¬è¯­æ³•

**çª—å£å‡½æ•°è¯­æ³•**ï¼š

```sql
function_name([arguments]) OVER (
    [PARTITION BY partition_list]
    [ORDER BY order_list]
    [ROWS | RANGE frame_clause]
)
```

### 2.2 ç¤ºä¾‹

**ç¤ºä¾‹**ï¼š

```sql
SELECT
    student_id,
    score,
    ROW_NUMBER() OVER (PARTITION BY class ORDER BY score DESC) as rank
FROM Scores;
```

---

## ä¸‰ã€çª—å£å‡½æ•°ç±»å‹

### 3.1 æ’åå‡½æ•°

**æ’åå‡½æ•°**ï¼š

- ROW_NUMBER()ï¼šè¡Œå·
- RANK()ï¼šæ’åï¼ˆå…è®¸å¹¶åˆ—ï¼‰
- DENSE_RANK()ï¼šå¯†é›†æ’å
- PERCENT_RANK()ï¼šç™¾åˆ†æ¯”æ’å

### 3.2 èšåˆå‡½æ•°

**èšåˆçª—å£å‡½æ•°**ï¼š

- SUM() OVER()
- AVG() OVER()
- COUNT() OVER()
- MAX() OVER()
- MIN() OVER()

### 3.3 å€¼å‡½æ•°

**å€¼å‡½æ•°**ï¼š

- LAG()ï¼šå‰ä¸€è¡Œå€¼
- LEAD()ï¼šåä¸€è¡Œå€¼
- FIRST_VALUE()ï¼šçª—å£ç¬¬ä¸€ä¸ªå€¼
- LAST_VALUE()ï¼šçª—å£æœ€åä¸€ä¸ªå€¼

---

## å››ã€çª—å£å‡½æ•°åº”ç”¨

### 4.1 æ’ååº”ç”¨

### 4.1.1 åœºæ™¯ç¤ºä¾‹ï¼šå­¦ç”Ÿæˆç»©æ’ååˆ†æ

**ä¸šåŠ¡éœ€æ±‚**ï¼šè®¡ç®—æ¯é—¨è¯¾ç¨‹çš„å­¦ç”Ÿæ’åï¼Œå¹¶åˆ†ææˆç»©åˆ†å¸ƒã€‚

**æ•°æ®æ¨¡å‹**ï¼š

```mermaid
erDiagram
    Student ||--o{ Enrollment : "é€‰è¯¾"
    Course ||--o{ Enrollment : "è¢«é€‰"
    Student {
        int student_id PK
        string name
        string class
    }
    Course {
        int course_id PK
        string course_name
    }
    Enrollment {
        int student_id FK
        int course_id FK
        int score
    }
```

**æ’åæŸ¥è¯¢å®ç°**ï¼š

```sql
SELECT
    c.course_name,
    s.name,
    s.class,
    e.score,
    RANK() OVER (PARTITION BY e.course_id ORDER BY e.score DESC) as course_rank,
    DENSE_RANK() OVER (PARTITION BY e.course_id ORDER BY e.score DESC) as dense_rank,
    ROW_NUMBER() OVER (PARTITION BY e.course_id ORDER BY e.score DESC) as row_number,
    PERCENT_RANK() OVER (PARTITION BY e.course_id ORDER BY e.score DESC) as percent_rank
FROM Enrollment e
JOIN Student s ON e.student_id = s.student_id
JOIN Course c ON e.course_id = c.course_id
ORDER BY c.course_name, course_rank;
```

**æŸ¥è¯¢æ‰§è¡Œæµç¨‹æ—¶åºå›¾**ï¼š

```mermaid
sequenceDiagram
    participant Client
    participant QueryEngine
    participant WindowFunction
    participant Storage

    Client->>QueryEngine: SELECT with RANK() OVER
    QueryEngine->>Storage: è¯»å–Enrollmentè¡¨
    Storage-->>QueryEngine: è¿”å›æ•°æ®
    QueryEngine->>WindowFunction: æŒ‰course_idåˆ†åŒº
    WindowFunction->>WindowFunction: åœ¨æ¯ä¸ªåˆ†åŒºå†…æŒ‰scoreæ’åº
    WindowFunction->>WindowFunction: è®¡ç®—RANK()
    WindowFunction-->>QueryEngine: è¿”å›æ’åç»“æœ
    QueryEngine-->>Client: è¿”å›æœ€ç»ˆç»“æœ
```

### 4.2 ç´¯è®¡ç»Ÿè®¡

### 4.2.1 åœºæ™¯ç¤ºä¾‹ï¼šé”€å”®ç´¯è®¡ç»Ÿè®¡å’Œç§»åŠ¨å¹³å‡

**ä¸šåŠ¡éœ€æ±‚**ï¼šè®¡ç®—æ¯æ—¥é”€å”®é¢çš„ç´¯è®¡å€¼å’Œ7æ—¥ç§»åŠ¨å¹³å‡ã€‚

**æ•°æ®æ¨¡å‹**ï¼š

```mermaid
erDiagram
    Sales {
        date date PK
        product_id int
        amount decimal
        quantity int
    }
```

**ç´¯è®¡ç»Ÿè®¡æŸ¥è¯¢å®ç°**ï¼š

```sql
SELECT
    date,
    amount,
    SUM(amount) OVER (ORDER BY date) as cumulative_sales,
    AVG(amount) OVER (
        ORDER BY date
        ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
    ) as moving_avg_7d,
    SUM(amount) OVER (
        ORDER BY date
        ROWS BETWEEN 29 PRECEDING AND CURRENT ROW
    ) as moving_sum_30d
FROM Sales
ORDER BY date;
```

### 4.2.2 åœºæ™¯ç¤ºä¾‹ï¼šåŒæ¯”ç¯æ¯”åˆ†æ

**ä¸šåŠ¡éœ€æ±‚**ï¼šè®¡ç®—æœˆåº¦é”€å”®é¢çš„åŒæ¯”å’Œç¯æ¯”å¢é•¿ç‡ã€‚

**åŒæ¯”ç¯æ¯”æŸ¥è¯¢å®ç°**ï¼š

```sql
WITH monthly_sales AS (
    SELECT
        DATE_TRUNC('month', date) as month,
        SUM(amount) as total_sales
    FROM Sales
    GROUP BY DATE_TRUNC('month', date)
)
SELECT
    month,
    total_sales,
    LAG(total_sales, 1) OVER (ORDER BY month) as prev_month,
    LAG(total_sales, 12) OVER (ORDER BY month) as prev_year,
    (total_sales - LAG(total_sales, 1) OVER (ORDER BY month)) * 100.0 /
        LAG(total_sales, 1) OVER (ORDER BY month) as month_over_month_pct,
    (total_sales - LAG(total_sales, 12) OVER (ORDER BY month)) * 100.0 /
        LAG(total_sales, 12) OVER (ORDER BY month) as year_over_year_pct
FROM monthly_sales
ORDER BY month;
```

---

## äº”ã€æ€§èƒ½ä¼˜åŒ–

### 5.1 ä¼˜åŒ–å»ºè®®

**æ€§èƒ½ä¼˜åŒ–**ï¼š

1. åˆç†ä½¿ç”¨PARTITION BY
2. é¿å…ä¸å¿…è¦çš„æ’åº
3. ä½¿ç”¨ç´¢å¼•æ”¯æŒçª—å£å‡½æ•°

---

## å…­ã€ç›¸å…³èµ„æº

### ç›¸å…³æ–‡æ¡£

- [å…¬å…±è¡¨è¡¨è¾¾å¼(CTE)](./05.02-å…¬å…±è¡¨è¡¨è¾¾å¼(CTE).md) - CTEè¯¦è§£
- [æ•°æ®æŸ¥è¯¢è¯­è¨€(DQL)](../04-è¯­æ³•è§„èŒƒ/04.03-æ•°æ®æŸ¥è¯¢è¯­è¨€(DQL).md) - DQLè¯­æ³•

---

**ç»´æŠ¤è€…**: SQL Standards Team
**æœ€åæ›´æ–°**: 2025-01-15
