# é€’å½’æŸ¥è¯¢è¯¦è§£

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-01-15
> **ç‰ˆæœ¬**ï¼šv1.0.0
> **éš¾åº¦**ï¼šâ­â­â­â­
> **åº”ç”¨åœºæ™¯**ï¼šå±‚æ¬¡ç»“æ„æŸ¥è¯¢ã€å›¾éå†ã€æ ‘å½¢æ•°æ®å¤„ç†

---

## ğŸ“‹ ç›®å½•

- [é€’å½’æŸ¥è¯¢è¯¦è§£](#é€’å½’æŸ¥è¯¢è¯¦è§£)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
    - [1.1 é€’å½’æŸ¥è¯¢åº”ç”¨åœºæ™¯æ€ç»´å¯¼å›¾](#11-é€’å½’æŸ¥è¯¢åº”ç”¨åœºæ™¯æ€ç»´å¯¼å›¾)
    - [1.2 é€’å½’æŸ¥è¯¢å†³ç­–æ ‘](#12-é€’å½’æŸ¥è¯¢å†³ç­–æ ‘)
    - [1.3 é€’å½’æŸ¥è¯¢ vs å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ](#13-é€’å½’æŸ¥è¯¢-vs-å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ)
  - [äºŒã€é€’å½’CTEè¯­æ³•](#äºŒé€’å½’cteè¯­æ³•)
    - [2.1 è¯­æ³•ç»“æ„](#21-è¯­æ³•ç»“æ„)
  - [ä¸‰ã€é€’å½’æŸ¥è¯¢åº”ç”¨](#ä¸‰é€’å½’æŸ¥è¯¢åº”ç”¨)
    - [3.1 å±‚æ¬¡ç»“æ„æŸ¥è¯¢](#31-å±‚æ¬¡ç»“æ„æŸ¥è¯¢)
  - [å››ã€ç»ˆæ­¢æ¡ä»¶](#å››ç»ˆæ­¢æ¡ä»¶)
    - [4.1 ç»ˆæ­¢æ¡ä»¶é‡è¦æ€§](#41-ç»ˆæ­¢æ¡ä»¶é‡è¦æ€§)
  - [äº”ã€æ€§èƒ½ä¼˜åŒ–](#äº”æ€§èƒ½ä¼˜åŒ–)
    - [5.1 ä¼˜åŒ–å»ºè®®](#51-ä¼˜åŒ–å»ºè®®)
  - [å…­ã€ç›¸å…³èµ„æº](#å…­ç›¸å…³èµ„æº)
    - [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)

---

## ä¸€ã€æ¦‚è¿°

**é€’å½’æŸ¥è¯¢ï¼ˆRecursive Queryï¼‰**ä½¿ç”¨WITH RECURSIVEå®ç°ï¼Œç”¨äºå¤„ç†å±‚æ¬¡ç»“æ„å’Œå›¾æ•°æ®ã€‚

**é€’å½’æŸ¥è¯¢ç‰¹ç‚¹**ï¼š

- æ”¯æŒè‡ªå¼•ç”¨
- éœ€è¦æ˜ç¡®çš„ç»ˆæ­¢æ¡ä»¶
- å¯ä»¥å¤„ç†æ— é™å±‚æ¬¡ç»“æ„

### 1.1 é€’å½’æŸ¥è¯¢åº”ç”¨åœºæ™¯æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((é€’å½’æŸ¥è¯¢))
    å±‚æ¬¡ç»“æ„
      ç»„ç»‡æ¶æ„
        éƒ¨é—¨å±‚çº§
        å‘˜å·¥å±‚çº§
      åˆ†ç±»ä½“ç³»
        å•†å“åˆ†ç±»
        ç›®å½•ç»“æ„
      æ ‘å½¢ç»“æ„
        è¯„è®ºæ ‘
        èœå•æ ‘
    å›¾éå†
      ç¤¾äº¤ç½‘ç»œ
        å¥½å‹å…³ç³»
        å…³æ³¨å…³ç³»
      è·¯å¾„æŸ¥æ‰¾
        æœ€çŸ­è·¯å¾„
        æ‰€æœ‰è·¯å¾„
      è¿é€šæ€§
        è¿é€šåˆ†é‡
        å¯è¾¾æ€§
    æ•°æ®ç”Ÿæˆ
      åºåˆ—ç”Ÿæˆ
        æ•°å­—åºåˆ—
        æ—¥æœŸåºåˆ—
      ç»„åˆç”Ÿæˆ
        æ’åˆ—ç»„åˆ
        å­é›†ç”Ÿæˆ
    ç´¯è®¡è®¡ç®—
      ç´¯è®¡æ±‚å’Œ
        ç´¯è®¡é”€å”®é¢
        ç´¯è®¡ç”¨æˆ·æ•°
      ç´¯è®¡ç»Ÿè®¡
        ç´¯è®¡æ’å
        ç´¯è®¡å æ¯”
```

### 1.2 é€’å½’æŸ¥è¯¢å†³ç­–æ ‘

```mermaid
flowchart TD
    A[éœ€è¦é€’å½’æŸ¥è¯¢?] --> B{æ•°æ®ç»“æ„ç±»å‹}
    B -->|å±‚æ¬¡ç»“æ„| C{æœ‰æ˜ç¡®å±‚çº§?}
    B -->|å›¾ç»“æ„| D{éœ€è¦éå†?}
    B -->|åºåˆ—ç”Ÿæˆ| E[ä½¿ç”¨é€’å½’CTE]

    C -->|æ˜¯| F{æœ‰ç»ˆæ­¢æ¡ä»¶?}
    F -->|æ˜¯| G[ä½¿ç”¨WITH RECURSIVE]
    F -->|å¦| H[è®¾è®¡ç»ˆæ­¢æ¡ä»¶]
    H --> G

    D -->|æ˜¯| I{éœ€è¦è·¯å¾„?}
    I -->|æ˜¯| J[é€’å½’è·¯å¾„æŸ¥æ‰¾]
    I -->|å¦| K[é€’å½’éå†]
    J --> G
    K --> G

    E --> G
    G --> L[æ‰§è¡Œé€’å½’æŸ¥è¯¢]
```

### 1.3 é€’å½’æŸ¥è¯¢ vs å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”çŸ©é˜µ

| æ–¹æ¡ˆ | å®ç°æ–¹å¼ | æ€§èƒ½ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|---------|------|--------|---------|
| **é€’å½’CTE** | WITH RECURSIVE | â­â­â­ | â­â­â­ | å±‚æ¬¡ç»“æ„ã€å›¾éå† |
| **è‡ªè¿æ¥** | å¤šæ¬¡JOIN | â­â­ | â­â­â­â­ | å›ºå®šå±‚çº§ï¼ˆ2-3å±‚ï¼‰ |
| **å­˜å‚¨è¿‡ç¨‹** | å¾ªç¯å¤„ç† | â­â­ | â­â­â­â­ | å¤æ‚é€»è¾‘ |
| **åº”ç”¨å±‚é€’å½’** | ç¨‹åºä»£ç  | â­ | â­â­â­â­â­ | ç®€å•åœºæ™¯ |

---

## äºŒã€é€’å½’CTEè¯­æ³•

### 2.1 è¯­æ³•ç»“æ„

**é€’å½’CTEè¯­æ³•**ï¼š

```sql
WITH RECURSIVE cte_name AS (
    -- åŸºç¡€æŸ¥è¯¢ï¼ˆé”šç‚¹ï¼‰
    SELECT ...
    UNION ALL
    -- é€’å½’æŸ¥è¯¢
    SELECT ... FROM cte_name WHERE ...
)
SELECT * FROM cte_name;
```

---

## ä¸‰ã€é€’å½’æŸ¥è¯¢åº”ç”¨

### 3.1 å±‚æ¬¡ç»“æ„æŸ¥è¯¢

**åœºæ™¯1ï¼šç»„ç»‡æ¶æ„æŸ¥è¯¢**:

**ä¸šåŠ¡éœ€æ±‚**ï¼šæŸ¥è¯¢å®Œæ•´çš„ç»„ç»‡æ¶æ„æ ‘ï¼ŒåŒ…æ‹¬æ‰€æœ‰å±‚çº§å…³ç³»ã€‚

**æ•°æ®æ¨¡å‹**ï¼š

```mermaid
erDiagram
    Organization ||--o{ Organization : "parent"
    Organization {
        int id PK
        string name
        int parent_id FK
        string type
    }
```

**ERå›¾è¯´æ˜**ï¼š

- ç»„ç»‡è¡¨è‡ªå¼•ç”¨ï¼Œé€šè¿‡parent_idå»ºç«‹å±‚çº§å…³ç³»
- æ ¹èŠ‚ç‚¹çš„parent_idä¸ºNULL

**æŸ¥è¯¢**ï¼š

```sql
WITH RECURSIVE org_tree AS (
    -- åŸºç¡€æŸ¥è¯¢ï¼šæ ¹èŠ‚ç‚¹
    SELECT
        id,
        name,
        parent_id,
        0 as level,
        CAST(name AS VARCHAR(1000)) as path
    FROM Organization
    WHERE parent_id IS NULL

    UNION ALL

    -- é€’å½’æŸ¥è¯¢ï¼šå­èŠ‚ç‚¹
    SELECT
        o.id,
        o.name,
        o.parent_id,
        ot.level + 1,
        ot.path || ' > ' || o.name
    FROM Organization o
    JOIN org_tree ot ON o.parent_id = ot.id
    WHERE ot.level < 10  -- é˜²æ­¢æ— é™é€’å½’
)
SELECT
    id,
    name,
    parent_id,
    level,
    path
FROM org_tree
ORDER BY path;
```

**æŸ¥è¯¢æ‰§è¡Œæµç¨‹æ—¶åºå›¾**ï¼š

```mermaid
sequenceDiagram
    participant Query
    participant CTE
    participant Organization

    Query->>CTE: åˆå§‹åŒ–åŸºç¡€æŸ¥è¯¢
    CTE->>Organization: æŸ¥è¯¢æ ¹èŠ‚ç‚¹(parent_id IS NULL)
    Organization-->>CTE: è¿”å›æ ¹èŠ‚ç‚¹

    loop é€’å½’è¿­ä»£
        CTE->>CTE: æ£€æŸ¥ç»ˆæ­¢æ¡ä»¶(level < 10)
        CTE->>Organization: æŸ¥è¯¢å­èŠ‚ç‚¹(parent_id = å½“å‰èŠ‚ç‚¹id)
        Organization-->>CTE: è¿”å›å­èŠ‚ç‚¹
        CTE->>CTE: åˆå¹¶ç»“æœ(UNION ALL)
    end

    CTE-->>Query: è¿”å›å®Œæ•´æ ‘ç»“æ„
```

**æŸ¥è¯¢ç»“æœç¤ºä¾‹**ï¼š

```text
| id | name     | parent_id | level | path                    |
|----|----------|-----------|-------|-------------------------|
| 1  | æ€»å…¬å¸   | NULL      | 0     | æ€»å…¬å¸                  |
| 2  | æŠ€æœ¯éƒ¨   | 1         | 1     | æ€»å…¬å¸ > æŠ€æœ¯éƒ¨         |
| 3  | å¼€å‘ç»„   | 2         | 2     | æ€»å…¬å¸ > æŠ€æœ¯éƒ¨ > å¼€å‘ç»„|
| 4  | æµ‹è¯•ç»„   | 2         | 2     | æ€»å…¬å¸ > æŠ€æœ¯éƒ¨ > æµ‹è¯•ç»„|
```

**åœºæ™¯2ï¼šè¯„è®ºæ ‘æŸ¥è¯¢**:

**ä¸šåŠ¡éœ€æ±‚**ï¼šæŸ¥è¯¢è¯„è®ºåŠå…¶æ‰€æœ‰å›å¤ï¼Œæ„å»ºè¯„è®ºæ ‘ã€‚

**æ•°æ®æ¨¡å‹**ï¼š

```mermaid
erDiagram
    Comment ||--o{ Comment : "å›å¤"
    Comment {
        int comment_id PK
        int post_id FK
        int parent_comment_id FK
        string content
        date created_at
    }
```

**æŸ¥è¯¢**ï¼š

```sql
WITH RECURSIVE comment_tree AS (
    -- åŸºç¡€æŸ¥è¯¢ï¼šé¡¶çº§è¯„è®º
    SELECT
        comment_id,
        post_id,
        parent_comment_id,
        content,
        created_at,
        0 as depth,
        CAST(comment_id AS VARCHAR(1000)) as thread_path
    FROM Comment
    WHERE post_id = :post_id
      AND parent_comment_id IS NULL

    UNION ALL

    -- é€’å½’æŸ¥è¯¢ï¼šå›å¤
    SELECT
        c.comment_id,
        c.post_id,
        c.parent_comment_id,
        c.content,
        c.created_at,
        ct.depth + 1,
        ct.thread_path || '.' || c.comment_id
    FROM Comment c
    JOIN comment_tree ct ON c.parent_comment_id = ct.comment_id
    WHERE ct.depth < 10
)
SELECT
    comment_id,
    content,
    depth,
    thread_path,
    created_at
FROM comment_tree
ORDER BY thread_path;
```

**æ€§èƒ½ä¼˜åŒ–**ï¼š

```sql
-- åˆ›å»ºç´¢å¼•ä¼˜åŒ–é€’å½’æŸ¥è¯¢
CREATE INDEX idx_comment_parent ON Comment(parent_comment_id);
CREATE INDEX idx_comment_post ON Comment(post_id, parent_comment_id);

-- é™åˆ¶é€’å½’æ·±åº¦
WHERE ct.depth < 10  -- é˜²æ­¢è¿‡æ·±é€’å½’
```

---

## å››ã€ç»ˆæ­¢æ¡ä»¶

### 4.1 ç»ˆæ­¢æ¡ä»¶é‡è¦æ€§

**ç»ˆæ­¢æ¡ä»¶**ï¼š

é€’å½’æŸ¥è¯¢å¿…é¡»åŒ…å«ç»ˆæ­¢æ¡ä»¶ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´æ— é™å¾ªç¯ï¼š

```sql
WITH RECURSIVE cte AS (
    SELECT 1 as n
    UNION ALL
    SELECT n + 1 FROM cte WHERE n < 10  -- ç»ˆæ­¢æ¡ä»¶
)
SELECT * FROM cte;
```

---

## äº”ã€æ€§èƒ½ä¼˜åŒ–

### 5.1 ä¼˜åŒ–å»ºè®®

**ä¼˜åŒ–å»ºè®®**ï¼š

1. **ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºé€’å½’æŸ¥è¯¢çš„å…³è”å­—æ®µåˆ›å»ºç´¢å¼•
2. **æ·±åº¦é™åˆ¶**ï¼šä½¿ç”¨WHEREå­å¥é™åˆ¶é€’å½’æ·±åº¦ï¼Œé˜²æ­¢æ— é™é€’å½’
3. **ç‰©åŒ–è§†å›¾**ï¼šå¯¹äºé¢‘ç¹æŸ¥è¯¢çš„å±‚æ¬¡ç»“æ„ï¼Œä½¿ç”¨ç‰©åŒ–è§†å›¾ç¼“å­˜ç»“æœ
4. **æŸ¥è¯¢é‡å†™**ï¼šå¯¹äºå›ºå®šå±‚çº§ï¼Œè€ƒè™‘ä½¿ç”¨è‡ªè¿æ¥æ›¿ä»£é€’å½’æŸ¥è¯¢

**æ€§èƒ½ä¼˜åŒ–ç¤ºä¾‹**ï¼š

```sql
-- åˆ›å»ºç´¢å¼•ä¼˜åŒ–é€’å½’æŸ¥è¯¢
CREATE INDEX idx_organization_parent ON Organization(parent_id);
CREATE INDEX idx_organization_id ON Organization(id);

-- ä¼˜åŒ–åçš„é€’å½’æŸ¥è¯¢ï¼ˆé™åˆ¶æ·±åº¦ï¼‰
WITH RECURSIVE org_tree AS (
    SELECT
        id,
        name,
        parent_id,
        0 as level,
        CAST(name AS VARCHAR(1000)) as path
    FROM Organization
    WHERE parent_id IS NULL

    UNION ALL

    SELECT
        o.id,
        o.name,
        o.parent_id,
        ot.level + 1,
        ot.path || ' > ' || o.name
    FROM Organization o
    JOIN org_tree ot ON o.parent_id = ot.id
    WHERE ot.level < 10  -- é™åˆ¶é€’å½’æ·±åº¦
)
SELECT * FROM org_tree
WHERE level <= 5;  -- åªæŸ¥è¯¢å‰5å±‚
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

| ä¼˜åŒ–æ–¹æ³• | æŸ¥è¯¢æ—¶é—´ | å†…å­˜ä½¿ç”¨ | é€‚ç”¨åœºæ™¯ |
|---------|---------|---------|---------|
| **æ— ä¼˜åŒ–** | 100% | 100% | å°æ•°æ®é›† |
| **ç´¢å¼•ä¼˜åŒ–** | 30% | 100% | å¤§æ•°æ®é›† |
| **æ·±åº¦é™åˆ¶** | 50% | 50% | æ·±å±‚ç»“æ„ |
| **ç‰©åŒ–è§†å›¾** | 10% | 150% | é¢‘ç¹æŸ¥è¯¢ |

**é€’å½’æŸ¥è¯¢ç»ˆæ­¢æ¡ä»¶å½¢å¼åŒ–å®šä¹‰**ï¼š

```latex
é€’å½’æŸ¥è¯¢ç»ˆæ­¢æ¡ä»¶ï¼š

WITH RECURSIVE cte AS (
    base_query
    UNION ALL
    recursive_query
)

ç»ˆæ­¢æ¡ä»¶ï¼š
1. åŸºç¡€æ¡ä»¶ï¼šbase_query ç»“æœä¸ºç©º
2. é€’å½’æ¡ä»¶ï¼šrecursive_query ç»“æœä¸ºç©º
3. æ·±åº¦æ¡ä»¶ï¼šlevel < max_depth
4. å¾ªç¯æ£€æµ‹ï¼švisited.contains(current_node)
```

**ç»ˆæ­¢æ¡ä»¶è¯æ˜**ï¼š

```latex
å®šç†ï¼šå¦‚æœé€’å½’æŸ¥è¯¢æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼Œåˆ™å¿…ç„¶ç»ˆæ­¢ï¼š

1. åŸºç¡€æŸ¥è¯¢æœ‰é™ï¼š|base_query| < âˆ
2. é€’å½’å…³ç³»æœ‰é™ï¼š|recursive_relation| < âˆ
3. æ·±åº¦é™åˆ¶ï¼šmax_depth < âˆ
4. æ— å¾ªç¯ï¼šâˆ€n: visited.contains(n) âŸ¹ n ä¸å†è¢«è®¿é—®

è¯æ˜ï¼š
å‡è®¾é€’å½’æŸ¥è¯¢ä¸ç»ˆæ­¢ï¼Œåˆ™å­˜åœ¨æ— é™åºåˆ—ï¼š
nâ‚ â†’ nâ‚‚ â†’ nâ‚ƒ â†’ ...

ç”±äºå…³ç³»æœ‰é™ï¼Œå¿…ç„¶å­˜åœ¨å¾ªç¯ï¼š
náµ¢ = nâ±¼ (i < j)

ä½†æ ¹æ®æ¡ä»¶4ï¼Œå¾ªç¯èŠ‚ç‚¹ä¸ä¼šè¢«é‡å¤è®¿é—®ï¼ŒçŸ›ç›¾ã€‚
å› æ­¤é€’å½’æŸ¥è¯¢å¿…ç„¶ç»ˆæ­¢ã€‚âœ“
```

---

## å…­ã€ç›¸å…³èµ„æº

### ç›¸å…³æ–‡æ¡£

- [å…¬å…±è¡¨è¡¨è¾¾å¼(CTE)](./05.02-å…¬å…±è¡¨è¡¨è¾¾å¼(CTE).md) - CTEè¯¦è§£

---

**ç»´æŠ¤è€…**: SQL Standards Team
**æœ€åæ›´æ–°**: 2025-01-15
