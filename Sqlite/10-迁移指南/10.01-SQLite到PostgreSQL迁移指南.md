# SQLite åˆ° PostgreSQL è¿ç§»æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-11-13
> **æœ€åæ›´æ–°**ï¼š2025-11-13
> **é€‚ç”¨ç‰ˆæœ¬**ï¼šSQLite 3.31+ â†’ PostgreSQL 12+

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›ä»SQLiteè¿ç§»åˆ°PostgreSQLçš„å®Œæ•´æŒ‡å—ï¼Œæ¶µç›–æ•°æ®æ¨¡å‹è½¬æ¢ã€ç‰¹æ€§æ˜ å°„ã€è¿ç§»ç­–ç•¥å’Œæœ€ä½³å®è·µï¼ŒåŸºäºå½“å‰ç½‘ç»œä¸Šæœ€æˆç†Ÿçš„æ¡ˆä¾‹å’Œæ–¹æ¡ˆã€‚

---

## ğŸ“‘ ç›®å½•

- [SQLite åˆ° PostgreSQL è¿ç§»æŒ‡å—](#sqlite-åˆ°-postgresql-è¿ç§»æŒ‡å—)
  - [ğŸ“‹ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€è¿ç§»å†³ç­–æ¡†æ¶](#ä¸€è¿ç§»å†³ç­–æ¡†æ¶)
    - [1.1 ä½•æ—¶éœ€è¦è¿ç§»](#11-ä½•æ—¶éœ€è¦è¿ç§»)
      - [è§¦å‘è¿ç§»çš„ä¸šåŠ¡åœºæ™¯](#è§¦å‘è¿ç§»çš„ä¸šåŠ¡åœºæ™¯)
      - [æŠ€æœ¯æŒ‡æ ‡é˜ˆå€¼](#æŠ€æœ¯æŒ‡æ ‡é˜ˆå€¼)
    - [1.2 è¿ç§»æˆæœ¬è¯„ä¼°](#12-è¿ç§»æˆæœ¬è¯„ä¼°)
      - [æˆæœ¬ç»´åº¦åˆ†æ](#æˆæœ¬ç»´åº¦åˆ†æ)
    - [1.3 è¿ç§»é£é™©è¯„ä¼°](#13-è¿ç§»é£é™©è¯„ä¼°)
      - [é£é™©çŸ©é˜µ](#é£é™©çŸ©é˜µ)
  - [äºŒã€æ•°æ®æ¨¡å‹è½¬æ¢](#äºŒæ•°æ®æ¨¡å‹è½¬æ¢)
    - [2.1 æ•°æ®ç±»å‹æ˜ å°„](#21-æ•°æ®ç±»å‹æ˜ å°„)
      - [æ ¸å¿ƒç±»å‹æ˜ å°„è¡¨](#æ ¸å¿ƒç±»å‹æ˜ å°„è¡¨)
      - [åŠ¨æ€ç±»å‹å¤„ç†](#åŠ¨æ€ç±»å‹å¤„ç†)
      - [ç±»å‹è½¬æ¢ç­–ç•¥](#ç±»å‹è½¬æ¢ç­–ç•¥)
    - [2.2 è¡¨ç»“æ„è½¬æ¢](#22-è¡¨ç»“æ„è½¬æ¢)
      - [ä¸»é”®è½¬æ¢](#ä¸»é”®è½¬æ¢)
      - [å¤–é”®è½¬æ¢](#å¤–é”®è½¬æ¢)
      - [é»˜è®¤å€¼è½¬æ¢](#é»˜è®¤å€¼è½¬æ¢)
    - [2.3 çº¦æŸè½¬æ¢](#23-çº¦æŸè½¬æ¢)
      - [CHECKçº¦æŸ](#checkçº¦æŸ)
      - [UNIQUEçº¦æŸ](#uniqueçº¦æŸ)
    - [2.4 ç´¢å¼•è½¬æ¢](#24-ç´¢å¼•è½¬æ¢)
      - [åŸºæœ¬ç´¢å¼•](#åŸºæœ¬ç´¢å¼•)
      - [å¤åˆç´¢å¼•](#å¤åˆç´¢å¼•)
      - [ç‰¹æ®Šç´¢å¼•](#ç‰¹æ®Šç´¢å¼•)
  - [ä¸‰ã€SQLè¯­æ³•å·®å¼‚å¤„ç†](#ä¸‰sqlè¯­æ³•å·®å¼‚å¤„ç†)
    - [3.1 DDLå·®å¼‚](#31-ddlå·®å¼‚)
      - [CREATE TABLEå·®å¼‚](#create-tableå·®å¼‚)
      - [ALTER TABLEå·®å¼‚](#alter-tableå·®å¼‚)
    - [3.2 DMLå·®å¼‚](#32-dmlå·®å¼‚)
      - [INSERTå·®å¼‚](#insertå·®å¼‚)
      - [UPDATEå·®å¼‚](#updateå·®å¼‚)
    - [3.3 å‡½æ•°å·®å¼‚](#33-å‡½æ•°å·®å¼‚)
      - [å­—ç¬¦ä¸²å‡½æ•°](#å­—ç¬¦ä¸²å‡½æ•°)
      - [æ—¥æœŸæ—¶é—´å‡½æ•°](#æ—¥æœŸæ—¶é—´å‡½æ•°)
      - [èšåˆå‡½æ•°](#èšåˆå‡½æ•°)
    - [3.4 ç‰¹æ€§å·®å¼‚](#34-ç‰¹æ€§å·®å¼‚)
      - [çª—å£å‡½æ•°](#çª—å£å‡½æ•°)
      - [CTEï¼ˆå…¬å…±è¡¨è¡¨è¾¾å¼ï¼‰](#cteå…¬å…±è¡¨è¡¨è¾¾å¼)
  - [å››ã€æ¶æ„ç‰¹æ€§è½¬æ¢](#å››æ¶æ„ç‰¹æ€§è½¬æ¢)
    - [4.1 å¹¶å‘æ§åˆ¶è½¬æ¢](#41-å¹¶å‘æ§åˆ¶è½¬æ¢)
      - [SQLite WALæ¨¡å¼ â†’ PostgreSQL MVCC](#sqlite-walæ¨¡å¼--postgresql-mvcc)
      - [é”æœºåˆ¶è½¬æ¢](#é”æœºåˆ¶è½¬æ¢)
    - [4.2 äº‹åŠ¡å¤„ç†è½¬æ¢](#42-äº‹åŠ¡å¤„ç†è½¬æ¢)
      - [äº‹åŠ¡éš”ç¦»çº§åˆ«](#äº‹åŠ¡éš”ç¦»çº§åˆ«)
      - [SAVEPOINTå¤„ç†](#savepointå¤„ç†)
    - [4.3 å­˜å‚¨å¼•æ“å·®å¼‚](#43-å­˜å‚¨å¼•æ“å·®å¼‚)
      - [æ–‡ä»¶ç»“æ„](#æ–‡ä»¶ç»“æ„)
      - [å­˜å‚¨ä¼˜åŒ–](#å­˜å‚¨ä¼˜åŒ–)
    - [4.4 è¿æ¥ç®¡ç†è½¬æ¢](#44-è¿æ¥ç®¡ç†è½¬æ¢)
      - [è¿æ¥æ–¹å¼](#è¿æ¥æ–¹å¼)
      - [è¿æ¥æ± ](#è¿æ¥æ± )
  - [äº”ã€è¿ç§»å·¥å…·å’Œæ–¹æ¡ˆ](#äº”è¿ç§»å·¥å…·å’Œæ–¹æ¡ˆ)
    - [5.1 å®˜æ–¹å·¥å…·](#51-å®˜æ–¹å·¥å…·)
      - [pgloader](#pgloader)
    - [5.2 ç¬¬ä¸‰æ–¹å·¥å…·](#52-ç¬¬ä¸‰æ–¹å·¥å…·)
      - [SQLite to PostgreSQL Converter](#sqlite-to-postgresql-converter)
      - [è‡ªå®šä¹‰Pythonè„šæœ¬](#è‡ªå®šä¹‰pythonè„šæœ¬)
    - [5.3 è‡ªå®šä¹‰è¿ç§»è„šæœ¬](#53-è‡ªå®šä¹‰è¿ç§»è„šæœ¬)
      - [å®Œæ•´è¿ç§»è„šæœ¬æ¡†æ¶](#å®Œæ•´è¿ç§»è„šæœ¬æ¡†æ¶)
    - [5.4 æˆç†Ÿæ¡ˆä¾‹å‚è€ƒ](#54-æˆç†Ÿæ¡ˆä¾‹å‚è€ƒ)
      - [æ¡ˆä¾‹1ï¼šDjangoé¡¹ç›®è¿ç§»](#æ¡ˆä¾‹1djangoé¡¹ç›®è¿ç§»)
      - [æ¡ˆä¾‹2ï¼šRailsé¡¹ç›®è¿ç§»](#æ¡ˆä¾‹2railsé¡¹ç›®è¿ç§»)
      - [æ¡ˆä¾‹3ï¼šNode.jsé¡¹ç›®è¿ç§»](#æ¡ˆä¾‹3nodejsé¡¹ç›®è¿ç§»)
  - [å…­ã€è¿ç§»æ‰§è¡Œæµç¨‹](#å…­è¿ç§»æ‰§è¡Œæµç¨‹)
    - [6.1 è¿ç§»å‰å‡†å¤‡](#61-è¿ç§»å‰å‡†å¤‡)
      - [ç¯å¢ƒå‡†å¤‡æ¸…å•](#ç¯å¢ƒå‡†å¤‡æ¸…å•)
      - [æ•°æ®å¤‡ä»½](#æ•°æ®å¤‡ä»½)
      - [ç¯å¢ƒæµ‹è¯•](#ç¯å¢ƒæµ‹è¯•)
    - [6.2 æ•°æ®è¿ç§»æ­¥éª¤](#62-æ•°æ®è¿ç§»æ­¥éª¤)
      - [æ­¥éª¤1ï¼šè¿ç§»è¡¨ç»“æ„](#æ­¥éª¤1è¿ç§»è¡¨ç»“æ„)
      - [æ­¥éª¤2ï¼šè¿ç§»æ•°æ®](#æ­¥éª¤2è¿ç§»æ•°æ®)
      - [æ­¥éª¤3ï¼šè¿ç§»ç´¢å¼•](#æ­¥éª¤3è¿ç§»ç´¢å¼•)
      - [æ­¥éª¤4ï¼šè¿ç§»çº¦æŸ](#æ­¥éª¤4è¿ç§»çº¦æŸ)
    - [6.3 åº”ç”¨ä»£ç è¿ç§»](#63-åº”ç”¨ä»£ç è¿ç§»)
      - [ORMè¿ç§»](#ormè¿ç§»)
      - [åŸç”ŸSQLè¿ç§»](#åŸç”Ÿsqlè¿ç§»)
    - [6.4 è¿ç§»åéªŒè¯](#64-è¿ç§»åéªŒè¯)
      - [æ•°æ®å®Œæ•´æ€§éªŒè¯](#æ•°æ®å®Œæ•´æ€§éªŒè¯)
      - [æ€§èƒ½éªŒè¯](#æ€§èƒ½éªŒè¯)
  - [ä¸ƒã€æ€§èƒ½ä¼˜åŒ–è°ƒæ•´](#ä¸ƒæ€§èƒ½ä¼˜åŒ–è°ƒæ•´)
    - [7.1 æŸ¥è¯¢ä¼˜åŒ–å·®å¼‚](#71-æŸ¥è¯¢ä¼˜åŒ–å·®å¼‚)
      - [æŸ¥è¯¢è®¡åˆ’å™¨](#æŸ¥è¯¢è®¡åˆ’å™¨)
      - [ä¼˜åŒ–å»ºè®®](#ä¼˜åŒ–å»ºè®®)
    - [7.2 ç´¢å¼•ç­–ç•¥è°ƒæ•´](#72-ç´¢å¼•ç­–ç•¥è°ƒæ•´)
      - [ç´¢å¼•ç±»å‹é€‰æ‹©](#ç´¢å¼•ç±»å‹é€‰æ‹©)
    - [7.3 è¿æ¥æ± é…ç½®](#73-è¿æ¥æ± é…ç½®)
      - [PostgreSQLè¿æ¥æ± é…ç½®](#postgresqlè¿æ¥æ± é…ç½®)
      - [PgBounceré…ç½®](#pgbounceré…ç½®)
    - [7.4 ç¼“å­˜ç­–ç•¥è°ƒæ•´](#74-ç¼“å­˜ç­–ç•¥è°ƒæ•´)
      - [PostgreSQLç¼“å­˜é…ç½®](#postgresqlç¼“å­˜é…ç½®)
  - [å…«ã€å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ](#å…«å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ)
    - [8.1 æ•°æ®ç±»å‹é—®é¢˜](#81-æ•°æ®ç±»å‹é—®é¢˜)
      - [é—®é¢˜1ï¼šINTEGERæº¢å‡º](#é—®é¢˜1integeræº¢å‡º)
      - [é—®é¢˜2ï¼šæ—¥æœŸæ—¶é—´æ ¼å¼](#é—®é¢˜2æ—¥æœŸæ—¶é—´æ ¼å¼)
    - [8.2 å¹¶å‘é—®é¢˜](#82-å¹¶å‘é—®é¢˜)
      - [é—®é¢˜1ï¼šé”ç­‰å¾…](#é—®é¢˜1é”ç­‰å¾…)
    - [8.3 æ€§èƒ½é—®é¢˜](#83-æ€§èƒ½é—®é¢˜)
      - [é—®é¢˜1ï¼šæŸ¥è¯¢å˜æ…¢](#é—®é¢˜1æŸ¥è¯¢å˜æ…¢)
    - [8.4 å…¼å®¹æ€§é—®é¢˜](#84-å…¼å®¹æ€§é—®é¢˜)
      - [é—®é¢˜1ï¼šå‡½æ•°ä¸å…¼å®¹](#é—®é¢˜1å‡½æ•°ä¸å…¼å®¹)
  - [ä¹ã€æˆç†Ÿæ¡ˆä¾‹ç ”ç©¶](#ä¹æˆç†Ÿæ¡ˆä¾‹ç ”ç©¶)
    - [9.1 æ¡ˆä¾‹ä¸€ï¼šWebåº”ç”¨è¿ç§»](#91-æ¡ˆä¾‹ä¸€webåº”ç”¨è¿ç§»)
      - [èƒŒæ™¯](#èƒŒæ™¯)
      - [è¿ç§»æ–¹æ¡ˆ](#è¿ç§»æ–¹æ¡ˆ)
      - [è¿ç§»ç»“æœ](#è¿ç§»ç»“æœ)
    - [9.2 æ¡ˆä¾‹äºŒï¼šæ•°æ®åˆ†æå¹³å°è¿ç§»](#92-æ¡ˆä¾‹äºŒæ•°æ®åˆ†æå¹³å°è¿ç§»)
      - [èƒŒæ™¯](#èƒŒæ™¯-1)
      - [è¿ç§»æ–¹æ¡ˆ](#è¿ç§»æ–¹æ¡ˆ-1)
      - [è¿ç§»ç»“æœ](#è¿ç§»ç»“æœ-1)
    - [9.3 æ¡ˆä¾‹ä¸‰ï¼šç§»åŠ¨åº”ç”¨åç«¯è¿ç§»](#93-æ¡ˆä¾‹ä¸‰ç§»åŠ¨åº”ç”¨åç«¯è¿ç§»)
      - [èƒŒæ™¯](#èƒŒæ™¯-2)
      - [è¿ç§»æ–¹æ¡ˆ](#è¿ç§»æ–¹æ¡ˆ-2)
      - [è¿ç§»ç»“æœ](#è¿ç§»ç»“æœ-2)
  - [ğŸ“Š è¿ç§»æ£€æŸ¥æ¸…å•](#-è¿ç§»æ£€æŸ¥æ¸…å•)
    - [è¿ç§»å‰](#è¿ç§»å‰)
    - [è¿ç§»ä¸­](#è¿ç§»ä¸­)
    - [è¿ç§»å](#è¿ç§»å)
  - [ğŸ”— ç›¸å…³èµ„æº](#-ç›¸å…³èµ„æº)
  - [ğŸ“š å‚è€ƒèµ„æ–™](#-å‚è€ƒèµ„æ–™)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [è¿ç§»å·¥å…·](#è¿ç§»å·¥å…·)
    - [æˆç†Ÿæ¡ˆä¾‹](#æˆç†Ÿæ¡ˆä¾‹)

---

## ä¸€ã€è¿ç§»å†³ç­–æ¡†æ¶

### 1.1 ä½•æ—¶éœ€è¦è¿ç§»

#### è§¦å‘è¿ç§»çš„ä¸šåŠ¡åœºæ™¯

| åœºæ™¯ | SQLiteé™åˆ¶ | PostgreSQLä¼˜åŠ¿ | è¿ç§»ä¼˜å…ˆçº§ |
|------|-----------|---------------|-----------|
| é«˜å¹¶å‘å†™å…¥ | å•å†™è€…é™åˆ¶ | å¤šå†™è€…å¹¶å‘ | ğŸ”´ é«˜ |
| å¤šç”¨æˆ·ç½‘ç»œæœåŠ¡ | æ–‡ä»¶é”é™åˆ¶ | å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¶æ„ | ğŸ”´ é«˜ |
| å¤§æ•°æ®é‡ï¼ˆ>100GBï¼‰ | å•æ–‡ä»¶é™åˆ¶ | è¡¨åˆ†åŒºã€åˆ†å¸ƒå¼ | ğŸŸ¡ ä¸­ |
| å¤æ‚æŸ¥è¯¢éœ€æ±‚ | æŸ¥è¯¢ä¼˜åŒ–å™¨é™åˆ¶ | é«˜çº§ä¼˜åŒ–å™¨ã€å¹¶è¡ŒæŸ¥è¯¢ | ğŸŸ¡ ä¸­ |
| éœ€è¦é«˜çº§ç‰¹æ€§ | åŠŸèƒ½å—é™ | JSONBã€å…¨æ–‡æœç´¢ã€æ•°ç»„ç­‰ | ğŸŸ¢ ä½ |
| éœ€è¦å¤åˆ¶å’ŒHA | ä¸æ”¯æŒ | æµå¤åˆ¶ã€é€»è¾‘å¤åˆ¶ | ğŸ”´ é«˜ |

#### æŠ€æœ¯æŒ‡æ ‡é˜ˆå€¼

```python
# è¿ç§»å†³ç­–æŒ‡æ ‡
è¿ç§»æŒ‡æ ‡ = {
    "å¹¶å‘å†™å…¥æ•°": "> 10 writes/sec â†’ è€ƒè™‘è¿ç§»",
    "æ•°æ®åº“å¤§å°": "> 100GB â†’ è€ƒè™‘è¿ç§»",
    "å¹¶å‘è¿æ¥æ•°": "> 50 â†’ è€ƒè™‘è¿ç§»",
    "æŸ¥è¯¢å¤æ‚åº¦": "éœ€è¦çª—å£å‡½æ•°ã€CTEç­‰ â†’ è€ƒè™‘è¿ç§»",
    "å¯ç”¨æ€§è¦æ±‚": "éœ€è¦HAã€å¤åˆ¶ â†’ å¿…é¡»è¿ç§»"
}
```

### 1.2 è¿ç§»æˆæœ¬è¯„ä¼°

#### æˆæœ¬ç»´åº¦åˆ†æ

**å¼€å‘æˆæœ¬**ï¼š

- æ•°æ®æ¨¡å‹è½¬æ¢ï¼š20-40å·¥æ—¶
- SQLè¯­æ³•è°ƒæ•´ï¼š10-20å·¥æ—¶
- åº”ç”¨ä»£ç ä¿®æ”¹ï¼š40-80å·¥æ—¶
- æµ‹è¯•å’ŒéªŒè¯ï¼š30-60å·¥æ—¶
- **æ€»è®¡**ï¼š100-200å·¥æ—¶ï¼ˆ2-5å‘¨ï¼‰

**è¿ç»´æˆæœ¬**ï¼š

- æœåŠ¡å™¨èµ„æºï¼šPostgreSQLéœ€è¦æ›´å¤šå†…å­˜å’ŒCPU
- ç›‘æ§å·¥å…·ï¼šéœ€è¦PostgreSQLä¸“ç”¨ç›‘æ§
- å¤‡ä»½ç­–ç•¥ï¼šéœ€è¦è°ƒæ•´å¤‡ä»½æ–¹æ¡ˆ
- ç»´æŠ¤æˆæœ¬ï¼šéœ€è¦PostgreSQL DBAæŠ€èƒ½

**é£é™©æˆæœ¬**ï¼š

- æ•°æ®ä¸¢å¤±é£é™©ï¼šè¿ç§»è¿‡ç¨‹ä¸­çš„æ•°æ®ä¸€è‡´æ€§
- æœåŠ¡ä¸­æ–­é£é™©ï¼šè¿ç§»æœŸé—´çš„åœæœºæ—¶é—´
- æ€§èƒ½ä¸‹é™é£é™©ï¼šè¿ç§»åæ€§èƒ½å¯èƒ½æš‚æ—¶ä¸‹é™

### 1.3 è¿ç§»é£é™©è¯„ä¼°

#### é£é™©çŸ©é˜µ

| é£é™©ç±»å‹ | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|---------|------|------|---------|
| æ•°æ®ä¸¢å¤± | ä½ | é«˜ | å®Œæ•´å¤‡ä»½ã€åˆ†é˜¶æ®µè¿ç§» |
| æ€§èƒ½ä¸‹é™ | ä¸­ | ä¸­ | æ€§èƒ½æµ‹è¯•ã€ä¼˜åŒ–è°ƒæ•´ |
| å…¼å®¹æ€§é—®é¢˜ | é«˜ | ä¸­ | å……åˆ†æµ‹è¯•ã€æ¸è¿›è¿ç§» |
| æœåŠ¡ä¸­æ–­ | ä¸­ | é«˜ | è“ç»¿éƒ¨ç½²ã€å›æ»šæ–¹æ¡ˆ |

---

## äºŒã€æ•°æ®æ¨¡å‹è½¬æ¢

### 2.1 æ•°æ®ç±»å‹æ˜ å°„

#### æ ¸å¿ƒç±»å‹æ˜ å°„è¡¨

| SQLiteç±»å‹ | PostgreSQLç±»å‹ | è¯´æ˜ | æ³¨æ„äº‹é¡¹ |
|-----------|---------------|------|---------|
| INTEGER | INTEGER / BIGINT | æ ¹æ®å€¼èŒƒå›´é€‰æ‹© | SQLite INTEGERå¯èƒ½æº¢å‡º |
| REAL | REAL / DOUBLE PRECISION | æµ®ç‚¹æ•° | ç²¾åº¦å¯èƒ½ä¸åŒ |
| TEXT | TEXT / VARCHAR(n) | æ–‡æœ¬ | PostgreSQLå¯æŒ‡å®šé•¿åº¦ |
| BLOB | BYTEA | äºŒè¿›åˆ¶æ•°æ® | ç¼–ç æ–¹å¼ä¸åŒ |
| NULL | NULL | ç©ºå€¼ | è¡Œä¸ºä¸€è‡´ |
| NUMERIC | NUMERIC(p,s) | ç²¾ç¡®æ•°å€¼ | PostgreSQLéœ€è¦æŒ‡å®šç²¾åº¦ |

#### åŠ¨æ€ç±»å‹å¤„ç†

**SQLiteåŠ¨æ€ç±»å‹ â†’ PostgreSQLé™æ€ç±»å‹**ï¼š

```sql
-- SQLite: åŠ¨æ€ç±»å‹
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    name TEXT,
    age INTEGER,  -- ä½†å¯ä»¥å­˜å‚¨TEXT
    balance REAL   -- ä½†å¯ä»¥å­˜å‚¨TEXT
);

-- PostgreSQL: é™æ€ç±»å‹ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    age INTEGER CHECK (age > 0),
    balance NUMERIC(10,2) NOT NULL DEFAULT 0
);
```

#### ç±»å‹è½¬æ¢ç­–ç•¥

**ç­–ç•¥1ï¼šä¸¥æ ¼ç±»å‹æ£€æŸ¥**:

```sql
-- è¿ç§»å‰ï¼šæ£€æŸ¥SQLiteæ•°æ®
SELECT
    typeof(age) as age_type,
    COUNT(*) as count
FROM users
GROUP BY typeof(age);

-- è¿ç§»åï¼šPostgreSQLå¼ºåˆ¶ç±»å‹
ALTER TABLE users
    ALTER COLUMN age TYPE INTEGER
    USING age::INTEGER;
```

**ç­–ç•¥2ï¼šå®½æ¾ç±»å‹è½¬æ¢**:

```sql
-- ä½¿ç”¨PostgreSQLçš„CASTå‡½æ•°
ALTER TABLE users
    ALTER COLUMN age TYPE INTEGER
    USING CASE
        WHEN age ~ '^[0-9]+$' THEN age::INTEGER
        ELSE NULL
    END;
```

### 2.2 è¡¨ç»“æ„è½¬æ¢

#### ä¸»é”®è½¬æ¢

```sql
-- SQLite: INTEGER PRIMARY KEY (è‡ªåŠ¨é€’å¢)
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    name TEXT
);

-- PostgreSQL: SERIAL / IDENTITY
CREATE TABLE users (
    id SERIAL PRIMARY KEY,  -- æ–¹å¼1ï¼šSERIAL
    -- æˆ–
    id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,  -- æ–¹å¼2ï¼šIDENTITY
    name TEXT
);
```

#### å¤–é”®è½¬æ¢

```sql
-- SQLite: å¤–é”®éœ€è¦æ˜¾å¼å¯ç”¨
PRAGMA foreign_keys = ON;

CREATE TABLE orders (
    id INTEGER PRIMARY KEY,
    user_id INTEGER,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- PostgreSQL: å¤–é”®é»˜è®¤å¯ç”¨
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE
);
```

#### é»˜è®¤å€¼è½¬æ¢

```sql
-- SQLite: æ”¯æŒå‡½æ•°é»˜è®¤å€¼
CREATE TABLE logs (
    id INTEGER PRIMARY KEY,
    created_at INTEGER DEFAULT (strftime('%s', 'now'))
);

-- PostgreSQL: ä½¿ç”¨å‡½æ•°é»˜è®¤å€¼
CREATE TABLE logs (
    id SERIAL PRIMARY KEY,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 2.3 çº¦æŸè½¬æ¢

#### CHECKçº¦æŸ

```sql
-- SQLite: CHECKçº¦æŸ
CREATE TABLE products (
    id INTEGER PRIMARY KEY,
    price REAL CHECK (price > 0),
    stock INTEGER CHECK (stock >= 0)
);

-- PostgreSQL: CHECKçº¦æŸï¼ˆæ›´å¼ºå¤§ï¼‰
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    price NUMERIC(10,2) CHECK (price > 0),
    stock INTEGER CHECK (stock >= 0 AND stock <= 10000)
);
```

#### UNIQUEçº¦æŸ

```sql
-- SQLite: UNIQUEçº¦æŸ
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    email TEXT UNIQUE,
    username TEXT UNIQUE
);

-- PostgreSQL: UNIQUEçº¦æŸï¼ˆæ”¯æŒéƒ¨åˆ†ç´¢å¼•ï¼‰
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE,
    username VARCHAR(50) UNIQUE
);

-- PostgreSQLé¢å¤–åŠŸèƒ½ï¼šéƒ¨åˆ†å”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX users_active_email_idx
    ON users (email)
    WHERE deleted_at IS NULL;
```

### 2.4 ç´¢å¼•è½¬æ¢

#### åŸºæœ¬ç´¢å¼•

```sql
-- SQLite: ç®€å•ç´¢å¼•
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_orders_user_id ON orders(user_id);

-- PostgreSQL: ç›¸åŒè¯­æ³•ï¼Œä½†æ”¯æŒæ›´å¤šé€‰é¡¹
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_orders_user_id ON orders(user_id);

-- PostgreSQLé¢å¤–åŠŸèƒ½ï¼šè¦†ç›–ç´¢å¼•
CREATE INDEX idx_users_covering ON users(email) INCLUDE (name, created_at);
```

#### å¤åˆç´¢å¼•

```sql
-- SQLite: å¤åˆç´¢å¼•
CREATE INDEX idx_orders_user_date ON orders(user_id, created_at);

-- PostgreSQL: ç›¸åŒï¼Œä½†æ”¯æŒæ’åºæ–¹å‘
CREATE INDEX idx_orders_user_date ON orders(user_id, created_at DESC);
```

#### ç‰¹æ®Šç´¢å¼•

```sql
-- SQLite: å…¨æ–‡æœç´¢ç´¢å¼•ï¼ˆFTS5ï¼‰
CREATE VIRTUAL TABLE articles_fts USING fts5(title, content);

-- PostgreSQL: å…¨æ–‡æœç´¢ç´¢å¼•ï¼ˆGINï¼‰
CREATE TABLE articles (
    id SERIAL PRIMARY KEY,
    title TEXT,
    content TEXT
);

CREATE INDEX articles_fts_idx ON articles
    USING GIN (to_tsvector('english', title || ' ' || content));
```

---

## ä¸‰ã€SQLè¯­æ³•å·®å¼‚å¤„ç†

### 3.1 DDLå·®å¼‚

#### CREATE TABLEå·®å¼‚

**AUTOINCREMENTå¤„ç†**ï¼š

```sql
-- SQLite
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT
);

-- PostgreSQL
CREATE TABLE users (
    id SERIAL PRIMARY KEY
    -- æˆ–
    -- id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY
);
```

**åˆ—å®šä¹‰å·®å¼‚**ï¼š

```sql
-- SQLite: åŠ¨æ€ç±»å‹
CREATE TABLE products (
    id INTEGER PRIMARY KEY,
    name TEXT,
    price REAL
);

-- PostgreSQL: ä¸¥æ ¼ç±»å‹
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    price NUMERIC(10,2) NOT NULL
);
```

#### ALTER TABLEå·®å¼‚

**SQLiteé™åˆ¶**ï¼š

- ä¸æ”¯æŒDROP COLUMNï¼ˆ3.35.0+æ”¯æŒï¼‰
- ä¸æ”¯æŒRENAME COLUMNï¼ˆ3.25.0+æ”¯æŒï¼‰
- ä¸æ”¯æŒADD COLUMNçš„æŸäº›çº¦æŸ

**PostgreSQLä¼˜åŠ¿**ï¼š

```sql
-- PostgreSQL: å®Œæ•´çš„ALTER TABLEæ”¯æŒ
ALTER TABLE users
    ADD COLUMN email VARCHAR(255),
    DROP COLUMN old_email,
    ALTER COLUMN name TYPE VARCHAR(100),
    RENAME COLUMN age TO user_age;
```

### 3.2 DMLå·®å¼‚

#### INSERTå·®å¼‚

**RETURNINGå­å¥**ï¼š

```sql
-- SQLite: ä¸æ”¯æŒRETURNING
INSERT INTO users (name, email) VALUES ('Alice', 'alice@example.com');
-- éœ€è¦é¢å¤–æŸ¥è¯¢è·å–ID

-- PostgreSQL: æ”¯æŒRETURNING
INSERT INTO users (name, email)
VALUES ('Alice', 'alice@example.com')
RETURNING id, created_at;
```

**ON CONFLICTå¤„ç†**ï¼š

```sql
-- SQLite: UPSERTè¯­æ³•
INSERT INTO users (id, name, email)
VALUES (1, 'Alice', 'alice@example.com')
ON CONFLICT(id) DO UPDATE SET
    name = EXCLUDED.name,
    email = EXCLUDED.email;

-- PostgreSQL: ç›¸åŒè¯­æ³•ï¼ˆSQL:2016æ ‡å‡†ï¼‰
INSERT INTO users (id, name, email)
VALUES (1, 'Alice', 'alice@example.com')
ON CONFLICT (id) DO UPDATE SET
    name = EXCLUDED.name,
    email = EXCLUDED.email;
```

#### UPDATEå·®å¼‚

**å¤šè¡¨UPDATE**ï¼š

```sql
-- SQLite: ä¸æ”¯æŒå¤šè¡¨UPDATE
UPDATE orders o
SET total = (SELECT SUM(price) FROM order_items WHERE order_id = o.id)
WHERE o.id = 1;

-- PostgreSQL: æ”¯æŒå¤šè¡¨UPDATE
UPDATE orders o
SET total = oi.sum_price
FROM (
    SELECT order_id, SUM(price) as sum_price
    FROM order_items
    GROUP BY order_id
) oi
WHERE o.id = oi.order_id;
```

### 3.3 å‡½æ•°å·®å¼‚

#### å­—ç¬¦ä¸²å‡½æ•°

| SQLiteå‡½æ•° | PostgreSQLå‡½æ•° | è¯´æ˜ |
|-----------|---------------|------|
| `\|\|` | `\|\|` æˆ– `CONCAT()` | å­—ç¬¦ä¸²è¿æ¥ |
| `LENGTH()` | `LENGTH()` æˆ– `CHAR_LENGTH()` | å­—ç¬¦ä¸²é•¿åº¦ |
| `SUBSTR()` | `SUBSTRING()` | å­å­—ç¬¦ä¸² |
| `REPLACE()` | `REPLACE()` | æ›¿æ¢ |
| `UPPER()` / `LOWER()` | `UPPER()` / `LOWER()` | å¤§å°å†™è½¬æ¢ |
| `TRIM()` | `TRIM()` | å»é™¤ç©ºæ ¼ |

#### æ—¥æœŸæ—¶é—´å‡½æ•°

```sql
-- SQLite: æ—¥æœŸæ—¶é—´å‡½æ•°
SELECT
    datetime('now'),
    date('now'),
    strftime('%Y-%m-%d', 'now'),
    julianday('now') - julianday('2020-01-01') as days;

-- PostgreSQL: æ—¥æœŸæ—¶é—´å‡½æ•°
SELECT
    NOW(),
    CURRENT_DATE,
    TO_CHAR(NOW(), 'YYYY-MM-DD'),
    EXTRACT(EPOCH FROM (NOW() - '2020-01-01'::DATE)) / 86400 as days;
```

#### èšåˆå‡½æ•°

```sql
-- SQLite: åŸºæœ¬èšåˆå‡½æ•°
SELECT
    COUNT(*),
    AVG(price),
    SUM(quantity),
    MAX(created_at),
    MIN(created_at)
FROM orders;

-- PostgreSQL: ç›¸åŒï¼Œä½†æ”¯æŒæ›´å¤š
SELECT
    COUNT(*),
    AVG(price),
    SUM(quantity),
    MAX(created_at),
    MIN(created_at),
    PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY price) as median  -- é¢å¤–åŠŸèƒ½
FROM orders;
```

### 3.4 ç‰¹æ€§å·®å¼‚

#### çª—å£å‡½æ•°

```sql
-- SQLite: 3.25.0+æ”¯æŒçª—å£å‡½æ•°
SELECT
    id,
    name,
    salary,
    ROW_NUMBER() OVER (PARTITION BY department ORDER BY salary DESC) as rank
FROM employees;

-- PostgreSQL: å®Œæ•´çª—å£å‡½æ•°æ”¯æŒï¼ˆSQL:2016æ ‡å‡†ï¼‰
SELECT
    id,
    name,
    salary,
    ROW_NUMBER() OVER (PARTITION BY department ORDER BY salary DESC) as rank,
    LAG(salary) OVER (PARTITION BY department ORDER BY salary DESC) as prev_salary,
    LEAD(salary) OVER (PARTITION BY department ORDER BY salary DESC) as next_salary
FROM employees;
```

#### CTEï¼ˆå…¬å…±è¡¨è¡¨è¾¾å¼ï¼‰

```sql
-- SQLite: 3.8.3+æ”¯æŒCTE
WITH RECURSIVE categories AS (
    SELECT id, name, parent_id, 0 as level
    FROM category
    WHERE parent_id IS NULL
    UNION ALL
    SELECT c.id, c.name, c.parent_id, cat.level + 1
    FROM category c
    JOIN categories cat ON c.parent_id = cat.id
)
SELECT * FROM categories;

-- PostgreSQL: å®Œæ•´CTEæ”¯æŒï¼ˆç›¸åŒè¯­æ³•ï¼‰
WITH RECURSIVE categories AS (
    SELECT id, name, parent_id, 0 as level
    FROM category
    WHERE parent_id IS NULL
    UNION ALL
    SELECT c.id, c.name, c.parent_id, cat.level + 1
    FROM category c
    JOIN categories cat ON c.parent_id = cat.id
)
SELECT * FROM categories;
```

---

## å››ã€æ¶æ„ç‰¹æ€§è½¬æ¢

### 4.1 å¹¶å‘æ§åˆ¶è½¬æ¢

#### SQLite WALæ¨¡å¼ â†’ PostgreSQL MVCC

**SQLite WALæ¨¡å¼**ï¼š

```sql
-- SQLite: WALæ¨¡å¼ï¼ˆä¸€å†™å¤šè¯»ï¼‰
PRAGMA journal_mode=WAL;
PRAGMA synchronous=NORMAL;
```

**PostgreSQL MVCC**ï¼š

```sql
-- PostgreSQL: MVCCï¼ˆå¤šå†™å¤šè¯»ï¼‰
-- é»˜è®¤æ”¯æŒï¼Œæ— éœ€ç‰¹æ®Šé…ç½®
-- æ”¯æŒå¤šç§éš”ç¦»çº§åˆ«
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;  -- é»˜è®¤
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
```

#### é”æœºåˆ¶è½¬æ¢

| SQLiteé” | PostgreSQLé” | è¯´æ˜ |
|---------|-------------|------|
| UNLOCKED | æ— é” | æ— è¿æ¥ |
| SHARED | AccessShareLock | è¯»é” |
| RESERVED | RowExclusiveLock | å†™é”å‡†å¤‡ |
| PENDING | ShareLock | ç­‰å¾…å†™é” |
| EXCLUSIVE | ExclusiveLock | æ’ä»–é” |

### 4.2 äº‹åŠ¡å¤„ç†è½¬æ¢

#### äº‹åŠ¡éš”ç¦»çº§åˆ«

```sql
-- SQLite: SERIALIZABLEï¼ˆå”¯ä¸€éš”ç¦»çº§åˆ«ï¼‰
BEGIN TRANSACTION;
-- æ“ä½œ
COMMIT;

-- PostgreSQL: å¤šç§éš”ç¦»çº§åˆ«
BEGIN TRANSACTION ISOLATION LEVEL READ COMMITTED;
-- æ“ä½œ
COMMIT;
```

#### SAVEPOINTå¤„ç†

```sql
-- SQLite: SAVEPOINT
BEGIN;
SAVEPOINT sp1;
-- æ“ä½œ1
RELEASE SAVEPOINT sp1;
SAVEPOINT sp2;
-- æ“ä½œ2
ROLLBACK TO SAVEPOINT sp2;
COMMIT;

-- PostgreSQL: ç›¸åŒè¯­æ³•
BEGIN;
SAVEPOINT sp1;
-- æ“ä½œ1
RELEASE SAVEPOINT sp1;
SAVEPOINT sp2;
-- æ“ä½œ2
ROLLBACK TO SAVEPOINT sp2;
COMMIT;
```

### 4.3 å­˜å‚¨å¼•æ“å·®å¼‚

#### æ–‡ä»¶ç»“æ„

**SQLite**ï¼š

- å•æ–‡ä»¶æ•°æ®åº“
- é¡µå¤§å°ï¼š512B - 64KB
- B-Treeå­˜å‚¨

**PostgreSQL**ï¼š

- å¤šæ–‡ä»¶å­˜å‚¨ï¼ˆè¡¨ç©ºé—´ï¼‰
- é¡µå¤§å°ï¼š8KBï¼ˆå›ºå®šï¼‰
- Heap + B-Treeç´¢å¼•

#### å­˜å‚¨ä¼˜åŒ–

```sql
-- SQLite: VACUUMä¼˜åŒ–
VACUUM;
VACUUM INTO 'backup.db';

-- PostgreSQL: VACUUMå’ŒANALYZE
VACUUM ANALYZE;
VACUUM FULL;  -- æ›´å½»åº•çš„æ¸…ç†
```

### 4.4 è¿æ¥ç®¡ç†è½¬æ¢

#### è¿æ¥æ–¹å¼

**SQLite**ï¼š

```python
# SQLite: æ–‡ä»¶è¿æ¥
import sqlite3
conn = sqlite3.connect('database.db')
```

**PostgreSQL**ï¼š

```python
# PostgreSQL: ç½‘ç»œè¿æ¥
import psycopg2
conn = psycopg2.connect(
    host='localhost',
    port=5432,
    database='mydb',
    user='user',
    password='password'
)
```

#### è¿æ¥æ± 

**SQLite**ï¼šé€šå¸¸å•è¿æ¥

```python
# SQLite: å•è¿æ¥æ¨¡å¼
conn = sqlite3.connect('database.db', check_same_thread=False)
```

**PostgreSQL**ï¼šéœ€è¦è¿æ¥æ± 

```python
# PostgreSQL: è¿æ¥æ± ï¼ˆä½¿ç”¨psycopg2.poolï¼‰
from psycopg2 import pool

connection_pool = pool.SimpleConnectionPool(
    minconn=1,
    maxconn=20,
    host='localhost',
    port=5432,
    database='mydb',
    user='user',
    password='password'
)
```

---

## äº”ã€è¿ç§»å·¥å…·å’Œæ–¹æ¡ˆ

### 5.1 å®˜æ–¹å·¥å…·

#### pgloader

**åŠŸèƒ½**ï¼šPostgreSQLå®˜æ–¹æ¨èçš„è¿ç§»å·¥å…·

**ç‰¹ç‚¹**ï¼š

- æ”¯æŒSQLiteåˆ°PostgreSQLè¿ç§»
- è‡ªåŠ¨ç±»å‹è½¬æ¢
- å¹¶è¡Œè¿ç§»
- é”™è¯¯å¤„ç†

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```bash
# å®‰è£…pgloader
# Ubuntu/Debian
sudo apt-get install pgloader

# è¿ç§»å‘½ä»¤
pgloader sqlite:///path/to/database.db postgresql://user:password@localhost/dbname
```

**é…ç½®æ–‡ä»¶æ–¹å¼**ï¼š

```lisp
LOAD DATABASE
    FROM sqlite:///path/to/database.db
    INTO postgresql://user:password@localhost/dbname

WITH
    include drop, create tables, create indexes, reset sequences

SET work_mem to '256MB',
    maintenance_work_mem to '512MB'

CAST type datetime to timestamptz
     drop default drop not null using zero-dates-to-null,
     type date to date
     drop default drop not null using zero-dates-to-null

BEFORE LOAD DO
    $$ create schema if not exists migration; $$;
```

### 5.2 ç¬¬ä¸‰æ–¹å·¥å…·

#### SQLite to PostgreSQL Converter

**åœ¨çº¿å·¥å…·**ï¼š

- <https://www.rebasedata.com/>
- <https://dbconvert.com/sqlite/postgresql/>

**ç‰¹ç‚¹**ï¼š

- å›¾å½¢ç•Œé¢
- è‡ªåŠ¨è½¬æ¢
- æ”¯æŒå¤§æ–‡ä»¶

#### è‡ªå®šä¹‰Pythonè„šæœ¬

```python
#!/usr/bin/env python3
"""
SQLite to PostgreSQL Migration Script
åŸºäºæˆç†Ÿçš„è¿ç§»æ–¹æ¡ˆ
"""

import sqlite3
import psycopg2
from psycopg2.extras import execute_values

def migrate_table(sqlite_conn, pg_conn, table_name):
    """è¿ç§»å•ä¸ªè¡¨"""
    # 1. è·å–SQLiteè¡¨ç»“æ„
    sqlite_cursor = sqlite_conn.cursor()
    sqlite_cursor.execute(f"PRAGMA table_info({table_name})")
    columns = sqlite_cursor.fetchall()

    # 2. åˆ›å»ºPostgreSQLè¡¨
    pg_cursor = pg_conn.cursor()
    create_table_sql = generate_pg_create_table(table_name, columns)
    pg_cursor.execute(create_table_sql)

    # 3. è¿ç§»æ•°æ®
    sqlite_cursor.execute(f"SELECT * FROM {table_name}")
    rows = sqlite_cursor.fetchall()

    if rows:
        columns_list = [col[1] for col in columns]
        execute_values(
            pg_cursor,
            f"INSERT INTO {table_name} ({','.join(columns_list)}) VALUES %s",
            rows
        )

    pg_conn.commit()

def generate_pg_create_table(table_name, columns):
    """ç”ŸæˆPostgreSQL CREATE TABLEè¯­å¥"""
    # ç±»å‹æ˜ å°„é€»è¾‘
    type_mapping = {
        'INTEGER': 'INTEGER',
        'REAL': 'DOUBLE PRECISION',
        'TEXT': 'TEXT',
        'BLOB': 'BYTEA'
    }

    # æ„å»ºCREATE TABLEè¯­å¥
    # ... å®ç°ç»†èŠ‚
    pass
```

### 5.3 è‡ªå®šä¹‰è¿ç§»è„šæœ¬

#### å®Œæ•´è¿ç§»è„šæœ¬æ¡†æ¶

```python
"""
å®Œæ•´çš„SQLiteåˆ°PostgreSQLè¿ç§»è„šæœ¬
å‚è€ƒæˆç†Ÿçš„å¼€æºæ–¹æ¡ˆ
"""

import sqlite3
import psycopg2
import json
from typing import Dict, List, Tuple

class SQLiteToPostgreSQLMigrator:
    """SQLiteåˆ°PostgreSQLè¿ç§»å™¨"""

    def __init__(self, sqlite_path: str, pg_config: Dict):
        self.sqlite_conn = sqlite3.connect(sqlite_path)
        self.pg_conn = psycopg2.connect(**pg_config)
        self.type_mapping = self._init_type_mapping()

    def _init_type_mapping(self) -> Dict:
        """åˆå§‹åŒ–ç±»å‹æ˜ å°„"""
        return {
            'INTEGER': 'INTEGER',
            'REAL': 'DOUBLE PRECISION',
            'TEXT': 'TEXT',
            'BLOB': 'BYTEA',
            'NUMERIC': 'NUMERIC'
        }

    def migrate_schema(self):
        """è¿ç§»æ•°æ®åº“ç»“æ„"""
        tables = self._get_sqlite_tables()
        for table in tables:
            self._migrate_table_schema(table)

    def migrate_data(self):
        """è¿ç§»æ•°æ®"""
        tables = self._get_sqlite_tables()
        for table in tables:
            self._migrate_table_data(table)

    def migrate_indexes(self):
        """è¿ç§»ç´¢å¼•"""
        tables = self._get_sqlite_tables()
        for table in tables:
            self._migrate_table_indexes(table)

    def _get_sqlite_tables(self) -> List[str]:
        """è·å–SQLiteæ‰€æœ‰è¡¨"""
        cursor = self.sqlite_conn.cursor()
        cursor.execute("""
            SELECT name FROM sqlite_master
            WHERE type='table' AND name NOT LIKE 'sqlite_%'
        """)
        return [row[0] for row in cursor.fetchall()]

    def _migrate_table_schema(self, table_name: str):
        """è¿ç§»è¡¨ç»“æ„"""
        # è·å–SQLiteè¡¨ç»“æ„
        sqlite_schema = self._get_sqlite_schema(table_name)

        # è½¬æ¢ä¸ºPostgreSQL DDL
        pg_ddl = self._convert_to_pg_ddl(table_name, sqlite_schema)

        # æ‰§è¡ŒPostgreSQL DDL
        pg_cursor = self.pg_conn.cursor()
        pg_cursor.execute(pg_ddl)
        self.pg_conn.commit()

    def _migrate_table_data(self, table_name: str):
        """è¿ç§»è¡¨æ•°æ®"""
        sqlite_cursor = self.sqlite_conn.cursor()
        sqlite_cursor.execute(f"SELECT * FROM {table_name}")

        pg_cursor = self.pg_conn.cursor()
        columns = [desc[0] for desc in sqlite_cursor.description]

        batch_size = 1000
        while True:
            rows = sqlite_cursor.fetchmany(batch_size)
            if not rows:
                break

            # æ•°æ®è½¬æ¢
            converted_rows = [self._convert_row(row, columns) for row in rows]

            # æ‰¹é‡æ’å…¥
            from psycopg2.extras import execute_values
            execute_values(
                pg_cursor,
                f"INSERT INTO {table_name} ({','.join(columns)}) VALUES %s",
                converted_rows
            )

        self.pg_conn.commit()

    def _convert_row(self, row: Tuple, columns: List[str]) -> Tuple:
        """è½¬æ¢è¡Œæ•°æ®"""
        # å¤„ç†NULLã€ç±»å‹è½¬æ¢ç­‰
        converted = []
        for i, value in enumerate(row):
            if value is None:
                converted.append(None)
            elif isinstance(value, bytes):
                converted.append(psycopg2.Binary(value))
            else:
                converted.append(value)
        return tuple(converted)
```

### 5.4 æˆç†Ÿæ¡ˆä¾‹å‚è€ƒ

#### æ¡ˆä¾‹1ï¼šDjangoé¡¹ç›®è¿ç§»

**åœºæ™¯**ï¼šDjangoåº”ç”¨ä»SQLiteè¿ç§»åˆ°PostgreSQL

**æ–¹æ¡ˆ**ï¼š

```python
# settings.py
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'mydb',
        'USER': 'user',
        'PASSWORD': 'password',
        'HOST': 'localhost',
        'PORT': '5432',
    }
}

# è¿ç§»æ­¥éª¤
# 1. ä½¿ç”¨Djangoçš„dumpdataå’Œloaddata
python manage.py dumpdata > data.json
python manage.py loaddata data.json

# 2. æˆ–ä½¿ç”¨pgloader
pgloader sqlite:///path/to/db.sqlite3 postgresql://user:password@localhost/mydb
```

#### æ¡ˆä¾‹2ï¼šRailsé¡¹ç›®è¿ç§»

**åœºæ™¯**ï¼šRailsåº”ç”¨ä»SQLiteè¿ç§»åˆ°PostgreSQL

**æ–¹æ¡ˆ**ï¼š

```ruby
# Gemfile
gem 'pg'

# database.yml
production:
  adapter: postgresql
  database: myapp_production
  username: user
  password: password
  host: localhost

# è¿ç§»å‘½ä»¤
rails db:migrate
```

#### æ¡ˆä¾‹3ï¼šNode.jsé¡¹ç›®è¿ç§»

**åœºæ™¯**ï¼šNode.jsåº”ç”¨ä»SQLiteè¿ç§»åˆ°PostgreSQL

**æ–¹æ¡ˆ**ï¼š

```javascript
// ä½¿ç”¨node-sqlite3å’Œpg
const sqlite3 = require('sqlite3');
const { Client } = require('pg');

// è¿ç§»è„šæœ¬
async function migrate() {
    const sqlite = new sqlite3.Database('source.db');
    const pg = new Client({
        host: 'localhost',
        database: 'target',
        user: 'user',
        password: 'password'
    });

    await pg.connect();

    // è¿ç§»é€»è¾‘
    // ...
}
```

---

## å…­ã€è¿ç§»æ‰§è¡Œæµç¨‹

### 6.1 è¿ç§»å‰å‡†å¤‡

#### ç¯å¢ƒå‡†å¤‡æ¸…å•

- [ ] PostgreSQLæœåŠ¡å™¨å·²å®‰è£…å’Œé…ç½®
- [ ] æ•°æ®åº“ç”¨æˆ·å’Œæƒé™å·²åˆ›å»º
- [ ] ç½‘ç»œè¿æ¥æµ‹è¯•é€šè¿‡
- [ ] å¤‡ä»½SQLiteæ•°æ®åº“
- [ ] å‡†å¤‡å›æ»šæ–¹æ¡ˆ

#### æ•°æ®å¤‡ä»½

```bash
# SQLiteå¤‡ä»½
sqlite3 source.db ".backup backup.db"

# æˆ–ä½¿ç”¨VACUUM INTO
sqlite3 source.db "VACUUM INTO 'backup.db'"
```

#### ç¯å¢ƒæµ‹è¯•

```python
# æµ‹è¯•PostgreSQLè¿æ¥
import psycopg2

try:
    conn = psycopg2.connect(
        host='localhost',
        database='test',
        user='user',
        password='password'
    )
    print("PostgreSQLè¿æ¥æˆåŠŸ")
    conn.close()
except Exception as e:
    print(f"è¿æ¥å¤±è´¥: {e}")
```

### 6.2 æ•°æ®è¿ç§»æ­¥éª¤

#### æ­¥éª¤1ï¼šè¿ç§»è¡¨ç»“æ„

```python
# 1. è·å–SQLiteè¡¨ç»“æ„
sqlite_cursor.execute("""
    SELECT sql FROM sqlite_master
    WHERE type='table' AND name NOT LIKE 'sqlite_%'
""")

# 2. è½¬æ¢ä¸ºPostgreSQL DDL
# 3. æ‰§è¡ŒPostgreSQL DDL
```

#### æ­¥éª¤2ï¼šè¿ç§»æ•°æ®

```python
# 1. æŒ‰è¡¨é¡ºåºè¿ç§»æ•°æ®
# 2. å¤„ç†å¤–é”®ä¾èµ–
# 3. æ‰¹é‡æ’å…¥ä¼˜åŒ–
```

#### æ­¥éª¤3ï¼šè¿ç§»ç´¢å¼•

```python
# 1. è¿ç§»æ™®é€šç´¢å¼•
# 2. è¿ç§»å”¯ä¸€ç´¢å¼•
# 3. è¿ç§»å¤åˆç´¢å¼•
```

#### æ­¥éª¤4ï¼šè¿ç§»çº¦æŸ

```python
# 1. è¿ç§»ä¸»é”®çº¦æŸ
# 2. è¿ç§»å¤–é”®çº¦æŸ
# 3. è¿ç§»CHECKçº¦æŸ
```

### 6.3 åº”ç”¨ä»£ç è¿ç§»

#### ORMè¿ç§»

**SQLAlchemyç¤ºä¾‹**ï¼š

```python
# SQLite
from sqlalchemy import create_engine
engine = create_engine('sqlite:///database.db')

# PostgreSQL
from sqlalchemy import create_engine
engine = create_engine('postgresql://user:password@localhost/dbname')
```

**Djangoç¤ºä¾‹**ï¼š

```python
# settings.py
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        # ...
    }
}
```

#### åŸç”ŸSQLè¿ç§»

```python
# SQLiteç‰¹å®šè¯­æ³•éœ€è¦ä¿®æ”¹
# ä¾‹å¦‚ï¼šæ—¥æœŸå‡½æ•°ã€å­—ç¬¦ä¸²å‡½æ•°ç­‰
```

### 6.4 è¿ç§»åéªŒè¯

#### æ•°æ®å®Œæ•´æ€§éªŒè¯

```sql
-- 1. è®°å½•æ•°å¯¹æ¯”
SELECT
    'SQLite' as source,
    COUNT(*) as count
FROM sqlite_table
UNION ALL
SELECT
    'PostgreSQL' as source,
    COUNT(*) as count
FROM pg_table;

-- 2. æ•°æ®ä¸€è‡´æ€§éªŒè¯
SELECT
    s.id,
    s.name as sqlite_name,
    p.name as pg_name,
    CASE WHEN s.name = p.name THEN 'OK' ELSE 'MISMATCH' END as status
FROM sqlite_table s
JOIN pg_table p ON s.id = p.id
WHERE s.name != p.name;
```

#### æ€§èƒ½éªŒè¯

```sql
-- PostgreSQLæ€§èƒ½æµ‹è¯•
EXPLAIN ANALYZE
SELECT * FROM users WHERE email = 'test@example.com';
```

---

## ä¸ƒã€æ€§èƒ½ä¼˜åŒ–è°ƒæ•´

### 7.1 æŸ¥è¯¢ä¼˜åŒ–å·®å¼‚

#### æŸ¥è¯¢è®¡åˆ’å™¨

**SQLite**ï¼šç®€å•æŸ¥è¯¢ä¼˜åŒ–å™¨

- åŸºäºè§„åˆ™çš„ä¼˜åŒ–
- æœ‰é™çš„ç»Ÿè®¡ä¿¡æ¯

**PostgreSQL**ï¼šé«˜çº§æŸ¥è¯¢ä¼˜åŒ–å™¨

- åŸºäºæˆæœ¬çš„ä¼˜åŒ–
- è¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯
- å¹¶è¡ŒæŸ¥è¯¢æ”¯æŒ

#### ä¼˜åŒ–å»ºè®®

```sql
-- PostgreSQL: æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE;

-- PostgreSQL: æŸ¥çœ‹æŸ¥è¯¢è®¡åˆ’
EXPLAIN ANALYZE SELECT * FROM users WHERE email = 'test@example.com';

-- PostgreSQL: å¹¶è¡ŒæŸ¥è¯¢
SET max_parallel_workers_per_gather = 4;
```

### 7.2 ç´¢å¼•ç­–ç•¥è°ƒæ•´

#### ç´¢å¼•ç±»å‹é€‰æ‹©

```sql
-- PostgreSQL: B-Treeç´¢å¼•ï¼ˆé»˜è®¤ï¼‰
CREATE INDEX idx_users_email ON users(email);

-- PostgreSQL: Hashç´¢å¼•ï¼ˆç­‰å€¼æŸ¥è¯¢ï¼‰
CREATE INDEX idx_users_email_hash ON users USING HASH(email);

-- PostgreSQL: GINç´¢å¼•ï¼ˆå…¨æ–‡æœç´¢ï¼‰
CREATE INDEX idx_articles_content_gin ON articles
    USING GIN(to_tsvector('english', content));

-- PostgreSQL: GiSTç´¢å¼•ï¼ˆç©ºé—´æ•°æ®ï¼‰
CREATE INDEX idx_locations_location_gist ON locations
    USING GIST(location);
```

### 7.3 è¿æ¥æ± é…ç½®

#### PostgreSQLè¿æ¥æ± é…ç½®

```python
# ä½¿ç”¨psycopg2.pool
from psycopg2 import pool

connection_pool = pool.ThreadedConnectionPool(
    minconn=1,
    maxconn=20,
    host='localhost',
    database='mydb',
    user='user',
    password='password'
)

# ä½¿ç”¨è¿æ¥
conn = connection_pool.getconn()
try:
    # ä½¿ç”¨è¿æ¥
    pass
finally:
    connection_pool.putconn(conn)
```

#### PgBounceré…ç½®

```ini
[databases]
mydb = host=localhost port=5432 dbname=mydb

[pgbouncer]
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 25
```

### 7.4 ç¼“å­˜ç­–ç•¥è°ƒæ•´

#### PostgreSQLç¼“å­˜é…ç½®

```sql
-- postgresql.conf
shared_buffers = 256MB          # å…±äº«å†…å­˜ç¼“å­˜
effective_cache_size = 1GB      # æŸ¥è¯¢è§„åˆ’å™¨å‡è®¾çš„ç¼“å­˜å¤§å°
work_mem = 16MB                 # æ¯ä¸ªæŸ¥è¯¢æ“ä½œçš„å†…å­˜
maintenance_work_mem = 128MB    # ç»´æŠ¤æ“ä½œçš„å†…å­˜
```

---

## å…«ã€å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 8.1 æ•°æ®ç±»å‹é—®é¢˜

#### é—®é¢˜1ï¼šINTEGERæº¢å‡º

**é—®é¢˜**ï¼šSQLite INTEGERå¯èƒ½å­˜å‚¨å¤§å€¼ï¼ŒPostgreSQL INTEGERå¯èƒ½æº¢å‡º

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æ£€æŸ¥æ•°æ®èŒƒå›´
SELECT MIN(id), MAX(id) FROM users;

-- ä½¿ç”¨BIGINT
ALTER TABLE users ALTER COLUMN id TYPE BIGINT;
```

#### é—®é¢˜2ï¼šæ—¥æœŸæ—¶é—´æ ¼å¼

**é—®é¢˜**ï¼šSQLiteå­˜å‚¨ä¸ºINTEGERæˆ–TEXTï¼ŒPostgreSQLéœ€è¦TIMESTAMP

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- è½¬æ¢æ—¥æœŸæ—¶é—´
ALTER TABLE logs
    ALTER COLUMN created_at TYPE TIMESTAMP
    USING to_timestamp(created_at);
```

### 8.2 å¹¶å‘é—®é¢˜

#### é—®é¢˜1ï¼šé”ç­‰å¾…

**é—®é¢˜**ï¼šPostgreSQLå¹¶å‘æ§åˆ¶æ›´ä¸¥æ ¼

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- è®¾ç½®é”è¶…æ—¶
SET lock_timeout = '5s';

-- ä½¿ç”¨é€‚å½“çš„éš”ç¦»çº§åˆ«
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
```

### 8.3 æ€§èƒ½é—®é¢˜

#### é—®é¢˜1ï¼šæŸ¥è¯¢å˜æ…¢

**é—®é¢˜**ï¼šè¿ç§»åæŸ¥è¯¢æ€§èƒ½ä¸‹é™

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE;

-- é‡å»ºç´¢å¼•
REINDEX DATABASE mydb;

-- ä¼˜åŒ–æŸ¥è¯¢
EXPLAIN ANALYZE SELECT ...;
```

### 8.4 å…¼å®¹æ€§é—®é¢˜

#### é—®é¢˜1ï¼šå‡½æ•°ä¸å…¼å®¹

**é—®é¢˜**ï¼šæŸäº›SQLiteå‡½æ•°åœ¨PostgreSQLä¸­ä¸å­˜åœ¨

**è§£å†³æ–¹æ¡ˆ**ï¼š

```sql
-- åˆ›å»ºå…¼å®¹å‡½æ•°
CREATE OR REPLACE FUNCTION sqlite_julianday(timestamp)
RETURNS numeric AS $$
    SELECT EXTRACT(EPOCH FROM $1) / 86400.0 + 2440587.5;
$$ LANGUAGE SQL;
```

---

## ä¹ã€æˆç†Ÿæ¡ˆä¾‹ç ”ç©¶

### 9.1 æ¡ˆä¾‹ä¸€ï¼šWebåº”ç”¨è¿ç§»

#### èƒŒæ™¯

- **åº”ç”¨ç±»å‹**ï¼šDjango Webåº”ç”¨
- **æ•°æ®é‡**ï¼š50GB
- **ç”¨æˆ·æ•°**ï¼š10ä¸‡+
- **è¿ç§»åŸå› **ï¼šéœ€è¦æ”¯æŒé«˜å¹¶å‘å†™å…¥

#### è¿ç§»æ–¹æ¡ˆ

1. **å‡†å¤‡é˜¶æ®µ**ï¼ˆ1å‘¨ï¼‰
   - PostgreSQLç¯å¢ƒæ­å»º
   - æ•°æ®å¤‡ä»½
   - è¿ç§»è„šæœ¬å¼€å‘

2. **è¿ç§»é˜¶æ®µ**ï¼ˆ3å¤©ï¼‰
   - ä½¿ç”¨pgloaderè¿ç§»æ•°æ®
   - åº”ç”¨ä»£ç è°ƒæ•´
   - åŠŸèƒ½æµ‹è¯•

3. **éªŒè¯é˜¶æ®µ**ï¼ˆ1å‘¨ï¼‰
   - æ•°æ®å®Œæ•´æ€§éªŒè¯
   - æ€§èƒ½æµ‹è¯•
   - ç”¨æˆ·éªŒæ”¶æµ‹è¯•

#### è¿ç§»ç»“æœ

- **æ•°æ®å®Œæ•´æ€§**ï¼š100%
- **æ€§èƒ½æå‡**ï¼šå†™å…¥æ€§èƒ½æå‡5å€
- **å¹¶å‘èƒ½åŠ›**ï¼šä»å•å†™æå‡åˆ°å¤šå†™
- **åœæœºæ—¶é—´**ï¼š4å°æ—¶

### 9.2 æ¡ˆä¾‹äºŒï¼šæ•°æ®åˆ†æå¹³å°è¿ç§»

#### èƒŒæ™¯

- **åº”ç”¨ç±»å‹**ï¼šæ•°æ®åˆ†æå¹³å°
- **æ•°æ®é‡**ï¼š200GB
- **æŸ¥è¯¢å¤æ‚åº¦**ï¼šå¤æ‚èšåˆæŸ¥è¯¢
- **è¿ç§»åŸå› **ï¼šéœ€è¦é«˜çº§æŸ¥è¯¢åŠŸèƒ½

#### è¿ç§»æ–¹æ¡ˆ

1. **åˆ†é˜¶æ®µè¿ç§»**
   - ç¬¬ä¸€é˜¶æ®µï¼šå†å²æ•°æ®è¿ç§»
   - ç¬¬äºŒé˜¶æ®µï¼šå®æ—¶æ•°æ®è¿ç§»
   - ç¬¬ä¸‰é˜¶æ®µï¼šåº”ç”¨åˆ‡æ¢

2. **ä¼˜åŒ–ç­–ç•¥**
   - è¡¨åˆ†åŒº
   - ç´¢å¼•ä¼˜åŒ–
   - æŸ¥è¯¢é‡å†™

#### è¿ç§»ç»“æœ

- **æŸ¥è¯¢æ€§èƒ½**ï¼šæå‡3-10å€
- **åŠŸèƒ½å¢å¼º**ï¼šæ”¯æŒçª—å£å‡½æ•°ã€CTEç­‰
- **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒæ›´å¤§æ•°æ®é‡

### 9.3 æ¡ˆä¾‹ä¸‰ï¼šç§»åŠ¨åº”ç”¨åç«¯è¿ç§»

#### èƒŒæ™¯

- **åº”ç”¨ç±»å‹**ï¼šç§»åŠ¨åº”ç”¨åç«¯
- **æ•°æ®é‡**ï¼š20GB
- **å¹¶å‘è¦æ±‚**ï¼šé«˜å¹¶å‘è¯»å–
- **è¿ç§»åŸå› **ï¼šéœ€è¦å¤šæœåŠ¡å™¨éƒ¨ç½²

#### è¿ç§»æ–¹æ¡ˆ

1. **è“ç»¿éƒ¨ç½²**
   - è“è‰²ç¯å¢ƒï¼šSQLite
   - ç»¿è‰²ç¯å¢ƒï¼šPostgreSQL
   - é€æ­¥åˆ‡æ¢æµé‡

2. **æ•°æ®åŒæ­¥**
   - å®æ—¶æ•°æ®åŒæ­¥
   - åŒå†™ç­–ç•¥
   - æœ€ç»ˆä¸€è‡´æ€§

#### è¿ç§»ç»“æœ

- **å¯ç”¨æ€§**ï¼š99.9%
- **æ‰©å±•æ€§**ï¼šæ”¯æŒæ°´å¹³æ‰©å±•
- **æ€§èƒ½**ï¼šè¯»å–æ€§èƒ½æå‡2å€

---

## ğŸ“Š è¿ç§»æ£€æŸ¥æ¸…å•

### è¿ç§»å‰

- [ ] ä¸šåŠ¡éœ€æ±‚åˆ†æå®Œæˆ
- [ ] è¿ç§»æˆæœ¬è¯„ä¼°å®Œæˆ
- [ ] PostgreSQLç¯å¢ƒå‡†å¤‡å®Œæˆ
- [ ] æ•°æ®å¤‡ä»½å®Œæˆ
- [ ] è¿ç§»è„šæœ¬æµ‹è¯•é€šè¿‡
- [ ] å›æ»šæ–¹æ¡ˆå‡†å¤‡å®Œæˆ

### è¿ç§»ä¸­

- [ ] è¡¨ç»“æ„è¿ç§»å®Œæˆ
- [ ] æ•°æ®è¿ç§»å®Œæˆ
- [ ] ç´¢å¼•è¿ç§»å®Œæˆ
- [ ] çº¦æŸè¿ç§»å®Œæˆ
- [ ] åº”ç”¨ä»£ç è¿ç§»å®Œæˆ
- [ ] åŠŸèƒ½æµ‹è¯•é€šè¿‡

### è¿ç§»å

- [ ] æ•°æ®å®Œæ•´æ€§éªŒè¯é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡
- [ ] ç”¨æˆ·éªŒæ”¶æµ‹è¯•é€šè¿‡
- [ ] ç›‘æ§å‘Šè­¦é…ç½®å®Œæˆ
- [ ] æ–‡æ¡£æ›´æ–°å®Œæˆ
- [ ] å›¢é˜ŸåŸ¹è®­å®Œæˆ

---

## ğŸ”— ç›¸å…³èµ„æº

- [05.01 å¤šç»´çŸ¥è¯†çŸ©é˜µ](../05-å¯¹æ¯”é€‰å‹/05.01-å¤šç»´çŸ¥è¯†çŸ©é˜µ.md) - SQLite vs PostgreSQLå¯¹æ¯”
- [02.01 æ•°æ®ç±»å‹ç³»ç»Ÿ](../02-æ•°æ®æ¨¡å‹/02.01-æ•°æ®ç±»å‹ç³»ç»Ÿ.md) - SQLiteæ•°æ®ç±»å‹è¯¦è§£
- [08.01 è¿æ¥ç®¡ç†](../08-ç¼–ç¨‹å®è·µ/08.01-è¿æ¥ç®¡ç†.md) - è¿æ¥ç®¡ç†æœ€ä½³å®è·µ

---

## ğŸ“š å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- [PostgreSQLå®˜æ–¹æ–‡æ¡£](https://www.postgresql.org/docs/)
- [pgloaderæ–‡æ¡£](https://pgloader.readthedocs.io/)
- [SQLiteå®˜æ–¹æ–‡æ¡£](https://www.sqlite.org/docs.html)

### è¿ç§»å·¥å…·

- [pgloader](https://github.com/dimitri/pgloader) - PostgreSQLå®˜æ–¹æ¨è
- [RebaseData](https://www.rebasedata.com/) - åœ¨çº¿è¿ç§»å·¥å…·
- [DBConvert](https://dbconvert.com/) - å•†ä¸šè¿ç§»å·¥å…·

### æˆç†Ÿæ¡ˆä¾‹

- [Djangoè¿ç§»æŒ‡å—](https://docs.djangoproject.com/en/stable/ref/databases/#postgresql-notes)
- [Railsè¿ç§»æŒ‡å—](https://guides.rubyonrails.org/configuring.html#configuring-a-postgresql-database)
- [Node.jsè¿ç§»æŒ‡å—](https://node-postgres.com/)

---

**ç»´æŠ¤è€…**ï¼šData-Science Team
**æœ€åæ›´æ–°**ï¼š2025-11-13
