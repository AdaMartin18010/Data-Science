# SQLite核心机制深度解析：源码级分析

> **创建日期**：2025-12-01
> **版本**：SQLite 3.45.x / 3.47.x
> **难度**：⭐⭐⭐⭐⭐
> **前置知识**：事务理论、操作系统、C语言

---

## 📋 目录

- [SQLite核心机制深度解析：源码级分析](#sqlite核心机制深度解析源码级分析)
  - [📋 目录](#-目录)
  - [一、概述与知识图谱](#一概述与知识图谱)
    - [1.1 SQLite核心机制思维导图](#11-sqlite核心机制思维导图)
    - [1.2 核心组件关系矩阵](#12-核心组件关系矩阵)
  - [二、SQLite架构全景图](#二sqlite架构全景图)
    - [2.1 执行流程架构](#21-执行流程架构)
    - [2.2 源码模块映射](#22-源码模块映射)
  - [三、锁机制源码分析](#三锁机制源码分析)
    - [3.1 五级锁状态机](#31-五级锁状态机)
    - [3.2 锁实现源码分析](#32-锁实现源码分析)
  - [四、WAL模式深度解析](#四wal模式深度解析)
    - [4.1 WAL文件结构](#41-wal文件结构)
    - [4.2 WAL读写流程](#42-wal读写流程)
    - [4.3 WAL源码关键函数](#43-wal源码关键函数)
  - [五、事务ACID实现](#五事务acid实现)
    - [5.1 ACID属性实现矩阵](#51-acid属性实现矩阵)
    - [5.2 事务状态机](#52-事务状态机)
  - [六、程序控制流分析](#六程序控制流分析)
    - [6.1 完整SQL执行控制流](#61-完整sql执行控制流)
    - [6.2 并发读写交互图](#62-并发读写交互图)
  - [七、数据流与版本流](#七数据流与版本流)
    - [7.1 WAL数据版本流](#71-wal数据版本流)
    - [7.2 页面生命周期](#72-页面生命周期)
  - [八、多视角分析](#八多视角分析)
    - [8.1 使用者视角](#81-使用者视角)
    - [8.2 设计者视角](#82-设计者视角)
    - [8.3 程序员视角](#83-程序员视角)
    - [8.4 数据转换视角](#84-数据转换视角)
  - [九、形式化证明](#九形式化证明)
    - [9.1 WAL快照隔离正确性证明](#91-wal快照隔离正确性证明)
    - [9.2 WAL崩溃恢复正确性证明](#92-wal崩溃恢复正确性证明)
  - [十、设计权衡与决策](#十设计权衡与决策)
    - [10.1 设计决策树](#101-设计决策树)
    - [10.2 性能权衡矩阵](#102-性能权衡矩阵)
  - [相关资源](#相关资源)
    - [相关文档](#相关文档)
    - [外部资源](#外部资源)

---

## 一、概述与知识图谱

### 1.1 SQLite核心机制思维导图

```text
SQLite核心机制知识图谱
══════════════════════════════════════════════════════════════════════════════

                            SQLite核心机制
                                  │
     ┌─────────────┬──────────────┼──────────────┬─────────────┐
     │             │              │              │             │
     ▼             ▼              ▼              ▼             ▼
  锁机制        WAL模式       事务ACID      并发控制      恢复机制
     │             │              │              │             │
┌────┴────┐  ┌────┴────┐   ┌────┴────┐   ┌────┴────┐   ┌────┴────┐
│         │  │         │   │         │   │         │   │         │
▼         ▼  ▼         ▼   ▼         ▼   ▼         ▼   ▼         ▼
UNLOCKED  WAL帧   原子性  隔离性  读不阻塞写  检查点    日志回放
SHARED    WAL索引 一致性  持久性  单写者模型  热备份    崩溃恢复
RESERVED  Checkpoint
PENDING   截断/重置
EXCLUSIVE

════════════════════════════════════════════════════════════════════════════
源码核心模块:
├── pager.c      - 页面缓存与事务管理 (核心: ~12000行)
├── wal.c        - WAL实现 (~3500行)
├── btree.c      - B-Tree存储引擎 (~10000行)
├── sqlite3.c    - 统一源码 (amalgamation, ~250000行)
└── vdbe.c       - 虚拟机执行引擎 (~7000行)
════════════════════════════════════════════════════════════════════════════
```

### 1.2 核心组件关系矩阵

```text
SQLite核心组件依赖关系矩阵
══════════════════════════════════════════════════════════════════════════════

┌───────────────┬────────┬────────┬────────┬────────┬────────┬────────┐
│ 组件\依赖      │ Pager  │ WAL    │ B-Tree │ VDBE   │ Parser │ OS接口 │
├───────────────┼────────┼────────┼────────┼────────┼────────┼────────┤
│ Pager         │   -    │  使用  │   -    │   -    │   -    │  依赖  │
│ WAL           │  被用  │   -    │   -    │   -    │   -    │  依赖  │
│ B-Tree        │  依赖  │   -    │   -    │   -    │   -    │   -    │
│ VDBE          │   -    │   -    │  调用  │   -    │   -    │   -    │
│ Parser        │   -    │   -    │   -    │  生成  │   -    │   -    │
│ OS接口        │  被依赖 │  被依赖│   -    │   -    │   -    │   -    │
└───────────────┴────────┴────────┴────────┴────────┴────────┴────────┘

调用层次:
SQL语句 → Parser → VDBE字节码 → B-Tree操作 → Pager页面管理 → WAL/OS
```

---

## 二、SQLite架构全景图

### 2.1 执行流程架构

```text
SQLite执行流程全景图
══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│                          用户应用层                                          │
│  sqlite3_exec() / sqlite3_prepare_v2() / sqlite3_step()                     │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SQL前端 (Frontend)                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                          │
│  │  Tokenizer  │→ │   Parser    │→│  Code Gen    │                          │
│  │  (词法分析)  │  │  (语法分析) │  │ (字节码生成) │                          │
│  └─────────────┘  └─────────────┘  └─────────────┘                          │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                    │ VDBE字节码
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      VDBE虚拟机 (Virtual Machine)                            │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  Op_Transaction → Op_TableLock → Op_Column → Op_ResultRow           │    │
│  │  事务开始         表锁获取        列读取      结果返回                │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       B-Tree存储引擎                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                          │
│  │ 表B-Tree    │  │ 索引B-Tree  │  │ Cursor游标  │                          │
│  │ (rowid键)   │  │ (索引键)    │  │ (遍历接口)  │                          │
│  └──────┬──────┘  └──────┬──────┘  └─────────────┘                          │
│         │                │                                                   │
└─────────┼────────────────┼──────────────────────────────────────────────────┘
          │                │
          ▼                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Pager页面缓存                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  页面缓存(Page Cache) ←→ 脏页管理 ←→ 事务状态机                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                    │
            ┌───────────────────────┼───────────────────────┐
            │                       │                       │
            ▼                       ▼                       ▼
┌───────────────────┐   ┌───────────────────┐   ┌───────────────────┐
│   WAL子系统        │   │  Rollback Journal │   │    OS层接口       │
│ (.db-wal/.db-shm) │   │   (.db-journal)   │   │  (sqlite3_vfs)    │
└───────────────────┘   └───────────────────┘   └───────────────────┘
            │                       │                       │
            └───────────────────────┼───────────────────────┘
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           文件系统 / 磁盘                                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                          │
│  │ 主数据库文件 │  │  WAL文件    │  │  SHM文件     │                          │
│  │  (.db)      │  │ (.db-wal)   │  │ (.db-shm)   │                          │
│  └─────────────┘  └─────────────┘  └─────────────┘                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 源码模块映射

```text
SQLite源码模块与功能映射
══════════════════════════════════════════════════════════════════════════════

┌────────────────────────────────────────────────────────────────────────────┐
│ 源码文件          │ 行数    │ 核心功能                                       │
├───────────────────┼─────────┼──────────────────────────────────────────────┤
│ pager.c           │ ~12000  │ 页面缓存、事务管理、锁机制                     │
│                   │         │ - sqlite3PagerBegin()  开始事务               │
│                   │         │ - sqlite3PagerCommit() 提交事务               │
│                   │         │ - sqlite3PagerRollback() 回滚事务             │
│                   │         │ - pagerLockDb() 数据库锁                      │
├───────────────────┼─────────┼──────────────────────────────────────────────┤
│ wal.c             │ ~3500   │ WAL实现                                       │
│                   │         │ - sqlite3WalBeginReadTransaction() 读事务     │
│                   │         │ - sqlite3WalBeginWriteTransaction() 写事务    │
│                   │         │ - sqlite3WalFrames() 写入WAL帧                │
│                   │         │ - sqlite3WalCheckpoint() 检查点               │
├───────────────────┼─────────┼──────────────────────────────────────────────┤
│ btree.c           │ ~10000  │ B-Tree存储引擎                                │
│                   │         │ - sqlite3BtreeBeginTrans() 开始B-Tree事务     │
│                   │         │ - sqlite3BtreeInsert() 插入记录               │
│                   │         │ - sqlite3BtreeDelete() 删除记录               │
├───────────────────┼─────────┼──────────────────────────────────────────────┤
│ vdbe.c            │ ~7000   │ 虚拟机执行引擎                                │
│                   │         │ - sqlite3VdbeExec() 执行字节码                │
│                   │         │ - OP_Transaction 事务操作码                   │
│                   │         │ - OP_Savepoint 保存点操作码                   │
├───────────────────┼─────────┼──────────────────────────────────────────────┤
│ os_unix.c         │ ~6000   │ Unix平台OS接口                                │
│                   │         │ - unixLock() 文件锁                           │
│                   │         │ - unixRead()/unixWrite() 文件读写             │
└───────────────────┴─────────┴──────────────────────────────────────────────┘
```

---

## 三、锁机制源码分析

### 3.1 五级锁状态机

```text
SQLite五级锁状态机（源码级）
══════════════════════════════════════════════════════════════════════════════

锁状态定义 (pager.c):
─────────────────────────────────────────────────────────────────────────────
#define NO_LOCK         0    // UNLOCKED - 无锁
#define SHARED_LOCK     1    // SHARED - 共享锁（读锁）
#define RESERVED_LOCK   2    // RESERVED - 预留锁（准备写）
#define PENDING_LOCK    3    // PENDING - 挂起锁（等待独占）
#define EXCLUSIVE_LOCK  4    // EXCLUSIVE - 独占锁（写锁）

状态转换图:
─────────────────────────────────────────────────────────────────────────────
                    ┌────────────────────────────────────────┐
                    │                                        │
                    ▼                                        │
              ┌──────────┐                                   │
              │ UNLOCKED │ ←───────────────────────────────┐ │
              │  (无锁)   │                                │ │
              └────┬─────┘                                 │ │
                   │ 读操作                                │ │
                   │ sqlite3PagerSharedLock()              │ │
                   ▼                                       │ │
              ┌──────────┐                                 │ │
         ┌───→│  SHARED  │←──┐                             │ │
         │    │  (共享锁) │   │ 多个读者共存                 │ │
         │    └────┬─────┘   │                             │ │
         │         │ 写意图   │                             │ │
         │         │ pagerLockDb(RESERVED_LOCK)            │ │
         │         ▼                                       │ │
         │    ┌──────────┐                                 │ │
         │    │ RESERVED │                                 │ │
         │    │ (预留锁)  │ ← 最多一个写者持有               │ │
         │    └────┬─────┘                                 │ │
         │         │ 准备提交                               │ │
         │         │ 等待读者完成                           │ │
         │         ▼                                       │ │
         │    ┌──────────┐                                 │ │
         │    │ PENDING  │                                 │ │
         │    │ (挂起锁)  │ ← 阻止新读者，等待现有读者        │ │
         │    └────┬─────┘                                 │ │
         │         │ 所有读者完成                           │ │
         │         │ pagerLockDb(EXCLUSIVE_LOCK)           │ │
         │         ▼                                       │ │
         │    ┌──────────┐                                 │ │
         │    │EXCLUSIVE │                                 │ │
         │    │ (独占锁)  │ ← 独占访问，执行写入             │ │
         │    └────┬─────┘                                 │ │
         │         │ 提交完成                               │ │
         │         │ sqlite3PagerCommitPhaseTwo()          │ │
         └─────────┴───────────────────────────────────────┘ │
                                                             │
                           ROLLBACK ─────────────────────────┘

锁兼容矩阵:
─────────────────────────────────────────────────────────────────────────────
┌──────────┬──────────┬──────────┬──────────┬──────────┬──────────┐
│ 请求\持有 │ UNLOCKED │  SHARED  │ RESERVED │ PENDING  │EXCLUSIVE │
├──────────┼──────────┼──────────┼──────────┼──────────┼──────────┤
│ SHARED   │    ✓     │    ✓    │    ✓    │    ✗     │    ✗     │
│ RESERVED │    ✓     │    ✓    │    ✗    │    ✗     │    ✗     │
│ PENDING  │    ✓     │    ✗*   │    ✗    │    ✗     │    ✗     │
│ EXCLUSIVE│    ✓     │    ✗    │    ✗    │    ✗     │    ✗     │
└──────────┴──────────┴──────────┴──────────┴──────────┴──────────┘
* PENDING允许现有SHARED，但阻止新SHARED
```

### 3.2 锁实现源码分析

```c
/*
 * 源码位置: pager.c - pagerLockDb()
 * 功能: 获取数据库文件锁
 */

/*
 * 伪代码展示核心逻辑（简化自实际源码）
 */

// 锁升级函数
static int pagerLockDb(Pager *pPager, int eLock){
    int rc = SQLITE_OK;

    // 检查当前锁状态
    if( pPager->eLock < eLock ){
        // 调用OS层锁接口
        rc = sqlite3OsLock(pPager->fd, eLock);
        if( rc == SQLITE_OK ){
            pPager->eLock = eLock;
        }
    }
    return rc;
}

// Unix平台锁实现 (os_unix.c)
static int unixLock(sqlite3_file *id, int eLock){
    unixFile *pFile = (unixFile*)id;
    struct flock lock;
    int rc = SQLITE_OK;

    // SHARED锁: 在PENDING_BYTE上获取读锁
    if( eLock == SHARED_LOCK ){
        lock.l_type = F_RDLCK;
        lock.l_start = PENDING_BYTE;
        lock.l_len = 1;
        rc = fcntl(pFile->h, F_SETLK, &lock);
    }

    // RESERVED锁: 在RESERVED_BYTE上获取写锁
    else if( eLock == RESERVED_LOCK ){
        lock.l_type = F_WRLCK;
        lock.l_start = RESERVED_BYTE;
        lock.l_len = 1;
        rc = fcntl(pFile->h, F_SETLK, &lock);
    }

    // EXCLUSIVE锁: 锁定整个共享区域
    else if( eLock == EXCLUSIVE_LOCK ){
        lock.l_type = F_WRLCK;
        lock.l_start = SHARED_FIRST;
        lock.l_len = SHARED_SIZE;
        rc = fcntl(pFile->h, F_SETLK, &lock);
    }

    return rc;
}

/*
 * 文件锁字节布局 (os_unix.c):
 *
 * PENDING_BYTE  = 0x40000000  (1GB偏移)
 * RESERVED_BYTE = PENDING_BYTE + 1
 * SHARED_FIRST  = PENDING_BYTE + 2
 * SHARED_SIZE   = 510
 *
 * 这些字节永远不会包含实际数据，仅用于锁定
 */
```

---

## 四、WAL模式深度解析

### 4.1 WAL文件结构

```text
WAL文件物理结构
══════════════════════════════════════════════════════════════════════════════

WAL文件 (.db-wal):
┌─────────────────────────────────────────────────────────────────────────────┐
│                              WAL头部 (32字节)                                │
├─────────────────────────────────────────────────────────────────────────────┤
│ magic (4B)  │ version (4B) │ page_size (4B) │ checkpoint_seq (4B)          │
│ 0x377f0682  │    3007000   │      4096      │      序列号                   │
├─────────────┼──────────────┼────────────────┼───────────────────────────────┤
│ salt1 (4B)  │ salt2 (4B)   │ checksum1 (4B) │ checksum2 (4B)               │
│  随机盐值1   │  随机盐值2   │   头部校验和1   │   头部校验和2                │
└─────────────────────────────────────────────────────────────────────────────┘
│
▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            WAL帧1 (Frame 1)                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                          帧头 (24字节)                                       │
│ page_number (4B) │ db_size (4B) │ salt1 (4B) │ salt2 (4B)                   │
│ checksum1 (4B)   │ checksum2 (4B)                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                          页面数据 (page_size字节)                            │
│ [ 修改后的页面内容，通常4096字节 ]                                           │
└─────────────────────────────────────────────────────────────────────────────┘
│
▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            WAL帧2 (Frame 2)                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                          帧头 (24字节)                                       │
│                          页面数据 (page_size字节)                            │
└─────────────────────────────────────────────────────────────────────────────┘
│
... 更多帧 ...
│
▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          提交帧 (Commit Frame)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│ 帧头: db_size > 0 表示事务提交点                                             │
│ 页面数据                                                                     │
└─────────────────────────────────────────────────────────────────────────────┘


WAL索引文件 (.db-shm) - 共享内存映射:
┌─────────────────────────────────────────────────────────────────────────────┐
│                          WAL索引头部                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│ version │ isInit │ iChange │ nReader │ mxFrame │ nPage │ aReadMark[5]       │
│ WAL版本 │ 初始化 │ 变化计数│ 读者数  │ 最大帧号│ 页数  │ 读者标记            │
└─────────────────────────────────────────────────────────────────────────────┘
│
▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          哈希表区域                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│ 哈希表[0]: 页号→帧号映射 (前4096个帧)                                        │
│ 哈希表[1]: 页号→帧号映射 (后续帧)                                            │
│ ...                                                                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 WAL读写流程

```text
WAL模式读写控制流
══════════════════════════════════════════════════════════════════════════════

【读操作流程】
─────────────────────────────────────────────────────────────────────────────
sqlite3_step(SELECT)
    │
    ▼
sqlite3WalBeginReadTransaction()
    │
    ├─→ 获取WAL读锁 (不阻塞写者)
    │   walLockShared(WAL_READ_LOCK(0))
    │
    ├─→ 记录读取点 (mxFrame)
    │   pWal->readLock = 当前最大提交帧号
    │
    ▼
读取页面 sqlite3WalFindFrame()
    │
    ├─→ 在WAL索引中查找页号
    │   iFrame = walHashGet(pWal, pgno)
    │
    ├─→ 如果找到且 iFrame <= readLock
    │   │ 从WAL文件读取页面
    │   └─→ walFrameRead()
    │
    └─→ 如果未找到
        │ 从主数据库文件读取
        └─→ sqlite3OsRead(pPager->fd)

【写操作流程】
─────────────────────────────────────────────────────────────────────────────
sqlite3_step(INSERT/UPDATE/DELETE)
    │
    ▼
sqlite3WalBeginWriteTransaction()
    │
    ├─→ 获取WAL写锁 (单写者)
    │   walLockExclusive(WAL_WRITE_LOCK)
    │
    ▼
修改页面 (在内存中)
    │
    ▼
sqlite3WalFrames() - 写入WAL帧
    │
    ├─→ 构造WAL帧头
    │   walEncodeFrame()
    │
    ├─→ 计算校验和
    │   walChecksumBytes()
    │
    ├─→ 写入WAL文件
    │   sqlite3OsWrite(pWal->pWalFd, ...)
    │
    ├─→ 更新WAL索引
    │   walHashInsert()
    │
    ▼
sqlite3WalEndWriteTransaction()
    │
    ├─→ 同步WAL文件 (如果需要)
    │   sqlite3OsSync(pWal->pWalFd)
    │
    └─→ 释放写锁
        walUnlockExclusive(WAL_WRITE_LOCK)

【Checkpoint流程】
─────────────────────────────────────────────────────────────────────────────
sqlite3WalCheckpoint()
    │
    ├─→ 获取检查点锁
    │   walLockExclusive(WAL_CKPT_LOCK)
    │
    ├─→ 等待所有读者完成
    │   walBusyCallback() while readers active
    │
    ├─→ 将WAL页面复制到主数据库
    │   for each frame in WAL:
    │       读取WAL帧 → 写入主数据库对应页面
    │       sqlite3OsWrite(pPager->fd, ...)
    │
    ├─→ 同步主数据库
    │   sqlite3OsSync(pPager->fd)
    │
    ├─→ 根据模式处理WAL文件
    │   PASSIVE: 等待读者，不阻塞
    │   FULL:    等待所有读者完成
    │   RESTART: 重置WAL文件
    │   TRUNCATE: 截断WAL文件
    │
    └─→ 释放检查点锁
```

### 4.3 WAL源码关键函数

```c
/*
 * 源码位置: wal.c
 * 核心函数分析
 */

/*
 * 写入WAL帧 (简化)
 */
int sqlite3WalFrames(
    Wal *pWal,          // WAL连接
    int szPage,         // 页面大小
    PgHdr *pList,       // 脏页链表
    Pgno nTruncate,     // 截断大小
    int isCommit,       // 是否是提交
    int sync_flags      // 同步标志
){
    int rc = SQLITE_OK;
    PgHdr *p;

    // 遍历所有脏页
    for(p=pList; p && rc==SQLITE_OK; p=p->pDirty){
        // 构造帧头
        u32 aFrame[WALFRAME_SIZE/4];
        walEncodeFrame(pWal, p->pgno, nTruncate, aFrame);

        // 计算校验和
        walChecksumBytes(pWal,
            aFrame, sizeof(aFrame),  // 帧头
            p->pData, szPage,        // 页面数据
            &pWal->aCksum[0], &pWal->aCksum[1]
        );

        // 写入WAL文件
        rc = sqlite3OsWrite(pWal->pWalFd, aFrame, sizeof(aFrame),
                           pWal->iOffset);
        if( rc==SQLITE_OK ){
            rc = sqlite3OsWrite(pWal->pWalFd, p->pData, szPage,
                               pWal->iOffset + sizeof(aFrame));
        }

        // 更新WAL索引
        if( rc==SQLITE_OK ){
            walHashInsert(pWal, p->pgno, ++pWal->iFrame);
        }

        pWal->iOffset += sizeof(aFrame) + szPage;
    }

    // 提交帧同步
    if( isCommit && rc==SQLITE_OK ){
        rc = sqlite3OsSync(pWal->pWalFd, sync_flags);
    }

    return rc;
}

/*
 * 查找页面在WAL中的帧
 */
int sqlite3WalFindFrame(
    Wal *pWal,       // WAL连接
    Pgno pgno,       // 页号
    u32 *piFrame     // 输出：帧号
){
    u32 iHash;
    u32 iFrame = 0;

    // 在WAL索引哈希表中查找
    iHash = walHash(pgno);
    for(; iHash<pWal->nHashSlot; iHash++){
        u32 iFrameTest = pWal->aHash[iHash];
        if( iFrameTest > pWal->readLock ) break;  // 超过读取点
        if( pWal->aPgno[iFrameTest] == pgno ){
            iFrame = iFrameTest;  // 找到更新的版本
        }
    }

    *piFrame = iFrame;
    return SQLITE_OK;
}
```

---

## 五、事务ACID实现

### 5.1 ACID属性实现矩阵

```text
SQLite ACID实现机制矩阵
══════════════════════════════════════════════════════════════════════════════

┌─────────────┬────────────────────────────────────────────────────────────────┐
│ ACID属性    │ SQLite实现机制                                                 │
├─────────────┼────────────────────────────────────────────────────────────────┤
│ 原子性      │ • WAL模式: 帧级别原子写入，提交帧标记事务边界                  │
│ Atomicity   │ • DELETE模式: 回滚日志记录原始页面                             │
│             │ • 实现: sqlite3BtreeCommit() 要么全部成功，要么全部回滚        │
│             │ • 崩溃恢复: 未完成事务自动回滚                                 │
├─────────────┼────────────────────────────────────────────────────────────────┤
│ 一致性      │ • 约束检查: CHECK, FOREIGN KEY, UNIQUE在事务提交前验证         │
│ Consistency │ • B-Tree完整性: 页面校验和，结构一致性检查                     │
│             │ • WAL校验和: 每帧独立校验，防止部分写入                        │
│             │ • 实现: sqlite3BtreeIntegrityCheck()                           │
├─────────────┼────────────────────────────────────────────────────────────────┤
│ 隔离性      │ • WAL模式: 快照隔离，读者看到开始时刻的一致视图                │
│ Isolation   │ • 锁机制: SHARED/RESERVED/EXCLUSIVE防止冲突                    │
│             │ • 实现: sqlite3WalBeginReadTransaction()记录readLock           │
│             │ • 单写者: 同时最多一个写事务                                   │
├─────────────┼────────────────────────────────────────────────────────────────┤
│ 持久性      │ • WAL同步: sqlite3OsSync()刷新WAL到磁盘                        │
│ Durability  │ • Checkpoint: 将WAL内容合并到主数据库                          │
│             │ • 同步模式: PRAGMA synchronous = FULL/NORMAL/OFF               │
│             │ • 实现: sqlite3PagerCommitPhaseTwo()                           │
└─────────────┴────────────────────────────────────────────────────────────────┘
```

### 5.2 事务状态机

```text
SQLite事务状态机
══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│                          事务状态转换图                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  PAGER_OPEN ──────────────────────────────────────────────────────────────┐ │
│      │                                                                     │ │
│      │ sqlite3PagerSharedLock()                                           │ │
│      │ 获取SHARED锁                                                        │ │
│      ▼                                                                     │ │
│  PAGER_READER ────────────────────────────────────────────────────────────┤ │
│      │                                                                     │ │
│      │ sqlite3PagerBegin()                                                │ │
│      │ 获取RESERVED锁，开始写事务                                          │ │
│      ▼                                                                     │ │
│  PAGER_WRITER_LOCKED ─────────────────────────────────────────────────────┤ │
│      │                                                                     │ │
│      │ 首次修改页面                                                        │ │
│      │ 写入WAL帧                                                           │ │
│      ▼                                                                     │ │
│  PAGER_WRITER_CACHEMOD ───────────────────────────────────────────────────┤ │
│      │                                                                     │ │
│      │ 有脏页需要写入                                                      │ │
│      │                                                                     │ │
│      ▼                                                                     │ │
│  PAGER_WRITER_DBMOD ──────────────────────────────────────────────────────┤ │
│      │                                                                     │ │
│      │ sqlite3PagerCommitPhaseOne()                                       │ │
│      │ 写入所有脏页到WAL                                                   │ │
│      ▼                                                                     │ │
│  PAGER_WRITER_FINISHED ───────────────────────────────────────────────────┤ │
│      │                                                                     │ │
│      │ sqlite3PagerCommitPhaseTwo()                                       │ │
│      │ 同步并释放锁                                                        │ │
│      │                                                                     │ │
│      └─→ PAGER_READER (如果保持读事务)                                     │ │
│          或                                                                 │ │
│      └─→ PAGER_OPEN (释放所有锁)                                           │ │
│                                                                             │
│  异常路径:                                                                  │
│  ─────────                                                                 │
│  任意WRITER状态 ──→ PAGER_ERROR (发生错误)                                 │
│                         │                                                   │
│                         │ sqlite3PagerRollback()                           │
│                         │ 回滚所有修改                                      │
│                         ▼                                                   │
│                    PAGER_OPEN                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 六、程序控制流分析

### 6.1 完整SQL执行控制流

```text
SQL执行完整控制流（INSERT示例）
══════════════════════════════════════════════════════════════════════════════

用户代码:
sqlite3_exec(db, "INSERT INTO t VALUES(1,'test')", NULL, NULL, NULL);

控制流时序图:
─────────────────────────────────────────────────────────────────────────────

[应用层]                [SQLite核心]              [Pager/WAL]           [OS层]
    │                        │                        │                    │
    │ sqlite3_exec()         │                        │                    │
    │───────────────────────→│                        │                    │
    │                        │                        │                    │
    │                 sqlite3_prepare_v2()            │                    │
    │                        │ Tokenize               │                    │
    │                        │ Parse                  │                    │
    │                        │ CodeGen                │                    │
    │                        │ → VDBE字节码           │                    │
    │                        │                        │                    │
    │                 sqlite3_step()                  │                    │
    │                        │                        │                    │
    │                 OP_Init                         │                    │
    │                        │                        │                    │
    │                 OP_Transaction                  │                    │
    │                        │ sqlite3BtreeBeginTrans()                    │
    │                        │─────────────────────→│                    │
    │                        │                        │ pagerLockDb()      │
    │                        │                        │───────────────────→│
    │                        │                        │                    │ fcntl()
    │                        │                        │←───────────────────│
    │                        │                        │ SHARED锁获取       │
    │                        │←─────────────────────│                    │
    │                        │                        │                    │
    │                 OP_TableLock                    │                    │
    │                        │ 获取表写锁             │                    │
    │                        │                        │                    │
    │                 OP_OpenWrite                    │                    │
    │                        │ 打开B-Tree游标         │                    │
    │                        │                        │                    │
    │                 OP_NewRowid                     │                    │
    │                        │ 分配新rowid            │                    │
    │                        │                        │                    │
    │                 OP_MakeRecord                   │                    │
    │                        │ 构造记录               │                    │
    │                        │                        │                    │
    │                 OP_Insert                       │                    │
    │                        │ sqlite3BtreeInsert()   │                    │
    │                        │─────────────────────→│                    │
    │                        │                        │ 标记页面为脏        │
    │                        │                        │                    │
    │                        │                        │ [首次写入]          │
    │                        │                        │ pagerLockDb(RESERVED)
    │                        │                        │───────────────────→│
    │                        │                        │                    │ fcntl()
    │                        │                        │←───────────────────│
    │                        │←─────────────────────│                    │
    │                        │                        │                    │
    │                 OP_Halt / 自动提交              │                    │
    │                        │ sqlite3BtreeCommit()   │                    │
    │                        │─────────────────────→│                    │
    │                        │                        │ sqlite3WalFrames() │
    │                        │                        │───────────────────→│
    │                        │                        │                    │ write()
    │                        │                        │←───────────────────│
    │                        │                        │                    │
    │                        │                        │ sqlite3OsSync()    │
    │                        │                        │───────────────────→│
    │                        │                        │                    │ fsync()
    │                        │                        │←───────────────────│
    │                        │                        │                    │
    │                        │                        │ 释放锁              │
    │                        │                        │───────────────────→│
    │                        │                        │                    │ fcntl()
    │                        │←─────────────────────│←───────────────────│
    │                        │                        │                    │
    │ SQLITE_DONE            │                        │                    │
    │←───────────────────────│                        │                    │
    │                        │                        │                    │

执行时间分布（典型INSERT）:
─────────────────────────────────────────────────────────────────────────────
解析/编译:     ~5%    (可通过prepare缓存优化)
B-Tree操作:   ~15%    (内存操作)
WAL写入:      ~30%    (磁盘I/O)
同步(fsync):  ~50%    (最大开销，可通过NORMAL模式降低)
```

### 6.2 并发读写交互图

```text
WAL模式并发读写交互图
══════════════════════════════════════════════════════════════════════════════

时间线 ─────────────────────────────────────────────────────────────────→

Writer                    Reader1                   Reader2
  │                          │                         │
  │ BEGIN                    │                         │
  │ 获取RESERVED锁           │                         │
  ▼                          │                         │
  │                          │ BEGIN                   │
  │                          │ 获取SHARED锁            │
  │                          │ readLock = mxFrame=0    │
  │                          ▼                         │
  │ INSERT                   │                         │
  │ 修改Page1               │ SELECT                  │
  │ 写WAL Frame1            │ 从主文件读Page1         │
  │ mxFrame=1               │ (readLock=0, 看不到Frame1)
  ▼                          ▼                         │
  │                          │                         │ BEGIN
  │                          │                         │ 获取SHARED锁
  │                          │                         │ readLock = mxFrame=1
  │                          │                         ▼
  │ INSERT                   │                         │
  │ 修改Page2               │                         │ SELECT
  │ 写WAL Frame2            │                         │ 从WAL读Page1
  │ mxFrame=2               │                         │ (Frame1 <= readLock=1)
  ▼                          │                         ▼
  │ COMMIT                   │                         │
  │ 同步WAL                  │                         │
  │ 释放RESERVED锁           │                         │
  ▼                          │                         │
  │                          │ SELECT                  │
  │                          │ 仍从主文件读            │
  │                          │ (readLock=0未更新)      │
  │                          ▼                         │
  │                          │ COMMIT                  │
  │                          │ 释放SHARED锁            │
  │                          │ 更新readLock            │
  │                          ▼                         │

关键点:
─────────────────────────────────────────────────────────────────────────────
1. Writer写入WAL不阻塞Reader（Reader看快照）
2. Reader的readLock在BEGIN时固定
3. Reader在COMMIT后才能看到新数据
4. 多个Reader可以有不同的readLock（看不同快照）
```

---

## 七、数据流与版本流

### 7.1 WAL数据版本流

```text
WAL模式数据版本流可视化
══════════════════════════════════════════════════════════════════════════════

初始状态:
┌─────────────────────────────────────────────────────────────────────────────┐
│                        主数据库 (.db)                                        │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ Page1: (1, 'Alice')  │ Page2: (2, 'Bob')  │ Page3: (空)             │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────────────────┐
│                          WAL文件 (空)                                        │
└─────────────────────────────────────────────────────────────────────────────┘

事务T1: UPDATE SET name='Alice2' WHERE id=1
─────────────────────────────────────────────────────────────────────────────
┌─────────────────────────────────────────────────────────────────────────────┐
│                        主数据库 (.db) - 未变化                               │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ Page1: (1, 'Alice')  │ Page2: (2, 'Bob')  │ Page3: (空)             │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────────────────┐
│                          WAL文件                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ Frame1: Page1' = (1, 'Alice2')  [Commit=T1]                         │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘

事务T2: INSERT(3, 'Charlie')
─────────────────────────────────────────────────────────────────────────────
┌─────────────────────────────────────────────────────────────────────────────┐
│                          WAL文件                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ Frame1: Page1' = (1, 'Alice2')  [Commit=T1]                         │   │
│  │ Frame2: Page3' = (3, 'Charlie') [Commit=T2]                         │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘

读者视图 (不同时刻开始):
─────────────────────────────────────────────────────────────────────────────
Reader(readLock=0):
    Page1 → 主文件 → (1, 'Alice')
    Page3 → 主文件 → (空)

Reader(readLock=1):
    Page1 → WAL Frame1 → (1, 'Alice2')
    Page3 → 主文件 → (空)

Reader(readLock=2):
    Page1 → WAL Frame1 → (1, 'Alice2')
    Page3 → WAL Frame2 → (3, 'Charlie')

Checkpoint后:
─────────────────────────────────────────────────────────────────────────────
┌─────────────────────────────────────────────────────────────────────────────┐
│                        主数据库 (.db) - 已更新                               │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ Page1: (1, 'Alice2') │ Page2: (2, 'Bob')  │ Page3: (3, 'Charlie')  │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────────────────┐
│                          WAL文件 (已清空/截断)                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 页面生命周期

```text
页面在SQLite中的生命周期
══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│                          页面状态转换图                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌────────────┐                                                            │
│   │  磁盘页面   │                                                            │
│   │ (未缓存)   │                                                            │
│   └─────┬──────┘                                                            │
│         │ sqlite3PagerGet()                                                 │
│         │ 读取页面到缓存                                                    │
│         ▼                                                                   │
│   ┌────────────┐      sqlite3PagerWrite()      ┌────────────┐              │
│   │  干净页面   │─────────────────────────────→│  脏页面    │              │
│   │ (cached)   │                               │ (dirty)    │              │
│   └─────┬──────┘                               └─────┬──────┘              │
│         │                                            │                      │
│         │ LRU淘汰                                    │ sqlite3WalFrames()   │
│         ↓                                            │ 写入WAL              │
│   ┌────────────┐                                    │                      │
│   │  释放页面   │                                    │                      │
│   │ (evicted)  │                                    │                      │
│   └────────────┘                                    ▼                      │
│                                              ┌────────────┐                │
│                                              │ WAL中页面  │                │
│                                              │ (in WAL)   │                │
│                                              └─────┬──────┘                │
│                                                    │                       │
│                                                    │ Checkpoint            │
│                                                    │ 复制到主文件          │
│                                                    ▼                       │
│                                              ┌────────────┐                │
│                                              │ 持久化页面  │                │
│                                              │ (on disk)  │                │
│                                              └────────────┘                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

页面缓存管理 (pcache.c):
─────────────────────────────────────────────────────────────────────────────
• 默认缓存大小: 2000页 (PRAGMA cache_size)
• 淘汰策略: LRU (Least Recently Used)
• 脏页链表: 按修改顺序维护
• 页面引用计数: 防止正在使用的页面被淘汰
```

---

## 八、多视角分析

### 8.1 使用者视角

```text
    使用者视角：SQLite事务使用最佳实践
    ══════════════════════════════════════════════════════════════════════════════

    【场景1：高并发读取】
    ─────────────────────────────────────────────────────────────────────────────
    配置:
    PRAGMA journal_mode = WAL;        -- 启用WAL
    PRAGMA busy_timeout = 5000;       -- 等待5秒
    PRAGMA synchronous = NORMAL;      -- 平衡性能和安全

    代码模式:
    ```python
    # 读操作不需要显式事务
    with sqlite3.connect('data.db') as conn:
        conn.execute("PRAGMA journal_mode=WAL")
        cursor = conn.execute("SELECT * FROM large_table")
        for row in cursor:
            process(row)  # 长时间处理不阻塞写者
    ```

    【场景2：批量写入】
    ─────────────────────────────────────────────────────────────────────────────
    配置:
    PRAGMA journal_mode = WAL;
    PRAGMA synchronous = OFF;         -- 批量导入时可临时关闭
    PRAGMA cache_size = -64000;       -- 64MB缓存

    代码模式:

    ```python
    with sqlite3.connect('data.db') as conn:
        conn.execute("BEGIN IMMEDIATE")  # 立即获取写锁
        cursor = conn.cursor()
        cursor.executemany(
            "INSERT INTO t VALUES (?, ?)",
            large_dataset
        )
        conn.commit()  # 单次提交
    ```

    【场景3：金融转账（需要强一致性）】
    ─────────────────────────────────────────────────────────────────────────────
    配置:
    PRAGMA journal_mode = WAL;
    PRAGMA synchronous = FULL;        -- 完全同步
    PRAGMA foreign_keys = ON;

    代码模式:

    ```python
    def transfer(from_acc, to_acc, amount):
        with sqlite3.connect('bank.db') as conn:
            conn.execute("BEGIN EXCLUSIVE")  # 独占锁
            try:
                conn.execute("UPDATE accounts SET balance = balance - ? WHERE id = ?",
                            (amount, from_acc))
                conn.execute("UPDATE accounts SET balance = balance + ? WHERE id = ?",
                            (amount, to_acc))
                # 检查余额约束
                balance = conn.execute(
                    "SELECT balance FROM accounts WHERE id = ?", (from_acc,)
                ).fetchone()[0]
                if balance < 0:
                    raise ValueError("余额不足")
                conn.commit()
            except:
                conn.rollback()
                raise
    ```

```

### 8.2 设计者视角

```text
    设计者视角：SQLite并发控制设计决策
    ══════════════════════════════════════════════════════════════════════════════

    【设计决策1：单写者模型】
    ─────────────────────────────────────────────────────────────────────────────
    决策: 同一时刻只允许一个写事务
    理由:
    ├── 简化并发控制，无需复杂的锁管理
    ├── 避免死锁（不存在写-写冲突）
    ├── 适合SQLite的嵌入式定位（低并发写场景）
    └── 代码简洁，减少bug可能性

    权衡:
    ├── 优点: 实现简单，可靠性高
    └── 缺点: 写并发受限

    源码体现:
    // wal.c - 写锁是独占的
    if( sqlite3WalBeginWriteTransaction(pWal)==SQLITE_BUSY ){
        return SQLITE_BUSY;  // 已有写者，返回忙
    }

    【设计决策2：WAL vs 回滚日志】
    ─────────────────────────────────────────────────────────────────────────────
    决策: 支持两种模式，WAL作为默认推荐
    理由:
                        WAL模式                    回滚日志模式
    ├── 读写并发      读不阻塞写                   读写互斥
    ├── 写性能        追加写入，高效               随机写入，较慢
    ├── 文件数量      3个文件(.db,.wal,.shm)      2个文件(.db,.journal)
    ├── 网络文件系统  不支持                       支持
    └── 适用场景      本地高并发                   网络存储/兼容性

    设计哲学: 提供选择，让用户根据场景决定

    【设计决策3：校验和策略】
    ─────────────────────────────────────────────────────────────────────────────
    决策: 每个WAL帧独立校验
    理由:
    ├── 检测部分写入（扇区边界问题）
    ├── 快速定位损坏位置
    ├── 恢复时可跳过损坏帧

    实现:
    // walChecksumBytes() - 累积校验和
    s1 = s2 = 0;
    for each 32-bit word w in data:
        s1 += w + s2;
        s2 += s1;
    // 校验和存储在帧头中
```

### 8.3 程序员视角

```text
程序员视角：SQLite源码导航与调试
══════════════════════════════════════════════════════════════════════════════

【源码调试入口点】
─────────────────────────────────────────────────────────────────────────────
事务开始:
  sqlite3_exec("BEGIN")
  → sqlite3BeginTransaction() [main.c]
  → sqlite3BtreeBeginTrans() [btree.c]
  → sqlite3PagerBegin() [pager.c]

页面读取:
  SELECT → OP_Column
  → sqlite3BtreeData() [btree.c]
  → sqlite3PagerGet() [pager.c]
  → sqlite3WalFindFrame() [wal.c]  // WAL模式

事务提交:
  sqlite3_exec("COMMIT")
  → sqlite3BtreeCommit() [btree.c]
  → sqlite3PagerCommitPhaseOne() [pager.c]
  → sqlite3WalFrames() [wal.c]
  → sqlite3PagerCommitPhaseTwo() [pager.c]

【关键数据结构】
─────────────────────────────────────────────────────────────────────────────
// Pager结构 (pager.c)
struct Pager {
    sqlite3_vfs *pVfs;        // 虚拟文件系统
    u8 eState;                // 事务状态
    u8 eLock;                 // 当前锁级别
    PgHdr *pDirty;           // 脏页链表
    Wal *pWal;               // WAL连接
    // ...
};

// WAL结构 (wal.c)
struct Wal {
    sqlite3_file *pWalFd;     // WAL文件句柄
    u32 mxFrame;              // 最大帧号
    u32 readLock;             // 读锁位置
    u8 ckptLock;              // 检查点锁
    // ...
};

【调试技巧】
─────────────────────────────────────────────────────────────────────────────
1. 编译调试版本:
   ./configure --enable-debug
   make

2. 启用跟踪:
   PRAGMA vdbe_trace = ON;   -- VDBE字节码跟踪

3. 查看锁状态:
   PRAGMA lock_status;       -- 显示连接锁状态

4. WAL状态:
   PRAGMA wal_checkpoint;    -- 返回WAL状态
```

### 8.4 数据转换视角

```text
数据转换视角：SQLite数据在各层的表示
══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│                        数据表示层次转换                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  SQL层:     INSERT INTO users VALUES (1, 'Alice', 25);                     │
│                              │                                              │
│                              ▼                                              │
│  VDBE层:    OP_MakeRecord                                                  │
│             Record = [header_size | type1 | type2 | type3 | data...]      │
│             = [04 | 01 | 17 | 01 | 01 | 'Alice' | 19]                      │
│             类型: 1=int8, 17=text(len=(17-13)/2=2*5+1), 19=int8            │
│                              │                                              │
│                              ▼                                              │
│  B-Tree层:  Cell = [payload_size | rowid | record]                         │
│             叶子页面中的一个Cell                                            │
│                              │                                              │
│                              ▼                                              │
│  Page层:    4096字节页面                                                    │
│             [页头 | Cell指针数组 | 空闲空间 | Cell内容区]                   │
│                              │                                              │
│                              ▼                                              │
│  WAL层:     WAL帧 = [帧头(24B) | 页面数据(4096B)]                           │
│             帧头包含页号、校验和等                                          │
│                              │                                              │
│                              ▼                                              │
│  文件层:    .db-wal文件中的连续字节                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

Record格式详解 (record.c):
─────────────────────────────────────────────────────────────────────────────
类型编码:
  0: NULL
  1: 8-bit signed integer
  2: 16-bit big-endian integer
  3: 24-bit big-endian integer
  4: 32-bit big-endian integer
  5: 48-bit big-endian integer
  6: 64-bit big-endian integer
  7: IEEE 754 double
  8: integer 0
  9: integer 1
  >= 12 even: BLOB of size (N-12)/2
  >= 13 odd: TEXT of size (N-13)/2
```

---

## 九、形式化证明

### 9.1 WAL快照隔离正确性证明

```text
    定理: SQLite WAL模式实现快照隔离
    ══════════════════════════════════════════════════════════════════════════════

    定义:
    ─────
    设 T 为事务集合
    设 R(T).readLock 为事务T的读锁位置（开始时的mxFrame）
    设 W(T).commitFrame 为事务T的提交帧号
    设 Page(pgno, frame) 为帧frame中页号pgno的内容

    快照隔离性质:
    1. 事务T读取的是T开始时刻的一致快照
    2. 写冲突时先提交者胜出

    证明:
    ─────

    【性质1: 快照一致性】

    引理1: 读取函数返回一致快照

    证明:
    设事务T在时刻t开始，此时mxFrame = n
    则 R(T).readLock = n

    对于任意页面pgno，Read(T, pgno)执行:
    ```c
    iFrame = sqlite3WalFindFrame(pWal, pgno);
    if( iFrame > 0 && iFrame <= R(T).readLock ){
        // 从WAL读取
        return Page(pgno, iFrame);
    } else {
        // 从主数据库读取
        return Page(pgno, 主文件);
    }
    ```

    由于:

    1. R(T).readLock在T生命周期内不变
    2. 只返回frame <= readLock的版本
    3. 主文件内容在Checkpoint前不变

    ∴ T看到的是开始时刻的一致视图 □

    【性质2: 写隔离】

    引理2: 单写者保证写隔离

    证明:

    - WAL写锁是独占的: walLockExclusive(WAL_WRITE_LOCK)
    - 同时只有一个事务可以持有写锁
    - 写事务按提交顺序分配commitFrame
    - 读事务的readLock不受写事务影响

    ∴ 写冲突不存在（单写者模型）□

    【综合证明】

    由引理1和引理2:

    - 每个读事务看到一致快照（引理1）
    - 写事务之间不冲突（引理2）
    - 读事务不受并发写影响（readLock机制）

    ∴ SQLite WAL模式满足快照隔离 □

```

### 9.2 WAL崩溃恢复正确性证明

```text
    定理: SQLite WAL崩溃恢复保证原子性
    ══════════════════════════════════════════════════════════════════════════════

    定义:
    ─────
    设 WAL = [F₁, F₂, ..., Fₙ] 为WAL帧序列
    设 Commit(Fᵢ) = true 当且仅当 Fᵢ 是提交帧（db_size > 0）
    设 Valid(Fᵢ) = true 当且仅当 Fᵢ 的校验和正确

    恢复算法:
    ─────
    ```c
    int walRecovery(Wal *pWal){
        u32 mxFrame = 0;
        u32 mxPage = 0;

        for(每个帧F in WAL){
            if( !Valid(F) ){
                break;  // 遇到无效帧，停止
            }
            if( Commit(F) ){
                mxFrame = F.frameNumber;
                mxPage = F.db_size;  // 记录最后有效提交点
            }
        }

        // 恢复到mxFrame指示的状态
        pWal->mxFrame = mxFrame;
        pWal->dbSize = mxPage;
        return SQLITE_OK;
    }
    ```

    证明:
    ─────

    【原子性保证】

    引理3: 恢复后数据库处于某个已提交事务的状态

    证明:

    1. WAL帧按顺序写入
    2. 每个帧有独立校验和
    3. 提交帧标记事务边界（db_size > 0）

    恢复时:

    - 扫描WAL直到遇到无效帧或文件结束
    - 记录最后一个有效提交帧的位置
    - 忽略提交帧之后的未提交帧

    场景分析:
    Case 1: 崩溃发生在帧写入之前
    → WAL不变，恢复到上一个提交点

    Case 2: 崩溃发生在帧写入过程中
    → 校验和验证失败，该帧被忽略
    → 恢复到上一个提交点

    Case 3: 崩溃发生在提交帧写入之后，fsync之前
    → 如果帧完整写入，fsync后生效
    → 如果帧不完整，校验和失败，忽略

    ∴ 恢复后数据库处于最后一个完整提交的事务状态 □

    【持久性保证】

    引理4: 已同步的提交事务持久化

    证明:

    - 提交时调用 sqlite3OsSync(pWal->pWalFd)
    - fsync()保证数据到达磁盘
    - 恢复时该提交帧必然有效

    ∴ 已同步提交的事务不会丢失 □

    综合引理3和引理4: WAL崩溃恢复保证ACID的原子性和持久性 □

```

---

## 十、设计权衡与决策

### 10.1 设计决策树

```text
SQLite并发控制设计决策树
══════════════════════════════════════════════════════════════════════════════

[SQLite使用场景?]
    │
    ├─→ 嵌入式/单用户
    │     │
    │     └─→ [需要网络文件系统?]
    │           │YES           │NO
    │           ▼              ▼
    │     DELETE模式       WAL模式
    │     (兼容性)         (性能)
    │
    ├─→ 多读者并发
    │     │
    │     └─→ WAL模式
    │         PRAGMA journal_mode = WAL;
    │         │
    │         └─→ [写入频率?]
    │               │低          │高
    │               ▼            ▼
    │         auto-checkpoint  手动checkpoint
    │                          定时执行
    │
    └─→ 高写入吞吐
          │
          └─→ [数据安全要求?]
                │高            │低
                ▼              ▼
          synchronous=FULL   synchronous=OFF
          (每次fsync)        (批量提交)

检查点策略决策:
─────────────────────────────────────────────────────────────────────────────
[WAL文件增长可接受?]
    │YES            │NO
    ▼               ▼
auto-checkpoint   [读者可能长时间活跃?]
(默认1000页)         │YES          │NO
                     ▼              ▼
                PASSIVE模式     TRUNCATE模式
                (不等待读者)    (等待并截断)
```

### 10.2 性能权衡矩阵

```text
SQLite配置性能权衡矩阵
══════════════════════════════════════════════════════════════════════════════

┌─────────────────────┬────────────┬────────────┬────────────┬────────────────┐
│ 配置选项             │ 写性能     │ 读性能      │ 安全性     │ 适用场景        │
├─────────────────────┼────────────┼────────────┼────────────┼────────────────┤
│ journal_mode=DELETE │ ★★☆☆☆   │ ★★★☆☆    │ ★★★★★    │ 网络存储       │
│ synchronous=FULL    │            │            │            │ 兼容性要求      │
├─────────────────────┼────────────┼────────────┼────────────┼────────────────┤
│ journal_mode=WAL    │ ★★★★☆   │ ★★★★★    │ ★★★★★   │ 本地高并发      │
│ synchronous=FULL    │            │            │            │ 金融应用        │
├─────────────────────┼────────────┼────────────┼────────────┼────────────────┤
│ journal_mode=WAL    │ ★★★★★   │ ★★★★★    │ ★★★★☆   │ 一般应用        │
│ synchronous=NORMAL  │            │            │            │ 推荐配置        │
├─────────────────────┼────────────┼────────────┼────────────┼────────────────┤
│ journal_mode=WAL    │ ★★★★★   │ ★★★★★    │ ★★☆☆☆   │ 批量导入        │
│ synchronous=OFF     │            │            │            │ 临时数据        │
├─────────────────────┼────────────┼────────────┼────────────┼────────────────┤
│ journal_mode=MEMORY │ ★★★★★   │ ★★★★★    │ ★☆☆☆☆   │ 测试/临时       │
│                     │            │            │            │ 可丢失数据      │
└─────────────────────┴────────────┴────────────┴────────────┴────────────────┘

cache_size影响:
─────────────────────────────────────────────────────────────────────────────
┌─────────────────┬────────────────────────────────────────────────────────────┐
│ cache_size      │ 效果                                                       │
├─────────────────┼────────────────────────────────────────────────────────────┤
│ -2000 (默认)    │ 约8MB，适合一般应用                                          │
│ -64000          │ 约256MB，大数据集/复杂查询                                   │
│ -256000         │ 约1GB，数据仓库/分析场景                                     │
└─────────────────┴────────────────────────────────────────────────────────────┘
```

---

## 相关资源

### 相关文档

- [01.02-事务与并发控制](./01.02-事务与并发控制.md) - 基础事务理论
- [06.04-WAL模式形式化验证](../06-形式化理论/06.04-WAL模式形式化验证.md) - TLA+规范
- [11.04-并发控制理论](../11-理论模型/11.04-并发控制理论.md) - 理论模型

### 外部资源

- [SQLite源码](https://sqlite.org/src/doc/trunk/README.md)
- [SQLite WAL模式文档](https://sqlite.org/wal.html)
- [SQLite文件格式](https://sqlite.org/fileformat.html)
- [SQLite锁机制](https://sqlite.org/lockingv3.html)

---

**维护者**: SQLite Knowledge Team
**最后更新**: 2025-12-01
