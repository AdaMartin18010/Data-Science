# äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶ï¼šMVCCä¸WALæœºåˆ¶æ·±åº¦è®ºè¯

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-11-13
> **æœ€åæ›´æ–°**ï¼š2025-01-15
> **ç‰ˆæœ¬**ï¼šSQLite 3.31+ è‡³ 3.47.x

---

## 1. ğŸ“‹ æ¦‚è¿°

SQLite3é€šè¿‡é”å’Œæ—¥å¿—å®ç°äº‹åŠ¡éš”ç¦»ï¼Œå…¶MVCCè®¾è®¡å…·æœ‰è¯»ä¸é˜»å¡å†™çš„ç‹¬ç‰¹ä¼˜åŠ¿ã€‚
æœ¬æ–‡æ¡£æ·±å…¥è§£æäº‹åŠ¡éš”ç¦»çº§åˆ«ã€WALæ¨¡å¼å’Œå¹¶å‘æ§åˆ¶æœºåˆ¶ã€‚

---

## 2. ğŸ“‘ ç›®å½•

- [äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶ï¼šMVCCä¸WALæœºåˆ¶æ·±åº¦è®ºè¯](#äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶mvccä¸walæœºåˆ¶æ·±åº¦è®ºè¯)
  - [1. ğŸ“‹ æ¦‚è¿°](#1--æ¦‚è¿°)
  - [2. ğŸ“‘ ç›®å½•](#2--ç›®å½•)
  - [3. ğŸ“Š æ€ç»´å¯¼å›¾](#3--æ€ç»´å¯¼å›¾)
  - [4. ğŸ“Š å¤šç»´æ¦‚å¿µçŸ©é˜µå¯¹æ¯”](#4--å¤šç»´æ¦‚å¿µçŸ©é˜µå¯¹æ¯”)
    - [4.1. äº‹åŠ¡éš”ç¦»çº§åˆ«å¯¹æ¯”çŸ©é˜µ](#41-äº‹åŠ¡éš”ç¦»çº§åˆ«å¯¹æ¯”çŸ©é˜µ)
    - [4.2. WALæ¨¡å¼å¯¹æ¯”çŸ©é˜µ](#42-walæ¨¡å¼å¯¹æ¯”çŸ©é˜µ)
    - [4.3. é”ç±»å‹å¯¹æ¯”çŸ©é˜µ](#43-é”ç±»å‹å¯¹æ¯”çŸ©é˜µ)
  - [5. ğŸŒ Wikipediaå¯¹é½](#5--wikipediaå¯¹é½)
    - [5.1. MVCCæ¦‚å¿µå¯¹é½](#51-mvccæ¦‚å¿µå¯¹é½)
    - [5.2. WALæ¦‚å¿µå¯¹é½](#52-walæ¦‚å¿µå¯¹é½)
    - [5.3. ACIDæ¦‚å¿µå¯¹é½](#53-acidæ¦‚å¿µå¯¹é½)
  - [5.5. å½¢å¼åŒ–å®šä¹‰](#55-å½¢å¼åŒ–å®šä¹‰)
    - [5.5.1. äº‹åŠ¡å½¢å¼åŒ–å®šä¹‰](#551-äº‹åŠ¡å½¢å¼åŒ–å®šä¹‰)
    - [5.5.2. é”æœºåˆ¶å½¢å¼åŒ–å®šä¹‰](#552-é”æœºåˆ¶å½¢å¼åŒ–å®šä¹‰)
    - [5.5.3. WALæœºåˆ¶å½¢å¼åŒ–å®šä¹‰](#553-walæœºåˆ¶å½¢å¼åŒ–å®šä¹‰)
    - [5.5.4. å¹¶å‘æ§åˆ¶å½¢å¼åŒ–å®šä¹‰](#554-å¹¶å‘æ§åˆ¶å½¢å¼åŒ–å®šä¹‰)
    - [5.5.5. å½¢å¼åŒ–å®šç†](#555-å½¢å¼åŒ–å®šç†)
    - [5.5.6. å½¢å¼åŒ–éªŒè¯](#556-å½¢å¼åŒ–éªŒè¯)
  - [6. äº‹åŠ¡éš”ç¦»çº§åˆ«å®ç°](#6-äº‹åŠ¡éš”ç¦»çº§åˆ«å®ç°)
    - [6.1. éš”ç¦»çº§åˆ«æ¦‚è§ˆ](#61-éš”ç¦»çº§åˆ«æ¦‚è§ˆ)
    - [6.2. å¿«ç…§éš”ç¦»ï¼ˆSnapshot Isolationï¼‰å®ç°](#62-å¿«ç…§éš”ç¦»snapshot-isolationå®ç°)
    - [6.3. éš”ç¦»çº§åˆ«å¯¹æ¯”](#63-éš”ç¦»çº§åˆ«å¯¹æ¯”)
  - [7. WALæ¨¡å¼ï¼ˆWrite-Ahead Loggingï¼‰çš„æŠ€æœ¯çªç ´](#7-walæ¨¡å¼write-ahead-loggingçš„æŠ€æœ¯çªç ´)
    - [7.1. ä¼ ç»Ÿå›æ»šæ—¥å¿—æ¨¡å¼ï¼ˆDELETEæ¨¡å¼ï¼‰çš„é—®é¢˜](#71-ä¼ ç»Ÿå›æ»šæ—¥å¿—æ¨¡å¼deleteæ¨¡å¼çš„é—®é¢˜)
    - [7.2. WALæ¨¡å¼çš„ä¼˜åŠ¿](#72-walæ¨¡å¼çš„ä¼˜åŠ¿)
    - [7.3. WALæ–‡ä»¶ç»“æ„](#73-walæ–‡ä»¶ç»“æ„)
    - [7.4. WALæ¨¡å¼é…ç½®](#74-walæ¨¡å¼é…ç½®)
    - [7.5. WALæ¨¡å¼çš„æŠ€æœ¯æƒè¡¡](#75-walæ¨¡å¼çš„æŠ€æœ¯æƒè¡¡)
  - [8. é”æœºåˆ¶è¯¦è§£](#8-é”æœºåˆ¶è¯¦è§£)
    - [8.1. äº”ç§é”çŠ¶æ€](#81-äº”ç§é”çŠ¶æ€)
    - [8.2. é”å‡çº§è·¯å¾„](#82-é”å‡çº§è·¯å¾„)
    - [8.3. æ­»é”é¢„é˜²](#83-æ­»é”é¢„é˜²)
  - [9. å¹¶å‘æ§åˆ¶æ€§èƒ½åˆ†æ](#9-å¹¶å‘æ§åˆ¶æ€§èƒ½åˆ†æ)
    - [9.1. å¹¶å‘æ¨¡å‹å¯¹æ¯”](#91-å¹¶å‘æ¨¡å‹å¯¹æ¯”)
    - [9.2. æ€§èƒ½æµ‹è¯•æ•°æ®ä¸ä»£ç ç¤ºä¾‹](#92-æ€§èƒ½æµ‹è¯•æ•°æ®ä¸ä»£ç ç¤ºä¾‹)
  - [10. æœ€ä½³å®è·µä¸ä»£ç ç¤ºä¾‹](#10-æœ€ä½³å®è·µä¸ä»£ç ç¤ºä¾‹)
    - [10.1. é€‰æ‹©DELETEæ¨¡å¼](#101-é€‰æ‹©deleteæ¨¡å¼)
  - [11. é€‰æ‹©WALæ¨¡å¼](#11-é€‰æ‹©walæ¨¡å¼)
  - [12. å®é™…æ¡ˆä¾‹ï¼šGitLab CIä¸­çš„SQLiteä½¿ç”¨](#12-å®é™…æ¡ˆä¾‹gitlab-ciä¸­çš„sqliteä½¿ç”¨)
  - [13. äº‹åŠ¡éš”ç¦»ä¸ä¸€è‡´æ€§ä¿è¯](#13-äº‹åŠ¡éš”ç¦»ä¸ä¸€è‡´æ€§ä¿è¯)
    - [13.1. ACIDç‰¹æ€§å®ç°](#131-acidç‰¹æ€§å®ç°)
    - [13.2. å´©æºƒæ¢å¤æœºåˆ¶](#132-å´©æºƒæ¢å¤æœºåˆ¶)
  - [14. ğŸ”— ç›¸å…³èµ„æº](#14--ç›¸å…³èµ„æº)
  - [15. ğŸ“š å‚è€ƒèµ„æ–™](#15--å‚è€ƒèµ„æ–™)
  - [16. ğŸ”— äº¤å‰å¼•ç”¨](#16--äº¤å‰å¼•ç”¨)
    - [16.1. ç›¸å…³æ–‡æ¡£](#161-ç›¸å…³æ–‡æ¡£)
      - [16.1.1. æ ¸å¿ƒæ¶æ„](#1611-æ ¸å¿ƒæ¶æ„)
      - [16.1.2. æ€§èƒ½ä¼˜åŒ–](#1612-æ€§èƒ½ä¼˜åŒ–)
      - [16.1.3. ç¼–ç¨‹å®è·µ](#1613-ç¼–ç¨‹å®è·µ)
      - [16.1.4. å½¢å¼åŒ–ç†è®º](#1614-å½¢å¼åŒ–ç†è®º)
      - [16.1.5. ç†è®ºæ¨¡å‹ ğŸ†•](#1615-ç†è®ºæ¨¡å‹-)
      - [16.1.6. è®¾è®¡æ¨¡å‹ ğŸ†•](#1616-è®¾è®¡æ¨¡å‹-)

---

## 3. ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶))
    äº‹åŠ¡éš”ç¦»çº§åˆ«
      READ UNCOMMITTED
        ç›´æ¥è¯»å–
        è„è¯»å¯èƒ½
      READ COMMITTED
        é»˜è®¤çº§åˆ«
        å¿«ç…§éš”ç¦»
      REPEATABLE READ
        äº‹åŠ¡å¿«ç…§
        å¯é‡å¤è¯»
      SERIALIZABLE
        ä¸¥æ ¼é”
        æœ€é«˜éš”ç¦»
    WALæ¨¡å¼
      WALä¼˜åŠ¿
        è¯»ä¸é˜»å¡å†™
        å¹¶å‘æ€§èƒ½
        å´©æºƒæ¢å¤
      WALæ–‡ä»¶ç»“æ„
        WALå¤´éƒ¨
        WALå¸§
        æ£€æŸ¥ç‚¹
      WALé…ç½®
        WALæ¨¡å¼å¯ç”¨
        æ£€æŸ¥ç‚¹ç­–ç•¥
        WALå¤§å°é™åˆ¶
    é”æœºåˆ¶
      é”çŠ¶æ€
        UNLOCKED
        SHARED
        RESERVED
        PENDING
        EXCLUSIVE
      é”å‡çº§
        é”å‡çº§è·¯å¾„
        æ­»é”é¢„é˜²
        è¶…æ—¶æœºåˆ¶
    å¹¶å‘æ§åˆ¶
      è¯»å¹¶å‘
        å¤šè¯»å•å†™
        å¿«ç…§éš”ç¦»
      å†™å¹¶å‘
        å†™é”äº’æ–¥
        äº‹åŠ¡é˜Ÿåˆ—
      æ€§èƒ½åˆ†æ
        å¹¶å‘æ¨¡å‹å¯¹æ¯”
        æ€§èƒ½æµ‹è¯•
        æœ€ä½³å®è·µ
    ACIDç‰¹æ€§
      åŸå­æ€§
        äº‹åŠ¡åŸå­æ€§
        æ“ä½œåŸå­æ€§
      ä¸€è‡´æ€§
        çº¦æŸæ£€æŸ¥
        å®Œæ•´æ€§ä¿è¯
      éš”ç¦»æ€§
        éš”ç¦»çº§åˆ«
        å¹¶å‘æ§åˆ¶
      æŒä¹…æ€§
        WALä¿è¯
        ç£ç›˜åˆ·æ–°
```

---

## 4. ğŸ“Š å¤šç»´æ¦‚å¿µçŸ©é˜µå¯¹æ¯”

### 4.1. äº‹åŠ¡éš”ç¦»çº§åˆ«å¯¹æ¯”çŸ©é˜µ

| éš”ç¦»çº§åˆ« | è„è¯» | ä¸å¯é‡å¤è¯» | å¹»è¯» | æ€§èƒ½ | å¹¶å‘æ€§ | SQLiteå®ç° |
|---------|------|-----------|------|------|--------|-----------|
| **READ UNCOMMITTED** | å¯èƒ½ | å¯èƒ½ | å¯èƒ½ | æœ€é«˜ | æœ€é«˜ | âœ… æ”¯æŒï¼ˆä¸æ¨èï¼‰ |
| **READ COMMITTED** | ä¸å¯èƒ½ | å¯èƒ½ | å¯èƒ½ | é«˜ | é«˜ | âœ… é»˜è®¤çº§åˆ« |
| **REPEATABLE READ** | ä¸å¯èƒ½ | ä¸å¯èƒ½ | å¯èƒ½ | ä¸­ | ä¸­ | âœ… æ”¯æŒ |
| **SERIALIZABLE** | ä¸å¯èƒ½ | ä¸å¯èƒ½ | ä¸å¯èƒ½ | ä½ | ä½ | âœ… æ”¯æŒ |

### 4.2. WALæ¨¡å¼å¯¹æ¯”çŸ©é˜µ

| æ—¥å¿—æ¨¡å¼ | è¯»æ€§èƒ½ | å†™æ€§èƒ½ | å¹¶å‘æ€§ | æ¢å¤é€Ÿåº¦ | é€‚ç”¨åœºæ™¯ | SQLiteæ”¯æŒ |
|---------|--------|--------|--------|---------|---------|-----------|
| **DELETEæ¨¡å¼** | ä¸­ | ä¸­ | ä½ | æ…¢ | ä¼ ç»Ÿåœºæ™¯ | âœ… é»˜è®¤æ¨¡å¼ |
| **WALæ¨¡å¼** | é«˜ | é«˜ | é«˜ | å¿« | é«˜å¹¶å‘ | âœ… æ¨èæ¨¡å¼ |
| **MEMORYæ¨¡å¼** | å¾ˆé«˜ | å¾ˆé«˜ | å¾ˆé«˜ | N/A | ä¸´æ—¶æ•°æ® | âœ… æ”¯æŒ |

### 4.3. é”ç±»å‹å¯¹æ¯”çŸ©é˜µ

| é”ç±»å‹ | è¯»è®¿é—® | å†™è®¿é—® | å‡çº§æ€§ | é˜»å¡æ€§ | é€‚ç”¨åœºæ™¯ | SQLiteæ”¯æŒ |
|--------|--------|--------|--------|--------|---------|-----------|
| **UNLOCKED** | å…è®¸ | å…è®¸ | æ˜¯ | æ—  | ç©ºé—²çŠ¶æ€ | âœ… æ”¯æŒ |
| **SHARED** | å…è®¸ | ä¸å…è®¸ | æ˜¯ | ä½ | è¯»æ“ä½œ | âœ… æ”¯æŒ |
| **RESERVED** | å…è®¸ | å‡†å¤‡ | æ˜¯ | ä¸­ | å†™å‡†å¤‡ | âœ… æ”¯æŒ |
| **PENDING** | ä¸å…è®¸ | ç­‰å¾… | æ˜¯ | é«˜ | å†™ç­‰å¾… | âœ… æ”¯æŒ |
| **EXCLUSIVE** | ä¸å…è®¸ | å…è®¸ | å¦ | æœ€é«˜ | å†™æ“ä½œ | âœ… æ”¯æŒ |

---

## 5. ğŸŒ Wikipediaå¯¹é½

### 5.1. MVCCæ¦‚å¿µå¯¹é½

**Wikipediaå®šä¹‰**: [Multiversion concurrency control](https://en.wikipedia.org/wiki/Multiversion_concurrency_control)

> Multiversion concurrency control (MVCC) is a concurrency control method commonly used by database management systems to provide concurrent access to the database and in programming languages to implement transactional memory.

**å¯¹é½è¯´æ˜**:

- âœ… **å®šä¹‰ä¸€è‡´æ€§**: æœ¬æ–‡æ¡£çš„å®šä¹‰ä¸Wikipediaä¸€è‡´ï¼Œéƒ½å¼ºè°ƒMVCCæ˜¯æä¾›å¹¶å‘è®¿é—®çš„å¹¶å‘æ§åˆ¶æ–¹æ³•
- âœ… **æ ¸å¿ƒç‰¹æ€§**: éƒ½æåˆ°å¤šç‰ˆæœ¬ã€å¿«ç…§éš”ç¦»ç­‰æ ¸å¿ƒç‰¹æ€§
- âœ… **åº”ç”¨åœºæ™¯**: éƒ½æåˆ°æ•°æ®åº“å¹¶å‘æ§åˆ¶ã€äº‹åŠ¡éš”ç¦»ç­‰åº”ç”¨åœºæ™¯

### 5.2. WALæ¦‚å¿µå¯¹é½

**Wikipediaå®šä¹‰**: [Write-ahead logging](https://en.wikipedia.org/wiki/Write-ahead_logging)

> Write-ahead logging (WAL) is a family of techniques for providing atomicity and durability in database systems.

**å¯¹é½è¯´æ˜**:

- âœ… **å®šä¹‰ä¸€è‡´æ€§**: æœ¬æ–‡æ¡£çš„å®šä¹‰ä¸Wikipediaä¸€è‡´ï¼Œéƒ½å¼ºè°ƒWALæ˜¯æä¾›åŸå­æ€§å’ŒæŒä¹…æ€§çš„æŠ€æœ¯
- âœ… **æ ¸å¿ƒæœºåˆ¶**: éƒ½æåˆ°å…ˆå†™æ—¥å¿—ã€åå†™æ•°æ®çš„æœºåˆ¶
- âœ… **åº”ç”¨åœºæ™¯**: éƒ½æåˆ°æ•°æ®åº“äº‹åŠ¡ã€å´©æºƒæ¢å¤ç­‰åº”ç”¨åœºæ™¯

### 5.3. ACIDæ¦‚å¿µå¯¹é½

**Wikipediaå®šä¹‰**: [ACID](https://en.wikipedia.org/wiki/ACID)

> ACID is a set of properties of database transactions intended to guarantee data validity despite errors, power failures, and other mishaps.

**å¯¹é½è¯´æ˜**:

- âœ… **å®šä¹‰ä¸€è‡´æ€§**: æœ¬æ–‡æ¡£çš„å®šä¹‰ä¸Wikipediaä¸€è‡´ï¼Œéƒ½å¼ºè°ƒACIDæ˜¯æ•°æ®åº“äº‹åŠ¡çš„å±æ€§é›†åˆ
- âœ… **æ ¸å¿ƒç‰¹æ€§**: éƒ½æåˆ°åŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§
- âœ… **å®ç°æ–¹å¼**: SQLiteé€šè¿‡WALå’Œé”æœºåˆ¶å®ç°ACIDç‰¹æ€§

---

## 5.5. å½¢å¼åŒ–å®šä¹‰

### 5.5.1. äº‹åŠ¡å½¢å¼åŒ–å®šä¹‰

```text
å®šä¹‰5.5.1 äº‹åŠ¡ï¼ˆTransactionï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

äº‹åŠ¡ T = (ops, <, state, txn_id)
  å…¶ä¸­:
  â€¢ ops: æ“ä½œåºåˆ— {r(x), w(x), commit, abort}
  â€¢ <: happens-beforeå…³ç³»ï¼ˆååºï¼‰
  â€¢ state: äº‹åŠ¡çŠ¶æ€ âˆˆ {BEGIN, ACTIVE, COMMITTING, COMMITTED, ABORTING, ABORTED}
  â€¢ txn_id: äº‹åŠ¡å”¯ä¸€æ ‡è¯†ç¬¦

æ“ä½œç±»å‹:
â€¢ r_i(x): äº‹åŠ¡T_iè¯»å–æ•°æ®é¡¹x
â€¢ w_i(x, v): äº‹åŠ¡T_iå†™å…¥æ•°æ®é¡¹xï¼Œå€¼ä¸ºv
â€¢ c_i: äº‹åŠ¡T_iæäº¤
â€¢ a_i: äº‹åŠ¡T_iä¸­æ­¢

äº‹åŠ¡æ€§è´¨:
â€¢ åŸå­æ€§: âˆ€T: (Commit(T) â†’ âˆ€op âˆˆ T.ops: Applied(op)) âˆ§
           (Abort(T) â†’ âˆ€op âˆˆ T.ops: RolledBack(op))
â€¢ ä¸€è‡´æ€§: âˆ€T: ConsistentBefore(T) â‡’ ConsistentAfter(Commit(T))
â€¢ éš”ç¦»æ€§: âˆ€Tâ‚, Tâ‚‚: (Tâ‚ â‰  Tâ‚‚) â‡’ Isolated(Tâ‚, Tâ‚‚)
â€¢ æŒä¹…æ€§: âˆ€T: (Commit(T) â‡’ Persistent(T))
```

### 5.5.2. é”æœºåˆ¶å½¢å¼åŒ–å®šä¹‰

```text
å®šä¹‰5.5.2 é”çŠ¶æ€ï¼ˆLock Stateï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

é”çŠ¶æ€ L âˆˆ {UNLOCKED, SHARED, RESERVED, PENDING, EXCLUSIVE}

é”çŠ¶æ€æœº:
  UNLOCKED â”€â”€readâ”€â”€> SHARED
  SHARED â”€â”€writeâ”€â”€> RESERVED
  RESERVED â”€â”€commitâ”€â”€> PENDING
  PENDING â”€â”€exclusiveâ”€â”€> EXCLUSIVE
  EXCLUSIVE â”€â”€releaseâ”€â”€> UNLOCKED

é”å…¼å®¹æ€§çŸ©é˜µ:
            UNLOCKED  SHARED  RESERVED  PENDING  EXCLUSIVE
UNLOCKED      âœ“        âœ“        âœ“        âœ“        âœ“
SHARED        âœ“        âœ“        âœ“        âœ—        âœ—
RESERVED      âœ“        âœ“        âœ—        âœ—        âœ—
PENDING       âœ“        âœ—        âœ—        âœ—        âœ—
EXCLUSIVE     âœ“        âœ—        âœ—        âœ—        âœ—

å½¢å¼åŒ–è¡¨ç¤º:
  Compatible(Lâ‚, Lâ‚‚) =
    if (Lâ‚ = UNLOCKED âˆ¨ Lâ‚‚ = UNLOCKED) then true
    else if (Lâ‚ = SHARED âˆ§ Lâ‚‚ = SHARED) then true
    else if (Lâ‚ = SHARED âˆ§ Lâ‚‚ = RESERVED) then true
    else false

é”è·å–æ“ä½œ:
  Acquire(T, r, lock_type):
    if Compatible(CurrentLock(r), lock_type):
      LockTable(r) = (lock_type, T)
      return SUCCESS
    else:
      Enqueue(LockQueue(r), T)
      return WAIT

é”é‡Šæ”¾æ“ä½œ:
  Release(T, r):
    LockTable(r) = UNLOCKED
    if LockQueue(r) â‰  âˆ…:
      T' = Dequeue(LockQueue(r))
      Acquire(T', r, T'.requested_lock_type)
```

### 5.5.3. WALæœºåˆ¶å½¢å¼åŒ–å®šä¹‰

```text
å®šä¹‰5.5.3 WALå¿«ç…§ï¼ˆWAL Snapshotï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

å¿«ç…§ S = (WAL, frame_number, txn_id)
  å…¶ä¸­:
  â€¢ WAL: WALå¸§åºåˆ— [Frameâ‚, Frameâ‚‚, ..., Frameâ‚™]
  â€¢ frame_number: å¿«ç…§å¯¹åº”çš„WALå¸§å·
  â€¢ txn_id: åˆ›å»ºå¿«ç…§çš„äº‹åŠ¡ID

WALå¸§:
  Frame = (page_id, old_value, new_value, txn_id, frame_number)

WALé¡ºåºå…¬ç†:
  âˆ€fâ‚, fâ‚‚ âˆˆ WAL: (fâ‚.frame_number < fâ‚‚.frame_number) â‡’
                 (fâ‚.written_before(fâ‚‚))

å¿«ç…§ä¸€è‡´æ€§:
  âˆ€T: Snapshot(T) = ConsistentState(DB, T.snapshot_frame_number)

è¯»å–æ“ä½œ:
  Read(T, x, snapshot):
    return snapshot.WAL[LastFrame(x, snapshot.frame_number)].new_value

å†™å…¥æ“ä½œ:
  Write(T, x, v):
    frame = (x, CurrentValue(x), v, T.txn_id, NextFrameNumber())
    AppendFrame(WAL, frame)
```

### 5.5.4. å¹¶å‘æ§åˆ¶å½¢å¼åŒ–å®šä¹‰

```text
å®šä¹‰5.5.4 å¹¶å‘å†å²ï¼ˆConcurrent Historyï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

å¹¶å‘å†å² H = (â‹ƒáµ¢ opsáµ¢, <_H)
  å…¶ä¸­:
  â€¢ opsáµ¢: äº‹åŠ¡Táµ¢çš„æ“ä½œé›†åˆ
  â€¢ <_H: å…¨å±€happens-beforeå…³ç³»

å†²çªæ“ä½œ:
  Conflict(opâ‚, opâ‚‚) âŸº
    (opâ‚ â‰  opâ‚‚) âˆ§
    (âˆƒ x: {opâ‚, opâ‚‚} âŠ† {r(x), w(x)}) âˆ§
    (w(x) âˆˆ {opâ‚, opâ‚‚})

å¯ä¸²è¡ŒåŒ–:
  Serializable(H) âŸº âˆƒä¸²è¡Œå†å²S: H â‰¡_conflict S

å¿«ç…§éš”ç¦»:
  SnapshotIsolation(H) âŸº
    âˆ€Táµ¢: (âˆ€ráµ¢(x) âˆˆ Táµ¢: ReadFromSnapshot(ráµ¢(x), Snapshot(Táµ¢))) âˆ§
         (âˆ€wáµ¢(x) âˆˆ Táµ¢: WriteToWAL(wáµ¢(x)))

æ­»é”æ£€æµ‹:
  Deadlock(H) âŸº âˆƒå¾ªç¯ç­‰å¾…é“¾: Tâ‚ â†’ Tâ‚‚ â†’ ... â†’ Tâ‚™ â†’ Tâ‚
```

### 5.5.5. å½¢å¼åŒ–å®šç†

```text
å®šç†5.5.1 äº‹åŠ¡åŸå­æ€§
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âˆ€T: Atomic(T) â‡” (Commit(T) âˆ¨ Abort(T))

è¯æ˜:
  1. ç”±äº‹åŠ¡å®šä¹‰ï¼Œäº‹åŠ¡è¦ä¹ˆæäº¤è¦ä¹ˆä¸­æ­¢
  2. æäº¤æ—¶æ‰€æœ‰æ“ä½œåº”ç”¨ï¼Œä¸­æ­¢æ—¶æ‰€æœ‰æ“ä½œå›æ»š
  3. å› æ­¤äº‹åŠ¡æ˜¯åŸå­çš„
  âˆ

å®šç†5.5.2 é”äº’æ–¥æ€§
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âˆ€r, âˆ€Tâ‚â‰ Tâ‚‚: Â¬(HasLock(Tâ‚, r, EXCLUSIVE) âˆ§ HasLock(Tâ‚‚, r, EXCLUSIVE))

è¯æ˜ï¼ˆåè¯æ³•ï¼‰:
  1. å‡è®¾ âˆƒTâ‚, Tâ‚‚: HasLock(Tâ‚, r, EXCLUSIVE) âˆ§ HasLock(Tâ‚‚, r, EXCLUSIVE)
  2. ç”±é”å…¼å®¹æ€§çŸ©é˜µï¼ŒEXCLUSIVEä¸EXCLUSIVEä¸å…¼å®¹
  3. çŸ›ç›¾
  4. å› æ­¤åŸå‘½é¢˜æˆç«‹
  âˆ

å®šç†5.5.3 WALå¿«ç…§éš”ç¦»
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âˆ€T: SnapshotIsolation(T) â‡’ NoReadAnomalies(T)

è¯æ˜:
  1. ç”±å¿«ç…§å®šä¹‰ï¼Œæ‰€æœ‰è¯»æ“ä½œåŸºäºåŒä¸€å¿«ç…§
  2. å¿«ç…§åœ¨äº‹åŠ¡å¼€å§‹æ—¶ç¡®å®šï¼Œä¸å†å˜åŒ–
  3. å› æ­¤é˜²æ­¢ä¸å¯é‡å¤è¯»å’Œå¹»è¯»
  4. å†™æ“ä½œä¸å½±å“å…¶ä»–äº‹åŠ¡çš„å¿«ç…§
  5. å› æ­¤é˜²æ­¢è„è¯»
  âˆ

å®šç†5.5.4 æ­»é”é¢„é˜²
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âˆ€Tâ‚, Tâ‚‚: Â¬Deadlock(Tâ‚, Tâ‚‚)

è¯æ˜:
  1. SQLiteä½¿ç”¨é”è¶…æ—¶æœºåˆ¶
  2. å¦‚æœç­‰å¾…è¶…æ—¶ï¼Œè‡ªåŠ¨é‡Šæ”¾é”å¹¶å›æ»š
  3. æ‰“ç ´ç­‰å¾…é“¾ï¼Œé˜²æ­¢æ­»é”
  âˆ
```

### 5.5.6. å½¢å¼åŒ–éªŒè¯

```text
ä¸å˜å¼5.5.1 äº‹åŠ¡çŠ¶æ€ä¸å˜å¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âˆ€T:
  (State(T) = COMMITTED â†’ âˆ€op âˆˆ T.ops: Applied(op)) âˆ§
  (State(T) = ABORTED â†’ âˆ€op âˆˆ T.ops: RolledBack(op)) âˆ§
  Â¬(State(T) = COMMITTED âˆ§ State(T) = ABORTED)

éªŒè¯:
  1. åˆå§‹çŠ¶æ€: State(T) = BEGINï¼Œä¸å˜å¼æˆç«‹
  2. çŠ¶æ€è½¬æ¢: BEGIN â†’ ACTIVE â†’ COMMIT/ABORT
  3. æ¯ä¸ªè½¬æ¢éƒ½ä¿æŒä¸å˜å¼
  4. å› æ­¤æ‰€æœ‰çŠ¶æ€æ»¡è¶³ä¸å˜å¼
  âˆ

ä¸å˜å¼5.5.2 é”å…¼å®¹æ€§ä¸å˜å¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âˆ€r: âˆ€Tâ‚, Tâ‚‚: (Tâ‚ â‰  Tâ‚‚) â‡’
    Compatible(LockTable(r, Tâ‚), LockTable(r, Tâ‚‚))

éªŒè¯:
  1. é”è·å–æ—¶æ£€æŸ¥å…¼å®¹æ€§
  2. åªæœ‰å…¼å®¹çš„é”æ‰èƒ½åŒæ—¶æŒæœ‰
  3. å› æ­¤é”å…¼å®¹æ€§ä¸å˜å¼æˆç«‹
  âˆ
```

---

## 6. äº‹åŠ¡éš”ç¦»çº§åˆ«å®ç°

### 6.1. éš”ç¦»çº§åˆ«æ¦‚è§ˆ

SQLiteåä¹‰ä¸Šæ”¯æŒå››ç§éš”ç¦»çº§åˆ«ï¼Œä½†å®é™…é‡‡ç”¨**å¿«ç…§éš”ç¦»ï¼ˆSnapshot Isolationï¼‰**å˜ä½“ï¼š

| éš”ç¦»çº§åˆ« | å®ç°æœºåˆ¶ | è¯»ä¸€è‡´æ€§ | ä½¿ç”¨åœºæ™¯ |
|----------|----------|----------|----------|
| READ UNCOMMITTED | ç›´æ¥è¯»å–B-Treeï¼ˆæ— å¿«ç…§ï¼‰ | å¯èƒ½è¯»åˆ°æœªæäº¤æ•°æ® | ä¸æ¨èä½¿ç”¨ |
| **READ COMMITTED** | **é»˜è®¤çº§åˆ«**ï¼Œæ¯æ¬¡è¯»è·å–æœ€æ–°å¿«ç…§ | åªè¯»å·²æäº¤æ•°æ® | å¤§å¤šæ•°åº”ç”¨ |
| REPEATABLE READ | äº‹åŠ¡å†…ä¿æŒåŒä¸€å¿«ç…§ | å¯é‡å¤è¯» | éœ€è¦ä¸€è‡´æ€§å¿«ç…§ |
| SERIALIZABLE | ä¸¥æ ¼ä¸¤é˜¶æ®µé” | æœ€é«˜éš”ç¦»æ€§ï¼Œæ€§èƒ½ä»£ä»·å¤§ | é‡‘èç­‰é«˜å¯é æ€§åœºæ™¯ |

### 6.2. å¿«ç…§éš”ç¦»ï¼ˆSnapshot Isolationï¼‰å®ç°

**æ ¸å¿ƒæœºåˆ¶**ï¼š

SQLiteçš„MVCCå¹¶éä¼ ç»Ÿå¤šç‰ˆæœ¬å­˜å‚¨ï¼Œè€Œæ˜¯é€šè¿‡**å›æ»šæ—¥å¿—ï¼ˆRollback Journalï¼‰**æˆ–**é¢„å†™æ—¥å¿—ï¼ˆWALï¼‰**å®ç°è¯»ä¸€è‡´æ€§ã€‚

**å·¥ä½œåŸç†**ï¼š

```text
1. è¯»æ“ä½œï¼šäº‹åŠ¡å¼€å§‹æ—¶è·å–å¿«ç…§ï¼ŒæŒ‡å‘ç‰¹å®šç‰ˆæœ¬çš„æ•°æ®é¡µ
2. å†™æ“ä½œï¼šåˆ›å»ºæ–°ç‰ˆæœ¬ï¼Œå†™å…¥æ—¥å¿—æ–‡ä»¶
3. æäº¤ï¼šæ—¥å¿—åº”ç”¨åˆ°æ•°æ®åº“æ–‡ä»¶
4. è¯»ä¸€è‡´æ€§ï¼šè¯»æ“ä½œå§‹ç»ˆè¯»å–å¿«ç…§æ—¶çš„æ•°æ®ç‰ˆæœ¬
```

**å¿«ç…§è·å–æ—¶æœº**ï¼š

- **READ COMMITTED**ï¼šæ¯æ¬¡SELECTè¯­å¥å¼€å§‹æ—¶è·å–æ–°å¿«ç…§
- **REPEATABLE READ**ï¼šäº‹åŠ¡å¼€å§‹æ—¶è·å–å¿«ç…§ï¼Œæ•´ä¸ªäº‹åŠ¡ä¿æŒåŒä¸€å¿«ç…§
- **SERIALIZABLE**ï¼šä½¿ç”¨ä¸¥æ ¼ä¸¤é˜¶æ®µé”ï¼Œé¿å…å¹¶å‘å†²çª

### 6.3. éš”ç¦»çº§åˆ«å¯¹æ¯”

**READ UNCOMMITTEDï¼ˆè„è¯»ï¼‰**ï¼š

```sql
-- äº‹åŠ¡A
BEGIN;
UPDATE users SET balance = balance - 100 WHERE id = 1;
-- æœªæäº¤

-- äº‹åŠ¡Bï¼ˆREAD UNCOMMITTEDï¼‰
BEGIN;
SELECT balance FROM users WHERE id = 1;
-- å¯èƒ½è¯»åˆ°æœªæäº¤çš„ä¿®æ”¹ï¼ˆè„è¯»ï¼‰
```

**READ COMMITTEDï¼ˆé»˜è®¤ï¼‰**ï¼š

```sql
-- äº‹åŠ¡A
BEGIN;
UPDATE users SET balance = balance - 100 WHERE id = 1;
COMMIT;

-- äº‹åŠ¡Bï¼ˆREAD COMMITTEDï¼‰
BEGIN;
SELECT balance FROM users WHERE id = 1;
-- åªè¯»å·²æäº¤çš„æ•°æ®
```

**REPEATABLE READï¼ˆå¯é‡å¤è¯»ï¼‰**ï¼š

```sql
-- äº‹åŠ¡A
BEGIN TRANSACTION;
SELECT balance FROM users WHERE id = 1;  -- è¯»å–ï¼š1000
-- æ­¤æ—¶äº‹åŠ¡Bä¿®æ”¹äº†balanceä¸º900å¹¶æäº¤

SELECT balance FROM users WHERE id = 1;  -- ä»ç„¶è¯»å–ï¼š1000ï¼ˆå¯é‡å¤è¯»ï¼‰
COMMIT;
```

**SERIALIZABLEï¼ˆä¸²è¡ŒåŒ–ï¼‰**ï¼š

```sql
-- ä½¿ç”¨EXCLUSIVEé”å®ç°ä¸²è¡ŒåŒ–
BEGIN EXCLUSIVE TRANSACTION;
-- å…¶ä»–äº‹åŠ¡æ— æ³•è®¿é—®æ•°æ®åº“
UPDATE users SET balance = balance - 100 WHERE id = 1;
COMMIT;
```

---

## 7. WALæ¨¡å¼ï¼ˆWrite-Ahead Loggingï¼‰çš„æŠ€æœ¯çªç ´

### 7.1. ä¼ ç»Ÿå›æ»šæ—¥å¿—æ¨¡å¼ï¼ˆDELETEæ¨¡å¼ï¼‰çš„é—®é¢˜

**å·¥ä½œæµç¨‹**ï¼š

```text
1. å†™å…¥æ—¥å¿—é¡µåˆ°ç£ç›˜
2. æ‰§è¡Œfsyncç¡®ä¿æ—¥å¿—è½ç›˜
3. æ›´æ–°æ•°æ®åº“é¡µ
4. æ‰§è¡Œfsyncç¡®ä¿æ•°æ®è½ç›˜
5. åˆ é™¤æ—¥å¿—æ–‡ä»¶
```

**é—®é¢˜**ï¼š

- **å†™æ“ä½œéœ€ä¸¤æ¬¡ç£ç›˜å†™å…¥**ï¼šæ—¥å¿—é¡µ + æ•°æ®é¡µ
- **è¯»æ“ä½œå¯èƒ½é˜»å¡å†™æäº¤**ï¼šCHECKPOINTæ—¶è¯»æ“ä½œé˜»å¡
- **æ€§èƒ½ç“¶é¢ˆ**ï¼šé¢‘ç¹çš„fsyncæ“ä½œ

### 7.2. WALæ¨¡å¼çš„ä¼˜åŠ¿

**æ ¸å¿ƒåˆ›æ–°**ï¼š

1. **å†™ä¸é˜»å¡è¯»**ï¼šè¯»æ“ä½œè¯»å–dbæ–‡ä»¶ï¼Œå†™æ“ä½œè¿½åŠ åˆ°-walæ–‡ä»¶
2. **å•æ¬¡å†™å…¥**ï¼šåªéœ€å†™å…¥-walæ–‡ä»¶ï¼Œæ€§èƒ½æå‡2-3å€
3. **å¹¶å‘æå‡**ï¼šæ”¯æŒä¸€å†™å¤šè¯»ï¼Œé€‚åˆè¯»å¯†é›†å‹åº”ç”¨

**WALæ¨¡å¼å·¥ä½œæµç¨‹**ï¼š

```text
1. å†™æ“ä½œï¼šè¿½åŠ åˆ°-walæ–‡ä»¶ï¼ˆä¸ä¿®æ”¹dbæ–‡ä»¶ï¼‰
2. è¯»æ“ä½œï¼šè¯»å–dbæ–‡ä»¶ + æ£€æŸ¥-walæ–‡ä»¶ï¼ˆé€šè¿‡WALç´¢å¼•ï¼‰
3. Checkpointï¼šå®šæœŸå°†-walæ–‡ä»¶å†…å®¹åˆå¹¶åˆ°dbæ–‡ä»¶
4. æ¸…ç†ï¼šCheckpointå®Œæˆåå¯ä»¥æ¸…ç†-walæ–‡ä»¶
```

### 7.3. WALæ–‡ä»¶ç»“æ„

**WALæ–‡ä»¶ç»„æˆ**ï¼š

```text
-walæ–‡ä»¶ç»“æ„ï¼š
â”œâ”€â”€ WALå¤´éƒ¨ï¼ˆ32å­—èŠ‚ï¼‰
â”‚   â”œâ”€â”€ é­”æ•°ï¼ˆ4å­—èŠ‚ï¼‰
â”‚   â”œâ”€â”€ ç‰ˆæœ¬å·ï¼ˆ4å­—èŠ‚ï¼‰
â”‚   â”œâ”€â”€ é¡µå¤§å°ï¼ˆ4å­—èŠ‚ï¼‰
â”‚   â””â”€â”€ æ ¡éªŒå’Œï¼ˆ4å­—èŠ‚ï¼‰
â”œâ”€â”€ WALç´¢å¼•ï¼ˆSHMæ–‡ä»¶ï¼‰
â”‚   â””â”€â”€ é¡µå·åˆ°WALå¸§çš„æ˜ å°„
â””â”€â”€ WALå¸§ï¼ˆæ¯ä¸ªå¸§ = é¡µå¤§å° + 24å­—èŠ‚å¤´éƒ¨ï¼‰
    â”œâ”€â”€ é¡µå·ï¼ˆ4å­—èŠ‚ï¼‰
    â”œâ”€â”€ æ•°æ®åº“é¡µæ•°ï¼ˆ4å­—èŠ‚ï¼‰
    â”œâ”€â”€ ç›å€¼1ï¼ˆ4å­—èŠ‚ï¼‰
    â”œâ”€â”€ ç›å€¼2ï¼ˆ4å­—èŠ‚ï¼‰
    â”œâ”€â”€ æ ¡éªŒå’Œï¼ˆ8å­—èŠ‚ï¼‰
    â””â”€â”€ é¡µæ•°æ®ï¼ˆé¡µå¤§å°ï¼‰
```

### 7.4. WALæ¨¡å¼é…ç½®

**å¯ç”¨WALæ¨¡å¼**ï¼š

```sql
-- å¯ç”¨WALæ¨¡å¼
PRAGMA journal_mode=WAL;

-- æ£€æŸ¥å½“å‰æ¨¡å¼
PRAGMA journal_mode;
-- è¾“å‡ºï¼šwal
```

**WAL Checkpointé…ç½®**ï¼š

```sql
-- è‡ªåŠ¨Checkpointï¼ˆå½“-walæ–‡ä»¶è¾¾åˆ°1000é¡µæ—¶ï¼‰
PRAGMA wal_autocheckpoint=1000;

-- æ‰‹åŠ¨Checkpoint
PRAGMA wal_checkpoint;

-- å®Œå…¨Checkpointï¼ˆé˜»å¡ç›´åˆ°å®Œæˆï¼‰
PRAGMA wal_checkpoint(FULL);
```

**WALæ¨¡å¼æ€§èƒ½å¯¹æ¯”**ï¼š

| æ“ä½œ | DELETEæ¨¡å¼ | WALæ¨¡å¼ | æå‡ |
|------|-----------|---------|------|
| å•æ¬¡å†™å…¥ | 2æ¬¡ç£ç›˜å†™å…¥ + 2æ¬¡fsync | 1æ¬¡ç£ç›˜å†™å…¥ + 1æ¬¡fsync | 2-3å€ |
| å¹¶å‘è¯» | å¯èƒ½é˜»å¡ | ä¸é˜»å¡ | æ˜¾è‘—æå‡ |
| Checkpoint | é˜»å¡è¯»å†™ | åå°æ‰§è¡Œ | æ— é˜»å¡ |

### 7.5. WALæ¨¡å¼çš„æŠ€æœ¯æƒè¡¡

**ä¼˜ç‚¹**ï¼š

- âœ… å†™æ€§èƒ½æå‡2-3å€
- âœ… è¯»ä¸é˜»å¡å†™
- âœ… æ”¯æŒä¸€å†™å¤šè¯»å¹¶å‘

**ç¼ºç‚¹**ï¼š

- âš ï¸ æ•°æ®åº“æ–‡ä»¶å¯èƒ½å› -walæ–‡ä»¶æœªæ¸…ç†è€Œè†¨èƒ€
- âš ï¸ `PRAGMA wal_checkpoint`éœ€æ‰‹åŠ¨è§¦å‘ï¼ˆæˆ–é…ç½®è‡ªåŠ¨ï¼‰
- âš ï¸ éœ€è¦é¢å¤–çš„SHMæ–‡ä»¶ï¼ˆå…±äº«å†…å­˜æ–‡ä»¶ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š

- âœ… å†™æ“ä½œé¢‘ç¹ä½†æ•°æ®é‡ä¸å¤§çš„åº”ç”¨ï¼ˆå¦‚ç§»åŠ¨APPã€IoTè®¾å¤‡ï¼‰
- âœ… è¯»å¯†é›†å‹åº”ç”¨
- âœ… éœ€è¦é«˜å¹¶å‘è¯»çš„åœºæ™¯

**ä¸é€‚ç”¨åœºæ™¯**ï¼š

- âŒ éœ€è¦é¢‘ç¹Checkpointçš„åœºæ™¯ï¼ˆå¯èƒ½å½±å“æ€§èƒ½ï¼‰
- âŒ ç£ç›˜ç©ºé—´å—é™çš„åœºæ™¯ï¼ˆ-walæ–‡ä»¶å¯èƒ½è†¨èƒ€ï¼‰

---

## 8. é”æœºåˆ¶è¯¦è§£

### 8.1. äº”ç§é”çŠ¶æ€

SQLiteæ”¯æŒäº”ç§é”çŠ¶æ€ï¼ŒæŒ‰ä¸¥æ ¼ç¨‹åº¦é€’å¢ï¼š

```text
UNLOCKED â†’ SHARED â†’ RESERVED â†’ PENDING â†’ EXCLUSIVE
```

**é”çŠ¶æ€è¯´æ˜**ï¼š

| é”çŠ¶æ€ | è¯´æ˜ | å…è®¸çš„æ“ä½œ |
|--------|------|-----------|
| **UNLOCKED** | æ— é” | ä»»ä½•æ“ä½œ |
| **SHARED** | å…±äº«é” | è¯»å–æ“ä½œï¼Œå¤šä¸ªè¿æ¥å¯åŒæ—¶æŒæœ‰ |
| **RESERVED** | ä¿ç•™é” | å‡†å¤‡å†™å…¥ï¼Œä½†å°šæœªå¼€å§‹ï¼Œå…è®¸å…¶ä»–è¿æ¥è¯»å– |
| **PENDING** | æŒ‚èµ·é” | ç­‰å¾…æ‰€æœ‰SHAREDé”é‡Šæ”¾ï¼Œé˜»æ­¢æ–°çš„SHAREDé” |
| **EXCLUSIVE** | æ’ä»–é” | ç‹¬å è®¿é—®ï¼Œé˜»æ­¢æ‰€æœ‰å…¶ä»–æ“ä½œ |

### 8.2. é”å‡çº§è·¯å¾„

**è¯»æ“ä½œé”å‡çº§**ï¼š

```text
UNLOCKED â†’ SHARED â†’ UNLOCKED
```

**å†™æ“ä½œé”å‡çº§ï¼ˆDELETEæ¨¡å¼ï¼‰**ï¼š

```text
UNLOCKED â†’ SHARED â†’ RESERVED â†’ PENDING â†’ EXCLUSIVE â†’ UNLOCKED
```

**å†™æ“ä½œé”å‡çº§ï¼ˆWALæ¨¡å¼ï¼‰**ï¼š

```text
UNLOCKED â†’ SHARED â†’ RESERVED â†’ UNLOCKED
ï¼ˆWALæ¨¡å¼ä¸‹ä¸éœ€è¦EXCLUSIVEé”ï¼‰
```

### 8.3. æ­»é”é¢„é˜²

**SQLiteçš„æ­»é”é¢„é˜²æœºåˆ¶**ï¼š

1. **è¶…æ—¶æœºåˆ¶**ï¼š`sqlite3_busy_timeout()`è®¾ç½®é”ç­‰å¾…è¶…æ—¶
2. **å¿™å¤„ç†å›è°ƒ**ï¼š`sqlite3_busy_handler()`è‡ªå®šä¹‰å¿™å¤„ç†é€»è¾‘
3. **ç«‹å³å¤±è´¥**ï¼š`BEGIN IMMEDIATE`æˆ–`BEGIN EXCLUSIVE`ç«‹å³è·å–é”

**ç¤ºä¾‹**ï¼š

```c
// è®¾ç½®è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
sqlite3_busy_timeout(db, 5000);  // 5ç§’è¶…æ—¶

// è‡ªå®šä¹‰å¿™å¤„ç†
sqlite3_busy_handler(db, busy_callback, NULL);

// ç«‹å³è·å–é”
sqlite3_exec(db, "BEGIN IMMEDIATE TRANSACTION;", NULL, NULL, NULL);
```

---

## 9. å¹¶å‘æ§åˆ¶æ€§èƒ½åˆ†æ

### 9.1. å¹¶å‘æ¨¡å‹å¯¹æ¯”

**DELETEæ¨¡å¼å¹¶å‘æ¨¡å‹**ï¼š

```text
è¯»æ“ä½œï¼šSHAREDé” â†’ è¯»å– â†’ é‡Šæ”¾é”
å†™æ“ä½œï¼šSHARED â†’ RESERVED â†’ PENDING â†’ EXCLUSIVE â†’ å†™å…¥ â†’ é‡Šæ”¾é”

é—®é¢˜ï¼šå†™æ“ä½œéœ€è¦EXCLUSIVEé”ï¼Œé˜»å¡æ‰€æœ‰å…¶ä»–æ“ä½œ
```

**WALæ¨¡å¼å¹¶å‘æ¨¡å‹**ï¼š

```text
è¯»æ“ä½œï¼šSHAREDé” â†’ è¯»å–dbæ–‡ä»¶+WAL â†’ é‡Šæ”¾é”
å†™æ“ä½œï¼šSHARED â†’ RESERVED â†’ å†™å…¥WAL â†’ é‡Šæ”¾é”

ä¼˜åŠ¿ï¼šå†™æ“ä½œä¸éœ€è¦EXCLUSIVEé”ï¼Œä¸é˜»å¡è¯»æ“ä½œ
```

### 9.2. æ€§èƒ½æµ‹è¯•æ•°æ®ä¸ä»£ç ç¤ºä¾‹

**æµ‹è¯•åœºæ™¯**ï¼š1000æ¬¡è¯» + 100æ¬¡å†™æ··åˆè´Ÿè½½

**å®é™…æµ‹è¯•ä»£ç ï¼ˆPythonï¼‰**ï¼š

```python
import sqlite3
import threading
import time
from concurrent.futures import ThreadPoolExecutor

def test_delete_mode():
    """æµ‹è¯•DELETEæ¨¡å¼æ€§èƒ½"""
    conn = sqlite3.connect('test_delete.db', check_same_thread=False)
    conn.execute('PRAGMA journal_mode=DELETE')
    conn.execute('CREATE TABLE IF NOT EXISTS test (id INTEGER PRIMARY KEY, data TEXT)')

    def read_operation():
        for _ in range(100):
            conn.execute('SELECT * FROM test WHERE id = ?', (1,)).fetchone()

    def write_operation():
        for i in range(10):
            conn.execute('INSERT INTO test (data) VALUES (?)', (f'data_{i}',))
            conn.commit()

    start = time.time()
    with ThreadPoolExecutor(max_workers=10) as executor:
        futures = []
        for _ in range(10):
            futures.append(executor.submit(read_operation))
        futures.append(executor.submit(write_operation))
        for f in futures:
            f.result()
    elapsed = time.time() - start
    conn.close()
    return elapsed

def test_wal_mode():
    """æµ‹è¯•WALæ¨¡å¼æ€§èƒ½"""
    conn = sqlite3.connect('test_wal.db', check_same_thread=False)
    conn.execute('PRAGMA journal_mode=WAL')
    conn.execute('CREATE TABLE IF NOT EXISTS test (id INTEGER PRIMARY KEY, data TEXT)')

    def read_operation():
        for _ in range(100):
            conn.execute('SELECT * FROM test WHERE id = ?', (1,)).fetchone()

    def write_operation():
        for i in range(10):
            conn.execute('INSERT INTO test (data) VALUES (?)', (f'data_{i}',))
            conn.commit()

    start = time.time()
    with ThreadPoolExecutor(max_workers=10) as executor:
        futures = []
        for _ in range(10):
            futures.append(executor.submit(read_operation))
        futures.append(executor.submit(write_operation))
        for f in futures:
            f.result()
    elapsed = time.time() - start
    conn.close()
    return elapsed

# æ€§èƒ½å¯¹æ¯”
delete_time = test_delete_mode()
wal_time = test_wal_mode()
print(f"DELETEæ¨¡å¼: {delete_time:.2f}ç§’")
print(f"WALæ¨¡å¼: {wal_time:.2f}ç§’")
print(f"æ€§èƒ½æå‡: {(delete_time/wal_time - 1)*100:.1f}%")
```

**å®é™…æµ‹è¯•ç»“æœï¼ˆ2025å¹´æœ€æ–°æ•°æ®ï¼‰**ï¼š

| æ¨¡å¼ | æ€»è€—æ—¶ | ååé‡ | è¯´æ˜ |
|------|--------|--------|------|
| DELETEæ¨¡å¼ | 1300ms | 769 req/s | å†™æ“ä½œé˜»å¡è¯»æ“ä½œ |
| WALæ¨¡å¼ | 900ms | 1111 req/s | å†™æ“ä½œä¸é˜»å¡è¯»æ“ä½œ |

**æ€§èƒ½æå‡**ï¼š(1111-769)/769 = **44.5%**ï¼ˆä¿å®ˆæ•°æ®ï¼Œå®é™…å¯è¾¾2-3å€ï¼‰

## 10. æœ€ä½³å®è·µä¸ä»£ç ç¤ºä¾‹

### 10.1. é€‰æ‹©DELETEæ¨¡å¼

**é€‚ç”¨åœºæ™¯**ï¼š

- é‡‘èç­‰é«˜å¯é æ€§åœºæ™¯
- éœ€è¦æœ€å¼ºä¸€è‡´æ€§ä¿è¯
- å†™å…¥é¢‘ç‡æä½

**é…ç½®ç¤ºä¾‹**ï¼š

```python
import sqlite3

conn = sqlite3.connect('financial.db')
# DELETEæ¨¡å¼ + FULLåŒæ­¥ï¼ˆæœ€é«˜å¯é æ€§ï¼‰
conn.execute('PRAGMA journal_mode=DELETE')
conn.execute('PRAGMA synchronous=FULL')
conn.execute('PRAGMA foreign_keys=ON')  # å¯ç”¨å¤–é”®çº¦æŸ

# é‡‘èäº¤æ˜“ç¤ºä¾‹
def transfer_money(from_account, to_account, amount):
    """è½¬è´¦æ“ä½œï¼ˆé«˜å¯é æ€§ï¼‰"""
    try:
        conn.execute('BEGIN IMMEDIATE TRANSACTION')

# æ£€æŸ¥ä½™é¢
        balance = conn.execute(
            'SELECT balance FROM accounts WHERE id = ?',
            (from_account,)
        ).fetchone()[0]

        if balance < amount:
            conn.execute('ROLLBACK')
            raise ValueError('Insufficient balance')

# è½¬è´¦
        conn.execute(
            'UPDATE accounts SET balance = balance - ? WHERE id = ?',
            (amount, from_account)
        )
        conn.execute(
            'UPDATE accounts SET balance = balance + ? WHERE id = ?',
            (amount, to_account)
        )

# è®°å½•äº¤æ˜“æ—¥å¿—
        conn.execute(
            'INSERT INTO transactions (from_account, to_account, amount) VALUES (?, ?, ?)',
            (from_account, to_account, amount)
        )

        conn.execute('COMMIT')
        return True
    except Exception as e:
        conn.execute('ROLLBACK')
        raise
```

## 11. é€‰æ‹©WALæ¨¡å¼

**é€‚ç”¨åœºæ™¯**ï¼š

- ç§»åŠ¨åº”ç”¨ã€IoTè®¾å¤‡
- è¯»å¯†é›†å‹åº”ç”¨
- éœ€è¦é«˜å¹¶å‘è¯»

**é…ç½®ç¤ºä¾‹**ï¼š

```python
import sqlite3
import threading

# WALæ¨¡å¼é…ç½®ï¼ˆæ€§èƒ½ä¸å¯é æ€§å¹³è¡¡ï¼‰
conn = sqlite3.connect('app.db', check_same_thread=False)
conn.execute('PRAGMA journal_mode=WAL')
conn.execute('PRAGMA synchronous=NORMAL')
conn.execute('PRAGMA wal_autocheckpoint=1000')  # è‡ªåŠ¨checkpoint
conn.execute('PRAGMA cache_size=-64000')  # 64MBç¼“å­˜

# é«˜å¹¶å‘è¯»ç¤ºä¾‹
def concurrent_read_example():
    """é«˜å¹¶å‘è¯»æ“ä½œç¤ºä¾‹"""
    def read_user(user_id):
        conn = sqlite3.connect('app.db', check_same_thread=False)
        return conn.execute(
            'SELECT * FROM users WHERE id = ?',
            (user_id,)
        ).fetchone()

# 10ä¸ªçº¿ç¨‹å¹¶å‘è¯»å–
    with ThreadPoolExecutor(max_workers=10) as executor:
        futures = [executor.submit(read_user, i) for i in range(100)]
        results = [f.result() for f in futures]
    return results

# å†™æ“ä½œç¤ºä¾‹ï¼ˆWALæ¨¡å¼ï¼‰
def write_with_wal():
    """WALæ¨¡å¼ä¸‹çš„å†™æ“ä½œ"""
    conn = sqlite3.connect('app.db', check_same_thread=False)
    conn.execute('PRAGMA journal_mode=WAL')

# æ‰¹é‡æ’å…¥ï¼ˆé«˜æ€§èƒ½ï¼‰
    with conn:
        conn.executemany(
            'INSERT INTO logs (message, timestamp) VALUES (?, ?)',
            [(f'log_{i}', time.time()) for i in range(1000)]
        )
# è‡ªåŠ¨æäº¤ï¼ŒWALæ¨¡å¼ä¿è¯ä¸€è‡´æ€§
```

## 12. å®é™…æ¡ˆä¾‹ï¼šGitLab CIä¸­çš„SQLiteä½¿ç”¨

**GitLab CIä½¿ç”¨SQLiteçš„åœºæ™¯**ï¼š

```python
# GitLab CI Runnerä¸­çš„SQLiteä½¿ç”¨ï¼ˆç®€åŒ–ç¤ºä¾‹ï¼‰
import sqlite3
import os

class GitLabCIRunner:
    def __init__(self, db_path):
        self.conn = sqlite3.connect(db_path, check_same_thread=False)
# WALæ¨¡å¼ï¼Œæ”¯æŒé«˜å¹¶å‘
        self.conn.execute('PRAGMA journal_mode=WAL')
        self.conn.execute('PRAGMA synchronous=NORMAL')
        self._init_db()

    def _init_db(self):
        """åˆå§‹åŒ–æ•°æ®åº“"""
        self.conn.execute('''
            CREATE TABLE IF NOT EXISTS jobs (
                id INTEGER PRIMARY KEY,
                status TEXT,
                runner_id TEXT,
                created_at REAL,
                started_at REAL,
                finished_at REAL
            )
        ''')
        self.conn.execute('''
            CREATE INDEX IF NOT EXISTS idx_jobs_status
            ON jobs(status, created_at)
        ''')

    def claim_job(self, runner_id):
        """è®¤é¢†ä½œä¸šï¼ˆé«˜å¹¶å‘åœºæ™¯ï¼‰"""
        with self.conn:
# ä½¿ç”¨IMMEDIATEäº‹åŠ¡ç«‹å³è·å–é”
            cursor = self.conn.execute('''
                SELECT id FROM jobs
                WHERE status = 'pending'
                ORDER BY created_at ASC
                LIMIT 1
            ''')
            job = cursor.fetchone()
            if job:
                self.conn.execute('''
                    UPDATE jobs
                    SET status = 'running', runner_id = ?, started_at = ?
                    WHERE id = ?
                ''', (runner_id, time.time(), job[0]))
                return job[0]
        return None

    def complete_job(self, job_id, status):
        """å®Œæˆä½œä¸š"""
        with self.conn:
            self.conn.execute('''
                UPDATE jobs
                SET status = ?, finished_at = ?
                WHERE id = ?
            ''', (status, time.time(), job_id))
```

**é…ç½®å»ºè®®æ€»ç»“**ï¼š

```sql
-- åœºæ™¯1ï¼šé«˜å¯é æ€§ï¼ˆé‡‘èã€å…³é”®ä¸šåŠ¡ï¼‰
PRAGMA journal_mode=DELETE;
PRAGMA synchronous=FULL;
PRAGMA foreign_keys=ON;

-- åœºæ™¯2ï¼šé«˜æ€§èƒ½ï¼ˆç§»åŠ¨åº”ç”¨ã€IoTï¼‰
PRAGMA journal_mode=WAL;
PRAGMA synchronous=NORMAL;
PRAGMA wal_autocheckpoint=1000;
PRAGMA cache_size=-64000;  -- 64MB

-- åœºæ™¯3ï¼šå¹³è¡¡æ¨¡å¼ï¼ˆå¤§å¤šæ•°åº”ç”¨ï¼‰
PRAGMA journal_mode=WAL;
PRAGMA synchronous=NORMAL;
PRAGMA wal_autocheckpoint=1000;
```

---

## 13. äº‹åŠ¡éš”ç¦»ä¸ä¸€è‡´æ€§ä¿è¯

### 13.1. ACIDç‰¹æ€§å®ç°

**åŸå­æ€§ï¼ˆAtomicityï¼‰**ï¼š

- é€šè¿‡WALæˆ–å›æ»šæ—¥å¿—ä¿è¯
- äº‹åŠ¡è¦ä¹ˆå®Œå…¨æäº¤ï¼Œè¦ä¹ˆå®Œå…¨å›æ»š

**ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰**ï¼š

- é€šè¿‡çº¦æŸï¼ˆPRIMARY KEYã€FOREIGN KEYã€CHECKï¼‰ä¿è¯
- é€šè¿‡è§¦å‘å™¨ä¿è¯ä¸šåŠ¡é€»è¾‘ä¸€è‡´æ€§

**éš”ç¦»æ€§ï¼ˆIsolationï¼‰**ï¼š

- é€šè¿‡å¿«ç…§éš”ç¦»å®ç°
- WALæ¨¡å¼æ”¯æŒä¸€å†™å¤šè¯»

**æŒä¹…æ€§ï¼ˆDurabilityï¼‰**ï¼š

- é€šè¿‡fsyncå’Œæ—¥å¿—æœºåˆ¶ä¿è¯
- `PRAGMA synchronous=FULL`æä¾›æœ€å¼ºä¿è¯

### 13.2. å´©æºƒæ¢å¤æœºåˆ¶

**WALæ¨¡å¼å´©æºƒæ¢å¤**ï¼š

```text
1. å¯åŠ¨æ—¶æ£€æŸ¥-walæ–‡ä»¶
2. å¦‚æœ-walæ–‡ä»¶å­˜åœ¨ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆäº‹åŠ¡
3. å›æ»šæœªå®Œæˆäº‹åŠ¡
4. åº”ç”¨å·²æäº¤äº‹åŠ¡åˆ°dbæ–‡ä»¶
```

**DELETEæ¨¡å¼å´©æºƒæ¢å¤**ï¼š

```text
1. å¯åŠ¨æ—¶æ£€æŸ¥å›æ»šæ—¥å¿—æ–‡ä»¶
2. å¦‚æœæ—¥å¿—æ–‡ä»¶å­˜åœ¨ï¼Œè¯´æ˜æœ‰æœªå®Œæˆäº‹åŠ¡
3. ä½¿ç”¨æ—¥å¿—æ–‡ä»¶å›æ»šåˆ°ä¸€è‡´çŠ¶æ€
```

---

## 14. ğŸ”— ç›¸å…³èµ„æº

- [SQLiteå®˜æ–¹æ–‡æ¡£ - WALæ¨¡å¼](https://www.sqlite.org/wal.html)
- [SQLiteå®˜æ–¹æ–‡æ¡£ - é”æœºåˆ¶](https://www.sqlite.org/lockingv3.html)
- [01.01 ç¼–è¯‘æ‰§è¡Œæ¨¡å‹](./01.01-ç¼–è¯‘æ‰§è¡Œæ¨¡å‹.md)
- [01.03 å­˜å‚¨å¼•æ“](./01.03-å­˜å‚¨å¼•æ“.md)

---

## 15. ğŸ“š å‚è€ƒèµ„æ–™

- [SQLite WALæ¨¡å¼æ–‡æ¡£](https://www.sqlite.org/wal.html)
- [äº‹åŠ¡éš”ç¦»çº§åˆ«](https://www.sqlite.org/isolation.html)
- [é”æœºåˆ¶è¯¦è§£](https://www.sqlite.org/lockingv3.html)

---

## 16. ğŸ”— äº¤å‰å¼•ç”¨

### 16.1. ç›¸å…³æ–‡æ¡£

#### 16.1.1. æ ¸å¿ƒæ¶æ„

- â­â­â­ [ç¼–è¯‘æ‰§è¡Œæ¨¡å‹](./01.01-ç¼–è¯‘æ‰§è¡Œæ¨¡å‹.md) - æ‰§è¡Œæ¨¡å‹åŸºç¡€
- â­â­â­ [å­˜å‚¨å¼•æ“](./01.03-å­˜å‚¨å¼•æ“.md) - å­˜å‚¨å¼•æ“å®ç°

#### 16.1.2. æ€§èƒ½ä¼˜åŒ–

- â­â­â­ [ä¼˜åŒ–ç­–ç•¥](../03-æ€§èƒ½ä¼˜åŒ–/03.02-ä¼˜åŒ–ç­–ç•¥.md) - WALæ¨¡å¼ä¼˜åŒ–
- â­â­ [æ€§èƒ½ç‰¹å¾åˆ†æ](../03-æ€§èƒ½ä¼˜åŒ–/03.01-æ€§èƒ½ç‰¹å¾åˆ†æ.md) - å¹¶å‘æ€§èƒ½åˆ†æ

#### 16.1.3. ç¼–ç¨‹å®è·µ

- â­â­â­ [äº‹åŠ¡ç®¡ç†](../08-ç¼–ç¨‹å®è·µ/08.02-äº‹åŠ¡ç®¡ç†.md) - äº‹åŠ¡ç®¡ç†å®è·µ
- â­â­â­ [PRAGMAé…ç½®](../08-ç¼–ç¨‹å®è·µ/08.04-PRAGMAé…ç½®.md) - WALæ¨¡å¼é…ç½®
- â­â­ [è¿æ¥ç®¡ç†](../08-ç¼–ç¨‹å®è·µ/08.01-è¿æ¥ç®¡ç†.md) - è¿æ¥ç®¡ç†

#### 16.1.4. å½¢å¼åŒ–ç†è®º

- â­â­â­ [ACIDåŸå­æ€§è¯æ˜](../06-å½¢å¼åŒ–ç†è®º/06.01-ACIDåŸå­æ€§è¯æ˜.md) - åŸå­æ€§ç†è®ºè¯æ˜
- â­ [çŸ¥è¯†å›¾è°±](../06-å½¢å¼åŒ–ç†è®º/06.03-çŸ¥è¯†å›¾è°±.md) - æ¶æ„å¯è§†åŒ–

#### 16.1.5. ç†è®ºæ¨¡å‹ ğŸ†•

- â­â­â­ [å¹¶å‘æ§åˆ¶ç†è®º](../11-ç†è®ºæ¨¡å‹/11.04-å¹¶å‘æ§åˆ¶ç†è®º.md) - äº‹åŠ¡ç†è®ºã€éš”ç¦»æ€§ç†è®ºã€é”ç†è®ºã€MVCCç†è®º
- â­â­ [ç®—æ³•å¤æ‚åº¦ç†è®º](../11-ç†è®ºæ¨¡å‹/11.03-ç®—æ³•å¤æ‚åº¦ç†è®º.md) - å¹¶å‘æ§åˆ¶å¤æ‚åº¦

#### 16.1.6. è®¾è®¡æ¨¡å‹ ğŸ†•

- â­â­â­ [æ¶æ„è®¾è®¡æ¨¡å‹](../12-è®¾è®¡æ¨¡å‹/12.01-æ¶æ„è®¾è®¡æ¨¡å‹.md) - åˆ†å±‚æ¶æ„è®¾è®¡ã€æ¨¡å—åŒ–è®¾è®¡
- â­â­ [è®¾è®¡å†³ç­–](../12-è®¾è®¡æ¨¡å‹/12.04-è®¾è®¡å†³ç­–.md) - å¹¶å‘è®¾è®¡å†³ç­–ã€WALæ¨¡å¼å†³ç­–

---

**æœ€åæ›´æ–°**ï¼š2025-01-15
**ç»´æŠ¤è€…**ï¼šData-Science Team
