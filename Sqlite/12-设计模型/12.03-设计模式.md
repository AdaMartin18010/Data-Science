# è®¾è®¡æ¨¡å¼ï¼šSQLiteä¸­çš„æ¨¡å¼åº”ç”¨

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-01-15
> **ç‰ˆæœ¬**ï¼šSQLite 3.31+ è‡³ 3.47.x

---

## 1. ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ·±å…¥åˆ†æSQLiteä¸­åº”ç”¨çš„å„ç§è®¾è®¡æ¨¡å¼ï¼ŒåŒ…æ‹¬åˆ›å»ºå‹æ¨¡å¼ã€ç»“æ„å‹æ¨¡å¼å’Œè¡Œä¸ºå‹æ¨¡å¼ï¼Œå¸®åŠ©ç†è§£SQLiteçš„è®¾è®¡å®ç°ã€‚

---

## 2. ğŸ“‘ ç›®å½•

- [è®¾è®¡æ¨¡å¼ï¼šSQLiteä¸­çš„æ¨¡å¼åº”ç”¨](#è®¾è®¡æ¨¡å¼sqliteä¸­çš„æ¨¡å¼åº”ç”¨)
  - [1. ğŸ“‹ æ¦‚è¿°](#1--æ¦‚è¿°)
  - [2. ğŸ“‘ ç›®å½•](#2--ç›®å½•)
  - [3. ğŸ“Š æ€ç»´å¯¼å›¾](#3--æ€ç»´å¯¼å›¾)
  - [4. åˆ›å»ºå‹æ¨¡å¼](#4-åˆ›å»ºå‹æ¨¡å¼)
    - [4.1. å·¥å‚æ¨¡å¼](#41-å·¥å‚æ¨¡å¼)
    - [4.2. å•ä¾‹æ¨¡å¼](#42-å•ä¾‹æ¨¡å¼)
    - [4.3. å»ºé€ è€…æ¨¡å¼](#43-å»ºé€ è€…æ¨¡å¼)
  - [5. ç»“æ„å‹æ¨¡å¼](#5-ç»“æ„å‹æ¨¡å¼)
    - [5.1. é€‚é…å™¨æ¨¡å¼](#51-é€‚é…å™¨æ¨¡å¼)
    - [5.2. è£…é¥°å™¨æ¨¡å¼](#52-è£…é¥°å™¨æ¨¡å¼)
    - [5.3. å¤–è§‚æ¨¡å¼](#53-å¤–è§‚æ¨¡å¼)
  - [6. è¡Œä¸ºå‹æ¨¡å¼](#6-è¡Œä¸ºå‹æ¨¡å¼)
    - [6.1. ç­–ç•¥æ¨¡å¼](#61-ç­–ç•¥æ¨¡å¼)
    - [6.2. è§‚å¯Ÿè€…æ¨¡å¼](#62-è§‚å¯Ÿè€…æ¨¡å¼)
    - [6.3. æ¨¡æ¿æ–¹æ³•æ¨¡å¼](#63-æ¨¡æ¿æ–¹æ³•æ¨¡å¼)
    - [6.4. çŠ¶æ€æ¨¡å¼](#64-çŠ¶æ€æ¨¡å¼)
  - [7. æ¶æ„æ¨¡å¼](#7-æ¶æ„æ¨¡å¼)
    - [7.1. åˆ†å±‚æ¶æ„æ¨¡å¼](#71-åˆ†å±‚æ¶æ„æ¨¡å¼)
    - [7.2. ç®¡é“-è¿‡æ»¤å™¨æ¨¡å¼](#72-ç®¡é“-è¿‡æ»¤å™¨æ¨¡å¼)
    - [7.3. æ¨¡å—åŒ–æ¨¡å¼](#73-æ¨¡å—åŒ–æ¨¡å¼)
  - [8. è®¾è®¡æ¨¡å¼æ€»ç»“](#8-è®¾è®¡æ¨¡å¼æ€»ç»“)
    - [8.1. æ¨¡å¼åº”ç”¨æ€»ç»“](#81-æ¨¡å¼åº”ç”¨æ€»ç»“)
    - [8.2. æ¨¡å¼åº”ç”¨ä¼˜åŠ¿](#82-æ¨¡å¼åº”ç”¨ä¼˜åŠ¿)
    - [8.3. æ¨¡å¼åº”ç”¨åœºæ™¯](#83-æ¨¡å¼åº”ç”¨åœºæ™¯)
    - [8.4. è®¾è®¡æ¨¡å¼åº”ç”¨ä»£ç ç¤ºä¾‹](#84-è®¾è®¡æ¨¡å¼åº”ç”¨ä»£ç ç¤ºä¾‹)
  - [9. ğŸ”— ç›¸å…³èµ„æº](#9--ç›¸å…³èµ„æº)
  - [10. ğŸ“š å‚è€ƒèµ„æ–™](#10--å‚è€ƒèµ„æ–™)

---

## 3. ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((è®¾è®¡æ¨¡å¼))
    åˆ›å»ºå‹æ¨¡å¼
      å·¥å‚æ¨¡å¼
        VFSå·¥å‚
        å¯¹è±¡åˆ›å»º
        æ¥å£ç»Ÿä¸€
      å•ä¾‹æ¨¡å¼
        å…¨å±€çŠ¶æ€
        èµ„æºç®¡ç†
      å»ºé€ è€…æ¨¡å¼
        å¤æ‚å¯¹è±¡æ„å»º
        é…ç½®æ„å»º
    ç»“æ„å‹æ¨¡å¼
      é€‚é…å™¨æ¨¡å¼
        VFSé€‚é…å™¨
        å¹³å°é€‚é…
        æ¥å£è½¬æ¢
      è£…é¥°å™¨æ¨¡å¼
        åŠŸèƒ½æ‰©å±•
        è¡Œä¸ºå¢å¼º
      å¤–è§‚æ¨¡å¼
        APIç®€åŒ–
        æ¥å£ç»Ÿä¸€
    è¡Œä¸ºå‹æ¨¡å¼
      ç­–ç•¥æ¨¡å¼
        ç®—æ³•é€‰æ‹©
        å¯æ›¿æ¢æ€§
        é…ç½®åŒ–
      è§‚å¯Ÿè€…æ¨¡å¼
        äº‹ä»¶é€šçŸ¥
        å›è°ƒæœºåˆ¶
      æ¨¡æ¿æ–¹æ³•æ¨¡å¼
        ç®—æ³•éª¨æ¶
        æ­¥éª¤å®šä¹‰
      çŠ¶æ€æ¨¡å¼
        çŠ¶æ€è½¬æ¢
        è¡Œä¸ºå˜åŒ–
    æ¶æ„æ¨¡å¼
      åˆ†å±‚æ¶æ„
        èŒè´£åˆ†ç¦»
        å±‚æ¬¡äº¤äº’
      ç®¡é“è¿‡æ»¤å™¨
        æ•°æ®æµ
        å¤„ç†ç®¡é“
      æ¨¡å—åŒ–
        æ¨¡å—åˆ’åˆ†
        æ¥å£å®šä¹‰
```

---

## 4. åˆ›å»ºå‹æ¨¡å¼

### 4.1. å·¥å‚æ¨¡å¼

**å·¥å‚æ¨¡å¼åº”ç”¨**ï¼š

SQLiteä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºVFSã€æ•°æ®åº“è¿æ¥ç­‰å¯¹è±¡ã€‚

**VFSå·¥å‚**ï¼š

```c
// VFSå·¥å‚æ¥å£
sqlite3_vfs *sqlite3_vfs_find(const char *zVfsName);
int sqlite3_vfs_register(sqlite3_vfs *pVfs, int makeDflt);

// ä½¿ç”¨ç¤ºä¾‹
sqlite3_vfs *vfs = sqlite3_vfs_find("unix");  // æŸ¥æ‰¾VFS
sqlite3_vfs_register(custom_vfs, 1);          // æ³¨å†ŒVFS
```

**æ•°æ®åº“å·¥å‚**ï¼š

```c
// æ•°æ®åº“åˆ›å»ºå·¥å‚
int sqlite3_open_v2(
    const char *filename,
    sqlite3 **ppDb,
    int flags,
    const char *zVfs  // VFSå·¥å‚å‚æ•°
);

// ä½¿ç”¨ç¤ºä¾‹
sqlite3 *db;
sqlite3_open_v2("test.db", &db, SQLITE_OPEN_READWRITE, "unix");
```

**æ¨¡å¼ä¼˜åŠ¿**ï¼š

- âœ… å¯¹è±¡åˆ›å»ºç»Ÿä¸€
- âœ… æ¥å£æŠ½è±¡
- âœ… æ˜“äºæ‰©å±•
- âœ… è§£è€¦åˆ›å»ºé€»è¾‘

### 4.2. å•ä¾‹æ¨¡å¼

**å•ä¾‹æ¨¡å¼åº”ç”¨**ï¼š

SQLiteä½¿ç”¨å•ä¾‹æ¨¡å¼ç®¡ç†å…¨å±€çŠ¶æ€å’Œèµ„æºã€‚

**å…¨å±€çŠ¶æ€å•ä¾‹**ï¼š

```c
// å…¨å±€é”™è¯¯å¤„ç†
static sqlite3GlobalConfig gConfig = {
    // å…¨å±€é…ç½®
};

// è·å–å…¨å±€é…ç½®ï¼ˆå•ä¾‹ï¼‰
sqlite3_config(SQLITE_CONFIG_MULTITHREAD, ...);
```

**æ¨¡å¼ä¼˜åŠ¿**ï¼š

- âœ… å…¨å±€çŠ¶æ€ç®¡ç†
- âœ… èµ„æºç»Ÿä¸€ç®¡ç†
- âœ… é¿å…é‡å¤åˆå§‹åŒ–

### 4.3. å»ºé€ è€…æ¨¡å¼

**å»ºé€ è€…æ¨¡å¼åº”ç”¨**ï¼š

SQLiteä½¿ç”¨å»ºé€ è€…æ¨¡å¼æ„å»ºå¤æ‚çš„SQLè¯­å¥å’ŒæŸ¥è¯¢è®¡åˆ’ã€‚

**æŸ¥è¯¢è®¡åˆ’æ„å»º**ï¼š

```c
// æŸ¥è¯¢è®¡åˆ’æ„å»ºå™¨
typedef struct Select Select;
Select *sqlite3SelectNew(
    Parse *pParse,        // è§£æå™¨
    ExprList *pEList,     // é€‰æ‹©åˆ—è¡¨
    SrcList *pSrc,        // æ•°æ®æº
    Expr *pWhere,         // WHEREæ¡ä»¶
    ExprList *pGroupBy,   // GROUP BY
    Expr *pHaving,        // HAVING
    ExprList *pOrderBy,   // ORDER BY
    Expr *pLimit,         // LIMIT
    Expr *pOffset         // OFFSET
);
```

**æ¨¡å¼ä¼˜åŠ¿**ï¼š

- âœ… å¤æ‚å¯¹è±¡æ„å»º
- âœ… æ„å»ºè¿‡ç¨‹æ¸…æ™°
- âœ… å‚æ•°å¯é€‰

---

## 5. ç»“æ„å‹æ¨¡å¼

### 5.1. é€‚é…å™¨æ¨¡å¼

**é€‚é…å™¨æ¨¡å¼åº”ç”¨**ï¼š

SQLiteä½¿ç”¨é€‚é…å™¨æ¨¡å¼é€‚é…ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿå’Œå¹³å°ã€‚

**VFSé€‚é…å™¨**ï¼š

```c
// VFSé€‚é…å™¨æ¥å£
typedef struct sqlite3_vfs sqlite3_vfs;
struct sqlite3_vfs {
    int iVersion;
    int szOsFile;
    int mxPathname;
    sqlite3_vfs *pNext;
    const char *zName;
    void *pAppData;
    int (*xOpen)(sqlite3_vfs*, const char *zName, sqlite3_file*, int, int *);
    int (*xDelete)(sqlite3_vfs*, const char *zName, int);
    // ... æ›´å¤šé€‚é…æ–¹æ³•
};

// Unix VFSé€‚é…å™¨
static sqlite3_vfs unixVfs = {
    .xOpen = unixOpen,
    .xDelete = unixDelete,
    // ... é€‚é…Unixç³»ç»Ÿè°ƒç”¨
};

// Windows VFSé€‚é…å™¨
static sqlite3_vfs winVfs = {
    .xOpen = winOpen,
    .xDelete = winDelete,
    // ... é€‚é…Windows API
};
```

**æ¨¡å¼ä¼˜åŠ¿**ï¼š

- âœ… å¹³å°é€‚é…
- âœ… æ¥å£ç»Ÿä¸€
- âœ… æ˜“äºæ‰©å±•

### 5.2. è£…é¥°å™¨æ¨¡å¼

**è£…é¥°å™¨æ¨¡å¼åº”ç”¨**ï¼š

SQLiteä½¿ç”¨è£…é¥°å™¨æ¨¡å¼æ‰©å±•åŠŸèƒ½ã€‚

**åŠŸèƒ½è£…é¥°å™¨**ï¼š

```c
// åŠ å¯†è£…é¥°å™¨
int sqlite3_key(sqlite3 *db, const void *pKey, int nKey);

// å‹ç¼©è£…é¥°å™¨
int sqlite3_compress_extension(...);

// å®¡è®¡è£…é¥°å™¨
void sqlite3_audit_hook(
    sqlite3 *db,
    int (*xAudit)(void*,int,const char*,const char*,const char*),
    void *pArg
);
```

**æ¨¡å¼ä¼˜åŠ¿**ï¼š

- âœ… åŠŸèƒ½æ‰©å±•
- âœ… åŠ¨æ€æ·»åŠ åŠŸèƒ½
- âœ… ä¸ä¿®æ”¹åŸæœ‰ä»£ç 

### 5.3. å¤–è§‚æ¨¡å¼

**å¤–è§‚æ¨¡å¼åº”ç”¨**ï¼š

SQLiteçš„C APIä½œä¸ºå¤–è§‚ï¼Œç®€åŒ–å¤æ‚çš„å†…éƒ¨æ“ä½œã€‚

**APIå¤–è§‚**ï¼š

```c
// ç®€å•çš„å¤–è§‚æ¥å£
int sqlite3_exec(
    sqlite3 *db,                    // æ•°æ®åº“
    const char *sql,                // SQLè¯­å¥
    int (*callback)(void*,int,char**,char**),  // å›è°ƒ
    void *arg,                      // ç”¨æˆ·æ•°æ®
    char **errmsg                   // é”™è¯¯æ¶ˆæ¯
);

// å†…éƒ¨å®ç°ï¼ˆå¤æ‚ï¼‰
// sqlite3_exec å†…éƒ¨è°ƒç”¨ï¼š
//   1. sqlite3_prepare_v2()
//   2. sqlite3_step()
//   3. sqlite3_finalize()
//   4. é”™è¯¯å¤„ç†
//   5. èµ„æºç®¡ç†
```

**æ¨¡å¼ä¼˜åŠ¿**ï¼š

- âœ… ç®€åŒ–æ¥å£
- âœ… éšè—å¤æ‚æ€§
- âœ… æ˜“äºä½¿ç”¨

---

## 6. è¡Œä¸ºå‹æ¨¡å¼

### 6.1. ç­–ç•¥æ¨¡å¼

**ç­–ç•¥æ¨¡å¼åº”ç”¨**ï¼š

SQLiteä½¿ç”¨ç­–ç•¥æ¨¡å¼é€‰æ‹©ä¸åŒçš„ç®—æ³•å’Œå®ç°ã€‚

**åŒæ­¥ç­–ç•¥**ï¼š

```c
// åŒæ­¥ç­–ç•¥é€‰æ‹©
PRAGMA synchronous = FULL | NORMAL | OFF;

// å†…éƒ¨å®ç°
switch(syncMode) {
    case FULL:
        // å®Œå…¨åŒæ­¥ç­–ç•¥
        sqlite3OsSync(pFile, SQLITE_SYNC_FULL);
        break;
    case NORMAL:
        // æ­£å¸¸åŒæ­¥ç­–ç•¥
        sqlite3OsSync(pFile, SQLITE_SYNC_NORMAL);
        break;
    case OFF:
        // å…³é—­åŒæ­¥ç­–ç•¥
        // ä¸æ‰§è¡ŒåŒæ­¥
        break;
}
```

**æ—¥å¿—æ¨¡å¼ç­–ç•¥**ï¼š

```c
// æ—¥å¿—æ¨¡å¼ç­–ç•¥
PRAGMA journal_mode = DELETE | WAL | MEMORY | TRUNCATE | PERSIST | OFF;

// ç­–ç•¥å®ç°
typedef struct {
    const char *zMode;
    int eMode;
    int (*xOpen)(sqlite3_vfs*, const char*, sqlite3_file*, int, int*);
} JournalMode;

static JournalMode journalModes[] = {
    {"delete", SQLITE_JOURNALMODE_DELETE, deleteOpen},
    {"wal", SQLITE_JOURNALMODE_WAL, walOpen},
    {"memory", SQLITE_JOURNALMODE_MEMORY, memOpen},
    // ...
};
```

**æ¨¡å¼ä¼˜åŠ¿**ï¼š

- âœ… ç®—æ³•å¯æ›¿æ¢
- âœ… é…ç½®çµæ´»
- âœ… æ˜“äºæ‰©å±•

### 6.2. è§‚å¯Ÿè€…æ¨¡å¼

**è§‚å¯Ÿè€…æ¨¡å¼åº”ç”¨**ï¼š

SQLiteä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼å¤„ç†äº‹ä»¶å’Œå›è°ƒã€‚

**è¿›åº¦è§‚å¯Ÿè€…**ï¼š

```c
// è¿›åº¦å›è°ƒï¼ˆè§‚å¯Ÿè€…ï¼‰
void sqlite3_progress_handler(
    sqlite3 *db,
    int nOps,
    int (*xProgress)(void*),
    void *pArg
);

// ä½¿ç”¨ç¤ºä¾‹
sqlite3_progress_handler(db, 1000, progress_callback, NULL);

int progress_callback(void *arg) {
    // è§‚å¯Ÿè€…å¤„ç†é€»è¾‘
    return 0;  // è¿”å›é0å–æ¶ˆæ“ä½œ
}
```

**æäº¤é’©å­ï¼ˆè§‚å¯Ÿè€…ï¼‰**ï¼š

```c
// æäº¤é’©å­ï¼ˆè§‚å¯Ÿè€…ï¼‰
void *sqlite3_commit_hook(
    sqlite3 *db,
    int (*xCallback)(void*),
    void *pArg
);

// ä½¿ç”¨ç¤ºä¾‹
sqlite3_commit_hook(db, commit_callback, NULL);

int commit_callback(void *arg) {
    // è§‚å¯Ÿè€…å¤„ç†é€»è¾‘
    return 0;  // è¿”å›é0å›æ»šäº‹åŠ¡
}
```

**æ¨¡å¼ä¼˜åŠ¿**ï¼š

- âœ… äº‹ä»¶é€šçŸ¥
- âœ… è§£è€¦è§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿè€…
- âœ… æ”¯æŒå¤šä¸ªè§‚å¯Ÿè€…

### 6.3. æ¨¡æ¿æ–¹æ³•æ¨¡å¼

**æ¨¡æ¿æ–¹æ³•æ¨¡å¼åº”ç”¨**ï¼š

SQLiteä½¿ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼å®šä¹‰ç®—æ³•éª¨æ¶ã€‚

**æŸ¥è¯¢æ‰§è¡Œæ¨¡æ¿**ï¼š

```c
// æŸ¥è¯¢æ‰§è¡Œæ¨¡æ¿æ–¹æ³•
int sqlite3_exec_template(sqlite3 *db, const char *sql) {
    // 1. å‡†å¤‡é˜¶æ®µï¼ˆæ¨¡æ¿æ–¹æ³•ï¼‰
    sqlite3_prepare_v2(db, sql, -1, &stmt, NULL);

    // 2. æ‰§è¡Œé˜¶æ®µï¼ˆæ¨¡æ¿æ–¹æ³•ï¼‰
    while (sqlite3_step(stmt) == SQLITE_ROW) {
        // å¤„ç†è¡Œï¼ˆå¯å®šåˆ¶ï¼‰
        process_row(stmt);
    }

    // 3. æ¸…ç†é˜¶æ®µï¼ˆæ¨¡æ¿æ–¹æ³•ï¼‰
    sqlite3_finalize(stmt);
}
```

**æ¨¡å¼ä¼˜åŠ¿**ï¼š

- âœ… ç®—æ³•éª¨æ¶å®šä¹‰
- âœ… æ­¥éª¤å¯å®šåˆ¶
- âœ… ä»£ç å¤ç”¨

### 6.4. çŠ¶æ€æ¨¡å¼

**çŠ¶æ€æ¨¡å¼åº”ç”¨**ï¼š

SQLiteä½¿ç”¨çŠ¶æ€æ¨¡å¼ç®¡ç†äº‹åŠ¡çŠ¶æ€å’Œé”çŠ¶æ€ã€‚

**äº‹åŠ¡çŠ¶æ€**ï¼š

```c
// äº‹åŠ¡çŠ¶æ€
typedef enum {
    TRANS_NONE,      // æ— äº‹åŠ¡
    TRANS_READ,      // è¯»äº‹åŠ¡
    TRANS_WRITE,     // å†™äº‹åŠ¡
    TRANS_EXCLUSIVE  // æ’ä»–äº‹åŠ¡
} TransactionState;

// çŠ¶æ€è½¬æ¢
int begin_transaction(sqlite3 *db, TransactionState state) {
    switch(state) {
        case TRANS_READ:
            return begin_read_transaction(db);
        case TRANS_WRITE:
            return begin_write_transaction(db);
        case TRANS_EXCLUSIVE:
            return begin_exclusive_transaction(db);
        default:
            return SQLITE_ERROR;
    }
}
```

**æ¨¡å¼ä¼˜åŠ¿**ï¼š

- âœ… çŠ¶æ€ç®¡ç†æ¸…æ™°
- âœ… çŠ¶æ€è½¬æ¢æ˜ç¡®
- âœ… è¡Œä¸ºéšçŠ¶æ€å˜åŒ–

---

## 7. æ¶æ„æ¨¡å¼

### 7.1. åˆ†å±‚æ¶æ„æ¨¡å¼

**åˆ†å±‚æ¶æ„**ï¼š

SQLiteé‡‡ç”¨äº”å±‚æ¶æ„æ¨¡å¼ã€‚

**æ¶æ„å±‚æ¬¡**ï¼š

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 5: SQL Interface              â”‚
â”‚  æ¨¡å¼ï¼šå¤–è§‚æ¨¡å¼                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 4: Compiler                   â”‚
â”‚  æ¨¡å¼ï¼šç®¡é“-è¿‡æ»¤å™¨æ¨¡å¼               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: Virtual Machine            â”‚
â”‚  æ¨¡å¼ï¼šè§£é‡Šå™¨æ¨¡å¼                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: Storage                    â”‚
â”‚  æ¨¡å¼ï¼šç­–ç•¥æ¨¡å¼                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: OS Interface               â”‚
â”‚  æ¨¡å¼ï¼šé€‚é…å™¨æ¨¡å¼                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¨¡å¼ä¼˜åŠ¿**ï¼š

- âœ… èŒè´£åˆ†ç¦»
- âœ… å±‚æ¬¡æ¸…æ™°
- âœ… æ˜“äºç»´æŠ¤

### 7.2. ç®¡é“-è¿‡æ»¤å™¨æ¨¡å¼

**ç®¡é“-è¿‡æ»¤å™¨æ¨¡å¼**ï¼š

SQLiteçš„ç¼–è¯‘è¿‡ç¨‹é‡‡ç”¨ç®¡é“-è¿‡æ»¤å™¨æ¨¡å¼ã€‚

**ç¼–è¯‘ç®¡é“**ï¼š

```text
SQLå­—ç¬¦ä¸²
    â†“
[Tokenizer]  â†’ Tokenæµ
    â†“
[Parser]     â†’ AST
    â†“
[CodeGenerator] â†’ å­—èŠ‚ç 
    â†“
[Optimizer]  â†’ ä¼˜åŒ–å­—èŠ‚ç 
    â†“
VDBEå­—èŠ‚ç 
```

**æ¨¡å¼ä¼˜åŠ¿**ï¼š

- âœ… å¤„ç†æ­¥éª¤æ¸…æ™°
- âœ… æ˜“äºæ‰©å±•
- âœ… æ˜“äºæµ‹è¯•

### 7.3. æ¨¡å—åŒ–æ¨¡å¼

**æ¨¡å—åŒ–æ¨¡å¼**ï¼š

SQLiteé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ã€‚

**æ¨¡å—åˆ’åˆ†**ï¼š

```text
Modules = {
  Tokenizer:      // è¯æ³•åˆ†ææ¨¡å—
  Parser:         // è¯­æ³•åˆ†ææ¨¡å—
  CodeGenerator:  // ä»£ç ç”Ÿæˆæ¨¡å—
  VDBE:           // è™šæ‹Ÿæœºæ¨¡å—
  BTree:          // B-Treeæ¨¡å—
  Pager:          // é¡µé¢ç®¡ç†æ¨¡å—
  VFS:            // æ–‡ä»¶ç³»ç»Ÿæ¨¡å—
}
```

**æ¨¡å¼ä¼˜åŠ¿**ï¼š

- âœ… é«˜å†…èš
- âœ… ä½è€¦åˆ
- âœ… æ˜“äºç»´æŠ¤

---

## 8. è®¾è®¡æ¨¡å¼æ€»ç»“

### 8.1. æ¨¡å¼åº”ç”¨æ€»ç»“

**åˆ›å»ºå‹æ¨¡å¼**ï¼š

- âœ… å·¥å‚æ¨¡å¼ï¼šVFSåˆ›å»ºã€æ•°æ®åº“åˆ›å»º
- âœ… å•ä¾‹æ¨¡å¼ï¼šå…¨å±€çŠ¶æ€ç®¡ç†
- âœ… å»ºé€ è€…æ¨¡å¼ï¼šæŸ¥è¯¢è®¡åˆ’æ„å»º

**ç»“æ„å‹æ¨¡å¼**ï¼š

- âœ… é€‚é…å™¨æ¨¡å¼ï¼šVFSé€‚é…ã€å¹³å°é€‚é…
- âœ… è£…é¥°å™¨æ¨¡å¼ï¼šåŠŸèƒ½æ‰©å±•
- âœ… å¤–è§‚æ¨¡å¼ï¼šAPIç®€åŒ–

**è¡Œä¸ºå‹æ¨¡å¼**ï¼š

- âœ… ç­–ç•¥æ¨¡å¼ï¼šç®—æ³•é€‰æ‹©
- âœ… è§‚å¯Ÿè€…æ¨¡å¼ï¼šäº‹ä»¶é€šçŸ¥
- âœ… æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼šç®—æ³•éª¨æ¶
- âœ… çŠ¶æ€æ¨¡å¼ï¼šçŠ¶æ€ç®¡ç†

**æ¶æ„æ¨¡å¼**ï¼š

- âœ… åˆ†å±‚æ¶æ„æ¨¡å¼
- âœ… ç®¡é“-è¿‡æ»¤å™¨æ¨¡å¼
- âœ… æ¨¡å—åŒ–æ¨¡å¼

### 8.2. æ¨¡å¼åº”ç”¨ä¼˜åŠ¿

**è®¾è®¡ä¼˜åŠ¿**ï¼š

- âœ… ä»£ç å¤ç”¨
- âœ… æ˜“äºç»´æŠ¤
- âœ… æ˜“äºæ‰©å±•
- âœ… è§£è€¦è®¾è®¡

### 8.3. æ¨¡å¼åº”ç”¨åœºæ™¯

**åº”ç”¨åœºæ™¯**ï¼š

- ç³»ç»Ÿæ¶æ„è®¾è®¡
- æ¨¡å—è®¾è®¡
- æ¥å£è®¾è®¡
- åŠŸèƒ½æ‰©å±•

### 8.4. è®¾è®¡æ¨¡å¼åº”ç”¨ä»£ç ç¤ºä¾‹

**å·¥å‚æ¨¡å¼åº”ç”¨**ï¼š

```python
import sqlite3

class DatabaseFactory:
    """æ•°æ®åº“å·¥å‚æ¨¡å¼"""

    @staticmethod
    def create_database(db_type='file', **kwargs):
        """åˆ›å»ºæ•°æ®åº“è¿æ¥"""
        if db_type == 'file':
            return sqlite3.connect(kwargs.get('filename', ':memory:'))
        elif db_type == 'memory':
            return sqlite3.connect(':memory:')
        elif db_type == 'temporary':
            return sqlite3.connect('')
        else:
            raise ValueError(f"Unknown database type: {db_type}")

# ä½¿ç”¨å·¥å‚æ¨¡å¼
db1 = DatabaseFactory.create_database('file', filename='test.db')
db2 = DatabaseFactory.create_database('memory')
db3 = DatabaseFactory.create_database('temporary')

print("âœ… å·¥å‚æ¨¡å¼åº”ç”¨ç¤ºä¾‹")
```

**ç­–ç•¥æ¨¡å¼åº”ç”¨**ï¼š

```python
import sqlite3

class SyncStrategy:
    """åŒæ­¥ç­–ç•¥æ¥å£"""
    def apply(self, conn):
        raise NotImplementedError

class FullSyncStrategy(SyncStrategy):
    """å®Œå…¨åŒæ­¥ç­–ç•¥"""
    def apply(self, conn):
        conn.execute('PRAGMA synchronous=FULL')
        print("åº”ç”¨å®Œå…¨åŒæ­¥ç­–ç•¥")

class NormalSyncStrategy(SyncStrategy):
    """æ­£å¸¸åŒæ­¥ç­–ç•¥"""
    def apply(self, conn):
        conn.execute('PRAGMA synchronous=NORMAL')
        print("åº”ç”¨æ­£å¸¸åŒæ­¥ç­–ç•¥")

class OffSyncStrategy(SyncStrategy):
    """å…³é—­åŒæ­¥ç­–ç•¥"""
    def apply(self, conn):
        conn.execute('PRAGMA synchronous=OFF')
        print("åº”ç”¨å…³é—­åŒæ­¥ç­–ç•¥")

class DatabaseConfig:
    """æ•°æ®åº“é…ç½®ï¼ˆä½¿ç”¨ç­–ç•¥æ¨¡å¼ï¼‰"""
    def __init__(self, sync_strategy: SyncStrategy):
        self.sync_strategy = sync_strategy

    def configure(self, conn):
        self.sync_strategy.apply(conn)

# ä½¿ç”¨ç­–ç•¥æ¨¡å¼
conn = sqlite3.connect(':memory:')
config = DatabaseConfig(FullSyncStrategy())
config.configure(conn)

print("âœ… ç­–ç•¥æ¨¡å¼åº”ç”¨ç¤ºä¾‹")
```

**è§‚å¯Ÿè€…æ¨¡å¼åº”ç”¨**ï¼š

```python
import sqlite3

class DatabaseObserver:
    """æ•°æ®åº“è§‚å¯Ÿè€…æ¥å£"""
    def on_commit(self, transaction_id):
        raise NotImplementedError

    def on_rollback(self, transaction_id):
        raise NotImplementedError

class LoggingObserver(DatabaseObserver):
    """æ—¥å¿—è§‚å¯Ÿè€…"""
    def on_commit(self, transaction_id):
        print(f"Transaction {transaction_id} committed")

    def on_rollback(self, transaction_id):
        print(f"Transaction {transaction_id} rolled back")

class AuditObserver(DatabaseObserver):
    """å®¡è®¡è§‚å¯Ÿè€…"""
    def on_commit(self, transaction_id):
        print(f"Audit: Transaction {transaction_id} committed")

    def on_rollback(self, transaction_id):
        print(f"Audit: Transaction {transaction_id} rolled back")

class ObservableDatabase:
    """å¯è§‚å¯Ÿçš„æ•°æ®åº“ï¼ˆè§‚å¯Ÿè€…æ¨¡å¼ï¼‰"""
    def __init__(self, conn):
        self.conn = conn
        self.observers = []
        self.transaction_id = 0

    def add_observer(self, observer: DatabaseObserver):
        self.observers.append(observer)

    def commit(self):
        self.transaction_id += 1
        self.conn.commit()
        for observer in self.observers:
            observer.on_commit(self.transaction_id)

    def rollback(self):
        self.transaction_id += 1
        self.conn.rollback()
        for observer in self.observers:
            observer.on_rollback(self.transaction_id)

# ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼
conn = sqlite3.connect(':memory:')
db = ObservableDatabase(conn)
db.add_observer(LoggingObserver())
db.add_observer(AuditObserver())

db.conn.execute('CREATE TABLE test (id INTEGER)')
db.commit()

print("âœ… è§‚å¯Ÿè€…æ¨¡å¼åº”ç”¨ç¤ºä¾‹")
```

**é€‚é…å™¨æ¨¡å¼åº”ç”¨**ï¼š

```python
import sqlite3

class VFSAdapter:
    """VFSé€‚é…å™¨æ¥å£"""
    def open(self, filename, flags):
        raise NotImplementedError

    def read(self, file, size, offset):
        raise NotImplementedError

    def write(self, file, data, offset):
        raise NotImplementedError

class UnixVFSAdapter(VFSAdapter):
    """Unix VFSé€‚é…å™¨"""
    def open(self, filename, flags):
        print(f"Unix: Opening {filename} with flags {flags}")
        return open(filename, 'rb+')

    def read(self, file, size, offset):
        file.seek(offset)
        return file.read(size)

    def write(self, file, data, offset):
        file.seek(offset)
        file.write(data)

class WindowsVFSAdapter(VFSAdapter):
    """Windows VFSé€‚é…å™¨"""
    def open(self, filename, flags):
        print(f"Windows: Opening {filename} with flags {flags}")
        return open(filename, 'rb+')

    def read(self, file, size, offset):
        file.seek(offset)
        return file.read(size)

    def write(self, file, data, offset):
        file.seek(offset)
        file.write(data)

# ä½¿ç”¨é€‚é…å™¨æ¨¡å¼
import platform
if platform.system() == 'Windows':
    vfs = WindowsVFSAdapter()
else:
    vfs = UnixVFSAdapter()

print("âœ… é€‚é…å™¨æ¨¡å¼åº”ç”¨ç¤ºä¾‹")
```

---

## 9. ğŸ”— ç›¸å…³èµ„æº

- [12.01 æ¶æ„è®¾è®¡æ¨¡å‹](./12.01-æ¶æ„è®¾è®¡æ¨¡å‹.md)
- [12.02 è®¾è®¡åŸåˆ™](./12.02-è®¾è®¡åŸåˆ™.md)
- [01.01 ç¼–è¯‘æ‰§è¡Œæ¨¡å‹](../01-æ ¸å¿ƒæ¶æ„/01.01-ç¼–è¯‘æ‰§è¡Œæ¨¡å‹.md)

---

## 10. ğŸ“š å‚è€ƒèµ„æ–™

- ã€Šè®¾è®¡æ¨¡å¼ï¼šå¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶çš„åŸºç¡€ã€‹
- ã€ŠHead Firstè®¾è®¡æ¨¡å¼ã€‹
- ã€Šè®¾è®¡æ¨¡å¼è§£æã€‹

---

**æœ€åæ›´æ–°**ï¼š2025-01-15
**ç»´æŠ¤è€…**ï¼šData-Science Team
