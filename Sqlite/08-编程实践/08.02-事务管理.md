# äº‹åŠ¡ç®¡ç†ï¼šæ‰¹é‡æ“ä½œä¸æ€§èƒ½ä¼˜åŒ–

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-11-13
> **æœ€åæ›´æ–°**ï¼š2025-11-13
> **ç‰ˆæœ¬**ï¼šSQLite 3.31+ è‡³ 3.47+

---

## ğŸ“‹ æ¦‚è¿°

äº‹åŠ¡ç®¡ç†æ˜¯SQLiteæ€§èƒ½ä¼˜åŒ–çš„å…³é”®ã€‚æœ¬æ–‡æ¡£æ·±å…¥è§£æäº‹åŠ¡æ§åˆ¶ã€æ‰¹é‡æ“ä½œä¼˜åŒ–å’ŒåµŒå¥—äº‹åŠ¡çš„ä½¿ç”¨ã€‚

---

## ğŸ“‘ ç›®å½•

- [äº‹åŠ¡ç®¡ç†ï¼šæ‰¹é‡æ“ä½œä¸æ€§èƒ½ä¼˜åŒ–](#äº‹åŠ¡ç®¡ç†æ‰¹é‡æ“ä½œä¸æ€§èƒ½ä¼˜åŒ–)
  - [ğŸ“‹ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¸€ã€åŸºæœ¬äº‹åŠ¡æ§åˆ¶](#ä¸€åŸºæœ¬äº‹åŠ¡æ§åˆ¶)
    - [1.1 BEGIN/COMMIT/ROLLBACK](#11-begincommitrollback)
    - [1.2 äº‹åŠ¡ç±»å‹](#12-äº‹åŠ¡ç±»å‹)
  - [äºŒã€æ‰¹é‡æ“ä½œä¼˜åŒ–](#äºŒæ‰¹é‡æ“ä½œä¼˜åŒ–)
    - [2.1 æ‰¹é‡æ’å…¥æ€§èƒ½å¯¹æ¯”](#21-æ‰¹é‡æ’å…¥æ€§èƒ½å¯¹æ¯”)
    - [2.2 æ‰¹é‡æ›´æ–°ä¼˜åŒ–](#22-æ‰¹é‡æ›´æ–°ä¼˜åŒ–)
    - [2.3 æ‰¹é‡æ“ä½œæœ€ä½³å®è·µ](#23-æ‰¹é‡æ“ä½œæœ€ä½³å®è·µ)
  - [ä¸‰ã€SAVEPOINTåµŒå¥—äº‹åŠ¡](#ä¸‰savepointåµŒå¥—äº‹åŠ¡)
    - [3.1 SAVEPOINTæ¦‚è¿°](#31-savepointæ¦‚è¿°)
    - [3.2 åº”ç”¨åœºæ™¯](#32-åº”ç”¨åœºæ™¯)
  - [å››ã€äº‹åŠ¡è¾¹ç•Œè®¾è®¡](#å››äº‹åŠ¡è¾¹ç•Œè®¾è®¡)
    - [4.1 äº‹åŠ¡ç²’åº¦](#41-äº‹åŠ¡ç²’åº¦)
    - [4.2 äº‹åŠ¡è¾¹ç•ŒåŸåˆ™](#42-äº‹åŠ¡è¾¹ç•ŒåŸåˆ™)
  - [äº”ã€äº‹åŠ¡æ€§èƒ½ä¼˜åŒ–](#äº”äº‹åŠ¡æ€§èƒ½ä¼˜åŒ–)
    - [5.1 æ‰¹é‡äº‹åŠ¡ä¼˜åŒ–](#51-æ‰¹é‡äº‹åŠ¡ä¼˜åŒ–)
    - [5.2 é¢„ç¼–è¯‘è¯­å¥](#52-é¢„ç¼–è¯‘è¯­å¥)
  - [å…­ã€äº‹åŠ¡é”™è¯¯å¤„ç†](#å…­äº‹åŠ¡é”™è¯¯å¤„ç†)
    - [6.1 é”™è¯¯ç å¤„ç†](#61-é”™è¯¯ç å¤„ç†)
    - [6.2 Pythoné”™è¯¯å¤„ç†](#62-pythoné”™è¯¯å¤„ç†)
  - [ä¸ƒã€äº‹åŠ¡æœ€ä½³å®è·µ](#ä¸ƒäº‹åŠ¡æœ€ä½³å®è·µ)
    - [7.1 äº‹åŠ¡è®¾è®¡åŸåˆ™](#71-äº‹åŠ¡è®¾è®¡åŸåˆ™)
    - [7.2 æ€§èƒ½ä¼˜åŒ–æ¸…å•](#72-æ€§èƒ½ä¼˜åŒ–æ¸…å•)
  - [ğŸ”— ç›¸å…³èµ„æº](#-ç›¸å…³èµ„æº)
  - [ğŸ“š å‚è€ƒèµ„æ–™](#-å‚è€ƒèµ„æ–™)

---

## ä¸€ã€åŸºæœ¬äº‹åŠ¡æ§åˆ¶

### 1.1 BEGIN/COMMIT/ROLLBACK

**åŸºæœ¬è¯­æ³•**ï¼š

```sql
-- å¼€å§‹äº‹åŠ¡
BEGIN TRANSACTION;

-- æ‰§è¡Œæ“ä½œ
INSERT INTO users (name, email) VALUES ('Alice', 'alice@example.com');
UPDATE accounts SET balance = balance - 100 WHERE user_id = 1;

-- æäº¤äº‹åŠ¡
COMMIT;

-- æˆ–å›æ»šäº‹åŠ¡
ROLLBACK;
```

**C API**ï¼š

```c
// å¼€å§‹äº‹åŠ¡
sqlite3_exec(db, "BEGIN TRANSACTION;", NULL, NULL, NULL);

// æ‰§è¡Œæ“ä½œ
sqlite3_exec(db, "INSERT INTO users ...", NULL, NULL, NULL);
sqlite3_exec(db, "UPDATE accounts ...", NULL, NULL, NULL);

// æäº¤æˆ–å›æ»š
int rc = sqlite3_exec(db, "COMMIT;", NULL, NULL, NULL);
if (rc != SQLITE_OK) {
    sqlite3_exec(db, "ROLLBACK;", NULL, NULL, NULL);
}
```

**Python API**ï¼š

```python
import sqlite3

conn = sqlite3.connect('app.db')
cursor = conn.cursor()

try:
    cursor.execute('BEGIN TRANSACTION')
    cursor.execute('INSERT INTO users ...')
    cursor.execute('UPDATE accounts ...')
    conn.commit()  # æäº¤äº‹åŠ¡
except sqlite3.Error:
    conn.rollback()  # å›æ»šäº‹åŠ¡
finally:
    conn.close()
```

### 1.2 äº‹åŠ¡ç±»å‹

**DEFERREDï¼ˆé»˜è®¤ï¼‰**ï¼š

```sql
-- å»¶è¿Ÿè·å–é”ï¼Œç›´åˆ°ç¬¬ä¸€æ¬¡å†™å…¥
BEGIN DEFERRED TRANSACTION;
```

**IMMEDIATE**ï¼š

```sql
-- ç«‹å³è·å–RESERVEDé”
BEGIN IMMEDIATE TRANSACTION;
```

**EXCLUSIVE**ï¼š

```sql
-- ç«‹å³è·å–EXCLUSIVEé”ï¼ˆé˜»å¡æ‰€æœ‰å…¶ä»–æ“ä½œï¼‰
BEGIN EXCLUSIVE TRANSACTION;
```

---

## äºŒã€æ‰¹é‡æ“ä½œä¼˜åŒ–

### 2.1 æ‰¹é‡æ’å…¥æ€§èƒ½å¯¹æ¯”

**æ–¹å¼1ï¼šæ— äº‹åŠ¡ï¼ˆæ…¢ï¼‰**ï¼š

```python
# âŒ æ…¢ï¼šæ¯æ¡æ’å…¥éƒ½æäº¤
for item in items:
    cursor.execute('INSERT INTO orders VALUES (?, ?, ?)', item)
    conn.commit()  # æ¯æ¬¡æäº¤

# æ€§èƒ½ï¼š1000æ¡æ’å…¥ ~5000ms
```

**æ–¹å¼2ï¼šå•äº‹åŠ¡ï¼ˆå¿«ï¼‰**ï¼š

```python
# âœ… å¿«ï¼šæ‰¹é‡æäº¤
cursor.execute('BEGIN TRANSACTION')
for item in items:
    cursor.execute('INSERT INTO orders VALUES (?, ?, ?)', item)
conn.commit()  # ä¸€æ¬¡æäº¤

# æ€§èƒ½ï¼š1000æ¡æ’å…¥ ~50msï¼ˆæå‡100å€ï¼‰
```

**æ–¹å¼3ï¼šexecutemanyï¼ˆæœ€å¿«ï¼‰**ï¼š

```python
# âœ… æœ€å¿«ï¼šä½¿ç”¨executemany
cursor.execute('BEGIN TRANSACTION')
cursor.executemany('INSERT INTO orders VALUES (?, ?, ?)', items)
conn.commit()

# æ€§èƒ½ï¼š1000æ¡æ’å…¥ ~20msï¼ˆæå‡250å€ï¼‰
```

### 2.2 æ‰¹é‡æ›´æ–°ä¼˜åŒ–

**æ‰¹é‡æ›´æ–°ç¤ºä¾‹**ï¼š

```python
# æ‰¹é‡æ›´æ–°çŠ¶æ€
cursor.execute('BEGIN TRANSACTION')
cursor.executemany(
    'UPDATE orders SET status = ? WHERE id = ?',
    [('shipped', 1), ('shipped', 2), ...]
)
conn.commit()
```

**æ‰¹é‡åˆ é™¤ä¼˜åŒ–**ï¼š

```sql
-- ä½¿ç”¨INå­å¥æ‰¹é‡åˆ é™¤
BEGIN TRANSACTION;
DELETE FROM orders WHERE id IN (1, 2, 3, ..., 1000);
COMMIT;

-- æ€§èƒ½ï¼šæ¯”é€æ¡åˆ é™¤å¿«100å€+
```

### 2.3 æ‰¹é‡æ“ä½œæœ€ä½³å®è·µ

**æ¨èæ¨¡å¼**ï¼š

```python
def batch_insert(conn, table, data_list, batch_size=1000):
    """æ‰¹é‡æ’å…¥æ•°æ®"""
    cursor = conn.cursor()

    try:
        cursor.execute('BEGIN TRANSACTION')

        # åˆ†æ‰¹æ’å…¥
        for i in range(0, len(data_list), batch_size):
            batch = data_list[i:i+batch_size]
            cursor.executemany(f'INSERT INTO {table} VALUES (?, ?, ?)', batch)

        conn.commit()
    except sqlite3.Error as e:
        conn.rollback()
        raise e
```

**æ€§èƒ½æ•°æ®**ï¼š

| æ–¹å¼ | 1000æ¡æ’å…¥è€—æ—¶ | æ€§èƒ½æå‡ |
|------|--------------|---------|
| æ— äº‹åŠ¡ | ~5000ms | åŸºå‡† |
| å•äº‹åŠ¡ | ~50ms | 100å€ |
| executemany | ~20ms | 250å€ |

---

## ä¸‰ã€SAVEPOINTåµŒå¥—äº‹åŠ¡

### 3.1 SAVEPOINTæ¦‚è¿°

**å®šä¹‰**ï¼šSAVEPOINTå…è®¸åœ¨äº‹åŠ¡å†…åˆ›å»ºåµŒå¥—çš„ä¿å­˜ç‚¹ï¼Œæ”¯æŒéƒ¨åˆ†å›æ»šã€‚

**è¯­æ³•**ï¼š

```sql
BEGIN TRANSACTION;

-- æ“ä½œ1
INSERT INTO users (name) VALUES ('Alice');
SAVEPOINT sp1;

-- æ“ä½œ2
INSERT INTO orders (user_id, amount) VALUES (1, 100);
SAVEPOINT sp2;

-- æ“ä½œ3
UPDATE accounts SET balance = balance - 100;

-- å›æ»šåˆ°sp2ï¼ˆä¿ç•™æ“ä½œ1å’Œæ“ä½œ2ï¼‰
ROLLBACK TO sp2;

-- æˆ–é‡Šæ”¾ä¿å­˜ç‚¹
RELEASE sp1;

COMMIT;
```

### 3.2 åº”ç”¨åœºæ™¯

**åœºæ™¯1ï¼šå¤æ‚ä¸šåŠ¡é€»è¾‘**ï¼š

```python
def process_order(conn, order_data):
    cursor = conn.cursor()

    try:
        cursor.execute('BEGIN TRANSACTION')

        # æ­¥éª¤1ï¼šåˆ›å»ºè®¢å•
        cursor.execute('INSERT INTO orders ...')
        order_id = cursor.lastrowid
        cursor.execute('SAVEPOINT sp_order')

        # æ­¥éª¤2ï¼šæ‰£å‡åº“å­˜
        for item in order_data['items']:
            cursor.execute(
                'UPDATE inventory SET quantity = quantity - ? WHERE product_id = ?',
                (item['qty'], item['product_id'])
            )
            # æ£€æŸ¥åº“å­˜
            if cursor.rowcount == 0:
                cursor.execute('ROLLBACK TO sp_order')
                raise ValueError('Insufficient inventory')

        # æ­¥éª¤3ï¼šæ‰£å‡ä½™é¢
        cursor.execute(
            'UPDATE accounts SET balance = balance - ? WHERE user_id = ?',
            (order_data['total'], order_data['user_id'])
        )

        conn.commit()
    except Exception:
        conn.rollback()
        raise
```

**åœºæ™¯2ï¼šæ•°æ®è¿ç§»**ï¼š

```python
def migrate_data(conn, source_data):
    cursor = conn.cursor()

    cursor.execute('BEGIN TRANSACTION')

    for batch in source_data:
        cursor.execute('SAVEPOINT sp_batch')
        try:
            # å¤„ç†ä¸€æ‰¹æ•°æ®
            process_batch(cursor, batch)
        except Exception:
            # å›æ»šå½“å‰æ‰¹æ¬¡ï¼Œç»§ç»­ä¸‹ä¸€æ‰¹æ¬¡
            cursor.execute('ROLLBACK TO sp_batch')
            continue

    conn.commit()
```

---

## å››ã€äº‹åŠ¡è¾¹ç•Œè®¾è®¡

### 4.1 äº‹åŠ¡ç²’åº¦

**ç»†ç²’åº¦äº‹åŠ¡ï¼ˆä¸æ¨èï¼‰**ï¼š

```python
# âŒ ä¸æ¨èï¼šäº‹åŠ¡å¤ªå°
def update_user(user_id, name):
    conn.execute('BEGIN')
    conn.execute('UPDATE users SET name = ? WHERE id = ?', (name, user_id))
    conn.commit()  # æ¯ä¸ªæ“ä½œä¸€ä¸ªäº‹åŠ¡
```

**ç²—ç²’åº¦äº‹åŠ¡ï¼ˆæ¨èï¼‰**ï¼š

```python
# âœ… æ¨èï¼šæ‰¹é‡æ“ä½œä¸€ä¸ªäº‹åŠ¡
def update_users(user_updates):
    conn.execute('BEGIN')
    for user_id, name in user_updates:
        conn.execute('UPDATE users SET name = ? WHERE id = ?', (name, user_id))
    conn.commit()  # æ‰¹é‡æ“ä½œä¸€ä¸ªäº‹åŠ¡
```

### 4.2 äº‹åŠ¡è¾¹ç•ŒåŸåˆ™

**åŸåˆ™1ï¼šä¸šåŠ¡é€»è¾‘å®Œæ•´æ€§**ï¼š

```python
# ä¸€ä¸ªä¸šåŠ¡æ“ä½œ = ä¸€ä¸ªäº‹åŠ¡
def transfer_money(from_account, to_account, amount):
    conn.execute('BEGIN')
    try:
        # æ‰£å‡æºè´¦æˆ·
        conn.execute('UPDATE accounts SET balance = balance - ? WHERE id = ?',
                    (amount, from_account))
        # å¢åŠ ç›®æ ‡è´¦æˆ·
        conn.execute('UPDATE accounts SET balance = balance + ? WHERE id = ?',
                    (amount, to_account))
        conn.commit()
    except:
        conn.rollback()
        raise
```

**åŸåˆ™2ï¼šæ€§èƒ½ä¼˜åŒ–**ï¼š

```python
# æ‰¹é‡æ“ä½œåˆå¹¶ä¸ºä¸€ä¸ªäº‹åŠ¡
def import_orders(orders):
    conn.execute('BEGIN')
    try:
        conn.executemany('INSERT INTO orders VALUES (?, ?, ?)', orders)
        conn.commit()
    except:
        conn.rollback()
        raise
```

---

## äº”ã€äº‹åŠ¡æ€§èƒ½ä¼˜åŒ–

### 5.1 æ‰¹é‡äº‹åŠ¡ä¼˜åŒ–

**ä¼˜åŒ–å‰**ï¼š

```python
# æ…¢ï¼šæ¯ä¸ªæ“ä½œä¸€ä¸ªäº‹åŠ¡
for order in orders:
    conn.execute('BEGIN')
    conn.execute('INSERT INTO orders ...', order)
    conn.commit()
# è€—æ—¶ï¼š~5000msï¼ˆ1000æ¡ï¼‰
```

**ä¼˜åŒ–å**ï¼š

```python
# å¿«ï¼šæ‰¹é‡æ“ä½œä¸€ä¸ªäº‹åŠ¡
conn.execute('BEGIN')
conn.executemany('INSERT INTO orders ...', orders)
conn.commit()
# è€—æ—¶ï¼š~20msï¼ˆ1000æ¡ï¼Œæå‡250å€ï¼‰
```

### 5.2 é¢„ç¼–è¯‘è¯­å¥

**ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥æå‡æ€§èƒ½**ï¼š

```c
// C APIï¼šé¢„ç¼–è¯‘è¯­å¥
sqlite3_stmt* stmt;
sqlite3_prepare_v2(db, "INSERT INTO users (name, email) VALUES (?, ?)", -1, &stmt, NULL);

// æ‰¹é‡æ’å…¥
for (int i = 0; i < count; i++) {
    sqlite3_bind_text(stmt, 1, names[i], -1, SQLITE_STATIC);
    sqlite3_bind_text(stmt, 2, emails[i], -1, SQLITE_STATIC);
    sqlite3_step(stmt);
    sqlite3_reset(stmt);  // é‡ç½®è¯­å¥ï¼Œå‡†å¤‡ä¸‹æ¬¡ä½¿ç”¨
}

sqlite3_finalize(stmt);
```

**Pythoné¢„ç¼–è¯‘**ï¼š

```python
# é¢„ç¼–è¯‘è¯­å¥
stmt = conn.prepare('INSERT INTO users (name, email) VALUES (?, ?)')

# æ‰¹é‡æ’å…¥
for name, email in users:
    stmt.execute(name, email)
```

---

## å…­ã€äº‹åŠ¡é”™è¯¯å¤„ç†

### 6.1 é”™è¯¯ç å¤„ç†

**SQLiteé”™è¯¯ç **ï¼š

| é”™è¯¯ç  | è¯´æ˜ | å¤„ç†æ–¹å¼ |
|--------|------|---------|
| SQLITE_OK | æˆåŠŸ | ç»§ç»­ |
| SQLITE_BUSY | æ•°æ®åº“è¢«é”å®š | é‡è¯•æˆ–ç­‰å¾… |
| SQLITE_LOCKED | è¡¨è¢«é”å®š | é‡è¯• |
| SQLITE_CONSTRAINT | çº¦æŸè¿å | å›æ»šå¹¶æŠ¥å‘Šé”™è¯¯ |
| SQLITE_ERROR | SQLé”™è¯¯ | å›æ»šå¹¶æŠ¥å‘Šé”™è¯¯ |

**é”™è¯¯å¤„ç†ç¤ºä¾‹**ï¼š

```c
int rc = sqlite3_exec(db, "INSERT INTO ...", NULL, NULL, NULL);

if (rc == SQLITE_BUSY) {
    // æ•°æ®åº“è¢«é”å®šï¼Œç­‰å¾…åé‡è¯•
    usleep(100000);  // ç­‰å¾…100ms
    rc = sqlite3_exec(db, "INSERT INTO ...", NULL, NULL, NULL);
} else if (rc == SQLITE_CONSTRAINT) {
    // çº¦æŸè¿åï¼Œå›æ»š
    sqlite3_exec(db, "ROLLBACK;", NULL, NULL, NULL);
    fprintf(stderr, "Constraint violation: %s\n", sqlite3_errmsg(db));
}
```

### 6.2 Pythoné”™è¯¯å¤„ç†

```python
import sqlite3

try:
    conn.execute('BEGIN')
    conn.execute('INSERT INTO users ...')
    conn.commit()
except sqlite3.IntegrityError as e:
    # çº¦æŸè¿å
    conn.rollback()
    print(f"Integrity error: {e}")
except sqlite3.OperationalError as e:
    # æ“ä½œé”™è¯¯ï¼ˆå¦‚é”å®šï¼‰
    conn.rollback()
    print(f"Operational error: {e}")
except sqlite3.Error as e:
    # å…¶ä»–æ•°æ®åº“é”™è¯¯
    conn.rollback()
    print(f"Database error: {e}")
```

---

## ä¸ƒã€äº‹åŠ¡æœ€ä½³å®è·µ

### 7.1 äº‹åŠ¡è®¾è®¡åŸåˆ™

1. **æ‰¹é‡æ“ä½œ**ï¼šå°†å¤šä¸ªæ“ä½œåˆå¹¶ä¸ºä¸€ä¸ªäº‹åŠ¡
2. **ä¸šåŠ¡å®Œæ•´æ€§**ï¼šä¸€ä¸ªä¸šåŠ¡æ“ä½œ = ä¸€ä¸ªäº‹åŠ¡
3. **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œå›æ»šæœºåˆ¶
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨executemanyå’Œé¢„ç¼–è¯‘è¯­å¥

### 7.2 æ€§èƒ½ä¼˜åŒ–æ¸…å•

- âœ… ä½¿ç”¨æ‰¹é‡äº‹åŠ¡ï¼ˆæ€§èƒ½æå‡10-250å€ï¼‰
- âœ… ä½¿ç”¨executemanyï¼ˆæ¯”å¾ªç¯æ’å…¥å¿«ï¼‰
- âœ… ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥ï¼ˆå‡å°‘è§£æå¼€é”€ï¼‰
- âœ… å¯ç”¨WALæ¨¡å¼ï¼ˆæ”¯æŒå¹¶å‘ï¼‰
- âœ… è®¾ç½®åˆé€‚çš„synchronousï¼ˆNORMALå¹³è¡¡æ€§èƒ½å’Œå®‰å…¨ï¼‰

---

## ğŸ”— ç›¸å…³èµ„æº

- [08.01 è¿æ¥ç®¡ç†](./08.01-è¿æ¥ç®¡ç†.md)
- [08.03 æŸ¥è¯¢ä¼˜åŒ–](./08.03-æŸ¥è¯¢ä¼˜åŒ–.md)
- [01.02 äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶](../01-æ ¸å¿ƒæ¶æ„/01.02-äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶.md)

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [SQLiteäº‹åŠ¡æ–‡æ¡£](https://www.sqlite.org/lang_transaction.html)
- [SQLiteæ€§èƒ½ä¼˜åŒ–](https://www.sqlite.org/performance.html)
- [æ‰¹é‡æ“ä½œæœ€ä½³å®è·µ](https://www.sqlite.org/faq.html#q19)

---

**æœ€åæ›´æ–°**ï¼š2025-11-13
**ç»´æŠ¤è€…**ï¼šData-Science Team
