# SQLiteå¤šçº¿ç¨‹å¹¶å‘æ¨¡å¼æœ€ä½³å®è·µ

> **åˆ›å»ºæ—¥æœŸ**: 2025-12-04
> **ç‰ˆæœ¬**: SQLite 3.47.x
> **éš¾åº¦**: â­â­â­â­â­

---

## ğŸ“‘ ç›®å½•

- [SQLiteå¤šçº¿ç¨‹å¹¶å‘æ¨¡å¼æœ€ä½³å®è·µ](#sqliteå¤šçº¿ç¨‹å¹¶å‘æ¨¡å¼æœ€ä½³å®è·µ)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [å¹¶å‘æ¨¡å¼æ€»è§ˆ](#å¹¶å‘æ¨¡å¼æ€»è§ˆ)
  - [æ¨¡å¼1ï¼šè¿æ¥æ± æ¨¡å¼ï¼ˆæ¨èï¼‰](#æ¨¡å¼1è¿æ¥æ± æ¨¡å¼æ¨è)
    - [æ¶æ„](#æ¶æ„)
    - [Pythonå®ç°](#pythonå®ç°)
  - [æ¨¡å¼2ï¼šè¯»å†™åˆ†ç¦»æ¨¡å¼](#æ¨¡å¼2è¯»å†™åˆ†ç¦»æ¨¡å¼)
    - [æ¶æ„](#æ¶æ„-1)
    - [Pythonå®ç°](#pythonå®ç°-1)
  - [æ¨¡å¼3ï¼šäº‹åŠ¡é˜Ÿåˆ—æ¨¡å¼](#æ¨¡å¼3äº‹åŠ¡é˜Ÿåˆ—æ¨¡å¼)
    - [æ¶æ„](#æ¶æ„-2)
    - [Pythonå®ç°](#pythonå®ç°-2)
  - [æ­»é”é¢„é˜²](#æ­»é”é¢„é˜²)
    - [BUSYè¶…æ—¶ä¸é‡è¯•](#busyè¶…æ—¶ä¸é‡è¯•)
  - [ğŸ”— äº¤å‰å¼•ç”¨](#-äº¤å‰å¼•ç”¨)
    - [æ ¸å¿ƒæ¶æ„æ–‡æ¡£](#æ ¸å¿ƒæ¶æ„æ–‡æ¡£)
    - [ç¼–ç¨‹å®è·µæ–‡æ¡£](#ç¼–ç¨‹å®è·µæ–‡æ¡£)
    - [æ€§èƒ½ä¼˜åŒ–æ–‡æ¡£ ğŸ†•](#æ€§èƒ½ä¼˜åŒ–æ–‡æ¡£-)
    - [çŸ¥è¯†å›¾è°±ä¸å¯¼èˆª ğŸ†•](#çŸ¥è¯†å›¾è°±ä¸å¯¼èˆª-)
    - [ç›¸å…³æ¦‚å¿µé“¾æ¥ ğŸ†•](#ç›¸å…³æ¦‚å¿µé“¾æ¥-)
      - [å¤šçº¿ç¨‹å¹¶å‘æ¦‚å¿µ](#å¤šçº¿ç¨‹å¹¶å‘æ¦‚å¿µ)

## å¹¶å‘æ¨¡å¼æ€»è§ˆ

```text
SQLiteä¸‰ç§çº¿ç¨‹æ¨¡å¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. å•çº¿ç¨‹æ¨¡å¼ï¼ˆSingle-Threadï¼‰
   â€¢ SQLITE_CONFIG_SINGLETHREAD
   â€¢ ç¦ç”¨æ‰€æœ‰äº’æ–¥é”
   â€¢ æœ€å¿«ï¼Œä½†ä¸çº¿ç¨‹å®‰å…¨

2. å¤šçº¿ç¨‹æ¨¡å¼ï¼ˆMulti-Threadï¼‰
   â€¢ SQLITE_CONFIG_MULTITHREAD
   â€¢ é»˜è®¤æ¨¡å¼
   â€¢ è¿æ¥ä¸èƒ½è·¨çº¿ç¨‹å…±äº«

3. ä¸²è¡ŒåŒ–æ¨¡å¼ï¼ˆSerializedï¼‰
   â€¢ SQLITE_CONFIG_SERIALIZED
   â€¢ è¿æ¥å¯è·¨çº¿ç¨‹å…±äº«
   â€¢ è‡ªåŠ¨åŠ é”ï¼Œæœ€å®‰å…¨

æ£€æµ‹å½“å‰æ¨¡å¼ï¼š
  SELECT sqlite_threadsafe();
  -- è¿”å›: 0=å•çº¿ç¨‹, 1=ä¸²è¡ŒåŒ–, 2=å¤šçº¿ç¨‹
```

---

## æ¨¡å¼1ï¼šè¿æ¥æ± æ¨¡å¼ï¼ˆæ¨èï¼‰

### æ¶æ„

```text
è¿æ¥æ± æ¶æ„
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Application                    â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚Thread 1â”‚  â”‚Thread 2â”‚  â”‚Thread 3â”‚   â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â”‚
â”‚      â”‚           â”‚           â”‚         â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                  â”‚                     â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚          â”‚ Connection Poolâ”‚             â”‚
â”‚          â”‚ (Queue-based)  â”‚             â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                  â”‚                     â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚       â”‚          â”‚          â”‚         â”‚
â”‚   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”     â”‚
â”‚   â”‚Conn 1 â”‚  â”‚Conn 2â”‚  â”‚Conn 3â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                  â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
            â”‚   app.db    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Pythonå®ç°

```python
import sqlite3
import threading
from queue import Queue, Empty
from contextlib import contextmanager
import time

class SQLiteConnectionPool:
    """SQLiteè¿æ¥æ± """

    def __init__(self, db_path, pool_size=5, timeout=30):
        self.db_path = db_path
        self.pool_size = pool_size
        self.timeout = timeout
        self.pool = Queue(maxsize=pool_size)
        self._lock = threading.Lock()
        self._created_connections = 0

        # é¢„åˆ›å»ºè¿æ¥
        self._init_pool()

    def _init_pool(self):
        """åˆå§‹åŒ–è¿æ¥æ± """
        for _ in range(self.pool_size):
            conn = self._create_connection()
            self.pool.put(conn)

    def _create_connection(self):
        """åˆ›å»ºæ–°è¿æ¥"""
        conn = sqlite3.connect(
            self.db_path,
            check_same_thread=False,  # å…è®¸è·¨çº¿ç¨‹
            timeout=self.timeout
        )

        # é…ç½®ä¼˜åŒ–
        conn.execute('PRAGMA journal_mode=WAL')
        conn.execute('PRAGMA synchronous=NORMAL')
        conn.execute('PRAGMA cache_size=-64000')
        conn.execute('PRAGMA temp_store=MEMORY')
        conn.execute('PRAGMA foreign_keys=ON')

        # è®¾ç½®è¡Œå·¥å‚ï¼ˆè¿”å›å­—å…¸ï¼‰
        conn.row_factory = sqlite3.Row

        self._created_connections += 1
        return conn

    @contextmanager
    def get_connection(self):
        """è·å–è¿æ¥ï¼ˆä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼‰"""
        conn = None
        try:
            # ä»æ± ä¸­è·å–è¿æ¥
            conn = self.pool.get(timeout=self.timeout)
            yield conn
        except Empty:
            raise TimeoutError("æ— æ³•ä»è¿æ¥æ± è·å–è¿æ¥")
        finally:
            # å½’è¿˜è¿æ¥
            if conn:
                self.pool.put(conn)

    def execute_query(self, sql, params=()):
        """æ‰§è¡ŒæŸ¥è¯¢"""
        with self.get_connection() as conn:
            cursor = conn.execute(sql, params)
            return [dict(row) for row in cursor.fetchall()]

    def execute_write(self, sql, params=()):
        """æ‰§è¡Œå†™æ“ä½œ"""
        with self.get_connection() as conn:
            cursor = conn.execute(sql, params)
            conn.commit()
            return cursor.lastrowid

    def execute_many(self, sql, params_list):
        """æ‰¹é‡æ‰§è¡Œ"""
        with self.get_connection() as conn:
            cursor = conn.executemany(sql, params_list)
            conn.commit()
            return cursor.rowcount

    def close_all(self):
        """å…³é—­æ‰€æœ‰è¿æ¥"""
        while not self.pool.empty():
            try:
                conn = self.pool.get_nowait()
                conn.close()
            except Empty:
                break

# å…¨å±€è¿æ¥æ± 
pool = SQLiteConnectionPool('app.db', pool_size=10)

# ä½¿ç”¨ç¤ºä¾‹
def worker_thread(thread_id):
    """å·¥ä½œçº¿ç¨‹"""
    for i in range(100):
        # è¯»å–
        users = pool.execute_query('SELECT * FROM users LIMIT 10')
        print(f"Thread {thread_id}: è¯»å– {len(users)} ç”¨æˆ·")

        # å†™å…¥
        user_id = pool.execute_write(
            'INSERT INTO users (name, email) VALUES (?, ?)',
            (f'User_{thread_id}_{i}', f'user_{thread_id}_{i}@example.com')
        )
        print(f"Thread {thread_id}: åˆ›å»ºç”¨æˆ· {user_id}")

        time.sleep(0.01)

# å¤šçº¿ç¨‹æµ‹è¯•
threads = [
    threading.Thread(target=worker_thread, args=(i,))
    for i in range(5)
]

for t in threads:
    t.start()

for t in threads:
    t.join()

pool.close_all()
```

---

## æ¨¡å¼2ï¼šè¯»å†™åˆ†ç¦»æ¨¡å¼

### æ¶æ„

```text
è¯»å†™åˆ†ç¦»æ¶æ„ï¼ˆWALæ¨¡å¼ï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Application                         â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Write Threadâ”‚          â”‚ Read Threads â”‚  â”‚
â”‚  â”‚   (1ä¸ª)     â”‚          â”‚    (Nä¸ª)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â”‚                         â”‚          â”‚
â”‚        â”‚ INSERT/UPDATE/DELETE    â”‚ SELECT   â”‚
â”‚        â”‚                         â”‚          â”‚
â”‚   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ Writer  â”‚              â”‚  Readers  â”‚   â”‚
â”‚   â”‚Connectionâ”‚            â”‚ Connectionsâ”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â”‚
â”‚        â”‚                         â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                         â”‚
         â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ WAL Modeâ”‚â—„â”€â”€â”€â”€â”€â”€â”˜
                 â”‚  app.db â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰¹ç‚¹:
â€¢ Writer: ç‹¬å å†™è¿æ¥
â€¢ Readers: å¤šä¸ªåªè¯»è¿æ¥ï¼Œå¹¶å‘è¯»å–
â€¢ WALæ¨¡å¼æ”¯æŒè¯»å†™å¹¶å‘
```

### Pythonå®ç°

```python
import sqlite3
import threading
from queue import Queue

class ReadWriteSeparation:
    """è¯»å†™åˆ†ç¦»æ•°æ®åº“"""

    def __init__(self, db_path, read_pool_size=5):
        self.db_path = db_path

        # å†™è¿æ¥ï¼ˆå•ä¾‹ï¼‰
        self.write_conn = None
        self.write_lock = threading.Lock()
        self._init_writer()

        # è¯»è¿æ¥æ± 
        self.read_pool = Queue(maxsize=read_pool_size)
        for _ in range(read_pool_size):
            self.read_pool.put(self._create_reader())

    def _init_writer(self):
        """åˆå§‹åŒ–å†™è¿æ¥"""
        self.write_conn = sqlite3.connect(
            self.db_path,
            check_same_thread=False
        )
        self.write_conn.execute('PRAGMA journal_mode=WAL')
        self.write_conn.execute('PRAGMA synchronous=NORMAL')
        self.write_conn.row_factory = sqlite3.Row

    def _create_reader(self):
        """åˆ›å»ºåªè¯»è¿æ¥"""
        conn = sqlite3.connect(
            f'file:{self.db_path}?mode=ro',  # åªè¯»æ¨¡å¼
            uri=True,
            check_same_thread=False
        )
        conn.row_factory = sqlite3.Row
        return conn

    def read(self, sql, params=()):
        """è¯»æ“ä½œï¼ˆä»è¯»è¿æ¥æ± ï¼‰"""
        conn = self.read_pool.get()
        try:
            cursor = conn.execute(sql, params)
            return [dict(row) for row in cursor.fetchall()]
        finally:
            self.read_pool.put(conn)

    def write(self, sql, params=()):
        """å†™æ“ä½œï¼ˆç‹¬å å†™è¿æ¥ï¼‰"""
        with self.write_lock:
            cursor = self.write_conn.execute(sql, params)
            self.write_conn.commit()
            return cursor.lastrowid

    def transaction(self, operations):
        """äº‹åŠ¡ï¼ˆå¤šä¸ªå†™æ“ä½œï¼‰"""
        with self.write_lock:
            try:
                self.write_conn.execute('BEGIN')
                results = []
                for sql, params in operations:
                    cursor = self.write_conn.execute(sql, params)
                    results.append(cursor.lastrowid)
                self.write_conn.commit()
                return results
            except Exception:
                self.write_conn.rollback()
                raise

# ä½¿ç”¨ç¤ºä¾‹
db = ReadWriteSeparation('app.db', read_pool_size=10)

def read_worker():
    """è¯»çº¿ç¨‹"""
    for _ in range(1000):
        users = db.read('SELECT * FROM users LIMIT 10')
        print(f"è¯»å–: {len(users)} ç”¨æˆ·")

def write_worker():
    """å†™çº¿ç¨‹"""
    for i in range(100):
        user_id = db.write(
            'INSERT INTO users (name) VALUES (?)',
            (f'User_{i}',)
        )
        print(f"åˆ›å»º: {user_id}")

# å¤šä¸ªè¯»çº¿ç¨‹ + 1ä¸ªå†™çº¿ç¨‹
readers = [threading.Thread(target=read_worker) for _ in range(5)]
writer = threading.Thread(target=write_worker)

for t in readers + [writer]:
    t.start()
for t in readers + [writer]:
    t.join()
```

---

## æ¨¡å¼3ï¼šäº‹åŠ¡é˜Ÿåˆ—æ¨¡å¼

### æ¶æ„

```text
äº‹åŠ¡é˜Ÿåˆ—æ¶æ„
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Application                    â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚Thread 1â”‚  â”‚Thread 2â”‚  â”‚Thread 3â”‚   â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â”‚
â”‚      â”‚           â”‚           â”‚         â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                  â”‚                     â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚          â”‚ Write Queue   â”‚             â”‚
â”‚          â”‚  (çº¿ç¨‹å®‰å…¨)    â”‚             â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                  â”‚                     â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚          â”‚ Writer Thread â”‚             â”‚
â”‚          â”‚  (å•ä¸€çº¿ç¨‹)    â”‚             â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                  â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
            â”‚   app.db    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰¹ç‚¹:
â€¢ æ‰€æœ‰å†™æ“ä½œæ’é˜Ÿ
â€¢ å•çº¿ç¨‹å¤„ç†å†™è¯·æ±‚
â€¢ æ¶ˆé™¤å†™å†²çª
```

### Pythonå®ç°

```python
import sqlite3
import threading
from queue import Queue
from dataclasses import dataclass
from typing import Any, Tuple

@dataclass
class WriteTask:
    """å†™ä»»åŠ¡"""
    sql: str
    params: Tuple
    result_queue: Queue  # ç”¨äºè¿”å›ç»“æœ

class TransactionQueue:
    """äº‹åŠ¡é˜Ÿåˆ—"""

    def __init__(self, db_path):
        self.db_path = db_path
        self.write_queue = Queue()
        self.conn = None
        self.running = False

        # å¯åŠ¨å†™çº¿ç¨‹
        self.writer_thread = threading.Thread(target=self._writer_loop, daemon=True)
        self.writer_thread.start()

    def _writer_loop(self):
        """å†™çº¿ç¨‹å¾ªç¯"""
        self.conn = sqlite3.connect(self.db_path)
        self.conn.execute('PRAGMA journal_mode=WAL')
        self.conn.row_factory = sqlite3.Row
        self.running = True

        while self.running:
            try:
                task = self.write_queue.get(timeout=1)
                self._execute_task(task)
            except:
                continue

    def _execute_task(self, task: WriteTask):
        """æ‰§è¡Œå†™ä»»åŠ¡"""
        try:
            cursor = self.conn.execute(task.sql, task.params)
            self.conn.commit()
            task.result_queue.put(('success', cursor.lastrowid))
        except Exception as e:
            task.result_queue.put(('error', str(e)))

    def write(self, sql, params=(), timeout=30):
        """å¼‚æ­¥å†™å…¥ï¼ˆç­‰å¾…ç»“æœï¼‰"""
        result_queue = Queue()
        task = WriteTask(sql, params, result_queue)

        # æäº¤ä»»åŠ¡
        self.write_queue.put(task)

        # ç­‰å¾…ç»“æœ
        status, result = result_queue.get(timeout=timeout)
        if status == 'error':
            raise Exception(result)
        return result

    def write_async(self, sql, params=()):
        """å¼‚æ­¥å†™å…¥ï¼ˆä¸ç­‰å¾…ç»“æœï¼‰"""
        result_queue = Queue()
        task = WriteTask(sql, params, result_queue)
        self.write_queue.put(task)

    def read(self, sql, params=()):
        """è¯»æ“ä½œï¼ˆç›´æ¥æ‰§è¡Œï¼‰"""
        conn = sqlite3.connect(f'file:{self.db_path}?mode=ro', uri=True)
        conn.row_factory = sqlite3.Row
        cursor = conn.execute(sql, params)
        results = [dict(row) for row in cursor.fetchall()]
        conn.close()
        return results

    def stop(self):
        """åœæ­¢å†™çº¿ç¨‹"""
        self.running = False
        self.writer_thread.join()
        if self.conn:
            self.conn.close()

# ä½¿ç”¨ç¤ºä¾‹
tq = TransactionQueue('app.db')

def worker(worker_id):
    """å·¥ä½œçº¿ç¨‹"""
    for i in range(100):
        # å†™å…¥ï¼ˆåŒæ­¥ï¼‰
        user_id = tq.write(
            'INSERT INTO users (name) VALUES (?)',
            (f'User_{worker_id}_{i}',)
        )
        print(f"Worker {worker_id}: åˆ›å»ºç”¨æˆ· {user_id}")

        # è¯»å–
        users = tq.read('SELECT * FROM users LIMIT 5')
        print(f"Worker {worker_id}: è¯»å– {len(users)} ç”¨æˆ·")

# å¤šçº¿ç¨‹
threads = [threading.Thread(target=worker, args=(i,)) for i in range(5)]
for t in threads:
    t.start()
for t in threads:
    t.join()

tq.stop()
```

---

## æ­»é”é¢„é˜²

### BUSYè¶…æ—¶ä¸é‡è¯•

```python
import sqlite3
import time
import random

def execute_with_retry(conn, sql, params=(), max_retries=5):
    """å¸¦é‡è¯•çš„æ‰§è¡Œ"""
    for attempt in range(max_retries):
        try:
            cursor = conn.execute(sql, params)
            conn.commit()
            return cursor.lastrowid
        except sqlite3.OperationalError as e:
            if 'database is locked' in str(e):
                if attempt < max_retries - 1:
                    # æŒ‡æ•°é€€é¿
                    wait_time = (2 ** attempt) * 0.1 + random.uniform(0, 0.1)
                    print(f"æ•°æ®åº“é”å®šï¼Œç­‰å¾…{wait_time:.2f}ç§’åé‡è¯•...")
                    time.sleep(wait_time)
                else:
                    raise
            else:
                raise

# ä½¿ç”¨
conn = sqlite3.connect('app.db', timeout=30)  # 30ç§’è¶…æ—¶
execute_with_retry(conn, 'INSERT INTO users (name) VALUES (?)', ('Alice',))
```

---

## ğŸ”— äº¤å‰å¼•ç”¨

### æ ¸å¿ƒæ¶æ„æ–‡æ¡£

- â­â­â­ [äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶](../01-æ ¸å¿ƒæ¶æ„/01.02-äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶.md) - å¹¶å‘æ§åˆ¶åŸºç¡€ï¼ˆå«è®ºè¯è„‰ç»œå’Œæ­£åä¾‹ï¼‰
- â­â­ [æ ¸å¿ƒæœºåˆ¶å…¨æ™¯å›¾](../01-æ ¸å¿ƒæ¶æ„/01.05-SQLiteæ ¸å¿ƒæœºåˆ¶å…¨æ™¯å›¾-å¤šç»´åº¦æ•´åˆåˆ†æ.md) - å¹¶å‘æœºåˆ¶æ•´åˆåˆ†æ

### ç¼–ç¨‹å®è·µæ–‡æ¡£

- â­â­â­ [è¿æ¥ç®¡ç†](./08.01-è¿æ¥ç®¡ç†.md) - è¿æ¥ç®¡ç†å®è·µï¼ˆå«äº¤å‰å¼•ç”¨ï¼‰
- â­â­â­ [äº‹åŠ¡ç®¡ç†](./08.02-äº‹åŠ¡ç®¡ç†.md) - äº‹åŠ¡ç®¡ç†å®è·µï¼ˆå«äº¤å‰å¼•ç”¨ï¼‰
- â­â­ [é«˜çº§ç¼–ç¨‹æ¨¡å¼](./08.11-SQLiteé«˜çº§ç¼–ç¨‹æ¨¡å¼.md) - é«˜çº§ç¼–ç¨‹æ¨¡å¼ï¼ˆå«è®ºè¯è„‰ç»œï¼‰

### æ€§èƒ½ä¼˜åŒ–æ–‡æ¡£ ğŸ†•

- â­â­ [æ€§èƒ½ç‰¹å¾åˆ†æ](../03-æ€§èƒ½ä¼˜åŒ–/03.01-æ€§èƒ½ç‰¹å¾åˆ†æ.md) - å¹¶å‘æ€§èƒ½åˆ†æï¼ˆå«å†³ç­–æ ‘ï¼‰
- â­â­ [ä¼˜åŒ–ç­–ç•¥](../03-æ€§èƒ½ä¼˜åŒ–/03.02-ä¼˜åŒ–ç­–ç•¥.md) - å¹¶å‘ä¼˜åŒ–ç­–ç•¥ï¼ˆå«è®ºè¯è„‰ç»œï¼‰

### çŸ¥è¯†å›¾è°±ä¸å¯¼èˆª ğŸ†•

- â­â­â­ [çŸ¥è¯†å›¾è°±ä¸æ¦‚å¿µå…³ç³»ç½‘ç»œ](../09-æœ€æ–°ç‰¹æ€§/09.03-SQLiteçŸ¥è¯†å›¾è°±ä¸æ¦‚å¿µå…³ç³»ç½‘ç»œ.md) - å¤šçº¿ç¨‹å¹¶å‘æ¦‚å¿µå…³ç³»ï¼ˆ400+æ¦‚å¿µï¼‰
- â­â­ [æ–‡æ¡£ä¾èµ–å…³ç³»å›¾](../00-é¡¹ç›®å¯¼èˆª/06-æ–‡æ¡£ä¾èµ–å…³ç³»å›¾.md) - å¤šçº¿ç¨‹å¹¶å‘æ–‡æ¡£ä¾èµ–
- â­â­ [æœ¯è¯­æ ‡å‡†åŒ–è¯å…¸](../00-é¡¹ç›®å¯¼èˆª/03-æœ¯è¯­è¯å…¸/SQLiteæœ¯è¯­æ ‡å‡†åŒ–è¯å…¸.md) - å¤šçº¿ç¨‹å¹¶å‘æœ¯è¯­ç´¢å¼•

### ç›¸å…³æ¦‚å¿µé“¾æ¥ ğŸ†•

#### å¤šçº¿ç¨‹å¹¶å‘æ¦‚å¿µ

- **å¤šçº¿ç¨‹å¹¶å‘** â†’ [çŸ¥è¯†å›¾è°±ï¼šå¹¶å‘æ§åˆ¶æ¦‚å¿µ](../09-æœ€æ–°ç‰¹æ€§/09.03-SQLiteçŸ¥è¯†å›¾è°±ä¸æ¦‚å¿µå…³ç³»ç½‘ç»œ.md#æ ¸å¿ƒæœ¬ä½“äº‹åŠ¡ä¸å¹¶å‘)
- **WALå¹¶å‘è¯»** â†’ [å®šç†ï¼šC6-WALå¹¶å‘è¯»](../06-å½¢å¼åŒ–ç†è®º/06.06-SQLiteå®šç†ä¾èµ–å…³ç³»å›¾è°±.md#c6-walå¹¶å‘è¯»)
- **æ­»é”é¢„é˜²** â†’ [å®šç†ï¼šC7-æ­»é”é¢„é˜²](../06-å½¢å¼åŒ–ç†è®º/06.06-SQLiteå®šç†ä¾èµ–å…³ç³»å›¾è°±.md#c7-æ­»é”é¢„é˜²)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0.0
**æœ€åæ›´æ–°**: 2025-12-05
