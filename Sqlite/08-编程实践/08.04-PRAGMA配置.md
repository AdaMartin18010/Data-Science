# PRAGMA配置：性能与安全调优

> **创建日期**：2025-11-13
> **最后更新**：2025-11-13
> **版本**：SQLite 3.31+ 至 3.47+

---

## 📋 概述

PRAGMA是SQLite的配置命令，用于控制数据库行为。本文档深入解析各种PRAGMA配置的使用场景和最佳实践。

---

## 📑 目录

- [PRAGMA配置：性能与安全调优](#pragma配置性能与安全调优)
  - [📋 概述](#-概述)
  - [📑 目录](#-目录)
  - [一、日志模式配置（journal\_mode）](#一日志模式配置journal_mode)
    - [1.1 DELETE模式（默认）](#11-delete模式默认)
    - [1.2 WAL模式（推荐）](#12-wal模式推荐)
    - [1.3 MEMORY模式](#13-memory模式)
    - [1.4 模式选择指南](#14-模式选择指南)
  - [二、同步模式配置（synchronous）](#二同步模式配置synchronous)
    - [2.1 FULL模式（最安全）](#21-full模式最安全)
    - [2.2 NORMAL模式（推荐）](#22-normal模式推荐)
    - [2.3 OFF模式（最快，不推荐）](#23-off模式最快不推荐)
  - [三、缓存配置](#三缓存配置)
    - [3.1 cache\_size（页缓存大小）](#31-cache_size页缓存大小)
    - [3.2 temp\_store（临时表存储）](#32-temp_store临时表存储)
    - [3.3 mmap\_size（内存映射大小）](#33-mmap_size内存映射大小)
  - [四、外键与完整性](#四外键与完整性)
    - [4.1 foreign\_keys（外键约束）](#41-foreign_keys外键约束)
    - [4.2 integrity\_check（完整性检查）](#42-integrity_check完整性检查)
  - [五、WAL模式配置](#五wal模式配置)
    - [5.1 wal\_autocheckpoint（自动Checkpoint）](#51-wal_autocheckpoint自动checkpoint)
    - [5.2 wal\_checkpoint（手动Checkpoint）](#52-wal_checkpoint手动checkpoint)
  - [六、性能优化配置](#六性能优化配置)
    - [6.1 optimize（查询优化器提示）](#61-optimize查询优化器提示)
    - [6.2 query\_only（只读模式）](#62-query_only只读模式)
    - [6.3 threads（线程数）](#63-threads线程数)
  - [七、PRAGMA配置最佳实践](#七pragma配置最佳实践)
    - [7.1 生产环境配置](#71-生产环境配置)
    - [7.2 开发环境配置](#72-开发环境配置)
    - [7.3 性能测试配置](#73-性能测试配置)
  - [🔗 相关资源](#-相关资源)
  - [📚 参考资料](#-参考资料)

---

## 一、日志模式配置（journal_mode）

### 1.1 DELETE模式（默认）

**配置**：

```sql
PRAGMA journal_mode=DELETE;
```

**特点**：

- 使用回滚日志文件
- 写操作需要两次磁盘写入
- 读操作可能阻塞写提交

**适用场景**：

- 金融等高可靠性场景
- 需要最强一致性保证

### 1.2 WAL模式（推荐）

**配置**：

```sql
PRAGMA journal_mode=WAL;
```

**特点**：

- 使用预写日志（Write-Ahead Logging）
- 写操作只需一次磁盘写入
- 读不阻塞写，支持一写多读

**性能提升**：

- 写性能提升2-3倍
- 并发读性能显著提升

**适用场景**：

- 大多数应用场景（推荐）
- 读密集型应用
- 移动应用、IoT设备

### 1.3 MEMORY模式

**配置**：

```sql
PRAGMA journal_mode=MEMORY;
```

**特点**：

- 日志存储在内存中
- 崩溃时可能丢失数据
- 性能最快

**适用场景**：

- 临时数据库
- 测试环境
- 可以接受数据丢失的场景

### 1.4 模式选择指南

| 模式 | 性能 | 安全性 | 适用场景 |
|------|------|--------|---------|
| DELETE | 中等 | 最高 | 金融、高可靠性 |
| WAL | 最高 | 高 | 大多数应用（推荐） |
| MEMORY | 最高 | 最低 | 临时、测试 |

---

## 二、同步模式配置（synchronous）

### 2.1 FULL模式（最安全）

**配置**：

```sql
PRAGMA synchronous=FULL;
```

**特点**：

- 每次写入后执行fsync
- 最高数据安全性
- 性能较慢

**适用场景**：

- 金融系统
- 关键数据存储

### 2.2 NORMAL模式（推荐）

**配置**：

```sql
PRAGMA synchronous=NORMAL;
```

**特点**：

- 关键操作执行fsync
- 平衡性能和安全
- 推荐用于大多数场景

**适用场景**：

- 大多数生产环境（推荐）
- 一般应用

### 2.3 OFF模式（最快，不推荐）

**配置**：

```sql
PRAGMA synchronous=OFF;
```

**特点**：

- 不执行fsync
- 性能最快
- 崩溃可能丢失数据

**适用场景**：

- 临时数据库
- 测试环境
- 可以接受数据丢失的场景

---

## 三、缓存配置

### 3.1 cache_size（页缓存大小）

**配置**：

```sql
-- 设置缓存大小为64MB（负值表示KB）
PRAGMA cache_size=-64000;

-- 查看当前缓存大小
PRAGMA cache_size;
```

**默认值**：-2000（2MB）

**推荐值**：

- 小数据库：-2000（2MB）
- 中等数据库：-16000（16MB）
- 大数据库：-64000（64MB）或更大

**性能影响**：

- 缓存越大，查询性能越好
- 但占用更多内存

### 3.2 temp_store（临时表存储）

**配置**：

```sql
-- 临时表存储在内存中（推荐）
PRAGMA temp_store=MEMORY;

-- 临时表存储在磁盘上
PRAGMA temp_store=FILE;
```

**推荐**：`MEMORY`（性能更好）

### 3.3 mmap_size（内存映射大小）

**配置**：

```sql
-- 设置内存映射大小为256MB
PRAGMA mmap_size=268435456;
```

**特点**：

- 使用内存映射文件
- 减少内存复制
- 提升大文件读取性能

**适用场景**：

- 大数据库文件
- 读密集型应用

---

## 四、外键与完整性

### 4.1 foreign_keys（外键约束）

**配置**：

```sql
-- 启用外键约束
PRAGMA foreign_keys=ON;

-- 检查是否启用
PRAGMA foreign_keys;
```

**重要**：默认关闭，需要显式启用

**示例**：

```sql
-- 启用外键
PRAGMA foreign_keys=ON;

-- 创建表
CREATE TABLE orders (
    id INTEGER PRIMARY KEY,
    user_id INTEGER,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 尝试插入无效外键（会失败）
INSERT INTO orders (user_id) VALUES (999);  -- 错误：外键约束违反
```

### 4.2 integrity_check（完整性检查）

**配置**：

```sql
-- 检查数据库完整性
PRAGMA integrity_check;

-- 快速检查
PRAGMA quick_check;
```

**用途**：

- 检查数据库损坏
- 定期维护检查

---

## 五、WAL模式配置

### 5.1 wal_autocheckpoint（自动Checkpoint）

**配置**：

```sql
-- 当WAL文件达到1000页时自动Checkpoint
PRAGMA wal_autocheckpoint=1000;

-- 查看当前设置
PRAGMA wal_autocheckpoint;
```

**默认值**：1000页

**推荐值**：

- 小数据库：1000
- 大数据库：10000或更大

### 5.2 wal_checkpoint（手动Checkpoint）

**配置**：

```sql
-- 手动Checkpoint（非阻塞）
PRAGMA wal_checkpoint;

-- 完全Checkpoint（阻塞直到完成）
PRAGMA wal_checkpoint(FULL);

-- 截断Checkpoint（尽可能截断WAL文件）
PRAGMA wal_checkpoint(TRUNCATE);
```

**使用场景**：

- 定期维护
- 应用关闭时
- 需要减少WAL文件大小时

---

## 六、性能优化配置

### 6.1 optimize（查询优化器提示）

**配置**：

```sql
-- 提示优化器分析表和索引
PRAGMA optimize;

-- 分析特定表
PRAGMA optimize('users');
```

**用途**：

- 更新统计信息
- 优化查询计划选择

### 6.2 query_only（只读模式）

**配置**：

```sql
-- 启用只读模式
PRAGMA query_only=ON;
```

**特点**：

- 禁止所有写操作
- 提升查询性能
- 适合备份、分析场景

### 6.3 threads（线程数）

**配置**：

```sql
-- 设置线程数（实验性）
PRAGMA threads=4;
```

**注意**：SQLite 3.38.0+实验性功能

---

## 七、PRAGMA配置最佳实践

### 7.1 生产环境配置

**推荐配置**：

```sql
-- 日志模式：WAL（性能最优）
PRAGMA journal_mode=WAL;

-- 同步模式：NORMAL（平衡性能和安全）
PRAGMA synchronous=NORMAL;

-- 缓存大小：根据数据库大小调整
PRAGMA cache_size=-64000;  -- 64MB

-- 临时表：内存存储
PRAGMA temp_store=MEMORY;

-- 外键：启用
PRAGMA foreign_keys=ON;

-- WAL自动Checkpoint
PRAGMA wal_autocheckpoint=1000;
```

### 7.2 开发环境配置

**推荐配置**：

```sql
-- 日志模式：WAL
PRAGMA journal_mode=WAL;

-- 同步模式：NORMAL
PRAGMA synchronous=NORMAL;

-- 缓存大小：较小
PRAGMA cache_size=-2000;  -- 2MB

-- 外键：启用（便于测试）
PRAGMA foreign_keys=ON;
```

### 7.3 性能测试配置

**推荐配置**：

```sql
-- 日志模式：WAL
PRAGMA journal_mode=WAL;

-- 同步模式：OFF（最快，仅测试）
PRAGMA synchronous=OFF;

-- 缓存大小：大
PRAGMA cache_size=-128000;  -- 128MB

-- 临时表：内存
PRAGMA temp_store=MEMORY;
```

---

## 🔗 相关资源

- [08.01 连接管理](./08.01-连接管理.md)
- [08.02 事务管理](./08.02-事务管理.md)
- [01.02 事务与并发控制](../01-核心架构/01.02-事务与并发控制.md)

---

## 📚 参考资料

- [SQLite PRAGMA文档](https://www.sqlite.org/pragma.html)
- [WAL模式文档](https://www.sqlite.org/wal.html)
- [性能优化指南](https://www.sqlite.org/performance.html)

---

**最后更新**：2025-11-13
**维护者**：Data-Science Team
