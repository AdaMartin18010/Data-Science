# SQLite Pythonä½¿ç”¨æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-11-13
> **æœ€åæ›´æ–°**ï¼š2025-01-15
> **ç‰ˆæœ¬**ï¼šPython 3.7+ï¼ŒSQLite 3.31+ è‡³ 3.47.x
> **é€‚ç”¨åº“**ï¼šsqlite3ï¼ˆæ ‡å‡†åº“ï¼‰ã€aiosqliteã€sqlalchemy

---

## 1. ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›SQLiteåœ¨Pythonä¸­çš„å®Œæ•´ä½¿ç”¨æŒ‡å—ï¼ŒåŒ…æ‹¬æ ‡å‡†åº“sqlite3ã€å¼‚æ­¥åº“aiosqliteå’ŒORMæ¡†æ¶SQLAlchemyçš„ä½¿ç”¨æ–¹æ³•ã€‚

---

## 1. ğŸ“‘ ç›®å½•

- [SQLite Pythonä½¿ç”¨æŒ‡å—](#sqlite-pythonä½¿ç”¨æŒ‡å—)
  - [1. ğŸ“‹ æ¦‚è¿°](#1--æ¦‚è¿°)
  - [1. ğŸ“‘ ç›®å½•](#1--ç›®å½•)
  - [3. ğŸ“Š æ€ç»´å¯¼å›¾](#3--æ€ç»´å¯¼å›¾)
  - [4. æ ‡å‡†åº“sqlite3](#4-æ ‡å‡†åº“sqlite3)
    - [4.1. åŸºæœ¬è¿æ¥](#41-åŸºæœ¬è¿æ¥)
  - [5. åŸºæœ¬æ“ä½œ](#5-åŸºæœ¬æ“ä½œ)
  - [6. äº‹åŠ¡ç®¡ç†](#6-äº‹åŠ¡ç®¡ç†)
  - [7. é¢„ç¼–è¯‘è¯­å¥](#7-é¢„ç¼–è¯‘è¯­å¥)
  - [8. ä¸Šä¸‹æ–‡ç®¡ç†å™¨](#8-ä¸Šä¸‹æ–‡ç®¡ç†å™¨)
  - [9. å¼‚æ­¥åº“aiosqlite](#9-å¼‚æ­¥åº“aiosqlite)
    - [9.1. å¼‚æ­¥è¿æ¥](#91-å¼‚æ­¥è¿æ¥)
  - [10. å¼‚æ­¥æ“ä½œ](#10-å¼‚æ­¥æ“ä½œ)
  - [11. å¼‚æ­¥äº‹åŠ¡](#11-å¼‚æ­¥äº‹åŠ¡)
  - [12. ORMæ¡†æ¶SQLAlchemy](#12-ormæ¡†æ¶sqlalchemy)
    - [12.1. SQLAlchemy Core](#121-sqlalchemy-core)
  - [13. SQLAlchemy ORM](#13-sqlalchemy-orm)
  - [14. æ¨¡å‹å®šä¹‰](#14-æ¨¡å‹å®šä¹‰)
  - [15. é«˜çº§ç‰¹æ€§](#15-é«˜çº§ç‰¹æ€§)
    - [15.1. è‡ªå®šä¹‰å‡½æ•°](#151-è‡ªå®šä¹‰å‡½æ•°)
    - [15.2. è‡ªå®šä¹‰èšåˆå‡½æ•°](#152-è‡ªå®šä¹‰èšåˆå‡½æ•°)
    - [15.3. è¡Œå·¥å‚ï¼ˆRow Factoryï¼‰](#153-è¡Œå·¥å‚row-factory)
  - [16. è¿æ¥æ± ](#16-è¿æ¥æ± )
  - [17. æ€§èƒ½ä¼˜åŒ–](#17-æ€§èƒ½ä¼˜åŒ–)
    - [17.1. æ‰¹é‡æ“ä½œ](#171-æ‰¹é‡æ“ä½œ)
  - [18. ç´¢å¼•ä¼˜åŒ–](#18-ç´¢å¼•ä¼˜åŒ–)
  - [19. WALæ¨¡å¼é…ç½®](#19-walæ¨¡å¼é…ç½®)
  - [20. Pythonåº“å¤šç»´å¯¹æ¯”çŸ©é˜µ](#20-pythonåº“å¤šç»´å¯¹æ¯”çŸ©é˜µ)
    - [20.1. Python SQLiteåº“å¯¹æ¯”çŸ©é˜µ](#201-python-sqliteåº“å¯¹æ¯”çŸ©é˜µ)
    - [20.2. Pythonä½¿ç”¨æ–¹å¼å¯¹æ¯”çŸ©é˜µ](#202-pythonä½¿ç”¨æ–¹å¼å¯¹æ¯”çŸ©é˜µ)
    - [20.3. Pythonæœ€ä½³å®è·µå¯¹æ¯”çŸ©é˜µ](#203-pythonæœ€ä½³å®è·µå¯¹æ¯”çŸ©é˜µ)
  - [21. æœ€ä½³å®è·µ](#21-æœ€ä½³å®è·µ)
    - [21.1. è¿æ¥ç®¡ç†](#211-è¿æ¥ç®¡ç†)
  - [22. é”™è¯¯å¤„ç†](#22-é”™è¯¯å¤„ç†)
    - [22.1. çº¿ç¨‹å®‰å…¨](#221-çº¿ç¨‹å®‰å…¨)
  - [23. ğŸ”— ç›¸å…³èµ„æº](#23--ç›¸å…³èµ„æº)
  - [24. ğŸ”— äº¤å‰å¼•ç”¨](#24--äº¤å‰å¼•ç”¨)
    - [24.1. ç†è®ºæ¨¡å‹ ğŸ†•](#241-ç†è®ºæ¨¡å‹-)
    - [24.2. è®¾è®¡æ¨¡å‹ ğŸ†•](#242-è®¾è®¡æ¨¡å‹-)
  - [25. ğŸ“š å‚è€ƒèµ„æ–™](#25--å‚è€ƒèµ„æ–™)

---

## 3. ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((Pythonä½¿ç”¨æŒ‡å—))
    æ ‡å‡†åº“sqlite3
      åŸºæœ¬è¿æ¥
        connectå‡½æ•°
        å†…å­˜æ•°æ®åº“
        URIè¿æ¥
        è¿æ¥é€‰é¡¹
      åŸºæœ¬æ“ä½œ
        CREATE TABLE
        INSERT UPDATE DELETE
        SELECTæŸ¥è¯¢
        cursorå¯¹è±¡
      äº‹åŠ¡ç®¡ç†
        commit rollback
        è‡ªåŠ¨æäº¤
        ä¸Šä¸‹æ–‡ç®¡ç†å™¨
      é¢„ç¼–è¯‘è¯­å¥
        executeå‚æ•°åŒ–
        æ€§èƒ½ä¼˜åŒ–
        å®‰å…¨é˜²æŠ¤
      ä¸Šä¸‹æ–‡ç®¡ç†å™¨
        withè¯­å¥
        è‡ªåŠ¨å…³é—­
        å¼‚å¸¸å¤„ç†
    å¼‚æ­¥åº“aiosqlite
      å¼‚æ­¥è¿æ¥
        aiosqlite.connect
        å¼‚æ­¥ä¸Šä¸‹æ–‡
        è¿æ¥æ± 
      å¼‚æ­¥æ“ä½œ
        await execute
        å¼‚æ­¥æŸ¥è¯¢
        å¼‚æ­¥äº‹åŠ¡
      å¼‚æ­¥äº‹åŠ¡
        async with
        å¼‚æ­¥æäº¤
        å¼‚æ­¥å›æ»š
    ORMæ¡†æ¶SQLAlchemy
      SQLAlchemy Core
        è¡¨å®šä¹‰
        æŸ¥è¯¢æ„å»º
        æ‰¹é‡æ“ä½œ
      SQLAlchemy ORM
        æ¨¡å‹å®šä¹‰
        å…³ç³»æ˜ å°„
        ä¼šè¯ç®¡ç†
      æ¨¡å‹å®šä¹‰
        Baseç±»
        åˆ—å®šä¹‰
        å…³ç³»å®šä¹‰
    é«˜çº§ç‰¹æ€§
      è‡ªå®šä¹‰å‡½æ•°
        create_function
        Pythonå‡½æ•°
        ç±»å‹è½¬æ¢
      è‡ªå®šä¹‰èšåˆå‡½æ•°
        create_aggregate
        èšåˆé€»è¾‘
        çŠ¶æ€ç®¡ç†
      è¡Œå·¥å‚Row Factory
        å‘½åå…ƒç»„
        å­—å…¸è¡Œ
        è‡ªå®šä¹‰è¡Œ
      è¿æ¥æ± 
        è¿æ¥ç®¡ç†
        æ€§èƒ½ä¼˜åŒ–
        èµ„æºæ§åˆ¶
    æ€§èƒ½ä¼˜åŒ–
      æ‰¹é‡æ“ä½œ
        executemany
        æ‰¹é‡æ’å…¥
        æ€§èƒ½æå‡
      ç´¢å¼•ä¼˜åŒ–
        åˆ›å»ºç´¢å¼•
        ç´¢å¼•ä½¿ç”¨
        æŸ¥è¯¢ä¼˜åŒ–
      WALæ¨¡å¼é…ç½®
        journal_mode
        æ€§èƒ½æå‡
        å¹¶å‘ä¼˜åŒ–
    æœ€ä½³å®è·µ
      è¿æ¥ç®¡ç†
        å•è¿æ¥
        è¿æ¥å¤ç”¨
        èµ„æºé‡Šæ”¾
      é”™è¯¯å¤„ç†
        å¼‚å¸¸æ•è·
        é”™è¯¯æ¢å¤
        æ—¥å¿—è®°å½•
      çº¿ç¨‹å®‰å…¨
        è¿æ¥å…±äº«
        é”æœºåˆ¶
        å¹¶å‘æ§åˆ¶
```

---

## 4. æ ‡å‡†åº“sqlite3

Pythonæ ‡å‡†åº“æä¾›äº†`sqlite3`æ¨¡å—ï¼Œæ— éœ€é¢å¤–å®‰è£…å³å¯ä½¿ç”¨SQLiteã€‚

### 4.1. åŸºæœ¬è¿æ¥

**åŸºæœ¬è¿æ¥**ï¼š

```python
import sqlite3

# è¿æ¥åˆ°æ•°æ®åº“æ–‡ä»¶ï¼ˆä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰
conn = sqlite3.connect('example.db')

# ä½¿ç”¨å†…å­˜æ•°æ®åº“
conn = sqlite3.connect(':memory:')

# ä½¿ç”¨URIè¿æ¥ï¼ˆæ”¯æŒæ›´å¤šé€‰é¡¹ï¼‰
conn = sqlite3.connect('file:example.db?mode=rwc', uri=True)

# å…³é—­è¿æ¥
conn.close()
```

**è¿æ¥é€‰é¡¹**ï¼š

```python
# è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
conn = sqlite3.connect('example.db', timeout=5.0)

# æ£€æŸ¥è¿æ¥æ˜¯å¦å·²å…³é—­
if conn:
    print("è¿æ¥å·²å»ºç«‹")
```

## 5. åŸºæœ¬æ“ä½œ

**åˆ›å»ºè¡¨å’Œæ’å…¥æ•°æ®**ï¼š

```python
import sqlite3

conn = sqlite3.connect('example.db')
cursor = conn.cursor()

# åˆ›å»ºè¡¨
cursor.execute('''
    CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        email TEXT UNIQUE,
        age INTEGER,
        created_at TEXT DEFAULT (datetime('now'))
    )
''')

# æ’å…¥å•æ¡æ•°æ®
cursor.execute('''
    INSERT INTO users (name, email, age)
    VALUES (?, ?, ?)
''', ('Alice', 'alice@example.com', 25))

# æ’å…¥å¤šæ¡æ•°æ®
users = [
    ('Bob', 'bob@example.com', 30),
    ('Charlie', 'charlie@example.com', 35)
]
cursor.executemany('''
    INSERT INTO users (name, email, age)
    VALUES (?, ?, ?)
''', users)

# æäº¤äº‹åŠ¡
conn.commit()

# å…³é—­æ¸¸æ ‡å’Œè¿æ¥
cursor.close()
conn.close()
```

**æŸ¥è¯¢æ•°æ®**ï¼š

```python
import sqlite3

conn = sqlite3.connect('example.db')
cursor = conn.cursor()

# æŸ¥è¯¢å•æ¡è®°å½•
cursor.execute('SELECT * FROM users WHERE id = ?', (1,))
user = cursor.fetchone()
print(user)  # (1, 'Alice', 'alice@example.com', 25, '2024-01-01 10:00:00')

# æŸ¥è¯¢å¤šæ¡è®°å½•
cursor.execute('SELECT * FROM users WHERE age > ?', (25,))
users = cursor.fetchall()
for user in users:
    print(user)

# ä½¿ç”¨å­—å…¸æ¸¸æ ‡ï¼ˆPython 3.6+ï¼‰
conn.row_factory = sqlite3.Row
cursor = conn.cursor()
cursor.execute('SELECT * FROM users WHERE id = ?', (1,))
user = cursor.fetchone()
print(user['name'])  # 'Alice'
print(dict(user))  # {'id': 1, 'name': 'Alice', ...}

cursor.close()
conn.close()
```

## 6. äº‹åŠ¡ç®¡ç†

**æ‰‹åŠ¨äº‹åŠ¡ç®¡ç†**ï¼š

```python
import sqlite3

conn = sqlite3.connect('example.db')
cursor = conn.cursor()

try:
# å¼€å§‹äº‹åŠ¡ï¼ˆéšå¼ï¼‰
    cursor.execute('INSERT INTO users (name, email) VALUES (?, ?)',
                   ('David', 'david@example.com'))
    cursor.execute('UPDATE users SET age = ? WHERE id = ?', (26, 1))

# æäº¤äº‹åŠ¡
    conn.commit()
    print("äº‹åŠ¡æäº¤æˆåŠŸ")
except sqlite3.Error as e:
# å›æ»šäº‹åŠ¡
    conn.rollback()
    print(f"äº‹åŠ¡å›æ»š: {e}")
finally:
    cursor.close()
    conn.close()
```

**è‡ªåŠ¨æäº¤æ¨¡å¼**ï¼š

```python
import sqlite3

# è‡ªåŠ¨æäº¤æ¨¡å¼ï¼ˆä¸æ¨èï¼Œæ€§èƒ½å·®ï¼‰
conn = sqlite3.connect('example.db', isolation_level=None)
cursor = conn.cursor()

cursor.execute('INSERT INTO users (name, email) VALUES (?, ?)',
               ('Eve', 'eve@example.com'))
# è‡ªåŠ¨æäº¤ï¼Œæ— éœ€conn.commit()

conn.close()
```

## 7. é¢„ç¼–è¯‘è¯­å¥

**ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥æå‡æ€§èƒ½**ï¼š

```python
import sqlite3

conn = sqlite3.connect('example.db')
cursor = conn.cursor()

# é¢„ç¼–è¯‘è¯­å¥
stmt = cursor.execute('SELECT * FROM users WHERE age > ? AND age < ?')

# æ‰§è¡Œå¤šæ¬¡æŸ¥è¯¢
cursor.execute('SELECT * FROM users WHERE age > ? AND age < ?', (20, 30))
results1 = cursor.fetchall()

cursor.execute('SELECT * FROM users WHERE age > ? AND age < ?', (30, 40))
results2 = cursor.fetchall()

# ä½¿ç”¨å‘½åå‚æ•°
cursor.execute('''
    SELECT * FROM users
    WHERE age > :min_age AND age < :max_age
''', {'min_age': 20, 'max_age': 30})

cursor.close()
conn.close()
```

## 8. ä¸Šä¸‹æ–‡ç®¡ç†å™¨

**ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨è‡ªåŠ¨ç®¡ç†è¿æ¥**ï¼š

```python
import sqlite3

# è¿æ¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆPython 3.10+ï¼‰
with sqlite3.connect('example.db') as conn:
    cursor = conn.cursor()
    cursor.execute('SELECT * FROM users')
    results = cursor.fetchall()
# è‡ªåŠ¨æäº¤æˆ–å›æ»š

# æ‰‹åŠ¨å®ç°ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
class SQLiteConnection:
    def __init__(self, db_path):
        self.db_path = db_path
        self.conn = None

    def __enter__(self):
        self.conn = sqlite3.connect(self.db_path)
        return self.conn

    def __exit__(self, exc_type, exc_val, exc_tb):
        if exc_type:
            self.conn.rollback()
        else:
            self.conn.commit()
        self.conn.close()
        return False

# ä½¿ç”¨
with SQLiteConnection('example.db') as conn:
    cursor = conn.cursor()
    cursor.execute('INSERT INTO users (name) VALUES (?)', ('Frank',))
```

---

## 9. å¼‚æ­¥åº“aiosqlite

å¯¹äºå¼‚æ­¥åº”ç”¨ï¼Œå¯ä»¥ä½¿ç”¨`aiosqlite`åº“ã€‚

### 9.1. å¼‚æ­¥è¿æ¥

**å®‰è£…å’ŒåŸºæœ¬ä½¿ç”¨**ï¼š

```bash
pip install aiosqlite
```

```python
import aiosqlite
import asyncio

async def main():
# å¼‚æ­¥è¿æ¥
    async with aiosqlite.connect('example.db') as db:
# æ‰§è¡ŒæŸ¥è¯¢
        async with db.execute('SELECT * FROM users') as cursor:
            async for row in cursor:
                print(row)

asyncio.run(main())
```

## 10. å¼‚æ­¥æ“ä½œ

**å¼‚æ­¥CRUDæ“ä½œ**ï¼š

```python
import aiosqlite
import asyncio

async def create_user(db, name, email, age):
    await db.execute('''
        INSERT INTO users (name, email, age)
        VALUES (?, ?, ?)
    ''', (name, email, age))
    await db.commit()

async def get_users(db):
    async with db.execute('SELECT * FROM users') as cursor:
        return await cursor.fetchall()

async def main():
    async with aiosqlite.connect('example.db') as db:
# åˆ›å»ºè¡¨
        await db.execute('''
            CREATE TABLE IF NOT EXISTS users (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                email TEXT,
                age INTEGER
            )
        ''')
        await db.commit()

# æ’å…¥æ•°æ®
        await create_user(db, 'Alice', 'alice@example.com', 25)

# æŸ¥è¯¢æ•°æ®
        users = await get_users(db)
        for user in users:
            print(user)

asyncio.run(main())
```

## 11. å¼‚æ­¥äº‹åŠ¡

**å¼‚æ­¥äº‹åŠ¡ç®¡ç†**ï¼š

```python
import aiosqlite
import asyncio

async def batch_insert(db, users):
    try:
        await db.execute('BEGIN')
        for name, email, age in users:
            await db.execute('''
                INSERT INTO users (name, email, age)
                VALUES (?, ?, ?)
            ''', (name, email, age))
        await db.commit()
        print("æ‰¹é‡æ’å…¥æˆåŠŸ")
    except Exception as e:
        await db.rollback()
        print(f"æ‰¹é‡æ’å…¥å¤±è´¥: {e}")

async def main():
    async with aiosqlite.connect('example.db') as db:
        users = [
            ('Bob', 'bob@example.com', 30),
            ('Charlie', 'charlie@example.com', 35)
        ]
        await batch_insert(db, users)

asyncio.run(main())
```

---

## 12. ORMæ¡†æ¶SQLAlchemy

SQLAlchemyæ˜¯Pythonæœ€æµè¡Œçš„ORMæ¡†æ¶ï¼Œæ”¯æŒSQLiteã€‚

### 12.1. SQLAlchemy Core

**ä½¿ç”¨SQLAlchemy Coreï¼ˆç±»ä¼¼åŸç”ŸSQLï¼‰**ï¼š

```python
from sqlalchemy import create_engine, MetaData, Table, Column, Integer, String
from sqlalchemy.sql import select

# åˆ›å»ºå¼•æ“
engine = create_engine('sqlite:///example.db', echo=True)

# å®šä¹‰è¡¨ç»“æ„
metadata = MetaData()
users = Table('users', metadata,
    Column('id', Integer, primary_key=True),
    Column('name', String(50), nullable=False),
    Column('email', String(100)),
    Column('age', Integer)
)

# åˆ›å»ºè¡¨
metadata.create_all(engine)

# æ’å…¥æ•°æ®
with engine.connect() as conn:
    conn.execute(users.insert(), [
        {'name': 'Alice', 'email': 'alice@example.com', 'age': 25},
        {'name': 'Bob', 'email': 'bob@example.com', 'age': 30}
    ])
    conn.commit()

# æŸ¥è¯¢æ•°æ®
with engine.connect() as conn:
    stmt = select(users).where(users.c.age > 25)
    result = conn.execute(stmt)
    for row in result:
        print(row)
```

## 13. SQLAlchemy ORM

**ä½¿ç”¨SQLAlchemy ORM**ï¼š

```python
from sqlalchemy import create_engine, Column, Integer, String, DateTime
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from datetime import datetime

Base = declarative_base()

# å®šä¹‰æ¨¡å‹
class User(Base):
    __tablename__ = 'users'

    id = Column(Integer, primary_key=True, autoincrement=True)
    name = Column(String(50), nullable=False)
    email = Column(String(100), unique=True)
    age = Column(Integer)
    created_at = Column(DateTime, default=datetime.now)

    def __repr__(self):
        return f"<User(id={self.id}, name='{self.name}')>"

# åˆ›å»ºå¼•æ“å’Œä¼šè¯
engine = create_engine('sqlite:///example.db', echo=True)
Base.metadata.create_all(engine)
Session = sessionmaker(bind=engine)

# ä½¿ç”¨ORMæ“ä½œ
session = Session()

# åˆ›å»ºç”¨æˆ·
user1 = User(name='Alice', email='alice@example.com', age=25)
user2 = User(name='Bob', email='bob@example.com', age=30)
session.add(user1)
session.add(user2)
session.commit()

# æŸ¥è¯¢ç”¨æˆ·
users = session.query(User).filter(User.age > 25).all()
for user in users:
    print(user)

# æ›´æ–°ç”¨æˆ·
user = session.query(User).filter(User.id == 1).first()
if user:
    user.age = 26
    session.commit()

# åˆ é™¤ç”¨æˆ·
user = session.query(User).filter(User.id == 2).first()
if user:
    session.delete(user)
    session.commit()

session.close()
```

## 14. æ¨¡å‹å®šä¹‰

**å®Œæ•´çš„æ¨¡å‹å®šä¹‰ç¤ºä¾‹**ï¼š

```python
from sqlalchemy import create_engine, Column, Integer, String, ForeignKey, Text
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship, sessionmaker

Base = declarative_base()

class User(Base):
    __tablename__ = 'users'

    id = Column(Integer, primary_key=True)
    name = Column(String(50), nullable=False)
    email = Column(String(100), unique=True)

# ä¸€å¯¹å¤šå…³ç³»
    orders = relationship('Order', back_populates='user')

    def __repr__(self):
        return f"<User(id={self.id}, name='{self.name}')>"

class Order(Base):
    __tablename__ = 'orders'

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey('users.id'), nullable=False)
    product = Column(String(100), nullable=False)
    amount = Column(Integer, nullable=False)

# å¤šå¯¹ä¸€å…³ç³»
    user = relationship('User', back_populates='orders')

    def __repr__(self):
        return f"<Order(id={self.id}, product='{self.product}')>"

# ä½¿ç”¨
engine = create_engine('sqlite:///example.db')
Base.metadata.create_all(engine)
Session = sessionmaker(bind=engine)

session = Session()

# åˆ›å»ºç”¨æˆ·å’Œè®¢å•
user = User(name='Alice', email='alice@example.com')
order1 = Order(user=user, product='Laptop', amount=1000)
order2 = Order(user=user, product='Mouse', amount=20)
session.add(user)
session.commit()

# æŸ¥è¯¢ç”¨æˆ·åŠå…¶è®¢å•
user = session.query(User).filter(User.name == 'Alice').first()
print(f"User: {user.name}")
for order in user.orders:
    print(f"  Order: {order.product} - ${order.amount}")

session.close()
```

---

## 15. é«˜çº§ç‰¹æ€§

### 15.1. è‡ªå®šä¹‰å‡½æ•°

**æ³¨å†ŒPythonå‡½æ•°ä¸ºSQLiteå‡½æ•°**ï¼š

```python
import sqlite3
import hashlib

def md5_hash(text):
    """è®¡ç®—MD5å“ˆå¸Œå€¼"""
    return hashlib.md5(text.encode()).hexdigest()

def upper_case(text):
    """è½¬æ¢ä¸ºå¤§å†™"""
    return text.upper()

conn = sqlite3.connect('example.db')
conn.create_function('md5', 1, md5_hash)
conn.create_function('upper', 1, upper_case)

cursor = conn.cursor()
cursor.execute('SELECT md5(name), upper(email) FROM users')
results = cursor.fetchall()

cursor.close()
conn.close()
```

### 15.2. è‡ªå®šä¹‰èšåˆå‡½æ•°

**åˆ›å»ºè‡ªå®šä¹‰èšåˆå‡½æ•°**ï¼š

```python
import sqlite3

class Median:
    """è®¡ç®—ä¸­ä½æ•°çš„èšåˆå‡½æ•°"""
    def __init__(self):
        self.values = []

    def step(self, value):
        if value is not None:
            self.values.append(value)

    def finalize(self):
        if not self.values:
            return None
        sorted_values = sorted(self.values)
        n = len(sorted_values)
        if n % 2 == 0:
            return (sorted_values[n//2 - 1] + sorted_values[n//2]) / 2
        else:
            return sorted_values[n//2]

conn = sqlite3.connect('example.db')
conn.create_aggregate('median', 1, Median)

cursor = conn.cursor()
cursor.execute('SELECT median(age) FROM users')
result = cursor.fetchone()
print(f"å¹´é¾„ä¸­ä½æ•°: {result[0]}")

cursor.close()
conn.close()
```

### 15.3. è¡Œå·¥å‚ï¼ˆRow Factoryï¼‰

**ä½¿ç”¨è¡Œå·¥å‚è¿”å›å­—å…¸**ï¼š

```python
import sqlite3

def dict_factory(cursor, row):
    """å°†è¡Œè½¬æ¢ä¸ºå­—å…¸"""
    d = {}
    for idx, col in enumerate(cursor.description):
        d[col[0]] = row[idx]
    return d

conn = sqlite3.connect('example.db')
conn.row_factory = dict_factory

cursor = conn.cursor()
cursor.execute('SELECT * FROM users WHERE id = ?', (1,))
user = cursor.fetchone()
print(user)  # {'id': 1, 'name': 'Alice', 'email': 'alice@example.com', ...}
print(user['name'])  # 'Alice'

cursor.close()
conn.close()
```

**ä½¿ç”¨sqlite3.Rowï¼ˆæ¨èï¼‰**ï¼š

```python
import sqlite3

conn = sqlite3.connect('example.db')
conn.row_factory = sqlite3.Row

cursor = conn.cursor()
cursor.execute('SELECT * FROM users')
for row in cursor.fetchall():
    print(f"ID: {row['id']}, Name: {row['name']}")
# ä¹Ÿå¯ä»¥ä½¿ç”¨ç´¢å¼•
    print(f"Email: {row[2]}")

cursor.close()
conn.close()
```

## 16. è¿æ¥æ± 

**ä½¿ç”¨è¿æ¥æ± ï¼ˆSQLAlchemyï¼‰**ï¼š

```python
from sqlalchemy import create_engine
from sqlalchemy.pool import QueuePool

# é…ç½®è¿æ¥æ± 
engine = create_engine(
    'sqlite:///example.db',
    poolclass=QueuePool,
    pool_size=5,
    max_overflow=10,
    pool_pre_ping=True  # è¿æ¥å‰æ£€æŸ¥è¿æ¥æ˜¯å¦æœ‰æ•ˆ
)

# ä½¿ç”¨è¿æ¥æ± 
with engine.connect() as conn:
    result = conn.execute('SELECT * FROM users')
    for row in result:
        print(row)
```

---

## 17. æ€§èƒ½ä¼˜åŒ–

### 17.1. æ‰¹é‡æ“ä½œ

**æ‰¹é‡æ’å…¥ä¼˜åŒ–**ï¼š

```python
import sqlite3

conn = sqlite3.connect('example.db')
cursor = conn.cursor()

# æ–¹æ³•1ï¼šä½¿ç”¨executemany
users = [
    ('User1', 'user1@example.com', 20),
    ('User2', 'user2@example.com', 25),
# ... æ›´å¤šç”¨æˆ·
]
cursor.executemany('''
    INSERT INTO users (name, email, age)
    VALUES (?, ?, ?)
''', users)
conn.commit()

# æ–¹æ³•2ï¼šä½¿ç”¨äº‹åŠ¡æ‰¹é‡æ’å…¥
def batch_insert(users, batch_size=1000):
    conn = sqlite3.connect('example.db')
    cursor = conn.cursor()

    try:
        for i in range(0, len(users), batch_size):
            batch = users[i:i+batch_size]
            cursor.executemany('''
                INSERT INTO users (name, email, age)
                VALUES (?, ?, ?)
            ''', batch)
            conn.commit()
    except Exception as e:
        conn.rollback()
        raise e
    finally:
        cursor.close()
        conn.close()

cursor.close()
conn.close()
```

## 18. ç´¢å¼•ä¼˜åŒ–

**åˆ›å»ºå’Œä½¿ç”¨ç´¢å¼•**ï¼š

```python
import sqlite3

conn = sqlite3.connect('example.db')
cursor = conn.cursor()

# åˆ›å»ºç´¢å¼•
cursor.execute('CREATE INDEX IF NOT EXISTS idx_email ON users(email)')
cursor.execute('CREATE INDEX IF NOT EXISTS idx_age ON users(age)')

# å¤åˆç´¢å¼•
cursor.execute('''
    CREATE INDEX IF NOT EXISTS idx_name_age
    ON users(name, age)
''')

conn.commit()

# åˆ†ææŸ¥è¯¢è®¡åˆ’
cursor.execute('EXPLAIN QUERY PLAN SELECT * FROM users WHERE email = ?',
               ('alice@example.com',))
plan = cursor.fetchall()
for row in plan:
    print(row)

cursor.close()
conn.close()
```

## 19. WALæ¨¡å¼é…ç½®

**é…ç½®WALæ¨¡å¼æå‡å¹¶å‘æ€§èƒ½**ï¼š

```python
import sqlite3

conn = sqlite3.connect('example.db')

# å¯ç”¨WALæ¨¡å¼
conn.execute('PRAGMA journal_mode=WAL')
conn.execute('PRAGMA synchronous=NORMAL')
conn.execute('PRAGMA cache_size=-16000')  # 16MBç¼“å­˜
conn.execute('PRAGMA foreign_keys=ON')

# æ£€æŸ¥é…ç½®
cursor = conn.cursor()
cursor.execute('PRAGMA journal_mode')
print(f"Journal mode: {cursor.fetchone()[0]}")

cursor.close()
conn.close()
```

---

## 20. Pythonåº“å¤šç»´å¯¹æ¯”çŸ©é˜µ

### 20.1. Python SQLiteåº“å¯¹æ¯”çŸ©é˜µ

| ç»´åº¦ | sqlite3ï¼ˆæ ‡å‡†åº“ï¼‰ | aiosqlite | SQLAlchemy |
|------|------------------|-----------|------------|
| **ç±»å‹** | åŒæ­¥åº“ | å¼‚æ­¥åº“ | ORMæ¡†æ¶ |
| **å®‰è£…** | å†…ç½® | pip install | pip install |
| **æ€§èƒ½** | â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **æ˜“ç”¨æ€§** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| **å¼‚æ­¥æ”¯æŒ** | âŒ | âœ… | âœ…ï¼ˆå¼‚æ­¥å¼•æ“ï¼‰ |
| **ORMæ”¯æŒ** | âŒ | âŒ | âœ… |
| **ç±»å‹å®‰å…¨** | â­â­â­ | â­â­â­ | â­â­â­â­ |
| **å­¦ä¹ æ›²çº¿** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **é€‚ç”¨åœºæ™¯** | ç®€å•åº”ç”¨ã€è„šæœ¬ | å¼‚æ­¥åº”ç”¨ | å¤æ‚åº”ç”¨ã€ORMéœ€æ±‚ |
| **æ–‡æ¡£è´¨é‡** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| **ç¤¾åŒºæ”¯æŒ** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |

### 20.2. Pythonä½¿ç”¨æ–¹å¼å¯¹æ¯”çŸ©é˜µ

| ç»´åº¦ | åŸç”ŸSQL | ORM | å¼‚æ­¥ORM |
|------|---------|-----|---------|
| **æ€§èƒ½** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ |
| **çµæ´»æ€§** | â­â­â­â­â­ | â­â­â­ | â­â­â­ |
| **å¼€å‘æ•ˆç‡** | â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |
| **ç±»å‹å®‰å…¨** | â­â­ | â­â­â­â­ | â­â­â­â­ |
| **å­¦ä¹ æˆæœ¬** | â­â­â­â­ | â­â­â­ | â­â­â­ |
| **é€‚ç”¨åœºæ™¯** | ç®€å•æŸ¥è¯¢ã€æ€§èƒ½è¦æ±‚é«˜ | å¤æ‚åº”ç”¨ã€å¿«é€Ÿå¼€å‘ | å¼‚æ­¥åº”ç”¨ã€é«˜å¹¶å‘ |
| **ä»£ç å¯è¯»æ€§** | â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |
| **ç»´æŠ¤æˆæœ¬** | â­â­â­ | â­â­â­â­ | â­â­â­â­ |

### 20.3. Pythonæœ€ä½³å®è·µå¯¹æ¯”çŸ©é˜µ

| å®è·µé¡¹ | æ¨èåšæ³• | ä¸æ¨èåšæ³• | æ€§èƒ½å½±å“ |
|--------|---------|-----------|---------|
| **è¿æ¥ç®¡ç†** | ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ | æ‰‹åŠ¨ç®¡ç†è¿æ¥ | â­â­â­â­â­ |
| **äº‹åŠ¡ç®¡ç†** | æ‰¹é‡æ“ä½œä½¿ç”¨äº‹åŠ¡ | é€æ¡æ“ä½œ | â­â­â­â­â­ |
| **é¢„ç¼–è¯‘è¯­å¥** | ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ | å­—ç¬¦ä¸²æ‹¼æ¥ | â­â­â­â­ |
| **é”™è¯¯å¤„ç†** | æ•è·å…·ä½“å¼‚å¸¸ | æ•è·æ‰€æœ‰å¼‚å¸¸ | â­â­â­ |
| **çº¿ç¨‹å®‰å…¨** | æ¯çº¿ç¨‹ç‹¬ç«‹è¿æ¥ | å…±äº«è¿æ¥ | â­â­â­â­â­ |
| **WALæ¨¡å¼** | å¯ç”¨WALæ¨¡å¼ | ä½¿ç”¨DELETEæ¨¡å¼ | â­â­â­â­ |

## 21. æœ€ä½³å®è·µ

### 21.1. è¿æ¥ç®¡ç†

**è¿æ¥ç®¡ç†æœ€ä½³å®è·µ**ï¼š

```python
import sqlite3
from contextlib import contextmanager

@contextmanager
def get_db_connection(db_path='example.db'):
    """æ•°æ®åº“è¿æ¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""
    conn = sqlite3.connect(db_path)
    conn.row_factory = sqlite3.Row
    try:
        yield conn
        conn.commit()
    except Exception:
        conn.rollback()
        raise
    finally:
        conn.close()

# ä½¿ç”¨
with get_db_connection() as conn:
    cursor = conn.cursor()
    cursor.execute('SELECT * FROM users')
    users = cursor.fetchall()
```

## 22. é”™è¯¯å¤„ç†

**å®Œå–„çš„é”™è¯¯å¤„ç†**ï¼š

```python
import sqlite3

def safe_execute(conn, sql, params=None):
    """å®‰å…¨æ‰§è¡ŒSQLè¯­å¥"""
    try:
        cursor = conn.cursor()
        if params:
            cursor.execute(sql, params)
        else:
            cursor.execute(sql)
        conn.commit()
        return cursor.fetchall() if cursor.description else None
    except sqlite3.IntegrityError as e:
        print(f"å®Œæ•´æ€§é”™è¯¯: {e}")
        conn.rollback()
        return None
    except sqlite3.OperationalError as e:
        print(f"æ“ä½œé”™è¯¯: {e}")
        conn.rollback()
        return None
    except sqlite3.Error as e:
        print(f"æ•°æ®åº“é”™è¯¯: {e}")
        conn.rollback()
        return None

conn = sqlite3.connect('example.db')
result = safe_execute(conn, 'SELECT * FROM users WHERE id = ?', (1,))
conn.close()
```

### 22.1. çº¿ç¨‹å®‰å…¨

**å¤šçº¿ç¨‹ä½¿ç”¨SQLite**ï¼š

```python
import sqlite3
import threading

# SQLiteé»˜è®¤æ”¯æŒå¤šçº¿ç¨‹ï¼ˆæ¯ä¸ªçº¿ç¨‹ä½¿ç”¨ç‹¬ç«‹è¿æ¥ï¼‰
def worker(db_path, user_id):
    conn = sqlite3.connect(db_path, check_same_thread=False)
    cursor = conn.cursor()
    cursor.execute('SELECT * FROM users WHERE id = ?', (user_id,))
    result = cursor.fetchone()
    cursor.close()
    conn.close()
    return result

# å¤šçº¿ç¨‹æŸ¥è¯¢
threads = []
for i in range(1, 6):
    t = threading.Thread(target=worker, args=('example.db', i))
    threads.append(t)
    t.start()

for t in threads:
    t.join()
```

---

## 23. ğŸ”— ç›¸å…³èµ„æº

- [08.01 è¿æ¥ç®¡ç†](./08.01-è¿æ¥ç®¡ç†.md) - è¿æ¥ç®¡ç†æœ€ä½³å®è·µ
- [08.02 äº‹åŠ¡ç®¡ç†](./08.02-äº‹åŠ¡ç®¡ç†.md) - äº‹åŠ¡ç®¡ç†è¯¦è§£
- [08.03 æŸ¥è¯¢ä¼˜åŒ–](./08.03-æŸ¥è¯¢ä¼˜åŒ–.md) - æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§
- [08.07 JavaScript/TypeScriptä½¿ç”¨æŒ‡å—](./08.07-JavaScript-TypeScriptä½¿ç”¨æŒ‡å—.md) - å…¶ä»–è¯­è¨€ä½¿ç”¨æŒ‡å—
- [08.08 Goä½¿ç”¨æŒ‡å—](./08.08-Goä½¿ç”¨æŒ‡å—.md) - å…¶ä»–è¯­è¨€ä½¿ç”¨æŒ‡å—
- [Python sqlite3å®˜æ–¹æ–‡æ¡£](https://docs.python.org/3/library/sqlite3.html)
- [SQLAlchemyæ–‡æ¡£](https://docs.sqlalchemy.org/)
- [aiosqliteæ–‡æ¡£](https://aiosqlite.omnilib.dev/)

---

## 24. ğŸ”— äº¤å‰å¼•ç”¨

### 24.1. ç†è®ºæ¨¡å‹ ğŸ†•

- â­ [ç³»ç»Ÿç†è®ºæ¨¡å‹](../11-ç†è®ºæ¨¡å‹/11.01-ç³»ç»Ÿç†è®ºæ¨¡å‹.md) - ç¼–ç¨‹æ¥å£ç†è®º
- â­ [ç®—æ³•å¤æ‚åº¦ç†è®º](../11-ç†è®ºæ¨¡å‹/11.03-ç®—æ³•å¤æ‚åº¦ç†è®º.md) - Pythonæ“ä½œå¤æ‚åº¦

### 24.2. è®¾è®¡æ¨¡å‹ ğŸ†•

- â­â­ [è®¾è®¡æ¨¡å¼](../12-è®¾è®¡æ¨¡å‹/12.03-è®¾è®¡æ¨¡å¼.md) - Pythonç¼–ç¨‹æ¨¡å¼
- â­ [è®¾è®¡åŸåˆ™](../12-è®¾è®¡æ¨¡å‹/12.02-è®¾è®¡åŸåˆ™.md) - Pythonç¼–ç¨‹åŸåˆ™

---

## 25. ğŸ“š å‚è€ƒèµ„æ–™

- [Python sqlite3æ¨¡å—](https://docs.python.org/3/library/sqlite3.html)
- [SQLAlchemy SQLiteæ”¯æŒ](https://docs.sqlalchemy.org/en/14/dialects/sqlite.html)
- [aiosqlite GitHub](https://github.com/omnilib/aiosqlite)

---

**æœ€åæ›´æ–°**ï¼š2025-01-15
**ç»´æŠ¤è€…**ï¼šData-Science Team
