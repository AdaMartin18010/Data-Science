# SQLite Goä½¿ç”¨æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-11-13
> **æœ€åæ›´æ–°**ï¼š2025-01-15
> **ç‰ˆæœ¬**ï¼šGo 1.16+ï¼ŒSQLite 3.31+ è‡³ 3.47.x
> **é€‚ç”¨åº“**ï¼šgithub.com/mattn/go-sqlite3ã€modernc.org/sqliteã€crawshaw.io/sqlite

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›SQLiteåœ¨Goè¯­è¨€ä¸­çš„å®Œæ•´ä½¿ç”¨æŒ‡å—ï¼ŒåŒ…æ‹¬CGOé©±åŠ¨ã€çº¯Goå®ç°å’Œç°ä»£SQLæ¥å£çš„ä½¿ç”¨æ–¹æ³•ã€‚

---

## ğŸ“‘ ç›®å½•

- [SQLite Goä½¿ç”¨æŒ‡å—](#sqlite-goä½¿ç”¨æŒ‡å—)
  - [ğŸ“‹ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ğŸ“Š æ€ç»´å¯¼å›¾](#-æ€ç»´å¯¼å›¾)
  - [ä¸€ã€database/sql + go-sqlite3ï¼ˆæ¨èï¼‰](#ä¸€databasesql--go-sqlite3æ¨è)
    - [1.1 å®‰è£…å’ŒåŸºæœ¬ä½¿ç”¨](#11-å®‰è£…å’ŒåŸºæœ¬ä½¿ç”¨)
    - [1.2 åŸºæœ¬æ“ä½œ](#12-åŸºæœ¬æ“ä½œ)
    - [1.3 äº‹åŠ¡ç®¡ç†](#13-äº‹åŠ¡ç®¡ç†)
    - [1.4 é¢„ç¼–è¯‘è¯­å¥](#14-é¢„ç¼–è¯‘è¯­å¥)
    - [1.5 è¿æ¥æ± é…ç½®](#15-è¿æ¥æ± é…ç½®)
  - [äºŒã€modernc.org/sqliteï¼ˆçº¯Goï¼‰](#äºŒmoderncorgsqliteçº¯go)
    - [2.1 å®‰è£…å’Œä½¿ç”¨](#21-å®‰è£…å’Œä½¿ç”¨)
    - [2.2 æ€§èƒ½å¯¹æ¯”](#22-æ€§èƒ½å¯¹æ¯”)
    - [2.3 é€‚ç”¨åœºæ™¯](#23-é€‚ç”¨åœºæ™¯)
  - [ä¸‰ã€crawshaw.io/sqliteï¼ˆä½çº§APIï¼‰](#ä¸‰crawshawiosqliteä½çº§api)
    - [3.1 ç›´æ¥APIè°ƒç”¨](#31-ç›´æ¥apiè°ƒç”¨)
    - [3.2 æ€§èƒ½ä¼˜åŒ–](#32-æ€§èƒ½ä¼˜åŒ–)
  - [å››ã€GORMé›†æˆ](#å››gormé›†æˆ)
    - [4.1 GORMåŸºæœ¬ä½¿ç”¨](#41-gormåŸºæœ¬ä½¿ç”¨)
    - [4.2 æ¨¡å‹å®šä¹‰](#42-æ¨¡å‹å®šä¹‰)
    - [4.3 é«˜çº§æŸ¥è¯¢](#43-é«˜çº§æŸ¥è¯¢)
  - [äº”ã€é«˜çº§ç‰¹æ€§](#äº”é«˜çº§ç‰¹æ€§)
    - [5.1 è‡ªå®šä¹‰å‡½æ•°](#51-è‡ªå®šä¹‰å‡½æ•°)
    - [5.2 è¿æ¥é’©å­](#52-è¿æ¥é’©å­)
    - [5.3 WALæ¨¡å¼é…ç½®](#53-walæ¨¡å¼é…ç½®)
  - [å…­ã€Goåº“å¤šç»´å¯¹æ¯”çŸ©é˜µ](#å…­goåº“å¤šç»´å¯¹æ¯”çŸ©é˜µ)
    - [6.1 Go SQLiteåº“å¯¹æ¯”çŸ©é˜µ](#61-go-sqliteåº“å¯¹æ¯”çŸ©é˜µ)
    - [6.2 Goä½¿ç”¨æ–¹å¼å¯¹æ¯”çŸ©é˜µ](#62-goä½¿ç”¨æ–¹å¼å¯¹æ¯”çŸ©é˜µ)
    - [6.3 Goæœ€ä½³å®è·µå¯¹æ¯”çŸ©é˜µ](#63-goæœ€ä½³å®è·µå¯¹æ¯”çŸ©é˜µ)
  - [ä¸ƒã€æœ€ä½³å®è·µ](#ä¸ƒæœ€ä½³å®è·µ)
    - [7.1 è¿æ¥ç®¡ç†](#71-è¿æ¥ç®¡ç†)
    - [7.2 é”™è¯¯å¤„ç†](#72-é”™è¯¯å¤„ç†)
    - [7.3 æ€§èƒ½ä¼˜åŒ–](#73-æ€§èƒ½ä¼˜åŒ–)
  - [ğŸ”— ç›¸å…³èµ„æº](#-ç›¸å…³èµ„æº)
  - [ğŸ”— äº¤å‰å¼•ç”¨](#-äº¤å‰å¼•ç”¨)
    - [ç†è®ºæ¨¡å‹ ğŸ†•](#ç†è®ºæ¨¡å‹-)
    - [è®¾è®¡æ¨¡å‹ ğŸ†•](#è®¾è®¡æ¨¡å‹-)
  - [ğŸ“š å‚è€ƒèµ„æ–™](#-å‚è€ƒèµ„æ–™)

---

## ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((Goä½¿ç”¨æŒ‡å—))
    database/sql + go-sqlite3æ¨è
      å®‰è£…å’ŒåŸºæœ¬ä½¿ç”¨
        go getå®‰è£…
        sql.Openè¿æ¥
        db.Pingæµ‹è¯•
      åŸºæœ¬æ“ä½œ
        CREATE TABLE
        INSERT UPDATE DELETE
        SELECTæŸ¥è¯¢
        Rowsæ‰«æ
      äº‹åŠ¡ç®¡ç†
        Beginäº‹åŠ¡
        Commitæäº¤
        Rollbackå›æ»š
      é¢„ç¼–è¯‘è¯­å¥
        Prepareæ–¹æ³•
        å‚æ•°ç»‘å®š
        æ€§èƒ½ä¼˜åŒ–
      è¿æ¥æ± é…ç½®
        SetMaxOpenConns
        SetMaxIdleConns
        è¿æ¥ç®¡ç†
    modernc.org/sqliteçº¯Go
      å®‰è£…å’Œä½¿ç”¨
        çº¯Goå®ç°
        æ— CGOä¾èµ–
        è·¨å¹³å°æ”¯æŒ
      æ€§èƒ½å¯¹æ¯”
        æ€§èƒ½æµ‹è¯•
        å†…å­˜ä½¿ç”¨
        å¯åŠ¨é€Ÿåº¦
      é€‚ç”¨åœºæ™¯
        æ— CGOè¦æ±‚
        è·¨å¹³å°éƒ¨ç½²
        æ€§èƒ½è¦æ±‚
    crawshaw.io/sqliteä½çº§API
      ç›´æ¥APIè°ƒç”¨
        ä½çº§æ¥å£
        æ€§èƒ½ä¼˜åŒ–
        ç²¾ç»†æ§åˆ¶
      æ€§èƒ½ä¼˜åŒ–
        é›¶æ‹·è´
        å†…å­˜ä¼˜åŒ–
        æŸ¥è¯¢ä¼˜åŒ–
    GORMé›†æˆ
      GORMåŸºæœ¬ä½¿ç”¨
        æ¨¡å‹å®šä¹‰
        æ•°æ®åº“è¿æ¥
        åŸºæœ¬æ“ä½œ
      æ¨¡å‹å®šä¹‰
        ç»“æ„ä½“æ ‡ç­¾
        å…³ç³»å®šä¹‰
        ç´¢å¼•å®šä¹‰
      é«˜çº§æŸ¥è¯¢
        å…³è”æŸ¥è¯¢
        é¢„åŠ è½½
        äº‹åŠ¡æ”¯æŒ
    é«˜çº§ç‰¹æ€§
      è‡ªå®šä¹‰å‡½æ•°
        RegisterFunc
        Goå‡½æ•°æ³¨å†Œ
        ç±»å‹è½¬æ¢
      è¿æ¥é’©å­
        è¿æ¥äº‹ä»¶
        é’©å­å‡½æ•°
        ç›‘æ§ç»Ÿè®¡
      WALæ¨¡å¼é…ç½®
        PRAGMAè®¾ç½®
        æ€§èƒ½ä¼˜åŒ–
        å¹¶å‘ä¼˜åŒ–
    æœ€ä½³å®è·µ
      è¿æ¥ç®¡ç†
        å•è¿æ¥
        è¿æ¥å¤ç”¨
        èµ„æºé‡Šæ”¾
      é”™è¯¯å¤„ç†
        é”™è¯¯æ£€æŸ¥
        é”™è¯¯æ¢å¤
        æ—¥å¿—è®°å½•
      æ€§èƒ½ä¼˜åŒ–
        æ‰¹é‡æ“ä½œ
        ç´¢å¼•ä¼˜åŒ–
        æŸ¥è¯¢ä¼˜åŒ–
```

---

## ä¸€ã€database/sql + go-sqlite3ï¼ˆæ¨èï¼‰

ä½¿ç”¨Goæ ‡å‡†åº“`database/sql`é…åˆ`go-sqlite3`é©±åŠ¨æ˜¯æœ€å¸¸ç”¨çš„æ–¹å¼ã€‚

### 1.1 å®‰è£…å’ŒåŸºæœ¬ä½¿ç”¨

**å®‰è£…**ï¼š

```bash
go get github.com/mattn/go-sqlite3
```

**åŸºæœ¬è¿æ¥**ï¼š

```go
package main

import (
    "database/sql"
    _ "github.com/mattn/go-sqlite3"
    "log"
)

func main() {
    // æ‰“å¼€æ•°æ®åº“è¿æ¥ï¼ˆä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰
    db, err := sql.Open("sqlite3", "example.db")
    if err != nil {
        log.Fatal(err)
    }
    defer db.Close()

    // æµ‹è¯•è¿æ¥
    err = db.Ping()
    if err != nil {
        log.Fatal(err)
    }

    log.Println("æ•°æ®åº“è¿æ¥æˆåŠŸ")
}
```

### 1.2 åŸºæœ¬æ“ä½œ

**åˆ›å»ºè¡¨å’Œæ’å…¥æ•°æ®**ï¼š

```go
package main

import (
    "database/sql"
    _ "github.com/mattn/go-sqlite3"
    "log"
)

func main() {
    db, err := sql.Open("sqlite3", "example.db")
    if err != nil {
        log.Fatal(err)
    }
    defer db.Close()

    // åˆ›å»ºè¡¨
    createTableSQL := `
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            email TEXT UNIQUE,
            age INTEGER,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
    `
    _, err = db.Exec(createTableSQL)
    if err != nil {
        log.Fatal(err)
    }

    // æ’å…¥å•æ¡æ•°æ®
    insertSQL := "INSERT INTO users (name, email, age) VALUES (?, ?, ?)"
    result, err := db.Exec(insertSQL, "Alice", "alice@example.com", 25)
    if err != nil {
        log.Fatal(err)
    }

    id, err := result.LastInsertId()
    if err != nil {
        log.Fatal(err)
    }
    log.Printf("æ’å…¥æˆåŠŸï¼ŒID: %d", id)

    // æ’å…¥å¤šæ¡æ•°æ®
    stmt, err := db.Prepare(insertSQL)
    if err != nil {
        log.Fatal(err)
    }
    defer stmt.Close()

    users := []struct {
        name  string
        email string
        age   int
    }{
        {"Bob", "bob@example.com", 30},
        {"Charlie", "charlie@example.com", 35},
    }

    for _, user := range users {
        _, err = stmt.Exec(user.name, user.email, user.age)
        if err != nil {
            log.Fatal(err)
        }
    }
}
```

**æŸ¥è¯¢æ•°æ®**ï¼š

```go
package main

import (
    "database/sql"
    _ "github.com/mattn/go-sqlite3"
    "log"
)

type User struct {
    ID        int
    Name      string
    Email     string
    Age       sql.NullInt64
    CreatedAt string
}

func main() {
    db, err := sql.Open("sqlite3", "example.db")
    if err != nil {
        log.Fatal(err)
    }
    defer db.Close()

    // æŸ¥è¯¢å•æ¡è®°å½•
    var user User
    err = db.QueryRow("SELECT id, name, email, age, created_at FROM users WHERE id = ?", 1).
        Scan(&user.ID, &user.Name, &user.Email, &user.Age, &user.CreatedAt)
    if err != nil {
        if err == sql.ErrNoRows {
            log.Println("æœªæ‰¾åˆ°è®°å½•")
        } else {
            log.Fatal(err)
        }
    } else {
        log.Printf("ç”¨æˆ·: %+v", user)
    }

    // æŸ¥è¯¢å¤šæ¡è®°å½•
    rows, err := db.Query("SELECT id, name, email, age, created_at FROM users WHERE age > ?", 25)
    if err != nil {
        log.Fatal(err)
    }
    defer rows.Close()

    var users []User
    for rows.Next() {
        var u User
        err := rows.Scan(&u.ID, &u.Name, &u.Email, &u.Age, &u.CreatedAt)
        if err != nil {
            log.Fatal(err)
        }
        users = append(users, u)
    }

    err = rows.Err()
    if err != nil {
        log.Fatal(err)
    }

    for _, u := range users {
        log.Printf("ç”¨æˆ·: %+v", u)
    }
}
```

**æ›´æ–°å’Œåˆ é™¤**ï¼š

```go
package main

import (
    "database/sql"
    _ "github.com/mattn/go-sqlite3"
    "log"
)

func main() {
    db, err := sql.Open("sqlite3", "example.db")
    if err != nil {
        log.Fatal(err)
    }
    defer db.Close()

    // æ›´æ–°æ•°æ®
    updateSQL := "UPDATE users SET age = ? WHERE id = ?"
    result, err := db.Exec(updateSQL, 26, 1)
    if err != nil {
        log.Fatal(err)
    }

    rowsAffected, err := result.RowsAffected()
    if err != nil {
        log.Fatal(err)
    }
    log.Printf("æ›´æ–°äº† %d è¡Œ", rowsAffected)

    // åˆ é™¤æ•°æ®
    deleteSQL := "DELETE FROM users WHERE id = ?"
    result, err = db.Exec(deleteSQL, 2)
    if err != nil {
        log.Fatal(err)
    }

    rowsAffected, err = result.RowsAffected()
    if err != nil {
        log.Fatal(err)
    }
    log.Printf("åˆ é™¤äº† %d è¡Œ", rowsAffected)
}
```

### 1.3 äº‹åŠ¡ç®¡ç†

**ä½¿ç”¨äº‹åŠ¡**ï¼š

```go
package main

import (
    "database/sql"
    _ "github.com/mattn/go-sqlite3"
    "log"
)

func main() {
    db, err := sql.Open("sqlite3", "example.db")
    if err != nil {
        log.Fatal(err)
    }
    defer db.Close()

    // å¼€å§‹äº‹åŠ¡
    tx, err := db.Begin()
    if err != nil {
        log.Fatal(err)
    }

    // æ‰§è¡Œå¤šä¸ªæ“ä½œ
    _, err = tx.Exec("INSERT INTO users (name, email) VALUES (?, ?)", "David", "david@example.com")
    if err != nil {
        tx.Rollback()
        log.Fatal(err)
    }

    _, err = tx.Exec("UPDATE users SET age = ? WHERE id = ?", 26, 1)
    if err != nil {
        tx.Rollback()
        log.Fatal(err)
    }

    // æäº¤äº‹åŠ¡
    err = tx.Commit()
    if err != nil {
        log.Fatal(err)
    }

    log.Println("äº‹åŠ¡æäº¤æˆåŠŸ")
}
```

### 1.4 é¢„ç¼–è¯‘è¯­å¥

**ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥**ï¼š

```go
package main

import (
    "database/sql"
    _ "github.com/mattn/go-sqlite3"
    "log"
)

func main() {
    db, err := sql.Open("sqlite3", "example.db")
    if err != nil {
        log.Fatal(err)
    }
    defer db.Close()

    // é¢„ç¼–è¯‘è¯­å¥
    stmt, err := db.Prepare("SELECT id, name, email FROM users WHERE id = ?")
    if err != nil {
        log.Fatal(err)
    }
    defer stmt.Close()

    // å¤šæ¬¡ä½¿ç”¨
    var name, email string
    var id int

    err = stmt.QueryRow(1).Scan(&id, &name, &email)
    if err != nil {
        log.Fatal(err)
    }
    log.Printf("ID: %d, Name: %s, Email: %s", id, name, email)

    err = stmt.QueryRow(2).Scan(&id, &name, &email)
    if err != nil {
        log.Fatal(err)
    }
    log.Printf("ID: %d, Name: %s, Email: %s", id, name, email)
}
```

### 1.5 è¿æ¥æ± é…ç½®

**é…ç½®è¿æ¥æ± **ï¼š

```go
package main

import (
    "database/sql"
    _ "github.com/mattn/go-sqlite3"
    "log"
    "time"
)

func main() {
    db, err := sql.Open("sqlite3", "example.db")
    if err != nil {
        log.Fatal(err)
    }
    defer db.Close()

    // é…ç½®è¿æ¥æ± 
    db.SetMaxOpenConns(1)        // SQLiteåªæ”¯æŒå•è¿æ¥ï¼Œè®¾ç½®ä¸º1
    db.SetMaxIdleConns(1)        // ç©ºé—²è¿æ¥æ•°
    db.SetConnMaxLifetime(time.Hour) // è¿æ¥æœ€å¤§ç”Ÿå­˜æ—¶é—´

    // æµ‹è¯•è¿æ¥
    err = db.Ping()
    if err != nil {
        log.Fatal(err)
    }

    log.Println("æ•°æ®åº“è¿æ¥æˆåŠŸ")
}
```

---

## äºŒã€modernc.org/sqliteï¼ˆçº¯Goï¼‰

`modernc.org/sqlite`æ˜¯çº¯Goå®ç°çš„SQLiteé©±åŠ¨ï¼Œä¸éœ€è¦CGOã€‚

### 2.1 å®‰è£…å’Œä½¿ç”¨

**å®‰è£…**ï¼š

```bash
go get modernc.org/sqlite
```

**åŸºæœ¬ä½¿ç”¨**ï¼š

```go
package main

import (
    "database/sql"
    _ "modernc.org/sqlite"
    "log"
)

func main() {
    // ä½¿ç”¨æ–¹å¼ä¸go-sqlite3å®Œå…¨ç›¸åŒ
    db, err := sql.Open("sqlite", "example.db")
    if err != nil {
        log.Fatal(err)
    }
    defer db.Close()

    // åˆ›å»ºè¡¨
    _, err = db.Exec(`
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            email TEXT UNIQUE
        )
    `)
    if err != nil {
        log.Fatal(err)
    }

    log.Println("æ•°æ®åº“æ“ä½œæˆåŠŸ")
}
```

### 2.2 æ€§èƒ½å¯¹æ¯”

**æ€§èƒ½ç‰¹ç‚¹**ï¼š

- **ä¼˜ç‚¹**ï¼š
  - çº¯Goå®ç°ï¼Œæ— éœ€CGO
  - äº¤å‰ç¼–è¯‘æ›´å®¹æ˜“
  - éƒ¨ç½²æ›´ç®€å•

- **ç¼ºç‚¹**ï¼š
  - æ€§èƒ½ç•¥ä½äºCGOç‰ˆæœ¬
  - æŸäº›é«˜çº§ç‰¹æ€§å¯èƒ½ä¸æ”¯æŒ

### 2.3 é€‚ç”¨åœºæ™¯

**é€‚ç”¨åœºæ™¯**ï¼š

- éœ€è¦äº¤å‰ç¼–è¯‘çš„é¡¹ç›®
- ä¸æƒ³ä¾èµ–Cç¼–è¯‘å™¨çš„ç¯å¢ƒ
- å¯¹æ€§èƒ½è¦æ±‚ä¸æ˜¯ç‰¹åˆ«é«˜çš„åœºæ™¯

---

## ä¸‰ã€crawshaw.io/sqliteï¼ˆä½çº§APIï¼‰

`crawshaw.io/sqlite`æä¾›æ›´æ¥è¿‘C APIçš„ä½çº§æ¥å£ã€‚

### 3.1 ç›´æ¥APIè°ƒç”¨

**åŸºæœ¬ä½¿ç”¨**ï¼š

```go
package main

import (
    "log"
    "crawshaw.io/sqlite"
    "crawshaw.io/sqlite/sqlitex"
)

func main() {
    // æ‰“å¼€æ•°æ®åº“
    conn, err := sqlite.OpenConn("example.db", 0)
    if err != nil {
        log.Fatal(err)
    }
    defer conn.Close()

    // æ‰§è¡ŒSQL
    err = sqlitex.Exec(conn, `
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            email TEXT UNIQUE
        )
    `, nil)
    if err != nil {
        log.Fatal(err)
    }

    // æ’å…¥æ•°æ®
    stmt := conn.Prep("INSERT INTO users (name, email) VALUES ($name, $email);")
    stmt.SetText("$name", "Alice")
    stmt.SetText("$email", "alice@example.com")
    _, err = stmt.Step()
    if err != nil {
        log.Fatal(err)
    }
    stmt.Reset()

    // æŸ¥è¯¢æ•°æ®
    stmt = conn.Prep("SELECT id, name, email FROM users WHERE id = $id;")
    stmt.SetInt64("$id", 1)
    hasRow, err := stmt.Step()
    if err != nil {
        log.Fatal(err)
    }
    if hasRow {
        id := stmt.GetInt64("id")
        name := stmt.GetText("name")
        email := stmt.GetText("email")
        log.Printf("ID: %d, Name: %s, Email: %s", id, name, email)
    }
    stmt.Reset()
}
```

### 3.2 æ€§èƒ½ä¼˜åŒ–

**æ€§èƒ½ä¼˜åŒ–æŠ€å·§**ï¼š

```go
package main

import (
    "log"
    "crawshaw.io/sqlite"
    "crawshaw.io/sqlite/sqlitex"
)

func main() {
    conn, err := sqlite.OpenConn("example.db", 0)
    if err != nil {
        log.Fatal(err)
    }
    defer conn.Close()

    // å¯ç”¨WALæ¨¡å¼
    err = sqlitex.Exec(conn, "PRAGMA journal_mode=WAL;", nil)
    if err != nil {
        log.Fatal(err)
    }

    // è®¾ç½®ç¼“å­˜å¤§å°
    err = sqlitex.Exec(conn, "PRAGMA cache_size=-16000;", nil)
    if err != nil {
        log.Fatal(err)
    }

    // æ‰¹é‡æ’å…¥
    err = sqlitex.Exec(conn, "BEGIN TRANSACTION;", nil)
    if err != nil {
        log.Fatal(err)
    }

    stmt := conn.Prep("INSERT INTO users (name, email) VALUES ($name, $email);")
    for i := 0; i < 1000; i++ {
        stmt.SetText("$name", fmt.Sprintf("User%d", i))
        stmt.SetText("$email", fmt.Sprintf("user%d@example.com", i))
        _, err = stmt.Step()
        if err != nil {
            log.Fatal(err)
        }
        stmt.Reset()
    }

    err = sqlitex.Exec(conn, "COMMIT;", nil)
    if err != nil {
        log.Fatal(err)
    }
}
```

---

## å››ã€GORMé›†æˆ

GORMæ˜¯Goæœ€æµè¡Œçš„ORMæ¡†æ¶ã€‚

### 4.1 GORMåŸºæœ¬ä½¿ç”¨

**å®‰è£…å’Œä½¿ç”¨**ï¼š

```bash
go get gorm.io/gorm
go get gorm.io/driver/sqlite
```

```go
package main

import (
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
    "log"
)

type User struct {
    ID        uint   `gorm:"primaryKey"`
    Name      string
    Email     string `gorm:"unique"`
    Age       int
    CreatedAt int64  `gorm:"autoCreateTime"`
}

func main() {
    // è¿æ¥æ•°æ®åº“
    db, err := gorm.Open(sqlite.Open("example.db"), &gorm.Config{})
    if err != nil {
        log.Fatal(err)
    }

    // è‡ªåŠ¨è¿ç§»
    err = db.AutoMigrate(&User{})
    if err != nil {
        log.Fatal(err)
    }

    // åˆ›å»ºç”¨æˆ·
    user := User{Name: "Alice", Email: "alice@example.com", Age: 25}
    result := db.Create(&user)
    if result.Error != nil {
        log.Fatal(result.Error)
    }
    log.Printf("åˆ›å»ºç”¨æˆ·æˆåŠŸï¼ŒID: %d", user.ID)

    // æŸ¥è¯¢ç”¨æˆ·
    var users []User
    db.Where("age > ?", 20).Find(&users)
    for _, u := range users {
        log.Printf("ç”¨æˆ·: %+v", u)
    }

    // æ›´æ–°ç”¨æˆ·
    db.Model(&user).Update("age", 26)

    // åˆ é™¤ç”¨æˆ·
    db.Delete(&user)
}
```

### 4.2 æ¨¡å‹å®šä¹‰

**å®Œæ•´çš„æ¨¡å‹å®šä¹‰**ï¼š

```go
package main

import (
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
    "log"
)

type User struct {
    ID        uint      `gorm:"primaryKey"`
    Name      string    `gorm:"not null"`
    Email     string    `gorm:"unique;not null"`
    Age       int
    Orders    []Order   `gorm:"foreignKey:UserID"`
    CreatedAt int64     `gorm:"autoCreateTime"`
    UpdatedAt int64     `gorm:"autoUpdateTime"`
}

type Order struct {
    ID        uint   `gorm:"primaryKey"`
    UserID    uint
    User      User   `gorm:"foreignKey:UserID"`
    Product   string `gorm:"not null"`
    Amount    int
    CreatedAt int64  `gorm:"autoCreateTime"`
}

func main() {
    db, err := gorm.Open(sqlite.Open("example.db"), &gorm.Config{})
    if err != nil {
        log.Fatal(err)
    }

    err = db.AutoMigrate(&User{}, &Order{})
    if err != nil {
        log.Fatal(err)
    }

    // åˆ›å»ºç”¨æˆ·å’Œè®¢å•
    user := User{
        Name:  "Alice",
        Email: "alice@example.com",
        Age:   25,
        Orders: []Order{
            {Product: "Laptop", Amount: 1000},
            {Product: "Mouse", Amount: 20},
        },
    }
    db.Create(&user)

    // æŸ¥è¯¢ç”¨æˆ·åŠå…¶è®¢å•
    var u User
    db.Preload("Orders").First(&u, user.ID)
    log.Printf("ç”¨æˆ·: %s", u.Name)
    for _, order := range u.Orders {
        log.Printf("  è®¢å•: %s - $%d", order.Product, order.Amount)
    }
}
```

### 4.3 é«˜çº§æŸ¥è¯¢

**GORMé«˜çº§æŸ¥è¯¢**ï¼š

```go
package main

import (
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
    "log"
)

type User struct {
    ID    uint
    Name  string
    Email string
    Age   int
}

func main() {
    db, err := gorm.Open(sqlite.Open("example.db"), &gorm.Config{})
    if err != nil {
        log.Fatal(err)
    }

    var users []User

    // æ¡ä»¶æŸ¥è¯¢
    db.Where("age > ?", 25).Find(&users)

    // é“¾å¼æŸ¥è¯¢
    db.Where("name LIKE ?", "%Alice%").Where("age > ?", 20).Find(&users)

    // æ’åº
    db.Order("age DESC").Find(&users)

    // é™åˆ¶ç»“æœ
    db.Limit(10).Offset(0).Find(&users)

    // èšåˆæŸ¥è¯¢
    var count int64
    db.Model(&User{}).Where("age > ?", 25).Count(&count)
    log.Printf("å¹´é¾„å¤§äº25çš„ç”¨æˆ·æ•°: %d", count)

    // åŸç”ŸSQL
    db.Raw("SELECT * FROM users WHERE age > ?", 25).Scan(&users)
}
```

---

## äº”ã€é«˜çº§ç‰¹æ€§

### 5.1 è‡ªå®šä¹‰å‡½æ•°

**æ³¨å†ŒGoå‡½æ•°ä¸ºSQLiteå‡½æ•°**ï¼š

```go
package main

import (
    "crypto/md5"
    "database/sql"
    "fmt"
    _ "github.com/mattn/go-sqlite3"
    "log"
)

func main() {
    db, err := sql.Open("sqlite3", "example.db")
    if err != nil {
        log.Fatal(err)
    }
    defer db.Close()

    // æ³¨æ„ï¼šgo-sqlite3ä¸æ”¯æŒç›´æ¥æ³¨å†Œè‡ªå®šä¹‰å‡½æ•°
    // éœ€è¦ä½¿ç”¨CGOæ‰©å±•æˆ–ä½¿ç”¨crawshaw.io/sqlite

    // ä½¿ç”¨crawshaw.io/sqliteæ³¨å†Œå‡½æ•°
    // conn.CreateFunction("md5", true, -1, func(ctx sqlite.Context, values []sqlite.Value) {
    //     data := []byte(values[0].Text())
    //     hash := md5.Sum(data)
    //     ctx.ResultText(fmt.Sprintf("%x", hash))
    // })
}
```

### 5.2 è¿æ¥é’©å­

**ä½¿ç”¨è¿æ¥é’©å­**ï¼š

```go
package main

import (
    "database/sql"
    _ "github.com/mattn/go-sqlite3"
    "log"
)

func main() {
    db, err := sql.Open("sqlite3", "example.db")
    if err != nil {
        log.Fatal(err)
    }
    defer db.Close()

    // è®¾ç½®è¿æ¥åæ‰§è¡Œçš„SQL
    _, err = db.Exec("PRAGMA journal_mode=WAL;")
    if err != nil {
        log.Fatal(err)
    }

    _, err = db.Exec("PRAGMA foreign_keys=ON;")
    if err != nil {
        log.Fatal(err)
    }

    _, err = db.Exec("PRAGMA synchronous=NORMAL;")
    if err != nil {
        log.Fatal(err)
    }

    log.Println("æ•°æ®åº“é…ç½®å®Œæˆ")
}
```

### 5.3 WALæ¨¡å¼é…ç½®

**WALæ¨¡å¼é…ç½®**ï¼š

```go
package main

import (
    "database/sql"
    _ "github.com/mattn/go-sqlite3"
    "log"
)

func configureDatabase(db *sql.DB) error {
    configs := []string{
        "PRAGMA journal_mode=WAL;",
        "PRAGMA synchronous=NORMAL;",
        "PRAGMA cache_size=-16000;", // 16MB
        "PRAGMA foreign_keys=ON;",
        "PRAGMA temp_store=MEMORY;",
    }

    for _, config := range configs {
        _, err := db.Exec(config)
        if err != nil {
            return err
        }
    }

    return nil
}

func main() {
    db, err := sql.Open("sqlite3", "example.db")
    if err != nil {
        log.Fatal(err)
    }
    defer db.Close()

    err = configureDatabase(db)
    if err != nil {
        log.Fatal(err)
    }

    log.Println("æ•°æ®åº“é…ç½®æˆåŠŸ")
}
```

---

## å…­ã€Goåº“å¤šç»´å¯¹æ¯”çŸ©é˜µ

### 6.1 Go SQLiteåº“å¯¹æ¯”çŸ©é˜µ

| ç»´åº¦ | go-sqlite3 | modernc.org/sqlite | crawshaw.io/sqlite |
|------|-----------|-------------------|-------------------|
| **ç±»å‹** | CGOç»‘å®š | çº¯Goå®ç° | ä½çº§API |
| **CGOä¾èµ–** | âœ… éœ€è¦ | âŒ ä¸éœ€è¦ | âŒ ä¸éœ€è¦ |
| **æ€§èƒ½** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| **æ˜“ç”¨æ€§** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­ |
| **è·¨å¹³å°** | â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |
| **ç±»å‹å®‰å…¨** | â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **å­¦ä¹ æ›²çº¿** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­ |
| **é€‚ç”¨åœºæ™¯** | æ ‡å‡†åº”ç”¨ï¼ˆæ¨èï¼‰ | æ— CGOè¦æ±‚ | æ€§èƒ½ä¼˜åŒ– |
| **æ–‡æ¡£è´¨é‡** | â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **ç¤¾åŒºæ”¯æŒ** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **ç¼–è¯‘é€Ÿåº¦** | â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |

### 6.2 Goä½¿ç”¨æ–¹å¼å¯¹æ¯”çŸ©é˜µ

| ç»´åº¦ | database/sql | GORM | åŸç”ŸAPI |
|------|-------------|------|---------|
| **æ€§èƒ½** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­â­ |
| **çµæ´»æ€§** | â­â­â­â­ | â­â­â­ | â­â­â­â­â­ |
| **å¼€å‘æ•ˆç‡** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­ |
| **ç±»å‹å®‰å…¨** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­ |
| **å­¦ä¹ æ›²çº¿** | â­â­â­â­ | â­â­â­ | â­â­â­ |
| **é€‚ç”¨åœºæ™¯** | æ ‡å‡†åº”ç”¨ï¼ˆæ¨èï¼‰ | ORMéœ€æ±‚ | æ€§èƒ½ä¼˜åŒ– |
| **ä»£ç å¯è¯»æ€§** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­ |
| **ç»´æŠ¤æˆæœ¬** | â­â­â­â­ | â­â­â­â­ | â­â­â­ |

### 6.3 Goæœ€ä½³å®è·µå¯¹æ¯”çŸ©é˜µ

| å®è·µé¡¹ | æ¨èåšæ³• | ä¸æ¨èåšæ³• | æ€§èƒ½å½±å“ |
|--------|---------|-----------|---------|
| **è¿æ¥ç®¡ç†** | ä½¿ç”¨è¿æ¥æ±  | é¢‘ç¹åˆ›å»ºè¿æ¥ | â­â­â­â­â­ |
| **äº‹åŠ¡ç®¡ç†** | æ‰¹é‡æ“ä½œä½¿ç”¨äº‹åŠ¡ | é€æ¡æ“ä½œ | â­â­â­â­â­ |
| **é¢„ç¼–è¯‘è¯­å¥** | ä½¿ç”¨Prepare | ç›´æ¥Exec | â­â­â­â­ |
| **é”™è¯¯å¤„ç†** | æ£€æŸ¥å…·ä½“é”™è¯¯ | å¿½ç•¥é”™è¯¯ | â­â­â­ |
| **è¿æ¥æ± é…ç½®** | åˆç†è®¾ç½®å¤§å° | é»˜è®¤é…ç½® | â­â­â­â­ |
| **WALæ¨¡å¼** | å¯ç”¨WALæ¨¡å¼ | ä½¿ç”¨DELETEæ¨¡å¼ | â­â­â­â­ |

## ä¸ƒã€æœ€ä½³å®è·µ

### 7.1 è¿æ¥ç®¡ç†

**è¿æ¥ç®¡ç†æœ€ä½³å®è·µ**ï¼š

```go
package main

import (
    "database/sql"
    _ "github.com/mattn/go-sqlite3"
    "log"
    "sync"
)

type DBManager struct {
    db *sql.DB
    mu sync.Mutex
}

var instance *DBManager
var once sync.Once

func GetDB() *sql.DB {
    once.Do(func() {
        db, err := sql.Open("sqlite3", "example.db")
        if err != nil {
            log.Fatal(err)
        }

        // é…ç½®æ•°æ®åº“
        db.SetMaxOpenConns(1)
        db.SetMaxIdleConns(1)

        instance = &DBManager{db: db}
    })
    return instance.db
}

func main() {
    db := GetDB()
    defer db.Close()

    // ä½¿ç”¨æ•°æ®åº“
    _, err := db.Exec("SELECT 1")
    if err != nil {
        log.Fatal(err)
    }
}
```

### 7.2 é”™è¯¯å¤„ç†

**å®Œå–„çš„é”™è¯¯å¤„ç†**ï¼š

```go
package main

import (
    "database/sql"
    "errors"
    _ "github.com/mattn/go-sqlite3"
    "log"
)

func safeQuery(db *sql.DB, query string, args ...interface{}) ([]map[string]interface{}, error) {
    rows, err := db.Query(query, args...)
    if err != nil {
        return nil, err
    }
    defer rows.Close()

    columns, err := rows.Columns()
    if err != nil {
        return nil, err
    }

    var results []map[string]interface{}
    for rows.Next() {
        values := make([]interface{}, len(columns))
        valuePtrs := make([]interface{}, len(columns))
        for i := range values {
            valuePtrs[i] = &values[i]
        }

        if err := rows.Scan(valuePtrs...); err != nil {
            return nil, err
        }

        entry := make(map[string]interface{})
        for i, col := range columns {
            entry[col] = values[i]
        }
        results = append(results, entry)
    }

    if err := rows.Err(); err != nil {
        return nil, err
    }

    return results, nil
}

func main() {
    db, err := sql.Open("sqlite3", "example.db")
    if err != nil {
        log.Fatal(err)
    }
    defer db.Close()

    results, err := safeQuery(db, "SELECT * FROM users WHERE id = ?", 1)
    if err != nil {
        if errors.Is(err, sql.ErrNoRows) {
            log.Println("æœªæ‰¾åˆ°è®°å½•")
        } else {
            log.Fatal(err)
        }
    } else {
        for _, row := range results {
            log.Printf("ç»“æœ: %+v", row)
        }
    }
}
```

### 7.3 æ€§èƒ½ä¼˜åŒ–

**æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š

```go
package main

import (
    "database/sql"
    _ "github.com/mattn/go-sqlite3"
    "log"
)

func main() {
    db, err := sql.Open("sqlite3", "example.db")
    if err != nil {
        log.Fatal(err)
    }
    defer db.Close()

    // 1. å¯ç”¨WALæ¨¡å¼
    db.Exec("PRAGMA journal_mode=WAL;")

    // 2. è®¾ç½®ç¼“å­˜
    db.Exec("PRAGMA cache_size=-16000;")

    // 3. ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥
    stmt, err := db.Prepare("INSERT INTO users (name, email) VALUES (?, ?)")
    if err != nil {
        log.Fatal(err)
    }
    defer stmt.Close()

    // 4. æ‰¹é‡æ“ä½œä½¿ç”¨äº‹åŠ¡
    tx, err := db.Begin()
    if err != nil {
        log.Fatal(err)
    }

    txStmt := tx.Stmt(stmt)
    for i := 0; i < 1000; i++ {
        _, err = txStmt.Exec(fmt.Sprintf("User%d", i), fmt.Sprintf("user%d@example.com", i))
        if err != nil {
            tx.Rollback()
            log.Fatal(err)
        }
    }

    err = tx.Commit()
    if err != nil {
        log.Fatal(err)
    }

    log.Println("æ‰¹é‡æ’å…¥å®Œæˆ")
}
```

---

## ğŸ”— ç›¸å…³èµ„æº

- [08.01 è¿æ¥ç®¡ç†](./08.01-è¿æ¥ç®¡ç†.md) - è¿æ¥ç®¡ç†æœ€ä½³å®è·µ
- [08.02 äº‹åŠ¡ç®¡ç†](./08.02-äº‹åŠ¡ç®¡ç†.md) - äº‹åŠ¡ç®¡ç†è¯¦è§£
- [08.03 æŸ¥è¯¢ä¼˜åŒ–](./08.03-æŸ¥è¯¢ä¼˜åŒ–.md) - æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§
- [08.06 Pythonä½¿ç”¨æŒ‡å—](./08.06-Pythonä½¿ç”¨æŒ‡å—.md) - å…¶ä»–è¯­è¨€ä½¿ç”¨æŒ‡å—
- [08.07 JavaScript/TypeScriptä½¿ç”¨æŒ‡å—](./08.07-JavaScript-TypeScriptä½¿ç”¨æŒ‡å—.md) - å…¶ä»–è¯­è¨€ä½¿ç”¨æŒ‡å—
- [go-sqlite3æ–‡æ¡£](https://github.com/mattn/go-sqlite3)
- [GORMæ–‡æ¡£](https://gorm.io/)

---

## ğŸ”— äº¤å‰å¼•ç”¨

### ç†è®ºæ¨¡å‹ ğŸ†•

- â­ [ç³»ç»Ÿç†è®ºæ¨¡å‹](../11-ç†è®ºæ¨¡å‹/11.01-ç³»ç»Ÿç†è®ºæ¨¡å‹.md) - ç¼–ç¨‹æ¥å£ç†è®º
- â­ [ç®—æ³•å¤æ‚åº¦ç†è®º](../11-ç†è®ºæ¨¡å‹/11.03-ç®—æ³•å¤æ‚åº¦ç†è®º.md) - Goæ“ä½œå¤æ‚åº¦

### è®¾è®¡æ¨¡å‹ ğŸ†•

- â­â­ [è®¾è®¡æ¨¡å¼](../12-è®¾è®¡æ¨¡å‹/12.03-è®¾è®¡æ¨¡å¼.md) - Goç¼–ç¨‹æ¨¡å¼
- â­ [è®¾è®¡åŸåˆ™](../12-è®¾è®¡æ¨¡å‹/12.02-è®¾è®¡åŸåˆ™.md) - Goç¼–ç¨‹åŸåˆ™

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [go-sqlite3 GitHub](https://github.com/mattn/go-sqlite3)
- [modernc.org/sqlite](https://gitlab.com/cznic/sqlite)
- [crawshaw.io/sqlite](https://github.com/crawshaw/sqlite)
- [GORMæ–‡æ¡£](https://gorm.io/docs/)

---

**æœ€åæ›´æ–°**ï¼š2025-01-15
**ç»´æŠ¤è€…**ï¼šData-Science Team
