# SQLiteæ•°æ®åº“ç‰ˆæœ¬æ§åˆ¶å·¥å…·å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025-12-05
> **ç‰ˆæœ¬**: SQLite 3.47.x
> **éš¾åº¦**: â­â­â­â­â­
> **é€‚ç”¨åœºæ™¯**: æ•°æ®åº“ç‰ˆæœ¬ç®¡ç†ã€Schemaè¿ç§»ã€å¤šç¯å¢ƒéƒ¨ç½²ã€ç‰ˆæœ¬æ§åˆ¶å·¥å…·é›†æˆ

---

## ğŸ“‘ ç›®å½•

- [SQLiteæ•°æ®åº“ç‰ˆæœ¬æ§åˆ¶å·¥å…·å®Œæ•´æŒ‡å—](#sqliteæ•°æ®åº“ç‰ˆæœ¬æ§åˆ¶å·¥å…·å®Œæ•´æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ç‰ˆæœ¬æ§åˆ¶å·¥å…·æ€»è§ˆ](#ç‰ˆæœ¬æ§åˆ¶å·¥å…·æ€»è§ˆ)
  - [1. Flywayé›†æˆ](#1-flywayé›†æˆ)
    - [1.1 FlywayåŸºç¡€](#11-flywayåŸºç¡€)
    - [1.2 Flywayé…ç½®](#12-flywayé…ç½®)
    - [1.3 Flywayè¿ç§»è„šæœ¬](#13-flywayè¿ç§»è„šæœ¬)
  - [2. Liquibaseé›†æˆ](#2-liquibaseé›†æˆ)
    - [2.1 LiquibaseåŸºç¡€](#21-liquibaseåŸºç¡€)
    - [2.2 Liquibaseé…ç½®](#22-liquibaseé…ç½®)
    - [2.3 Liquibaseå˜æ›´é›†](#23-liquibaseå˜æ›´é›†)
  - [3. Alembicé›†æˆ](#3-alembicé›†æˆ)
    - [3.1 AlembicåŸºç¡€](#31-alembicåŸºç¡€)
    - [3.2 Alembicé…ç½®](#32-alembicé…ç½®)
    - [3.3 Alembicè¿ç§»è„šæœ¬](#33-alembicè¿ç§»è„šæœ¬)
  - [4. è‡ªå®šä¹‰ç‰ˆæœ¬æ§åˆ¶](#4-è‡ªå®šä¹‰ç‰ˆæœ¬æ§åˆ¶)
    - [4.1 ç®€å•ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ](#41-ç®€å•ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ)
    - [4.2 é«˜çº§ç‰ˆæœ¬æ§åˆ¶åŠŸèƒ½](#42-é«˜çº§ç‰ˆæœ¬æ§åˆ¶åŠŸèƒ½)
  - [5. å¤šç¯å¢ƒéƒ¨ç½²ç­–ç•¥](#5-å¤šç¯å¢ƒéƒ¨ç½²ç­–ç•¥)
    - [5.1 ç¯å¢ƒé…ç½®ç®¡ç†](#51-ç¯å¢ƒé…ç½®ç®¡ç†)
    - [5.2 ç¯å¢ƒç‰¹å®šè¿ç§»](#52-ç¯å¢ƒç‰¹å®šè¿ç§»)
    - [5.3 éƒ¨ç½²æµç¨‹](#53-éƒ¨ç½²æµç¨‹)
  - [6. å·¥å…·å¯¹æ¯”ä¸é€‰å‹](#6-å·¥å…·å¯¹æ¯”ä¸é€‰å‹)
    - [6.1 å·¥å…·å¯¹æ¯”çŸ©é˜µ](#61-å·¥å…·å¯¹æ¯”çŸ©é˜µ)
    - [6.2 é€‰å‹å»ºè®®](#62-é€‰å‹å»ºè®®)
  - [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)
    - [7.1 ç‰ˆæœ¬æ§åˆ¶æœ€ä½³å®è·µ](#71-ç‰ˆæœ¬æ§åˆ¶æœ€ä½³å®è·µ)
    - [7.2 å¤šç¯å¢ƒéƒ¨ç½²æœ€ä½³å®è·µ](#72-å¤šç¯å¢ƒéƒ¨ç½²æœ€ä½³å®è·µ)
  - [8. ğŸ”— ç›¸å…³èµ„æº](#8--ç›¸å…³èµ„æº)
    - [å†…éƒ¨èµ„æº](#å†…éƒ¨èµ„æº)
    - [å¤–éƒ¨èµ„æº](#å¤–éƒ¨èµ„æº)

---

## ç‰ˆæœ¬æ§åˆ¶å·¥å…·æ€»è§ˆ

```text
æ•°æ®åº“ç‰ˆæœ¬æ§åˆ¶å·¥å…·
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä¸»æµå·¥å…·å¯¹æ¯”                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Flyway                                                               â”‚
â”‚    â€¢ ç®€å•æ˜“ç”¨                                                            â”‚
â”‚    â€¢ SQLä¼˜å…ˆ                                                            â”‚
â”‚    â€¢ ç‰ˆæœ¬å·å‘½å                                                          â”‚
â”‚                                                                         â”‚
â”‚ 2. Liquibase                                                            â”‚
â”‚    â€¢ å¤šæ ¼å¼æ”¯æŒï¼ˆXML/YAML/JSON/SQLï¼‰                                     â”‚
â”‚    â€¢ å˜æ›´é›†ç®¡ç†                                                          â”‚
â”‚    â€¢ å›æ»šæ”¯æŒ                                                            â”‚
â”‚                                                                         â”‚
â”‚ 3. Alembic                                                              â”‚
â”‚    â€¢ Pythonç”Ÿæ€                                                         â”‚
â”‚    â€¢ SQLAlchemyé›†æˆ                                                     â”‚
â”‚    â€¢ è‡ªåŠ¨ç”Ÿæˆè¿ç§»                                                        â”‚
â”‚                                                                         â”‚
â”‚ 4. è‡ªå®šä¹‰å·¥å…·                                                            â”‚
â”‚    â€¢ å®Œå…¨æ§åˆ¶                                                           â”‚
â”‚    â€¢ è½»é‡çº§                                                             â”‚
â”‚    â€¢ å®šåˆ¶åŒ–éœ€æ±‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. Flywayé›†æˆ

### 1.1 FlywayåŸºç¡€

```python
# Flyway Pythoné›†æˆç¤ºä¾‹
# éœ€è¦å®‰è£…: pip install flyway

from flyway import Flyway
import sqlite3

class FlywayManager:
    def __init__(self, db_path: str, migrations_dir: str = 'migrations'):
        self.db_path = db_path
        self.migrations_dir = migrations_dir
        self.flyway = Flyway(
            url=f'jdbc:sqlite:{db_path}',
            locations=[f'filesystem:{migrations_dir}']
        )

    def migrate(self):
        """æ‰§è¡Œè¿ç§»"""
        return self.flyway.migrate()

    def info(self):
        """æŸ¥çœ‹è¿ç§»ä¿¡æ¯"""
        return self.flyway.info()

    def validate(self):
        """éªŒè¯è¿ç§»"""
        return self.flyway.validate()

    def baseline(self, version: str = '1'):
        """åŸºçº¿åŒ–æ•°æ®åº“"""
        return self.flyway.baseline(version=version)
```

### 1.2 Flywayé…ç½®

```properties
# flyway.conf
flyway.url=jdbc:sqlite:./database.db
flyway.user=
flyway.password=
flyway.locations=filesystem:migrations
flyway.sqlMigrationPrefix=V
flyway.sqlMigrationSeparator=__
flyway.sqlMigrationSuffixes=.sql
flyway.validateOnMigrate=true
flyway.cleanOnValidationError=false
```

### 1.3 Flywayè¿ç§»è„šæœ¬

```sql
-- migrations/V1__Initial_schema.sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    email TEXT UNIQUE NOT NULL,
    created_at INTEGER NOT NULL
);

CREATE INDEX idx_users_email ON users(email);

-- migrations/V2__Add_user_profile.sql
ALTER TABLE users ADD COLUMN profile TEXT;

CREATE TABLE user_profiles (
    user_id INTEGER PRIMARY KEY,
    bio TEXT,
    avatar_url TEXT,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- migrations/V3__Add_indexes.sql
CREATE INDEX idx_users_created ON users(created_at);
CREATE INDEX idx_profiles_user ON user_profiles(user_id);
```

---

## 2. Liquibaseé›†æˆ

### 2.1 LiquibaseåŸºç¡€

```python
# Liquibase Pythoné›†æˆç¤ºä¾‹
# éœ€è¦å®‰è£…: pip install liquibase

from liquibase import Liquibase
import sqlite3

class LiquibaseManager:
    def __init__(self, db_path: str, changelog_file: str = 'changelog.xml'):
        self.db_path = db_path
        self.changelog_file = changelog_file
        self.liquibase = Liquibase(
            url=f'jdbc:sqlite:{db_path}',
            changeLogFile=changelog_file
        )

    def update(self):
        """æ‰§è¡Œæ›´æ–°"""
        return self.liquibase.update()

    def status(self):
        """æŸ¥çœ‹çŠ¶æ€"""
        return self.liquibase.status()

    def rollback(self, count: int = 1):
        """å›æ»š"""
        return self.liquibase.rollback(count=count)

    def rollback_to_tag(self, tag: str):
        """å›æ»šåˆ°æ ‡ç­¾"""
        return self.liquibase.rollback(tag=tag)
```

### 2.2 Liquibaseé…ç½®

```xml
<!-- changelog.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="1" author="developer">
        <createTable tableName="users">
            <column name="id" type="INTEGER" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="TEXT">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="created_at" type="INTEGER">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="2" author="developer">
        <addColumn tableName="users">
            <column name="profile" type="TEXT"/>
        </addColumn>
    </changeSet>

    <changeSet id="3" author="developer">
        <createTable tableName="user_profiles">
            <column name="user_id" type="INTEGER">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="bio" type="TEXT"/>
            <column name="avatar_url" type="TEXT"/>
        </createTable>
        <addForeignKeyConstraint
            baseTableName="user_profiles"
            baseColumnNames="user_id"
            constraintName="fk_user_profiles_user_id"
            referencedTableName="users"
            referencedColumnNames="id"/>
    </changeSet>

</databaseChangeLog>
```

### 2.3 Liquibaseå˜æ›´é›†

```yaml
# changelog.yaml
databaseChangeLog:
  - changeSet:
      id: 1
      author: developer
      changes:
        - createTable:
            tableName: users
            columns:
              - column:
                  name: id
                  type: INTEGER
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: name
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: email
                  type: TEXT
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: created_at
                  type: INTEGER
                  constraints:
                    nullable: false

  - changeSet:
      id: 2
      author: developer
      changes:
        - addColumn:
            tableName: users
            columns:
              - column:
                  name: profile
                  type: TEXT
```

---

## 3. Alembicé›†æˆ

### 3.1 AlembicåŸºç¡€

```python
# Alembicé…ç½®å’Œä½¿ç”¨
# éœ€è¦å®‰è£…: pip install alembic sqlalchemy

from alembic import config, script
from alembic.runtime import migration
from sqlalchemy import create_engine
import sqlite3

class AlembicManager:
    def __init__(self, db_path: str, alembic_cfg_path: str = 'alembic.ini'):
        self.db_path = db_path
        self.alembic_cfg = config.Config(alembic_cfg_path)
        self.alembic_cfg.set_main_option('sqlalchemy.url', f'sqlite:///{db_path}')

    def upgrade(self, revision: str = 'head'):
        """å‡çº§åˆ°æŒ‡å®šç‰ˆæœ¬"""
        from alembic import command
        command.upgrade(self.alembic_cfg, revision)

    def downgrade(self, revision: str = '-1'):
        """é™çº§åˆ°æŒ‡å®šç‰ˆæœ¬"""
        from alembic import command
        command.downgrade(self.alembic_cfg, revision)

    def current(self):
        """æŸ¥çœ‹å½“å‰ç‰ˆæœ¬"""
        from alembic import command
        return command.current(self.alembic_cfg)

    def history(self):
        """æŸ¥çœ‹å†å²"""
        from alembic import command
        return command.history(self.alembic_cfg)

    def revision(self, message: str, autogenerate: bool = True):
        """åˆ›å»ºæ–°è¿ç§»"""
        from alembic import command
        command.revision(
            self.alembic_cfg,
            message=message,
            autogenerate=autogenerate
        )
```

### 3.2 Alembicé…ç½®

```ini
# alembic.ini
[alembic]
script_location = alembic
sqlalchemy.url = sqlite:///./database.db

[loggers]
keys = root,sqlalchemy,alembic

[handlers]
keys = console

[formatters]
keys = generic

[logger_root]
level = WARN
handlers = console
qualname =

[logger_sqlalchemy]
level = WARN
handlers =
qualname = sqlalchemy.engine

[logger_alembic]
level = INFO
handlers =
qualname = alembic

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[formatter_generic]
format = %(levelname)-5.5s [%(name)s] %(message)s
datefmt = %H:%M:%S
```

### 3.3 Alembicè¿ç§»è„šæœ¬

```python
# alembic/versions/001_initial_schema.py
"""Initial schema

Revision ID: 001
Revises:
Create Date: 2025-12-05 10:00:00.000000

"""
from alembic import op
import sqlalchemy as sa

# revision identifiers, used by Alembic.
revision = '001'
down_revision = None
branch_labels = None
depends_on = None

def upgrade():
    op.create_table('users',
        sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
        sa.Column('name', sa.Text(), nullable=False),
        sa.Column('email', sa.Text(), nullable=False),
        sa.Column('created_at', sa.Integer(), nullable=False),
        sa.PrimaryKeyConstraint('id'),
        sa.UniqueConstraint('email')
    )
    op.create_index('idx_users_email', 'users', ['email'])

def downgrade():
    op.drop_index('idx_users_email', table_name='users')
    op.drop_table('users')

# alembic/versions/002_add_user_profile.py
"""Add user profile

Revision ID: 002
Revises: 001
Create Date: 2025-12-05 11:00:00.000000

"""
from alembic import op
import sqlalchemy as sa

revision = '002'
down_revision = '001'
branch_labels = None
depends_on = None

def upgrade():
    op.add_column('users', sa.Column('profile', sa.Text(), nullable=True))
    op.create_table('user_profiles',
        sa.Column('user_id', sa.Integer(), nullable=False),
        sa.Column('bio', sa.Text(), nullable=True),
        sa.Column('avatar_url', sa.Text(), nullable=True),
        sa.ForeignKeyConstraint(['user_id'], ['users.id']),
        sa.PrimaryKeyConstraint('user_id')
    )

def downgrade():
    op.drop_table('user_profiles')
    op.drop_column('users', 'profile')
```

---

## 4. è‡ªå®šä¹‰ç‰ˆæœ¬æ§åˆ¶

### 4.1 ç®€å•ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ

```python
import sqlite3
import hashlib
from pathlib import Path
from typing import List, Dict
from datetime import datetime

class SimpleVersionControl:
    def __init__(self, db_path: str, migrations_dir: str = 'migrations'):
        self.db_path = db_path
        self.migrations_dir = Path(migrations_dir)
        self.conn = sqlite3.connect(db_path)
        self.setup_version_table()

    def setup_version_table(self):
        """è®¾ç½®ç‰ˆæœ¬è¡¨"""
        cursor = self.conn.cursor()
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS schema_version (
                version INTEGER PRIMARY KEY,
                name TEXT NOT NULL,
                checksum TEXT NOT NULL,
                applied_at INTEGER NOT NULL
            )
        """)
        self.conn.commit()

    def get_current_version(self) -> int:
        """è·å–å½“å‰ç‰ˆæœ¬"""
        cursor = self.conn.cursor()
        cursor.execute("SELECT MAX(version) FROM schema_version")
        result = cursor.fetchone()[0]
        return result if result else 0

    def load_migrations(self) -> List[Dict]:
        """åŠ è½½è¿ç§»è„šæœ¬"""
        migrations = []

        for migration_file in sorted(self.migrations_dir.glob("*.sql")):
            # æ–‡ä»¶åæ ¼å¼: 001_initial_schema.sql
            parts = migration_file.stem.split('_', 1)
            version = int(parts[0])
            name = parts[1] if len(parts) > 1 else migration_file.stem

            with open(migration_file, 'r', encoding='utf-8') as f:
                sql = f.read()

            checksum = hashlib.md5(sql.encode()).hexdigest()

            migrations.append({
                'version': version,
                'name': name,
                'file': migration_file,
                'sql': sql,
                'checksum': checksum
            })

        return sorted(migrations, key=lambda x: x['version'])

    def apply_migration(self, migration: Dict):
        """åº”ç”¨è¿ç§»"""
        cursor = self.conn.cursor()

        # æ£€æŸ¥æ˜¯å¦å·²åº”ç”¨
        cursor.execute("""
            SELECT version FROM schema_version WHERE version = ?
        """, (migration['version'],))
        if cursor.fetchone():
            print(f"è¿ç§» {migration['version']} å·²åº”ç”¨ï¼Œè·³è¿‡")
            return

        # æ‰§è¡Œè¿ç§»
        try:
            cursor.executescript(migration['sql'])
            cursor.execute("""
                INSERT INTO schema_version (version, name, checksum, applied_at)
                VALUES (?, ?, ?, strftime('%s', 'now'))
            """, (migration['version'], migration['name'], migration['checksum']))
            self.conn.commit()
            print(f"è¿ç§» {migration['version']} åº”ç”¨æˆåŠŸ")
        except Exception as e:
            self.conn.rollback()
            print(f"è¿ç§» {migration['version']} åº”ç”¨å¤±è´¥: {e}")
            raise

    def migrate(self):
        """æ‰§è¡Œæ‰€æœ‰æœªåº”ç”¨çš„è¿ç§»"""
        current_version = self.get_current_version()
        migrations = self.load_migrations()

        for migration in migrations:
            if migration['version'] > current_version:
                self.apply_migration(migration)

    def rollback(self, target_version: int):
        """å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬"""
        # æ³¨æ„ï¼šéœ€è¦ç»´æŠ¤å›æ»šè„šæœ¬
        current_version = self.get_current_version()

        if target_version >= current_version:
            raise ValueError(f"ç›®æ ‡ç‰ˆæœ¬ {target_version} å¿…é¡»å°äºå½“å‰ç‰ˆæœ¬ {current_version}")

        cursor = self.conn.cursor()
        cursor.execute("""
            SELECT version FROM schema_version
            WHERE version > ?
            ORDER BY version DESC
        """, (target_version,))

        versions_to_rollback = [row[0] for row in cursor.fetchall()]

        # æ‰§è¡Œå›æ»šï¼ˆéœ€è¦å›æ»šè„šæœ¬ï¼‰
        for version in versions_to_rollback:
            rollback_file = self.migrations_dir / f"{version:03d}_rollback.sql"
            if rollback_file.exists():
                with open(rollback_file, 'r') as f:
                    rollback_sql = f.read()
                cursor.executescript(rollback_sql)
                cursor.execute("DELETE FROM schema_version WHERE version = ?", (version,))

        self.conn.commit()
```

### 4.2 é«˜çº§ç‰ˆæœ¬æ§åˆ¶åŠŸèƒ½

```python
class AdvancedVersionControl(SimpleVersionControl):
    def __init__(self, db_path: str, migrations_dir: str = 'migrations'):
        super().__init__(db_path, migrations_dir)
        self.setup_advanced_tables()

    def setup_advanced_tables(self):
        """è®¾ç½®é«˜çº§åŠŸèƒ½è¡¨"""
        cursor = self.conn.cursor()

        # è¿ç§»å†å²è¯¦æƒ…
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS migration_history (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                version INTEGER NOT NULL,
                name TEXT NOT NULL,
                checksum TEXT NOT NULL,
                applied_at INTEGER NOT NULL,
                execution_time REAL,
                success INTEGER,
                error_message TEXT,
                FOREIGN KEY (version) REFERENCES schema_version(version)
            )
        """)

        # ç¯å¢ƒä¿¡æ¯
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS environment_info (
                environment TEXT PRIMARY KEY,
                current_version INTEGER,
                last_migration_at INTEGER,
                updated_at INTEGER NOT NULL
            )
        """)

        self.conn.commit()

    def record_migration_history(self, migration: Dict, execution_time: float,
                                 success: bool, error_message: str = None):
        """è®°å½•è¿ç§»å†å²"""
        cursor = self.conn.cursor()
        cursor.execute("""
            INSERT INTO migration_history
            (version, name, checksum, applied_at, execution_time, success, error_message)
            VALUES (?, ?, ?, strftime('%s', 'now'), ?, ?, ?)
        """, (
            migration['version'],
            migration['name'],
            migration['checksum'],
            execution_time,
            1 if success else 0,
            error_message
        ))
        self.conn.commit()

    def get_migration_history(self, limit: int = 100) -> List[Dict]:
        """è·å–è¿ç§»å†å²"""
        cursor = self.conn.cursor()
        cursor.execute("""
            SELECT * FROM migration_history
            ORDER BY applied_at DESC
            LIMIT ?
        """, (limit,))

        return [dict(row) for row in cursor.fetchall()]

    def validate_migrations(self) -> Dict:
        """éªŒè¯è¿ç§»"""
        cursor = self.conn.cursor()

        # æ£€æŸ¥å·²åº”ç”¨çš„è¿ç§»
        cursor.execute("SELECT version, checksum FROM schema_version")
        applied = {row[0]: row[1] for row in cursor.fetchall()}

        # æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿä¸­çš„è¿ç§»
        migrations = self.load_migrations()
        file_checksums = {m['version']: m['checksum'] for m in migrations}

        # æ¯”è¾ƒ
        issues = []
        for version, checksum in applied.items():
            if version in file_checksums:
                if file_checksums[version] != checksum:
                    issues.append({
                        'version': version,
                        'issue': 'checksum_mismatch',
                        'message': f'è¿ç§» {version} çš„æ ¡éªŒå’Œä¸åŒ¹é…'
                    })
            else:
                issues.append({
                    'version': version,
                    'issue': 'file_missing',
                    'message': f'è¿ç§» {version} çš„æ–‡ä»¶ä¸å­˜åœ¨'
                })

        return {
            'valid': len(issues) == 0,
            'issues': issues
        }
```

---

## 5. å¤šç¯å¢ƒéƒ¨ç½²ç­–ç•¥

### 5.1 ç¯å¢ƒé…ç½®ç®¡ç†

```python
import os
from typing import Dict

class EnvironmentConfig:
    def __init__(self):
        self.environments = {
            'development': {
                'db_path': './dev.db',
                'migrations_dir': './migrations',
                'auto_migrate': True,
                'backup_before_migrate': False
            },
            'testing': {
                'db_path': './test.db',
                'migrations_dir': './migrations',
                'auto_migrate': True,
                'backup_before_migrate': False
            },
            'staging': {
                'db_path': './staging.db',
                'migrations_dir': './migrations',
                'auto_migrate': False,
                'backup_before_migrate': True
            },
            'production': {
                'db_path': './production.db',
                'migrations_dir': './migrations',
                'auto_migrate': False,
                'backup_before_migrate': True
            }
        }

    def get_config(self, environment: str) -> Dict:
        """è·å–ç¯å¢ƒé…ç½®"""
        return self.environments.get(environment, {})

    def get_current_environment(self) -> str:
        """è·å–å½“å‰ç¯å¢ƒ"""
        return os.getenv('ENVIRONMENT', 'development')
```

### 5.2 ç¯å¢ƒç‰¹å®šè¿ç§»

```python
class EnvironmentAwareMigration:
    def __init__(self, version_control: SimpleVersionControl,
                 environment: str):
        self.version_control = version_control
        self.environment = environment

    def load_migrations(self) -> List[Dict]:
        """åŠ è½½è¿ç§»ï¼ˆè€ƒè™‘ç¯å¢ƒï¼‰"""
        all_migrations = self.version_control.load_migrations()

        # è¿‡æ»¤ç¯å¢ƒç‰¹å®šè¿ç§»
        filtered = []
        for migration in all_migrations:
            # æ£€æŸ¥æ˜¯å¦æœ‰ç¯å¢ƒé™åˆ¶
            if self.is_migration_for_environment(migration):
                filtered.append(migration)

        return filtered

    def is_migration_for_environment(self, migration: Dict) -> bool:
        """æ£€æŸ¥è¿ç§»æ˜¯å¦é€‚ç”¨äºå½“å‰ç¯å¢ƒ"""
        # æ£€æŸ¥æ–‡ä»¶åä¸­çš„ç¯å¢ƒæ ‡è®°
        # ä¾‹å¦‚: 001_initial_schema_prod.sql åªåœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œ
        name = migration['name'].lower()

        if '_prod' in name or '_production' in name:
            return self.environment == 'production'
        elif '_dev' in name or '_development' in name:
            return self.environment in ['development', 'testing']
        elif '_test' in name or '_testing' in name:
            return self.environment == 'testing'
        else:
            return True  # é»˜è®¤é€‚ç”¨äºæ‰€æœ‰ç¯å¢ƒ
```

### 5.3 éƒ¨ç½²æµç¨‹

```python
class DeploymentManager:
    def __init__(self, version_control: SimpleVersionControl,
                 environment: str):
        self.version_control = version_control
        self.environment = environment
        self.config = EnvironmentConfig()

    def deploy(self, backup: bool = True) -> Dict:
        """éƒ¨ç½²è¿ç§»"""
        env_config = self.config.get_config(self.environment)

        # 1. å¤‡ä»½ï¼ˆå¦‚æœéœ€è¦ï¼‰
        if backup and env_config.get('backup_before_migrate', False):
            self.backup_database()

        # 2. éªŒè¯
        validation = self.version_control.validate_migrations()
        if not validation['valid']:
            return {
                'success': False,
                'reason': 'è¿ç§»éªŒè¯å¤±è´¥',
                'issues': validation['issues']
            }

        # 3. æ‰§è¡Œè¿ç§»
        try:
            self.version_control.migrate()
            return {
                'success': True,
                'message': 'è¿ç§»æˆåŠŸ'
            }
        except Exception as e:
            return {
                'success': False,
                'reason': str(e)
            }

    def backup_database(self):
        """å¤‡ä»½æ•°æ®åº“"""
        from datetime import datetime
        import shutil

        backup_path = f"{self.version_control.db_path}.{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        shutil.copy2(self.version_control.db_path, backup_path)
        print(f"æ•°æ®åº“å·²å¤‡ä»½åˆ°: {backup_path}")
```

---

## 6. å·¥å…·å¯¹æ¯”ä¸é€‰å‹

### 6.1 å·¥å…·å¯¹æ¯”çŸ©é˜µ

| ç‰¹æ€§ | Flyway | Liquibase | Alembic | è‡ªå®šä¹‰ |
|------|--------|-----------|---------|--------|
| **æ˜“ç”¨æ€§** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­ |
| **SQLæ”¯æŒ** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­â­â­ |
| **å›æ»šæ”¯æŒ** | â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **å¤šæ ¼å¼** | â­â­ | â­â­â­â­â­ | â­â­ | â­â­â­â­â­ |
| **Pythoné›†æˆ** | â­â­ | â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| **å­¦ä¹ æ›²çº¿** | ä½ | ä¸­ | ä¸­ | é«˜ |
| **ç¤¾åŒºæ”¯æŒ** | â­â­â­â­ | â­â­â­â­ | â­â­â­â­ | - |

### 6.2 é€‰å‹å»ºè®®

**é€‰æ‹©Flywayå¦‚æœ**ï¼š

- éœ€è¦ç®€å•å¿«é€Ÿçš„è§£å†³æ–¹æ¡ˆ
- ä¸»è¦ä½¿ç”¨SQLè¿ç§»
- å›¢é˜Ÿç†Ÿæ‚‰Javaç”Ÿæ€

**é€‰æ‹©Liquibaseå¦‚æœ**ï¼š

- éœ€è¦å¼ºå¤§çš„å›æ»šåŠŸèƒ½
- éœ€è¦å¤šæ ¼å¼æ”¯æŒ
- éœ€è¦å¤æ‚çš„å˜æ›´ç®¡ç†

**é€‰æ‹©Alembicå¦‚æœ**ï¼š

- ä½¿ç”¨Python/SQLAlchemy
- éœ€è¦è‡ªåŠ¨ç”Ÿæˆè¿ç§»
- Pythonå›¢é˜Ÿ

**é€‰æ‹©è‡ªå®šä¹‰å¦‚æœ**ï¼š

- æœ‰ç‰¹æ®Šéœ€æ±‚
- éœ€è¦å®Œå…¨æ§åˆ¶
- è½»é‡çº§è§£å†³æ–¹æ¡ˆ

---

## 7. æœ€ä½³å®è·µ

### 7.1 ç‰ˆæœ¬æ§åˆ¶æœ€ä½³å®è·µ

1. **å‘½åè§„èŒƒ**
   - ä½¿ç”¨ç»Ÿä¸€çš„å‘½åæ ¼å¼
   - åŒ…å«ç‰ˆæœ¬å·å’Œæè¿°
   - é¿å…ç‰¹æ®Šå­—ç¬¦

2. **è¿ç§»è„šæœ¬**
   - ä¿æŒè„šæœ¬å¹‚ç­‰æ€§
   - é¿å…ç ´åæ€§å˜æ›´
   - æä¾›å›æ»šè„šæœ¬

3. **ç‰ˆæœ¬ç®¡ç†**
   - ç‰ˆæœ¬å·é€’å¢
   - è®°å½•å˜æ›´åŸå› 
   - ç»´æŠ¤å˜æ›´æ—¥å¿—

### 7.2 å¤šç¯å¢ƒéƒ¨ç½²æœ€ä½³å®è·µ

1. **ç¯å¢ƒéš”ç¦»**
   - æ¯ä¸ªç¯å¢ƒç‹¬ç«‹æ•°æ®åº“
   - ç¯å¢ƒç‰¹å®šé…ç½®
   - ç¯å¢ƒç‰¹å®šè¿ç§»

2. **éƒ¨ç½²æµç¨‹**
   - å¼€å‘ -> æµ‹è¯• -> é¢„å‘å¸ƒ -> ç”Ÿäº§
   - æ¯ä¸ªç¯å¢ƒéªŒè¯
   - ç”Ÿäº§ç¯å¢ƒäººå·¥å®¡æ ¸

3. **å›æ»šå‡†å¤‡**
   - ç»´æŠ¤å›æ»šè„šæœ¬
   - æµ‹è¯•å›æ»šæµç¨‹
   - å¿«é€Ÿå›æ»šæœºåˆ¶

---

## 8. ğŸ”— ç›¸å…³èµ„æº

### å†…éƒ¨èµ„æº

- [å¼€å‘å·¥ä½œæµä¸CI/CDé›†æˆ](./08.17-SQLiteå¼€å‘å·¥ä½œæµä¸CI-CDé›†æˆ.md) - CI/CDåŸºç¡€
- [æ™ºèƒ½åŒ–CI/CDå®è·µ](./08.18-æ™ºèƒ½åŒ–CI-CDå®è·µæŒ‡å—.md) - æ™ºèƒ½åŒ–å®è·µ
- [DataOpså®è·µ](./08.19-DataOpsé©±åŠ¨çš„æ•°æ®åº“CI-CDå®è·µ.md) - DataOpså®è·µ

### å¤–éƒ¨èµ„æº

- [Flywayæ–‡æ¡£](https://flywaydb.org/documentation/) - Flywayå®˜æ–¹æ–‡æ¡£
- [Liquibaseæ–‡æ¡£](https://docs.liquibase.com/) - Liquibaseå®˜æ–¹æ–‡æ¡£
- [Alembicæ–‡æ¡£](https://alembic.sqlalchemy.org/) - Alembicå®˜æ–¹æ–‡æ¡£

---

**æœ€åæ›´æ–°**: 2025-12-05
**ç»´æŠ¤è€…**: Data-Science Team
