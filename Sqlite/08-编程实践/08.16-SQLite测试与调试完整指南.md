# SQLiteæµ‹è¯•ä¸è°ƒè¯•å®Œæ•´æŒ‡å—

> **åˆ›å»ºæ—¥æœŸ**: 2025-12-05
> **ç‰ˆæœ¬**: SQLite 3.47.x
> **éš¾åº¦**: â­â­â­â­â­
> **é€‚ç”¨åœºæ™¯**: å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€æ€§èƒ½æµ‹è¯•ã€è°ƒè¯•æ’é”™

---

## ğŸ“‘ ç›®å½•

- [SQLiteæµ‹è¯•ä¸è°ƒè¯•å®Œæ•´æŒ‡å—](#sqliteæµ‹è¯•ä¸è°ƒè¯•å®Œæ•´æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [æµ‹è¯•ä½“ç³»æ€»è§ˆ](#æµ‹è¯•ä½“ç³»æ€»è§ˆ)
  - [1. å•å…ƒæµ‹è¯•](#1-å•å…ƒæµ‹è¯•)
    - [1.1 æµ‹è¯•æ¡†æ¶](#11-æµ‹è¯•æ¡†æ¶)
    - [1.2 æµ‹è¯•æ•°æ®åº“ç®¡ç†](#12-æµ‹è¯•æ•°æ®åº“ç®¡ç†)
    - [1.3 æµ‹è¯•æ•°æ®å‡†å¤‡](#13-æµ‹è¯•æ•°æ®å‡†å¤‡)
  - [2. é›†æˆæµ‹è¯•](#2-é›†æˆæµ‹è¯•)
    - [2.1 äº‹åŠ¡æµ‹è¯•](#21-äº‹åŠ¡æµ‹è¯•)
    - [2.2 å¹¶å‘æµ‹è¯•](#22-å¹¶å‘æµ‹è¯•)
    - [2.3 æ€§èƒ½æµ‹è¯•](#23-æ€§èƒ½æµ‹è¯•)
  - [3. è°ƒè¯•æŠ€å·§](#3-è°ƒè¯•æŠ€å·§)
    - [3.1 SQLè°ƒè¯•](#31-sqlè°ƒè¯•)
    - [3.2 æŸ¥è¯¢è®¡åˆ’è°ƒè¯•](#32-æŸ¥è¯¢è®¡åˆ’è°ƒè¯•)
    - [3.3 æ€§èƒ½è°ƒè¯•](#33-æ€§èƒ½è°ƒè¯•)
  - [4. æµ‹è¯•å·¥å…·](#4-æµ‹è¯•å·¥å…·)
    - [4.1 Pythonæµ‹è¯•å·¥å…·](#41-pythonæµ‹è¯•å·¥å…·)
    - [4.2 æµ‹è¯•æ•°æ®ç”Ÿæˆ](#42-æµ‹è¯•æ•°æ®ç”Ÿæˆ)
  - [5. æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
    - [5.1 æµ‹è¯•æœ€ä½³å®è·µ](#51-æµ‹è¯•æœ€ä½³å®è·µ)
    - [5.2 è°ƒè¯•æœ€ä½³å®è·µ](#52-è°ƒè¯•æœ€ä½³å®è·µ)
  - [6. ğŸ”— ç›¸å…³èµ„æº](#6--ç›¸å…³èµ„æº)
    - [å†…éƒ¨èµ„æº](#å†…éƒ¨èµ„æº)
    - [å¤–éƒ¨èµ„æº](#å¤–éƒ¨èµ„æº)

---

## æµ‹è¯•ä½“ç³»æ€»è§ˆ

```text
SQLiteæµ‹è¯•ä½“ç³»
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æµ‹è¯•å±‚æ¬¡                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. å•å…ƒæµ‹è¯•                                                              â”‚
â”‚    â€¢ å‡½æ•°çº§æµ‹è¯•                                                          â”‚
â”‚    â€¢ æ•°æ®è®¿é—®å±‚æµ‹è¯•                                                      â”‚
â”‚    â€¢ ä¸šåŠ¡é€»è¾‘æµ‹è¯•                                                        â”‚
â”‚                                                                          â”‚
â”‚ 2. é›†æˆæµ‹è¯•                                                              â”‚
â”‚    â€¢ æ•°æ®åº“æ“ä½œæµ‹è¯•                                                      â”‚
â”‚    â€¢ äº‹åŠ¡æµ‹è¯•                                                            â”‚
â”‚    â€¢ å¹¶å‘æµ‹è¯•                                                            â”‚
â”‚                                                                          â”‚
â”‚ 3. æ€§èƒ½æµ‹è¯•                                                              â”‚
â”‚    â€¢ æŸ¥è¯¢æ€§èƒ½æµ‹è¯•                                                        â”‚
â”‚    â€¢ å†™å…¥æ€§èƒ½æµ‹è¯•                                                        â”‚
â”‚    â€¢ å‹åŠ›æµ‹è¯•                                                            â”‚
â”‚                                                                          â”‚
â”‚ 4. è°ƒè¯•å·¥å…·                                                              â”‚
â”‚    â€¢ SQLè°ƒè¯•                                                             â”‚
â”‚    â€¢ æŸ¥è¯¢è®¡åˆ’åˆ†æ                                                        â”‚
â”‚    â€¢ æ€§èƒ½åˆ†æ                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. å•å…ƒæµ‹è¯•

### 1.1 æµ‹è¯•æ¡†æ¶

```python
import unittest
import sqlite3
import tempfile
import os
from pathlib import Path

class SQLiteTestCase(unittest.TestCase):
    """SQLiteæµ‹è¯•åŸºç±»"""

    def setUp(self):
        """æ¯ä¸ªæµ‹è¯•å‰åˆ›å»ºä¸´æ—¶æ•°æ®åº“"""
        self.db_fd, self.db_path = tempfile.mkstemp(suffix='.db')
        self.conn = sqlite3.connect(self.db_path)
        self.setup_schema()

    def tearDown(self):
        """æ¯ä¸ªæµ‹è¯•åæ¸…ç†"""
        self.conn.close()
        os.close(self.db_fd)
        os.unlink(self.db_path)

    def setup_schema(self):
        """è®¾ç½®æµ‹è¯•æ•°æ®åº“ç»“æ„"""
        cursor = self.conn.cursor()
        cursor.execute("""
            CREATE TABLE users (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                email TEXT UNIQUE NOT NULL,
                created_at INTEGER NOT NULL
            )
        """)
        self.conn.commit()

    def insert_test_user(self, name: str, email: str):
        """æ’å…¥æµ‹è¯•ç”¨æˆ·"""
        cursor = self.conn.cursor()
        cursor.execute("""
            INSERT INTO users (name, email, created_at)
            VALUES (?, ?, strftime('%s', 'now'))
        """, (name, email))
        self.conn.commit()
        return cursor.lastrowid

class UserRepositoryTest(SQLiteTestCase):
    """ç”¨æˆ·ä»“å‚¨æµ‹è¯•"""

    def test_insert_user(self):
        """æµ‹è¯•æ’å…¥ç”¨æˆ·"""
        user_id = self.insert_test_user('Alice', 'alice@example.com')
        self.assertIsNotNone(user_id)
        self.assertGreater(user_id, 0)

    def test_get_user(self):
        """æµ‹è¯•è·å–ç”¨æˆ·"""
        user_id = self.insert_test_user('Bob', 'bob@example.com')

        cursor = self.conn.cursor()
        cursor.execute("SELECT * FROM users WHERE id = ?", (user_id,))
        user = cursor.fetchone()

        self.assertIsNotNone(user)
        self.assertEqual(user[1], 'Bob')
        self.assertEqual(user[2], 'bob@example.com')

    def test_unique_email_constraint(self):
        """æµ‹è¯•å”¯ä¸€é‚®ç®±çº¦æŸ"""
        self.insert_test_user('Alice', 'alice@example.com')

        # å°è¯•æ’å…¥é‡å¤é‚®ç®±
        with self.assertRaises(sqlite3.IntegrityError):
            self.insert_test_user('Bob', 'alice@example.com')
```

### 1.2 æµ‹è¯•æ•°æ®åº“ç®¡ç†

```python
import pytest
import sqlite3
from contextlib import contextmanager

@pytest.fixture
def test_db():
    """æµ‹è¯•æ•°æ®åº“fixture"""
    import tempfile
    db_fd, db_path = tempfile.mkstemp(suffix='.db')
    conn = sqlite3.connect(db_path)

    # è®¾ç½®æµ‹è¯•ç¯å¢ƒ
    cursor = conn.cursor()
    cursor.execute("PRAGMA foreign_keys = ON")
    cursor.execute("PRAGMA journal_mode = WAL")
    conn.commit()

    yield conn

    # æ¸…ç†
    conn.close()
    os.close(db_fd)
    os.unlink(db_path)

@pytest.fixture
def test_db_with_data(test_db):
    """å¸¦æµ‹è¯•æ•°æ®çš„æ•°æ®åº“fixture"""
    cursor = test_db.cursor()
    cursor.execute("""
        CREATE TABLE users (
            id INTEGER PRIMARY KEY,
            name TEXT NOT NULL,
            email TEXT UNIQUE
        )
    """)

    # æ’å…¥æµ‹è¯•æ•°æ®
    test_users = [
        ('Alice', 'alice@example.com'),
        ('Bob', 'bob@example.com'),
        ('Charlie', 'charlie@example.com')
    ]
    cursor.executemany(
        "INSERT INTO users (name, email) VALUES (?, ?)",
        test_users
    )
    test_db.commit()

    return test_db

def test_user_count(test_db_with_data):
    """æµ‹è¯•ç”¨æˆ·æ•°é‡"""
    cursor = test_db_with_data.cursor()
    cursor.execute("SELECT COUNT(*) FROM users")
    count = cursor.fetchone()[0]
    assert count == 3
```

### 1.3 æµ‹è¯•æ•°æ®å‡†å¤‡

```python
class TestDataFactory:
    """æµ‹è¯•æ•°æ®å·¥å‚"""

    def __init__(self, conn):
        self.conn = conn

    def create_users(self, count: int = 10):
        """åˆ›å»ºæµ‹è¯•ç”¨æˆ·"""
        cursor = self.conn.cursor()
        users = []

        for i in range(count):
            name = f"User{i}"
            email = f"user{i}@example.com"
            cursor.execute("""
                INSERT INTO users (name, email, created_at)
                VALUES (?, ?, strftime('%s', 'now'))
            """, (name, email))
            users.append(cursor.lastrowid)

        self.conn.commit()
        return users

    def create_orders(self, user_ids: list, count_per_user: int = 5):
        """åˆ›å»ºæµ‹è¯•è®¢å•"""
        cursor = self.conn.cursor()
        orders = []

        for user_id in user_ids:
            for i in range(count_per_user):
                amount = 10.0 + i * 5.0
                cursor.execute("""
                    INSERT INTO orders (user_id, amount, created_at)
                    VALUES (?, ?, strftime('%s', 'now'))
                """, (user_id, amount))
                orders.append(cursor.lastrowid)

        self.conn.commit()
        return orders

# ä½¿ç”¨ç¤ºä¾‹
class TestWithFactory(SQLiteTestCase):
    def setUp(self):
        super().setUp()
        self.factory = TestDataFactory(self.conn)

    def test_user_orders(self):
        """æµ‹è¯•ç”¨æˆ·è®¢å•"""
        user_ids = self.factory.create_users(5)
        orders = self.factory.create_orders(user_ids, 3)

        cursor = self.conn.cursor()
        cursor.execute("SELECT COUNT(*) FROM orders")
        count = cursor.fetchone()[0]

        self.assertEqual(count, 15)  # 5 users * 3 orders
```

---

## 2. é›†æˆæµ‹è¯•

### 2.1 äº‹åŠ¡æµ‹è¯•

```python
class TransactionTest(SQLiteTestCase):
    """äº‹åŠ¡æµ‹è¯•"""

    def test_transaction_rollback(self):
        """æµ‹è¯•äº‹åŠ¡å›æ»š"""
        cursor = self.conn.cursor()

        # å¼€å§‹äº‹åŠ¡
        cursor.execute("BEGIN TRANSACTION")

        # æ’å…¥æ•°æ®
        cursor.execute("""
            INSERT INTO users (name, email, created_at)
            VALUES (?, ?, strftime('%s', 'now'))
        """, ('Test', 'test@example.com'))

        # å›æ»š
        cursor.execute("ROLLBACK")

        # éªŒè¯æ•°æ®æœªæ’å…¥
        cursor.execute("SELECT COUNT(*) FROM users")
        count = cursor.fetchone()[0]
        self.assertEqual(count, 0)

    def test_transaction_commit(self):
        """æµ‹è¯•äº‹åŠ¡æäº¤"""
        cursor = self.conn.cursor()

        cursor.execute("BEGIN TRANSACTION")
        cursor.execute("""
            INSERT INTO users (name, email, created_at)
            VALUES (?, ?, strftime('%s', 'now'))
        """, ('Test', 'test@example.com'))
        cursor.execute("COMMIT")

        # éªŒè¯æ•°æ®å·²æ’å…¥
        cursor.execute("SELECT COUNT(*) FROM users")
        count = cursor.fetchone()[0]
        self.assertEqual(count, 1)

    def test_savepoint(self):
        """æµ‹è¯•ä¿å­˜ç‚¹"""
        cursor = self.conn.cursor()

        # æ’å…¥ç¬¬ä¸€ä¸ªç”¨æˆ·
        cursor.execute("""
            INSERT INTO users (name, email, created_at)
            VALUES (?, ?, strftime('%s', 'now'))
        """, ('User1', 'user1@example.com'))

        # åˆ›å»ºä¿å­˜ç‚¹
        cursor.execute("SAVEPOINT sp1")

        # æ’å…¥ç¬¬äºŒä¸ªç”¨æˆ·
        cursor.execute("""
            INSERT INTO users (name, email, created_at)
            VALUES (?, ?, strftime('%s', 'now'))
        """, ('User2', 'user2@example.com'))

        # å›æ»šåˆ°ä¿å­˜ç‚¹
        cursor.execute("ROLLBACK TO sp1")
        self.conn.commit()

        # éªŒè¯åªæœ‰ç¬¬ä¸€ä¸ªç”¨æˆ·
        cursor.execute("SELECT COUNT(*) FROM users")
        count = cursor.fetchone()[0]
        self.assertEqual(count, 1)
```

### 2.2 å¹¶å‘æµ‹è¯•

```python
import threading
import time

class ConcurrencyTest(SQLiteTestCase):
    """å¹¶å‘æµ‹è¯•"""

    def test_concurrent_reads(self):
        """æµ‹è¯•å¹¶å‘è¯»å–"""
        # å‡†å¤‡æµ‹è¯•æ•°æ®
        self.factory = TestDataFactory(self.conn)
        self.factory.create_users(100)

        results = []
        errors = []

        def read_users(thread_id):
            try:
                conn = sqlite3.connect(self.db_path)
                cursor = conn.cursor()
                cursor.execute("SELECT COUNT(*) FROM users")
                count = cursor.fetchone()[0]
                results.append(count)
                conn.close()
            except Exception as e:
                errors.append(e)

        # å¯åŠ¨10ä¸ªå¹¶å‘è¯»å–çº¿ç¨‹
        threads = []
        for i in range(10):
            thread = threading.Thread(target=read_users, args=(i,))
            threads.append(thread)
            thread.start()

        for thread in threads:
            thread.join()

        # éªŒè¯æ‰€æœ‰è¯»å–éƒ½æˆåŠŸ
        self.assertEqual(len(errors), 0)
        self.assertEqual(len(results), 10)
        self.assertTrue(all(count == 100 for count in results))

    def test_concurrent_writes(self):
        """æµ‹è¯•å¹¶å‘å†™å…¥ï¼ˆWALæ¨¡å¼ï¼‰"""
        cursor = self.conn.cursor()
        cursor.execute("PRAGMA journal_mode = WAL")
        self.conn.commit()

        write_count = [0]
        errors = []

        def write_user(thread_id):
            try:
                conn = sqlite3.connect(self.db_path)
                cursor = conn.cursor()
                cursor.execute("""
                    INSERT INTO users (name, email, created_at)
                    VALUES (?, ?, strftime('%s', 'now'))
                """, (f'User{thread_id}', f'user{thread_id}@example.com'))
                conn.commit()
                write_count[0] += 1
                conn.close()
            except Exception as e:
                errors.append(e)

        # å¯åŠ¨5ä¸ªå¹¶å‘å†™å…¥çº¿ç¨‹
        threads = []
        for i in range(5):
            thread = threading.Thread(target=write_user, args=(i,))
            threads.append(thread)
            thread.start()

        for thread in threads:
            thread.join()

        # éªŒè¯å†™å…¥æˆåŠŸ
        self.assertEqual(len(errors), 0)
        self.assertEqual(write_count[0], 5)

        cursor.execute("SELECT COUNT(*) FROM users")
        total_count = cursor.fetchone()[0]
        self.assertEqual(total_count, 5)
```

### 2.3 æ€§èƒ½æµ‹è¯•

```python
import time
from statistics import mean, stdev

class PerformanceTest(SQLiteTestCase):
    """æ€§èƒ½æµ‹è¯•"""

    def test_insert_performance(self):
        """æµ‹è¯•æ’å…¥æ€§èƒ½"""
        cursor = self.conn.cursor()

        # è®¾ç½®ä¼˜åŒ–
        cursor.execute("PRAGMA journal_mode = WAL")
        cursor.execute("PRAGMA synchronous = NORMAL")
        self.conn.commit()

        # æµ‹è¯•æ‰¹é‡æ’å…¥
        times = []
        for _ in range(10):
            start = time.time()

            cursor.execute("BEGIN TRANSACTION")
            for i in range(1000):
                cursor.execute("""
                    INSERT INTO users (name, email, created_at)
                    VALUES (?, ?, strftime('%s', 'now'))
                """, (f'User{i}', f'user{i}@example.com'))
            cursor.execute("COMMIT")

            elapsed = time.time() - start
            times.append(elapsed)

        avg_time = mean(times)
        print(f"å¹³å‡æ’å…¥æ—¶é—´: {avg_time:.3f}ç§’")
        print(f"ååé‡: {1000/avg_time:.0f} è¡Œ/ç§’")

        # æ–­è¨€æ€§èƒ½è¦æ±‚
        self.assertLess(avg_time, 0.1)  # 1000è¡Œåº”åœ¨0.1ç§’å†…å®Œæˆ

    def test_query_performance(self):
        """æµ‹è¯•æŸ¥è¯¢æ€§èƒ½"""
        # å‡†å¤‡æµ‹è¯•æ•°æ®
        factory = TestDataFactory(self.conn)
        factory.create_users(10000)

        # åˆ›å»ºç´¢å¼•
        cursor = self.conn.cursor()
        cursor.execute("CREATE INDEX idx_users_email ON users(email)")
        self.conn.commit()

        # æµ‹è¯•æŸ¥è¯¢æ€§èƒ½
        times = []
        for _ in range(100):
            start = time.time()
            cursor.execute("SELECT * FROM users WHERE email = ?",
                         ('user5000@example.com',))
            cursor.fetchone()
            elapsed = time.time() - start
            times.append(elapsed)

        avg_time = mean(times)
        print(f"å¹³å‡æŸ¥è¯¢æ—¶é—´: {avg_time*1000:.3f}æ¯«ç§’")

        # æ–­è¨€æ€§èƒ½è¦æ±‚
        self.assertLess(avg_time, 0.01)  # æŸ¥è¯¢åº”åœ¨10mså†…å®Œæˆ
```

---

## 3. è°ƒè¯•æŠ€å·§

### 3.1 SQLè°ƒè¯•

```python
class SQLDebugger:
    """SQLè°ƒè¯•å™¨"""

    def __init__(self, conn):
        self.conn = conn
        self.query_log = []

    def execute_with_logging(self, query: str, params: tuple = ()):
        """å¸¦æ—¥å¿—çš„æ‰§è¡Œ"""
        cursor = self.conn.cursor()

        start_time = time.time()
        try:
            cursor.execute(query, params)
            result = cursor.fetchall()
            elapsed = time.time() - start_time

            self.query_log.append({
                'query': query,
                'params': params,
                'elapsed': elapsed,
                'row_count': len(result),
                'success': True
            })

            return result
        except Exception as e:
            elapsed = time.time() - start_time
            self.query_log.append({
                'query': query,
                'params': params,
                'elapsed': elapsed,
                'error': str(e),
                'success': False
            })
            raise

    def get_slow_queries(self, threshold: float = 0.1):
        """è·å–æ…¢æŸ¥è¯¢"""
        return [
            log for log in self.query_log
            if log.get('elapsed', 0) > threshold
        ]

    def print_query_log(self):
        """æ‰“å°æŸ¥è¯¢æ—¥å¿—"""
        for log in self.query_log:
            print(f"æŸ¥è¯¢: {log['query']}")
            print(f"å‚æ•°: {log.get('params', ())}")
            print(f"è€—æ—¶: {log.get('elapsed', 0):.3f}ç§’")
            if not log.get('success'):
                print(f"é”™è¯¯: {log.get('error')}")
            print("-" * 50)
```

### 3.2 æŸ¥è¯¢è®¡åˆ’è°ƒè¯•

```python
class QueryPlanDebugger:
    """æŸ¥è¯¢è®¡åˆ’è°ƒè¯•å™¨"""

    def __init__(self, conn):
        self.conn = conn

    def explain_query_plan(self, query: str, params: tuple = ()):
        """åˆ†ææŸ¥è¯¢è®¡åˆ’"""
        cursor = self.conn.cursor()
        cursor.execute(f"EXPLAIN QUERY PLAN {query}", params)

        plan = cursor.fetchall()
        return plan

    def analyze_query(self, query: str, params: tuple = ()):
        """åˆ†ææŸ¥è¯¢ï¼ˆè¯¦ç»†ï¼‰"""
        plan = self.explain_query_plan(query, params)

        print("æŸ¥è¯¢è®¡åˆ’:")
        for row in plan:
            print(f"  {row}")

        # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ç´¢å¼•
        uses_index = any('USING INDEX' in str(row) for row in plan)
        if not uses_index:
            print("âš ï¸ è­¦å‘Š: æŸ¥è¯¢æœªä½¿ç”¨ç´¢å¼•")

        return plan

    def suggest_index(self, query: str):
        """å»ºè®®ç´¢å¼•"""
        # ç®€å•è§£æWHEREå­å¥
        import re
        where_match = re.search(r'WHERE\s+(\w+)\s*=', query, re.IGNORECASE)
        if where_match:
            column = where_match.group(1)
            print(f"å»ºè®®åˆ›å»ºç´¢å¼•: CREATE INDEX idx_{column} ON table_name({column})")
```

### 3.3 æ€§èƒ½è°ƒè¯•

```python
class PerformanceProfiler:
    """æ€§èƒ½åˆ†æå™¨"""

    def __init__(self, conn):
        self.conn = conn
        self.profiles = []

    def profile_query(self, query: str, params: tuple = (), iterations: int = 100):
        """æ€§èƒ½åˆ†ææŸ¥è¯¢"""
        cursor = self.conn.cursor()

        times = []
        for _ in range(iterations):
            start = time.time()
            cursor.execute(query, params)
            cursor.fetchall()
            elapsed = time.time() - start
            times.append(elapsed)

        profile = {
            'query': query,
            'iterations': iterations,
            'min': min(times),
            'max': max(times),
            'mean': mean(times),
            'median': sorted(times)[len(times)//2],
            'stdev': stdev(times) if len(times) > 1 else 0
        }

        self.profiles.append(profile)
        return profile

    def compare_queries(self, queries: list):
        """æ¯”è¾ƒå¤šä¸ªæŸ¥è¯¢çš„æ€§èƒ½"""
        results = []
        for query, params in queries:
            profile = self.profile_query(query, params)
            results.append({
                'query': query,
                'mean_time': profile['mean']
            })

        # æ’åº
        results.sort(key=lambda x: x['mean_time'])

        print("æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”:")
        for i, result in enumerate(results, 1):
            print(f"{i}. {result['query'][:50]}... - {result['mean_time']*1000:.3f}ms")

        return results
```

---

## 4. æµ‹è¯•å·¥å…·

### 4.1 Pythonæµ‹è¯•å·¥å…·

```python
import pytest
from unittest.mock import Mock, patch

class DatabaseMock:
    """æ•°æ®åº“Mock"""

    def __init__(self):
        self.data = {}
        self.queries = []

    def execute(self, query, params=()):
        """æ¨¡æ‹Ÿæ‰§è¡ŒæŸ¥è¯¢"""
        self.queries.append((query, params))

        if query.startswith('SELECT'):
            # æ¨¡æ‹ŸæŸ¥è¯¢ç»“æœ
            return [('result1',), ('result2',)]
        elif query.startswith('INSERT'):
            # æ¨¡æ‹Ÿæ’å…¥
            return 1
        return None

@pytest.fixture
def mock_db():
    """Mockæ•°æ®åº“fixture"""
    return DatabaseMock()

def test_with_mock(mock_db):
    """ä½¿ç”¨Mockçš„æµ‹è¯•"""
    result = mock_db.execute("SELECT * FROM users")
    assert len(result) == 2
    assert len(mock_db.queries) == 1

# ä½¿ç”¨pytestçš„å‚æ•°åŒ–æµ‹è¯•
@pytest.mark.parametrize("name,email,expected", [
    ('Alice', 'alice@example.com', True),
    ('', 'bob@example.com', False),  # ç©ºåç§°
    ('Charlie', 'invalid-email', False),  # æ— æ•ˆé‚®ç®±
])
def test_user_validation(test_db, name, email, expected):
    """å‚æ•°åŒ–æµ‹è¯•ç”¨æˆ·éªŒè¯"""
    try:
        cursor = test_db.cursor()
        cursor.execute("""
            INSERT INTO users (name, email, created_at)
            VALUES (?, ?, strftime('%s', 'now'))
        """, (name, email))
        test_db.commit()
        result = True
    except:
        result = False

    assert result == expected
```

### 4.2 æµ‹è¯•æ•°æ®ç”Ÿæˆ

```python
from faker import Faker

class TestDataGenerator:
    """æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨"""

    def __init__(self):
        self.fake = Faker('zh_CN')

    def generate_user(self) -> dict:
        """ç”Ÿæˆæµ‹è¯•ç”¨æˆ·"""
        return {
            'name': self.fake.name(),
            'email': self.fake.email(),
            'created_at': int(time.time())
        }

    def generate_users(self, count: int) -> list:
        """ç”Ÿæˆå¤šä¸ªæµ‹è¯•ç”¨æˆ·"""
        return [self.generate_user() for _ in range(count)]

    def insert_generated_users(self, conn, count: int):
        """æ’å…¥ç”Ÿæˆçš„ç”¨æˆ·"""
        users = self.generate_users(count)
        cursor = conn.cursor()
        cursor.executemany("""
            INSERT INTO users (name, email, created_at)
            VALUES (?, ?, ?)
        """, [(u['name'], u['email'], u['created_at']) for u in users])
        conn.commit()
        return users

# ä½¿ç”¨ç¤ºä¾‹
def test_with_generated_data(test_db):
    """ä½¿ç”¨ç”Ÿæˆæ•°æ®çš„æµ‹è¯•"""
    generator = TestDataGenerator()
    users = generator.insert_generated_users(test_db, 100)

    cursor = test_db.cursor()
    cursor.execute("SELECT COUNT(*) FROM users")
    count = cursor.fetchone()[0]

    assert count == 100
```

---

## 5. æœ€ä½³å®è·µ

### 5.1 æµ‹è¯•æœ€ä½³å®è·µ

1. **éš”ç¦»æ€§**
   - æ¯ä¸ªæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“
   - æµ‹è¯•ä¹‹é—´ä¸å…±äº«çŠ¶æ€
   - ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ¸…ç†

2. **å¯é‡å¤æ€§**
   - ä½¿ç”¨å›ºå®šç§å­ç”Ÿæˆæµ‹è¯•æ•°æ®
   - é¿å…ä¾èµ–å¤–éƒ¨èµ„æº
   - æµ‹è¯•ç»“æœå¯é¢„æµ‹

3. **æ€§èƒ½æµ‹è¯•**
   - è®¾ç½®åˆç†çš„æ€§èƒ½åŸºå‡†
   - ç›‘æ§æ€§èƒ½å›å½’
   - å®šæœŸè¿è¡Œæ€§èƒ½æµ‹è¯•

### 5.2 è°ƒè¯•æœ€ä½³å®è·µ

1. **æ—¥å¿—è®°å½•**
   - è®°å½•æ‰€æœ‰SQLæŸ¥è¯¢
   - è®°å½•æ‰§è¡Œæ—¶é—´
   - è®°å½•é”™è¯¯ä¿¡æ¯

2. **æŸ¥è¯¢åˆ†æ**
   - ä½¿ç”¨EXPLAIN QUERY PLAN
   - æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
   - ä¼˜åŒ–æ…¢æŸ¥è¯¢

3. **æ€§èƒ½åˆ†æ**
   - ä½¿ç”¨æ€§èƒ½åˆ†æå·¥å…·
   - è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ
   - æŒç»­ä¼˜åŒ–

---

## 6. ğŸ”— ç›¸å…³èµ„æº

### å†…éƒ¨èµ„æº

- [æŸ¥è¯¢ä¼˜åŒ–](./08.03-æŸ¥è¯¢ä¼˜åŒ–.md) - æŸ¥è¯¢ä¼˜åŒ–å®è·µ
- [é”™è¯¯å¤„ç†](./08.05-é”™è¯¯å¤„ç†.md) - é”™è¯¯å¤„ç†
- [ç”Ÿäº§ç¯å¢ƒç›‘æ§](./08.13-SQLiteç”Ÿäº§ç¯å¢ƒç›‘æ§ä¸è¯Šæ–­.md) - ç›‘æ§å’Œè¯Šæ–­

### å¤–éƒ¨èµ„æº

- [pytestæ–‡æ¡£](https://docs.pytest.org/) - Pythonæµ‹è¯•æ¡†æ¶
- [unittestæ–‡æ¡£](https://docs.python.org/3/library/unittest.html) - Pythonå•å…ƒæµ‹è¯•
- [SQLiteæµ‹è¯•](https://www.sqlite.org/testing.html) - SQLiteå®˜æ–¹æµ‹è¯•æ–‡æ¡£

---

**æœ€åæ›´æ–°**: 2025-12-05
**ç»´æŠ¤è€…**: Data-Science Team
