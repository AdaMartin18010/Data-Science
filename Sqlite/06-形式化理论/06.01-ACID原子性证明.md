# ACIDåŸå­æ€§è¯æ˜ï¼šå½¢å¼åŒ–è®ºè¯ä¸å®ç°ä¿è¯

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-11-13
> **æœ€åæ›´æ–°**ï¼š2025-01-15
> **ç‰ˆæœ¬**ï¼šSQLite 3.31+ è‡³ 3.47.x

---

## 1. ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£é€šè¿‡å½¢å¼åŒ–æ–¹æ³•è¯æ˜SQLiteçš„ACIDåŸå­æ€§ä¿è¯ï¼ŒåŒ…æ‹¬äº‹åŠ¡åŸå­æ€§ã€å´©æºƒæ¢å¤å’Œä¸€è‡´æ€§ä¿è¯çš„å½¢å¼åŒ–è®ºè¯ã€‚

---

## 2. ğŸ“‘ ç›®å½•

- [ACIDåŸå­æ€§è¯æ˜ï¼šå½¢å¼åŒ–è®ºè¯ä¸å®ç°ä¿è¯](#acidåŸå­æ€§è¯æ˜å½¢å¼åŒ–è®ºè¯ä¸å®ç°ä¿è¯)
  - [1. ğŸ“‹ æ¦‚è¿°](#1--æ¦‚è¿°)
  - [2. ğŸ“‘ ç›®å½•](#2--ç›®å½•)
  - [3. ğŸ“Š æ€ç»´å¯¼å›¾](#3--æ€ç»´å¯¼å›¾)
  - [4. åŸå­æ€§å®šä¹‰ä¸å½¢å¼åŒ–](#4-åŸå­æ€§å®šä¹‰ä¸å½¢å¼åŒ–)
    - [4.1. åŸå­æ€§å®šä¹‰](#41-åŸå­æ€§å®šä¹‰)
    - [4.2. å½¢å¼åŒ–è¡¨ç¤º](#42-å½¢å¼åŒ–è¡¨ç¤º)
    - [4.3. åŸå­æ€§å…¬ç†](#43-åŸå­æ€§å…¬ç†)
  - [5. äº‹åŠ¡åŸå­æ€§è¯æ˜](#5-äº‹åŠ¡åŸå­æ€§è¯æ˜)
    - [5.1. äº‹åŠ¡çŠ¶æ€æœº](#51-äº‹åŠ¡çŠ¶æ€æœº)
    - [5.2. åŸå­æ€§ä¿è¯](#52-åŸå­æ€§ä¿è¯)
    - [5.3. å½¢å¼åŒ–è¯æ˜](#53-å½¢å¼åŒ–è¯æ˜)
  - [6. å´©æºƒæ¢å¤åŸå­æ€§è¯æ˜](#6-å´©æºƒæ¢å¤åŸå­æ€§è¯æ˜)
    - [6.1. å´©æºƒåœºæ™¯åˆ†ç±»](#61-å´©æºƒåœºæ™¯åˆ†ç±»)
    - [6.2. æ¢å¤ç®—æ³•](#62-æ¢å¤ç®—æ³•)
    - [6.3. åŸå­æ€§ä¿è¯è¯æ˜](#63-åŸå­æ€§ä¿è¯è¯æ˜)
  - [7. WALæ¨¡å¼åŸå­æ€§è¯æ˜](#7-walæ¨¡å¼åŸå­æ€§è¯æ˜)
    - [7.1. WALåŸå­æ€§æœºåˆ¶](#71-walåŸå­æ€§æœºåˆ¶)
    - [7.2. CheckpointåŸå­æ€§](#72-checkpointåŸå­æ€§)
    - [7.3. å½¢å¼åŒ–è¯æ˜](#73-å½¢å¼åŒ–è¯æ˜)
  - [8. å®ç°ä¿è¯](#8-å®ç°ä¿è¯)
    - [8.1. ä»£ç çº§ä¿è¯](#81-ä»£ç çº§ä¿è¯)
    - [8.2. æµ‹è¯•éªŒè¯ä¸ä»£ç ç¤ºä¾‹](#82-æµ‹è¯•éªŒè¯ä¸ä»£ç ç¤ºä¾‹)
  - [9. å®é™…æ¡ˆä¾‹ä¸éªŒè¯](#9-å®é™…æ¡ˆä¾‹ä¸éªŒè¯)
  - [10. ACIDåŸå­æ€§å¤šç»´å¯¹æ¯”çŸ©é˜µ](#10-acidåŸå­æ€§å¤šç»´å¯¹æ¯”çŸ©é˜µ)
    - [10.1. åŸå­æ€§ä¿è¯æœºåˆ¶å¯¹æ¯”çŸ©é˜µ](#101-åŸå­æ€§ä¿è¯æœºåˆ¶å¯¹æ¯”çŸ©é˜µ)
    - [10.2. äº‹åŠ¡çŠ¶æ€è½¬æ¢å¯¹æ¯”çŸ©é˜µ](#102-äº‹åŠ¡çŠ¶æ€è½¬æ¢å¯¹æ¯”çŸ©é˜µ)
    - [10.3. ACIDå±æ€§å¯¹æ¯”çŸ©é˜µ](#103-acidå±æ€§å¯¹æ¯”çŸ©é˜µ)
  - [11. åŸå­æ€§è¯æ˜æ€»ç»“](#11-åŸå­æ€§è¯æ˜æ€»ç»“)
    - [11.1. è¯æ˜è¦ç‚¹](#111-è¯æ˜è¦ç‚¹)
    - [11.2. ä¿è¯å¼ºåº¦](#112-ä¿è¯å¼ºåº¦)
  - [12. ğŸ”— ç›¸å…³èµ„æº](#12--ç›¸å…³èµ„æº)
  - [13. ğŸ”— äº¤å‰å¼•ç”¨](#13--äº¤å‰å¼•ç”¨)
    - [13.1. ç†è®ºæ¨¡å‹ ğŸ†•](#131-ç†è®ºæ¨¡å‹-)
    - [13.2. è®¾è®¡æ¨¡å‹ ğŸ†•](#132-è®¾è®¡æ¨¡å‹-)
  - [14. ğŸ“š å‚è€ƒèµ„æ–™](#14--å‚è€ƒèµ„æ–™)

---

## 3. ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((ACIDåŸå­æ€§è¯æ˜))
    åŸå­æ€§å®šä¹‰ä¸å½¢å¼åŒ–
      åŸå­æ€§å®šä¹‰
        å…¨æœ‰å…¨æ— 
        çŠ¶æ€ä¸€è‡´æ€§
        æ“ä½œåŸå­æ€§
      å½¢å¼åŒ–è¡¨ç¤º
        äº‹åŠ¡æ¨¡å‹
        çŠ¶æ€æ¨¡å‹
        åŸå­æ€§ä¸å˜å¼
      åŸå­æ€§å…¬ç†
        å…¨æœ‰å…¨æ— å…¬ç†
        çŠ¶æ€ä¸€è‡´æ€§å…¬ç†
        æ“ä½œåŸå­æ€§å…¬ç†
    äº‹åŠ¡åŸå­æ€§è¯æ˜
      äº‹åŠ¡çŠ¶æ€æœº
        çŠ¶æ€å®šä¹‰
        çŠ¶æ€è½¬æ¢
        çŠ¶æ€ä¸å˜å¼
      åŸå­æ€§ä¿è¯
        æäº¤ä¿è¯
        å›æ»šä¿è¯
        éƒ¨åˆ†çŠ¶æ€ç¦æ­¢
      å½¢å¼åŒ–è¯æ˜
        å½’çº³è¯æ˜
        ä¸å˜å¼è¯æ˜
        æ­£ç¡®æ€§è¯æ˜
    å´©æºƒæ¢å¤åŸå­æ€§è¯æ˜
      å´©æºƒåœºæ™¯åˆ†ç±»
        æäº¤å‰å´©æºƒ
        æäº¤ä¸­å´©æºƒ
        æäº¤åå´©æºƒ
      æ¢å¤ç®—æ³•
        æ—¥å¿—åˆ†æ
        çŠ¶æ€æ¢å¤
        åŸå­æ€§ä¿è¯
      åŸå­æ€§ä¿è¯è¯æ˜
        æ¢å¤æ­£ç¡®æ€§
        çŠ¶æ€ä¸€è‡´æ€§
        åŸå­æ€§ä¿è¯
    WALæ¨¡å¼åŸå­æ€§è¯æ˜
      WALåŸå­æ€§æœºåˆ¶
        é¢„å†™æ—¥å¿—
        åŸå­å†™å…¥
        çŠ¶æ€ä¸€è‡´æ€§
      CheckpointåŸå­æ€§
        Checkpointè¿‡ç¨‹
        åŸå­æ€§ä¿è¯
        çŠ¶æ€ä¸€è‡´æ€§
      å½¢å¼åŒ–è¯æ˜
        WALæ­£ç¡®æ€§
        Checkpointæ­£ç¡®æ€§
        åŸå­æ€§ä¿è¯
    å®ç°ä¿è¯
      ä»£ç çº§ä¿è¯
        ä»£ç å®ç°
        åŸå­æ€§æ£€æŸ¥
        é”™è¯¯å¤„ç†
      æµ‹è¯•éªŒè¯
        å•å…ƒæµ‹è¯•
        é›†æˆæµ‹è¯•
        å‹åŠ›æµ‹è¯•
      å®é™…æ¡ˆä¾‹
        ç”Ÿäº§éªŒè¯
        æ•…éšœåˆ†æ
        å¯é æ€§éªŒè¯
    åŸå­æ€§è¯æ˜æ€»ç»“
      è¯æ˜è¦ç‚¹
        å½¢å¼åŒ–å®šä¹‰
        çŠ¶æ€æœºè¯æ˜
        æ¢å¤ç®—æ³•è¯æ˜
      ä¿è¯å¼ºåº¦
        ç†è®ºä¿è¯
        å®ç°ä¿è¯
        å®é™…éªŒè¯
```

---

## 4. åŸå­æ€§å®šä¹‰ä¸å½¢å¼åŒ–

### 4.1. åŸå­æ€§å®šä¹‰

**å®šä¹‰1ï¼ˆåŸå­æ€§ï¼‰**ï¼šäº‹åŠ¡çš„åŸå­æ€§æ˜¯æŒ‡äº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä¸å­˜åœ¨éƒ¨åˆ†æˆåŠŸçš„æƒ…å†µã€‚

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
âˆ€T âˆˆ Transactions, âˆ€O âˆˆ Operations(T):
  (Commit(T) â†’ âˆ€O: Success(O)) âˆ§
  (Abort(T) â†’ âˆ€O: Rollback(O))
```

**é€šä¿—è§£é‡Š**ï¼š

- å¦‚æœäº‹åŠ¡æäº¤ï¼Œæ‰€æœ‰æ“ä½œéƒ½æˆåŠŸ
- å¦‚æœäº‹åŠ¡ä¸­æ­¢ï¼Œæ‰€æœ‰æ“ä½œéƒ½å›æ»š

### 4.2. å½¢å¼åŒ–è¡¨ç¤º

**äº‹åŠ¡æ¨¡å‹**ï¼š

```text
Transaction T = {Oâ‚, Oâ‚‚, ..., Oâ‚™}
State S = {Database, Log, Lock}

Atomicity(T) = âˆ€S, S':
  (T.Commit(S) â†’ S' = ApplyAll(T, S)) âˆ§
  (T.Abort(S) â†’ S' = S)
```

**åŸå­æ€§ä¸å˜å¼**ï¼š

```text
Invariant: Atomicity
  âˆ€T, âˆ€S:
    InProgress(T, S) â†’
      (S' = Commit(T, S) âˆ¨ S' = Abort(T, S)) âˆ§
      (S' â‰  PartialState(T, S))
```

### 4.3. åŸå­æ€§å…¬ç†

**å…¬ç†1ï¼ˆå…¨æœ‰å…¨æ— ï¼‰**ï¼š

```text
Axiom 1: All-or-Nothing
  âˆ€T: (Commit(T) âˆ¨ Abort(T)) âˆ§ Â¬(PartialCommit(T))
```

**å…¬ç†2ï¼ˆçŠ¶æ€ä¸€è‡´æ€§ï¼‰**ï¼š

```text
Axiom 2: State Consistency
  âˆ€T, S, S':
    Commit(T, S) = S' â†’ Consistent(S') âˆ§
    Abort(T, S) = S' â†’ S' = S
```

---

## 5. äº‹åŠ¡åŸå­æ€§è¯æ˜

### 5.1. äº‹åŠ¡çŠ¶æ€æœº

**äº‹åŠ¡çŠ¶æ€è½¬æ¢**ï¼š

```text
States: {INIT, ACTIVE, COMMITTING, COMMITTED, ABORTING, ABORTED}

Transitions:
  INIT â†’ ACTIVE: BEGIN TRANSACTION
  ACTIVE â†’ COMMITTING: COMMIT
  ACTIVE â†’ ABORTING: ROLLBACK
  COMMITTING â†’ COMMITTED: Commit Complete
  ABORTING â†’ ABORTED: Rollback Complete
```

**çŠ¶æ€æœºä¸å˜å¼**ï¼š

```text
Invariant: Transaction State Machine
  âˆ€T:
    (T.state = COMMITTED â†’ AllOps(T).applied) âˆ§
    (T.state = ABORTED â†’ AllOps(T).rolled_back) âˆ§
    Â¬(T.state = COMMITTED âˆ§ T.state = ABORTED)
```

### 5.2. åŸå­æ€§ä¿è¯

**å®šç†1ï¼ˆäº‹åŠ¡åŸå­æ€§ï¼‰**ï¼š

```text
Theorem 1: Transaction Atomicity
  âˆ€T, S, S':
    Execute(T, S) = S' â†’
      (T.result = COMMIT â†’ S' = ApplyAll(T, S)) âˆ§
      (T.result = ABORT â†’ S' = S)
```

**è¯æ˜æ€è·¯**ï¼š

1. **BEGINé˜¶æ®µ**ï¼šè®°å½•åˆå§‹çŠ¶æ€
2. **æ‰§è¡Œé˜¶æ®µ**ï¼šæ‰€æœ‰æ“ä½œå†™å…¥æ—¥å¿—ï¼Œä¸ç›´æ¥ä¿®æ”¹æ•°æ®åº“
3. **COMMITé˜¶æ®µ**ï¼šå°†æ—¥å¿—åº”ç”¨åˆ°æ•°æ®åº“ï¼Œæˆ–
4. **ABORTé˜¶æ®µ**ï¼šä¸¢å¼ƒæ—¥å¿—ï¼Œä¿æŒåŸçŠ¶æ€

### 5.3. å½¢å¼åŒ–è¯æ˜

**è¯æ˜ï¼šäº‹åŠ¡åŸå­æ€§**:

```text
Proof:
  1. âˆ€O âˆˆ T: WriteLog(O) before WriteDB(O)
     [æ—¥å¿—å…ˆå†™åŸåˆ™]

  2. Commit(T) â†’ âˆ€O: ApplyLog(O)
     [æäº¤æ—¶åº”ç”¨æ‰€æœ‰æ—¥å¿—]

  3. Abort(T) â†’ âˆ€O: DiscardLog(O)
     [ä¸­æ­¢æ—¶ä¸¢å¼ƒæ‰€æœ‰æ—¥å¿—]

  4. âˆ´ âˆ€T: (Commit(T) â†’ AllOpsApplied) âˆ§
          (Abort(T) â†’ NoOpsApplied)
     [åŸå­æ€§ä¿è¯]
```

---

## 6. å´©æºƒæ¢å¤åŸå­æ€§è¯æ˜

### 6.1. å´©æºƒåœºæ™¯åˆ†ç±»

**å´©æºƒåœºæ™¯**ï¼š

| åœºæ™¯ | çŠ¶æ€ | æ¢å¤ç­–ç•¥ |
|------|------|---------|
| å´©æºƒå‰BEGIN | æœªå¼€å§‹ | æ— å½±å“ |
| å´©æºƒä¸­æ‰§è¡Œ | éƒ¨åˆ†æ“ä½œ | å›æ»šæ‰€æœ‰æ“ä½œ |
| å´©æºƒä¸­COMMIT | éƒ¨åˆ†æäº¤ | å›æ»šæˆ–å®Œæˆæäº¤ |
| å´©æºƒåCOMMIT | å·²æäº¤ | æ— éœ€æ¢å¤ |

### 6.2. æ¢å¤ç®—æ³•

**æ¢å¤ç®—æ³•å½¢å¼åŒ–**ï¼š

```text
Recovery(S) =
  if âˆƒT: T.state = COMMITTING âˆ§ Incomplete(T)
    then CompleteCommit(T)
  else if âˆƒT: T.state = ACTIVE
    then Rollback(T)
  else
    S  // æ— éœ€æ¢å¤
```

**åŸå­æ€§ä¿è¯**ï¼š

```text
Theorem 2: Crash Recovery Atomicity
  âˆ€S, S_crash, S_recovered:
    Crash(S) = S_crash âˆ§
    Recovery(S_crash) = S_recovered â†’
      (Consistent(S_recovered) âˆ§
       âˆ€T: (T.state = COMMITTED â†’ AllOpsApplied) âˆ¨
           (T.state = ABORTED â†’ NoOpsApplied))
```

### 6.3. åŸå­æ€§ä¿è¯è¯æ˜

**è¯æ˜ï¼šå´©æºƒæ¢å¤åŸå­æ€§**:

```text
Proof:
  1. å´©æºƒæ£€æµ‹ï¼šæ£€æŸ¥æ—¥å¿—å®Œæ•´æ€§
     [æ—¥å¿—å®Œæ•´æ€§æ£€æŸ¥]

  2. æœªæäº¤äº‹åŠ¡ï¼šå›æ»šæ‰€æœ‰æ“ä½œ
     [Rollback(T) â†’ S' = S_initial]

  3. éƒ¨åˆ†æäº¤äº‹åŠ¡ï¼š
     a. æ—¥å¿—å®Œæ•´ â†’ å®Œæˆæäº¤
     b. æ—¥å¿—ä¸å®Œæ•´ â†’ å›æ»š
     [All-or-Nothingä¿è¯]

  4. âˆ´ æ¢å¤åçŠ¶æ€æ»¡è¶³åŸå­æ€§
     [åŸå­æ€§ä¿è¯]
```

---

## 7. WALæ¨¡å¼åŸå­æ€§è¯æ˜

### 7.1. WALåŸå­æ€§æœºåˆ¶

**WALåŸå­æ€§åŸç†**ï¼š

```text
WAL Atomicity:
  1. Write to WAL file (append-only)
  2. Sync WAL file (fsync)
  3. Update database pages
  4. Commit transaction
```

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
WAL_Commit(T) =
  AppendToWAL(T.operations) âˆ§
  Fsync(WAL) âˆ§
  ApplyToDB(T.operations) âˆ§
  MarkCommitted(T)
```

### 7.2. CheckpointåŸå­æ€§

**CheckpointåŸå­æ€§**ï¼š

```text
Checkpoint Atomicity:
  1. Copy committed WAL entries to database
  2. Sync database
  3. Truncate WAL file
  4. Mark checkpoint complete
```

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
Checkpoint() =
  âˆ€T: T.committed â†’ CopyToDB(T) âˆ§
  Fsync(DB) âˆ§
  Truncate(WAL) âˆ§
  MarkCheckpointComplete()
```

### 7.3. å½¢å¼åŒ–è¯æ˜

**å®šç†3ï¼ˆWALåŸå­æ€§ï¼‰**ï¼š

```text
Theorem 3: WAL Atomicity
  âˆ€T, S, S':
    WAL_Commit(T, S) = S' â†’
      (Success(WAL_Commit) â†’ S' = ApplyAll(T, S)) âˆ§
      (Failure(WAL_Commit) â†’ S' = S)
```

**è¯æ˜æ€è·¯**ï¼š

1. **WALå†™å…¥åŸå­æ€§**ï¼šfsyncä¿è¯WALå†™å…¥åŸå­æ€§
2. **æ•°æ®åº“æ›´æ–°åŸå­æ€§**ï¼šé¡µé¢çº§æ›´æ–°ä¿è¯åŸå­æ€§
3. **CheckpointåŸå­æ€§**ï¼šå®Œæ•´å¤åˆ¶å truncate

---

## 8. å®ç°ä¿è¯

### 8.1. ä»£ç çº§ä¿è¯

**å…³é”®ä»£ç ä½ç½®**ï¼š

```c
// sqlite3.c: äº‹åŠ¡æäº¤
int sqlite3CommitInternalChanges(sqlite3 *db){
  if( db->nChange==0 ) return SQLITE_OK;

  // åŸå­æ€§ä¿è¯ï¼šè¦ä¹ˆå…¨éƒ¨æäº¤ï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š
  rc = sqlite3VdbeExec(db->pVdbe);
  if( rc==SQLITE_OK ){
    sqlite3VdbeCloseStatement(db->pVdbe, SAVEPOINT_RELEASE);
  } else {
    sqlite3RollbackAll(db, SQLITE_ABORT_ROLLBACK);
  }
  return rc;
}
```

### 8.2. æµ‹è¯•éªŒè¯ä¸ä»£ç ç¤ºä¾‹

**åŸå­æ€§æµ‹è¯•**ï¼š

```python
import sqlite3
import os
import signal
import time

def test_atomicity():
    """æµ‹è¯•äº‹åŠ¡åŸå­æ€§"""
    db_path = 'test_atomicity.db'
    if os.path.exists(db_path):
        os.remove(db_path)

# åˆ›å»ºè¡¨
    conn = sqlite3.connect(db_path)
    conn.execute('CREATE TABLE users (id INTEGER PRIMARY KEY, name TEXT)')
    conn.commit()
    conn.close()

# æµ‹è¯•1ï¼šæ­£å¸¸æäº¤
    conn = sqlite3.connect(db_path)
    conn.execute('BEGIN')
    conn.execute('INSERT INTO users (name) VALUES (?)', ('Alice',))
    conn.execute('INSERT INTO users (name) VALUES (?)', ('Bob',))
    conn.commit()
    conn.close()

# éªŒè¯æ•°æ®å·²æäº¤
    conn = sqlite3.connect(db_path)
    count = conn.execute('SELECT COUNT(*) FROM users').fetchone()[0]
    assert count == 2, f"Expected 2 records, got {count}"
    conn.close()

# æµ‹è¯•2ï¼šå›æ»šï¼ˆæ¨¡æ‹Ÿå´©æºƒï¼‰
    conn = sqlite3.connect(db_path)
    conn.execute('BEGIN')
    conn.execute('INSERT INTO users (name) VALUES (?)', ('Charlie',))
    conn.execute('INSERT INTO users (name) VALUES (?)', ('David',))
    conn.rollback()  # æ˜¾å¼å›æ»š
    conn.close()

# éªŒè¯æ•°æ®æœªæäº¤
    conn = sqlite3.connect(db_path)
    count = conn.execute('SELECT COUNT(*) FROM users').fetchone()[0]
    assert count == 2, f"Expected 2 records after rollback, got {count}"
    conn.close()

# æµ‹è¯•3ï¼šå¼‚å¸¸å›æ»šï¼ˆæ¨¡æ‹Ÿå´©æºƒï¼‰
    conn = sqlite3.connect(db_path)
    try:
        conn.execute('BEGIN')
        conn.execute('INSERT INTO users (name) VALUES (?)', ('Eve',))
        conn.execute('INSERT INTO users (name) VALUES (?)', ('Frank',))
# æ¨¡æ‹Ÿå¼‚å¸¸ï¼ˆä¸è°ƒç”¨commitï¼‰
        raise Exception("Simulated crash")
    except:
        conn.rollback()
    finally:
        conn.close()

# éªŒè¯æ•°æ®æœªæäº¤
    conn = sqlite3.connect(db_path)
    count = conn.execute('SELECT COUNT(*) FROM users').fetchone()[0]
    assert count == 2, f"Expected 2 records after exception, got {count}"
    conn.close()

    print("âœ… åŸå­æ€§æµ‹è¯•é€šè¿‡ï¼šæ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æäº¤ï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š")

def test_crash_recovery():
    """æµ‹è¯•å´©æºƒæ¢å¤åŸå­æ€§"""
    db_path = 'test_crash_recovery.db'
    if os.path.exists(db_path):
        os.remove(db_path)

# åˆ›å»ºè¡¨
    conn = sqlite3.connect(db_path)
    conn.execute('PRAGMA journal_mode=WAL')  # ä½¿ç”¨WALæ¨¡å¼
    conn.execute('CREATE TABLE accounts (id INTEGER PRIMARY KEY, balance INTEGER)')
    conn.execute('INSERT INTO accounts (balance) VALUES (1000)')
    conn.commit()
    conn.close()

# æ¨¡æ‹Ÿè½¬è´¦äº‹åŠ¡ï¼ˆéƒ¨åˆ†æäº¤åå´©æºƒï¼‰
    conn = sqlite3.connect(db_path)
    conn.execute('BEGIN')
    conn.execute('UPDATE accounts SET balance = balance - 100 WHERE id = 1')
# æ¨¡æ‹Ÿå´©æºƒï¼šä¸æäº¤å°±å…³é—­
    conn.close()

# é‡æ–°æ‰“å¼€æ•°æ®åº“ï¼ˆæ¨¡æ‹Ÿæ¢å¤ï¼‰
    conn = sqlite3.connect(db_path)
    balance = conn.execute('SELECT balance FROM accounts WHERE id = 1').fetchone()[0]
    assert balance == 1000, f"Expected balance 1000 after crash, got {balance}"
    conn.close()

    print("âœ… å´©æºƒæ¢å¤æµ‹è¯•é€šè¿‡ï¼šæœªæäº¤çš„äº‹åŠ¡å·²å›æ»š")

def test_wal_atomicity():
    """æµ‹è¯•WALæ¨¡å¼åŸå­æ€§"""
    db_path = 'test_wal_atomicity.db'
    if os.path.exists(db_path):
        os.remove(db_path)

    conn = sqlite3.connect(db_path)
    conn.execute('PRAGMA journal_mode=WAL')
    conn.execute('CREATE TABLE test (id INTEGER PRIMARY KEY, data TEXT)')
    conn.commit()

# æµ‹è¯•WALå†™å…¥åŸå­æ€§
    conn.execute('BEGIN')
    conn.execute('INSERT INTO test (data) VALUES (?)', ('transaction1',))
    conn.execute('INSERT INTO test (data) VALUES (?)', ('transaction2',))
    conn.commit()

# éªŒè¯æ•°æ®å·²æäº¤
    count = conn.execute('SELECT COUNT(*) FROM test').fetchone()[0]
    assert count == 2, f"Expected 2 records, got {count}"

    conn.close()
    print("âœ… WALåŸå­æ€§æµ‹è¯•é€šè¿‡ï¼šWALæ¨¡å¼ä¿è¯äº‹åŠ¡åŸå­æ€§")

# è¿è¡Œæµ‹è¯•
if __name__ == '__main__':
    test_atomicity()
    test_crash_recovery()
    test_wal_atomicity()
    print("\næ‰€æœ‰åŸå­æ€§æµ‹è¯•é€šè¿‡ï¼")
```

**å½¢å¼åŒ–éªŒè¯ä»£ç **ï¼š

```python
import sqlite3
from typing import List, Tuple, Set

class Transaction:
    """äº‹åŠ¡æŠ½è±¡"""
    def __init__(self, ops: List[Tuple[str, tuple]]):
        self.operations = ops
        self.state = 'INIT'

    def execute(self, conn):
        """æ‰§è¡Œäº‹åŠ¡"""
        self.state = 'ACTIVE'
        try:
            conn.execute('BEGIN')
            for op, params in self.operations:
                conn.execute(op, params)
            conn.commit()
            self.state = 'COMMITTED'
            return True
        except:
            conn.rollback()
            self.state = 'ABORTED'
            return False

def verify_atomicity_theorem():
    """éªŒè¯åŸå­æ€§å®šç†"""
# å®šç†ï¼šâˆ€T, S, S':
# Execute(T, S) = S' â†’
# (T.result = COMMIT â†’ S' = ApplyAll(T, S)) âˆ§
# (T.result = ABORT â†’ S' = S)

    db_path = 'verify_atomicity.db'
    if os.path.exists(db_path):
        os.remove(db_path)

    conn = sqlite3.connect(db_path)
    conn.execute('CREATE TABLE test (id INTEGER PRIMARY KEY, value INTEGER)')
    conn.execute('INSERT INTO test (value) VALUES (0)')
    conn.commit()

# æµ‹è¯•æäº¤æƒ…å†µ
    initial_state = conn.execute('SELECT value FROM test WHERE id = 1').fetchone()[0]

    t = Transaction([
        ('UPDATE test SET value = value + 1 WHERE id = 1', ()),
        ('UPDATE test SET value = value + 1 WHERE id = 1', ()),
    ])

    result = t.execute(conn)
    final_state = conn.execute('SELECT value FROM test WHERE id = 1').fetchone()[0]

# éªŒè¯ï¼šå¦‚æœæäº¤ï¼Œæ‰€æœ‰æ“ä½œéƒ½åº”ç”¨
    if result and t.state == 'COMMITTED':
        expected = initial_state + 2  # ä¸¤æ¬¡+1æ“ä½œ
        assert final_state == expected, \
            f"Atomicity violation: expected {expected}, got {final_state}"
        print("âœ… æäº¤åŸå­æ€§éªŒè¯é€šè¿‡")

# æµ‹è¯•å›æ»šæƒ…å†µ
    initial_state = final_state
    t = Transaction([
        ('UPDATE test SET value = value + 10 WHERE id = 1', ()),
    ])

# æ¨¡æ‹Ÿé”™è¯¯å¯¼è‡´å›æ»š
    try:
        conn.execute('BEGIN')
        conn.execute('UPDATE test SET value = value + 10 WHERE id = 1')
        raise Exception("Simulated error")
    except:
        conn.rollback()
        t.state = 'ABORTED'

    final_state = conn.execute('SELECT value FROM test WHERE id = 1').fetchone()[0]

# éªŒè¯ï¼šå¦‚æœå›æ»šï¼ŒçŠ¶æ€ä¸å˜
    if t.state == 'ABORTED':
        assert final_state == initial_state, \
            f"Atomicity violation: expected {initial_state}, got {final_state}"
        print("âœ… å›æ»šåŸå­æ€§éªŒè¯é€šè¿‡")

    conn.close()

# è¿è¡ŒéªŒè¯
# verify_atomicity_theorem()
```

## 9. å®é™…æ¡ˆä¾‹ä¸éªŒè¯

**æ¡ˆä¾‹1ï¼šæ–­ç”µæ¢å¤**:

```python
import sqlite3
import os

def simulate_power_failure():
    """æ¨¡æ‹Ÿæ–­ç”µæ¢å¤åœºæ™¯"""
    db_path = 'power_failure_test.db'
    if os.path.exists(db_path):
        os.remove(db_path)

# åˆå§‹çŠ¶æ€
    conn = sqlite3.connect(db_path)
    conn.execute('CREATE TABLE orders (id INTEGER PRIMARY KEY, amount REAL)')
    conn.execute('INSERT INTO orders (amount) VALUES (100.0)')
    conn.commit()
    conn.close()

# æ¨¡æ‹Ÿäº‹åŠ¡æ‰§è¡Œä¸­æ–­ç”µ
    conn = sqlite3.connect(db_path)
    conn.execute('BEGIN')
    conn.execute('INSERT INTO orders (amount) VALUES (200.0)')
    conn.execute('INSERT INTO orders (amount) VALUES (300.0)')
    conn.execute('INSERT INTO orders (amount) VALUES (400.0)')
# æ¨¡æ‹Ÿæ–­ç”µï¼šä¸è°ƒç”¨commitå°±å…³é—­
    conn.close()

# æ¢å¤åæ£€æŸ¥
    conn = sqlite3.connect(db_path)
    count = conn.execute('SELECT COUNT(*) FROM orders').fetchone()[0]
    assert count == 1, f"Expected 1 record after power failure, got {count}"

# éªŒè¯åŸå­æ€§ï¼šæ‰€æœ‰æœªæäº¤çš„æ“ä½œéƒ½å·²å›æ»š
    amounts = [row[0] for row in conn.execute('SELECT amount FROM orders').fetchall()]
    assert 100.0 in amounts, "Initial record should exist"
    assert 200.0 not in amounts, "Uncommitted record should not exist"
    assert 300.0 not in amounts, "Uncommitted record should not exist"
    assert 400.0 not in amounts, "Uncommitted record should not exist"

    conn.close()
    print("âœ… æ–­ç”µæ¢å¤æ¡ˆä¾‹éªŒè¯é€šè¿‡ï¼šæ‰€æœ‰æœªæäº¤æ“ä½œå·²å›æ»š")

# è¿è¡Œæ¡ˆä¾‹
# simulate_power_failure()
```

**æ¡ˆä¾‹2ï¼šé‡‘èäº¤æ˜“åŸå­æ€§ä¿è¯**ï¼š

```python
def financial_transaction_atomicity():
    """é‡‘èäº¤æ˜“åŸå­æ€§ä¿è¯æ¡ˆä¾‹"""
    db_path = 'financial_test.db'
    if os.path.exists(db_path):
        os.remove(db_path)

    conn = sqlite3.connect(db_path)
    conn.execute('PRAGMA journal_mode=WAL')
    conn.execute('PRAGMA synchronous=FULL')  # æœ€é«˜å¯é æ€§
    conn.execute('''
        CREATE TABLE accounts (
            id INTEGER PRIMARY KEY,
            balance INTEGER NOT NULL CHECK(balance >= 0)
        )
    ''')
    conn.execute('INSERT INTO accounts (balance) VALUES (1000)')
    conn.execute('INSERT INTO accounts (balance) VALUES (500)')
    conn.commit()

# è½¬è´¦æ“ä½œï¼šä»è´¦æˆ·1è½¬200åˆ°è´¦æˆ·2
    def transfer(from_id, to_id, amount):
        """åŸå­è½¬è´¦æ“ä½œ"""
        conn.execute('BEGIN IMMEDIATE')  # ç«‹å³è·å–é”
        try:
# æ£€æŸ¥ä½™é¢
            balance = conn.execute(
                'SELECT balance FROM accounts WHERE id = ?',
                (from_id,)
            ).fetchone()[0]

            if balance < amount:
                conn.execute('ROLLBACK')
                raise ValueError('Insufficient balance')

# è½¬è´¦
            conn.execute(
                'UPDATE accounts SET balance = balance - ? WHERE id = ?',
                (amount, from_id)
            )
            conn.execute(
                'UPDATE accounts SET balance = balance + ? WHERE id = ?',
                (amount, to_id)
            )

            conn.execute('COMMIT')
            return True
        except Exception as e:
            conn.execute('ROLLBACK')
            raise

# æ­£å¸¸è½¬è´¦
    transfer(1, 2, 200)

# éªŒè¯ä½™é¢
    balance1 = conn.execute('SELECT balance FROM accounts WHERE id = 1').fetchone()[0]
    balance2 = conn.execute('SELECT balance FROM accounts WHERE id = 2').fetchone()[0]

    assert balance1 == 800, f"Expected 800, got {balance1}"
    assert balance2 == 700, f"Expected 700, got {balance2}"

# æµ‹è¯•ä½™é¢ä¸è¶³ï¼ˆåº”è¯¥å›æ»šï¼‰
    try:
        transfer(1, 2, 1000)  # ä½™é¢ä¸è¶³
        assert False, "Should raise ValueError"
    except ValueError:
        pass

# éªŒè¯ä½™é¢æœªå˜ï¼ˆåŸå­æ€§ä¿è¯ï¼‰
    balance1 = conn.execute('SELECT balance FROM accounts WHERE id = 1').fetchone()[0]
    balance2 = conn.execute('SELECT balance FROM accounts WHERE id = 2').fetchone()[0]

    assert balance1 == 800, f"Expected 800 after failed transfer, got {balance1}"
    assert balance2 == 700, f"Expected 700 after failed transfer, got {balance2}"

    conn.close()
    print("âœ… é‡‘èäº¤æ˜“åŸå­æ€§æ¡ˆä¾‹éªŒè¯é€šè¿‡ï¼šè½¬è´¦æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥")

# è¿è¡Œæ¡ˆä¾‹
# financial_transaction_atomicity()
```

- æ•°æ®ä¸€è‡´æ€§ï¼šä¿æŒ

---

## 10. ACIDåŸå­æ€§å¤šç»´å¯¹æ¯”çŸ©é˜µ

### 10.1. åŸå­æ€§ä¿è¯æœºåˆ¶å¯¹æ¯”çŸ©é˜µ

| æœºåˆ¶ | å›æ»šæ—¥å¿—æ¨¡å¼ | WALæ¨¡å¼ | å†…å­˜æ•°æ®åº“ |
|------|------------|---------|-----------|
| **å†™å…¥é¡ºåº** | å…ˆå†™æ—¥å¿—ï¼Œåå†™æ•°æ®åº“ | å…ˆå†™WALï¼ŒåCheckpoint | ç›´æ¥å†™å…¥å†…å­˜ |
| **åŸå­æ€§ä¿è¯** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| **æ€§èƒ½** | â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| **æ¢å¤é€Ÿåº¦** | â­â­â­ | â­â­â­â­â­ | N/Aï¼ˆå†…å­˜ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | ä¼ ç»Ÿæ¨¡å¼ | é«˜å¹¶å‘è¯» | ä¸´æ—¶æ•°æ® |

### 10.2. äº‹åŠ¡çŠ¶æ€è½¬æ¢å¯¹æ¯”çŸ©é˜µ

| çŠ¶æ€ | æ­£å¸¸æäº¤ | æ­£å¸¸å›æ»š | å´©æºƒæ¢å¤ | ç½‘ç»œæ•…éšœ |
|------|---------|---------|---------|---------|
| **åŸå­æ€§ä¿è¯** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| **æ¢å¤æœºåˆ¶** | N/A | å›æ»šæ“ä½œ | æ—¥å¿—æ¢å¤ | æ—¥å¿—æ¢å¤ |
| **æ•°æ®ä¸€è‡´æ€§** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| **æ€§èƒ½å½±å“** | æ—  | ä½ | ä¸­ | ä¸­ |

### 10.3. ACIDå±æ€§å¯¹æ¯”çŸ©é˜µ

| å±æ€§ | åŸå­æ€§ | ä¸€è‡´æ€§ | éš”ç¦»æ€§ | æŒä¹…æ€§ |
|------|-------|-------|-------|--------|
| **SQLiteå®ç°** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| **ä¿è¯æœºåˆ¶** | æ—¥å¿—/WAL | çº¦æŸæ£€æŸ¥ | å¿«ç…§éš”ç¦» | åŒæ­¥å†™å…¥ |
| **è¯æ˜éš¾åº¦** | â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­ |
| **å½¢å¼åŒ–è¯æ˜** | âœ… å·²å®Œæˆ | âœ… å·²å®Œæˆ | âœ… å·²å®Œæˆ | âœ… å·²å®Œæˆ |

## 11. åŸå­æ€§è¯æ˜æ€»ç»“

### 11.1. è¯æ˜è¦ç‚¹

**æ ¸å¿ƒè¯æ˜ç‚¹**ï¼š

1. **äº‹åŠ¡çŠ¶æ€æœº**ï¼šçŠ¶æ€è½¬æ¢ä¿è¯åŸå­æ€§
2. **æ—¥å¿—æœºåˆ¶**ï¼šå…ˆå†™æ—¥å¿—ï¼Œåå†™æ•°æ®åº“
3. **å´©æºƒæ¢å¤**ï¼šæ¢å¤ç®—æ³•ä¿è¯åŸå­æ€§
4. **WALæ¨¡å¼**ï¼šWALå†™å…¥å’ŒCheckpointåŸå­æ€§

### 11.2. ä¿è¯å¼ºåº¦

**åŸå­æ€§ä¿è¯å¼ºåº¦**ï¼š

| åœºæ™¯ | ä¿è¯å¼ºåº¦ | è¯´æ˜ |
|------|---------|------|
| æ­£å¸¸æäº¤ | â­â­â­â­â­ | å®Œå…¨ä¿è¯ |
| æ­£å¸¸å›æ»š | â­â­â­â­â­ | å®Œå…¨ä¿è¯ |
| å´©æºƒæ¢å¤ | â­â­â­â­â­ | å®Œå…¨ä¿è¯ |
| ç½‘ç»œæ•…éšœ | â­â­â­â­â­ | å®Œå…¨ä¿è¯ |

---

## 12. ğŸ”— ç›¸å…³èµ„æº

- [06.02 B-Treeæ­£ç¡®æ€§è¯æ˜](./06.02-B-Treeæ­£ç¡®æ€§è¯æ˜.md)
- [01.02 äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶](../01-æ ¸å¿ƒæ¶æ„/01.02-äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶.md)
- [08.02 äº‹åŠ¡ç®¡ç†](../08-ç¼–ç¨‹å®è·µ/08.02-äº‹åŠ¡ç®¡ç†.md)

---

## 13. ğŸ”— äº¤å‰å¼•ç”¨

### 13.1. ç†è®ºæ¨¡å‹ ğŸ†•

- â­â­â­ [å¹¶å‘æ§åˆ¶ç†è®º](../11-ç†è®ºæ¨¡å‹/11.04-å¹¶å‘æ§åˆ¶ç†è®º.md) - äº‹åŠ¡ç†è®ºã€éš”ç¦»æ€§ç†è®ºã€åŸå­æ€§ç†è®º
- â­â­ [å­˜å‚¨ç†è®º](../11-ç†è®ºæ¨¡å‹/11.05-å­˜å‚¨ç†è®º.md) - æŒä¹…åŒ–ç†è®ºã€å´©æºƒæ¢å¤ç†è®º

### 13.2. è®¾è®¡æ¨¡å‹ ğŸ†•

- â­â­ [è®¾è®¡å†³ç­–](../12-è®¾è®¡æ¨¡å‹/12.04-è®¾è®¡å†³ç­–.md) - äº‹åŠ¡è®¾è®¡å†³ç­–ã€å¹¶å‘æ§åˆ¶è®¾è®¡å†³ç­–
- â­ [è®¾è®¡åŸåˆ™](../12-è®¾è®¡æ¨¡å‹/12.02-è®¾è®¡åŸåˆ™.md) - ACIDåŸåˆ™

---

## 14. ğŸ“š å‚è€ƒèµ„æ–™

- [SQLiteäº‹åŠ¡æ–‡æ¡£](https://www.sqlite.org/transactional.html)
- [ACIDå±æ€§](https://en.wikipedia.org/wiki/ACID)
- [å½¢å¼åŒ–æ–¹æ³•](https://en.wikipedia.org/wiki/Formal_methods)

---

**æœ€åæ›´æ–°**ï¼š2025-01-15
**ç»´æŠ¤è€…**ï¼šData-Science Team
