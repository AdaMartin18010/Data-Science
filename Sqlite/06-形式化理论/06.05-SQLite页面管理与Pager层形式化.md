# SQLiteé¡µé¢ç®¡ç†ä¸Pagerå±‚å½¢å¼åŒ–

> **åˆ›å»ºæ—¥æœŸ**: 2025-12-04
> **ç‰ˆæœ¬**: SQLite 3.47.x
> **éš¾åº¦**: â­â­â­â­â­

---

## ğŸ“‘ ç›®å½•

- [SQLiteé¡µé¢ç®¡ç†ä¸Pagerå±‚å½¢å¼åŒ–](#sqliteé¡µé¢ç®¡ç†ä¸pagerå±‚å½¢å¼åŒ–)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [Pagerå±‚æ¶æ„](#pagerå±‚æ¶æ„)
  - [å½¢å¼åŒ–å®šä¹‰](#å½¢å¼åŒ–å®šä¹‰)
    - [å®šä¹‰1.1 é¡µé¢](#å®šä¹‰11-é¡µé¢)
    - [å®šä¹‰1.2 é¡µé¢ç¼“å­˜](#å®šä¹‰12-é¡µé¢ç¼“å­˜)
  - [PagerçŠ¶æ€æœº](#pagerçŠ¶æ€æœº)
  - [é¡µé¢ç®¡ç†ç®—æ³•](#é¡µé¢ç®¡ç†ç®—æ³•)
    - [ç®—æ³•1ï¼šé¡µé¢è·å–ï¼ˆfetchï¼‰](#ç®—æ³•1é¡µé¢è·å–fetch)
    - [ç®—æ³•2ï¼šé¡µé¢å†™å…¥ï¼ˆwriteï¼‰](#ç®—æ³•2é¡µé¢å†™å…¥write)
    - [ç®—æ³•3ï¼šäº‹åŠ¡æäº¤ï¼ˆcommitï¼‰](#ç®—æ³•3äº‹åŠ¡æäº¤commit)
  - [å½¢å¼åŒ–å®šç†](#å½¢å¼åŒ–å®šç†)
    - [å®šç†1ï¼šå´©æºƒæ¢å¤æ­£ç¡®æ€§](#å®šç†1å´©æºƒæ¢å¤æ­£ç¡®æ€§)
    - [å®šç†2ï¼šWALå¹¶å‘è¯»å†™ä¸å†²çª](#å®šç†2walå¹¶å‘è¯»å†™ä¸å†²çª)
  - [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
    - [1. é¡µé¢ç¼“å­˜å¤§å°](#1-é¡µé¢ç¼“å­˜å¤§å°)
    - [2. é¡µé¢å¤§å°é€‰æ‹©](#2-é¡µé¢å¤§å°é€‰æ‹©)
    - [3. é¢„è¯»ï¼ˆRead-Aheadï¼‰](#3-é¢„è¯»read-ahead)

## Pagerå±‚æ¶æ„

```text
SQLiteå­˜å‚¨å±‚æ¬¡
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         SQL Layer (VDBE)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         B-Tree Layer                     â”‚
â”‚  â€¢ btree.c                               â”‚
â”‚  â€¢ ç®¡ç†B-Treeç»“æ„                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Pager Layer â­                   â”‚
â”‚  â€¢ pager.c                               â”‚
â”‚  â€¢ é¡µé¢ç¼“å­˜(Page Cache)                   â”‚
â”‚  â€¢ äº‹åŠ¡ç®¡ç†                               â”‚
â”‚  â€¢ WAL/Rollback Journal                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         VFS Layer                        â”‚
â”‚  â€¢ os_unix.c / os_win.c                  â”‚
â”‚  â€¢ æ“ä½œç³»ç»ŸæŠ½è±¡                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Database File  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å½¢å¼åŒ–å®šä¹‰

### å®šä¹‰1.1 é¡µé¢

```text
å®šä¹‰1.1 æ•°æ®åº“é¡µé¢
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

é¡µé¢ P = (pgno, data, state, dirty)

å…¶ä¸­:
â€¢ pgno: é¡µå·ï¼ˆ1-basedï¼Œ0ä¸ºæ— æ•ˆé¡µï¼‰
â€¢ data: é¡µé¢æ•°æ®ï¼ˆbyteæ•°ç»„ï¼Œé•¿åº¦=page_sizeï¼‰
â€¢ state: é¡µé¢çŠ¶æ€ âˆˆ {CLEAN, DIRTY, LOCKED, JOURNALED}
â€¢ dirty: è„æ ‡è®°ï¼ˆæ˜¯å¦å·²ä¿®æ”¹ï¼‰

é¡µé¢å¤§å°:
  page_size âˆˆ {512, 1024, 2048, 4096, 8192, 16384, 32768, 65536}
  é»˜è®¤: 4096 bytes

é¡µé¢ç±»å‹:
â€¢ Lock page (pgno = 1): æ•°æ®åº“é”é¡µ
â€¢ Schema page (pgno = 1): ç¬¬ä¸€é¡µï¼Œå­˜å‚¨schema
â€¢ Free list trunk page: ç©ºé—²é¡µé“¾è¡¨
â€¢ Free list leaf page: ç©ºé—²é¡µæ•°æ®
â€¢ B-Tree interior page: B-Treeå†…éƒ¨èŠ‚ç‚¹
â€¢ B-Tree leaf page: B-Treeå¶å­èŠ‚ç‚¹
â€¢ Payload overflow page: æº¢å‡ºé¡µ
```

### å®šä¹‰1.2 é¡µé¢ç¼“å­˜

```text
å®šä¹‰1.2 é¡µé¢ç¼“å­˜ï¼ˆPage Cacheï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ç¼“å­˜ C = (pages, lru, size_limit)

å…¶ä¸­:
â€¢ pages: Map<pgno, Page>ï¼ˆé¡µå·â†’é¡µé¢ï¼‰
â€¢ lru: LRUé“¾è¡¨ï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰
â€¢ size_limit: ç¼“å­˜å¤§å°ä¸Šé™ï¼ˆå•ä½ï¼šé¡µæ•°ï¼‰

æ“ä½œ:
â€¢ fetch(pgno): Page - è·å–é¡µé¢
â€¢ release(page) - é‡Šæ”¾é¡µé¢
â€¢ flush() - åˆ·æ–°è„é¡µåˆ°ç£ç›˜
â€¢ evict() - é©±é€LRUé¡µé¢

æ€§è´¨1ï¼ˆç¼“å­˜ä¸€è‡´æ€§ï¼‰:
  âˆ€ pgno, fetch(pgno) è¿”å›çš„é¡µé¢æ•°æ® = ç£ç›˜ä¸Šçš„é¡µé¢æ•°æ® OR æ›´æ–°çš„ç‰ˆæœ¬

æ€§è´¨2ï¼ˆè„é¡µå¿…é¡»å†™å›ï¼‰:
  åœ¨äº‹åŠ¡æäº¤å‰ï¼Œæ‰€æœ‰ dirty=true çš„é¡µé¢å¿…é¡» flush åˆ°ç£ç›˜
```

---

## PagerçŠ¶æ€æœº

```text
PagerçŠ¶æ€è½¬æ¢å›¾
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ OPEN    â”‚â—„â”€â”€â”€ sqlite3_open()
                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                       â”‚ BEGIN
                       â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”Œâ”€â”€â”€â”€â–ºâ”‚ READER  â”‚ (å…±äº«é”)
            â”‚     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
            â”‚          â”‚ writeæ“ä½œ
            â”‚          â–¼
            â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚     â”‚ WRITER  â”‚ (RESERVEDé”)
            â”‚     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
            â”‚          â”‚ ç»§ç»­å†™
            â”‚          â–¼
            â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚     â”‚ WRITER_ â”‚
            â”‚     â”‚ LOCKED  â”‚ (EXCLUSIVEé”é¢„å¤‡)
            â”‚     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
            â”‚          â”‚ å‡†å¤‡æäº¤
            â”‚          â–¼
            â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â””â”€â”€â”€â”€â”€â”¤ WRITER_ â”‚
                  â”‚ FINISHEDâ”‚ (EXCLUSIVEé”)
                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                       â”‚ COMMIT
                       â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ OPEN    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

çŠ¶æ€è¯´æ˜:
â€¢ OPEN: æ— é”ï¼Œå¯è¯»å¯å†™
â€¢ READER: SHAREDé”ï¼Œå¯è¯»
â€¢ WRITER: RESERVEDé”ï¼Œå¯è¯»å¯å†™ï¼ˆç‹¬å å†™ï¼‰
â€¢ WRITER_LOCKED: PENDINGé”ï¼Œå‡†å¤‡æäº¤
â€¢ WRITER_FINISHED: EXCLUSIVEé”ï¼Œæäº¤ä¸­
```

---

## é¡µé¢ç®¡ç†ç®—æ³•

### ç®—æ³•1ï¼šé¡µé¢è·å–ï¼ˆfetchï¼‰

```c
// SQLiteæºç ç®€åŒ–ç‰ˆ
Page* pager_fetch(Pager *pager, Pgno pgno, int flags) {
    Page *page;

    // 1. æ£€æŸ¥ç¼“å­˜
    page = cache_lookup(pager->cache, pgno);
    if (page != NULL) {
        cache_hit++;
        return page;  // ç¼“å­˜å‘½ä¸­
    }

    // 2. ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ†é…æ–°é¡µé¢
    cache_miss++;
    page = (Page*)malloc(sizeof(Page) + pager->page_size);
    page->pgno = pgno;
    page->dirty = 0;

    // 3. ä»ç£ç›˜è¯»å–
    if (pgno <= pager->db_size) {
        off_t offset = (pgno - 1) * pager->page_size;
        pread(pager->fd, page->data, pager->page_size, offset);
    } else {
        // æ–°é¡µé¢ï¼Œæ¸…é›¶
        memset(page->data, 0, pager->page_size);
    }

    // 4. åŠ å…¥ç¼“å­˜
    cache_insert(pager->cache, page);

    // 5. LRUé©±é€ï¼ˆå¦‚æœç¼“å­˜æ»¡ï¼‰
    if (cache_size(pager->cache) > pager->cache_limit) {
        pager_evict_lru(pager);
    }

    return page;
}
```

### ç®—æ³•2ï¼šé¡µé¢å†™å…¥ï¼ˆwriteï¼‰

```c
int pager_write(Pager *pager, Page *page) {
    // 1. æ£€æŸ¥å†™æƒé™
    if (pager->state < WRITER) {
        // å‡çº§åˆ°WRITERçŠ¶æ€
        acquire_reserved_lock(pager);
        pager->state = WRITER;
    }

    // 2. å¦‚æœé¡µé¢æœªjournalï¼Œå…ˆå†™journal
    if (!page->in_journal && pager->journal_mode == ROLLBACK) {
        // å†™å…¥rollback journal
        off_t offset = pager->journal_offset;
        write(pager->journal_fd, &page->pgno, sizeof(Pgno));
        write(pager->journal_fd, page->data, pager->page_size);
        pager->journal_offset += sizeof(Pgno) + pager->page_size;

        page->in_journal = 1;
    }

    // 3. WALæ¨¡å¼ï¼šè¿½åŠ åˆ°WAL
    if (pager->journal_mode == WAL) {
        wal_append_frame(pager->wal, page->pgno, page->data);
    }

    // 4. æ ‡è®°ä¸ºè„é¡µ
    page->dirty = 1;

    return SQLITE_OK;
}
```

### ç®—æ³•3ï¼šäº‹åŠ¡æäº¤ï¼ˆcommitï¼‰

```c
int pager_commit(Pager *pager) {
    // 1. çŠ¶æ€æ£€æŸ¥
    if (pager->state != WRITER) {
        return SQLITE_OK;  // æ— ä¿®æ”¹
    }

    // 2. Rollback Journalæ¨¡å¼
    if (pager->journal_mode == ROLLBACK) {
        // 2.1 åŒæ­¥journalï¼ˆç¡®ä¿æŒä¹…åŒ–ï¼‰
        fsync(pager->journal_fd);

        // 2.2 è·å–EXCLUSIVEé”
        acquire_exclusive_lock(pager);
        pager->state = WRITER_FINISHED;

        // 2.3 å†™å…¥æ‰€æœ‰è„é¡µåˆ°æ•°æ®åº“æ–‡ä»¶
        for (Page *page : pager->dirty_pages) {
            off_t offset = (page->pgno - 1) * pager->page_size;
            pwrite(pager->fd, page->data, pager->page_size, offset);
        }

        // 2.4 åŒæ­¥æ•°æ®åº“æ–‡ä»¶
        fsync(pager->fd);

        // 2.5 åˆ é™¤journalæ–‡ä»¶
        unlink(pager->journal_path);

        // 2.6 é‡Šæ”¾é”
        release_lock(pager);
        pager->state = OPEN;
    }

    // 3. WALæ¨¡å¼
    else if (pager->journal_mode == WAL) {
        // 3.1 WALå¸§å·²ç»åœ¨writeæ—¶è¿½åŠ 
        // 3.2 å†™å…¥commit record
        wal_commit(pager->wal, pager->txn_id);

        // 3.3 åŒæ­¥WAL
        fsync(pager->wal->fd);

        // 3.4 æ›´æ–°å…±äº«å†…å­˜ï¼ˆé€šçŸ¥å…¶ä»–è¿æ¥ï¼‰
        wal_update_shm(pager->wal, pager->txn_id);

        // 3.5 Checkpointï¼ˆå¦‚æœéœ€è¦ï¼‰
        if (wal_size(pager->wal) > pager->wal_autocheckpoint) {
            wal_checkpoint(pager->wal, TRUNCATE);
        }
    }

    return SQLITE_OK;
}
```

---

## å½¢å¼åŒ–å®šç†

### å®šç†1ï¼šå´©æºƒæ¢å¤æ­£ç¡®æ€§

```text
å®šç†1ï¼šRollback Journalå´©æºƒæ¢å¤æ­£ç¡®æ€§
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

å‰æ:
  â€¢ Journalæ–‡ä»¶å·²fsync
  â€¢ å´©æºƒå‘ç”Ÿåœ¨commitè¿‡ç¨‹ä¸­

å®šç†: æ¢å¤åï¼Œæ•°æ®åº“çŠ¶æ€ = äº‹åŠ¡å¼€å§‹å‰çš„çŠ¶æ€

è¯æ˜:

è®¾äº‹åŠ¡ T ä¿®æ”¹äº†é¡µé¢é›†åˆ M = {P1, P2, ..., Pn}

äº‹åŠ¡å¼€å§‹å‰:
  âˆ€ Pi âˆˆ M, disk(Pi) = before_image_i

Journalè®°å½•:
  Journal = [(pgno_1, before_image_1), (pgno_2, before_image_2), ..., (pgno_n, before_image_n)]

å´©æºƒåœºæ™¯åˆ†ç±»:

Case 1: Journalå·²å†™å…¥ï¼Œæ•°æ®åº“æ–‡ä»¶æœªä¿®æ”¹
  â†’ æ¢å¤: ä¸éœ€è¦æ“ä½œï¼Œæ•°æ®åº“çŠ¶æ€æ­£ç¡®

Case 2: Journalå·²å†™å…¥ï¼Œæ•°æ®åº“æ–‡ä»¶éƒ¨åˆ†ä¿®æ”¹
  â†’ æ¢å¤: ä»Journalè¯»å–before_imageï¼Œè¦†ç›–æ•°æ®åº“æ–‡ä»¶
  â†’ âˆ€ Pi âˆˆ M, disk(Pi) := before_image_i
  â†’ æ•°æ®åº“æ¢å¤åˆ°äº‹åŠ¡å‰çŠ¶æ€

Case 3: Journalæœªå®Œå…¨å†™å…¥ï¼ˆHot Journalæ£€æµ‹å¤±è´¥ï¼‰
  â†’ æ¢å¤: å¿½ç•¥Journalï¼Œæ•°æ®åº“æ–‡ä»¶æœªä¿®æ”¹
  â†’ æ•°æ®åº“ä¿æŒäº‹åŠ¡å‰çŠ¶æ€

Case 4: æäº¤æˆåŠŸï¼ŒJournalå·²åˆ é™¤
  â†’ æ¢å¤: æ— éœ€æ“ä½œï¼Œäº‹åŠ¡å·²æˆåŠŸ

ç»“è®º:
  âˆ€ Case, æ¢å¤åæ•°æ®åº“çŠ¶æ€ = äº‹åŠ¡å‰çŠ¶æ€ OR äº‹åŠ¡åçŠ¶æ€ï¼ˆåŸå­æ€§ï¼‰

âˆ´ å´©æºƒæ¢å¤æ­£ç¡® âˆ
```

### å®šç†2ï¼šWALå¹¶å‘è¯»å†™ä¸å†²çª

```text
å®šç†2ï¼šWALæ¨¡å¼ä¸‹è¯»å†™ä¸äº’æ–¥
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

è®¾:
â€¢ Reader: äº‹åŠ¡T_rï¼Œå¼€å§‹æ—¶é—´t_r
â€¢ Writer: äº‹åŠ¡T_wï¼Œå¼€å§‹æ—¶é—´t_w < t_rï¼Œæäº¤æ—¶é—´t_c

å®šç†: T_rå’ŒT_wå¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œä¸äº’ç›¸é˜»å¡

è¯æ˜:

WALè¯»å–è§„åˆ™:
  T_rè¯»å–é¡µé¢Pæ—¶ï¼ŒæŸ¥æ‰¾æœ€å¤§txn_id â‰¤ start_txn_id_r çš„ç‰ˆæœ¬

æ—¶é—´çº¿:
  t_w: T_wå¼€å§‹
  t_c: T_wæäº¤ï¼ˆå†™å…¥WALï¼‰
  t_r: T_rå¼€å§‹

åˆ†æ:

1. T_rè¯»å–æ—¶ï¼ŒT_wå·²æäº¤
   â†’ T_rçš„start_txn_id_r â‰¥ T_wçš„txn_id
   â†’ T_rå¯ä»¥çœ‹åˆ°T_wçš„ä¿®æ”¹
   â†’ æ— å†²çª

2. T_rè¯»å–æ—¶ï¼ŒT_wæœªæäº¤
   â†’ T_rçš„start_txn_id_r < T_wçš„txn_id
   â†’ T_rè¯»å–æ—§ç‰ˆæœ¬ï¼ˆä»æ•°æ®åº“æ–‡ä»¶æˆ–æ—§WALå¸§ï¼‰
   â†’ T_wç»§ç»­å†™WALï¼ˆä¸é˜»å¡T_rï¼‰
   â†’ æ— å†²çª

3. T_wå†™å…¥æ—¶ï¼ŒT_ræ­£åœ¨è¯»å–
   â†’ T_wè¿½åŠ åˆ°WALï¼ˆä¸ä¿®æ”¹T_ræ­£åœ¨è¯»çš„é¡µé¢ï¼‰
   â†’ T_rç»§ç»­ä»æ—§ç‰ˆæœ¬è¯»å–
   â†’ æ— å†²çª

ç»“è®º:
  âˆ€ P âˆˆ Pages, read(T_r, P) å’Œ write(T_w, P) ä¸äº’æ–¥

âˆ´ WALæ¨¡å¼è¯»å†™ä¸å†²çª âˆ
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. é¡µé¢ç¼“å­˜å¤§å°

```sql
-- é»˜è®¤ï¼š2000é¡µ (8MBï¼Œå‡è®¾page_size=4096)
PRAGMA cache_size = -64000;  -- 64MB (è´Ÿæ•°è¡¨ç¤ºKB)

-- æ•ˆæœï¼š
-- â€¢ å¢åŠ ç¼“å­˜ â†’ å‡å°‘ç£ç›˜IO
-- â€¢ ç¼“å­˜å‘½ä¸­ç‡ä»70% â†’ 95%
-- â€¢ æŸ¥è¯¢æ€§èƒ½æå‡2-3å€
```

### 2. é¡µé¢å¤§å°é€‰æ‹©

```sql
-- åˆ›å»ºæ•°æ®åº“æ—¶è®¾ç½®ï¼ˆä¹‹åä¸å¯æ›´æ”¹ï¼‰
PRAGMA page_size = 4096;  -- é»˜è®¤
PRAGMA page_size = 8192;  -- å¤§é¡µé¢

-- æƒè¡¡ï¼š
-- â€¢ å°é¡µé¢(1024): é€‚åˆå°è®°å½•ï¼Œå‡å°‘å†…éƒ¨ç¢ç‰‡
-- â€¢ å¤§é¡µé¢(8192): é€‚åˆå¤§è®°å½•ï¼ˆBLOBï¼‰ï¼Œå‡å°‘B-Treeæ·±åº¦

-- B-Treeæ·±åº¦å¯¹æ¯”ï¼ˆ100ä¸‡è¡Œï¼‰ï¼š
-- page_size=1024: æ·±åº¦â‰ˆ4
-- page_size=4096: æ·±åº¦â‰ˆ3
-- page_size=8192: æ·±åº¦â‰ˆ3
```

### 3. é¢„è¯»ï¼ˆRead-Aheadï¼‰

```c
// SQLite 3.47+ æ”¯æŒé¢„è¯»ä¼˜åŒ–
// å½“é¡ºåºæ‰«ææ—¶ï¼ŒPagerä¼šé¢„è¯»åç»­é¡µé¢

// ç¤ºä¾‹ï¼šSCAN orders
// é¡µé¢è®¿é—®åºåˆ—ï¼š1, 2, 3, 4, ...
// Pagerè‡ªåŠ¨é¢„è¯»ï¼š
//   è®¿é—®é¡µé¢1æ—¶ï¼Œé¢„è¯»2, 3
//   è®¿é—®é¡µé¢2æ—¶ï¼Œé¢„è¯»4, 5
// æ•ˆæœï¼šå‡å°‘IO waitæ—¶é—´
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
**æœ€åæ›´æ–°**: 2025-12-04
