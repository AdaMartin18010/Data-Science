# å­˜å‚¨ç†è®ºï¼šé¡µç»“æ„ä¸B-Treeå­˜å‚¨æ¨¡å‹

> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-15
> **æœ€åæ›´æ–°**ï¼š2025-01-15
> **ç‰ˆæœ¬**ï¼šSQLite 3.31+ è‡³ 3.47.x

---

## 1. ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£ä»å­˜å‚¨ç†è®ºè§†è§’æ·±å…¥åˆ†æSQLiteçš„å­˜å‚¨æ¨¡å‹ç†è®ºã€ç´¢å¼•ç†è®ºã€ç¼“å­˜ç†è®ºå’ŒæŒä¹…åŒ–ç†è®ºï¼Œæä¾›å½¢å¼åŒ–çš„ç†è®ºåˆ†æå’Œæ•°å­¦è¯æ˜ã€‚

---

## 1. ğŸ“‘ ç›®å½•

- [å­˜å‚¨ç†è®ºï¼šé¡µç»“æ„ä¸B-Treeå­˜å‚¨æ¨¡å‹](#å­˜å‚¨ç†è®ºé¡µç»“æ„ä¸b-treeå­˜å‚¨æ¨¡å‹)
  - [1. ğŸ“‹ æ¦‚è¿°](#1--æ¦‚è¿°)
  - [1. ğŸ“‘ ç›®å½•](#1--ç›®å½•)
  - [3. ğŸ“Š æ€ç»´å¯¼å›¾](#3--æ€ç»´å¯¼å›¾)
  - [4. å­˜å‚¨æ¨¡å‹ç†è®º](#4-å­˜å‚¨æ¨¡å‹ç†è®º)
    - [4.1. å­˜å‚¨æ¨¡å‹å®šä¹‰](#41-å­˜å‚¨æ¨¡å‹å®šä¹‰)
    - [4.2. é¡µç»“æ„ç†è®º](#42-é¡µç»“æ„ç†è®º)
    - [4.3. å­˜å‚¨å¸ƒå±€ç†è®º](#43-å­˜å‚¨å¸ƒå±€ç†è®º)
    - [4.4. å­˜å‚¨æ•ˆç‡ç†è®º](#44-å­˜å‚¨æ•ˆç‡ç†è®º)
  - [5. ç´¢å¼•ç†è®º](#5-ç´¢å¼•ç†è®º)
    - [5.1. ç´¢å¼•å®šä¹‰](#51-ç´¢å¼•å®šä¹‰)
    - [5.2. B-Treeç´¢å¼•ç†è®º](#52-b-treeç´¢å¼•ç†è®º)
    - [5.3. ç´¢å¼•é€‰æ‹©ç†è®º](#53-ç´¢å¼•é€‰æ‹©ç†è®º)
    - [5.4. ç´¢å¼•ç»´æŠ¤ç†è®º](#54-ç´¢å¼•ç»´æŠ¤ç†è®º)
  - [6. ç¼“å­˜ç†è®º](#6-ç¼“å­˜ç†è®º)
    - [6.1. ç¼“å­˜æ¨¡å‹å®šä¹‰](#61-ç¼“å­˜æ¨¡å‹å®šä¹‰)
    - [6.2. ç¼“å­˜æ›¿æ¢ç†è®º](#62-ç¼“å­˜æ›¿æ¢ç†è®º)
    - [6.3. ç¼“å­˜ä¸€è‡´æ€§ç†è®º](#63-ç¼“å­˜ä¸€è‡´æ€§ç†è®º)
    - [6.4. ç¼“å­˜æ€§èƒ½ç†è®º](#64-ç¼“å­˜æ€§èƒ½ç†è®º)
  - [7. æŒä¹…åŒ–ç†è®º](#7-æŒä¹…åŒ–ç†è®º)
    - [7.1. æŒä¹…åŒ–å®šä¹‰](#71-æŒä¹…åŒ–å®šä¹‰)
    - [7.2. æ—¥å¿—ç†è®º](#72-æ—¥å¿—ç†è®º)
    - [7.3. æ¢å¤ç†è®º](#73-æ¢å¤ç†è®º)
    - [7.4. ä¸€è‡´æ€§ç†è®º](#74-ä¸€è‡´æ€§ç†è®º)
  - [8. å­˜å‚¨ç†è®ºæ€»ç»“](#8-å­˜å‚¨ç†è®ºæ€»ç»“)
    - [8.1. ç†è®ºæ¨¡å‹è¦ç‚¹](#81-ç†è®ºæ¨¡å‹è¦ç‚¹)
    - [8.2. SQLiteå­˜å‚¨ç‰¹æ€§](#82-sqliteå­˜å‚¨ç‰¹æ€§)
    - [8.3. ç†è®ºåº”ç”¨](#83-ç†è®ºåº”ç”¨)
    - [8.4. å­˜å‚¨ç†è®ºéªŒè¯ä»£ç ](#84-å­˜å‚¨ç†è®ºéªŒè¯ä»£ç )
  - [9. ğŸ”— ç›¸å…³èµ„æº](#9--ç›¸å…³èµ„æº)
  - [10. ğŸ“š å‚è€ƒèµ„æ–™](#10--å‚è€ƒèµ„æ–™)

---

## 3. ğŸ“Š æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((å­˜å‚¨ç†è®º))
    å­˜å‚¨æ¨¡å‹ç†è®º
      å­˜å‚¨æ¨¡å‹å®šä¹‰
        å­˜å‚¨å±‚æ¬¡
        å­˜å‚¨æŠ½è±¡
        å­˜å‚¨æ¥å£
      é¡µç»“æ„ç†è®º
        é¡µå®šä¹‰
        é¡µç±»å‹
        é¡µå¸ƒå±€
        é¡µç®¡ç†
      å­˜å‚¨å¸ƒå±€ç†è®º
        æ–‡ä»¶å¸ƒå±€
        é¡µåˆ†é…
        ç©ºé—´ç®¡ç†
      å­˜å‚¨æ•ˆç‡ç†è®º
        ç©ºé—´åˆ©ç”¨ç‡
        ç¢ç‰‡ç®¡ç†
        å‹ç¼©ç†è®º
    ç´¢å¼•ç†è®º
      ç´¢å¼•å®šä¹‰
        ç´¢å¼•æ¦‚å¿µ
        ç´¢å¼•ä½œç”¨
        ç´¢å¼•ç±»å‹
      B-Treeç´¢å¼•ç†è®º
        B-Treeç»“æ„
        B-Treeæ“ä½œ
        B-Treeæ€§èƒ½
      ç´¢å¼•é€‰æ‹©ç†è®º
        é€‰æ‹©æ€§
        ç´¢å¼•æ”¶ç›Š
        ç´¢å¼•æˆæœ¬
      ç´¢å¼•ç»´æŠ¤ç†è®º
        ç´¢å¼•æ›´æ–°
        ç´¢å¼•é‡å»º
        ç´¢å¼•ä¼˜åŒ–
    ç¼“å­˜ç†è®º
      ç¼“å­˜æ¨¡å‹å®šä¹‰
        ç¼“å­˜å±‚æ¬¡
        ç¼“å­˜ç­–ç•¥
        ç¼“å­˜ç®¡ç†
      ç¼“å­˜æ›¿æ¢ç†è®º
        LRUç®—æ³•
        LFUç®—æ³•
        Clockç®—æ³•
      ç¼“å­˜ä¸€è‡´æ€§ç†è®º
        ä¸€è‡´æ€§æ¨¡å‹
        ä¸€è‡´æ€§åè®®
        ä¸€è‡´æ€§ä¿è¯
      ç¼“å­˜æ€§èƒ½ç†è®º
        å‘½ä¸­ç‡
        æ€§èƒ½åˆ†æ
        ä¼˜åŒ–ç­–ç•¥
    æŒä¹…åŒ–ç†è®º
      æŒä¹…åŒ–å®šä¹‰
        æŒä¹…åŒ–æ¦‚å¿µ
        æŒä¹…åŒ–ä¿è¯
        æŒä¹…åŒ–æœºåˆ¶
      æ—¥å¿—ç†è®º
        æ—¥å¿—ç±»å‹
        æ—¥å¿—ç»“æ„
        æ—¥å¿—åè®®
      æ¢å¤ç†è®º
        æ¢å¤ç®—æ³•
        æ¢å¤æ­£ç¡®æ€§
        æ¢å¤æ€§èƒ½
      ä¸€è‡´æ€§ç†è®º
        ä¸€è‡´æ€§å®šä¹‰
        ä¸€è‡´æ€§ä¿è¯
        ä¸€è‡´æ€§æ£€æŸ¥
```

---

## 4. å­˜å‚¨æ¨¡å‹ç†è®º

### 4.1. å­˜å‚¨æ¨¡å‹å®šä¹‰

**å®šä¹‰1ï¼ˆå­˜å‚¨æ¨¡å‹ï¼‰**ï¼šå­˜å‚¨æ¨¡å‹å®šä¹‰äº†æ•°æ®åœ¨å­˜å‚¨ä»‹è´¨ä¸Šçš„ç»„ç»‡æ–¹å¼å’Œè®¿é—®æ–¹æ³•ã€‚

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
å­˜å‚¨æ¨¡å‹å®šä¹‰ï¼š
  StorageModel = (Pages, Layout, Access, Management)

å…¶ä¸­ï¼š
  Pages: é¡µé›†åˆ
  Layout: å­˜å‚¨å¸ƒå±€
  Access: è®¿é—®æ–¹æ³•
  Management: ç®¡ç†ç­–ç•¥
```

**å­˜å‚¨å±‚æ¬¡æ¨¡å‹**ï¼š

```text
å­˜å‚¨å±‚æ¬¡ï¼š
  Level 1: CPUå¯„å­˜å™¨ï¼ˆæœ€å¿«ï¼Œæœ€å°ï¼‰
  Level 2: CPUç¼“å­˜ï¼ˆå¿«ï¼Œå°ï¼‰
  Level 3: å†…å­˜ï¼ˆä¸­ï¼Œä¸­ï¼‰
  Level 4: ç£ç›˜ï¼ˆæ…¢ï¼Œå¤§ï¼‰

SQLiteå­˜å‚¨å±‚æ¬¡ï¼š
  Memory Cache â†’ Disk Pages â†’ Disk File
```

### 4.2. é¡µç»“æ„ç†è®º

**é¡µå®šä¹‰**ï¼š

```text
é¡µå®šä¹‰ï¼š
  Page = (Header, Data, Footer)

å…¶ä¸­ï¼š
  Header: é¡µå¤´éƒ¨ï¼ˆå…ƒæ•°æ®ï¼‰
  Data: é¡µæ•°æ®ï¼ˆå®é™…æ•°æ®ï¼‰
  Footer: é¡µå°¾éƒ¨ï¼ˆæ ¡éªŒå’Œç­‰ï¼‰

é¡µå¤§å°ï¼š
  PageSize âˆˆ {512, 1024, 2048, 4096, 8192, 16384, 32768, 65536}
  é»˜è®¤ï¼š4096 bytes
```

**é¡µç±»å‹ç†è®º**ï¼š

```text
é¡µç±»å‹å®šä¹‰ï¼š
  PageType = {
    LOCK_BYTE_PAGE: é”å®šå­—èŠ‚é¡µ
    FREELIST_PAGE: è‡ªç”±åˆ—è¡¨é¡µ
    FREELIST_TRUNK_PAGE: è‡ªç”±åˆ—è¡¨ä¸»å¹²é¡µ
    B_TREE_PAGE: B-Treeé¡µ
    PTRMAP_PAGE: æŒ‡é’ˆæ˜ å°„é¡µ
  }

é¡µç±»å‹æ ‡è¯†ï¼š
  PageType(page) = page.header.type
```

**é¡µå¸ƒå±€ç†è®º**ï¼š

```text
é¡µå¸ƒå±€ï¼š
  PageLayout = {
    Header: é¡µå¤´éƒ¨ï¼ˆå›ºå®šå¤§å°ï¼‰
    CellPointers: å•å…ƒæŒ‡é’ˆæ•°ç»„
    FreeSpace: ç©ºé—²ç©ºé—´
    Cells: å•å…ƒæ•°æ®
    Footer: é¡µå°¾éƒ¨ï¼ˆå¯é€‰ï¼‰
  }

ç©ºé—´åˆ†é…ï¼š
  AllocateSpace(page, size) = {
    if FreeSpace(page) â‰¥ size:
      return Allocate(FreeSpace(page), size)
    else:
      return NULL  // éœ€è¦åˆ†è£‚
  }
```

### 4.3. å­˜å‚¨å¸ƒå±€ç†è®º

**æ–‡ä»¶å¸ƒå±€**ï¼š

```text
æ•°æ®åº“æ–‡ä»¶å¸ƒå±€ï¼š
  FileLayout = {
    Header: æ•°æ®åº“å¤´éƒ¨ï¼ˆ100 bytesï¼‰
    Pages: é¡µåºåˆ—
  }

é¡µåˆ†é…ï¼š
  PageAllocation = {
    PageID: é¡µæ ‡è¯†ç¬¦
    PageOffset: é¡µåœ¨æ–‡ä»¶ä¸­çš„åç§»
    PageSize: é¡µå¤§å°
  }

é¡µåœ°å€è®¡ç®—ï¼š
  PageAddress(page_id) = HeaderSize + (page_id - 1) Ã— PageSize
```

**ç©ºé—´ç®¡ç†ç†è®º**ï¼š

```text
ç©ºé—´ç®¡ç†ï¼š
  SpaceManagement = {
    Allocation: é¡µåˆ†é…
    Deallocation: é¡µé‡Šæ”¾
    Fragmentation: ç¢ç‰‡ç®¡ç†
    Compaction: ç©ºé—´å‹ç¼©
  }

è‡ªç”±åˆ—è¡¨ï¼š
  Freelist = {
    TrunkPages: ä¸»å¹²é¡µåˆ—è¡¨
    LeafPages: å¶å­é¡µåˆ—è¡¨
  }
```

### 4.4. å­˜å‚¨æ•ˆç‡ç†è®º

**ç©ºé—´åˆ©ç”¨ç‡**ï¼š

```text
ç©ºé—´åˆ©ç”¨ç‡å®šä¹‰ï¼š
  Utilization(page) = UsedSpace(page) / TotalSpace(page)

å¹³å‡åˆ©ç”¨ç‡ï¼š
  AvgUtilization = Î£ Utilization(pageáµ¢) / n

ç›®æ ‡åˆ©ç”¨ç‡ï¼š
  TargetUtilization âˆˆ [0.5, 0.9]  // 50%-90%
```

**ç¢ç‰‡ç®¡ç†ç†è®º**ï¼š

```text
ç¢ç‰‡å®šä¹‰ï¼š
  Fragmentation = {
    Internal: é¡µå†…ç¢ç‰‡
    External: é¡µé—´ç¢ç‰‡
  }

ç¢ç‰‡åº¦é‡ï¼š
  FragmentationRate = FreeSpace / TotalSpace

ç¢ç‰‡ç®¡ç†ï¼š
  - å†…éƒ¨ç¢ç‰‡ï¼šé¡µå†…ç©ºé—²ç©ºé—´
  - å¤–éƒ¨ç¢ç‰‡ï¼šè‡ªç”±åˆ—è¡¨ä¸­çš„é¡µ
  - ç¢ç‰‡æ•´ç†ï¼šVACUUMæ“ä½œ
```

---

## 5. ç´¢å¼•ç†è®º

### 5.1. ç´¢å¼•å®šä¹‰

**å®šä¹‰2ï¼ˆç´¢å¼•ï¼‰**ï¼šç´¢å¼•æ˜¯æ•°æ®ç»“æ„çš„é›†åˆï¼Œç”¨äºåŠ é€Ÿæ•°æ®è®¿é—®ã€‚

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
ç´¢å¼•å®šä¹‰ï¼š
  Index = (Structure, Keys, Values, Access)

å…¶ä¸­ï¼š
  Structure: ç´¢å¼•ç»“æ„ï¼ˆB-Tree, Hash, etc.ï¼‰
  Keys: é”®é›†åˆ
  Values: å€¼é›†åˆï¼ˆROWIDæˆ–æ•°æ®ï¼‰
  Access: è®¿é—®æ–¹æ³•
```

**ç´¢å¼•ç±»å‹**ï¼š

```text
ç´¢å¼•ç±»å‹ï¼š
  IndexType = {
    PRIMARY_KEY: ä¸»é”®ç´¢å¼•
    UNIQUE: å”¯ä¸€ç´¢å¼•
    NON_UNIQUE: éå”¯ä¸€ç´¢å¼•
    COVERING: è¦†ç›–ç´¢å¼•
    PARTIAL: éƒ¨åˆ†ç´¢å¼•
  }
```

### 5.2. B-Treeç´¢å¼•ç†è®º

**B-Treeç»“æ„ç†è®º**ï¼š

```text
B-Treeå®šä¹‰ï¼š
  BTree = (Root, Nodes, Leaves)

èŠ‚ç‚¹ç»“æ„ï¼š
  Node = {
    Keys: [kâ‚, kâ‚‚, ..., kâ‚™]
    Children: [câ‚, câ‚‚, ..., câ‚™â‚Šâ‚]
    IsLeaf: boolean
  }

B-Treeæ€§è´¨ï¼š
  1. æ‰€æœ‰å¶å­èŠ‚ç‚¹åœ¨åŒä¸€å±‚
  2. æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šmä¸ªå­èŠ‚ç‚¹ï¼ˆmæ˜¯åˆ†æ”¯å› å­ï¼‰
  3. æ ¹èŠ‚ç‚¹è‡³å°‘æœ‰2ä¸ªå­èŠ‚ç‚¹ï¼ˆé™¤éæ˜¯å¶å­ï¼‰
  4. éæ ¹éå¶èŠ‚ç‚¹è‡³å°‘æœ‰âŒˆm/2âŒ‰ä¸ªå­èŠ‚ç‚¹
```

**B-Treeæ€§èƒ½ç†è®º**ï¼š

```text
B-Treeé«˜åº¦ï¼š
  h = âŒˆlog_m(n)âŒ‰

å…¶ä¸­ï¼š
  n: é”®çš„æ•°é‡
  m: åˆ†æ”¯å› å­ï¼ˆé€šå¸¸100-200ï¼‰

æŸ¥æ‰¾å¤æ‚åº¦ï¼š
  Time(Search) = O(h) = O(log_m(n)) = O(log n)

æ’å…¥å¤æ‚åº¦ï¼š
  Time(Insert) = O(h) = O(log n)

åˆ é™¤å¤æ‚åº¦ï¼š
  Time(Delete) = O(h) = O(log n)
```

### 5.3. ç´¢å¼•é€‰æ‹©ç†è®º

**é€‰æ‹©æ€§ç†è®º**ï¼š

```text
é€‰æ‹©æ€§å®šä¹‰ï¼š
  Selectivity(Index, Column) =
    DistinctValues(Column) / TotalRows

é€‰æ‹©æ€§èŒƒå›´ï¼š
  Selectivity âˆˆ [0, 1]
  - 1.0: å®Œå…¨å”¯ä¸€ï¼ˆæœ€ä½³ï¼‰
  - 0.0: å®Œå…¨é‡å¤ï¼ˆæœ€å·®ï¼‰

ç´¢å¼•æ”¶ç›Šï¼š
  IndexBenefit = f(Selectivity, QueryFrequency, UpdateCost)

ç´¢å¼•æˆæœ¬ï¼š
  IndexCost = {
    Storage: å­˜å‚¨ç©ºé—´
    Maintenance: ç»´æŠ¤æˆæœ¬
    Update: æ›´æ–°æˆæœ¬
  }
```

**ç´¢å¼•é€‰æ‹©å†³ç­–**ï¼š

```text
ç´¢å¼•é€‰æ‹©è§„åˆ™ï¼š
  if Selectivity > Threshold and QueryFrequency > UpdateFrequency:
    CreateIndex()
  else:
    NoIndex()

é˜ˆå€¼é€‰æ‹©ï¼š
  Threshold âˆˆ [0.1, 0.3]  // 10%-30%é€‰æ‹©æ€§
```

### 5.4. ç´¢å¼•ç»´æŠ¤ç†è®º

**ç´¢å¼•æ›´æ–°ç†è®º**ï¼š

```text
ç´¢å¼•æ›´æ–°ï¼š
  UpdateIndex(Index, Key, OldValue, NewValue) = {
    if OldValue â‰  NULL:
      Delete(Index, Key, OldValue)
    if NewValue â‰  NULL:
      Insert(Index, Key, NewValue)
  }

æ›´æ–°æˆæœ¬ï¼š
  Cost(UpdateIndex) = Cost(Delete) + Cost(Insert)
                    = O(log n) + O(log n)
                    = O(log n)
```

**ç´¢å¼•é‡å»ºç†è®º**ï¼š

```text
ç´¢å¼•é‡å»ºï¼š
  RebuildIndex(Index) = {
    CreateNewIndex()
    for each row in Table:
      Insert(NewIndex, row.key, row.value)
    Replace(OldIndex, NewIndex)
  }

é‡å»ºæˆæœ¬ï¼š
  Cost(RebuildIndex) = O(n log n)

é‡å»ºæ—¶æœºï¼š
  - ç¢ç‰‡åŒ–ä¸¥é‡
  - ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸ
  - æ€§èƒ½ä¸‹é™
```

---

## 6. ç¼“å­˜ç†è®º

### 6.1. ç¼“å­˜æ¨¡å‹å®šä¹‰

**å®šä¹‰3ï¼ˆç¼“å­˜ï¼‰**ï¼šç¼“å­˜æ˜¯å¿«é€Ÿå­˜å‚¨ä»‹è´¨ï¼Œç”¨äºå­˜å‚¨é¢‘ç¹è®¿é—®çš„æ•°æ®ã€‚

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
ç¼“å­˜æ¨¡å‹ï¼š
  Cache = (Size, Policy, Replacement, Consistency)

å…¶ä¸­ï¼š
  Size: ç¼“å­˜å¤§å°
  Policy: ç¼“å­˜ç­–ç•¥ï¼ˆLRU, LFU, Clock, etc.ï¼‰
  Replacement: æ›¿æ¢ç®—æ³•
  Consistency: ä¸€è‡´æ€§åè®®
```

**ç¼“å­˜å±‚æ¬¡**ï¼š

```text
SQLiteç¼“å­˜å±‚æ¬¡ï¼š
  Level 1: é¡µé¢ç¼“å­˜ï¼ˆPager Cacheï¼‰
  Level 2: æ“ä½œç³»ç»Ÿé¡µé¢ç¼“å­˜
  Level 3: ç£ç›˜

ç¼“å­˜å¤§å°ï¼š
  CacheSize = PRAGMA cache_size
  é»˜è®¤ï¼š-2000 pages (2MB)
  æ¨èï¼šæ ¹æ®å¯ç”¨å†…å­˜è°ƒæ•´
```

### 6.2. ç¼“å­˜æ›¿æ¢ç†è®º

**LRUç®—æ³•**ï¼š

```text
LRUï¼ˆLeast Recently Usedï¼‰ç®—æ³•ï¼š
  ReplaceLRU(Cache) = {
    victim = LeastRecentlyUsed(Cache)
    Evict(victim)
    return victim
  }

LRUå®ç°ï¼š
  - ä½¿ç”¨åŒå‘é“¾è¡¨ç»´æŠ¤è®¿é—®é¡ºåº
  - è®¿é—®æ—¶ç§»åŠ¨åˆ°é“¾è¡¨å¤´éƒ¨
  - æ›¿æ¢æ—¶é€‰æ‹©é“¾è¡¨å°¾éƒ¨

LRUå¤æ‚åº¦ï¼š
  Time(Access) = O(1)
  Time(Replace) = O(1)
```

**LFUç®—æ³•**ï¼š

```text
LFUï¼ˆLeast Frequently Usedï¼‰ç®—æ³•ï¼š
  ReplaceLFU(Cache) = {
    victim = LeastFrequentlyUsed(Cache)
    Evict(victim)
    return victim
  }

LFUå®ç°ï¼š
  - ç»´æŠ¤è®¿é—®é¢‘ç‡è®¡æ•°
  - æ›¿æ¢æ—¶é€‰æ‹©é¢‘ç‡æœ€ä½çš„é¡µ

LFUå¤æ‚åº¦ï¼š
  Time(Access) = O(1)
  Time(Replace) = O(log n)  // éœ€è¦å †ç»´æŠ¤
```

**Clockç®—æ³•**ï¼š

```text
Clockç®—æ³•ï¼š
  ReplaceClock(Cache) = {
    while True:
      page = ClockHand()
      if page.reference_bit == 0:
        Evict(page)
        return page
      else:
        page.reference_bit = 0
        ClockHand = Next()
  }

Clockå¤æ‚åº¦ï¼š
  Time(Access) = O(1)
  Time(Replace) = O(n) æœ€åæƒ…å†µ
```

### 6.3. ç¼“å­˜ä¸€è‡´æ€§ç†è®º

**ä¸€è‡´æ€§æ¨¡å‹**ï¼š

```text
ä¸€è‡´æ€§å®šä¹‰ï¼š
  CacheConsistency = {
    ReadConsistency: è¯»ä¸€è‡´æ€§
    WriteConsistency: å†™ä¸€è‡´æ€§
    Coherence: ç¼“å­˜ä¸€è‡´æ€§
  }

ä¸€è‡´æ€§çº§åˆ«ï¼š
  - å¼ºä¸€è‡´æ€§ï¼šç«‹å³åŒæ­¥
  - å¼±ä¸€è‡´æ€§ï¼šå»¶è¿ŸåŒæ­¥
  - æœ€ç»ˆä¸€è‡´æ€§ï¼šæœ€ç»ˆåŒæ­¥
```

**SQLiteç¼“å­˜ä¸€è‡´æ€§**ï¼š

```text
SQLiteä¸€è‡´æ€§æ¨¡å‹ï¼š
  - å†™æ—¶å¤åˆ¶ï¼ˆCopy-on-Writeï¼‰
  - è„é¡µæ ‡è®°
  - äº‹åŠ¡æäº¤æ—¶åŒæ­¥

ä¸€è‡´æ€§ä¿è¯ï¼š
  âˆ€Page p in Cache:
    if p.dirty:
      Sync(p) before Commit
    else:
      p is consistent
```

### 6.4. ç¼“å­˜æ€§èƒ½ç†è®º

**å‘½ä¸­ç‡ç†è®º**ï¼š

```text
å‘½ä¸­ç‡å®šä¹‰ï¼š
  HitRate = CacheHits / (CacheHits + CacheMisses)

å‘½ä¸­ç‡èŒƒå›´ï¼š
  HitRate âˆˆ [0, 1]
  - 1.0: å…¨éƒ¨å‘½ä¸­ï¼ˆç†æƒ³ï¼‰
  - 0.0: å…¨éƒ¨æœªå‘½ä¸­ï¼ˆæœ€å·®ï¼‰

æ€§èƒ½å½±å“ï¼š
  AvgAccessTime = HitRate Ã— CacheAccessTime +
                  (1 - HitRate) Ã— DiskAccessTime
```

**ç¼“å­˜æ€§èƒ½ä¼˜åŒ–**ï¼š

```text
ä¼˜åŒ–ç­–ç•¥ï¼š
  1. å¢åŠ ç¼“å­˜å¤§å°ï¼šæå‡å‘½ä¸­ç‡
  2. ä¼˜åŒ–æ›¿æ¢ç®—æ³•ï¼šé€‰æ‹©æ›´å¥½çš„æ›¿æ¢ç­–ç•¥
  3. é¢„å–ç­–ç•¥ï¼šé¢„æµ‹æ€§åŠ è½½
  4. æ‰¹é‡æ“ä½œï¼šå‡å°‘ç¼“å­˜å¤±æ•ˆ

æ€§èƒ½åˆ†æï¼š
  OptimalCacheSize = f(WorkingSet, AvailableMemory, AccessPattern)
```

---

## 7. æŒä¹…åŒ–ç†è®º

### 7.1. æŒä¹…åŒ–å®šä¹‰

**å®šä¹‰4ï¼ˆæŒä¹…åŒ–ï¼‰**ï¼šæŒä¹…åŒ–æ˜¯ç¡®ä¿æ•°æ®åœ¨ç³»ç»Ÿæ•…éšœåä»ç„¶å­˜åœ¨çš„æœºåˆ¶ã€‚

**å½¢å¼åŒ–è¡¨ç¤º**ï¼š

```text
æŒä¹…åŒ–å®šä¹‰ï¼š
  Persistence(Data) = {
    âˆ€Failure: AfterRecovery(Data) = Data
  }

æŒä¹…åŒ–ä¿è¯ï¼š
  âˆ€Transaction T:
    Commit(T) â†’ Persistent(Result(T))
```

### 7.2. æ—¥å¿—ç†è®º

**æ—¥å¿—ç±»å‹**ï¼š

```text
æ—¥å¿—ç±»å‹ï¼š
  LogType = {
    REDO_LOG: é‡åšæ—¥å¿—ï¼ˆWALï¼‰
    UNDO_LOG: æ’¤é”€æ—¥å¿—ï¼ˆRollback Journalï¼‰
    COMBINED_LOG: ç»„åˆæ—¥å¿—
  }

æ—¥å¿—è®°å½•ï¼š
  LogRecord = (TransactionID, Operation, Data, Timestamp)
```

**WALæ—¥å¿—ç†è®º**ï¼š

```text
WALæœºåˆ¶ï¼š
  Write-Ahead Logging = {
    Write: å…ˆå†™WALï¼Œåå†™æ•°æ®åº“
    Commit: WALåŒæ­¥åæäº¤
    Checkpoint: å®šæœŸå°†WALå†™å…¥æ•°æ®åº“
  }

WALåè®®ï¼š
  WALProtocol = {
    1. WriteToWAL(Operation)
    2. SyncWAL()
    3. CommitTransaction()
    4. (Later) Checkpoint()
  }
```

### 7.3. æ¢å¤ç†è®º

**æ¢å¤ç®—æ³•**ï¼š

```text
æ¢å¤ç®—æ³•ï¼š
  Recovery() = {
    // 1. åˆ†æé˜¶æ®µ
    ActiveTransactions = AnalyzeLog()

    // 2. é‡åšé˜¶æ®µ
    for each log record in WAL:
      if Committed(log.transaction):
        Redo(log.operation)

    // 3. æ’¤é”€é˜¶æ®µ
    for each transaction in ActiveTransactions:
      Undo(transaction)
  }

æ¢å¤æ­£ç¡®æ€§ï¼š
  RecoveryCorrectness = {
    âˆ€CommittedTransaction T: Redo(T)
    âˆ€UncommittedTransaction T: Undo(T)
  }
```

**æ¢å¤æ€§èƒ½**ï¼š

```text
æ¢å¤æ—¶é—´ï¼š
  RecoveryTime = f(WALSize, ActiveTransactions, DiskSpeed)

ä¼˜åŒ–ç­–ç•¥ï¼š
  1. å®šæœŸCheckpointï¼šå‡å°‘WALå¤§å°
  2. å¿«é€Ÿæ¢å¤ï¼šä¼˜åŒ–æ¢å¤ç®—æ³•
  3. å¢é‡æ¢å¤ï¼šåªæ¢å¤å¿…è¦çš„éƒ¨åˆ†
```

### 7.4. ä¸€è‡´æ€§ç†è®º

**ä¸€è‡´æ€§å®šä¹‰**ï¼š

```text
ä¸€è‡´æ€§å®šä¹‰ï¼š
  Consistency = {
    Structural: ç»“æ„ä¸€è‡´æ€§ï¼ˆé¡µç»“æ„æ­£ç¡®ï¼‰
    Logical: é€»è¾‘ä¸€è‡´æ€§ï¼ˆæ•°æ®å®Œæ•´æ€§ï¼‰
    Referential: å‚ç…§ä¸€è‡´æ€§ï¼ˆå¤–é”®çº¦æŸï¼‰
  }

ä¸€è‡´æ€§æ£€æŸ¥ï¼š
  ConsistencyCheck() = {
    CheckPageStructure()
    CheckIntegrityConstraints()
    CheckReferentialIntegrity()
  }
```

**ä¸€è‡´æ€§ä¿è¯**ï¼š

```text
ä¸€è‡´æ€§ä¿è¯ï¼š
  âˆ€State S:
    Consistent(S) â†’
      AfterRecovery(S) is Consistent

ä¸€è‡´æ€§ç»´æŠ¤ï¼š
  - äº‹åŠ¡ä¿è¯é€»è¾‘ä¸€è‡´æ€§
  - æ—¥å¿—ä¿è¯ç»“æ„ä¸€è‡´æ€§
  - çº¦æŸä¿è¯å‚ç…§ä¸€è‡´æ€§
```

---

## 8. å­˜å‚¨ç†è®ºæ€»ç»“

### 8.1. ç†è®ºæ¨¡å‹è¦ç‚¹

**æ ¸å¿ƒç†è®º**ï¼š

1. **å­˜å‚¨æ¨¡å‹ç†è®º**ï¼šé¡µç»“æ„ã€å­˜å‚¨å¸ƒå±€ã€å­˜å‚¨æ•ˆç‡
2. **ç´¢å¼•ç†è®º**ï¼šB-Treeç´¢å¼•ã€ç´¢å¼•é€‰æ‹©ã€ç´¢å¼•ç»´æŠ¤
3. **ç¼“å­˜ç†è®º**ï¼šç¼“å­˜æ¨¡å‹ã€æ›¿æ¢ç®—æ³•ã€ä¸€è‡´æ€§ã€æ€§èƒ½
4. **æŒä¹…åŒ–ç†è®º**ï¼šæ—¥å¿—ç†è®ºã€æ¢å¤ç†è®ºã€ä¸€è‡´æ€§ç†è®º

### 8.2. SQLiteå­˜å‚¨ç‰¹æ€§

**SQLiteå®ç°**ï¼š

- âœ… é¡µå¼å­˜å‚¨ï¼ˆ4KBé»˜è®¤ï¼‰
- âœ… B-Treeç´¢å¼•
- âœ… é¡µé¢ç¼“å­˜ï¼ˆLRUï¼‰
- âœ… WALæ—¥å¿—
- âœ… è‡ªåŠ¨æ¢å¤

### 8.3. ç†è®ºåº”ç”¨

**åº”ç”¨åœºæ™¯**ï¼š

- å­˜å‚¨è®¾è®¡
- ç´¢å¼•è®¾è®¡
- ç¼“å­˜ä¼˜åŒ–
- æŒä¹…åŒ–ä¿è¯

### 8.4. å­˜å‚¨ç†è®ºéªŒè¯ä»£ç 

**å­˜å‚¨æ¨¡å‹éªŒè¯**ï¼š

```python
import sqlite3
import os

def test_storage_model():
    """éªŒè¯å­˜å‚¨æ¨¡å‹"""
    db_file = 'test_storage.db'
    conn = sqlite3.connect(db_file)
    cursor = conn.cursor()

# æµ‹è¯•é¡µå¤§å°
    cursor.execute('PRAGMA page_size')
    page_size = cursor.fetchone()[0]
    print(f"é¡µå¤§å°: {page_size} bytes")
    assert page_size in [512, 1024, 2048, 4096, 8192, 16384, 32768, 65536]

# æµ‹è¯•é¡µæ•°
    cursor.execute('CREATE TABLE test (id INTEGER PRIMARY KEY, value TEXT)')
    cursor.execute('INSERT INTO test (value) VALUES (?)', ('test',))
    conn.commit()

    cursor.execute('PRAGMA page_count')
    page_count = cursor.fetchone()[0]
    print(f"é¡µæ•°: {page_count}")
    assert page_count > 0

# æµ‹è¯•æ–‡ä»¶å¤§å°
    file_size = os.path.getsize(db_file)
    print(f"æ–‡ä»¶å¤§å°: {file_size} bytes")
    assert file_size >= page_size * page_count

    conn.close()
    os.unlink(db_file)
    print("âœ… å­˜å‚¨æ¨¡å‹éªŒè¯é€šè¿‡")

def test_index_performance():
    """éªŒè¯ç´¢å¼•æ€§èƒ½"""
    conn = sqlite3.connect(':memory:')
    cursor = conn.cursor()

    cursor.execute('CREATE TABLE test (id INTEGER PRIMARY KEY, value TEXT)')

# æ’å…¥æ•°æ®
    cursor.executemany('INSERT INTO test (value) VALUES (?)',
                      [(f'value_{i}',) for i in range(10000)])

# æµ‹è¯•æ— ç´¢å¼•æŸ¥æ‰¾
    import time
    start = time.perf_counter()
    cursor.execute('SELECT * FROM test WHERE value = ?', ('value_5000',))
    cursor.fetchone()
    time_no_index = time.perf_counter() - start

# åˆ›å»ºç´¢å¼•
    cursor.execute('CREATE INDEX idx_value ON test(value)')

# æµ‹è¯•æœ‰ç´¢å¼•æŸ¥æ‰¾
    start = time.perf_counter()
    cursor.execute('SELECT * FROM test WHERE value = ?', ('value_5000',))
    cursor.fetchone()
    time_with_index = time.perf_counter() - start

    print(f"æ— ç´¢å¼•æŸ¥æ‰¾æ—¶é—´: {time_no_index*1000:.3f}ms")
    print(f"æœ‰ç´¢å¼•æŸ¥æ‰¾æ—¶é—´: {time_with_index*1000:.3f}ms")
    print(f"æ€§èƒ½æå‡: {time_no_index/time_with_index:.1f}x")

    assert time_with_index < time_no_index / 10, "ç´¢å¼•åº”è¯¥æ˜¾è‘—æå‡æ€§èƒ½"

    conn.close()
    print("âœ… ç´¢å¼•æ€§èƒ½éªŒè¯é€šè¿‡")

def test_cache_performance():
    """éªŒè¯ç¼“å­˜æ€§èƒ½"""
    conn = sqlite3.connect(':memory:')
    cursor = conn.cursor()

# è®¾ç½®ç¼“å­˜å¤§å°
    cursor.execute('PRAGMA cache_size=-2000')  # 2MBç¼“å­˜
    cursor.execute('CREATE TABLE test (id INTEGER PRIMARY KEY, value TEXT)')

# æ’å…¥æ•°æ®
    cursor.executemany('INSERT INTO test (value) VALUES (?)',
                      [(f'value_{i}',) for i in range(1000)])

# æµ‹è¯•ç¼“å­˜å‘½ä¸­
    import time
    times = []
    for _ in range(100):
        start = time.perf_counter()
        cursor.execute('SELECT * FROM test WHERE id = ?', (500,))
        cursor.fetchone()
        times.append(time.perf_counter() - start)

    avg_time = sum(times) / len(times)
    print(f"å¹³å‡æŸ¥è¯¢æ—¶é—´: {avg_time*1000:.3f}ms")
    assert avg_time < 0.001, "ç¼“å­˜åº”è¯¥æä¾›å¿«é€Ÿè®¿é—®"

    conn.close()
    print("âœ… ç¼“å­˜æ€§èƒ½éªŒè¯é€šè¿‡")

def test_persistence():
    """éªŒè¯æŒä¹…åŒ–"""
    db_file = 'test_persistence.db'

# å†™å…¥æ•°æ®
    conn1 = sqlite3.connect(db_file)
    cursor1 = conn1.cursor()
    cursor1.execute('CREATE TABLE test (id INTEGER PRIMARY KEY, value TEXT)')
    cursor1.execute('INSERT INTO test (value) VALUES (?)', ('persistent',))
    conn1.commit()
    conn1.close()

# é‡æ–°è¿æ¥ï¼ŒéªŒè¯æ•°æ®æŒä¹…åŒ–
    conn2 = sqlite3.connect(db_file)
    cursor2 = conn2.cursor()
    cursor2.execute('SELECT value FROM test WHERE id = 1')
    value = cursor2.fetchone()[0]

    assert value == 'persistent', "æ•°æ®åº”è¯¥æŒä¹…åŒ–"

    conn2.close()
    os.unlink(db_file)
    print("âœ… æŒä¹…åŒ–éªŒè¯é€šè¿‡")

# è¿è¡Œæµ‹è¯•
if __name__ == '__main__':
    test_storage_model()
    test_index_performance()
    test_cache_performance()
    test_persistence()
```

---

## 9. ğŸ”— ç›¸å…³èµ„æº

- [01.03 å­˜å‚¨å¼•æ“](../01-æ ¸å¿ƒæ¶æ„/01.03-å­˜å‚¨å¼•æ“.md)
- [03.01 æ€§èƒ½ç‰¹å¾åˆ†æ](../03-æ€§èƒ½ä¼˜åŒ–/03.01-æ€§èƒ½ç‰¹å¾åˆ†æ.md)
- [06.02 B-Treeæ­£ç¡®æ€§è¯æ˜](../06-å½¢å¼åŒ–ç†è®º/06.02-B-Treeæ­£ç¡®æ€§è¯æ˜.md)

---

## 10. ğŸ“š å‚è€ƒèµ„æ–™

- ã€Šæ•°æ®åº“ç³»ç»Ÿå®ç°ã€‹
- ã€Šå­˜å‚¨ç³»ç»Ÿï¼šè®¾è®¡ä¸å®ç°ã€‹
- ã€Šæ“ä½œç³»ç»Ÿï¼šè®¾è®¡ä¸å®ç°ã€‹

---

**æœ€åæ›´æ–°**ï¼š2025-01-15
**ç»´æŠ¤è€…**ï¼šData-Science Team
