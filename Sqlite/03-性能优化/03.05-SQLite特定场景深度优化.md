# SQLiteç‰¹å®šåœºæ™¯æ·±åº¦ä¼˜åŒ–

> **åˆ›å»ºæ—¥æœŸ**: 2025-12-05
> **ç‰ˆæœ¬**: SQLite 3.47.x
> **éš¾åº¦**: â­â­â­â­â­
> **é€‚ç”¨åœºæ™¯**: ç‰¹å®šä¸šåŠ¡åœºæ™¯çš„æ€§èƒ½æè‡´ä¼˜åŒ–

---

## ğŸ“‘ ç›®å½•

- [SQLiteç‰¹å®šåœºæ™¯æ·±åº¦ä¼˜åŒ–](#sqliteç‰¹å®šåœºæ™¯æ·±åº¦ä¼˜åŒ–)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [ä¼˜åŒ–åœºæ™¯æ€»è§ˆ](#ä¼˜åŒ–åœºæ™¯æ€»è§ˆ)
  - [1. æ—¶é—´åºåˆ—æ•°æ®ä¼˜åŒ–](#1-æ—¶é—´åºåˆ—æ•°æ®ä¼˜åŒ–)
    - [1.1 åˆ†åŒºè¡¨è®¾è®¡](#11-åˆ†åŒºè¡¨è®¾è®¡)
    - [1.2 æ—¶é—´ç´¢å¼•ä¼˜åŒ–](#12-æ—¶é—´ç´¢å¼•ä¼˜åŒ–)
    - [1.3 æ•°æ®å½’æ¡£ç­–ç•¥](#13-æ•°æ®å½’æ¡£ç­–ç•¥)
  - [2. å…¨æ–‡æœç´¢ä¼˜åŒ–](#2-å…¨æ–‡æœç´¢ä¼˜åŒ–)
    - [2.1 FTS5é…ç½®ä¼˜åŒ–](#21-fts5é…ç½®ä¼˜åŒ–)
    - [2.2 æœç´¢æ€§èƒ½ä¼˜åŒ–](#22-æœç´¢æ€§èƒ½ä¼˜åŒ–)
  - [3. æ—¥å¿—æ•°æ®ä¼˜åŒ–](#3-æ—¥å¿—æ•°æ®ä¼˜åŒ–)
    - [3.1 è¿½åŠ å†™å…¥ä¼˜åŒ–](#31-è¿½åŠ å†™å…¥ä¼˜åŒ–)
    - [3.2 æ—¥å¿—è½®è½¬ç­–ç•¥](#32-æ—¥å¿—è½®è½¬ç­–ç•¥)
  - [4. ç¼“å­˜æ•°æ®ä¼˜åŒ–](#4-ç¼“å­˜æ•°æ®ä¼˜åŒ–)
    - [4.1 å†…å­˜æ•°æ®åº“](#41-å†…å­˜æ•°æ®åº“)
    - [4.2 ç¼“å­˜æ·˜æ±°ç­–ç•¥](#42-ç¼“å­˜æ·˜æ±°ç­–ç•¥)
  - [5. åˆ†ææŸ¥è¯¢ä¼˜åŒ–](#5-åˆ†ææŸ¥è¯¢ä¼˜åŒ–)
    - [5.1 ç‰©åŒ–è§†å›¾](#51-ç‰©åŒ–è§†å›¾)
    - [5.2 é¢„èšåˆè¡¨](#52-é¢„èšåˆè¡¨)
  - [6. æ‰¹é‡å¯¼å…¥ä¼˜åŒ–](#6-æ‰¹é‡å¯¼å…¥ä¼˜åŒ–)
    - [6.1 æ‰¹é‡æ’å…¥ç­–ç•¥](#61-æ‰¹é‡æ’å…¥ç­–ç•¥)
    - [6.2 å¯¼å…¥æ€§èƒ½ä¼˜åŒ–](#62-å¯¼å…¥æ€§èƒ½ä¼˜åŒ–)
  - [6.5. åœºæ™¯ä¼˜åŒ–å†³ç­–æ ‘](#65-åœºæ™¯ä¼˜åŒ–å†³ç­–æ ‘)
  - [6.6. åœºæ™¯ä¼˜åŒ–è®ºè¯è„‰ç»œ](#66-åœºæ™¯ä¼˜åŒ–è®ºè¯è„‰ç»œ)
    - [6.6.1. è®ºè¯ç›®æ ‡](#661-è®ºè¯ç›®æ ‡)
    - [6.6.2. è®ºè¯é“¾æ¡](#662-è®ºè¯é“¾æ¡)
    - [6.6.3. å…³é”®è®ºè¯æ­¥éª¤](#663-å…³é”®è®ºè¯æ­¥éª¤)
    - [6.6.4. æ­£åä¾‹è¯æ˜](#664-æ­£åä¾‹è¯æ˜)
  - [7. ğŸ”— ç›¸å…³èµ„æº](#7--ç›¸å…³èµ„æº)
    - [å†…éƒ¨èµ„æº](#å†…éƒ¨èµ„æº)
    - [å¤–éƒ¨èµ„æº](#å¤–éƒ¨èµ„æº)
  - [8. ğŸ”— äº¤å‰å¼•ç”¨](#8--äº¤å‰å¼•ç”¨)
    - [8.1. æ€§èƒ½ä¼˜åŒ–æ–‡æ¡£](#81-æ€§èƒ½ä¼˜åŒ–æ–‡æ¡£)
    - [8.2. æ ¸å¿ƒæ¶æ„æ–‡æ¡£](#82-æ ¸å¿ƒæ¶æ„æ–‡æ¡£)
    - [8.3. å½¢å¼åŒ–ç†è®º ğŸ†•](#83-å½¢å¼åŒ–ç†è®º-)
    - [8.4. çŸ¥è¯†å›¾è°±ä¸å¯¼èˆª ğŸ†•](#84-çŸ¥è¯†å›¾è°±ä¸å¯¼èˆª-)
    - [8.5. ç›¸å…³æ¦‚å¿µé“¾æ¥ ğŸ†•](#85-ç›¸å…³æ¦‚å¿µé“¾æ¥-)
      - [8.5.1. åœºæ™¯ä¼˜åŒ–æ¦‚å¿µ](#851-åœºæ™¯ä¼˜åŒ–æ¦‚å¿µ)
      - [8.5.2. åœºæ™¯ä¼˜åŒ–è·¯å¾„](#852-åœºæ™¯ä¼˜åŒ–è·¯å¾„)

---

## ä¼˜åŒ–åœºæ™¯æ€»è§ˆ

```text
ç‰¹å®šåœºæ™¯ä¼˜åŒ–çŸ©é˜µ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœºæ™¯                 â”‚ ä¸»è¦æŒ‘æˆ˜     â”‚ ä¼˜åŒ–ç­–ç•¥      â”‚ æ€§èƒ½æå‡      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ—¶é—´åºåˆ—æ•°æ®         â”‚ æ•°æ®é‡å¤§      â”‚ åˆ†åŒº+å½’æ¡£     â”‚ 10-100å€     â”‚
â”‚                     â”‚ æŸ¥è¯¢æ…¢        â”‚ æ—¶é—´ç´¢å¼•     â”‚              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å…¨æ–‡æœç´¢             â”‚ æœç´¢æ…¢       â”‚ FTS5ä¼˜åŒ–      â”‚ 5-20å€       â”‚
â”‚                     â”‚ ç´¢å¼•å¤§        â”‚ åˆ†è¯ä¼˜åŒ–     â”‚              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ—¥å¿—æ•°æ®             â”‚ å†™å…¥é¢‘ç¹     â”‚ è¿½åŠ å†™å…¥      â”‚ 50-200å€     â”‚
â”‚                     â”‚ æ–‡ä»¶å¢é•¿å¿«    â”‚ WALæ¨¡å¼      â”‚              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¼“å­˜æ•°æ®             â”‚ å†…å­˜é™åˆ¶     â”‚ å†…å­˜æ•°æ®åº“    â”‚ 100-1000å€   â”‚
â”‚                     â”‚ æ·˜æ±°ç­–ç•¥      â”‚ LRUç­–ç•¥      â”‚              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åˆ†ææŸ¥è¯¢             â”‚ èšåˆæ…¢       â”‚ ç‰©åŒ–è§†å›¾      â”‚ 10-50å€      â”‚
â”‚                     â”‚ å®æ—¶æ€§è¦æ±‚    â”‚ é¢„èšåˆè¡¨      â”‚              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ‰¹é‡å¯¼å…¥             â”‚ å¯¼å…¥æ…¢       â”‚ æ‰¹é‡äº‹åŠ¡      â”‚ 100-1000å€   â”‚
â”‚                     â”‚ é”ç«äº‰        â”‚ ä¼˜åŒ–é…ç½®     â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. æ—¶é—´åºåˆ—æ•°æ®ä¼˜åŒ–

### 1.1 åˆ†åŒºè¡¨è®¾è®¡

```python
import sqlite3
from datetime import datetime, timedelta

class TimeSeriesPartition:
    def __init__(self, db_path: str, table_prefix: str = 'metrics'):
        self.db_path = db_path
        self.table_prefix = table_prefix
        self.conn = sqlite3.connect(db_path)
        self.setup_partitions()

    def setup_partitions(self):
        """è®¾ç½®åˆ†åŒºè¡¨"""
        cursor = self.conn.cursor()

        # åˆ›å»ºä¸»è¡¨ï¼ˆè§†å›¾ï¼‰
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS metrics (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                timestamp INTEGER NOT NULL,
                metric_name TEXT NOT NULL,
                value REAL NOT NULL,
                tags TEXT
            )
        """)

        # åˆ›å»ºæ—¶é—´ç´¢å¼•
        cursor.execute("""
            CREATE INDEX IF NOT EXISTS idx_metrics_time
            ON metrics(timestamp, metric_name)
        """)

        self.conn.commit()

    def get_partition_table(self, timestamp: int) -> str:
        """æ ¹æ®æ—¶é—´æˆ³è·å–åˆ†åŒºè¡¨å"""
        dt = datetime.fromtimestamp(timestamp)
        # æŒ‰æœˆåˆ†åŒº
        partition_name = f"{self.table_prefix}_{dt.strftime('%Y%m')}"
        return partition_name

    def ensure_partition(self, timestamp: int):
        """ç¡®ä¿åˆ†åŒºè¡¨å­˜åœ¨"""
        partition_name = self.get_partition_table(timestamp)
        cursor = self.conn.cursor()

        cursor.execute(f"""
            CREATE TABLE IF NOT EXISTS {partition_name} (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                timestamp INTEGER NOT NULL,
                metric_name TEXT NOT NULL,
                value REAL NOT NULL,
                tags TEXT
            )
        """)

        cursor.execute(f"""
            CREATE INDEX IF NOT EXISTS idx_{partition_name}_time
            ON {partition_name}(timestamp, metric_name)
        """)

        self.conn.commit()

    def insert_metric(self, timestamp: int, metric_name: str, value: float, tags: str = None):
        """æ’å…¥æŒ‡æ ‡æ•°æ®"""
        partition_name = self.get_partition_table(timestamp)
        self.ensure_partition(partition_name)

        cursor = self.conn.cursor()
        cursor.execute(f"""
            INSERT INTO {partition_name} (timestamp, metric_name, value, tags)
            VALUES (?, ?, ?, ?)
        """, (timestamp, metric_name, value, tags))

        self.conn.commit()

    def query_range(self, start_time: int, end_time: int, metric_name: str = None):
        """æŸ¥è¯¢æ—¶é—´èŒƒå›´å†…çš„æ•°æ®"""
        results = []
        cursor = self.conn.cursor()

        # è·å–æ‰€æœ‰æ¶‰åŠçš„åˆ†åŒº
        start_dt = datetime.fromtimestamp(start_time)
        end_dt = datetime.fromtimestamp(end_time)

        current = start_dt.replace(day=1)
        while current <= end_dt:
            partition_name = f"{self.table_prefix}_{current.strftime('%Y%m')}"

            query = f"""
                SELECT * FROM {partition_name}
                WHERE timestamp >= ? AND timestamp <= ?
            """
            params = [start_time, end_time]

            if metric_name:
                query += " AND metric_name = ?"
                params.append(metric_name)

            cursor.execute(query, params)
            results.extend(cursor.fetchall())

            # ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªæœˆ
            if current.month == 12:
                current = current.replace(year=current.year + 1, month=1)
            else:
                current = current.replace(month=current.month + 1)

        return results
```

### 1.2 æ—¶é—´ç´¢å¼•ä¼˜åŒ–

```python
class TimeIndexOptimizer:
    def __init__(self, conn):
        self.conn = conn

    def create_optimized_time_index(self, table_name: str, time_column: str):
        """åˆ›å»ºä¼˜åŒ–çš„æ—¶é—´ç´¢å¼•"""
        cursor = self.conn.cursor()

        # ä½¿ç”¨è¦†ç›–ç´¢å¼•
        cursor.execute(f"""
            CREATE INDEX IF NOT EXISTS idx_{table_name}_time_covering
            ON {table_name}({time_column}, metric_name)
            INCLUDE (value, tags)
        """)

        # åˆ›å»ºéƒ¨åˆ†ç´¢å¼•ï¼ˆåªç´¢å¼•æœ€è¿‘çš„æ•°æ®ï¼‰
        cursor.execute(f"""
            CREATE INDEX IF NOT EXISTS idx_{table_name}_recent
            ON {table_name}({time_column})
            WHERE {time_column} > strftime('%s', 'now', '-30 days')
        """)

        self.conn.commit()
```

### 1.3 æ•°æ®å½’æ¡£ç­–ç•¥

```python
class TimeSeriesArchiver:
    def __init__(self, db_path: str, archive_path: str):
        self.db_path = db_path
        self.archive_path = archive_path
        self.conn = sqlite3.connect(db_path)

    def archive_old_data(self, days_to_keep: int = 90):
        """å½’æ¡£æ—§æ•°æ®"""
        cutoff_time = int((datetime.now() - timedelta(days=days_to_keep)).timestamp())

        cursor = self.conn.cursor()

        # è·å–æ‰€æœ‰åˆ†åŒº
        cursor.execute("""
            SELECT name FROM sqlite_master
            WHERE type='table' AND name LIKE 'metrics_%'
        """)

        partitions = cursor.fetchall()

        for (partition_name,) in partitions:
            # æ£€æŸ¥åˆ†åŒºä¸­æœ€æ—§çš„æ•°æ®
            cursor.execute(f"""
                SELECT MIN(timestamp) FROM {partition_name}
            """)
            min_time = cursor.fetchone()[0]

            if min_time and min_time < cutoff_time:
                # å½’æ¡£æ•´ä¸ªåˆ†åŒº
                self._archive_partition(partition_name, cutoff_time)

    def _archive_partition(self, partition_name: str, cutoff_time: int):
        """å½’æ¡£åˆ†åŒº"""
        # å¯¼å‡ºåˆ°å½’æ¡£æ•°æ®åº“
        archive_conn = sqlite3.connect(self.archive_path)
        cursor = self.conn.cursor()
        archive_cursor = archive_conn.cursor()

        # åˆ›å»ºå½’æ¡£è¡¨
        archive_cursor.execute(f"""
            CREATE TABLE IF NOT EXISTS {partition_name} AS
            SELECT * FROM {partition_name}
            WHERE timestamp < ?
        """, (cutoff_time,))

        # åˆ é™¤åŸè¡¨ä¸­çš„æ—§æ•°æ®
        cursor.execute(f"""
            DELETE FROM {partition_name}
            WHERE timestamp < ?
        """, (cutoff_time,))

        archive_conn.commit()
        self.conn.commit()
        archive_conn.close()
```

---

## 2. å…¨æ–‡æœç´¢ä¼˜åŒ–

### 2.1 FTS5é…ç½®ä¼˜åŒ–

```python
class FTS5Optimizer:
    def __init__(self, conn):
        self.conn = conn

    def create_optimized_fts5(self, table_name: str):
        """åˆ›å»ºä¼˜åŒ–çš„FTS5è¡¨"""
        cursor = self.conn.cursor()

        # åˆ›å»ºFTS5è™šæ‹Ÿè¡¨
        cursor.execute(f"""
            CREATE VIRTUAL TABLE IF NOT EXISTS {table_name}_fts USING fts5(
                title,
                content,
                tokenize='porter unicode61',
                content='{table_name}',
                content_rowid='id'
            )
        """)

        # åˆ›å»ºè§¦å‘å™¨ä¿æŒåŒæ­¥
        cursor.execute(f"""
            CREATE TRIGGER IF NOT EXISTS {table_name}_fts_insert AFTER INSERT ON {table_name}
            BEGIN
                INSERT INTO {table_name}_fts(rowid, title, content)
                VALUES (new.id, new.title, new.content);
            END
        """)

        cursor.execute(f"""
            CREATE TRIGGER IF NOT EXISTS {table_name}_fts_update AFTER UPDATE ON {table_name}
            BEGIN
                UPDATE {table_name}_fts SET title = new.title, content = new.content
                WHERE rowid = new.id;
            END
        """)

        cursor.execute(f"""
            CREATE TRIGGER IF NOT EXISTS {table_name}_fts_delete AFTER DELETE ON {table_name}
            BEGIN
                DELETE FROM {table_name}_fts WHERE rowid = old.id;
            END
        """)

        self.conn.commit()

    def optimize_fts5(self, table_name: str):
        """ä¼˜åŒ–FTS5ç´¢å¼•"""
        cursor = self.conn.cursor()

        # åˆå¹¶FTS5æ®µ
        cursor.execute(f"INSERT INTO {table_name}_fts({table_name}_fts) VALUES('merge', 4)")

        # ä¼˜åŒ–FTS5ç´¢å¼•
        cursor.execute(f"INSERT INTO {table_name}_fts({table_name}_fts) VALUES('optimize')")

        self.conn.commit()
```

### 2.2 æœç´¢æ€§èƒ½ä¼˜åŒ–

```python
class SearchOptimizer:
    def __init__(self, conn):
        self.conn = conn

    def optimized_search(self, query: str, limit: int = 20):
        """ä¼˜åŒ–çš„æœç´¢æŸ¥è¯¢"""
        cursor = self.conn.cursor()

        # ä½¿ç”¨BM25æ’åº
        cursor.execute("""
            SELECT
                rowid,
                title,
                content,
                bm25(documents_fts) AS rank
            FROM documents_fts
            WHERE documents_fts MATCH ?
            ORDER BY rank
            LIMIT ?
        """, (query, limit))

        return cursor.fetchall()

    def phrase_search(self, phrase: str):
        """çŸ­è¯­æœç´¢"""
        cursor = self.conn.cursor()

        # ä½¿ç”¨å¼•å·è¿›è¡ŒçŸ­è¯­æœç´¢
        cursor.execute("""
            SELECT * FROM documents_fts
            WHERE documents_fts MATCH ?
        """, (f'"{phrase}"',))

        return cursor.fetchall()
```

---

## 3. æ—¥å¿—æ•°æ®ä¼˜åŒ–

### 3.1 è¿½åŠ å†™å…¥ä¼˜åŒ–

```python
class LogWriter:
    def __init__(self, db_path: str):
        self.db_path = db_path
        self.conn = sqlite3.connect(db_path)
        self.setup_optimizations()

    def setup_optimizations(self):
        """è®¾ç½®å†™å…¥ä¼˜åŒ–"""
        cursor = self.conn.cursor()

        # WALæ¨¡å¼ï¼ˆæœ€ä½³å†™å…¥æ€§èƒ½ï¼‰
        cursor.execute("PRAGMA journal_mode = WAL")

        # é™ä½åŒæ­¥çº§åˆ«ï¼ˆæé«˜å†™å…¥é€Ÿåº¦ï¼‰
        cursor.execute("PRAGMA synchronous = NORMAL")

        # å¢å¤§é¡µé¢å¤§å°
        cursor.execute("PRAGMA page_size = 4096")

        # å¢å¤§ç¼“å­˜
        cursor.execute("PRAGMA cache_size = -100000")  # 100MB

        self.conn.commit()

    def batch_write_logs(self, logs: List[Dict]):
        """æ‰¹é‡å†™å…¥æ—¥å¿—"""
        cursor = self.conn.cursor()

        # ä½¿ç”¨executemanyæ‰¹é‡æ’å…¥
        cursor.executemany("""
            INSERT INTO logs (timestamp, level, message, metadata)
            VALUES (?, ?, ?, ?)
        """, [
            (log['timestamp'], log['level'], log['message'], log.get('metadata'))
            for log in logs
        ])

        self.conn.commit()
```

### 3.2 æ—¥å¿—è½®è½¬ç­–ç•¥

```python
class LogRotator:
    def __init__(self, db_path: str, max_size_mb: int = 100):
        self.db_path = db_path
        self.max_size_mb = max_size_mb

    def should_rotate(self) -> bool:
        """æ£€æŸ¥æ˜¯å¦éœ€è¦è½®è½¬"""
        file_size = Path(self.db_path).stat().st_size
        max_size_bytes = self.max_size_mb * 1024 * 1024
        return file_size > max_size_bytes

    def rotate_logs(self):
        """è½®è½¬æ—¥å¿—"""
        if not self.should_rotate():
            return

        # å½’æ¡£æ—§æ—¥å¿—
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        archive_path = f"{self.db_path}.{timestamp}"

        shutil.move(self.db_path, archive_path)

        # åˆ›å»ºæ–°æ•°æ®åº“
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        cursor.execute("""
            CREATE TABLE logs (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                timestamp INTEGER NOT NULL,
                level TEXT NOT NULL,
                message TEXT NOT NULL,
                metadata TEXT
            )
        """)
        conn.close()
```

---

## 4. ç¼“å­˜æ•°æ®ä¼˜åŒ–

### 4.1 å†…å­˜æ•°æ®åº“

```python
class InMemoryCache:
    def __init__(self):
        self.conn = sqlite3.connect(':memory:')
        self.setup_cache()

    def setup_cache(self):
        """è®¾ç½®ç¼“å­˜è¡¨"""
        cursor = self.conn.cursor()
        cursor.execute("""
            CREATE TABLE cache (
                key TEXT PRIMARY KEY,
                value TEXT NOT NULL,
                expires_at INTEGER,
                access_count INTEGER DEFAULT 0,
                last_accessed INTEGER
            )
        """)

        cursor.execute("""
            CREATE INDEX idx_cache_expires ON cache(expires_at)
        """)

        self.conn.commit()

    def get(self, key: str):
        """è·å–ç¼“å­˜"""
        cursor = self.conn.cursor()
        cursor.execute("""
            SELECT value, expires_at FROM cache
            WHERE key = ? AND (expires_at IS NULL OR expires_at > ?)
        """, (key, int(time.time())))

        result = cursor.fetchone()
        if result:
            # æ›´æ–°è®¿é—®ç»Ÿè®¡
            cursor.execute("""
                UPDATE cache
                SET access_count = access_count + 1,
                    last_accessed = ?
                WHERE key = ?
            """, (int(time.time()), key))
            self.conn.commit()
            return result[0]
        return None

    def set(self, key: str, value: str, ttl: int = None):
        """è®¾ç½®ç¼“å­˜"""
        cursor = self.conn.cursor()
        expires_at = int(time.time()) + ttl if ttl else None

        cursor.execute("""
            INSERT OR REPLACE INTO cache (key, value, expires_at, last_accessed)
            VALUES (?, ?, ?, ?)
        """, (key, value, expires_at, int(time.time())))

        self.conn.commit()

    def evict_expired(self):
        """æ¸…ç†è¿‡æœŸç¼“å­˜"""
        cursor = self.conn.cursor()
        cursor.execute("""
            DELETE FROM cache
            WHERE expires_at IS NOT NULL AND expires_at < ?
        """, (int(time.time()),))
        self.conn.commit()
```

### 4.2 ç¼“å­˜æ·˜æ±°ç­–ç•¥

```python
class LRUCache:
    def __init__(self, max_size: int = 1000):
        self.conn = sqlite3.connect(':memory:')
        self.max_size = max_size
        self.setup_cache()

    def setup_cache(self):
        """è®¾ç½®LRUç¼“å­˜"""
        cursor = self.conn.cursor()
        cursor.execute("""
            CREATE TABLE lru_cache (
                key TEXT PRIMARY KEY,
                value TEXT NOT NULL,
                last_accessed INTEGER NOT NULL
            )
        """)

        cursor.execute("""
            CREATE INDEX idx_lru_access ON lru_cache(last_accessed)
        """)

        self.conn.commit()

    def get(self, key: str):
        """è·å–ç¼“å­˜ï¼ˆæ›´æ–°è®¿é—®æ—¶é—´ï¼‰"""
        cursor = self.conn.cursor()
        cursor.execute("""
            SELECT value FROM lru_cache WHERE key = ?
        """, (key,))

        result = cursor.fetchone()
        if result:
            # æ›´æ–°è®¿é—®æ—¶é—´
            cursor.execute("""
                UPDATE lru_cache SET last_accessed = ? WHERE key = ?
            """, (int(time.time()), key))
            self.conn.commit()
            return result[0]
        return None

    def set(self, key: str, value: str):
        """è®¾ç½®ç¼“å­˜ï¼ˆLRUæ·˜æ±°ï¼‰"""
        cursor = self.conn.cursor()

        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ·˜æ±°
        cursor.execute("SELECT COUNT(*) FROM lru_cache")
        count = cursor.fetchone()[0]

        if count >= self.max_size:
            # åˆ é™¤æœ€ä¹…æœªè®¿é—®çš„é¡¹
            cursor.execute("""
                DELETE FROM lru_cache
                WHERE key = (
                    SELECT key FROM lru_cache
                    ORDER BY last_accessed ASC
                    LIMIT 1
                )
            """)

        # æ’å…¥æˆ–æ›´æ–°
        cursor.execute("""
            INSERT OR REPLACE INTO lru_cache (key, value, last_accessed)
            VALUES (?, ?, ?)
        """, (key, value, int(time.time())))

        self.conn.commit()
```

---

## 5. åˆ†ææŸ¥è¯¢ä¼˜åŒ–

### 5.1 ç‰©åŒ–è§†å›¾

```python
class MaterializedView:
    def __init__(self, conn):
        self.conn = conn

    def create_materialized_view(self, view_name: str, query: str):
        """åˆ›å»ºç‰©åŒ–è§†å›¾"""
        cursor = self.conn.cursor()

        # åˆ›å»ºç‰©åŒ–è§†å›¾è¡¨
        cursor.execute(f"""
            CREATE TABLE IF NOT EXISTS {view_name} AS {query}
        """)

        # åˆ›å»ºç´¢å¼•
        cursor.execute(f"""
            CREATE INDEX IF NOT EXISTS idx_{view_name}_id
            ON {view_name}(id)
        """)

        self.conn.commit()

    def refresh_materialized_view(self, view_name: str, query: str):
        """åˆ·æ–°ç‰©åŒ–è§†å›¾"""
        cursor = self.conn.cursor()

        # åˆ é™¤æ—§æ•°æ®
        cursor.execute(f"DELETE FROM {view_name}")

        # é‡æ–°è®¡ç®—
        cursor.execute(f"INSERT INTO {view_name} {query}")

        self.conn.commit()
```

### 5.2 é¢„èšåˆè¡¨

```python
class PreAggregation:
    def __init__(self, conn):
        self.conn = conn

    def create_aggregation_table(self):
        """åˆ›å»ºé¢„èšåˆè¡¨"""
        cursor = self.conn.cursor()

        cursor.execute("""
            CREATE TABLE IF NOT EXISTS daily_stats (
                date TEXT PRIMARY KEY,
                total_sales REAL,
                total_orders INTEGER,
                avg_order_value REAL,
                last_updated INTEGER
            )
        """)

        self.conn.commit()

    def update_daily_stats(self, date: str):
        """æ›´æ–°æ¯æ—¥ç»Ÿè®¡"""
        cursor = self.conn.cursor()

        cursor.execute("""
            INSERT OR REPLACE INTO daily_stats
            SELECT
                date(created_at, 'unixepoch') as date,
                SUM(amount) as total_sales,
                COUNT(*) as total_orders,
                AVG(amount) as avg_order_value,
                strftime('%s', 'now') as last_updated
            FROM orders
            WHERE date(created_at, 'unixepoch') = ?
            GROUP BY date
        """, (date,))

        self.conn.commit()
```

---

## 6. æ‰¹é‡å¯¼å…¥ä¼˜åŒ–

### 6.1 æ‰¹é‡æ’å…¥ç­–ç•¥

```python
class BulkImporter:
    def __init__(self, db_path: str):
        self.db_path = db_path
        self.conn = sqlite3.connect(db_path)
        self.setup_optimizations()

    def setup_optimizations(self):
        """è®¾ç½®æ‰¹é‡å¯¼å…¥ä¼˜åŒ–"""
        cursor = self.conn.cursor()

        # WALæ¨¡å¼
        cursor.execute("PRAGMA journal_mode = WAL")

        # å…³é—­åŒæ­¥ï¼ˆæ‰¹é‡å¯¼å…¥æ—¶ï¼‰
        cursor.execute("PRAGMA synchronous = OFF")

        # å¢å¤§é¡µé¢å¤§å°
        cursor.execute("PRAGMA page_size = 65536")  # 64KB

        # å¢å¤§ç¼“å­˜
        cursor.execute("PRAGMA cache_size = -200000")  # 200MB

        # å…³é—­å¤–é”®æ£€æŸ¥
        cursor.execute("PRAGMA foreign_keys = OFF")

        self.conn.commit()

    def bulk_insert(self, table_name: str, data: List[tuple], batch_size: int = 10000):
        """æ‰¹é‡æ’å…¥"""
        cursor = self.conn.cursor()

        # å¼€å§‹äº‹åŠ¡
        cursor.execute("BEGIN TRANSACTION")

        try:
            for i in range(0, len(data), batch_size):
                batch = data[i:i+batch_size]
                placeholders = ','.join(['?'] * len(batch[0]))
                cursor.executemany(
                    f"INSERT INTO {table_name} VALUES ({placeholders})",
                    batch
                )

            cursor.execute("COMMIT")
        except Exception as e:
            cursor.execute("ROLLBACK")
            raise e

    def finish_import(self):
        """å®Œæˆå¯¼å…¥ï¼ˆæ¢å¤è®¾ç½®ï¼‰"""
        cursor = self.conn.cursor()

        # æ¢å¤åŒæ­¥
        cursor.execute("PRAGMA synchronous = NORMAL")

        # å¯ç”¨å¤–é”®æ£€æŸ¥
        cursor.execute("PRAGMA foreign_keys = ON")

        # æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        cursor.execute("ANALYZE")

        self.conn.commit()
```

### 6.2 å¯¼å…¥æ€§èƒ½ä¼˜åŒ–

```python
class OptimizedImporter(BulkImporter):
    def parallel_import(self, table_name: str, data: List[tuple], num_threads: int = 4):
        """å¹¶è¡Œå¯¼å…¥"""
        import threading

        chunk_size = len(data) // num_threads
        threads = []

        def import_chunk(chunk, thread_id):
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()
            cursor.execute("PRAGMA journal_mode = WAL")
            cursor.execute("PRAGMA synchronous = OFF")

            placeholders = ','.join(['?'] * len(chunk[0]))
            cursor.executemany(
                f"INSERT INTO {table_name} VALUES ({placeholders})",
                chunk
            )
            conn.commit()
            conn.close()

        for i in range(num_threads):
            start = i * chunk_size
            end = start + chunk_size if i < num_threads - 1 else len(data)
            chunk = data[start:end]

            thread = threading.Thread(target=import_chunk, args=(chunk, i))
            threads.append(thread)
            thread.start()

        for thread in threads:
            thread.join()
```

---

## 6.5. åœºæ™¯ä¼˜åŒ–å†³ç­–æ ‘

```text
SQLiteç‰¹å®šåœºæ™¯ä¼˜åŒ–å†³ç­–æ ‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

é—®é¢˜ï¼šå¦‚ä½•é€‰æ‹©ç‰¹å®šåœºæ™¯çš„ä¼˜åŒ–ç­–ç•¥ï¼Ÿ
    â”‚
    â”œâ”€ æ•°æ®ç‰¹å¾ï¼Ÿ
    â”‚   â”œâ”€ æ—¶é—´åºåˆ—æ•°æ® â†’ è¿›å…¥æ—¶é—´åºåˆ—ä¼˜åŒ–è·¯å¾„
    â”‚   â”œâ”€ å…¨æ–‡æœç´¢æ•°æ® â†’ è¿›å…¥å…¨æ–‡æœç´¢ä¼˜åŒ–è·¯å¾„
    â”‚   â”œâ”€ æ—¥å¿—æ•°æ® â†’ è¿›å…¥æ—¥å¿—æ•°æ®ä¼˜åŒ–è·¯å¾„
    â”‚   â”œâ”€ ç¼“å­˜æ•°æ® â†’ è¿›å…¥ç¼“å­˜æ•°æ®ä¼˜åŒ–è·¯å¾„
    â”‚   â”œâ”€ åˆ†ææŸ¥è¯¢ â†’ è¿›å…¥åˆ†ææŸ¥è¯¢ä¼˜åŒ–è·¯å¾„
    â”‚   â””â”€ æ‰¹é‡å¯¼å…¥ â†’ è¿›å…¥æ‰¹é‡å¯¼å…¥ä¼˜åŒ–è·¯å¾„
    â”‚
    â”œâ”€ æ—¶é—´åºåˆ—ä¼˜åŒ–è·¯å¾„
    â”‚   â”œâ”€ æ•°æ®é‡æ˜¯å¦å¤§ï¼ˆ>1GBï¼‰ï¼Ÿ
    â”‚   â”‚   â”œâ”€ æ˜¯ â†’ åˆ†åŒºè¡¨è®¾è®¡
    â”‚   â”‚   â”‚   â”œâ”€ æŒ‰æœˆåˆ†åŒºï¼ˆæ¨èï¼‰
    â”‚   â”‚   â”‚   â”œâ”€ æŒ‰å‘¨åˆ†åŒºï¼ˆé«˜é¢‘å†™å…¥ï¼‰
    â”‚   â”‚   â”‚   â””â”€ æŒ‰æ—¥åˆ†åŒºï¼ˆè¶…å¤§æ•°æ®é‡ï¼‰
    â”‚   â”‚   â””â”€ å¦ â†’ å•è¡¨+æ—¶é—´ç´¢å¼•
    â”‚   â”‚
    â”‚   â”œâ”€ æŸ¥è¯¢æ˜¯å¦æŒ‰æ—¶é—´èŒƒå›´ï¼Ÿ
    â”‚   â”‚   â”œâ”€ æ˜¯ â†’ æ—¶é—´ç´¢å¼•ä¼˜åŒ–
    â”‚   â”‚   â”‚   â”œâ”€ (timestamp, metric_name)å¤åˆç´¢å¼•
    â”‚   â”‚   â”‚   â”œâ”€ éƒ¨åˆ†ç´¢å¼•ï¼ˆWHERE timestamp > ?ï¼‰
    â”‚   â”‚   â”‚   â””â”€ è¦†ç›–ç´¢å¼•ï¼ˆSELECTåˆ—ï¼‰
    â”‚   â”‚   â””â”€ å¦ â†’ æ ‡å‡†ç´¢å¼•
    â”‚   â”‚
    â”‚   â””â”€ å†å²æ•°æ®æ˜¯å¦éœ€è¦å½’æ¡£ï¼Ÿ
    â”‚       â”œâ”€ æ˜¯ â†’ æ•°æ®å½’æ¡£ç­–ç•¥
    â”‚       â”‚   â”œâ”€ è‡ªåŠ¨å½’æ¡£ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
    â”‚       â”‚   â”œâ”€ å†·çƒ­åˆ†ç¦»ï¼ˆçƒ­æ•°æ®+å½’æ¡£åº“ï¼‰
    â”‚       â”‚   â””â”€ å‹ç¼©å½’æ¡£ï¼ˆèŠ‚çœç©ºé—´ï¼‰
    â”‚       â””â”€ å¦ â†’ æ— éœ€å½’æ¡£
    â”‚
    â”œâ”€ å…¨æ–‡æœç´¢ä¼˜åŒ–è·¯å¾„
    â”‚   â”œâ”€ æ˜¯å¦ä½¿ç”¨FTS5ï¼Ÿ
    â”‚   â”‚   â”œâ”€ å¦ â†’ å¯ç”¨FTS5ï¼ˆCREATE VIRTUAL TABLE ... USING fts5ï¼‰
    â”‚   â”‚   â””â”€ æ˜¯ â†’ æ£€æŸ¥FTS5é…ç½®
    â”‚   â”‚
    â”‚   â”œâ”€ FTS5é…ç½®æ˜¯å¦ä¼˜åŒ–ï¼Ÿ
    â”‚   â”‚   â”œâ”€ å¦ â†’ FTS5é…ç½®ä¼˜åŒ–
    â”‚   â”‚   â”‚   â”œâ”€ åˆ†è¯å™¨é€‰æ‹©ï¼ˆunicode61/porterï¼‰
    â”‚   â”‚   â”‚   â”œâ”€ å†…å®¹è¡¨ä¼˜åŒ–ï¼ˆcontent=ï¼‰
    â”‚   â”‚   â”‚   â””â”€ å‰ç¼€ç´¢å¼•ï¼ˆprefix=ï¼‰
    â”‚   â”‚   â””â”€ æ˜¯ â†’ æ£€æŸ¥æœç´¢æ€§èƒ½
    â”‚   â”‚
    â”‚   â””â”€ æœç´¢æ€§èƒ½æ˜¯å¦æ»¡è¶³ï¼Ÿ
    â”‚       â”œâ”€ å¦ â†’ æœç´¢æ€§èƒ½ä¼˜åŒ–
    â”‚       â”‚   â”œâ”€ ä½¿ç”¨MATCHè€ŒéLIKE
    â”‚       â”‚   â”œâ”€ é™åˆ¶ç»“æœé›†ï¼ˆLIMITï¼‰
    â”‚       â”‚   â””â”€ ç»“æœæ’åºä¼˜åŒ–ï¼ˆORDER BY rankï¼‰
    â”‚       â””â”€ æ˜¯ â†’ å…¨æ–‡æœç´¢å·²ä¼˜åŒ–
    â”‚
    â”œâ”€ æ—¥å¿—æ•°æ®ä¼˜åŒ–è·¯å¾„
    â”‚   â”œâ”€ å†™å…¥æ˜¯å¦é¢‘ç¹ï¼Ÿ
    â”‚   â”‚   â”œâ”€ æ˜¯ â†’ è¿½åŠ å†™å…¥ä¼˜åŒ–
    â”‚   â”‚   â”‚   â”œâ”€ WALæ¨¡å¼ï¼ˆå¿…éœ€ï¼‰
    â”‚   â”‚   â”‚   â”œâ”€ æ‰¹é‡å†™å…¥ï¼ˆexecutemanyï¼‰
    â”‚   â”‚   â”‚   â””â”€ å¼‚æ­¥æäº¤ï¼ˆPRAGMA synchronous=NORMALï¼‰
    â”‚   â”‚   â””â”€ å¦ â†’ æ ‡å‡†å†™å…¥
    â”‚   â”‚
    â”‚   â”œâ”€ æ–‡ä»¶æ˜¯å¦å¢é•¿è¿‡å¿«ï¼Ÿ
    â”‚   â”‚   â”œâ”€ æ˜¯ â†’ æ—¥å¿—è½®è½¬ç­–ç•¥
    â”‚   â”‚   â”‚   â”œâ”€ æŒ‰å¤§å°è½®è½¬ï¼ˆmax_sizeï¼‰
    â”‚   â”‚   â”‚   â”œâ”€ æŒ‰æ—¶é—´è½®è½¬ï¼ˆdaily/weeklyï¼‰
    â”‚   â”‚   â”‚   â””â”€ è‡ªåŠ¨å½’æ¡£ï¼ˆå‹ç¼©å­˜å‚¨ï¼‰
    â”‚   â”‚   â””â”€ å¦ â†’ æ— éœ€è½®è½¬
    â”‚   â”‚
    â”‚   â””â”€ æŸ¥è¯¢æ˜¯å¦é¢‘ç¹ï¼Ÿ
    â”‚       â”œâ”€ æ˜¯ â†’ æŸ¥è¯¢ä¼˜åŒ–
    â”‚       â”‚   â”œâ”€ æ—¶é—´èŒƒå›´ç´¢å¼•
    â”‚       â”‚   â”œâ”€ çº§åˆ«è¿‡æ»¤ç´¢å¼•
    â”‚       â”‚   â””â”€ è¦†ç›–ç´¢å¼•
    â”‚       â””â”€ å¦ â†’ å†™å…¥ä¼˜åŒ–ä¸ºä¸»
    â”‚
    â”œâ”€ ç¼“å­˜æ•°æ®ä¼˜åŒ–è·¯å¾„
    â”‚   â”œâ”€ æ•°æ®æ˜¯å¦å¯ä¸¢å¤±ï¼Ÿ
    â”‚   â”‚   â”œâ”€ æ˜¯ â†’ å†…å­˜æ•°æ®åº“
    â”‚   â”‚   â”‚   â”œâ”€ :memory:ï¼ˆä¸´æ—¶ç¼“å­˜ï¼‰
    â”‚   â”‚   â”‚   â”œâ”€ å…±äº«å†…å­˜ï¼ˆfile:?mode=memory&cache=sharedï¼‰
    â”‚   â”‚   â”‚   â””â”€ ä¸´æ—¶è¡¨ï¼ˆCREATE TEMP TABLEï¼‰
    â”‚   â”‚   â””â”€ å¦ â†’ æŒä¹…åŒ–ç¼“å­˜
    â”‚   â”‚
    â”‚   â”œâ”€ å†…å­˜æ˜¯å¦å—é™ï¼Ÿ
    â”‚   â”‚   â”œâ”€ æ˜¯ â†’ ç¼“å­˜æ·˜æ±°ç­–ç•¥
    â”‚   â”‚   â”‚   â”œâ”€ LRUæ·˜æ±°ï¼ˆåº”ç”¨å±‚å®ç°ï¼‰
    â”‚   â”‚   â”‚   â”œâ”€ TTLè¿‡æœŸï¼ˆæ—¶é—´æˆ³å­—æ®µï¼‰
    â”‚   â”‚   â”‚   â””â”€ å¤§å°é™åˆ¶ï¼ˆå®šæœŸæ¸…ç†ï¼‰
    â”‚   â”‚   â””â”€ å¦ â†’ å…¨é‡ç¼“å­˜
    â”‚   â”‚
    â”‚   â””â”€ è®¿é—®æ¨¡å¼ï¼Ÿ
    â”‚       â”œâ”€ è¯»å¤šå†™å°‘ â†’ åªè¯»ä¼˜åŒ–
    â”‚       â”‚   â”œâ”€ PRAGMA query_only=ON
    â”‚       â”‚   â””â”€ è¦†ç›–ç´¢å¼•
    â”‚       â””â”€ è¯»å†™å‡è¡¡ â†’ æ ‡å‡†ä¼˜åŒ–
    â”‚
    â”œâ”€ åˆ†ææŸ¥è¯¢ä¼˜åŒ–è·¯å¾„
    â”‚   â”œâ”€ æŸ¥è¯¢æ˜¯å¦å¤æ‚ï¼ˆå¤šè¡¨JOIN/èšåˆï¼‰ï¼Ÿ
    â”‚   â”‚   â”œâ”€ æ˜¯ â†’ ç‰©åŒ–è§†å›¾
    â”‚   â”‚   â”‚   â”œâ”€ åˆ›å»ºç‰©åŒ–è§†å›¾è¡¨
    â”‚   â”‚   â”‚   â”œâ”€ å®šæ—¶åˆ·æ–°ï¼ˆè§¦å‘å™¨/å®šæ—¶ä»»åŠ¡ï¼‰
    â”‚   â”‚   â”‚   â””â”€ æŸ¥è¯¢ç‰©åŒ–è§†å›¾
    â”‚   â”‚   â””â”€ å¦ â†’ æ£€æŸ¥é¢„èšåˆ
    â”‚   â”‚
    â”‚   â”œâ”€ æ˜¯å¦éœ€è¦å®æ—¶æ€§ï¼Ÿ
    â”‚   â”‚   â”œâ”€ å¦ â†’ é¢„èšåˆè¡¨
    â”‚   â”‚   â”‚   â”œâ”€ æŒ‰ç»´åº¦é¢„èšåˆï¼ˆGROUP BYï¼‰
    â”‚   â”‚   â”‚   â”œâ”€ å¢é‡æ›´æ–°ï¼ˆè§¦å‘å™¨ï¼‰
    â”‚   â”‚   â”‚   â””â”€ æŸ¥è¯¢é¢„èšåˆè¡¨
    â”‚   â”‚   â””â”€ æ˜¯ â†’ å®æ—¶æŸ¥è¯¢ä¼˜åŒ–
    â”‚   â”‚
    â”‚   â””â”€ æ•°æ®é‡æ˜¯å¦å¤§ï¼Ÿ
    â”‚       â”œâ”€ æ˜¯ â†’ åˆ—å­˜å‚¨æ¨¡æ‹Ÿ
    â”‚       â”‚   â”œâ”€ å‚ç›´åˆ†åŒº
    â”‚       â”‚   â”œâ”€ åˆ—å¼ç‰©åŒ–è§†å›¾
    â”‚       â”‚   â””â”€ åˆ—å‹ç¼©å­˜å‚¨
    â”‚       â””â”€ å¦ â†’ æ ‡å‡†ä¼˜åŒ–
    â”‚
    â””â”€ æ‰¹é‡å¯¼å…¥ä¼˜åŒ–è·¯å¾„
        â”œâ”€ å¯¼å…¥æ•°æ®é‡ï¼Ÿ
        â”‚   â”œâ”€ å°é‡ï¼ˆ<10ä¸‡ï¼‰ â†’ æ ‡å‡†æ‰¹é‡äº‹åŠ¡
        â”‚   â”œâ”€ ä¸­é‡ï¼ˆ10ä¸‡-100ä¸‡ï¼‰ â†’ æ‰¹é‡äº‹åŠ¡+é¢„ç¼–è¯‘
        â”‚   â””â”€ å¤§é‡ï¼ˆ>100ä¸‡ï¼‰ â†’ æ‰¹é‡å¯¼å…¥ä¼˜åŒ–
        â”‚
        â”œâ”€ æ‰¹é‡å¯¼å…¥ä¼˜åŒ–ç­–ç•¥
        â”‚   â”œâ”€ ç¦ç”¨ç´¢å¼•ï¼ˆå¯¼å…¥æ—¶ï¼‰
        â”‚   â”‚   â”œâ”€ åˆ é™¤ç´¢å¼•
        â”‚   â”‚   â”œâ”€ å¯¼å…¥æ•°æ®
        â”‚   â”‚   â””â”€ é‡å»ºç´¢å¼•
        â”‚   â”œâ”€ è°ƒæ•´PRAGMA
        â”‚   â”‚   â”œâ”€ synchronous=OFF
        â”‚   â”‚   â”œâ”€ journal_mode=OFF
        â”‚   â”‚   â””â”€ cache_sizeå¢å¤§
        â”‚   â””â”€ åˆ†æ‰¹å¯¼å…¥
        â”‚       â”œâ”€ æ¯æ‰¹10ä¸‡æ¡
        â”‚       â””â”€ æ¯æ‰¹æäº¤ä¸€æ¬¡
        â”‚
        â””â”€ å¯¼å…¥åä¼˜åŒ–
            â”œâ”€ ANALYZEï¼ˆæ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼‰
            â”œâ”€ VACUUMï¼ˆæ•´ç†ç¢ç‰‡ï¼‰
            â””â”€ REINDEXï¼ˆé‡å»ºç´¢å¼•ï¼‰

åœºæ™¯ä¼˜åŒ–ä¼˜å…ˆçº§:
1. æ—¶é—´åºåˆ—ï¼šåˆ†åŒºè¡¨ > æ—¶é—´ç´¢å¼• > æ•°æ®å½’æ¡£
2. å…¨æ–‡æœç´¢ï¼šFTS5é…ç½® > æœç´¢ä¼˜åŒ– > ç´¢å¼•ä¼˜åŒ–
3. æ—¥å¿—æ•°æ®ï¼šWALæ¨¡å¼ > æ‰¹é‡å†™å…¥ > æ—¥å¿—è½®è½¬
4. ç¼“å­˜æ•°æ®ï¼šå†…å­˜æ•°æ®åº“ > æ·˜æ±°ç­–ç•¥ > è®¿é—®ä¼˜åŒ–
5. åˆ†ææŸ¥è¯¢ï¼šç‰©åŒ–è§†å›¾ > é¢„èšåˆ > åˆ—å­˜å‚¨æ¨¡æ‹Ÿ
6. æ‰¹é‡å¯¼å…¥ï¼šæ‰¹é‡äº‹åŠ¡ > PRAGMAä¼˜åŒ– > åˆ†æ‰¹å¯¼å…¥

ä¼˜åŒ–æ•ˆæœé¢„æœŸ:
â€¢ æ—¶é—´åºåˆ—ï¼š10-100å€æ€§èƒ½æå‡
â€¢ å…¨æ–‡æœç´¢ï¼š5-20å€æ€§èƒ½æå‡
â€¢ æ—¥å¿—æ•°æ®ï¼š50-200å€æ€§èƒ½æå‡
â€¢ ç¼“å­˜æ•°æ®ï¼š100-1000å€æ€§èƒ½æå‡
â€¢ åˆ†ææŸ¥è¯¢ï¼š10-50å€æ€§èƒ½æå‡
â€¢ æ‰¹é‡å¯¼å…¥ï¼š100-1000å€æ€§èƒ½æå‡
```

---

## 6.6. åœºæ™¯ä¼˜åŒ–è®ºè¯è„‰ç»œ

### 6.6.1. è®ºè¯ç›®æ ‡

**ç›®æ ‡é™ˆè¿°**ï¼š

- è¯æ˜ç‰¹å®šåœºæ™¯ä¼˜åŒ–ç­–ç•¥çš„æœ‰æ•ˆæ€§
- è¯æ˜åœºæ™¯ä¼˜åŒ–å¸¦æ¥çš„æ€§èƒ½æå‡
- è¯æ˜ä¼˜åŒ–ç­–ç•¥é€‰æ‹©çš„æ­£ç¡®æ€§

**è®ºè¯èŒƒå›´**ï¼š

- æ—¶é—´åºåˆ—æ•°æ®ä¼˜åŒ–
- å…¨æ–‡æœç´¢ä¼˜åŒ–
- æ—¥å¿—æ•°æ®ä¼˜åŒ–
- ç¼“å­˜æ•°æ®ä¼˜åŒ–
- åˆ†ææŸ¥è¯¢ä¼˜åŒ–
- æ‰¹é‡å¯¼å…¥ä¼˜åŒ–

### 6.6.2. è®ºè¯é“¾æ¡

**æ—¶é—´åºåˆ—ä¼˜åŒ–è®ºè¯é“¾**ï¼š

```text
å‰æ: æ—¶é—´åºåˆ—æ•°æ®é‡å¤§ï¼ŒæŸ¥è¯¢æŒ‰æ—¶é—´èŒƒå›´
  â†“
åŸºç¡€: åˆ†åŒºè¡¨å‡å°‘æ‰«æèŒƒå›´ (æ•°æ®åˆ†åŒºç†è®º)
  â†“
åº”ç”¨: æ—¶é—´ç´¢å¼•åŠ é€ŸæŸ¥è¯¢ (ç´¢å¼•ä¼˜åŒ–ç†è®º)
  â†“
ç»“è®º: æ—¶é—´åºåˆ—ä¼˜åŒ–æœ‰æ•ˆ âœ…
```

**å…¨æ–‡æœç´¢ä¼˜åŒ–è®ºè¯é“¾**ï¼š

```text
å‰æ: å…¨æ–‡æœç´¢éœ€è¦å¿«é€ŸåŒ¹é…
  â†“
åŸºç¡€: FTS5å€’æ’ç´¢å¼•ç»“æ„ (ä¿¡æ¯æ£€ç´¢ç†è®º)
  â†“
åº”ç”¨: FTS5æœç´¢æ€§èƒ½æå‡ (A1: ç´¢å¼•åŠ é€ŸæŸ¥è¯¢)
  â†“
ç»“è®º: FTS5ä¼˜åŒ–æœ‰æ•ˆ âœ…
```

**æ‰¹é‡å¯¼å…¥ä¼˜åŒ–è®ºè¯é“¾**ï¼š

```text
å‰æ: æ‰¹é‡å¯¼å…¥æ•°æ®é‡å¤§
  â†“
åŸºç¡€: æ‰¹é‡äº‹åŠ¡å‡å°‘å¼€é”€ (æ‰¹é‡æ“ä½œç†è®º)
  â†“
åº”ç”¨: æ‰¹é‡å¯¼å…¥æ€§èƒ½æå‡ (A3: æ‰¹é‡æ’å…¥ä¼˜åŒ–)
  â†“
ç»“è®º: æ‰¹é‡å¯¼å…¥ä¼˜åŒ–æœ‰æ•ˆ âœ…
```

### 6.6.3. å…³é”®è®ºè¯æ­¥éª¤

**æ­¥éª¤1: æ—¶é—´åºåˆ—åˆ†åŒºä¼˜åŒ–è®ºè¯**:

- **å‰æ**: 100GBæ—¶é—´åºåˆ—æ•°æ®ï¼ŒæŸ¥è¯¢æœ€è¿‘1ä¸ªæœˆ
- **æ¨ç†**: æ— åˆ†åŒºéœ€è¦æ‰«æ100GBï¼ŒæŒ‰æœˆåˆ†åŒºåªéœ€æ‰«æ8GBï¼ˆ1/12ï¼‰
- **ç»“è®º**: åˆ†åŒºä¼˜åŒ–å¸¦æ¥12å€æ€§èƒ½æå‡ âœ…

**æ­¥éª¤2: FTS5å…¨æ–‡æœç´¢ä¼˜åŒ–è®ºè¯**:

- **å‰æ**: LIKEæŸ¥è¯¢éœ€è¦å…¨è¡¨æ‰«æO(n)ï¼ŒFTS5ä½¿ç”¨å€’æ’ç´¢å¼•O(log n)
- **æ¨ç†**: 100ä¸‡æ¡è®°å½•ï¼ŒLIKEæŸ¥è¯¢å¹³å‡500msï¼ŒFTS5æŸ¥è¯¢å¹³å‡0.1ms
- **ç»“è®º**: FTS5ä¼˜åŒ–å¸¦æ¥5000å€æ€§èƒ½æå‡ âœ…

**æ­¥éª¤3: æ‰¹é‡å¯¼å…¥ä¼˜åŒ–è®ºè¯**:

- **å‰æ**: å•æ¡å¯¼å…¥éœ€è¦äº‹åŠ¡å¼€é”€ï¼Œæ‰¹é‡å¯¼å…¥å…±äº«äº‹åŠ¡å¼€é”€
- **æ¨ç†**: 100ä¸‡æ¡å¯¼å…¥ï¼Œå•æ¡æ¨¡å¼100ä¸‡æ¬¡äº‹åŠ¡ï¼Œæ‰¹é‡æ¨¡å¼1æ¬¡äº‹åŠ¡
- **ç»“è®º**: æ‰¹é‡å¯¼å…¥å‡å°‘100ä¸‡å€äº‹åŠ¡å¼€é”€ âœ…

### 6.6.4. æ­£åä¾‹è¯æ˜

**æ­£ä¾‹ï¼šæ—¶é—´åºåˆ—åˆ†åŒºä¼˜åŒ–**:

- **åœºæ™¯**: 1å¹´æ—¶é—´åºåˆ—æ•°æ®ï¼ŒæŸ¥è¯¢æœ€è¿‘1ä¸ªæœˆ
- **æ“ä½œ**:
  - æ— åˆ†åŒº: SELECT * FROM metrics WHERE timestamp > ? (å…¨è¡¨æ‰«æ)
  - æœ‰åˆ†åŒº: SELECT * FROM metrics_202501 WHERE timestamp > ? (åˆ†åŒºæ‰«æ)
- **ç»“æœ**:
  - æ— åˆ†åŒº: æ‰«æ12ä¸ªæœˆæ•°æ®ï¼Œè€—æ—¶12ç§’
  - æœ‰åˆ†åŒº: æ‰«æ1ä¸ªæœˆæ•°æ®ï¼Œè€—æ—¶1ç§’
  - æ€§èƒ½æå‡: 12å€
- **éªŒè¯**: âœ… åˆ†åŒºä¼˜åŒ–æœ‰æ•ˆ

**åä¾‹ï¼šæ— åˆ†åŒºçš„æ—¶é—´åºåˆ—æŸ¥è¯¢æ…¢**:

- **åœºæ™¯**: å¤§é‡æ—¶é—´åºåˆ—æ•°æ®ï¼Œæ— åˆ†åŒºè®¾è®¡
- **æ“ä½œ**: æŸ¥è¯¢æœ€è¿‘æ•°æ®éœ€è¦æ‰«æå…¨éƒ¨å†å²æ•°æ®
- **ç»“æœ**: æŸ¥è¯¢æ—¶é—´éšæ•°æ®é‡çº¿æ€§å¢é•¿ï¼Œæ— æ³•æ¥å—
- **é—®é¢˜**: æŸ¥è¯¢æ€§èƒ½å·®ï¼Œæ— æ³•æ‰©å±•
- **ç»“è®º**: âŒ è¯´æ˜åˆ†åŒºä¼˜åŒ–çš„å¿…è¦æ€§

**æ­£ä¾‹ï¼šFTS5å…¨æ–‡æœç´¢é«˜æ•ˆ**:

- **åœºæ™¯**: 100ä¸‡æ¡æ–‡æ¡£ï¼Œå…¨æ–‡æœç´¢å…³é”®è¯
- **æ“ä½œ**:
  - LIKEæ¨¡å¼: SELECT * FROM docs WHERE content LIKE '%keyword%'
  - FTS5æ¨¡å¼: SELECT * FROM docs_fts WHERE docs_fts MATCH 'keyword'
- **ç»“æœ**:
  - LIKEæ¨¡å¼: å…¨è¡¨æ‰«æï¼Œå¹³å‡500ms
  - FTS5æ¨¡å¼: å€’æ’ç´¢å¼•ï¼Œå¹³å‡0.1ms
  - æ€§èƒ½æå‡: 5000å€
- **éªŒè¯**: âœ… FTS5ä¼˜åŒ–æœ‰æ•ˆ

**åä¾‹ï¼šLIKEå…¨æ–‡æœç´¢æ€§èƒ½å·®**:

- **åœºæ™¯**: å¤§é‡æ–‡æœ¬æ•°æ®ï¼Œä½¿ç”¨LIKEè¿›è¡Œå…¨æ–‡æœç´¢
- **æ“ä½œ**: SELECT * FROM docs WHERE content LIKE '%keyword%'
- **ç»“æœ**: æ¯æ¬¡æŸ¥è¯¢å…¨è¡¨æ‰«æï¼Œæ€§èƒ½éšæ•°æ®é‡çº¿æ€§ä¸‹é™
- **é—®é¢˜**: æœç´¢æ€§èƒ½å·®ï¼Œæ— æ³•æ¥å—
- **ç»“è®º**: âŒ è¯´æ˜FTS5ä¼˜åŒ–çš„å¿…è¦æ€§

---

## 7. ğŸ”— ç›¸å…³èµ„æº

### å†…éƒ¨èµ„æº

- [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](./03.02-ä¼˜åŒ–ç­–ç•¥.md) - é€šç”¨ä¼˜åŒ–ç­–ç•¥ï¼ˆå«è®ºè¯è„‰ç»œï¼‰
- [æ€§èƒ½ç‰¹å¾åˆ†æ](./03.01-æ€§èƒ½ç‰¹å¾åˆ†æ.md) - æ€§èƒ½ç‰¹å¾åˆ†æï¼ˆå«å†³ç­–æ ‘ï¼‰
- [æŸ¥è¯¢ä¼˜åŒ–](../08-ç¼–ç¨‹å®è·µ/08.03-æŸ¥è¯¢ä¼˜åŒ–.md) - æŸ¥è¯¢ä¼˜åŒ–å®è·µ

### å¤–éƒ¨èµ„æº

- [SQLiteæ€§èƒ½ä¼˜åŒ–](https://www.sqlite.org/performance.html) - å®˜æ–¹æ€§èƒ½æ–‡æ¡£
- [FTS5æ–‡æ¡£](https://www.sqlite.org/fts5.html) - FTS5å…¨æ–‡æœç´¢

---

## 8. ğŸ”— äº¤å‰å¼•ç”¨

### 8.1. æ€§èƒ½ä¼˜åŒ–æ–‡æ¡£

- â­â­â­ [æ€§èƒ½ç‰¹å¾åˆ†æ](./03.01-æ€§èƒ½ç‰¹å¾åˆ†æ.md) - æ€§èƒ½åˆ†æåŸºç¡€ï¼ˆå«å†³ç­–æ ‘ï¼‰
- â­â­â­ [ä¼˜åŒ–ç­–ç•¥](./03.02-ä¼˜åŒ–ç­–ç•¥.md) - é€šç”¨ä¼˜åŒ–ç­–ç•¥ï¼ˆå«è®ºè¯è„‰ç»œå’Œå†³ç­–æ ‘ï¼‰
- â­â­ [æŸ¥è¯¢ä¼˜åŒ–](../08-ç¼–ç¨‹å®è·µ/08.03-æŸ¥è¯¢ä¼˜åŒ–.md) - æŸ¥è¯¢ä¼˜åŒ–å®è·µ

### 8.2. æ ¸å¿ƒæ¶æ„æ–‡æ¡£

- â­â­â­ [å­˜å‚¨å¼•æ“](../01-æ ¸å¿ƒæ¶æ„/01.03-å­˜å‚¨å¼•æ“.md) - å­˜å‚¨ä¼˜åŒ–åŸºç¡€ï¼ˆå«è®ºè¯è„‰ç»œï¼‰
- â­â­ [äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶](../01-æ ¸å¿ƒæ¶æ„/01.02-äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶.md) - å¹¶å‘æ€§èƒ½åŸºç¡€

### 8.3. å½¢å¼åŒ–ç†è®º ğŸ†•

- â­â­â­ [å½¢å¼åŒ–è®ºè¯æ¡†æ¶æ€»è§ˆ](../06-å½¢å¼åŒ–ç†è®º/06.05-SQLiteå½¢å¼åŒ–è®ºè¯æ¡†æ¶æ€»è§ˆ.md) - äº”å±‚å½¢å¼åŒ–ä½“ç³»
- â­â­ [å®šç†ä¾èµ–å…³ç³»å›¾è°±](../06-å½¢å¼åŒ–ç†è®º/06.06-SQLiteå®šç†ä¾èµ–å…³ç³»å›¾è°±.md) - ä¼˜åŒ–ç›¸å…³å®šç†

### 8.4. çŸ¥è¯†å›¾è°±ä¸å¯¼èˆª ğŸ†•

- â­â­â­ [çŸ¥è¯†å›¾è°±ä¸æ¦‚å¿µå…³ç³»ç½‘ç»œ](../09-æœ€æ–°ç‰¹æ€§/09.03-SQLiteçŸ¥è¯†å›¾è°±ä¸æ¦‚å¿µå…³ç³»ç½‘ç»œ.md) - åœºæ™¯ä¼˜åŒ–æ¦‚å¿µå…³ç³»
- â­â­ [æ–‡æ¡£ä¾èµ–å…³ç³»å›¾](../00-é¡¹ç›®å¯¼èˆª/06-æ–‡æ¡£ä¾èµ–å…³ç³»å›¾.md) - åœºæ™¯ä¼˜åŒ–æ–‡æ¡£ä¾èµ–
- â­â­ [æœ¯è¯­æ ‡å‡†åŒ–è¯å…¸](../00-é¡¹ç›®å¯¼èˆª/03-æœ¯è¯­è¯å…¸/SQLiteæœ¯è¯­æ ‡å‡†åŒ–è¯å…¸.md) - åœºæ™¯ä¼˜åŒ–æœ¯è¯­ç´¢å¼•

### 8.5. ç›¸å…³æ¦‚å¿µé“¾æ¥ ğŸ†•

#### 8.5.1. åœºæ™¯ä¼˜åŒ–æ¦‚å¿µ

- **æ—¶é—´åºåˆ—ä¼˜åŒ–** â†’ [çŸ¥è¯†å›¾è°±ï¼šæ—¶é—´åºåˆ—æ¦‚å¿µ](../09-æœ€æ–°ç‰¹æ€§/09.03-SQLiteçŸ¥è¯†å›¾è°±ä¸æ¦‚å¿µå…³ç³»ç½‘ç»œ.md#åº”ç”¨åœºæ™¯æœ¬ä½“)
- **å…¨æ–‡æœç´¢ä¼˜åŒ–** â†’ [çŸ¥è¯†å›¾è°±ï¼šFTS5æ¦‚å¿µ](../09-æœ€æ–°ç‰¹æ€§/09.03-SQLiteçŸ¥è¯†å›¾è°±ä¸æ¦‚å¿µå…³ç³»ç½‘ç»œ.md#åº”ç”¨åœºæ™¯æœ¬ä½“)
- **æ‰¹é‡å¯¼å…¥ä¼˜åŒ–** â†’ [å®šç†ï¼šA3-æ‰¹é‡æ’å…¥ä¼˜åŒ–](../06-å½¢å¼åŒ–ç†è®º/06.06-SQLiteå®šç†ä¾èµ–å…³ç³»å›¾è°±.md#a3-æ‰¹é‡æ’å…¥ä¼˜åŒ–)

#### 8.5.2. åœºæ™¯ä¼˜åŒ–è·¯å¾„

- **åœºæ™¯ä¼˜åŒ–å†³ç­–æ ‘** â†’ [åœºæ™¯ä¼˜åŒ–å†³ç­–æ ‘](./03.05-SQLiteç‰¹å®šåœºæ™¯æ·±åº¦ä¼˜åŒ–.md#65-åœºæ™¯ä¼˜åŒ–å†³ç­–æ ‘)
- **åœºæ™¯ä¼˜åŒ–è®ºè¯è„‰ç»œ** â†’ [åœºæ™¯ä¼˜åŒ–è®ºè¯è„‰ç»œ](./03.05-SQLiteç‰¹å®šåœºæ™¯æ·±åº¦ä¼˜åŒ–.md#66-åœºæ™¯ä¼˜åŒ–è®ºè¯è„‰ç»œ)

---

**æœ€åæ›´æ–°**: 2025-12-05
**ç»´æŠ¤è€…**: Data-Science Team
