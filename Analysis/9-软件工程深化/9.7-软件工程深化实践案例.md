# è½¯ä»¶å·¥ç¨‹æ·±åŒ–å®è·µæ¡ˆä¾‹

## ğŸ“‘ ç›®å½•

- [è½¯ä»¶å·¥ç¨‹æ·±åŒ–å®è·µæ¡ˆä¾‹](#è½¯ä»¶å·¥ç¨‹æ·±åŒ–å®è·µæ¡ˆä¾‹)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. è®¾è®¡æ¨¡å¼å®è·µæ¡ˆä¾‹](#1-è®¾è®¡æ¨¡å¼å®è·µæ¡ˆä¾‹)
    - [1.1. åˆ›å»ºå‹æ¨¡å¼å®è·µ](#11-åˆ›å»ºå‹æ¨¡å¼å®è·µ)
  - [2. ç»“æ„å‹æ¨¡å¼å®è·µ](#2-ç»“æ„å‹æ¨¡å¼å®è·µ)
  - [3. è¡Œä¸ºå‹æ¨¡å¼å®è·µ](#3-è¡Œä¸ºå‹æ¨¡å¼å®è·µ)
  - [4. å¾®æœåŠ¡æ¶æ„å®è·µæ¡ˆä¾‹](#4-å¾®æœåŠ¡æ¶æ„å®è·µæ¡ˆä¾‹)
    - [4.1. æœåŠ¡æ³¨å†Œä¸å‘ç°](#41-æœåŠ¡æ³¨å†Œä¸å‘ç°)
  - [5. ç†”æ–­å™¨æ¨¡å¼](#5-ç†”æ–­å™¨æ¨¡å¼)
  - [6. ç»„ä»¶æ¶æ„å®è·µæ¡ˆä¾‹](#6-ç»„ä»¶æ¶æ„å®è·µæ¡ˆä¾‹)
    - [6.1. æ’ä»¶åŒ–æ¶æ„](#61-æ’ä»¶åŒ–æ¶æ„)
  - [7. äº‹ä»¶é©±åŠ¨æ¶æ„](#7-äº‹ä»¶é©±åŠ¨æ¶æ„)
  - [8. å·¥ä½œæµå¼•æ“å®è·µæ¡ˆä¾‹](#8-å·¥ä½œæµå¼•æ“å®è·µæ¡ˆä¾‹)
    - [8.1. ç®€å•å·¥ä½œæµå¼•æ“](#81-ç®€å•å·¥ä½œæµå¼•æ“)

---


## 1. è®¾è®¡æ¨¡å¼å®è·µæ¡ˆä¾‹

### 1.1. åˆ›å»ºå‹æ¨¡å¼å®è·µ

```python
# æŠ½è±¡å·¥å‚æ¨¡å¼ - è·¨å¹³å°UIç»„ä»¶
from abc import ABC, abstractmethod

class Button(ABC):
    @abstractmethod
    def render(self):
        pass

class TextBox(ABC):
    @abstractmethod
    def render(self):
        pass

class WindowsButton(Button):
    def render(self):
        return "Windowsé£æ ¼æŒ‰é’®"

class WindowsTextBox(TextBox):
    def render(self):
        return "Windowsé£æ ¼æ–‡æœ¬æ¡†"

class MacButton(Button):
    def render(self):
        return "Macé£æ ¼æŒ‰é’®"

class MacTextBox(TextBox):
    def render(self):
        return "Macé£æ ¼æ–‡æœ¬æ¡†"

class UIFactory(ABC):
    @abstractmethod
    def create_button(self) -> Button:
        pass

    @abstractmethod
    def create_textbox(self) -> TextBox:
        pass

class WindowsUIFactory(UIFactory):
    def create_button(self) -> Button:
        return WindowsButton()

    def create_textbox(self) -> TextBox:
        return WindowsTextBox()

class MacUIFactory(UIFactory):
    def create_button(self) -> Button:
        return MacButton()

    def create_textbox(self) -> TextBox:
        return MacTextBox()

# ä½¿ç”¨ç¤ºä¾‹
def create_ui(factory: UIFactory):
    button = factory.create_button()
    textbox = factory.create_textbox()
    print(f"æŒ‰é’®: {button.render()}")
    print(f"æ–‡æœ¬æ¡†: {textbox.render()}")

# æµ‹è¯•
print("Windows UI:")
create_ui(WindowsUIFactory())
print("\nMac UI:")
create_ui(MacUIFactory())
```

## 2. ç»“æ„å‹æ¨¡å¼å®è·µ

```python
# è£…é¥°å™¨æ¨¡å¼ - å’–å•¡è®¢å•ç³»ç»Ÿ
class Coffee:
    def cost(self):
        return 10

    def description(self):
        return "ç®€å•å’–å•¡"

class CoffeeDecorator(Coffee):
    def __init__(self, coffee):
        self._coffee = coffee

    def cost(self):
        return self._coffee.cost()

    def description(self):
        return self._coffee.description()

class Milk(CoffeeDecorator):
    def cost(self):
        return self._coffee.cost() + 2

    def description(self):
        return self._coffee.description() + ", ç‰›å¥¶"

class Sugar(CoffeeDecorator):
    def cost(self):
        return self._coffee.cost() + 1

    def description(self):
        return self._coffee.description() + ", ç³–"

class Whip(CoffeeDecorator):
    def cost(self):
        return self._coffee.cost() + 3

    def description(self):
        return self._coffee.description() + ", å¥¶æ²¹"

# ä½¿ç”¨ç¤ºä¾‹
coffee = Coffee()
print(f"åŸºç¡€å’–å•¡: {coffee.description()}, ä»·æ ¼: ${coffee.cost()}")

coffee_with_milk = Milk(coffee)
print(f"åŠ ç‰›å¥¶: {coffee_with_milk.description()}, ä»·æ ¼: ${coffee_with_milk.cost()}")

coffee_with_milk_sugar = Sugar(coffee_with_milk)
print(f"åŠ ç‰›å¥¶å’Œç³–: {coffee_with_milk_sugar.description()}, ä»·æ ¼: ${coffee_with_milk_sugar.cost()}")

coffee_complete = Whip(coffee_with_milk_sugar)
print(f"å®Œæ•´å’–å•¡: {coffee_complete.description()}, ä»·æ ¼: ${coffee_complete.cost()}")
```

## 3. è¡Œä¸ºå‹æ¨¡å¼å®è·µ

```python
# è§‚å¯Ÿè€…æ¨¡å¼ - è‚¡ç¥¨ä»·æ ¼ç›‘æ§ç³»ç»Ÿ
from abc import ABC, abstractmethod
from typing import List

class Observer(ABC):
    @abstractmethod
    def update(self, price: float):
        pass

class Subject(ABC):
    @abstractmethod
    def attach(self, observer: Observer):
        pass

    @abstractmethod
    def detach(self, observer: Observer):
        pass

    @abstractmethod
    def notify(self):
        pass

class StockPrice(Subject):
    def __init__(self, symbol: str, price: float):
        self._symbol = symbol
        self._price = price
        self._observers: List[Observer] = []

    def attach(self, observer: Observer):
        self._observers.append(observer)

    def detach(self, observer: Observer):
        self._observers.remove(observer)

    def notify(self):
        for observer in self._observers:
            observer.update(self._price)

    def set_price(self, price: float):
        self._price = price
        self.notify()

    def get_price(self):
        return self._price

class PriceAlert(Observer):
    def __init__(self, name: str, threshold: float):
        self._name = name
        self._threshold = threshold

    def update(self, price: float):
        if price > self._threshold:
            print(f"{self._name}: ä»·æ ¼ ${price} è¶…è¿‡é˜ˆå€¼ ${self._threshold}")

class PriceLogger(Observer):
    def update(self, price: float):
        print(f"ä»·æ ¼æ›´æ–°: ${price}")

# ä½¿ç”¨ç¤ºä¾‹
stock = StockPrice("AAPL", 150.0)
alert1 = PriceAlert("é«˜é£é™©è­¦æŠ¥", 160.0)
alert2 = PriceAlert("ä½é£é™©è­¦æŠ¥", 155.0)
logger = PriceLogger()

stock.attach(alert1)
stock.attach(alert2)
stock.attach(logger)

print("åˆå§‹ä»·æ ¼: $150")
stock.set_price(155.0)
stock.set_price(165.0)
```

## 4. å¾®æœåŠ¡æ¶æ„å®è·µæ¡ˆä¾‹

### 4.1. æœåŠ¡æ³¨å†Œä¸å‘ç°

```python
# æœåŠ¡æ³¨å†Œä¸­å¿ƒ
import json
import time
from typing import Dict, List

class ServiceRegistry:
    def __init__(self):
        self._services: Dict[str, List[dict]] = {}

    def register(self, service_name: str, host: str, port: int, health_check_url: str):
        service_info = {
            'host': host,
            'port': port,
            'health_check_url': health_check_url,
            'registered_at': time.time(),
            'last_heartbeat': time.time()
        }

        if service_name not in self._services:
            self._services[service_name] = []

        self._services[service_name].append(service_info)
        print(f"æœåŠ¡ {service_name} æ³¨å†ŒæˆåŠŸ: {host}:{port}")

    def deregister(self, service_name: str, host: str, port: int):
        if service_name in self._services:
            self._services[service_name] = [
                s for s in self._services[service_name]
                if not (s['host'] == host and s['port'] == port)
            ]
            print(f"æœåŠ¡ {service_name} æ³¨é”€æˆåŠŸ: {host}:{port}")

    def get_services(self, service_name: str) -> List[dict]:
        return self._services.get(service_name, [])

    def heartbeat(self, service_name: str, host: str, port: int):
        for service in self._services.get(service_name, []):
            if service['host'] == host and service['port'] == port:
                service['last_heartbeat'] = time.time()
                break

# æœåŠ¡å‘ç°å®¢æˆ·ç«¯
class ServiceDiscovery:
    def __init__(self, registry: ServiceRegistry):
        self._registry = registry

    def discover_service(self, service_name: str) -> dict:
        services = self._registry.get_services(service_name)
        if not services:
            raise Exception(f"æœåŠ¡ {service_name} ä¸å¯ç”¨")

# ç®€å•çš„è´Ÿè½½å‡è¡¡ - è½®è¯¢
        service = services[0]  # ç®€åŒ–ç‰ˆæœ¬
        return service

    def get_service_url(self, service_name: str) -> str:
        service = self.discover_service(service_name)
        return f"http://{service['host']}:{service['port']}"

# ä½¿ç”¨ç¤ºä¾‹
registry = ServiceRegistry()
discovery = ServiceDiscovery(registry)

# æ³¨å†ŒæœåŠ¡
registry.register("user-service", "localhost", 8081, "/health")
registry.register("user-service", "localhost", 8082, "/health")
registry.register("order-service", "localhost", 8083, "/health")

# æœåŠ¡å‘ç°
try:
    user_service_url = discovery.get_service_url("user-service")
    print(f"å‘ç°ç”¨æˆ·æœåŠ¡: {user_service_url}")
except Exception as e:
    print(f"æœåŠ¡å‘ç°å¤±è´¥: {e}")
```

## 5. ç†”æ–­å™¨æ¨¡å¼

```python
# ç†”æ–­å™¨å®ç°
import time
from enum import Enum
from typing import Callable, Any

class CircuitState(Enum):
    CLOSED = "CLOSED"      # æ­£å¸¸çŠ¶æ€
    OPEN = "OPEN"         # ç†”æ–­çŠ¶æ€
    HALF_OPEN = "HALF_OPEN"  # åŠå¼€çŠ¶æ€

class CircuitBreaker:
    def __init__(self, failure_threshold: int = 5, recovery_timeout: int = 60):
        self.failure_threshold = failure_threshold
        self.recovery_timeout = recovery_timeout
        self.failure_count = 0
        self.last_failure_time = 0
        self.state = CircuitState.CLOSED

    def call(self, func: Callable, *args, **kwargs) -> Any:
        if self.state == CircuitState.OPEN:
            if time.time() - self.last_failure_time > self.recovery_timeout:
                self.state = CircuitState.HALF_OPEN
                print("ç†”æ–­å™¨è¿›å…¥åŠå¼€çŠ¶æ€")
            else:
                raise Exception("ç†”æ–­å™¨å¼€å¯ï¼ŒæœåŠ¡ä¸å¯ç”¨")

        try:
            result = func(*args, **kwargs)
            self._on_success()
            return result
        except Exception as e:
            self._on_failure()
            raise e

    def _on_success(self):
        self.failure_count = 0
        self.state = CircuitState.CLOSED
        print("è°ƒç”¨æˆåŠŸï¼Œç†”æ–­å™¨å…³é—­")

    def _on_failure(self):
        self.failure_count += 1
        self.last_failure_time = time.time()

        if self.failure_count >= self.failure_threshold:
            self.state = CircuitState.OPEN
            print(f"å¤±è´¥æ¬¡æ•°è¾¾åˆ°é˜ˆå€¼ {self.failure_threshold}ï¼Œç†”æ–­å™¨å¼€å¯")

# æ¨¡æ‹ŸæœåŠ¡è°ƒç”¨
def unreliable_service(success_rate: float = 0.3):
    import random
    if random.random() > success_rate:
        raise Exception("æœåŠ¡è°ƒç”¨å¤±è´¥")
    return "æœåŠ¡è°ƒç”¨æˆåŠŸ"

# ä½¿ç”¨ç¤ºä¾‹
breaker = CircuitBreaker(failure_threshold=3, recovery_timeout=10)

for i in range(10):
    try:
        result = breaker.call(unreliable_service, 0.3)
        print(f"è°ƒç”¨ {i+1}: {result}")
    except Exception as e:
        print(f"è°ƒç”¨ {i+1}: {e}")
    time.sleep(1)
```

## 6. ç»„ä»¶æ¶æ„å®è·µæ¡ˆä¾‹

### 6.1. æ’ä»¶åŒ–æ¶æ„

```python
# æ’ä»¶ç®¡ç†å™¨
from abc import ABC, abstractmethod
from typing import Dict, Type
import importlib

class Plugin(ABC):
    @abstractmethod
    def name(self) -> str:
        pass

    @abstractmethod
    def execute(self, data: str) -> str:
        pass

class PluginManager:
    def __init__(self):
        self._plugins: Dict[str, Plugin] = {}

    def register_plugin(self, plugin: Plugin):
        self._plugins[plugin.name()] = plugin
        print(f"æ’ä»¶ {plugin.name()} æ³¨å†ŒæˆåŠŸ")

    def get_plugin(self, name: str) -> Plugin:
        return self._plugins.get(name)

    def list_plugins(self) -> list:
        return list(self._plugins.keys())

    def execute_plugin(self, name: str, data: str) -> str:
        plugin = self.get_plugin(name)
        if plugin:
            return plugin.execute(data)
        else:
            raise Exception(f"æ’ä»¶ {name} ä¸å­˜åœ¨")

# å…·ä½“æ’ä»¶å®ç°
class TextUppercasePlugin(Plugin):
    def name(self) -> str:
        return "uppercase"

    def execute(self, data: str) -> str:
        return data.upper()

class TextLowercasePlugin(Plugin):
    def name(self) -> str:
        return "lowercase"

    def execute(self, data: str) -> str:
        return data.lower()

class TextReversePlugin(Plugin):
    def name(self) -> str:
        return "reverse"

    def execute(self, data: str) -> str:
        return data[::-1]

# ä½¿ç”¨ç¤ºä¾‹
manager = PluginManager()

# æ³¨å†Œæ’ä»¶
manager.register_plugin(TextUppercasePlugin())
manager.register_plugin(TextLowercasePlugin())
manager.register_plugin(TextReversePlugin())

# åˆ—å‡ºæ‰€æœ‰æ’ä»¶
print(f"å¯ç”¨æ’ä»¶: {manager.list_plugins()}")

# æ‰§è¡Œæ’ä»¶
text = "Hello World"
print(f"åŸå§‹æ–‡æœ¬: {text}")

for plugin_name in manager.list_plugins():
    try:
        result = manager.execute_plugin(plugin_name, text)
        print(f"{plugin_name}: {result}")
    except Exception as e:
        print(f"æ’ä»¶ {plugin_name} æ‰§è¡Œå¤±è´¥: {e}")
```

## 7. äº‹ä»¶é©±åŠ¨æ¶æ„

```python
# äº‹ä»¶æ€»çº¿
from typing import Dict, List, Callable
from dataclasses import dataclass
from datetime import datetime

@dataclass
class Event:
    type: str
    data: dict
    timestamp: datetime = None

    def __post_init__(self):
        if self.timestamp is None:
            self.timestamp = datetime.now()

class EventBus:
    def __init__(self):
        self._handlers: Dict[str, List[Callable]] = {}

    def subscribe(self, event_type: str, handler: Callable):
        if event_type not in self._handlers:
            self._handlers[event_type] = []
        self._handlers[event_type].append(handler)
        print(f"è®¢é˜…äº‹ä»¶ {event_type}")

    def unsubscribe(self, event_type: str, handler: Callable):
        if event_type in self._handlers:
            self._handlers[event_type].remove(handler)
            print(f"å–æ¶ˆè®¢é˜…äº‹ä»¶ {event_type}")

    def publish(self, event: Event):
        if event.type in self._handlers:
            for handler in self._handlers[event.type]:
                try:
                    handler(event)
                except Exception as e:
                    print(f"äº‹ä»¶å¤„ç†å™¨æ‰§è¡Œå¤±è´¥: {e}")
        print(f"å‘å¸ƒäº‹ä»¶ {event.type}: {event.data}")

# äº‹ä»¶å¤„ç†å™¨
class UserEventHandler:
    def on_user_registered(self, event: Event):
        print(f"ç”¨æˆ·æ³¨å†Œäº‹ä»¶: {event.data}")

    def on_user_login(self, event: Event):
        print(f"ç”¨æˆ·ç™»å½•äº‹ä»¶: {event.data}")

class OrderEventHandler:
    def on_order_created(self, event: Event):
        print(f"è®¢å•åˆ›å»ºäº‹ä»¶: {event.data}")

    def on_order_paid(self, event: Event):
        print(f"è®¢å•æ”¯ä»˜äº‹ä»¶: {event.data}")

# ä½¿ç”¨ç¤ºä¾‹
event_bus = EventBus()
user_handler = UserEventHandler()
order_handler = OrderEventHandler()

# è®¢é˜…äº‹ä»¶
event_bus.subscribe("user.registered", user_handler.on_user_registered)
event_bus.subscribe("user.login", user_handler.on_user_login)
event_bus.subscribe("order.created", order_handler.on_order_created)
event_bus.subscribe("order.paid", order_handler.on_order_paid)

# å‘å¸ƒäº‹ä»¶
user_registered_event = Event("user.registered", {
    "user_id": "12345",
    "email": "user@example.com",
    "username": "john_doe"
})

order_created_event = Event("order.created", {
    "order_id": "67890",
    "user_id": "12345",
    "amount": 99.99
})

event_bus.publish(user_registered_event)
event_bus.publish(order_created_event)
```

## 8. å·¥ä½œæµå¼•æ“å®è·µæ¡ˆä¾‹

### 8.1. ç®€å•å·¥ä½œæµå¼•æ“

```python
# å·¥ä½œæµå¼•æ“
from abc import ABC, abstractmethod
from typing import Dict, List, Any
from enum import Enum

class TaskStatus(Enum):
    PENDING = "PENDING"
    RUNNING = "RUNNING"
    COMPLETED = "COMPLETED"
    FAILED = "FAILED"

class Task(ABC):
    def __init__(self, name: str):
        self.name = name
        self.status = TaskStatus.PENDING
        self.result = None

    @abstractmethod
    def execute(self, context: Dict[str, Any]) -> Any:
        pass

class Workflow:
    def __init__(self, name: str):
        self.name = name
        self.tasks: List[Task] = []
        self.context: Dict[str, Any] = {}

    def add_task(self, task: Task):
        self.tasks.append(task)

    def execute(self):
        print(f"å¼€å§‹æ‰§è¡Œå·¥ä½œæµ: {self.name}")

        for task in self.tasks:
            try:
                task.status = TaskStatus.RUNNING
                print(f"æ‰§è¡Œä»»åŠ¡: {task.name}")

                task.result = task.execute(self.context)
                task.status = TaskStatus.COMPLETED

                print(f"ä»»åŠ¡å®Œæˆ: {task.name}, ç»“æœ: {task.result}")

            except Exception as e:
                task.status = TaskStatus.FAILED
                print(f"ä»»åŠ¡å¤±è´¥: {task.name}, é”™è¯¯: {e}")
                break

# å…·ä½“ä»»åŠ¡å®ç°
class DataValidationTask(Task):
    def execute(self, context: Dict[str, Any]) -> Any:
        data = context.get("input_data", [])
        if not data:
            raise Exception("è¾“å…¥æ•°æ®ä¸ºç©º")

        valid_data = [item for item in data if isinstance(item, (int, float))]
        context["validated_data"] = valid_data
        return f"éªŒè¯é€šè¿‡ï¼Œæœ‰æ•ˆæ•°æ®: {len(valid_data)} æ¡"

class DataProcessingTask(Task):
    def execute(self, context: Dict[str, Any]) -> Any:
        data = context.get("validated_data", [])
        if not data:
            raise Exception("æ²¡æœ‰éªŒè¯è¿‡çš„æ•°æ®")

        processed_data = [x * 2 for x in data]
        context["processed_data"] = processed_data
        return f"å¤„ç†å®Œæˆï¼Œç»“æœ: {processed_data}"

class DataExportTask(Task):
    def execute(self, context: Dict[str, Any]) -> Any:
        data = context.get("processed_data", [])
        if not data:
            raise Exception("æ²¡æœ‰å¤„ç†è¿‡çš„æ•°æ®")

# æ¨¡æ‹Ÿå¯¼å‡º
        export_result = f"å¯¼å‡º {len(data)} æ¡æ•°æ®åˆ°æ–‡ä»¶"
        context["export_result"] = export_result
        return export_result

# ä½¿ç”¨ç¤ºä¾‹
workflow = Workflow("æ•°æ®å¤„ç†å·¥ä½œæµ")

# æ·»åŠ ä»»åŠ¡
workflow.add_task(DataValidationTask("æ•°æ®éªŒè¯"))
workflow.add_task(DataProcessingTask("æ•°æ®å¤„ç†"))
workflow.add_task(DataExportTask("æ•°æ®å¯¼å‡º"))

# è®¾ç½®è¾“å…¥æ•°æ®
workflow.context["input_data"] = [1, 2, 3, "invalid", 4, 5.5]

# æ‰§è¡Œå·¥ä½œæµ
workflow.execute()

# æŸ¥çœ‹æœ€ç»ˆç»“æœ
print(f"\nå·¥ä½œæµæ‰§è¡Œå®Œæˆï¼Œæœ€ç»ˆç»“æœ: {workflow.context.get('export_result')}")
```

è¿™äº›å®è·µæ¡ˆä¾‹å±•ç¤ºäº†è½¯ä»¶å·¥ç¨‹æ·±åŒ–ä¸­çš„æ ¸å¿ƒæ¦‚å¿µå’Œå®é™…åº”ç”¨ï¼ŒåŒ…æ‹¬è®¾è®¡æ¨¡å¼ã€å¾®æœåŠ¡æ¶æ„ã€ç»„ä»¶æ¶æ„å’Œå·¥ä½œæµå¼•æ“ç­‰ã€‚æ¯ä¸ªæ¡ˆä¾‹éƒ½æä¾›äº†å®Œæ•´çš„ä»£ç å®ç°å’Œä½¿ç”¨ç¤ºä¾‹ï¼Œå¸®åŠ©ç†è§£è¿™äº›æ¦‚å¿µçš„å®é™…åº”ç”¨ã€‚
