# DevOpsä¸CI/CDæ¶æ„è®¾è®¡

## ğŸ“‘ ç›®å½•

- [DevOpsä¸CI/CDæ¶æ„è®¾è®¡](#devopsä¸cicdæ¶æ„è®¾è®¡)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1. èƒŒæ™¯ä¸åŠ¨æœº](#11-èƒŒæ™¯ä¸åŠ¨æœº)
    - [1.2. ç›®æ ‡ä¸èŒƒå›´](#12-ç›®æ ‡ä¸èŒƒå›´)
  - [2. ç†è®ºåŸºç¡€](#2-ç†è®ºåŸºç¡€)
    - [2.1. DevOpsæ ¸å¿ƒæ¦‚å¿µ](#21-devopsæ ¸å¿ƒæ¦‚å¿µ)
      - [2.1.1. æ–‡åŒ–è½¬å˜](#211-æ–‡åŒ–è½¬å˜)
  - [3. ä»·å€¼æµæ˜ å°„](#3-ä»·å€¼æµæ˜ å°„)
    - [3.1. CI/CDç†è®ºæ¡†æ¶](#31-cicdç†è®ºæ¡†æ¶)
      - [3.1.1. æŒç»­é›†æˆï¼ˆCIï¼‰](#311-æŒç»­é›†æˆci)
      - [3.1.2. æŒç»­äº¤ä»˜ï¼ˆCDï¼‰](#312-æŒç»­äº¤ä»˜cd)
  - [4. æ¶æ„è®¾è®¡](#4-æ¶æ„è®¾è®¡)
    - [4.1. æ•´ä½“æ¶æ„](#41-æ•´ä½“æ¶æ„)
      - [4.1.1. åˆ†å±‚æ¶æ„](#411-åˆ†å±‚æ¶æ„)
      - [4.1.2. æµæ°´çº¿è®¾è®¡](#412-æµæ°´çº¿è®¾è®¡)
  - [5. å®¹å™¨åŒ–æ¶æ„](#5-å®¹å™¨åŒ–æ¶æ„)
    - [5.1. Dockeræœ€ä½³å®è·µ](#51-dockeræœ€ä½³å®è·µ)
  - [6. Kuberneteséƒ¨ç½²](#6-kuberneteséƒ¨ç½²)
  - [7. ç›‘æ§ä¸å¯è§‚æµ‹æ€§](#7-ç›‘æ§ä¸å¯è§‚æµ‹æ€§)
    - [7.1. ç›‘æ§æ¶æ„](#71-ç›‘æ§æ¶æ„)
  - [8. æ—¥å¿—èšåˆ](#8-æ—¥å¿—èšåˆ)
  - [9. å·¥ç¨‹å®ç°](#9-å·¥ç¨‹å®ç°)
    - [9.1. è‡ªåŠ¨åŒ–è„šæœ¬](#91-è‡ªåŠ¨åŒ–è„šæœ¬)
      - [9.1.1. éƒ¨ç½²è„šæœ¬](#911-éƒ¨ç½²è„šæœ¬)
  - [10. ç›‘æ§è„šæœ¬](#10-ç›‘æ§è„šæœ¬)
  - [11. æœ€ä½³å®è·µ](#11-æœ€ä½³å®è·µ)
    - [11.1. å®‰å…¨æœ€ä½³å®è·µ](#111-å®‰å…¨æœ€ä½³å®è·µ)
      - [11.1.1. å®¹å™¨å®‰å…¨](#1111-å®¹å™¨å®‰å…¨)
  - [12. å¯†é’¥ç®¡ç†](#12-å¯†é’¥ç®¡ç†)
  - [13. æ€§èƒ½ä¼˜åŒ–](#13-æ€§èƒ½ä¼˜åŒ–)
    - [13.1. èµ„æºç®¡ç†](#131-èµ„æºç®¡ç†)
  - [14. æ°´å¹³æ‰©å±•](#14-æ°´å¹³æ‰©å±•)
  - [15. æ€»ç»“ä¸å±•æœ›](#15-æ€»ç»“ä¸å±•æœ›)
    - [15.1. å®æ–½æ•ˆæœ](#151-å®æ–½æ•ˆæœ)
    - [15.2. æœªæ¥å‘å±•æ–¹å‘](#152-æœªæ¥å‘å±•æ–¹å‘)
      - [15.2.1. GitOps](#1521-gitops)
  - [16. æœåŠ¡ç½‘æ ¼](#16-æœåŠ¡ç½‘æ ¼)
  - [17. æŒç»­æ”¹è¿›](#17-æŒç»­æ”¹è¿›)
  - [18. å‚è€ƒæ–‡çŒ®](#18-å‚è€ƒæ–‡çŒ®)
  - [19. ç›¸å…³é“¾æ¥](#19-ç›¸å…³é“¾æ¥)
  - [20. è´¡çŒ®æŒ‡å—](#20-è´¡çŒ®æŒ‡å—)
  - [21. è®¸å¯è¯ä¿¡æ¯](#21-è®¸å¯è¯ä¿¡æ¯)

---

## 1. æ¦‚è¿°

### 1.1. èƒŒæ™¯ä¸åŠ¨æœº

DevOpsï¼ˆDevelopment + Operationsï¼‰æ˜¯ä¸€ç§æ–‡åŒ–ã€å®è·µå’Œå·¥å…·çš„ç»“åˆï¼Œæ—¨åœ¨ç¼©çŸ­ç³»ç»Ÿå¼€å‘ç”Ÿå‘½å‘¨æœŸï¼Œæä¾›é«˜è´¨é‡çš„æŒç»­äº¤ä»˜ã€‚CI/CDï¼ˆContinuous Integration/Continuous Deliveryï¼‰æ˜¯DevOpsçš„æ ¸å¿ƒå®è·µï¼Œé€šè¿‡è‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²æµç¨‹ï¼Œå®ç°å¿«é€Ÿã€å¯é çš„è½¯ä»¶äº¤ä»˜ã€‚

### 1.2. ç›®æ ‡ä¸èŒƒå›´

æœ¬æ–‡æ¡£æ—¨åœ¨ï¼š

- å»ºç«‹DevOpsçš„ç†è®ºåŸºç¡€å’Œå®è·µæ¡†æ¶
- è®¾è®¡å®Œæ•´çš„CI/CDæµæ°´çº¿æ¶æ„
- æä¾›å·¥ç¨‹å®ç°æŒ‡å¯¼å’Œæœ€ä½³å®è·µ
- æ¶µç›–äº‘åŸç”Ÿå’Œå®¹å™¨åŒ–éƒ¨ç½²ç­–ç•¥

## 2. ç†è®ºåŸºç¡€

### 2.1. DevOpsæ ¸å¿ƒæ¦‚å¿µ

#### 2.1.1. æ–‡åŒ–è½¬å˜

```yaml
# DevOpsæ–‡åŒ–çŸ©é˜µ
devops_culture:
  collaboration:
    - cross_team_communication: "è·¨å›¢é˜Ÿåä½œ"
    - shared_responsibility: "å…±åŒè´£ä»»"
    - continuous_learning: "æŒç»­å­¦ä¹ "

  automation:
    - infrastructure_as_code: "åŸºç¡€è®¾æ–½å³ä»£ç "
    - automated_testing: "è‡ªåŠ¨åŒ–æµ‹è¯•"
    - automated_deployment: "è‡ªåŠ¨åŒ–éƒ¨ç½²"

  measurement:
    - metrics_collection: "æŒ‡æ ‡æ”¶é›†"
    - performance_monitoring: "æ€§èƒ½ç›‘æ§"
    - feedback_loops: "åé¦ˆå¾ªç¯"
```

## 3. ä»·å€¼æµæ˜ å°„

```mermaid
graph LR
    A[éœ€æ±‚] --> B[å¼€å‘]
    B --> C[æµ‹è¯•]
    C --> D[éƒ¨ç½²]
    D --> E[ç›‘æ§]
    E --> F[åé¦ˆ]
    F --> A

    style A fill:#e1f5fe
    style B fill:#f3e5f5
    style C fill:#e8f5e8
    style D fill:#fff3e0
    style E fill:#fce4ec
    style F fill:#f1f8e9
```

### 3.1. CI/CDç†è®ºæ¡†æ¶

#### 3.1.1. æŒç»­é›†æˆï¼ˆCIï¼‰

**å®šä¹‰**ï¼šæŒç»­é›†æˆæ˜¯ä¸€ç§å¼€å‘å®è·µï¼Œè¦æ±‚å¼€å‘äººå‘˜é¢‘ç¹åœ°å°†ä»£ç é›†æˆåˆ°ä¸»å¹²åˆ†æ”¯ï¼Œå¹¶é€šè¿‡è‡ªåŠ¨åŒ–æ„å»ºå’Œæµ‹è¯•æ¥éªŒè¯ä»£ç è´¨é‡ã€‚

**æ•°å­¦å½¢å¼åŒ–**ï¼š

è®¾ $C$ ä¸ºä»£ç æäº¤é›†åˆï¼Œ$B$ ä¸ºæ„å»ºç»“æœé›†åˆï¼Œ$T$ ä¸ºæµ‹è¯•ç»“æœé›†åˆï¼Œåˆ™CIè¿‡ç¨‹å¯è¡¨ç¤ºä¸ºï¼š

$$CI: C \rightarrow B \times T$$

å…¶ä¸­ï¼š

- $B = \{success, failure\}$
- $T = \{pass, fail\}$

**è´¨é‡æŒ‡æ ‡**ï¼š

$$\text{CIæˆåŠŸç‡} = \frac{|\{c \in C : B(c) = success \land T(c) = pass\}|}{|C|}$$

#### 3.1.2. æŒç»­äº¤ä»˜ï¼ˆCDï¼‰

**å®šä¹‰**ï¼šæŒç»­äº¤ä»˜æ˜¯ä¸€ç§è½¯ä»¶å·¥ç¨‹æ–¹æ³•ï¼Œç¡®ä¿è½¯ä»¶å¯ä»¥éšæ—¶å¯é åœ°å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒã€‚

**çŠ¶æ€æœºæ¨¡å‹**ï¼š

```rust
#[derive(Debug, Clone, PartialEq)]
pub enum DeploymentState {
    Development,
    Testing,
    Staging,
    Production,
    Rollback,
}

#[derive(Debug)]
pub struct DeploymentPipeline {
    current_state: DeploymentState,
    artifacts: Vec<Artifact>,
    approvals: Vec<Approval>,
}

impl DeploymentPipeline {
    pub fn can_deploy(&self, target: &DeploymentState) -> bool {
        match (&self.current_state, target) {
            (DeploymentState::Development, DeploymentState::Testing) => true,
            (DeploymentState::Testing, DeploymentState::Staging) => {
                self.all_tests_passed()
            },
            (DeploymentState::Staging, DeploymentState::Production) => {
                self.all_approvals_granted()
            },
            _ => false,
        }
    }

    fn all_tests_passed(&self) -> bool {
        // æ£€æŸ¥æ‰€æœ‰æµ‹è¯•æ˜¯å¦é€šè¿‡
        true
    }

    fn all_approvals_granted(&self) -> bool {
        // æ£€æŸ¥æ‰€æœ‰å®¡æ‰¹æ˜¯å¦é€šè¿‡
        true
    }
}
```

## 4. æ¶æ„è®¾è®¡

### 4.1. æ•´ä½“æ¶æ„

#### 4.1.1. åˆ†å±‚æ¶æ„

```mermaid
graph TB
    subgraph "åº”ç”¨å±‚"
        A1[Webåº”ç”¨]
        A2[APIæœåŠ¡]
        A3[å¾®æœåŠ¡]
    end

    subgraph "å¹³å°å±‚"
        P1[å®¹å™¨ç¼–æ’]
        P2[æœåŠ¡ç½‘æ ¼]
        P3[é…ç½®ç®¡ç†]
    end

    subgraph "åŸºç¡€è®¾æ–½å±‚"
        I1[è®¡ç®—èµ„æº]
        I2[å­˜å‚¨èµ„æº]
        I3[ç½‘ç»œèµ„æº]
    end

    subgraph "CI/CDæµæ°´çº¿"
        C1[ä»£ç ç®¡ç†]
        C2[æ„å»ºç³»ç»Ÿ]
        C3[æµ‹è¯•ç³»ç»Ÿ]
        C4[éƒ¨ç½²ç³»ç»Ÿ]
        C5[ç›‘æ§ç³»ç»Ÿ]
    end

    A1 --> P1
    A2 --> P2
    A3 --> P3
    P1 --> I1
    P2 --> I2
    P3 --> I3

    C1 --> C2
    C2 --> C3
    C3 --> C4
    C4 --> C5
```

#### 4.1.2. æµæ°´çº¿è®¾è®¡

```yaml
# GitLab CI/CDæµæ°´çº¿é…ç½®
stages:
  - validate
  - build
  - test
  - security
  - deploy
  - monitor

variables:
  DOCKER_REGISTRY: "registry.example.com"
  KUBERNETES_NAMESPACE: "production"

validate:
  stage: validate
  script:
    - npm run lint
    - npm run type-check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

build:
  stage: build
  script:
    - docker build -t $DOCKER_REGISTRY/app:$CI_COMMIT_SHA .
    - docker push $DOCKER_REGISTRY/app:$CI_COMMIT_SHA
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

test:
  stage: test
  script:
    - npm run test:unit
    - npm run test:integration
    - npm run test:e2e
  coverage: '/Coverage: \d+\.\d+%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml

security:
  stage: security
  script:
    - npm audit
    - trivy image $DOCKER_REGISTRY/app:$CI_COMMIT_SHA
  allow_failure: true

deploy:
  stage: deploy
  script:
    - kubectl set image deployment/app app=$DOCKER_REGISTRY/app:$CI_COMMIT_SHA
    - kubectl rollout status deployment/app
  environment:
    name: production
    url: https://app.example.com
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

monitor:
  stage: monitor
  script:
    - ./scripts/health-check.sh
    - ./scripts/performance-check.sh
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
```

## 5. å®¹å™¨åŒ–æ¶æ„

### 5.1. Dockeræœ€ä½³å®è·µ

```dockerfile
# å¤šé˜¶æ®µæ„å»ºDockerfile
FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

FROM node:18-alpine AS runtime

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001

WORKDIR /app

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder --chown=nextjs:nodejs /app/node_modules ./node_modules
COPY --chown=nextjs:nodejs . .

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV PORT=3000

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/health || exit 1

USER nextjs

CMD ["npm", "start"]
```

## 6. Kuberneteséƒ¨ç½²

```yaml
# Kuberneteséƒ¨ç½²é…ç½®
apiVersion: apps/v1
kind: Deployment
metadata:
  name: data-science-app
  namespace: production
  labels:
    app: data-science-app
    version: v1.0.0
spec:
  replicas: 3
  selector:
    matchLabels:
      app: data-science-app
  template:
    metadata:
      labels:
        app: data-science-app
        version: v1.0.0
    spec:
      containers:
      - name: app
        image: registry.example.com/data-science-app:v1.0.0
        ports:
        - containerPort: 3000
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: url
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: redis-secret
              key: url
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 5
      imagePullSecrets:
      - name: registry-secret
---
apiVersion: v1
kind: Service
metadata:
  name: data-science-app-service
  namespace: production
spec:
  selector:
    app: data-science-app
  ports:
  - protocol: TCP
    port: 80
    targetPort: 3000
  type: ClusterIP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: data-science-app-ingress
  namespace: production
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  tls:
  - hosts:
    - app.example.com
    secretName: app-tls
  rules:
  - host: app.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: data-science-app-service
            port:
              number: 80
```

## 7. ç›‘æ§ä¸å¯è§‚æµ‹æ€§

### 7.1. ç›‘æ§æ¶æ„

```yaml
# Prometheusç›‘æ§é…ç½®
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "alert_rules.yml"

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

scrape_configs:
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
        target_label: __address__
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: kubernetes_pod_name
```

## 8. æ—¥å¿—èšåˆ

```yaml
# Fluentdé…ç½®
<source>
  @type tail
  path /var/log/containers/*.log
  pos_file /var/log/fluentd-containers.log.pos
  tag kubernetes.*
  read_from_head true
  <parse>
    @type json
    time_format %Y-%m-%dT%H:%M:%S.%NZ
  </parse>
</source>

<filter kubernetes.**>
  @type kubernetes_metadata
  @id filter_kube_metadata
</filter>

<match kubernetes.**>
  @type elasticsearch
  host elasticsearch-master
  port 9200
  logstash_format true
  logstash_prefix k8s
  <buffer>
    @type file
    path /var/log/fluentd-buffers/kubernetes.system.buffer
    flush_mode interval
    retry_type exponential_backoff
    flush_interval 5s
    retry_forever false
    retry_max_interval 30
    chunk_limit_size 2M
    queue_limit_length 8
    overflow_action block
  </buffer>
</match>
```

## 9. å·¥ç¨‹å®ç°

### 9.1. è‡ªåŠ¨åŒ–è„šæœ¬

#### 9.1.1. éƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash
# deploy.sh - è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

set -euo pipefail

# é…ç½®å˜é‡
APP_NAME="data-science-app"
REGISTRY="registry.example.com"
NAMESPACE="production"
KUBECONFIG="${KUBECONFIG:-~/.kube/config}"

# é¢œè‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# æ£€æŸ¥å‰ç½®æ¡ä»¶
check_prerequisites() {
    log_info "æ£€æŸ¥å‰ç½®æ¡ä»¶..."

# æ£€æŸ¥Docker
    if ! command -v docker &> /dev/null; then
        log_error "Dockeræœªå®‰è£…"
        exit 1
    fi

# æ£€æŸ¥kubectl
    if ! command -v kubectl &> /dev/null; then
        log_error "kubectlæœªå®‰è£…"
        exit 1
    fi

# æ£€æŸ¥kubeconfig
    if [ ! -f "$KUBECONFIG" ]; then
        log_error "Kubeconfigæ–‡ä»¶ä¸å­˜åœ¨: $KUBECONFIG"
        exit 1
    fi

    log_info "å‰ç½®æ¡ä»¶æ£€æŸ¥é€šè¿‡"
}

# æ„å»ºé•œåƒ
build_image() {
    local version=$1
    log_info "æ„å»ºDockeré•œåƒ: $version"

    docker build -t "$REGISTRY/$APP_NAME:$version" .
    docker push "$REGISTRY/$APP_NAME:$version"

    log_info "é•œåƒæ„å»ºå®Œæˆ: $REGISTRY/$APP_NAME:$version"
}

# éƒ¨ç½²åˆ°Kubernetes
deploy_to_kubernetes() {
    local version=$1
    log_info "éƒ¨ç½²åˆ°Kubernetes: $version"

# æ›´æ–°é•œåƒæ ‡ç­¾
    kubectl set image deployment/$APP_NAME $APP_NAME="$REGISTRY/$APP_NAME:$version" -n $NAMESPACE

# ç­‰å¾…éƒ¨ç½²å®Œæˆ
    kubectl rollout status deployment/$APP_NAME -n $NAMESPACE --timeout=300s

    log_info "éƒ¨ç½²å®Œæˆ"
}

# å¥åº·æ£€æŸ¥
health_check() {
    log_info "æ‰§è¡Œå¥åº·æ£€æŸ¥..."

# ç­‰å¾…æœåŠ¡å°±ç»ª
    sleep 30

# æ£€æŸ¥PodçŠ¶æ€
    local ready_pods=$(kubectl get pods -n $NAMESPACE -l app=$APP_NAME -o jsonpath='{.items[*].status.containerStatuses[*].ready}' | tr ' ' '\n' | grep -c "true")
    local total_pods=$(kubectl get pods -n $NAMESPACE -l app=$APP_NAME --no-headers | wc -l)

    if [ "$ready_pods" -eq "$total_pods" ]; then
        log_info "æ‰€æœ‰Podå·²å°±ç»ª: $ready_pods/$total_pods"
    else
        log_error "Podå°±ç»ªçŠ¶æ€å¼‚å¸¸: $ready_pods/$total_pods"
        exit 1
    fi

# æ£€æŸ¥æœåŠ¡ç«¯ç‚¹
    local endpoints=$(kubectl get endpoints $APP_NAME-service -n $NAMESPACE -o jsonpath='{.subsets[*].addresses[*].ip}' | wc -w)
    if [ "$endpoints" -gt 0 ]; then
        log_info "æœåŠ¡ç«¯ç‚¹æ­£å¸¸: $endpointsä¸ª"
    else
        log_error "æœåŠ¡ç«¯ç‚¹å¼‚å¸¸"
        exit 1
    fi
}

# å›æ»šåŠŸèƒ½
rollback() {
    local previous_version=$1
    log_warn "æ‰§è¡Œå›æ»šåˆ°ç‰ˆæœ¬: $previous_version"

    kubectl rollout undo deployment/$APP_NAME -n $NAMESPACE
    kubectl rollout status deployment/$APP_NAME -n $NAMESPACE --timeout=300s

    log_info "å›æ»šå®Œæˆ"
}

# ä¸»å‡½æ•°
main() {
    local version=${1:-$(git rev-parse --short HEAD)}

    log_info "å¼€å§‹éƒ¨ç½²æµç¨‹ï¼Œç‰ˆæœ¬: $version"

    check_prerequisites
    build_image "$version"
    deploy_to_kubernetes "$version"
    health_check

    log_info "éƒ¨ç½²æµç¨‹å®Œæˆ"
}

# è„šæœ¬å…¥å£
if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    main "$@"
fi
```

## 10. ç›‘æ§è„šæœ¬

```python
#!/usr/bin/env python3
# monitor.py - åº”ç”¨ç›‘æ§è„šæœ¬

import os
import time
import json
import requests
import subprocess
from datetime import datetime
from typing import Dict, List, Optional
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

class ApplicationMonitor:
    def __init__(self, config: Dict):
        self.config = config
        self.metrics = {}

    def check_kubernetes_pods(self) -> Dict:
        """æ£€æŸ¥Kubernetes PodçŠ¶æ€"""
        try:
            cmd = [
                'kubectl', 'get', 'pods',
                '-n', self.config['namespace'],
                '-l', f"app={self.config['app_name']}",
                '-o', 'json'
            ]

            result = subprocess.run(cmd, capture_output=True, text=True, check=True)
            pods_data = json.loads(result.stdout)

            total_pods = len(pods_data['items'])
            ready_pods = sum(
                1 for pod in pods_data['items']
                if all(container['ready'] for container in pod['status']['containerStatuses'])
            )

            return {
                'total_pods': total_pods,
                'ready_pods': ready_pods,
                'ready_ratio': ready_pods / total_pods if total_pods > 0 else 0
            }
        except Exception as e:
            logger.error(f"æ£€æŸ¥PodçŠ¶æ€å¤±è´¥: {e}")
            return {'error': str(e)}

    def check_service_health(self) -> Dict:
        """æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€"""
        try:
            url = f"{self.config['service_url']}/health"
            response = requests.get(url, timeout=10)

            return {
                'status_code': response.status_code,
                'response_time': response.elapsed.total_seconds(),
                'healthy': response.status_code == 200
            }
        except Exception as e:
            logger.error(f"å¥åº·æ£€æŸ¥å¤±è´¥: {e}")
            return {'error': str(e), 'healthy': False}

    def check_database_connection(self) -> Dict:
        """æ£€æŸ¥æ•°æ®åº“è¿æ¥"""
        try:
# è¿™é‡Œå¯ä»¥æ·»åŠ æ•°æ®åº“è¿æ¥æ£€æŸ¥é€»è¾‘
            return {'connected': True, 'response_time': 0.1}
        except Exception as e:
            logger.error(f"æ•°æ®åº“è¿æ¥æ£€æŸ¥å¤±è´¥: {e}")
            return {'connected': False, 'error': str(e)}

    def collect_metrics(self) -> Dict:
        """æ”¶é›†æ‰€æœ‰æŒ‡æ ‡"""
        metrics = {
            'timestamp': datetime.now().isoformat(),
            'pods': self.check_kubernetes_pods(),
            'service': self.check_service_health(),
            'database': self.check_database_connection()
        }

        self.metrics = metrics
        return metrics

    def send_alert(self, message: str, severity: str = 'warning'):
        """å‘é€å‘Šè­¦"""
# è¿™é‡Œå¯ä»¥é›†æˆå‘Šè­¦ç³»ç»Ÿï¼ˆå¦‚Slackã€é’‰é’‰ç­‰ï¼‰
        logger.warning(f"å‘Šè­¦ [{severity}]: {message}")

    def check_thresholds(self, metrics: Dict):
        """æ£€æŸ¥é˜ˆå€¼å¹¶å‘é€å‘Šè­¦"""
# Podå°±ç»ªç‡æ£€æŸ¥
        if 'pods' in metrics and 'ready_ratio' in metrics['pods']:
            ready_ratio = metrics['pods']['ready_ratio']
            if ready_ratio < 0.8:
                self.send_alert(f"Podå°±ç»ªç‡è¿‡ä½: {ready_ratio:.2%}", 'critical')

# æœåŠ¡å“åº”æ—¶é—´æ£€æŸ¥
        if 'service' in metrics and 'response_time' in metrics['service']:
            response_time = metrics['service']['response_time']
            if response_time > 2.0:
                self.send_alert(f"æœåŠ¡å“åº”æ—¶é—´è¿‡é•¿: {response_time:.2f}s", 'warning')

# æ•°æ®åº“è¿æ¥æ£€æŸ¥
        if 'database' in metrics and not metrics['database'].get('connected', True):
            self.send_alert("æ•°æ®åº“è¿æ¥å¤±è´¥", 'critical')

    def run_monitoring_loop(self):
        """è¿è¡Œç›‘æ§å¾ªç¯"""
        logger.info("å¼€å§‹ç›‘æ§å¾ªç¯")

        while True:
            try:
                metrics = self.collect_metrics()
                self.check_thresholds(metrics)

# è¾“å‡ºæŒ‡æ ‡
                logger.info(f"ç›‘æ§æŒ‡æ ‡: {json.dumps(metrics, indent=2)}")

# ç­‰å¾…ä¸‹æ¬¡æ£€æŸ¥
                time.sleep(self.config.get('check_interval', 60))

            except KeyboardInterrupt:
                logger.info("ç›‘æ§å¾ªç¯è¢«ä¸­æ–­")
                break
            except Exception as e:
                logger.error(f"ç›‘æ§å¾ªç¯å¼‚å¸¸: {e}")
                time.sleep(10)

def main():
# é…ç½®
    config = {
        'app_name': 'data-science-app',
        'namespace': 'production',
        'service_url': 'https://app.example.com',
        'check_interval': 60  # ç§’
    }

    monitor = ApplicationMonitor(config)
    monitor.run_monitoring_loop()

if __name__ == '__main__':
    main()
```

## 11. æœ€ä½³å®è·µ

### 11.1. å®‰å…¨æœ€ä½³å®è·µ

#### 11.1.1. å®¹å™¨å®‰å…¨

```yaml
# å®‰å…¨ç­–ç•¥é…ç½®
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: data-science-app-policy
  namespace: production
spec:
  selector:
    matchLabels:
      app: data-science-app
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/production/sa/data-science-app"]
    to:
    - operation:
        methods: ["GET", "POST"]
        paths: ["/api/*"]
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: data-science-app-network-policy
  namespace: production
spec:
  podSelector:
    matchLabels:
      app: data-science-app
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 3000
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: database
    ports:
    - protocol: TCP
      port: 5432
```

## 12. å¯†é’¥ç®¡ç†

```yaml
# Kubernetes Secreté…ç½®
apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
  namespace: production
type: Opaque
data:
  database-url: <base64-encoded-database-url>
  api-key: <base64-encoded-api-key>
  jwt-secret: <base64-encoded-jwt-secret>
---
# ä½¿ç”¨Secretçš„Podé…ç½®
apiVersion: v1
kind: Pod
metadata:
  name: data-science-app
spec:
  containers:
  - name: app
    image: data-science-app:latest
    env:
    - name: DATABASE_URL
      valueFrom:
        secretKeyRef:
          name: app-secrets
          key: database-url
    - name: API_KEY
      valueFrom:
        secretKeyRef:
          name: app-secrets
          key: api-key
    volumeMounts:
    - name: secrets-volume
      mountPath: /etc/secrets
      readOnly: true
  volumes:
  - name: secrets-volume
    secret:
      secretName: app-secrets
```

## 13. æ€§èƒ½ä¼˜åŒ–

### 13.1. èµ„æºç®¡ç†

```yaml
# èµ„æºé™åˆ¶å’Œè¯·æ±‚
apiVersion: apps/v1
kind: Deployment
metadata:
  name: data-science-app
spec:
  template:
    spec:
      containers:
      - name: app
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        env:
        - name: NODE_OPTIONS
          value: "--max-old-space-size=512"
```

## 14. æ°´å¹³æ‰©å±•

```yaml
# HorizontalPodAutoscaleré…ç½®
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: data-science-app-hpa
  namespace: production
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: data-science-app
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 10
        periodSeconds: 60
```

## 15. æ€»ç»“ä¸å±•æœ›

### 15.1. å®æ–½æ•ˆæœ

é€šè¿‡å®æ–½DevOpså’ŒCI/CDå®è·µï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

- **éƒ¨ç½²é¢‘ç‡æå‡**ï¼šä»æ¯æœˆéƒ¨ç½²æå‡åˆ°æ¯æ—¥å¤šæ¬¡éƒ¨ç½²
- **æ•…éšœæ¢å¤æ—¶é—´ç¼©çŸ­**ï¼šä»å°æ—¶çº§ç¼©çŸ­åˆ°åˆ†é’Ÿçº§
- **ä»£ç è´¨é‡æå‡**ï¼šé€šè¿‡è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–ç‡æå‡åˆ°90%ä»¥ä¸Š
- **å›¢é˜Ÿåä½œæ•ˆç‡æå‡**ï¼šå¼€å‘ã€æµ‹è¯•ã€è¿ç»´å›¢é˜Ÿåä½œæ›´åŠ ç´§å¯†

### 15.2. æœªæ¥å‘å±•æ–¹å‘

#### 15.2.1. GitOps

```yaml
# ArgoCDåº”ç”¨é…ç½®
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: data-science-app
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/example/data-science-app
    targetRevision: HEAD
    path: k8s
  destination:
    server: https://kubernetes.default.svc
    namespace: production
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
```

## 16. æœåŠ¡ç½‘æ ¼

```yaml
# Istio VirtualServiceé…ç½®
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: data-science-app
spec:
  hosts:
  - app.example.com
  gateways:
  - data-science-gateway
  http:
  - route:
    - destination:
        host: data-science-app-service
        port:
          number: 80
      weight: 90
    - destination:
        host: data-science-app-service-v2
        port:
          number: 80
      weight: 10
    retries:
      attempts: 3
      perTryTimeout: 2s
    timeout: 10s
```

## 17. æŒç»­æ”¹è¿›

DevOpsæ˜¯ä¸€ä¸ªæŒç»­æ”¹è¿›çš„è¿‡ç¨‹ï¼Œéœ€è¦ï¼š

1. **å®šæœŸå›é¡¾**ï¼šé€šè¿‡å›é¡¾ä¼šè®®è¯†åˆ«æ”¹è¿›ç‚¹
2. **æŒ‡æ ‡ç›‘æ§**ï¼šæŒç»­ç›‘æ§å…³é”®æŒ‡æ ‡
3. **æŠ€æœ¯æ›´æ–°**ï¼šåŠæ—¶é‡‡ç”¨æ–°æŠ€æœ¯å’Œå·¥å…·
4. **å›¢é˜ŸåŸ¹è®­**ï¼šæŒç»­æå‡å›¢é˜ŸæŠ€èƒ½

## 18. å‚è€ƒæ–‡çŒ®

1. [The DevOps Handbook](https://itrevolution.com/the-devops-handbook/)
2. [Continuous Delivery](https://continuousdelivery.com/)
3. [Site Reliability Engineering](https://sre.google/)
4. [Kubernetes Documentation](https://kubernetes.io/docs/)
5. [Docker Best Practices](https://docs.docker.com/develop/dev-best-practices/)

## 19. ç›¸å…³é“¾æ¥

- [CI/CDæµæ°´çº¿è®¾è®¡](../4.1.13-å¾®æœåŠ¡æ¶æ„è®¾è®¡.md)
- [äº‘åŸç”Ÿæ¶æ„å®è·µ](../4.1.14-äº‘åŸç”Ÿæ¶æ„å®è·µ.md)
- [æ€§èƒ½ç›‘æ§ç³»ç»Ÿ](../../7-æŒç»­é›†æˆä¸æ¼”è¿›/7.5-ç›‘æ§ä¸å¯è§‚æµ‹/7.5.1-æ€§èƒ½ç›‘æ§ç³»ç»Ÿ.md)

## 20. è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®DevOpså’ŒCI/CDç›¸å…³çš„æœ€ä½³å®è·µå’Œæ¡ˆä¾‹ã€‚

## 21. è®¸å¯è¯ä¿¡æ¯

æœ¬æ–‡æ¡£é‡‡ç”¨MITè®¸å¯è¯ã€‚
