# 4.3.2 å¾®æœåŠ¡æ¶æ„å®è·µæ¡ˆä¾‹

## ğŸ“‘ ç›®å½•

- [4.3.2 å¾®æœåŠ¡æ¶æ„å®è·µæ¡ˆä¾‹](#432-å¾®æœåŠ¡æ¶æ„å®è·µæ¡ˆä¾‹)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. ç›®å½•](#2-ç›®å½•)
  - [3. æœåŠ¡æ‹†åˆ†å®è·µæ¡ˆä¾‹](#3-æœåŠ¡æ‹†åˆ†å®è·µæ¡ˆä¾‹)
    - [3.1. ç”µå•†ç³»ç»ŸæœåŠ¡æ‹†åˆ†](#31-ç”µå•†ç³»ç»ŸæœåŠ¡æ‹†åˆ†)
  - [4. æœåŠ¡é—´é€šä¿¡](#4-æœåŠ¡é—´é€šä¿¡)
  - [5. APIç½‘å…³å®è·µæ¡ˆä¾‹](#5-apiç½‘å…³å®è·µæ¡ˆä¾‹)
    - [5.1. åŸºäºFlaskçš„APIç½‘å…³](#51-åŸºäºflaskçš„apiç½‘å…³)
  - [6. ç½‘å…³é…ç½®ç®¡ç†](#6-ç½‘å…³é…ç½®ç®¡ç†)
  - [7. æœåŠ¡å‘ç°ä¸æ³¨å†Œå®è·µæ¡ˆä¾‹](#7-æœåŠ¡å‘ç°ä¸æ³¨å†Œå®è·µæ¡ˆä¾‹)
    - [7.1. åŸºäºConsulçš„æœåŠ¡æ³¨å†Œ](#71-åŸºäºconsulçš„æœåŠ¡æ³¨å†Œ)
  - [8. åŸºäºEurekaçš„æœåŠ¡æ³¨å†Œ](#8-åŸºäºeurekaçš„æœåŠ¡æ³¨å†Œ)
  - [9. æœåŠ¡æ²»ç†å®è·µæ¡ˆä¾‹](#9-æœåŠ¡æ²»ç†å®è·µæ¡ˆä¾‹)
    - [9.1. ç†”æ–­å™¨å®ç°](#91-ç†”æ–­å™¨å®ç°)
  - [10. é‡è¯•æœºåˆ¶](#10-é‡è¯•æœºåˆ¶)
  - [11. é…ç½®ç®¡ç†å®è·µæ¡ˆä¾‹](#11-é…ç½®ç®¡ç†å®è·µæ¡ˆä¾‹)
    - [11.1. åŸºäºConfigMapçš„é…ç½®ç®¡ç†](#111-åŸºäºconfigmapçš„é…ç½®ç®¡ç†)
  - [12. é…ç½®çƒ­æ›´æ–°](#12-é…ç½®çƒ­æ›´æ–°)
  - [13. æ€»ç»“](#13-æ€»ç»“)

---


## 1. æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›å¾®æœåŠ¡æ¶æ„çš„å®é™…åº”ç”¨æ¡ˆä¾‹ï¼Œæ¶µç›–æœåŠ¡æ‹†åˆ†ã€æœåŠ¡æ²»ç†ã€APIç½‘å…³ã€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†ç­‰æ ¸å¿ƒä¸»é¢˜ã€‚

## 2. ç›®å½•

- [4.3.2 å¾®æœåŠ¡æ¶æ„å®è·µæ¡ˆä¾‹](#432-å¾®æœåŠ¡æ¶æ„å®è·µæ¡ˆä¾‹)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
  - [2. ç›®å½•](#2-ç›®å½•)
  - [3. æœåŠ¡æ‹†åˆ†å®è·µæ¡ˆä¾‹](#3-æœåŠ¡æ‹†åˆ†å®è·µæ¡ˆä¾‹)
    - [3.1. ç”µå•†ç³»ç»ŸæœåŠ¡æ‹†åˆ†](#31-ç”µå•†ç³»ç»ŸæœåŠ¡æ‹†åˆ†)
  - [4. æœåŠ¡é—´é€šä¿¡](#4-æœåŠ¡é—´é€šä¿¡)
  - [5. APIç½‘å…³å®è·µæ¡ˆä¾‹](#5-apiç½‘å…³å®è·µæ¡ˆä¾‹)
    - [5.1. åŸºäºFlaskçš„APIç½‘å…³](#51-åŸºäºflaskçš„apiç½‘å…³)
  - [6. ç½‘å…³é…ç½®ç®¡ç†](#6-ç½‘å…³é…ç½®ç®¡ç†)
  - [7. æœåŠ¡å‘ç°ä¸æ³¨å†Œå®è·µæ¡ˆä¾‹](#7-æœåŠ¡å‘ç°ä¸æ³¨å†Œå®è·µæ¡ˆä¾‹)
    - [7.1. åŸºäºConsulçš„æœåŠ¡æ³¨å†Œ](#71-åŸºäºconsulçš„æœåŠ¡æ³¨å†Œ)
  - [8. åŸºäºEurekaçš„æœåŠ¡æ³¨å†Œ](#8-åŸºäºeurekaçš„æœåŠ¡æ³¨å†Œ)
  - [9. æœåŠ¡æ²»ç†å®è·µæ¡ˆä¾‹](#9-æœåŠ¡æ²»ç†å®è·µæ¡ˆä¾‹)
    - [9.1. ç†”æ–­å™¨å®ç°](#91-ç†”æ–­å™¨å®ç°)
  - [10. é‡è¯•æœºåˆ¶](#10-é‡è¯•æœºåˆ¶)
  - [11. é…ç½®ç®¡ç†å®è·µæ¡ˆä¾‹](#11-é…ç½®ç®¡ç†å®è·µæ¡ˆä¾‹)
    - [11.1. åŸºäºConfigMapçš„é…ç½®ç®¡ç†](#111-åŸºäºconfigmapçš„é…ç½®ç®¡ç†)
  - [12. é…ç½®çƒ­æ›´æ–°](#12-é…ç½®çƒ­æ›´æ–°)
  - [13. æ€»ç»“](#13-æ€»ç»“)

## 3. æœåŠ¡æ‹†åˆ†å®è·µæ¡ˆä¾‹

### 3.1. ç”µå•†ç³»ç»ŸæœåŠ¡æ‹†åˆ†

```python
# ç”¨æˆ·æœåŠ¡ (user-service)
class UserService:
    def __init__(self):
        self.db = Database()

    def create_user(self, user_data):
        return self.db.users.insert(user_data)

    def get_user(self, user_id):
        return self.db.users.find_one({'_id': user_id})

    def update_user(self, user_id, user_data):
        return self.db.users.update({'_id': user_id}, user_data)

    def delete_user(self, user_id):
        return self.db.users.delete({'_id': user_id})

# å•†å“æœåŠ¡ (product-service)
class ProductService:
    def __init__(self):
        self.db = Database()

    def create_product(self, product_data):
        return self.db.products.insert(product_data)

    def get_product(self, product_id):
        return self.db.products.find_one({'_id': product_id})

    def search_products(self, query):
        return self.db.products.find({'name': {'$regex': query}})

    def update_stock(self, product_id, quantity):
        return self.db.products.update(
            {'_id': product_id},
            {'$inc': {'stock': -quantity}}
        )

# è®¢å•æœåŠ¡ (order-service)
class OrderService:
    def __init__(self):
        self.db = Database()
        self.user_client = UserClient()
        self.product_client = ProductClient()

    def create_order(self, user_id, items):
# éªŒè¯ç”¨æˆ·
        user = self.user_client.get_user(user_id)
        if not user:
            raise Exception("ç”¨æˆ·ä¸å­˜åœ¨")

# éªŒè¯å•†å“å’Œåº“å­˜
        total_amount = 0
        for item in items:
            product = self.product_client.get_product(item['product_id'])
            if not product:
                raise Exception(f"å•†å“ {item['product_id']} ä¸å­˜åœ¨")
            if product['stock'] < item['quantity']:
                raise Exception(f"å•†å“ {item['product_id']} åº“å­˜ä¸è¶³")
            total_amount += product['price'] * item['quantity']

# åˆ›å»ºè®¢å•
        order = {
            'user_id': user_id,
            'items': items,
            'total_amount': total_amount,
            'status': 'pending',
            'created_at': datetime.now()
        }

        order_id = self.db.orders.insert(order)

# æ›´æ–°åº“å­˜
        for item in items:
            self.product_client.update_stock(item['product_id'], item['quantity'])

        return order_id

    def get_order(self, order_id):
        return self.db.orders.find_one({'_id': order_id})

    def update_order_status(self, order_id, status):
        return self.db.orders.update(
            {'_id': order_id},
            {'$set': {'status': status}}
        )

# æ”¯ä»˜æœåŠ¡ (payment-service)
class PaymentService:
    def __init__(self):
        self.db = Database()

    def process_payment(self, order_id, payment_method, amount):
        payment = {
            'order_id': order_id,
            'payment_method': payment_method,
            'amount': amount,
            'status': 'processing',
            'created_at': datetime.now()
        }

        payment_id = self.db.payments.insert(payment)

# æ¨¡æ‹Ÿæ”¯ä»˜å¤„ç†
        if self._process_payment_logic(payment_method, amount):
            self.db.payments.update(
                {'_id': payment_id},
                {'$set': {'status': 'completed'}}
            )
            return payment_id
        else:
            self.db.payments.update(
                {'_id': payment_id},
                {'$set': {'status': 'failed'}}
            )
            raise Exception("æ”¯ä»˜å¤±è´¥")

    def _process_payment_logic(self, payment_method, amount):
# æ¨¡æ‹Ÿæ”¯ä»˜å¤„ç†é€»è¾‘
        import random
        return random.random() > 0.1  # 90%æˆåŠŸç‡
```

## 4. æœåŠ¡é—´é€šä¿¡

```python
import requests
import json
from typing import Dict, Any

class ServiceClient:
    def __init__(self, service_name, base_url):
        self.service_name = service_name
        self.base_url = base_url
        self.session = requests.Session()

    def _make_request(self, method, endpoint, data=None, params=None):
        url = f"{self.base_url}{endpoint}"
        headers = {'Content-Type': 'application/json'}

        try:
            if method.upper() == 'GET':
                response = self.session.get(url, params=params, headers=headers)
            elif method.upper() == 'POST':
                response = self.session.post(url, json=data, headers=headers)
            elif method.upper() == 'PUT':
                response = self.session.put(url, json=data, headers=headers)
            elif method.upper() == 'DELETE':
                response = self.session.delete(url, headers=headers)

            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            raise Exception(f"æœåŠ¡ {self.service_name} è°ƒç”¨å¤±è´¥: {e}")

class UserClient(ServiceClient):
    def __init__(self):
        super().__init__('user-service', 'http://user-service:8080')

    def get_user(self, user_id):
        return self._make_request('GET', f'/users/{user_id}')

    def create_user(self, user_data):
        return self._make_request('POST', '/users', data=user_data)

    def update_user(self, user_id, user_data):
        return self._make_request('PUT', f'/users/{user_id}', data=user_data)

class ProductClient(ServiceClient):
    def __init__(self):
        super().__init__('product-service', 'http://product-service:8080')

    def get_product(self, product_id):
        return self._make_request('GET', f'/products/{product_id}')

    def search_products(self, query):
        return self._make_request('GET', '/products/search', params={'q': query})

    def update_stock(self, product_id, quantity):
        return self._make_request('PUT', f'/products/{product_id}/stock',
                                data={'quantity': quantity})

class PaymentClient(ServiceClient):
    def __init__(self):
        super().__init__('payment-service', 'http://payment-service:8080')

    def process_payment(self, order_id, payment_method, amount):
        return self._make_request('POST', '/payments',
                                data={'order_id': order_id,
                                     'payment_method': payment_method,
                                     'amount': amount})
```

## 5. APIç½‘å…³å®è·µæ¡ˆä¾‹

### 5.1. åŸºäºFlaskçš„APIç½‘å…³

```python
from flask import Flask, request, jsonify
import requests
import jwt
import time
from functools import wraps

app = Flask(__name__)
app.config['SECRET_KEY'] = 'your-secret-key'

# æœåŠ¡è·¯ç”±é…ç½®
SERVICE_ROUTES = {
    'user-service': 'http://user-service:8080',
    'product-service': 'http://product-service:8080',
    'order-service': 'http://order-service:8080',
    'payment-service': 'http://payment-service:8080'
}

def require_auth(f):
    @wraps(f)
    def decorated(*args, **kwargs):
        token = request.headers.get('Authorization')
        if not token:
            return jsonify({'error': 'ç¼ºå°‘è®¤è¯ä»¤ç‰Œ'}), 401

        try:
            token = token.split(' ')[1]  # Bearer token
            payload = jwt.decode(token, app.config['SECRET_KEY'], algorithms=['HS256'])
            request.user = payload
        except jwt.ExpiredSignatureError:
            return jsonify({'error': 'ä»¤ç‰Œå·²è¿‡æœŸ'}), 401
        except jwt.InvalidTokenError:
            return jsonify({'error': 'æ— æ•ˆä»¤ç‰Œ'}), 401

        return f(*args, **kwargs)
    return decorated

def rate_limit(f):
    @wraps(f)
    def decorated(*args, **kwargs):
        client_ip = request.remote_addr
# ç®€å•çš„å†…å­˜é™æµï¼ˆç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨Redisï¼‰
        if hasattr(app, 'rate_limit') and client_ip in app.rate_limit:
            last_request = app.rate_limit[client_ip]
            if time.time() - last_request < 1:  # 1ç§’å†…é™åˆ¶1æ¬¡è¯·æ±‚
                return jsonify({'error': 'è¯·æ±‚è¿‡äºé¢‘ç¹'}), 429

        if not hasattr(app, 'rate_limit'):
            app.rate_limit = {}
        app.rate_limit[client_ip] = time.time()

        return f(*args, **kwargs)
    return decorated

@app.route('/api/<service>/<path:path>', methods=['GET', 'POST', 'PUT', 'DELETE'])
@require_auth
@rate_limit
def proxy_request(service, path):
    if service not in SERVICE_ROUTES:
        return jsonify({'error': 'æœåŠ¡ä¸å­˜åœ¨'}), 404

    target_url = f"{SERVICE_ROUTES[service]}/{path}"

# è½¬å‘è¯·æ±‚
    try:
        headers = dict(request.headers)
        headers.pop('Host', None)  # ç§»é™¤Hostå¤´

        response = requests.request(
            method=request.method,
            url=target_url,
            headers=headers,
            params=request.args,
            json=request.get_json() if request.is_json else None,
            data=request.get_data() if not request.is_json else None,
            timeout=30
        )

        return response.content, response.status_code, response.headers.items()

    except requests.exceptions.RequestException as e:
        return jsonify({'error': f'æœåŠ¡è°ƒç”¨å¤±è´¥: {str(e)}'}), 503

@app.route('/api/auth/login', methods=['POST'])
@rate_limit
def login():
    data = request.get_json()
    username = data.get('username')
    password = data.get('password')

# éªŒè¯ç”¨æˆ·ï¼ˆè°ƒç”¨ç”¨æˆ·æœåŠ¡ï¼‰
    try:
        response = requests.post(
            f"{SERVICE_ROUTES['user-service']}/auth/login",
            json={'username': username, 'password': password}
        )

        if response.status_code == 200:
            user_data = response.json()
# ç”ŸæˆJWTä»¤ç‰Œ
            token = jwt.encode(
                {
                    'user_id': user_data['user_id'],
                    'username': user_data['username'],
                    'exp': time.time() + 3600  # 1å°æ—¶è¿‡æœŸ
                },
                app.config['SECRET_KEY'],
                algorithm='HS256'
            )

            return jsonify({
                'token': token,
                'user': user_data
            })
        else:
            return jsonify({'error': 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'}), 401

    except requests.exceptions.RequestException:
        return jsonify({'error': 'è®¤è¯æœåŠ¡ä¸å¯ç”¨'}), 503

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8000)
```

## 6. ç½‘å…³é…ç½®ç®¡ç†

```yaml
# gateway-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: api-gateway-config
data:
  routes.yaml: |
    routes:
      - name: user-service
        path: /api/users/*
        target: http://user-service:8080
        methods: [GET, POST, PUT, DELETE]
        auth: required
        rate_limit: 100/minute

      - name: product-service
        path: /api/products/*
        target: http://product-service:8080
        methods: [GET, POST, PUT, DELETE]
        auth: required
        rate_limit: 200/minute

      - name: order-service
        path: /api/orders/*
        target: http://order-service:8080
        methods: [GET, POST, PUT, DELETE]
        auth: required
        rate_limit: 50/minute

      - name: payment-service
        path: /api/payments/*
        target: http://payment-service:8080
        methods: [GET, POST, PUT, DELETE]
        auth: required
        rate_limit: 30/minute

    auth:
      jwt_secret: your-secret-key
      token_expiry: 3600

    rate_limiting:
      default_limit: 100/minute
      burst_limit: 200

    cors:
      allowed_origins: ["http://localhost:3000", "https://example.com"]
      allowed_methods: [GET, POST, PUT, DELETE, OPTIONS]
      allowed_headers: [Content-Type, Authorization]
```

## 7. æœåŠ¡å‘ç°ä¸æ³¨å†Œå®è·µæ¡ˆä¾‹

### 7.1. åŸºäºConsulçš„æœåŠ¡æ³¨å†Œ

```python
import consul
import socket
import time
import threading
from flask import Flask

class ServiceRegistry:
    def __init__(self, consul_host='localhost', consul_port=8500):
        self.consul = consul.Consul(host=consul_host, port=consul_port)
        self.service_name = None
        self.service_id = None
        self.service_address = None
        self.service_port = None

    def register_service(self, service_name, service_port, tags=None):
        self.service_name = service_name
        self.service_address = socket.gethostbyname(socket.gethostname())
        self.service_port = service_port
        self.service_id = f"{service_name}-{self.service_address}-{service_port}"

# æ³¨å†ŒæœåŠ¡
        self.consul.agent.service.register(
            name=service_name,
            service_id=self.service_id,
            address=self.service_address,
            port=service_port,
            tags=tags or [],
            check=consul.Check.http(
                f"http://{self.service_address}:{service_port}/health",
                interval="10s",
                timeout="5s"
            )
        )
        print(f"æœåŠ¡ {service_name} å·²æ³¨å†Œåˆ°Consul")

    def deregister_service(self):
        if self.service_id:
            self.consul.agent.service.deregister(self.service_id)
            print(f"æœåŠ¡ {self.service_name} å·²ä»Consulæ³¨é”€")

    def discover_service(self, service_name):
        """æœåŠ¡å‘ç°"""
        _, services = self.consul.health.service(service_name, passing=True)
        if services:
# ç®€å•çš„è´Ÿè½½å‡è¡¡ï¼šè½®è¯¢
            service = services[0]['Service']
            return f"http://{service['Address']}:{service['Port']}"
        return None

    def get_all_services(self):
        """è·å–æ‰€æœ‰æœåŠ¡"""
        _, services = self.consul.agent.services()
        return services

# æœåŠ¡æ³¨å†Œç¤ºä¾‹
class UserServiceApp:
    def __init__(self):
        self.app = Flask(__name__)
        self.registry = ServiceRegistry()
        self.setup_routes()

    def setup_routes(self):
        @self.app.route('/health')
        def health_check():
            return {'status': 'healthy'}, 200

        @self.app.route('/users/<user_id>')
        def get_user(user_id):
# ä¸šåŠ¡é€»è¾‘
            return {'user_id': user_id, 'name': 'Test User'}, 200

    def start(self, port=8080):
# æ³¨å†ŒæœåŠ¡
        self.registry.register_service('user-service', port, ['api', 'user'])

# å¯åŠ¨æœåŠ¡
        try:
            self.app.run(host='0.0.0.0', port=port)
        finally:
# æœåŠ¡å…³é—­æ—¶æ³¨é”€
            self.registry.deregister_service()

# æœåŠ¡å‘ç°å®¢æˆ·ç«¯
class ServiceDiscoveryClient:
    def __init__(self):
        self.registry = ServiceRegistry()

    def get_service_url(self, service_name):
        return self.registry.discover_service(service_name)

    def call_service(self, service_name, endpoint, method='GET', data=None):
        service_url = self.get_service_url(service_name)
        if not service_url:
            raise Exception(f"æœåŠ¡ {service_name} ä¸å¯ç”¨")

        url = f"{service_url}{endpoint}"
        response = requests.request(method, url, json=data)
        return response.json()

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == '__main__':
    user_service = UserServiceApp()
    user_service.start(8080)
```

## 8. åŸºäºEurekaçš„æœåŠ¡æ³¨å†Œ

```python
import requests
import json
import time
import threading

class EurekaClient:
    def __init__(self, eureka_url, app_name, instance_id, host, port):
        self.eureka_url = eureka_url
        self.app_name = app_name
        self.instance_id = instance_id
        self.host = host
        self.port = port
        self.heartbeat_thread = None
        self.running = False

    def register(self):
        """æ³¨å†ŒæœåŠ¡åˆ°Eureka"""
        registration_data = {
            "instance": {
                "instanceId": self.instance_id,
                "hostName": self.host,
                "app": self.app_name,
                "ipAddr": self.host,
                "status": "UP",
                "overriddenstatus": "UNKNOWN",
                "port": {
                    "$": self.port,
                    "@enabled": "true"
                },
                "securePort": {
                    "$": 443,
                    "@enabled": "false"
                },
                "countryId": 1,
                "dataCenterInfo": {
                    "@class": "com.netflix.appinfo.InstanceInfo$DefaultDataCenterInfo",
                    "name": "MyOwn"
                },
                "leaseInfo": {
                    "renewalIntervalInSecs": 30,
                    "durationInSecs": 90,
                    "registrationTimestamp": 0,
                    "lastRenewalTimestamp": 0,
                    "evictionTimestamp": 0,
                    "serviceUpTimestamp": 0
                },
                "metadata": {
                    "@class": "java.util.Collections$EmptyMap"
                },
                "homePageUrl": f"http://{self.host}:{self.port}/",
                "statusPageUrl": f"http://{self.host}:{self.port}/health",
                "healthCheckUrl": f"http://{self.host}:{self.port}/health",
                "vipAddress": self.app_name,
                "secureVipAddress": self.app_name,
                "isCoordinatingDiscoveryServer": "false",
                "lastUpdatedTimestamp": "0",
                "lastDirtyTimestamp": "0",
                "actionType": "ADDED"
            }
        }

        response = requests.post(
            f"{self.eureka_url}/eureka/apps/{self.app_name}",
            json=registration_data,
            headers={'Content-Type': 'application/json'}
        )

        if response.status_code == 204:
            print(f"æœåŠ¡ {self.app_name} å·²æ³¨å†Œåˆ°Eureka")
            self.start_heartbeat()
        else:
            raise Exception(f"æœåŠ¡æ³¨å†Œå¤±è´¥: {response.status_code}")

    def deregister(self):
        """ä»Eurekaæ³¨é”€æœåŠ¡"""
        self.running = False
        if self.heartbeat_thread:
            self.heartbeat_thread.join()

        response = requests.delete(
            f"{self.eureka_url}/eureka/apps/{self.app_name}/{self.instance_id}"
        )

        if response.status_code == 200:
            print(f"æœåŠ¡ {self.app_name} å·²ä»Eurekaæ³¨é”€")

    def start_heartbeat(self):
        """å¼€å§‹å¿ƒè·³"""
        self.running = True
        self.heartbeat_thread = threading.Thread(target=self._heartbeat_loop)
        self.heartbeat_thread.daemon = True
        self.heartbeat_thread.start()

    def _heartbeat_loop(self):
        """å¿ƒè·³å¾ªç¯"""
        while self.running:
            try:
                response = requests.put(
                    f"{self.eureka_url}/eureka/apps/{self.app_name}/{self.instance_id}"
                )
                if response.status_code != 200:
                    print(f"å¿ƒè·³å¤±è´¥: {response.status_code}")
            except Exception as e:
                print(f"å¿ƒè·³å¼‚å¸¸: {e}")

            time.sleep(30)  # 30ç§’å¿ƒè·³ä¸€æ¬¡

# ä½¿ç”¨ç¤ºä¾‹
eureka_client = EurekaClient(
    eureka_url='http://eureka-server:8761',
    app_name='user-service',
    instance_id='user-service-1',
    host='localhost',
    port=8080
)

try:
    eureka_client.register()
# å¯åŠ¨æœåŠ¡...
    time.sleep(3600)  # è¿è¡Œ1å°æ—¶
finally:
    eureka_client.deregister()
```

## 9. æœåŠ¡æ²»ç†å®è·µæ¡ˆä¾‹

### 9.1. ç†”æ–­å™¨å®ç°

```python
import time
import threading
from enum import Enum
from functools import wraps

class CircuitBreakerState(Enum):
    CLOSED = "CLOSED"      # æ­£å¸¸çŠ¶æ€
    OPEN = "OPEN"          # ç†”æ–­çŠ¶æ€
    HALF_OPEN = "HALF_OPEN"  # åŠå¼€çŠ¶æ€

class CircuitBreaker:
    def __init__(self, failure_threshold=5, recovery_timeout=60, expected_exception=Exception):
        self.failure_threshold = failure_threshold
        self.recovery_timeout = recovery_timeout
        self.expected_exception = expected_exception

        self.state = CircuitBreakerState.CLOSED
        self.failure_count = 0
        self.last_failure_time = None
        self.lock = threading.Lock()

    def call(self, func, *args, **kwargs):
        with self.lock:
            if self.state == CircuitBreakerState.OPEN:
                if time.time() - self.last_failure_time > self.recovery_timeout:
                    self.state = CircuitBreakerState.HALF_OPEN
                else:
                    raise Exception("ç†”æ–­å™¨å¼€å¯ï¼ŒæœåŠ¡ä¸å¯ç”¨")

        try:
            result = func(*args, **kwargs)
            self._on_success()
            return result
        except self.expected_exception as e:
            self._on_failure()
            raise e

    def _on_success(self):
        with self.lock:
            self.failure_count = 0
            self.state = CircuitBreakerState.CLOSED

    def _on_failure(self):
        with self.lock:
            self.failure_count += 1
            self.last_failure_time = time.time()

            if self.state == CircuitBreakerState.HALF_OPEN:
                self.state = CircuitBreakerState.OPEN
            elif self.state == CircuitBreakerState.CLOSED and self.failure_count >= self.failure_threshold:
                self.state = CircuitBreakerState.OPEN

def circuit_breaker(failure_threshold=5, recovery_timeout=60):
    def decorator(func):
        breaker = CircuitBreaker(failure_threshold, recovery_timeout)

        @wraps(func)
        def wrapper(*args, **kwargs):
            return breaker.call(func, *args, **kwargs)

        return wrapper
    return decorator

# ä½¿ç”¨ç¤ºä¾‹
@circuit_breaker(failure_threshold=3, recovery_timeout=30)
def call_external_service():
    import random
    if random.random() < 0.3:  # 30%æ¦‚ç‡å¤±è´¥
        raise Exception("å¤–éƒ¨æœåŠ¡è°ƒç”¨å¤±è´¥")
    return "æœåŠ¡è°ƒç”¨æˆåŠŸ"

# æµ‹è¯•ç†”æ–­å™¨
for i in range(10):
    try:
        result = call_external_service()
        print(f"è°ƒç”¨ {i+1}: {result}")
    except Exception as e:
        print(f"è°ƒç”¨ {i+1}: {e}")
    time.sleep(1)
```

## 10. é‡è¯•æœºåˆ¶

```python
import time
import random
from functools import wraps

class RetryPolicy:
    def __init__(self, max_retries=3, base_delay=1, max_delay=60, backoff_factor=2):
        self.max_retries = max_retries
        self.base_delay = base_delay
        self.max_delay = max_delay
        self.backoff_factor = backoff_factor

    def get_delay(self, attempt):
        """è®¡ç®—å»¶è¿Ÿæ—¶é—´ï¼ˆæŒ‡æ•°é€€é¿ï¼‰"""
        delay = self.base_delay * (self.backoff_factor ** attempt)
        return min(delay, self.max_delay)

def retry(max_retries=3, base_delay=1, max_delay=60, backoff_factor=2, exceptions=(Exception,)):
    def decorator(func):
        policy = RetryPolicy(max_retries, base_delay, max_delay, backoff_factor)

        @wraps(func)
        def wrapper(*args, **kwargs):
            last_exception = None

            for attempt in range(max_retries + 1):
                try:
                    return func(*args, **kwargs)
                except exceptions as e:
                    last_exception = e

                    if attempt == max_retries:
                        raise last_exception

                    delay = policy.get_delay(attempt)
# æ·»åŠ éšæœºæŠ–åŠ¨
                    jitter = random.uniform(0, 0.1 * delay)
                    time.sleep(delay + jitter)

            raise last_exception

        return wrapper
    return decorator

# ä½¿ç”¨ç¤ºä¾‹
@retry(max_retries=3, base_delay=1, exceptions=(ConnectionError, TimeoutError))
def unreliable_service_call():
    import random
    if random.random() < 0.7:  # 70%æ¦‚ç‡å¤±è´¥
        raise ConnectionError("ç½‘ç»œè¿æ¥å¤±è´¥")
    return "æœåŠ¡è°ƒç”¨æˆåŠŸ"

# æµ‹è¯•é‡è¯•æœºåˆ¶
for i in range(5):
    try:
        result = unreliable_service_call()
        print(f"è°ƒç”¨ {i+1}: {result}")
    except Exception as e:
        print(f"è°ƒç”¨ {i+1}: æœ€ç»ˆå¤±è´¥ - {e}")
```

## 11. é…ç½®ç®¡ç†å®è·µæ¡ˆä¾‹

### 11.1. åŸºäºConfigMapçš„é…ç½®ç®¡ç†

```python
import os
import yaml
import json
from typing import Dict, Any

class ConfigManager:
    def __init__(self, config_path='/etc/config'):
        self.config_path = config_path
        self.config_cache = {}
        self.load_config()

    def load_config(self):
        """åŠ è½½é…ç½®æ–‡ä»¶"""
# ä»ç¯å¢ƒå˜é‡åŠ è½½
        self._load_from_env()

# ä»æ–‡ä»¶åŠ è½½
        self._load_from_files()

    def _load_from_env(self):
        """ä»ç¯å¢ƒå˜é‡åŠ è½½é…ç½®"""
        for key, value in os.environ.items():
            if key.startswith('APP_'):
                config_key = key[4:].lower()  # ç§»é™¤APP_å‰ç¼€
                self.config_cache[config_key] = self._parse_value(value)

    def _load_from_files(self):
        """ä»æ–‡ä»¶åŠ è½½é…ç½®"""
        if os.path.exists(f"{self.config_path}/config.yaml"):
            with open(f"{self.config_path}/config.yaml", 'r') as f:
                yaml_config = yaml.safe_load(f)
                self.config_cache.update(yaml_config)

        if os.path.exists(f"{self.config_path}/config.json"):
            with open(f"{self.config_path}/config.json", 'r') as f:
                json_config = json.load(f)
                self.config_cache.update(json_config)

    def _parse_value(self, value):
        """è§£æé…ç½®å€¼"""
# å°è¯•è§£æä¸ºJSON
        try:
            return json.loads(value)
        except (json.JSONDecodeError, TypeError):
            pass

# å°è¯•è§£æä¸ºå¸ƒå°”å€¼
        if value.lower() in ('true', 'false'):
            return value.lower() == 'true'

# å°è¯•è§£æä¸ºæ•°å­—
        try:
            if '.' in value:
                return float(value)
            else:
                return int(value)
        except ValueError:
            pass

        return value

    def get(self, key, default=None):
        """è·å–é…ç½®å€¼"""
        return self.config_cache.get(key, default)

    def get_int(self, key, default=0):
        """è·å–æ•´æ•°é…ç½®"""
        value = self.get(key, default)
        try:
            return int(value)
        except (ValueError, TypeError):
            return default

    def get_bool(self, key, default=False):
        """è·å–å¸ƒå°”é…ç½®"""
        value = self.get(key, default)
        if isinstance(value, bool):
            return value
        return str(value).lower() in ('true', '1', 'yes', 'on')

    def reload(self):
        """é‡æ–°åŠ è½½é…ç½®"""
        self.config_cache.clear()
        self.load_config()

# ä½¿ç”¨ç¤ºä¾‹
config = ConfigManager()

# æ•°æ®åº“é…ç½®
db_config = {
    'host': config.get('database.host', 'localhost'),
    'port': config.get_int('database.port', 3306),
    'name': config.get('database.name', 'test'),
    'user': config.get('database.user', 'root'),
    'password': config.get('database.password', '')
}

# æœåŠ¡é…ç½®
service_config = {
    'port': config.get_int('service.port', 8080),
    'debug': config.get_bool('service.debug', False),
    'log_level': config.get('service.log_level', 'INFO')
}

# Redisé…ç½®
redis_config = {
    'host': config.get('redis.host', 'localhost'),
    'port': config.get_int('redis.port', 6379),
    'db': config.get_int('redis.db', 0)
}

print("æ•°æ®åº“é…ç½®:", db_config)
print("æœåŠ¡é…ç½®:", service_config)
print("Redisé…ç½®:", redis_config)
```

## 12. é…ç½®çƒ­æ›´æ–°

```python
import threading
import time
import os
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler

class ConfigWatcher(FileSystemEventHandler):
    def __init__(self, config_manager):
        self.config_manager = config_manager

    def on_modified(self, event):
        if not event.is_directory and event.src_path.endswith(('.yaml', '.json')):
            print(f"é…ç½®æ–‡ä»¶ {event.src_path} å·²ä¿®æ”¹ï¼Œé‡æ–°åŠ è½½é…ç½®")
            self.config_manager.reload()

class HotReloadConfigManager(ConfigManager):
    def __init__(self, config_path='/etc/config'):
        super().__init__(config_path)
        self.watcher = ConfigWatcher(self)
        self.observer = Observer()
        self.observer.schedule(self.watcher, config_path, recursive=False)
        self.observer.start()

    def stop_watching(self):
        """åœæ­¢æ–‡ä»¶ç›‘æ§"""
        self.observer.stop()
        self.observer.join()

# ä½¿ç”¨ç¤ºä¾‹
config = HotReloadConfigManager('/tmp/config')

try:
# æœåŠ¡è¿è¡ŒæœŸé—´é…ç½®ä¼šè‡ªåŠ¨çƒ­æ›´æ–°
    while True:
        print(f"å½“å‰ç«¯å£é…ç½®: {config.get_int('service.port', 8080)}")
        time.sleep(10)
except KeyboardInterrupt:
    config.stop_watching()
    print("é…ç½®ç›‘æ§å·²åœæ­¢")
```

## 13. æ€»ç»“

è¿™äº›å®è·µæ¡ˆä¾‹å±•ç¤ºäº†å¾®æœåŠ¡æ¶æ„çš„æ ¸å¿ƒåº”ç”¨åœºæ™¯ï¼ŒåŒ…æ‹¬ï¼š

1. **æœåŠ¡æ‹†åˆ†**ï¼šæŒ‰ä¸šåŠ¡é¢†åŸŸæ‹†åˆ†æœåŠ¡ï¼Œå®ç°æ¾è€¦åˆ
2. **APIç½‘å…³**ï¼šç»Ÿä¸€å…¥å£ã€è®¤è¯ã€é™æµã€è·¯ç”±
3. **æœåŠ¡å‘ç°**ï¼šè‡ªåŠ¨æ³¨å†Œå’Œå‘ç°æœåŠ¡å®ä¾‹
4. **æœåŠ¡æ²»ç†**ï¼šç†”æ–­å™¨ã€é‡è¯•æœºåˆ¶ã€è´Ÿè½½å‡è¡¡
5. **é…ç½®ç®¡ç†**ï¼šé›†ä¸­é…ç½®ã€çƒ­æ›´æ–°ã€ç¯å¢ƒéš”ç¦»

æ¯ä¸ªæ¡ˆä¾‹éƒ½æä¾›äº†å®Œæ•´çš„ä»£ç ç¤ºä¾‹å’Œæœ€ä½³å®è·µï¼Œå¯ä»¥ç›´æ¥åº”ç”¨äºå®é™…é¡¹ç›®ä¸­ã€‚

**ç›¸å…³é“¾æ¥ï¼š**

- [4.3.1-å¾®æœåŠ¡æ¶æ„åŸºç¡€ç†è®º](4.3.1-å¾®æœåŠ¡æ¶æ„åŸºç¡€ç†è®º.md)
- [4.1.16-è½¯ä»¶æ¶æ„å®è·µæ¡ˆä¾‹](../4.1-æ¶æ„è®¾è®¡/4.1.16-è½¯ä»¶æ¶æ„å®è·µæ¡ˆä¾‹.md)
- [4.2.2-è®¾è®¡æ¨¡å¼å®è·µæ¡ˆä¾‹](../4.2-è®¾è®¡æ¨¡å¼/4.2.2-è®¾è®¡æ¨¡å¼å®è·µæ¡ˆä¾‹.md)
