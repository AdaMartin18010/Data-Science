# 1.4.7 NewSQLå®‰å…¨ä¸åˆè§„

## ğŸ“‘ ç›®å½•

- [1.4.7 NewSQLå®‰å…¨ä¸åˆè§„](#147-newsqlå®‰å…¨ä¸åˆè§„)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1. å®‰å…¨ç›®æ ‡](#11-å®‰å…¨ç›®æ ‡)
    - [1.2. åˆè§„è¦æ±‚](#12-åˆè§„è¦æ±‚)
  - [2. å®‰å…¨æœºåˆ¶](#2-å®‰å…¨æœºåˆ¶)
    - [2.1. èº«ä»½è®¤è¯](#21-èº«ä»½è®¤è¯)
      - [2.1.1. è®¤è¯æ–¹å¼](#211-è®¤è¯æ–¹å¼)
      - [2.1.2. å¯†ç ç­–ç•¥](#212-å¯†ç ç­–ç•¥)
      - [2.1.3. å¤šå› ç´ è®¤è¯ï¼ˆMFAï¼‰](#213-å¤šå› ç´ è®¤è¯mfa)
    - [2.2. æƒé™æ§åˆ¶](#22-æƒé™æ§åˆ¶)
      - [2.2.1. åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰](#221-åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶rbac)
      - [2.2.2. è¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰](#222-è¡Œçº§å®‰å…¨rls)
      - [2.2.3. åˆ—çº§å®‰å…¨](#223-åˆ—çº§å®‰å…¨)
    - [2.3. æ•°æ®åŠ å¯†](#23-æ•°æ®åŠ å¯†)
      - [2.3.1. ä¼ è¾“åŠ å¯†ï¼ˆTLS/SSLï¼‰](#231-ä¼ è¾“åŠ å¯†tlsssl)
      - [2.3.2. é™æ€åŠ å¯†ï¼ˆAt-Rest Encryptionï¼‰](#232-é™æ€åŠ å¯†at-rest-encryption)
      - [2.3.3. åº”ç”¨å±‚åŠ å¯†](#233-åº”ç”¨å±‚åŠ å¯†)
    - [2.4. å®¡è®¡æ—¥å¿—](#24-å®¡è®¡æ—¥å¿—)
      - [2.4.1. å®¡è®¡æ—¥å¿—ç±»å‹](#241-å®¡è®¡æ—¥å¿—ç±»å‹)
      - [2.4.2. å®¡è®¡æ—¥å¿—å®ç°](#242-å®¡è®¡æ—¥å¿—å®ç°)
      - [2.4.3. å®¡è®¡æ—¥å¿—åˆ†æ](#243-å®¡è®¡æ—¥å¿—åˆ†æ)
    - [2.5. ç½‘ç»œå®‰å…¨](#25-ç½‘ç»œå®‰å…¨)
      - [2.5.1. ç½‘ç»œéš”ç¦»](#251-ç½‘ç»œéš”ç¦»)
      - [2.5.2. VPNè®¿é—®](#252-vpnè®¿é—®)
    - [2.6. æ•°æ®è„±æ•](#26-æ•°æ®è„±æ•)
      - [2.6.1. é™æ€è„±æ•](#261-é™æ€è„±æ•)
      - [2.6.2. åŠ¨æ€è„±æ•](#262-åŠ¨æ€è„±æ•)
  - [3. åˆè§„æ ‡å‡†](#3-åˆè§„æ ‡å‡†)
    - [3.1. GDPRåˆè§„](#31-gdpråˆè§„)
      - [3.1.1. GDPRæ ¸å¿ƒè¦æ±‚](#311-gdpræ ¸å¿ƒè¦æ±‚)
      - [3.1.2. GDPRå®ç°](#312-gdprå®ç°)
    - [3.2. SOXåˆè§„](#32-soxåˆè§„)
      - [3.2.1. SOXæ ¸å¿ƒè¦æ±‚](#321-soxæ ¸å¿ƒè¦æ±‚)
      - [3.2.2. SOXå®ç°](#322-soxå®ç°)
    - [3.3. PCI DSSåˆè§„](#33-pci-dssåˆè§„)
      - [3.3.1. PCI DSSæ ¸å¿ƒè¦æ±‚](#331-pci-dssæ ¸å¿ƒè¦æ±‚)
      - [3.3.2. PCI DSSå®ç°](#332-pci-dsså®ç°)
    - [3.4. HIPAAåˆè§„](#34-hipaaåˆè§„)
      - [3.4.1. HIPAAæ ¸å¿ƒè¦æ±‚](#341-hipaaæ ¸å¿ƒè¦æ±‚)
    - [3.5. å…¶ä»–åˆè§„æ ‡å‡†](#35-å…¶ä»–åˆè§„æ ‡å‡†)
  - [4. å®é™…ç³»ç»Ÿå®ç°](#4-å®é™…ç³»ç»Ÿå®ç°)
    - [4.1. TiDBå®‰å…¨æœºåˆ¶](#41-tidbå®‰å…¨æœºåˆ¶)
    - [4.2. CockroachDBå®‰å…¨æœºåˆ¶](#42-cockroachdbå®‰å…¨æœºåˆ¶)
    - [4.3. OceanBaseå®‰å…¨æœºåˆ¶](#43-oceanbaseå®‰å…¨æœºåˆ¶)
  - [5. å®‰å…¨æœ€ä½³å®è·µ](#5-å®‰å…¨æœ€ä½³å®è·µ)
    - [5.1. å®‰å…¨é…ç½®](#51-å®‰å…¨é…ç½®)
    - [5.2. å®‰å…¨å®¡è®¡](#52-å®‰å…¨å®¡è®¡)
    - [5.3. å®‰å…¨ç›‘æ§](#53-å®‰å…¨ç›‘æ§)
  - [6. å®é™…åº”ç”¨æ¡ˆä¾‹](#6-å®é™…åº”ç”¨æ¡ˆä¾‹)
    - [6.1. é‡‘èè¡Œä¸šï¼šNewSQLå®‰å…¨æ¶æ„](#61-é‡‘èè¡Œä¸šnewsqlå®‰å…¨æ¶æ„)
    - [6.2. äº’è”ç½‘è¡Œä¸šï¼šåˆ†å¸ƒå¼å®‰å…¨åˆè§„](#62-äº’è”ç½‘è¡Œä¸šåˆ†å¸ƒå¼å®‰å…¨åˆè§„)
  - [7. å½¢å¼åŒ–å®šä¹‰](#7-å½¢å¼åŒ–å®šä¹‰)
    - [7.1. å®‰å…¨æ¨¡å‹å½¢å¼åŒ–](#71-å®‰å…¨æ¨¡å‹å½¢å¼åŒ–)
    - [7.2. å®‰å…¨ç­‰çº§å½¢å¼åŒ–](#72-å®‰å…¨ç­‰çº§å½¢å¼åŒ–)
  - [8. å¤šè¡¨å¾](#8-å¤šè¡¨å¾)
  - [9. æ€»ç»“ä¸å±•æœ›](#9-æ€»ç»“ä¸å±•æœ›)
    - [9.1. æ€»ç»“](#91-æ€»ç»“)
    - [9.2. å‘å±•è¶‹åŠ¿](#92-å‘å±•è¶‹åŠ¿)

---

## 1. æ¦‚è¿°

### 1.1. å®‰å…¨ç›®æ ‡

**NewSQLå®‰å…¨çš„æ ¸å¿ƒç›®æ ‡**ï¼š

1. **æœºå¯†æ€§ï¼ˆConfidentialityï¼‰**ï¼šä¿æŠ¤æ•°æ®ä¸è¢«æœªæˆæƒè®¿é—®
2. **å®Œæ•´æ€§ï¼ˆIntegrityï¼‰**ï¼šä¿è¯æ•°æ®ä¸è¢«ç¯¡æ”¹
3. **å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰**ï¼šä¿è¯ç³»ç»Ÿå¯ç”¨
4. **å¯å®¡è®¡æ€§ï¼ˆAuditabilityï¼‰**ï¼šè®°å½•æ‰€æœ‰æ“ä½œï¼Œæ”¯æŒå®¡è®¡

**å®‰å…¨æ¨¡å‹**ï¼š

```mermaid
graph TB
    User[ç”¨æˆ·] --> Auth[èº«ä»½è®¤è¯]
    Auth -->|é€šè¿‡| Authz[æƒé™æ§åˆ¶]
    Authz -->|æˆæƒ| Access[æ•°æ®è®¿é—®]
    Access --> Encrypt[æ•°æ®åŠ å¯†]
    Access --> Audit[å®¡è®¡æ—¥å¿—]
    Access --> Network[ç½‘ç»œå®‰å…¨]
```

### 1.2. åˆè§„è¦æ±‚

**ä¸»è¦åˆè§„æ ‡å‡†**ï¼š

| åˆè§„æ ‡å‡† | å…¨ç§° | é€‚ç”¨èŒƒå›´ | æ ¸å¿ƒè¦æ±‚ |
|---------|------|---------|---------|
| **GDPR** | General Data Protection Regulation | æ¬§ç›Ÿ | æ•°æ®ä¿æŠ¤ã€éšç§æƒ |
| **SOX** | Sarbanes-Oxley Act | ç¾å›½ä¸Šå¸‚å…¬å¸ | è´¢åŠ¡å®¡è®¡ã€å†…éƒ¨æ§åˆ¶ |
| **PCI DSS** | Payment Card Industry Data Security Standard | æ”¯ä»˜å¡è¡Œä¸š | æ”¯ä»˜æ•°æ®å®‰å…¨ |
| **HIPAA** | Health Insurance Portability and Accountability Act | ç¾å›½åŒ»ç–— | åŒ»ç–—æ•°æ®ä¿æŠ¤ |

---

## 2. å®‰å…¨æœºåˆ¶

### 2.1. èº«ä»½è®¤è¯

#### 2.1.1. è®¤è¯æ–¹å¼

**æ”¯æŒçš„è®¤è¯æ–¹å¼**ï¼š

1. **å¯†ç è®¤è¯**ï¼šç”¨æˆ·å+å¯†ç 
2. **è¯ä¹¦è®¤è¯**ï¼šX.509è¯ä¹¦
3. **LDAPè®¤è¯**ï¼šä¼ä¸šç›®å½•æœåŠ¡
4. **OAuthè®¤è¯**ï¼šç¬¬ä¸‰æ–¹è®¤è¯
5. **Kerberosè®¤è¯**ï¼šä¼ä¸šçº§è®¤è¯

**è®¤è¯æµç¨‹**ï¼š

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Auth as è®¤è¯æœåŠ¡
    participant DB as æ•°æ®åº“

    Client->>Auth: æäº¤å‡­è¯
    Auth->>Auth: éªŒè¯å‡­è¯
    Auth->>Client: è¿”å›Token
    Client->>DB: ä½¿ç”¨Tokenè®¿é—®
    DB->>Auth: éªŒè¯Token
    Auth->>DB: éªŒè¯ç»“æœ
    DB->>Client: è¿”å›æ•°æ®
```

#### 2.1.2. å¯†ç ç­–ç•¥

**å¯†ç è¦æ±‚**ï¼š

- **æœ€å°é•¿åº¦**ï¼šè‡³å°‘8-12ä¸ªå­—ç¬¦
- **å¤æ‚åº¦**ï¼šåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦
- **è¿‡æœŸæ—¶é—´**ï¼šå®šæœŸæ›´æ¢å¯†ç 
- **å†å²è®°å½•**ï¼šä¸èƒ½ä½¿ç”¨æœ€è¿‘Næ¬¡å¯†ç 

**å®ç°ç¤ºä¾‹**ï¼š

```sql
-- TiDBå¯†ç ç­–ç•¥é…ç½®
SET GLOBAL validate_password.policy = 'STRONG';
SET GLOBAL validate_password.length = 12;
SET GLOBAL validate_password.mixed_case_count = 1;
SET GLOBAL validate_password.number_count = 1;
SET GLOBAL validate_password.special_char_count = 1;

-- åˆ›å»ºç”¨æˆ·
CREATE USER 'app_user'@'%' IDENTIFIED BY 'ComplexP@ssw0rd!';
```

#### 2.1.3. å¤šå› ç´ è®¤è¯ï¼ˆMFAï¼‰

**MFAå®ç°**ï¼š

```python
class MultiFactorAuth:
    def __init__(self, db, sms_service, totp_service):
        self.db = db
        self.sms_service = sms_service
        self.totp_service = totp_service

    def authenticate(self, username, password, mfa_code):
        """å¤šå› ç´ è®¤è¯"""
        # ç¬¬ä¸€æ­¥ï¼šéªŒè¯å¯†ç 
        if not self.verify_password(username, password):
            return False

        # ç¬¬äºŒæ­¥ï¼šéªŒè¯MFAä»£ç 
        if not self.verify_mfa(username, mfa_code):
            return False

        return True

    def verify_mfa(self, username, mfa_code):
        """éªŒè¯MFAä»£ç """
        # å¯ä»¥æ”¯æŒTOTPæˆ–SMSéªŒè¯ç 
        return (self.totp_service.verify(username, mfa_code) or
                self.sms_service.verify(username, mfa_code))
```

### 2.2. æƒé™æ§åˆ¶

#### 2.2.1. åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰

**RBACæ¨¡å‹**ï¼š

```mermaid
graph TB
    User[ç”¨æˆ·] --> Role[è§’è‰²]
    Role --> Permission[æƒé™]
    Permission --> Resource[èµ„æº]

    Role1[ç®¡ç†å‘˜] --> Permission1[æ‰€æœ‰æƒé™]
    Role2[å¼€å‘è€…] --> Permission2[è¯»å†™æƒé™]
    Role3[åªè¯»ç”¨æˆ·] --> Permission3[åªè¯»æƒé™]
```

**å®ç°ç¤ºä¾‹**ï¼š

```sql
-- åˆ›å»ºè§’è‰²
CREATE ROLE 'admin_role';
CREATE ROLE 'developer_role';
CREATE ROLE 'readonly_role';

-- æˆäºˆè§’è‰²æƒé™
GRANT ALL PRIVILEGES ON *.* TO 'admin_role';
GRANT SELECT, INSERT, UPDATE, DELETE ON app_db.* TO 'developer_role';
GRANT SELECT ON app_db.* TO 'readonly_role';

-- åˆ†é…è§’è‰²ç»™ç”¨æˆ·
GRANT 'admin_role' TO 'admin_user'@'%';
GRANT 'developer_role' TO 'dev_user'@'%';
GRANT 'readonly_role' TO 'readonly_user'@'%';

-- æ¿€æ´»è§’è‰²
SET DEFAULT ROLE 'developer_role' FOR 'dev_user'@'%';
```

#### 2.2.2. è¡Œçº§å®‰å…¨ï¼ˆRLSï¼‰

**è¡Œçº§å®‰å…¨å®ç°**ï¼š

```sql
-- åˆ›å»ºè¡Œçº§å®‰å…¨ç­–ç•¥
CREATE POLICY user_data_policy ON users
    FOR ALL
    TO app_user
    USING (user_id = current_user_id());

-- å¯ç”¨è¡Œçº§å®‰å…¨
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
SELECT * FROM users;  -- è‡ªåŠ¨è¿‡æ»¤ï¼Œåªè¿”å›å½“å‰ç”¨æˆ·çš„æ•°æ®
```

#### 2.2.3. åˆ—çº§å®‰å…¨

**åˆ—çº§å®‰å…¨å®ç°**ï¼š

```sql
-- åˆ›å»ºè§†å›¾ï¼Œéšè—æ•æ„Ÿåˆ—
CREATE VIEW user_public AS
SELECT
    user_id,
    username,
    email,
    created_at
FROM users;
-- ä¸åŒ…å«passwordã€phoneç­‰æ•æ„Ÿå­—æ®µ

-- æˆäºˆè§†å›¾æƒé™
GRANT SELECT ON user_public TO 'public_user'@'%';
```

### 2.3. æ•°æ®åŠ å¯†

#### 2.3.1. ä¼ è¾“åŠ å¯†ï¼ˆTLS/SSLï¼‰

**TLSé…ç½®**ï¼š

```yaml
# TiDB TLSé…ç½®
[security]
ssl-ca = "/path/to/ca.pem"
ssl-cert = "/path/to/server.pem"
ssl-key = "/path/to/server-key.pem"
```

**å®¢æˆ·ç«¯è¿æ¥**ï¼š

```python
import pymysql

# ä½¿ç”¨TLSè¿æ¥
conn = pymysql.connect(
    host='localhost',
    port=4000,
    user='root',
    password='password',
    ssl={'ca': '/path/to/ca.pem'}
)
```

#### 2.3.2. é™æ€åŠ å¯†ï¼ˆAt-Rest Encryptionï¼‰

**æ•°æ®åŠ å¯†å®ç°**ï¼š

```sql
-- åˆ›å»ºåŠ å¯†è¡¨
CREATE TABLE sensitive_data (
    id BIGINT PRIMARY KEY,
    encrypted_field VARBINARY(255)  -- åŠ å¯†å­—æ®µ
) ENCRYPTION='Y';

-- æ’å…¥åŠ å¯†æ•°æ®
INSERT INTO sensitive_data (id, encrypted_field)
VALUES (1, AES_ENCRYPT('sensitive_value', 'encryption_key'));
```

**é€æ˜æ•°æ®åŠ å¯†ï¼ˆTDEï¼‰**ï¼š

```yaml
# TiDB TDEé…ç½®
[security]
enable-tde = true
tde-key-id = "arn:aws:kms:region:account:key/key-id"
```

#### 2.3.3. åº”ç”¨å±‚åŠ å¯†

**åº”ç”¨å±‚åŠ å¯†å®ç°**ï¼š

```python
from cryptography.fernet import Fernet

class DataEncryption:
    def __init__(self, key):
        self.cipher = Fernet(key)

    def encrypt(self, data):
        """åŠ å¯†æ•°æ®"""
        return self.cipher.encrypt(data.encode()).decode()

    def decrypt(self, encrypted_data):
        """è§£å¯†æ•°æ®"""
        return self.cipher.decrypt(encrypted_data.encode()).decode()

# ä½¿ç”¨ç¤ºä¾‹
encryption = DataEncryption(Fernet.generate_key())

# å­˜å‚¨åŠ å¯†æ•°æ®
encrypted_ssn = encryption.encrypt("123-45-6789")
db.execute("INSERT INTO users (ssn) VALUES (%s)", (encrypted_ssn,))

# è¯»å–è§£å¯†æ•°æ®
encrypted_ssn = db.fetchone()[0]
ssn = encryption.decrypt(encrypted_ssn)
```

### 2.4. å®¡è®¡æ—¥å¿—

#### 2.4.1. å®¡è®¡æ—¥å¿—ç±»å‹

**å®¡è®¡æ—¥å¿—åˆ†ç±»**ï¼š

1. **è®¿é—®æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰æ•°æ®åº“è®¿é—®
2. **æ“ä½œæ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰æ•°æ®æ“ä½œï¼ˆINSERTã€UPDATEã€DELETEï¼‰
3. **æƒé™æ—¥å¿—**ï¼šè®°å½•æƒé™å˜æ›´
4. **è®¤è¯æ—¥å¿—**ï¼šè®°å½•è®¤è¯æˆåŠŸ/å¤±è´¥

**å®¡è®¡æ—¥å¿—è¡¨è®¾è®¡**ï¼š

```sql
-- åˆ›å»ºå®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE audit_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    event_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    user_name VARCHAR(100),
    host VARCHAR(100),
    database_name VARCHAR(100),
    table_name VARCHAR(100),
    action VARCHAR(50),  -- SELECT, INSERT, UPDATE, DELETE, GRANT, REVOKE
    sql_text TEXT,
    affected_rows INT,
    execution_time_ms INT,
    ip_address VARCHAR(45),
    user_agent VARCHAR(255),
    INDEX idx_event_time (event_time),
    INDEX idx_user_name (user_name),
    INDEX idx_action (action)
) PARTITION BY RANGE (TO_DAYS(event_time)) (
    PARTITION p202401 VALUES LESS THAN (TO_DAYS('2024-02-01')),
    PARTITION p202402 VALUES LESS THAN (TO_DAYS('2024-03-01')),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 2.4.2. å®¡è®¡æ—¥å¿—å®ç°

**è§¦å‘å™¨å®ç°**ï¼š

```sql
-- åˆ›å»ºå®¡è®¡è§¦å‘å™¨
DELIMITER $$

CREATE TRIGGER audit_users_insert
AFTER INSERT ON users
FOR EACH ROW
BEGIN
    INSERT INTO audit_log (
        user_name, database_name, table_name, action, sql_text
    ) VALUES (
        USER(), DATABASE(), 'users', 'INSERT',
        CONCAT('INSERT INTO users VALUES (', NEW.id, ', ', NEW.username, ')')
    );
END$$

DELIMITER ;
```

**åº”ç”¨å±‚å®ç°**ï¼š

```python
class AuditLogger:
    def __init__(self, db):
        self.db = db

    def log_query(self, user, action, sql, affected_rows, execution_time):
        """è®°å½•æŸ¥è¯¢æ—¥å¿—"""
        self.db.execute("""
            INSERT INTO audit_log
            (user_name, action, sql_text, affected_rows, execution_time_ms)
            VALUES (%s, %s, %s, %s, %s)
        """, (user, action, sql, affected_rows, execution_time))

    def log_access(self, user, ip_address, user_agent):
        """è®°å½•è®¿é—®æ—¥å¿—"""
        self.db.execute("""
            INSERT INTO audit_log
            (user_name, action, ip_address, user_agent)
            VALUES (%s, 'ACCESS', %s, %s)
        """, (user, ip_address, user_agent))
```

#### 2.4.3. å®¡è®¡æ—¥å¿—åˆ†æ

**å®¡è®¡æ—¥å¿—æŸ¥è¯¢**ï¼š

```sql
-- æŸ¥è¯¢ç‰¹å®šç”¨æˆ·çš„æ“ä½œ
SELECT * FROM audit_log
WHERE user_name = 'admin_user'
  AND event_time >= NOW() - INTERVAL 24 HOUR
ORDER BY event_time DESC;

-- æŸ¥è¯¢æ•æ„Ÿæ“ä½œ
SELECT * FROM audit_log
WHERE action IN ('DELETE', 'DROP', 'TRUNCATE')
  AND event_time >= NOW() - INTERVAL 7 DAY;

-- æŸ¥è¯¢å¼‚å¸¸è®¿é—®
SELECT
    user_name,
    ip_address,
    COUNT(*) as access_count
FROM audit_log
WHERE event_time >= NOW() - INTERVAL 1 HOUR
GROUP BY user_name, ip_address
HAVING access_count > 100;
```

### 2.5. ç½‘ç»œå®‰å…¨

#### 2.5.1. ç½‘ç»œéš”ç¦»

**ç½‘ç»œæ¶æ„**ï¼š

```mermaid
graph TB
    Internet[äº’è”ç½‘] --> DMZ[DMZåŒºåŸŸ]
    DMZ --> App[åº”ç”¨å±‚]
    App --> DB[æ•°æ®åº“å±‚]

    DB --> Internal[å†…éƒ¨ç½‘ç»œ]
    Internal --> Backup[å¤‡ä»½ç³»ç»Ÿ]
```

**é˜²ç«å¢™è§„åˆ™**ï¼š

```bash
# åªå…è®¸åº”ç”¨æœåŠ¡å™¨è®¿é—®æ•°æ®åº“
iptables -A INPUT -p tcp --dport 4000 -s 10.0.1.0/24 -j ACCEPT
iptables -A INPUT -p tcp --dport 4000 -j DROP

# å…è®¸ç®¡ç†æœåŠ¡å™¨è®¿é—®
iptables -A INPUT -p tcp --dport 4000 -s 10.0.2.100 -j ACCEPT
```

#### 2.5.2. VPNè®¿é—®

**VPNé…ç½®**ï¼š

```yaml
# OpenVPNé…ç½®
client
dev tun
proto udp
remote vpn.example.com 1194
ca ca.crt
cert client.crt
key client.key
```

### 2.6. æ•°æ®è„±æ•

#### 2.6.1. é™æ€è„±æ•

**æ•°æ®è„±æ•å®ç°**ï¼š

```python
import hashlib
import re

class DataMasking:
    def mask_email(self, email):
        """è„±æ•é‚®ç®±"""
        parts = email.split('@')
        if len(parts) == 2:
            username = parts[0]
            domain = parts[1]
            masked_username = username[0] + '*' * (len(username) - 1)
            return f"{masked_username}@{domain}"
        return email

    def mask_phone(self, phone):
        """è„±æ•æ‰‹æœºå·"""
        if len(phone) >= 11:
            return phone[:3] + '****' + phone[-4:]
        return phone

    def mask_id_card(self, id_card):
        """è„±æ•èº«ä»½è¯å·"""
        if len(id_card) >= 18:
            return id_card[:6] + '*' * 8 + id_card[-4:]
        return id_card

    def hash_sensitive(self, data):
        """å“ˆå¸Œæ•æ„Ÿæ•°æ®"""
        return hashlib.sha256(data.encode()).hexdigest()

# ä½¿ç”¨ç¤ºä¾‹
masking = DataMasking()
masked_email = masking.mask_email("user@example.com")  # u***@example.com
masked_phone = masking.mask_phone("13812345678")  # 138****5678
```

#### 2.6.2. åŠ¨æ€è„±æ•

**åŠ¨æ€è„±æ•å®ç°**ï¼š

```sql
-- åˆ›å»ºè„±æ•è§†å›¾
CREATE VIEW users_masked AS
SELECT
    user_id,
    username,
    CONCAT(LEFT(email, 1), '***', SUBSTRING(email, LOCATE('@', email))) as email,
    CONCAT(LEFT(phone, 3), '****', RIGHT(phone, 4)) as phone
FROM users;

-- æˆäºˆè§†å›¾æƒé™
GRANT SELECT ON users_masked TO 'analyst'@'%';
```

---

## 3. åˆè§„æ ‡å‡†

### 3.1. GDPRåˆè§„

#### 3.1.1. GDPRæ ¸å¿ƒè¦æ±‚

**GDPRä¸»è¦è¦æ±‚**ï¼š

1. **æ•°æ®æœ€å°åŒ–**ï¼šåªæ”¶é›†å¿…è¦çš„æ•°æ®
2. **ç›®çš„é™åˆ¶**ï¼šæ•°æ®åªèƒ½ç”¨äºæŒ‡å®šç›®çš„
3. **æ•°æ®å‡†ç¡®æ€§**ï¼šä¿è¯æ•°æ®å‡†ç¡®
4. **å­˜å‚¨é™åˆ¶**ï¼šæ•°æ®ä¸èƒ½æ— é™æœŸå­˜å‚¨
5. **æ•°æ®ä¸»ä½“æƒåˆ©**ï¼šè®¿é—®ã€æ›´æ­£ã€åˆ é™¤ã€å¯æºå¸¦æƒ

#### 3.1.2. GDPRå®ç°

**æ•°æ®ä¸»ä½“æƒåˆ©å®ç°**ï¼š

```python
class GDPRCompliance:
    def __init__(self, db):
        self.db = db

    def get_user_data(self, user_id):
        """è·å–ç”¨æˆ·æ•°æ®ï¼ˆè®¿é—®æƒï¼‰"""
        return self.db.execute("""
            SELECT * FROM users WHERE user_id = %s
        """, (user_id,))

    def update_user_data(self, user_id, data):
        """æ›´æ–°ç”¨æˆ·æ•°æ®ï¼ˆæ›´æ­£æƒï¼‰"""
        self.db.execute("""
            UPDATE users SET %s WHERE user_id = %s
        """, (data, user_id))

    def delete_user_data(self, user_id):
        """åˆ é™¤ç”¨æˆ·æ•°æ®ï¼ˆåˆ é™¤æƒï¼‰"""
        # è½¯åˆ é™¤
        self.db.execute("""
            UPDATE users SET deleted_at = NOW() WHERE user_id = %s
        """, (user_id,))

        # è®°å½•åˆ é™¤æ—¥å¿—
        self.db.execute("""
            INSERT INTO gdpr_deletion_log (user_id, deleted_at)
            VALUES (%s, NOW())
        """, (user_id,))

    def export_user_data(self, user_id):
        """å¯¼å‡ºç”¨æˆ·æ•°æ®ï¼ˆå¯æºå¸¦æƒï¼‰"""
        data = self.get_user_data(user_id)
        # å¯¼å‡ºä¸ºJSONæ ¼å¼
        return json.dumps(data, indent=2)
```

**æ•°æ®ä¿ç•™ç­–ç•¥**ï¼š

```sql
-- è‡ªåŠ¨åˆ é™¤è¿‡æœŸæ•°æ®
CREATE EVENT delete_old_data
ON SCHEDULE EVERY 1 DAY
DO
  DELETE FROM user_logs
  WHERE created_at < DATE_SUB(NOW(), INTERVAL 2 YEAR);
```

### 3.2. SOXåˆè§„

#### 3.2.1. SOXæ ¸å¿ƒè¦æ±‚

**SOXä¸»è¦è¦æ±‚**ï¼š

1. **è´¢åŠ¡æ•°æ®å®Œæ•´æ€§**ï¼šä¿è¯è´¢åŠ¡æ•°æ®å‡†ç¡®
2. **è®¿é—®æ§åˆ¶**ï¼šé™åˆ¶è´¢åŠ¡æ•°æ®è®¿é—®
3. **å®¡è®¡è¿½è¸ª**ï¼šè®°å½•æ‰€æœ‰è´¢åŠ¡æ“ä½œ
4. **å˜æ›´ç®¡ç†**ï¼šè®°å½•æ‰€æœ‰é…ç½®å˜æ›´

#### 3.2.2. SOXå®ç°

**è´¢åŠ¡æ•°æ®å®¡è®¡**ï¼š

```sql
-- åˆ›å»ºè´¢åŠ¡æ•°æ®å®¡è®¡è¡¨
CREATE TABLE financial_audit (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    transaction_id BIGINT,
    account_id BIGINT,
    amount DECIMAL(15,2),
    transaction_type VARCHAR(50),
    user_name VARCHAR(100),
    ip_address VARCHAR(45),
    event_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    before_value JSON,
    after_value JSON,
    INDEX idx_transaction_id (transaction_id),
    INDEX idx_event_time (event_time)
);

-- åˆ›å»ºå®¡è®¡è§¦å‘å™¨
DELIMITER $$

CREATE TRIGGER audit_financial_update
BEFORE UPDATE ON financial_transactions
FOR EACH ROW
BEGIN
    INSERT INTO financial_audit (
        transaction_id, account_id, amount, transaction_type,
        user_name, before_value, after_value
    ) VALUES (
        NEW.id, NEW.account_id, NEW.amount, NEW.type,
        USER(),
        JSON_OBJECT('amount', OLD.amount, 'status', OLD.status),
        JSON_OBJECT('amount', NEW.amount, 'status', NEW.status)
    );
END$$

DELIMITER ;
```

### 3.3. PCI DSSåˆè§„

#### 3.3.1. PCI DSSæ ¸å¿ƒè¦æ±‚

**PCI DSSä¸»è¦è¦æ±‚**ï¼š

1. **æ•°æ®åŠ å¯†**ï¼šåŠ å¯†å­˜å‚¨å’Œä¼ è¾“
2. **è®¿é—®æ§åˆ¶**ï¼šé™åˆ¶æ”¯ä»˜æ•°æ®è®¿é—®
3. **ç½‘ç»œå®‰å…¨**ï¼šä¿æŠ¤ç½‘ç»œ
4. **ç›‘æ§å’Œæµ‹è¯•**ï¼šæŒç»­ç›‘æ§å’Œæµ‹è¯•

#### 3.3.2. PCI DSSå®ç°

**æ”¯ä»˜æ•°æ®åŠ å¯†**ï¼š

```sql
-- åˆ›å»ºåŠ å¯†æ”¯ä»˜æ•°æ®è¡¨
CREATE TABLE payment_cards (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT,
    card_token VARCHAR(255),  -- åŠ å¯†çš„å¡å·token
    last_four_digits CHAR(4),  -- æœ€å4ä½
    expiry_month TINYINT,
    expiry_year SMALLINT,
    encrypted_cvv VARBINARY(255),  -- åŠ å¯†çš„CVV
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id)
) ENCRYPTION='Y';

-- æ’å…¥åŠ å¯†æ•°æ®
INSERT INTO payment_cards (user_id, card_token, last_four_digits, encrypted_cvv)
VALUES (
    123,
    'tok_1234567890abcdef',  -- ç”±æ”¯ä»˜ç½‘å…³ç”Ÿæˆçš„token
    '1234',
    AES_ENCRYPT('123', 'encryption_key')
);
```

### 3.4. HIPAAåˆè§„

#### 3.4.1. HIPAAæ ¸å¿ƒè¦æ±‚

**HIPAAä¸»è¦è¦æ±‚**ï¼š

1. **è®¿é—®æ§åˆ¶**ï¼šé™åˆ¶åŒ»ç–—æ•°æ®è®¿é—®
2. **å®¡è®¡æ§åˆ¶**ï¼šè®°å½•æ‰€æœ‰è®¿é—®
3. **æ•°æ®åŠ å¯†**ï¼šåŠ å¯†åŒ»ç–—æ•°æ®
4. **ä¼ è¾“å®‰å…¨**ï¼šå®‰å…¨ä¼ è¾“æ•°æ®

### 3.5. å…¶ä»–åˆè§„æ ‡å‡†

**å…¶ä»–é‡è¦åˆè§„æ ‡å‡†**ï¼š

- **ISO 27001**ï¼šä¿¡æ¯å®‰å…¨ç®¡ç†
- **SOC 2**ï¼šæœåŠ¡ç»„ç»‡æ§åˆ¶
- **NIST**ï¼šç¾å›½å›½å®¶æ ‡å‡†ä¸æŠ€æœ¯ç ”ç©¶é™¢æ ‡å‡†

---

## 4. å®é™…ç³»ç»Ÿå®ç°

### 4.1. TiDBå®‰å…¨æœºåˆ¶

**TiDBå®‰å…¨ç‰¹æ€§**ï¼š

1. **èº«ä»½è®¤è¯**ï¼šæ”¯æŒå¯†ç ã€è¯ä¹¦è®¤è¯
2. **æƒé™æ§åˆ¶**ï¼šRBACã€è¡Œçº§å®‰å…¨
3. **æ•°æ®åŠ å¯†**ï¼šTLSä¼ è¾“åŠ å¯†ã€TDEé™æ€åŠ å¯†
4. **å®¡è®¡æ—¥å¿—**ï¼šå®Œæ•´çš„å®¡è®¡æ—¥å¿—

**é…ç½®ç¤ºä¾‹**ï¼š

```yaml
# TiDBå®‰å…¨é…ç½®
[security]
ssl-ca = "/path/to/ca.pem"
ssl-cert = "/path/to/server.pem"
ssl-key = "/path/to/server-key.pem"
enable-tde = true
audit-log = true
```

### 4.2. CockroachDBå®‰å…¨æœºåˆ¶

**CockroachDBå®‰å…¨ç‰¹æ€§**ï¼š

1. **èº«ä»½è®¤è¯**ï¼šè¯ä¹¦è®¤è¯ã€å¯†ç è®¤è¯
2. **æƒé™æ§åˆ¶**ï¼šç»†ç²’åº¦æƒé™æ§åˆ¶
3. **æ•°æ®åŠ å¯†**ï¼šTLSä¼ è¾“åŠ å¯†
4. **å®¡è®¡æ—¥å¿—**ï¼šç»“æ„åŒ–å®¡è®¡æ—¥å¿—

**é…ç½®ç¤ºä¾‹**ï¼š

```bash
# CockroachDBå¯åŠ¨é…ç½®
cockroach start \
  --certs-dir=/certs \
  --listen-addr=0.0.0.0:26257 \
  --advertise-addr=node1:26257 \
  --sql-audit-dir=/var/log/cockroach/audit
```

### 4.3. OceanBaseå®‰å…¨æœºåˆ¶

**OceanBaseå®‰å…¨ç‰¹æ€§**ï¼š

1. **èº«ä»½è®¤è¯**ï¼šå¯†ç è®¤è¯ã€LDAPè®¤è¯
2. **æƒé™æ§åˆ¶**ï¼šRBACã€è¡Œçº§å®‰å…¨
3. **æ•°æ®åŠ å¯†**ï¼šTLSä¼ è¾“åŠ å¯†
4. **å®¡è®¡æ—¥å¿—**ï¼šå®Œæ•´å®¡è®¡æ—¥å¿—

---

## 5. å®‰å…¨æœ€ä½³å®è·µ

### 5.1. å®‰å…¨é…ç½®

**å®‰å…¨é…ç½®æ¸…å•**ï¼š

1. âœ… å¯ç”¨TLS/SSLåŠ å¯†
2. âœ… é…ç½®å¼ºå¯†ç ç­–ç•¥
3. âœ… å¯ç”¨å®¡è®¡æ—¥å¿—
4. âœ… é…ç½®é˜²ç«å¢™è§„åˆ™
5. âœ… å®šæœŸæ›´æ–°ç³»ç»Ÿ
6. âœ… é™åˆ¶ç½‘ç»œè®¿é—®
7. âœ… å¯ç”¨æ•°æ®åŠ å¯†
8. âœ… é…ç½®å¤‡ä»½åŠ å¯†

### 5.2. å®‰å…¨å®¡è®¡

**å®‰å…¨å®¡è®¡æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[æ”¶é›†å®¡è®¡æ—¥å¿—] --> B[åˆ†æå¼‚å¸¸è¡Œä¸º]
    B --> C{å‘ç°å¨èƒ?}
    C -->|æ˜¯| D[è§¦å‘å‘Šè­¦]
    C -->|å¦| E[è®°å½•æ­£å¸¸]
    D --> F[å®‰å…¨å“åº”]
    F --> G[ä¿®å¤é—®é¢˜]
    G --> H[æ›´æ–°ç­–ç•¥]
```

### 5.3. å®‰å…¨ç›‘æ§

**å®‰å…¨ç›‘æ§æŒ‡æ ‡**ï¼š

- **è®¤è¯å¤±è´¥æ¬¡æ•°**ï¼šæ£€æµ‹æš´åŠ›ç ´è§£
- **å¼‚å¸¸è®¿é—®æ¨¡å¼**ï¼šæ£€æµ‹å¼‚å¸¸è¡Œä¸º
- **æƒé™å˜æ›´**ï¼šç›‘æ§æƒé™å˜æ›´
- **æ•°æ®è®¿é—®æ¨¡å¼**ï¼šæ£€æµ‹æ•°æ®æ³„éœ²

---

## 6. å®é™…åº”ç”¨æ¡ˆä¾‹

### 6.1. é‡‘èè¡Œä¸šï¼šNewSQLå®‰å…¨æ¶æ„

**åœºæ™¯**ï¼š

- é«˜å®‰å…¨è¦æ±‚
- ä¸¥æ ¼åˆè§„è¦æ±‚
- å®æ—¶ç›‘æ§éœ€æ±‚

**å®ç°**ï¼š

```yaml
# å®‰å…¨é…ç½®
security:
  authentication:
    method: certificate
    mfa: enabled

  authorization:
    rbac: enabled
    rls: enabled

  encryption:
    tls: enabled
    tde: enabled

  audit:
    enabled: true
    retention: 7years
```

### 6.2. äº’è”ç½‘è¡Œä¸šï¼šåˆ†å¸ƒå¼å®‰å…¨åˆè§„

**åœºæ™¯**ï¼š

- å¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿ
- å¤šç§Ÿæˆ·ç¯å¢ƒ
- æ•°æ®éšç§ä¿æŠ¤

**å®ç°**ï¼š

- å¤šç§Ÿæˆ·éš”ç¦»
- æ•°æ®è„±æ•
- è®¿é—®æ§åˆ¶
- å®¡è®¡æ—¥å¿—

---

## 7. å½¢å¼åŒ–å®šä¹‰

### 7.1. å®‰å…¨æ¨¡å‹å½¢å¼åŒ–

**è®¿é—®æ§åˆ¶æ¨¡å‹**ï¼š

è®¾è®¿é—®æ§åˆ¶æ¨¡å‹ä¸º $AC = (S, O, A, P)$ï¼Œå…¶ä¸­ï¼š

- $S$ï¼šä¸»ä½“é›†åˆï¼ˆç”¨æˆ·ã€è§’è‰²ï¼‰
- $O$ï¼šå®¢ä½“é›†åˆï¼ˆæ•°æ®ã€èµ„æºï¼‰
- $A$ï¼šæ“ä½œé›†åˆï¼ˆSELECTã€INSERTã€UPDATEã€DELETEï¼‰
- $P$ï¼šæƒé™ç­–ç•¥

**è®¿é—®å†³ç­–å‡½æ•°**ï¼š

$$
access(s, o, a) = \begin{cases}
\text{å…è®¸} & \text{if } (s, o, a) \in P \\
\text{æ‹’ç»} & \text{otherwise}
\end{cases}
$$

### 7.2. å®‰å…¨ç­‰çº§å½¢å¼åŒ–

**å®‰å…¨ç­‰çº§å®šä¹‰**ï¼š

$$\text{å®‰å…¨ç­‰çº§} = f(\text{è®¤è¯å¼ºåº¦}, \text{åŠ å¯†å¼ºåº¦}, \text{å®¡è®¡å®Œæ•´æ€§})$$

å…¶ä¸­ï¼š

- è®¤è¯å¼ºåº¦ï¼š$A \in [0, 1]$
- åŠ å¯†å¼ºåº¦ï¼š$E \in [0, 1]$
- å®¡è®¡å®Œæ•´æ€§ï¼š$I \in [0, 1]$

---

## 8. å¤šè¡¨å¾

æœ¬ä¸»é¢˜æ”¯æŒå¤šç§è¡¨å¾æ–¹å¼ï¼š

1. **ç¬¦å·è¡¨å¾**ï¼šå®‰å…¨æ¨¡å‹å…¬å¼ã€æƒé™ç­–ç•¥
2. **å›¾ç»“æ„**ï¼šå®‰å…¨æ¶æ„å›¾ã€è®¿é—®æ§åˆ¶å›¾
3. **ä»£ç å®ç°**ï¼šå®‰å…¨é…ç½®ä»£ç ã€å®¡è®¡ä»£ç 
4. **è‡ªç„¶è¯­è¨€**ï¼šæ¦‚å¿µå®šä¹‰ã€æœ€ä½³å®è·µ
5. **å¯è§†åŒ–**ï¼šå®‰å…¨ç›‘æ§é¢æ¿ã€å®¡è®¡æŠ¥å‘Š

---

## 9. æ€»ç»“ä¸å±•æœ›

### 9.1. æ€»ç»“

NewSQLå®‰å…¨ä¸åˆè§„çš„æ ¸å¿ƒè¦ç‚¹ï¼š

1. **å®‰å…¨æœºåˆ¶**ï¼šèº«ä»½è®¤è¯ã€æƒé™æ§åˆ¶ã€æ•°æ®åŠ å¯†ã€å®¡è®¡æ—¥å¿—
2. **åˆè§„æ ‡å‡†**ï¼šGDPRã€SOXã€PCI DSSã€HIPAA
3. **æœ€ä½³å®è·µ**ï¼šå®‰å…¨é…ç½®ã€å®‰å…¨å®¡è®¡ã€å®‰å…¨ç›‘æ§
4. **å®é™…å®ç°**ï¼šTiDBã€CockroachDBã€OceanBaseç­‰ç³»ç»Ÿ

### 9.2. å‘å±•è¶‹åŠ¿

**æœªæ¥å‘å±•æ–¹å‘**ï¼š

1. **é›¶ä¿¡ä»»æ¶æ„**ï¼šä¸ä¿¡ä»»ä»»ä½•ç½‘ç»œ
2. **AIå®‰å…¨**ï¼šAIé©±åŠ¨çš„å®‰å…¨æ£€æµ‹
3. **è‡ªåŠ¨åŒ–åˆè§„**ï¼šè‡ªåŠ¨åˆè§„æ£€æŸ¥
4. **éšç§è®¡ç®—**ï¼šè”é‚¦å­¦ä¹ ã€åŒæ€åŠ å¯†

---

**å‚è€ƒæ–‡çŒ®**ï¼š

1. GDPR: <https://gdpr.eu/>
2. SOX: <https://www.soxlaw.com/>
3. PCI DSS: <https://www.pcisecuritystandards.org/>
4. TiDB Security: <https://docs.pingcap.com/tidb/stable/security>

---

[è¿”å›NewSQLå¯¼èˆª](README.md)
