# 1.4.8 NewSQLäº‘åŸç”Ÿä¸å®¹å™¨åŒ–éƒ¨ç½²

## ğŸ“‘ ç›®å½•

- [1.4.8 NewSQLäº‘åŸç”Ÿä¸å®¹å™¨åŒ–éƒ¨ç½²](#148-newsqläº‘åŸç”Ÿä¸å®¹å™¨åŒ–éƒ¨ç½²)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1. äº‘åŸç”Ÿå®šä¹‰](#11-äº‘åŸç”Ÿå®šä¹‰)
    - [1.2. å®¹å™¨åŒ–ä¼˜åŠ¿](#12-å®¹å™¨åŒ–ä¼˜åŠ¿)
  - [2. å®¹å™¨åŒ–éƒ¨ç½²](#2-å®¹å™¨åŒ–éƒ¨ç½²)
    - [2.1. Dockerå®¹å™¨åŒ–](#21-dockerå®¹å™¨åŒ–)
      - [2.1.1. DockeråŸºç¡€](#211-dockeråŸºç¡€)
      - [2.1.2. Dockerfileç¼–å†™](#212-dockerfileç¼–å†™)
    - [2.2. å®¹å™¨é•œåƒæ„å»º](#22-å®¹å™¨é•œåƒæ„å»º)
      - [2.2.1. é•œåƒæ„å»ºæœ€ä½³å®è·µ](#221-é•œåƒæ„å»ºæœ€ä½³å®è·µ)
      - [2.2.2. é•œåƒç‰ˆæœ¬ç®¡ç†](#222-é•œåƒç‰ˆæœ¬ç®¡ç†)
    - [2.3. å®¹å™¨ç¼–æ’](#23-å®¹å™¨ç¼–æ’)
      - [2.3.1. Docker Compose](#231-docker-compose)
  - [3. Kuberneteséƒ¨ç½²](#3-kuberneteséƒ¨ç½²)
    - [3.1. KubernetesåŸºç¡€](#31-kubernetesåŸºç¡€)
      - [3.1.1. Kubernetesæ¶æ„](#311-kubernetesæ¶æ„)
      - [3.1.2. æ ¸å¿ƒæ¦‚å¿µ](#312-æ ¸å¿ƒæ¦‚å¿µ)
    - [3.2. StatefulSetéƒ¨ç½²](#32-statefulsetéƒ¨ç½²)
      - [3.2.1. StatefulSetç‰¹ç‚¹](#321-statefulsetç‰¹ç‚¹)
      - [3.2.2. Serviceé…ç½®](#322-serviceé…ç½®)
    - [3.3. Operatoræ¨¡å¼](#33-operatoræ¨¡å¼)
      - [3.3.1. Operatoræ¦‚å¿µ](#331-operatoræ¦‚å¿µ)
      - [3.3.2. TiDB Operator](#332-tidb-operator)
    - [3.4. Helm Chart](#34-helm-chart)
      - [3.4.1. HelmåŸºç¡€](#341-helmåŸºç¡€)
      - [3.4.2. Helméƒ¨ç½²](#342-helméƒ¨ç½²)
  - [4. äº‘åŸç”Ÿæ¶æ„](#4-äº‘åŸç”Ÿæ¶æ„)
    - [4.1. å¾®æœåŠ¡æ¶æ„](#41-å¾®æœåŠ¡æ¶æ„)
      - [4.1.1. å¾®æœåŠ¡æ‹†åˆ†](#411-å¾®æœåŠ¡æ‹†åˆ†)
      - [4.1.2. æœåŠ¡é—´é€šä¿¡](#412-æœåŠ¡é—´é€šä¿¡)
    - [4.2. æœåŠ¡ç½‘æ ¼](#42-æœåŠ¡ç½‘æ ¼)
      - [4.2.1. IstioæœåŠ¡ç½‘æ ¼](#421-istioæœåŠ¡ç½‘æ ¼)
      - [4.2.2. Istioé…ç½®](#422-istioé…ç½®)
    - [4.3. æœåŠ¡å‘ç°](#43-æœåŠ¡å‘ç°)
      - [4.3.1. KubernetesæœåŠ¡å‘ç°](#431-kubernetesæœåŠ¡å‘ç°)
    - [4.4. é…ç½®ç®¡ç†](#44-é…ç½®ç®¡ç†)
      - [4.4.1. ConfigMap](#441-configmap)
      - [4.4.2. Secret](#442-secret)
  - [5. å¼¹æ€§æ‰©å±•](#5-å¼¹æ€§æ‰©å±•)
    - [5.1. æ°´å¹³æ‰©å±•](#51-æ°´å¹³æ‰©å±•)
      - [5.1.1. æ‰‹åŠ¨æ‰©å±•](#511-æ‰‹åŠ¨æ‰©å±•)
      - [5.1.2. è‡ªåŠ¨æ‰©å±•](#512-è‡ªåŠ¨æ‰©å±•)
    - [5.2. è‡ªåŠ¨æ‰©ç¼©å®¹](#52-è‡ªåŠ¨æ‰©ç¼©å®¹)
      - [5.2.1. åŸºäºCPUçš„æ‰©ç¼©å®¹](#521-åŸºäºcpuçš„æ‰©ç¼©å®¹)
      - [5.2.2. åŸºäºè‡ªå®šä¹‰æŒ‡æ ‡çš„æ‰©ç¼©å®¹](#522-åŸºäºè‡ªå®šä¹‰æŒ‡æ ‡çš„æ‰©ç¼©å®¹)
    - [5.3. èµ„æºç®¡ç†](#53-èµ„æºç®¡ç†)
      - [5.3.1. èµ„æºè¯·æ±‚å’Œé™åˆ¶](#531-èµ„æºè¯·æ±‚å’Œé™åˆ¶)
      - [5.3.2. èµ„æºé…é¢](#532-èµ„æºé…é¢)
  - [6. é«˜å¯ç”¨ä¸æ•…éšœæ¢å¤](#6-é«˜å¯ç”¨ä¸æ•…éšœæ¢å¤)
    - [6.1. è‡ªåŠ¨æ•…éšœæ¢å¤](#61-è‡ªåŠ¨æ•…éšœæ¢å¤)
      - [6.1.1. Podé‡å¯ç­–ç•¥](#611-podé‡å¯ç­–ç•¥)
      - [6.1.2. æ•…éšœè½¬ç§»](#612-æ•…éšœè½¬ç§»)
    - [6.2. å¥åº·æ£€æŸ¥](#62-å¥åº·æ£€æŸ¥)
      - [6.2.1. Liveness Probe](#621-liveness-probe)
      - [6.2.2. Readiness Probe](#622-readiness-probe)
    - [6.3. æ»šåŠ¨æ›´æ–°](#63-æ»šåŠ¨æ›´æ–°)
      - [6.3.1. æ»šåŠ¨æ›´æ–°ç­–ç•¥](#631-æ»šåŠ¨æ›´æ–°ç­–ç•¥)
      - [6.3.2. é‡‘ä¸é›€å‘å¸ƒ](#632-é‡‘ä¸é›€å‘å¸ƒ)
  - [7. å®é™…ç³»ç»Ÿéƒ¨ç½²](#7-å®é™…ç³»ç»Ÿéƒ¨ç½²)
    - [7.1. TiDB Kuberneteséƒ¨ç½²](#71-tidb-kuberneteséƒ¨ç½²)
    - [7.2. CockroachDB Kuberneteséƒ¨ç½²](#72-cockroachdb-kuberneteséƒ¨ç½²)
    - [7.3. OceanBase Kuberneteséƒ¨ç½²](#73-oceanbase-kuberneteséƒ¨ç½²)
  - [8. ç›‘æ§ä¸è¿ç»´](#8-ç›‘æ§ä¸è¿ç»´)
    - [8.1. æ—¥å¿—ç®¡ç†](#81-æ—¥å¿—ç®¡ç†)
      - [8.1.1. æ—¥å¿—æ”¶é›†](#811-æ—¥å¿—æ”¶é›†)
    - [8.2. ç›‘æ§é›†æˆ](#82-ç›‘æ§é›†æˆ)
      - [8.2.1. Prometheusç›‘æ§](#821-prometheusç›‘æ§)
    - [8.3. å¤‡ä»½ä¸æ¢å¤](#83-å¤‡ä»½ä¸æ¢å¤)
      - [8.3.1. å¤‡ä»½ç­–ç•¥](#831-å¤‡ä»½ç­–ç•¥)
  - [9. å½¢å¼åŒ–å®šä¹‰](#9-å½¢å¼åŒ–å®šä¹‰)
    - [9.1. äº‘åŸç”Ÿç³»ç»Ÿå½¢å¼åŒ–](#91-äº‘åŸç”Ÿç³»ç»Ÿå½¢å¼åŒ–)
  - [10. å¤šè¡¨å¾](#10-å¤šè¡¨å¾)
  - [11. æ€»ç»“ä¸å±•æœ›](#11-æ€»ç»“ä¸å±•æœ›)
    - [11.1. æ€»ç»“](#111-æ€»ç»“)
    - [11.2. å‘å±•è¶‹åŠ¿](#112-å‘å±•è¶‹åŠ¿)

---

## 1. æ¦‚è¿°

### 1.1. äº‘åŸç”Ÿå®šä¹‰

**äº‘åŸç”Ÿï¼ˆCloud Nativeï¼‰**æ˜¯ä¸€ç§æ„å»ºå’Œè¿è¡Œåº”ç”¨ç¨‹åºçš„æ–¹æ³•ï¼Œå……åˆ†åˆ©ç”¨äº‘è®¡ç®—çš„ä¼˜åŠ¿ï¼š

1. **å®¹å™¨åŒ–**ï¼šä½¿ç”¨å®¹å™¨æ‰“åŒ…åº”ç”¨
2. **å¾®æœåŠ¡**ï¼šåº”ç”¨æ‹†åˆ†ä¸ºå¾®æœåŠ¡
3. **åŠ¨æ€ç¼–æ’**ï¼šä½¿ç”¨ç¼–æ’ç³»ç»Ÿç®¡ç†å®¹å™¨
4. **DevOps**ï¼šæŒç»­é›†æˆå’ŒæŒç»­éƒ¨ç½²

**äº‘åŸç”Ÿæ¶æ„**ï¼š

```mermaid
graph TB
    App[åº”ç”¨] --> Container[å®¹å™¨]
    Container --> Orchestrator[ç¼–æ’ç³»ç»Ÿ]
    Orchestrator --> Cloud[äº‘å¹³å°]

    Cloud --> Compute[è®¡ç®—èµ„æº]
    Cloud --> Storage[å­˜å‚¨èµ„æº]
    Cloud --> Network[ç½‘ç»œèµ„æº]
```

### 1.2. å®¹å™¨åŒ–ä¼˜åŠ¿

**å®¹å™¨åŒ–çš„ä¼˜åŠ¿**ï¼š

1. **ç¯å¢ƒä¸€è‡´æ€§**ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒä¸€è‡´
2. **å¿«é€Ÿéƒ¨ç½²**ï¼šç§’çº§å¯åŠ¨å’Œåœæ­¢
3. **èµ„æºéš”ç¦»**ï¼šè¿›ç¨‹çº§èµ„æºéš”ç¦»
4. **æ˜“äºæ‰©å±•**ï¼šæ°´å¹³æ‰©å±•ç®€å•
5. **ç‰ˆæœ¬ç®¡ç†**ï¼šé•œåƒç‰ˆæœ¬ç®¡ç†

**å¯¹æ¯”ä¼ ç»Ÿéƒ¨ç½²**ï¼š

| ç‰¹æ€§ | ä¼ ç»Ÿéƒ¨ç½² | å®¹å™¨åŒ–éƒ¨ç½² |
|------|---------|-----------|
| **å¯åŠ¨æ—¶é—´** | åˆ†é’Ÿçº§ | ç§’çº§ |
| **èµ„æºåˆ©ç”¨ç‡** | ä½ | é«˜ |
| **ç¯å¢ƒä¸€è‡´æ€§** | éš¾ä¿è¯ | æ˜“ä¿è¯ |
| **æ‰©å±•æ€§** | å¤æ‚ | ç®€å• |
| **ç‰ˆæœ¬ç®¡ç†** | å¤æ‚ | ç®€å• |

---

## 2. å®¹å™¨åŒ–éƒ¨ç½²

### 2.1. Dockerå®¹å™¨åŒ–

#### 2.1.1. DockeråŸºç¡€

**Dockeræ¶æ„**ï¼š

```mermaid
graph TB
    Client[Dockerå®¢æˆ·ç«¯] --> Daemon[Dockerå®ˆæŠ¤è¿›ç¨‹]
    Daemon --> Images[é•œåƒä»“åº“]
    Daemon --> Containers[å®¹å™¨]

    Images --> Registry[é•œåƒæ³¨å†Œè¡¨]
    Containers --> Network[ç½‘ç»œ]
    Containers --> Volume[æ•°æ®å·]
```

#### 2.1.2. Dockerfileç¼–å†™

**TiDB Dockerfileç¤ºä¾‹**ï¼š

```dockerfile
# TiDB Dockerfile
FROM ubuntu:20.04

# å®‰è£…ä¾èµ–
RUN apt-get update && apt-get install -y \
    wget \
    curl \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…TiDB
RUN wget https://download.pingcap.org/tidb-latest-linux-amd64.tar.gz && \
    tar -xzf tidb-latest-linux-amd64.tar.gz && \
    mv tidb-latest-linux-amd64/bin/* /usr/local/bin/ && \
    rm -rf tidb-latest-linux-amd64*

# åˆ›å»ºæ•°æ®ç›®å½•
RUN mkdir -p /var/lib/tidb/data

# æš´éœ²ç«¯å£
EXPOSE 4000 10080

# å¯åŠ¨å‘½ä»¤
CMD ["tidb-server"]
```

**å¤šé˜¶æ®µæ„å»º**ï¼š

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM golang:1.19 AS builder
WORKDIR /app
COPY . .
RUN go build -o tidb-server ./cmd/tidb-server

# è¿è¡Œé˜¶æ®µ
FROM ubuntu:20.04
RUN apt-get update && apt-get install -y ca-certificates
COPY --from=builder /app/tidb-server /usr/local/bin/
CMD ["tidb-server"]
```

### 2.2. å®¹å™¨é•œåƒæ„å»º

#### 2.2.1. é•œåƒæ„å»ºæœ€ä½³å®è·µ

**æœ€ä½³å®è·µ**ï¼š

1. **ä½¿ç”¨å¤šé˜¶æ®µæ„å»º**ï¼šå‡å°é•œåƒå¤§å°
2. **ä½¿ç”¨.dockerignore**ï¼šæ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶
3. **å±‚ç¼“å­˜ä¼˜åŒ–**ï¼šåˆç†å®‰æ’COPYé¡ºåº
4. **ä½¿ç”¨å®˜æ–¹åŸºç¡€é•œåƒ**ï¼šå®‰å…¨å¯é 
5. **æœ€å°åŒ–é•œåƒ**ï¼šåªåŒ…å«å¿…è¦ç»„ä»¶

**.dockerignoreç¤ºä¾‹**ï¼š

```dockerignore
# .dockerignore
.git
.gitignore
*.md
*.log
node_modules
.env
.DS_Store
```

#### 2.2.2. é•œåƒç‰ˆæœ¬ç®¡ç†

**ç‰ˆæœ¬æ ‡ç­¾ç­–ç•¥**ï¼š

```bash
# æ„å»ºé•œåƒ
docker build -t tidb:latest .
docker build -t tidb:v6.5.0 .
docker build -t tidb:v6.5.0-20240116 .

# æ¨é€åˆ°ä»“åº“
docker tag tidb:latest registry.example.com/tidb:latest
docker push registry.example.com/tidb:latest
```

### 2.3. å®¹å™¨ç¼–æ’

#### 2.3.1. Docker Compose

**docker-compose.ymlç¤ºä¾‹**ï¼š

```yaml
version: '3.8'

services:
  pd:
    image: pingcap/pd:latest
    ports:
      - "2379:2379"
    volumes:
      - pd-data:/data
    command:
      - --name=pd1
      - --client-urls=http://0.0.0.0:2379
      - --peer-urls=http://0.0.0.0:2380
      - --data-dir=/data/pd

  tikv:
    image: pingcap/tikv:latest
    ports:
      - "20160:20160"
    volumes:
      - tikv-data:/data
    depends_on:
      - pd
    command:
      - --addr=0.0.0.0:20160
      - --advertise-addr=tikv:20160
      - --pd=pd:2379
      - --data-dir=/data/tikv

  tidb:
    image: pingcap/tidb:latest
    ports:
      - "4000:4000"
      - "10080:10080"
    depends_on:
      - pd
      - tikv
    command:
      - --store=tikv
      - --path=pd:2379

volumes:
  pd-data:
  tikv-data:
```

---

## 3. Kuberneteséƒ¨ç½²

### 3.1. KubernetesåŸºç¡€

#### 3.1.1. Kubernetesæ¶æ„

**Kubernetesç»„ä»¶**ï¼š

```mermaid
graph TB
    Master[MasterèŠ‚ç‚¹] --> API[API Server]
    Master --> Scheduler[Scheduler]
    Master --> Controller[Controller Manager]
    Master --> etcd[etcd]

    Node[NodeèŠ‚ç‚¹] --> Kubelet[Kubelet]
    Node --> Proxy[Kube Proxy]
    Node --> Pod[Pod]

    API --> Kubelet
    Scheduler --> Kubelet
```

#### 3.1.2. æ ¸å¿ƒæ¦‚å¿µ

**Kubernetesæ ¸å¿ƒèµ„æº**ï¼š

1. **Pod**ï¼šæœ€å°éƒ¨ç½²å•å…ƒ
2. **Deployment**ï¼šæ— çŠ¶æ€åº”ç”¨éƒ¨ç½²
3. **StatefulSet**ï¼šæœ‰çŠ¶æ€åº”ç”¨éƒ¨ç½²
4. **Service**ï¼šæœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡
5. **ConfigMap**ï¼šé…ç½®ç®¡ç†
6. **Secret**ï¼šå¯†é’¥ç®¡ç†
7. **PersistentVolume**ï¼šæŒä¹…åŒ–å­˜å‚¨

### 3.2. StatefulSetéƒ¨ç½²

#### 3.2.1. StatefulSetç‰¹ç‚¹

**StatefulSetç‰¹æ€§**ï¼š

1. **ç¨³å®šçš„ç½‘ç»œæ ‡è¯†**ï¼šæ¯ä¸ªPodæœ‰å”¯ä¸€æ ‡è¯†
2. **æœ‰åºéƒ¨ç½²**ï¼šæŒ‰é¡ºåºåˆ›å»ºå’Œåˆ é™¤
3. **æŒä¹…åŒ–å­˜å‚¨**ï¼šæ¯ä¸ªPodæœ‰ç‹¬ç«‹çš„å­˜å‚¨

**StatefulSetç¤ºä¾‹**ï¼š

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: tidb-cluster
spec:
  serviceName: "tidb"
  replicas: 3
  selector:
    matchLabels:
      app: tidb
  template:
    metadata:
      labels:
        app: tidb
    spec:
      containers:
      - name: tidb
        image: pingcap/tidb:latest
        ports:
        - containerPort: 4000
          name: mysql
        - containerPort: 10080
          name: status
        volumeMounts:
        - name: data
          mountPath: /var/lib/tidb
        env:
        - name: PD_ADDRESS
          value: "pd-service:2379"
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 100Gi
```

#### 3.2.2. Serviceé…ç½®

**Serviceç¤ºä¾‹**ï¼š

```yaml
apiVersion: v1
kind: Service
metadata:
  name: tidb-service
spec:
  type: LoadBalancer
  ports:
  - port: 4000
    targetPort: 4000
    protocol: TCP
    name: mysql
  selector:
    app: tidb
```

### 3.3. Operatoræ¨¡å¼

#### 3.3.1. Operatoræ¦‚å¿µ

**Operator**æ˜¯Kubernetesçš„æ‰©å±•ï¼Œç”¨äºç®¡ç†å¤æ‚çš„æœ‰çŠ¶æ€åº”ç”¨ã€‚

**Operatoræ¶æ„**ï¼š

```mermaid
graph TB
    User[ç”¨æˆ·] --> CR[è‡ªå®šä¹‰èµ„æº]
    CR --> Controller[Controller]
    Controller --> K8S[Kubernetes API]
    Controller --> App[åº”ç”¨]

    Controller --> Reconcile[Reconcileå¾ªç¯]
    Reconcile --> Desired[æœŸæœ›çŠ¶æ€]
    Reconcile --> Current[å½“å‰çŠ¶æ€]
```

#### 3.3.2. TiDB Operator

**TiDB Operatoréƒ¨ç½²**ï¼š

```yaml
apiVersion: pingcap.com/v1alpha1
kind: TidbCluster
metadata:
  name: tidb-cluster
spec:
  version: v6.5.0
  pd:
    replicas: 3
    requests:
      storage: "10Gi"
      cpu: 1000m
      memory: 2Gi
  tikv:
    replicas: 3
    requests:
      storage: "100Gi"
      cpu: 2000m
      memory: 4Gi
  tidb:
    replicas: 2
    requests:
      cpu: 1000m
      memory: 2Gi
```

### 3.4. Helm Chart

#### 3.4.1. HelmåŸºç¡€

**Helm**æ˜¯Kubernetesçš„åŒ…ç®¡ç†å·¥å…·ã€‚

**Helm Chartç»“æ„**ï¼š

```text
tidb-chart/
â”œâ”€â”€ Chart.yaml
â”œâ”€â”€ values.yaml
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â””â”€â”€ configmap.yaml
â””â”€â”€ charts/
```

#### 3.4.2. Helméƒ¨ç½²

**ä½¿ç”¨Helméƒ¨ç½²**ï¼š

```bash
# æ·»åŠ Helmä»“åº“
helm repo add pingcap https://charts.pingcap.org
helm repo update

# å®‰è£…TiDB
helm install tidb-cluster pingcap/tidb-cluster \
  --set pd.replicas=3 \
  --set tikv.replicas=3 \
  --set tidb.replicas=2

# å‡çº§
helm upgrade tidb-cluster pingcap/tidb-cluster \
  --set tidb.replicas=3

# å¸è½½
helm uninstall tidb-cluster
```

---

## 4. äº‘åŸç”Ÿæ¶æ„

### 4.1. å¾®æœåŠ¡æ¶æ„

#### 4.1.1. å¾®æœåŠ¡æ‹†åˆ†

**NewSQLå¾®æœåŠ¡æ¶æ„**ï¼š

```mermaid
graph TB
    Gateway[APIç½‘å…³] --> SQL[SQLæœåŠ¡]
    Gateway --> Admin[ç®¡ç†æœåŠ¡]

    SQL --> Query[æŸ¥è¯¢å¼•æ“]
    SQL --> Transaction[äº‹åŠ¡å¼•æ“]

    Query --> Storage[å­˜å‚¨æœåŠ¡]
    Transaction --> Storage

    Storage --> PD[å…ƒæ•°æ®æœåŠ¡]
    Storage --> TiKV[å­˜å‚¨èŠ‚ç‚¹]
```

#### 4.1.2. æœåŠ¡é—´é€šä¿¡

**æœåŠ¡é€šä¿¡æ–¹å¼**ï¼š

1. **åŒæ­¥é€šä¿¡**ï¼šREST APIã€gRPC
2. **å¼‚æ­¥é€šä¿¡**ï¼šæ¶ˆæ¯é˜Ÿåˆ—ã€äº‹ä»¶æ€»çº¿

**gRPCç¤ºä¾‹**ï¼š

```protobuf
// storage.proto
syntax = "proto3";

service StorageService {
  rpc Get(GetRequest) returns (GetResponse);
  rpc Put(PutRequest) returns (PutResponse);
}

message GetRequest {
  string key = 1;
}

message GetResponse {
  bytes value = 1;
}
```

### 4.2. æœåŠ¡ç½‘æ ¼

#### 4.2.1. IstioæœåŠ¡ç½‘æ ¼

**Istioæ¶æ„**ï¼š

```mermaid
graph TB
    App[åº”ç”¨] --> Sidecar[Sidecarä»£ç†]
    Sidecar --> Control[æ§åˆ¶å¹³é¢]

    Control --> Pilot[Pilot]
    Control --> Citadel[Citadel]
    Control --> Galley[Galley]

    Sidecar --> Data[æ•°æ®å¹³é¢]
```

#### 4.2.2. Istioé…ç½®

**VirtualServiceç¤ºä¾‹**ï¼š

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: tidb-service
spec:
  hosts:
  - tidb-service
  http:
  - match:
    - uri:
        prefix: "/"
    route:
    - destination:
        host: tidb-service
        subset: v1
      weight: 90
    - destination:
        host: tidb-service
        subset: v2
      weight: 10
```

### 4.3. æœåŠ¡å‘ç°

#### 4.3.1. KubernetesæœåŠ¡å‘ç°

**æœåŠ¡å‘ç°æœºåˆ¶**ï¼š

1. **DNSæœåŠ¡å‘ç°**ï¼šé€šè¿‡Serviceåç§°è§£æ
2. **ç¯å¢ƒå˜é‡**ï¼šé€šè¿‡ç¯å¢ƒå˜é‡æ³¨å…¥
3. **Service Mesh**ï¼šé€šè¿‡æœåŠ¡ç½‘æ ¼å‘ç°

**DNSæœåŠ¡å‘ç°**ï¼š

```python
import socket

# é€šè¿‡DNSè§£ææœåŠ¡
def get_service_endpoint(service_name, namespace='default'):
    dns_name = f"{service_name}.{namespace}.svc.cluster.local"
    return socket.gethostbyname(dns_name)

# ä½¿ç”¨ç¤ºä¾‹
tidb_host = get_service_endpoint("tidb-service")
```

### 4.4. é…ç½®ç®¡ç†

#### 4.4.1. ConfigMap

**ConfigMapç¤ºä¾‹**ï¼š

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: tidb-config
data:
  config.toml: |
    [log]
    level = "info"

    [performance]
    max-procs = 16
    max-memory = "32GB"
```

**ä½¿ç”¨ConfigMap**ï¼š

```yaml
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: tidb
    image: pingcap/tidb:latest
    volumeMounts:
    - name: config
      mountPath: /etc/tidb
  volumes:
  - name: config
    configMap:
      name: tidb-config
```

#### 4.4.2. Secret

**Secretç¤ºä¾‹**ï¼š

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: tidb-secret
type: Opaque
data:
  password: cGFzc3dvcmQ=  # base64ç¼–ç 
```

---

## 5. å¼¹æ€§æ‰©å±•

### 5.1. æ°´å¹³æ‰©å±•

#### 5.1.1. æ‰‹åŠ¨æ‰©å±•

**æ‰©å±•StatefulSet**ï¼š

```bash
# æ‰©å±•TiDBå®ä¾‹
kubectl scale statefulset tidb-cluster --replicas=5

# æŸ¥çœ‹æ‰©å±•çŠ¶æ€
kubectl get pods -l app=tidb
```

#### 5.1.2. è‡ªåŠ¨æ‰©å±•

**HPAï¼ˆHorizontal Pod Autoscalerï¼‰é…ç½®**ï¼š

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: tidb-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: tidb-cluster
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

### 5.2. è‡ªåŠ¨æ‰©ç¼©å®¹

#### 5.2.1. åŸºäºCPUçš„æ‰©ç¼©å®¹

**CPUæ‰©ç¼©å®¹ç­–ç•¥**ï¼š

```yaml
metrics:
- type: Resource
  resource:
    name: cpu
    target:
      type: Utilization
      averageUtilization: 70
```

#### 5.2.2. åŸºäºè‡ªå®šä¹‰æŒ‡æ ‡çš„æ‰©ç¼©å®¹

**è‡ªå®šä¹‰æŒ‡æ ‡æ‰©ç¼©å®¹**ï¼š

```yaml
metrics:
- type: Pods
  pods:
    metric:
      name: qps
    target:
      type: AverageValue
      averageValue: "1000"
```

### 5.3. èµ„æºç®¡ç†

#### 5.3.1. èµ„æºè¯·æ±‚å’Œé™åˆ¶

**èµ„æºé…ç½®**ï¼š

```yaml
resources:
  requests:
    cpu: 1000m
    memory: 2Gi
  limits:
    cpu: 2000m
    memory: 4Gi
```

#### 5.3.2. èµ„æºé…é¢

**ResourceQuotaç¤ºä¾‹**ï¼š

```yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: tidb-quota
spec:
  hard:
    requests.cpu: "10"
    requests.memory: 20Gi
    limits.cpu: "20"
    limits.memory: 40Gi
    persistentvolumeclaims: "10"
```

---

## 6. é«˜å¯ç”¨ä¸æ•…éšœæ¢å¤

### 6.1. è‡ªåŠ¨æ•…éšœæ¢å¤

#### 6.1.1. Podé‡å¯ç­–ç•¥

**é‡å¯ç­–ç•¥**ï¼š

```yaml
spec:
  restartPolicy: Always  # Always, OnFailure, Never
  containers:
  - name: tidb
    image: pingcap/tidb:latest
```

#### 6.1.2. æ•…éšœè½¬ç§»

**æ•…éšœè½¬ç§»æœºåˆ¶**ï¼š

```mermaid
flowchart TD
    A[Podæ•…éšœ] --> B{å¥åº·æ£€æŸ¥å¤±è´¥}
    B -->|æ˜¯| C[æ ‡è®°ä¸ºä¸å¥åº·]
    C --> D[ä»Serviceç§»é™¤]
    D --> E[åˆ›å»ºæ–°Pod]
    E --> F[æ–°Podå°±ç»ª]
    F --> G[åŠ å…¥Service]
```

### 6.2. å¥åº·æ£€æŸ¥

#### 6.2.1. Liveness Probe

**å­˜æ´»æ¢é’ˆ**ï¼š

```yaml
livenessProbe:
  httpGet:
    path: /status
    port: 10080
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
```

#### 6.2.2. Readiness Probe

**å°±ç»ªæ¢é’ˆ**ï¼š

```yaml
readinessProbe:
  tcpSocket:
    port: 4000
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3
```

### 6.3. æ»šåŠ¨æ›´æ–°

#### 6.3.1. æ»šåŠ¨æ›´æ–°ç­–ç•¥

**æ›´æ–°ç­–ç•¥**ï¼š

```yaml
spec:
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
```

#### 6.3.2. é‡‘ä¸é›€å‘å¸ƒ

**é‡‘ä¸é›€å‘å¸ƒæµç¨‹**ï¼š

```mermaid
flowchart TD
    A[éƒ¨ç½²æ–°ç‰ˆæœ¬] --> B[10%æµé‡]
    B --> C{ç›‘æ§æŒ‡æ ‡}
    C -->|æ­£å¸¸| D[50%æµé‡]
    C -->|å¼‚å¸¸| E[å›æ»š]
    D --> F{ç›‘æ§æŒ‡æ ‡}
    F -->|æ­£å¸¸| G[100%æµé‡]
    F -->|å¼‚å¸¸| E
```

---

## 7. å®é™…ç³»ç»Ÿéƒ¨ç½²

### 7.1. TiDB Kuberneteséƒ¨ç½²

**å®Œæ•´éƒ¨ç½²ç¤ºä¾‹**ï¼š

```yaml
apiVersion: pingcap.com/v1alpha1
kind: TidbCluster
metadata:
  name: tidb-cluster
  namespace: tidb
spec:
  version: v6.5.0
  timezone: UTC
  pvReclaimPolicy: Retain
  enableDynamicConfiguration: true

  pd:
    baseImage: pingcap/pd
    replicas: 3
    requests:
      storage: "10Gi"
      cpu: 1000m
      memory: 2Gi
    limits:
      cpu: 2000m
      memory: 4Gi
    config: |
      [log]
      level = "info"

  tikv:
    baseImage: pingcap/tikv
    replicas: 3
    requests:
      storage: "100Gi"
      cpu: 2000m
      memory: 4Gi
    limits:
      cpu: 4000m
      memory: 8Gi
    config: |
      [log]
      level = "info"

  tidb:
    baseImage: pingcap/tidb
    replicas: 2
    requests:
      cpu: 1000m
      memory: 2Gi
    limits:
      cpu: 2000m
      memory: 4Gi
    config: |
      [log]
      level = "info"
```

### 7.2. CockroachDB Kuberneteséƒ¨ç½²

**CockroachDBéƒ¨ç½²**ï¼š

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: cockroachdb
spec:
  serviceName: "cockroachdb"
  replicas: 3
  template:
    spec:
      containers:
      - name: cockroachdb
        image: cockroachdb/cockroach:latest
        ports:
        - containerPort: 26257
        - containerPort: 8080
        command:
        - /cockroach/cockroach
        - start
        - --join=cockroachdb-0.cockroachdb,cockroachdb-1.cockroachdb,cockroachdb-2.cockroachdb
        - --advertise-host=$(hostname -f)
```

### 7.3. OceanBase Kuberneteséƒ¨ç½²

**OceanBaseéƒ¨ç½²**ï¼š

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: oceanbase
spec:
  serviceName: "oceanbase"
  replicas: 3
  template:
    spec:
      containers:
      - name: oceanbase
        image: oceanbase/oceanbase-ce:latest
        ports:
        - containerPort: 2881
        - containerPort: 2882
```

---

## 8. ç›‘æ§ä¸è¿ç»´

### 8.1. æ—¥å¿—ç®¡ç†

#### 8.1.1. æ—¥å¿—æ”¶é›†

**ä½¿ç”¨Fluentdæ”¶é›†æ—¥å¿—**ï¼š

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentd-config
data:
  fluent.conf: |
    <source>
      @type tail
      path /var/log/tidb/*.log
      pos_file /var/log/fluentd-tidb.log.pos
      tag tidb.*
      format json
    </source>

    <match tidb.**>
      @type elasticsearch
      host elasticsearch.logging.svc.cluster.local
      port 9200
      index_name tidb
    </match>
```

### 8.2. ç›‘æ§é›†æˆ

#### 8.2.1. Prometheusç›‘æ§

**ServiceMonitoré…ç½®**ï¼š

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: tidb-monitor
spec:
  selector:
    matchLabels:
      app: tidb
  endpoints:
  - port: status
    path: /metrics
    interval: 30s
```

### 8.3. å¤‡ä»½ä¸æ¢å¤

#### 8.3.1. å¤‡ä»½ç­–ç•¥

**CronJobå¤‡ä»½**ï¼š

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: tidb-backup
spec:
  schedule: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: backup
            image: pingcap/tidb-backup:latest
            command:
            - /bin/sh
            - -c
            - |
              mysqldump -h tidb-service -u root -p$MYSQL_ROOT_PASSWORD \
                --all-databases > /backup/backup-$(date +%Y%m%d).sql
            volumeMounts:
            - name: backup-volume
              mountPath: /backup
          volumes:
          - name: backup-volume
            persistentVolumeClaim:
              claimName: backup-pvc
```

---

## 9. å½¢å¼åŒ–å®šä¹‰

### 9.1. äº‘åŸç”Ÿç³»ç»Ÿå½¢å¼åŒ–

**äº‘åŸç”Ÿç³»ç»Ÿå®šä¹‰**ï¼š

è®¾äº‘åŸç”Ÿç³»ç»Ÿä¸º $CN = (C, O, S, M)$ï¼Œå…¶ä¸­ï¼š

- $C$ï¼šå®¹å™¨é›†åˆ
- $O$ï¼šç¼–æ’ç³»ç»Ÿ
- $S$ï¼šæœåŠ¡é›†åˆ
- $M$ï¼šç›‘æ§ç³»ç»Ÿ

**å¯ç”¨æ€§å®šä¹‰**ï¼š

$$Availability = 1 - (1 - p)^n$$

å…¶ä¸­ $p$ æ˜¯å•èŠ‚ç‚¹å¯ç”¨æ€§ï¼Œ$n$ æ˜¯èŠ‚ç‚¹æ•°ã€‚

---

## 10. å¤šè¡¨å¾

æœ¬ä¸»é¢˜æ”¯æŒå¤šç§è¡¨å¾æ–¹å¼ï¼š

1. **ç¬¦å·è¡¨å¾**ï¼šå½¢å¼åŒ–å®šä¹‰ã€æ•°å­¦å…¬å¼
2. **å›¾ç»“æ„**ï¼šæ¶æ„å›¾ã€éƒ¨ç½²å›¾
3. **ä»£ç å®ç°**ï¼šYAMLé…ç½®ã€è„šæœ¬ä»£ç 
4. **è‡ªç„¶è¯­è¨€**ï¼šæ¦‚å¿µå®šä¹‰ã€æœ€ä½³å®è·µ
5. **å¯è§†åŒ–**ï¼šç›‘æ§é¢æ¿ã€éƒ¨ç½²è§†å›¾

---

## 11. æ€»ç»“ä¸å±•æœ›

### 11.1. æ€»ç»“

NewSQLäº‘åŸç”Ÿä¸å®¹å™¨åŒ–éƒ¨ç½²çš„æ ¸å¿ƒè¦ç‚¹ï¼š

1. **å®¹å™¨åŒ–**ï¼šDockerå®¹å™¨åŒ–ã€é•œåƒæ„å»º
2. **Kubernetes**ï¼šStatefulSetã€Operatorã€Helm
3. **äº‘åŸç”Ÿæ¶æ„**ï¼šå¾®æœåŠ¡ã€æœåŠ¡ç½‘æ ¼ã€æœåŠ¡å‘ç°
4. **å¼¹æ€§æ‰©å±•**ï¼šæ°´å¹³æ‰©å±•ã€è‡ªåŠ¨æ‰©ç¼©å®¹
5. **é«˜å¯ç”¨**ï¼šæ•…éšœæ¢å¤ã€å¥åº·æ£€æŸ¥ã€æ»šåŠ¨æ›´æ–°

### 11.2. å‘å±•è¶‹åŠ¿

**æœªæ¥å‘å±•æ–¹å‘**ï¼š

1. **Serverless**ï¼šæ— æœåŠ¡å™¨æ¶æ„
2. **è¾¹ç¼˜è®¡ç®—**ï¼šè¾¹ç¼˜éƒ¨ç½²
3. **AIè¿ç»´**ï¼šAIé©±åŠ¨çš„è‡ªåŠ¨åŒ–è¿ç»´
4. **GitOps**ï¼šåŸºäºGitçš„è¿ç»´

---

**å‚è€ƒæ–‡çŒ®**ï¼š

1. Kubernetes Documentation: <https://kubernetes.io/docs/>
2. TiDB Operator: <https://docs.pingcap.com/tidb-in-kubernetes/>
3. Docker Documentation: <https://docs.docker.com/>

---

[è¿”å›NewSQLå¯¼èˆª](README.md)
