# 1.1.55 两阶段提交：可恢复性与阻塞特性证明

## 1. 定义与协议

- 参与者：协调者 C，参与者 \(P_1..P_n\)。
- 阶段：
  1) 准备阶段（`PREPARE`）：C 发送 `PREPARE`，参与者写入预提交日志并返回 `YES/NO`；
  2) 决议阶段（`COMMIT/ABORT`）：若全为 `YES`，C 记录决议并广播 `COMMIT`，否则 `ABORT`。

## 2. 日志与可恢复性

- ARIES 风格WAL：参与者在返回 `YES` 前必须将 `prepare` 记录持久化。
- 可恢复性（Recoverability）：若任一参与者在 `COMMIT` 后崩溃重启，依据日志 `commit` 记录/协调者决议可恢复一致状态；
- 命题：若所有 `YES` 响应均在持久化 `prepare` 后返回，则不存在“已提交但丢失更新”的不可恢复状态。

## 3. 阻塞性（Blocking）

- 经典结论：C 在决议前崩溃，且参与者仅知“我已 `PREPARED`”，无法单方面决定提交或回滚，系统进入阻塞直到C或足够多的副本提供决议。
- 证明要点：为保持一致性，参与者缺乏全局票决信息；任何单方 `COMMIT/ABORT` 选择都可能违背另一个参与者的日志前提。

## 4. 故障情形

- C 崩溃于决议前：阻塞；
- C 崩溃于写入决议后但广播前：依赖仲裁/重复投递恢复；
- P 部分崩溃：依据 `prepare`/`commit` 日志恢复；
- 网络分区：无外部仲裁下可能长期阻塞。

## 5. 证明提纲

- 正确性：
  - 安全性（无分歧）：若某参与者 `COMMIT`，则任何参与者不可能 `ABORT`（由协调者单一决议与幂等重放保证）。
  - 可恢复性：`prepare` 与 `commit` 日志作为恢复点；重放确保最终一致达到同一决议。
- 活性限制：在 `C` 不可用且无共识替代的条件下，2PC 不保证活性（阻塞）。

## 6. 示例（PostgreSQL）

```sql
-- 节点A/B上各有本地事务
BEGIN;  -- 在A
  UPDATE t SET v = v + 1 WHERE id = 1;
PREPARE TRANSACTION 'tx_1';

BEGIN;  -- 在B
  UPDATE t SET v = v + 1 WHERE id = 1;
PREPARE TRANSACTION 'tx_1';

-- 协调者收集YES后
COMMIT PREPARED 'tx_1';  -- 在A
COMMIT PREPARED 'tx_1';  -- 在B
```

## 7. 工程建议

- 避免长时间 `PREPARED`：设置 `max_prepared_transactions` 合理上限并监控；
- 引入共识替代：使用三阶段提交/基于共识（Paxos/Raft）的分布式事务以消除阻塞；
- 幂等操作与补偿：跨系统时优先采用 SAGA 模式（见 `1.1.56`）。
