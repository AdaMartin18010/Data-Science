# 1.1.26 查询语言的形式语义与等价律（纯形式化）

本文件以关系代数为核心，为SQL核心子集给出形式语义、等价律与正确性证明纲要，不涉及工程实现。

## 目录

1. 语法与语义域
2. 语义函数与保形性
3. 基本等价律与证明纲要
4. 连接/选择/投影的重写正确性
5. 聚合与分组的语义片段
6. 规范化与保守扩展

## 1. 语法与语义域

- 关系模式集合记为\(\Sigma\)；每个关系符号\(R\)具备属性域与类型\(\tau\)。
- 表达式产生式（核心）：
  - 基本：\(e ::= R \mid \sigma_\phi(e) \mid \pi_A(e) \mid e_1 \Join_\theta e_2 \mid e_1 \cup e_2 \mid e_1 - e_2\)
- 结果域：\(\llbracket e \rrbracket : D \to \mathcal{I}(R)\)，其中\(D\)为数据库状态。

## 2. 语义函数与保形性

- 定义 2.1（选择语义）：\(\llbracket \sigma_\phi(e) \rrbracket(D) = \{ t\in \llbracket e \rrbracket(D) \mid \phi(t)=\text{true}\}\)。
- 定义 2.2（投影语义）：\(\llbracket \pi_A(e) \rrbracket(D) = \{ t|_A : t\in \llbracket e \rrbracket(D)\}\)。
- 定义 2.3（等值连接）：\(\llbracket e_1 \Join_\theta e_2 \rrbracket(D)=\{ t_1\circ t_2 \mid t_1\in \llbracket e_1 \rrbracket, t_2\in \llbracket e_2 \rrbracket, \theta(t_1,t_2)\}\)。
- 性质 2.4（保形性）：若\(e\)类型良构，则\(\llbracket e \rrbracket(D)\)永为相容元组集合。

## 3. 基本等价律与证明纲要

- 定理 3.1（选择的结合与交换）：\(\sigma_{\phi_1}(\sigma_{\phi_2}(e))\equiv \sigma_{\phi_1\land\phi_2}(e)\equiv \sigma_{\phi_2}(\sigma_{\phi_1}(e))\)。
  - 纲要：由选择谓词布尔代数直接给出。
- 定理 3.2（投影的幂等与收缩）：\(\pi_A(\pi_B(e)) \equiv \pi_{A\cap B}(e)\)。
  - 纲要：投影为属性删减算子，复合即交集。
- 定理 3.3（选择下沉）：若\(\phi\)仅依赖\(e_1\)属性，则\(\sigma_\phi(e_1 \Join e_2) \equiv (\sigma_\phi e_1) \Join e_2\)。
  - 纲要：连接结果中影响\(\phi\)的仅源于\(e_1\)。
- 定理 3.4（连接结合律与交换律）：在等值连接下\((e_1 \Join e_2)\Join e_3 \equiv e_1\Join(e_2\Join e_3)\)，且\(e_1\Join e_2 \equiv e_2\Join e_1\)。

## 4. 连接/选择/投影的重写正确性

- 定义 4.1（语义等价）：\(e_1\equiv e_2\iff \forall D, \llbracket e_1 \rrbracket(D)=\llbracket e_2 \rrbracket(D)\)。
- 定理 4.2（重写正确性充要）：若重写序列\(e\Rightarrow^* e'\)中每步遵循3节等价律，则\(e\equiv e'\)。
  - 纲要：逐步语义保持，合成仍保持。

## 5. 聚合与分组的语义片段

- 定义 5.1（分组语义）：\(\mathsf{GroupBy}_G(e)\)将\(\llbracket e\rrbracket\)按键\(G\)划分等价类\(\{C_i\}\)。
- 定义 5.2（聚合算子）：\(\mathsf{Agg}_f(C)=f(\{v\mid v\in C\})\)，要求\(f\)对多重集良定义。
- 命题 5.3（聚合外推的约束）：聚合与选择/投影的可交换性受\(f\)与谓词属性依赖的限制。

## 6. 规范化与保守扩展

- 定义 6.1（保守扩展）：向语言加入算子\(o\)若对旧表达式\(e\)之语义不变，则为保守扩展。
- 命题 6.2：窗口/排序等扩展在严格限定语义下可视为保守扩展（对旧子语言）。

## 7. 聚合与分组：严格语义与可交换性

### 7.1 严格语义

- 定义 7.1（分组等价类）：给定键 G，\(\mathsf{Part}_G(R)=\{C\subseteq R\mid C\neq\emptyset, \forall t_1,t_2\in C, t_1|_G=t_2|_G\}\)，且这些等价类两两不交并覆盖 R。
- 定义 7.2（聚合算子语义）：给定可测函数 \(f\)（对多重集良定义），\(\mathsf{Agg}_f(C)=v\)。
- 定义 7.3（分组聚合）：\(\mathsf{GB}_G^f(R)=\{ (k, \mathsf{Agg}_f(C_k)) \mid C_k\in \mathsf{Part}_G(R), k = t|_G, t\in C_k \}\)。

### 7.2 可交换性与分配律

- 定理 7.4（选择与聚合的可交换性条件）：若谓词 \(\phi\) 仅依赖于 G 中的属性，且 \(f\) 对被过滤掉的元组不携带侧效应，则
\[ \mathsf{GB}_G^f(\sigma_\phi R) \equiv \sigma_\phi'(\mathsf{GB}_G^f R) \]
其中 \(\phi'\) 为对键域的诱导谓词。
  证明纲要：分组按 G 划分与基于 G 的过滤可交换；聚合仅作用于类内元素，多重集剔除与先验剔除等价。

- 定理 7.5（投影与聚合的相容性）：若投影 \(\pi_A\) 满足 \(G\subseteq A\) 且 \(f\) 仅依赖于 \(A\) 上的属性，则
\[ \mathsf{GB}_G^f(\pi_A R) \equiv \mathsf{GB}_G^f(R) \]
  证明纲要：投影不移除分组键且不去除 \(f\) 所需属性，类内多重集等价。

- 定理 7.6（分组顺序独立性）：若 \(f\) 是交换结合的（如 SUM、COUNT、MIN、MAX），则对任何分区策略的二次分组再聚合与一次聚合等价。
  证明纲要：利用交换结合性将分区的逐段聚合折叠为全体聚合。

### 7.3 聚合与连接

- 命题 7.7：对等值连接 \(R\Join_\theta S\)，若 \(G\subseteq \text{attrs}(R)\) 且 \(f\) 与 \(\theta\) 独立，则
\[ \mathsf{GB}_G^f(R\Join_\theta S) \equiv \mathsf{GB}_G^f(R) \Join_\theta S \]
条件：\(\theta\) 不改变键等价类的基数结构（无一对多扩增影响 f 的可加性）。
