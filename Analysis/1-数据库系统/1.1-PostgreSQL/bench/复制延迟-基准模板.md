# 复制延迟-基准模板

## 1. 目标

- 在主从架构下测量写负载下的复制延迟（byte_lag / time_lag）与RPO影响。

## 2. 方法

- 在主库持续写入（pgbench -N / 自定义批写），从库监测 `pg_stat_replication`；
- 记录 `pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn)`。

## 3. 步骤

```bash
pgbench -N -c 32 -j 32 -T 300 postgres
```

```sql
SELECT application_name, state, sync_state,
       pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) AS byte_lag
FROM pg_stat_replication;
```

## 4. 记录

- 延迟曲线、同步策略变化（ANY N）、网络带宽与IO占用。
