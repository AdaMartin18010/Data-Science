---
title: 混合查询-基准模板
slug: 混合查询-基准模板
tags: []
pg_version: 16
status: draft
last_review: 2025-09-12
owner: TBD
---

# 混合查询-基准模板

## 1. 目标

- 同时覆盖结构化筛选、全文、向量召回的组合性能，度量 TP50/TP95/TP99 与吞吐。

## 2. 数据与脚本

- 参考 `sql/vector_examples.sql` 与全文索引创建；
- 自定义 pgbench 脚本组合：

```sql
-- mix.sql
\set qv '[0.1,0.2,...]'
\set kw 'postgres'
WITH s AS (
  SELECT id, ts_rank(to_tsvector('simple', text), plainto_tsquery('simple', :kw)) AS tr
  FROM docs
  WHERE to_tsvector('simple', text) @@ plainto_tsquery('simple', :kw)
  ORDER BY tr DESC LIMIT 500
), v AS (
  SELECT id, embedding <-> :qv::vector AS dist FROM docs WHERE id IN (SELECT id FROM s) ORDER BY dist ASC LIMIT 100
)
SELECT count(*) FROM v;
```

## 3. 运行

```bash
pgbench -c 32 -j 32 -T 300 -f mix.sql postgres
```

## 4. 记录

- TPS 与延迟分位、CPU/IO、PG 指标；
- 不同 `ivfflat.probes`/HNSW 参数下的曲线。
