# 1.1.49 选择率估计误差：敏感性与上界（纯形式化+工程启示）

## 目录

1. 模型与误差度量
2. 连接顺序敏感性与阈值翻转
3. 代价比上界与失效条件
4. 鲁棒优化（Min–Max/后悔最小化）
5. 工程策略与示例

## 1. 模型与误差度量

- 设基础关系 \(R_1,\dots,R_n\)，谓词集合 \(\{p_j\}_{j=1}^m\)。真实选择率向量 \(s\in[0,1]^m\)，估计为 \(\hat{s}\)。误差 \(e=\hat{s}-s\)。
- 度量：\(\|e\|_\infty \le \varepsilon\) 或加权范数 \(\|W e\|_\infty\le\varepsilon\)。
- 基数函数：\(B(s)\) 给出每个中间结果的行数估计；代价函数 \(C(s)\) 依赖扫描/连接/聚合算子族。

## 2. 连接顺序敏感性与阈值翻转

- 敏感度定义：\(S=\sup_{\|e\|\le\varepsilon} |C(\hat{s})-C(s)|/\varepsilon\)。
- 命题 2.1：左深树在早期连接对选择率误差更敏感；若早期连接放大基数误差，后续代价呈乘性放大。
- 阈值翻转：存在临界 \(\tau\) 使两计划 \(P_1,P_2\) 的代价排序随 \(s\) 穿越 \(\tau\) 而翻转；当 \(\hat{s}\) 跨越 \(\tau\) 时，选择错误计划概率显著上升。

## 3. 代价比上界与失效条件

- 定理 3.1（Lipschitz 上界）：若 \(C\) 对 \(s\) 在域 \(\Omega\) 上 \(L\)-Lipschitz，则 \(\forall s,\hat{s}\in\Omega\)
\[ \frac{C(\hat{s})}{C(s)} \le 1 + \frac{L\,\|e\|}{C(s)}. \]
- 命题 3.2（失效）：当误差使计划选择跨越连接交换/接入路径阈值，局部 Lipschitz 假设不再成立，上界失效；需采用分段上界或鲁棒选择。

## 4. 鲁棒优化（Min–Max/后悔最小化）

- 不确定集：\(\mathcal{U}=\{\hat{s}:\|W(\hat{s}-s_0)\|_\infty\le\varepsilon\}\)。
- Min–Max：\(\min_{P}\max_{\hat{s}\in\mathcal{U}} C_P(\hat{s})\)。
- 最小后悔：\(\min_{P}\max_{\hat{s}\in\mathcal{U}} \big(C_P(\hat{s})-\min_{Q}C_Q(\hat{s})\big)\)。
- 命题 4.1：当存在近邻阈值翻转点时，鲁棒方案优于点估计最优；但可能牺牲部分平均性能。

## 5. 工程策略与示例

- 提升统计质量：提高 `default_statistics_target`，为相关列创建扩展统计（多列NDV/相关性）。
- 表达式/冗余列：为热点谓词创建表达式列与索引，降低估计不确定性。
- 自适应反馈：启用自动 `ANALYZE`，对严重偏差的查询记录真实行数，周期性校准；参见 `02.03-统计信息与代价模型.md`。

```sql
-- 扩展统计（相关性/多列NDV）
CREATE STATISTICS st_emp_dept_salary (dependencies, ndistinct) ON dept_id, salary FROM employees;
ANALYZE employees;

-- 表达式列与索引
ALTER TABLE orders ADD COLUMN status_text text GENERATED ALWAYS AS (status::text) STORED;
CREATE INDEX idx_orders_status_text ON orders(status_text);
```

- 守护阈值：对关键连接选择顺序设置小的 `join_collapse_limit` 以固定稳定方案，或使用物化中间结果降低乘性放大。
- 监控与回归：以 `EXPLAIN (ANALYZE, BUFFERS)` 采集真实基数，与估计对比，记录误差分布以驱动参数与统计策略。

## 6. 交叉引用

- `02-查询处理/02.03-统计信息与代价模型.md`
- `02-查询处理/02.01-查询优化器原理.md`
- `1.1.82-索引选择与代价模型-多目标优化的Pareto最优性.md`
