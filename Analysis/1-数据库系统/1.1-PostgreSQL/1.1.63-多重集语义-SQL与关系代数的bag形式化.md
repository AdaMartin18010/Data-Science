---
title: 1.1.63-多重集语义-SQL与关系代数的bag形式化
slug: 1.1.63-多重集语义-SQL与关系代数的bag形式化
tags: []
pg_version: 16
status: draft
last_review: 2025-09-12
owner: TBD
---

﻿# 1.1.63-多重集语义-SQL与关系代数的bag形式化

## 摘要

- 目标：刻画SQL默认的多重集（bag）语义，给出与集合语义在投影/连接/并/差/聚合上的差异与等价律修正。

## 问题定义（形式化）

- 关系为多重集 R: U→N（键到计数）。运算定义：
  - 投影：计数聚合至投影键；
  - 连接：计数相乘；
  - 并：计数相加；差：计数下界为0的相减。

## 最小示例（可运行）

```sql
-- 去重与不去重的对比
SELECT customer_id FROM orders;           -- bag（可能重复）
SELECT DISTINCT customer_id FROM orders;  -- set（去重）
```

## 实务要点

- 等价律：部分集合代数等价在bag语义下失效，查询重写需考虑计数影响。
- 性能：DISTINCT/聚合去重成本较高；必要时先局部聚合再全局去重。
- 正确性：与窗口函数/CTE交互时注意重复放大效应。

## 交叉引用

- `1.1.39-关系代数与关系演算-科德定理与可表达性.md`
- `1.1.80-查询重写等价性-基于同构的充分必要条件.md`
- `02-查询处理/02.04-查询重写与等价性.md`
