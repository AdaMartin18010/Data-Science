# 1.1.81-并行查询调度-负载均衡与通信代价的最优化

## 摘要

- 目标：在并行执行中平衡工作量与通信/重分布代价，最小化总完成时间（makespan）。

## 问题定义（形式化）

- 给定算子DAG G=(V,E)，每个算子 v 有代价 c(v) 与数据重分布代价 r(e)。在并行度 p 与内存/带宽约束下，求调度 S 使得 makespan(S) 最小。

## 最小示例（可运行）

```sql
-- 启用并行参数（示例值，按环境微调）
SET max_parallel_workers_per_gather = 4;
SET parallel_tuple_cost = 0.1;  -- 降低并行开销阈值
SET parallel_setup_cost = 500;

EXPLAIN (ANALYZE, BUFFERS)
SELECT /*+ Parallel */ c.customer_id, sum(o.amount)
FROM orders o
JOIN customers c ON o.customer_id = c.id
GROUP BY c.customer_id;
```

## 实务要点

- 预分区/局部聚合：先在分区内局部聚合，减少跨节点shuffle。
- 并行度选择：绑定CPU核心与I/O吞吐，避免过度并行导致竞争。
- 大表小表连接：广播小表、对大表按连接键分区以降低重分布代价。

## 交叉引用

- `02-查询处理/02.01-查询优化器原理.md`
- `1.1.59-表分区与分区裁剪-语义与等价.md`
- `1.1.49-选择率估计误差-敏感性与上界.md`
