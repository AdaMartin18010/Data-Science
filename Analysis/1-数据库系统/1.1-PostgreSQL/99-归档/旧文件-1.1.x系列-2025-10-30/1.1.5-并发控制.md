# 并发控制

## 1. 定义

**中文**: 并发控制是数据库系统中管理多个事务同时访问共享数据的机制，确保数据一致性和事务隔离性。

**English**: Concurrency control is a mechanism in database systems that manages multiple transactions accessing shared data simultaneously, ensuring data consistency and transaction isolation.

## 2. 形式化定义

```latex
\newcommand{\lock}{\mathcal{L}}
\newcommand{\trans}{\mathcal{T}}
\newcommand{\resource}{\mathcal{R}}

\lock = \{l_1, l_2, \ldots, l_n\}

其中每个锁 l_i = (r_i, t_i, mode_i) 表示：
- r_i \in \resource: 被锁定的资源
- t_i \in \trans: 持有锁的事务
- mode_i \in \{S, X\}: 锁模式（共享/排他）
```

## 3. 核心属性

- **隔离性**: 并发事务间相互隔离
- **一致性**: 保证数据完整性
- **死锁避免**: 防止死锁发生
- **性能优化**: 最大化并发度

## 4. 理论基础

### 4.1 锁机制理论

```latex
\begin{theorem}[两阶段加锁协议]
事务T满足两阶段加锁协议，当且仅当：
1. 增长阶段：T只能获得锁，不能释放锁
2. 收缩阶段：T只能释放锁，不能获得锁
\end{theorem}
```

### 4.2 MVCC理论

```latex
\begin{theorem}[多版本并发控制]
MVCC通过以下机制实现并发控制：
1. 每个事务看到数据的一致性快照
2. 写操作创建新版本，不阻塞读操作
3. 垃圾回收机制清理过期版本
\end{theorem}
```

## 5. 算法实现

### 5.1 锁机制

```sql
-- 行级锁
SELECT * FROM accounts WHERE account_id = 1001 FOR UPDATE;

-- 共享锁
SELECT * FROM accounts WHERE account_id = 1001 FOR SHARE;

-- 表级锁
LOCK TABLE accounts IN ACCESS EXCLUSIVE MODE;
```

### 5.2 MVCC实现

```sql
-- 事务1：读取数据
BEGIN;
SELECT balance FROM accounts WHERE account_id = 1001;
-- 看到快照版本

-- 事务2：更新数据
BEGIN;
UPDATE accounts SET balance = balance + 100 WHERE account_id = 1001;
COMMIT;

-- 事务1：再次读取（看到旧版本）
SELECT balance FROM accounts WHERE account_id = 1001;
COMMIT;
```

### 5.3 死锁检测

```sql
-- 查看当前锁等待情况
SELECT 
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

## 6. 应用实例

### 6.1 银行账户管理

```sql
-- 安全的转账操作
BEGIN;

-- 锁定转出账户
SELECT balance FROM accounts WHERE account_id = 1001 FOR UPDATE;

-- 锁定转入账户
SELECT balance FROM accounts WHERE account_id = 1002 FOR UPDATE;

-- 执行转账
UPDATE accounts SET balance = balance - 100 WHERE account_id = 1001;
UPDATE accounts SET balance = balance + 100 WHERE account_id = 1002;

COMMIT;
```

### 6.2 库存管理系统

```sql
-- 库存扣减（使用MVCC）
BEGIN;

-- 检查库存（看到快照）
SELECT quantity FROM inventory WHERE product_id = 1001;

-- 扣减库存
UPDATE inventory 
SET quantity = quantity - 1 
WHERE product_id = 1001 AND quantity > 0;

-- 如果更新行数为0，说明库存不足
IF NOT FOUND THEN
    RAISE EXCEPTION '库存不足';
END IF;

COMMIT;
```

## 7. 性能分析

- **锁等待时间**: O(1) 到 O(n)，取决于锁竞争
- **MVCC开销**: O(1) 版本创建，O(n) 垃圾回收
- **死锁检测**: O(n²) 复杂度
- **并发度**: 读操作几乎无阻塞

## 8. 相关概念

- **上位概念**: 事务管理、数据库一致性
- **下位概念**: 锁机制、MVCC、死锁检测
- **平行概念**: 分布式并发控制、乐观并发控制

## 9. 参考文献

1. Gray, J., & Reuter, A. (1993). Transaction processing: concepts and techniques. Morgan Kaufmann.
2. PostgreSQL Global Development Group. (2024). PostgreSQL 16.2 Documentation.

## 10. Wikidata对齐

- **ID**: Q186929 (concurrency control)
- **属性**: database concept, transaction management
- **链接**: <https://en.wikipedia.org/wiki/Concurrency_control>
