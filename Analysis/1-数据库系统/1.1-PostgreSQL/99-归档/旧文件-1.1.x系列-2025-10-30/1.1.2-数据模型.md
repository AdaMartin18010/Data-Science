# 1.1.2-数据模型

> 面向PostgreSQL的数据模型综述：关系模型与扩展类型、约束语义、继承与分区、JSON/JSONB、数组与范围、物化视图与索引、范式与依赖、示例SQL与形式化连接。

## 1. 总览与定位

- 目标：给出PostgreSQL在“关系模型 + 可扩展类型系统”上的完整画像，并与查询优化、事务并发、存储结构形成闭环。
- 读者预备：了解基本SQL、事务概念与数据库范式。
- 关联章节：
  - 架构与实现：`01-核心基础/01.01-系统架构与设计原理.md`
  - 查询优化：`02-查询处理/02.01-查询优化器原理.md`
  - 并发控制：`01-核心基础/01.05-并发控制与MVCC机制.md`
  - 形式理论：`06-形式化理论/06.01-关系代数与演算.md`

## 2. 关系模型与表对象

- 基本对象：`SCHEMA`、`TABLE`、`VIEW`、`MATERIALIZED VIEW`、`SEQUENCE`、`TYPE`、`INDEX`、`CONSTRAINT`。
- 主键与候选键：主键唯一标识元组；候选键可能多于一个，主键是其中被选定者。
- 外键与参照完整性：保持跨表一致性；支持 `ON DELETE/UPDATE` 的 `RESTRICT | CASCADE | SET NULL/DEFAULT`。
- 视图与物化视图：视图为逻辑查询定义；物化视图持久化存储结果，适合OLAP/代价昂贵查询的加速（参见 `1.1.60-物化视图选择-查询重写等价与代价界.md`）。

## 3. 类型系统与可扩展性

- 内置标量：`boolean`、`integer`、`bigint`、`numeric`、`text`、`bytea`、`timestamp/timestamptz`、`date`、`uuid` 等。
- 复合类型：以行结构为模板，可作为列类型或函数返回类型。
- 数组类型：任意基类型可形成数组，支持多维数组与丰富下标、切片操作。
- 范围类型：`int4range`、`int8range`、`numrange`、`tsrange`、`tstzrange`、`daterange`，原生支持重叠、包含、并交等操作符与GiST索引。
- 枚举类型：有序枚举，适合有限状态编码。
- JSON/JSONB：`JSON` 保留原始表示，`JSONB` 以二进制表示支持高效操作、索引与运算符；参见 `1.1.98-数据库JSON数据模型-JSON查询与模式验证的形式化.md`。
- 自定义类型与操作符：通过扩展机制定义新类型、操作符、函数、索引方法（参见 `03-高级特性/03.01-扩展系统与插件开发.md`）。

## 4. 约束与完整性语义

- 主键/唯一：`PRIMARY KEY`、`UNIQUE` 保证键/候选键唯一性，可组合多列。
- 外键：`FOREIGN KEY` 保证参照一致性，需配合索引优化写/读性能。
- 检查约束：`CHECK` 用于列/表级谓词约束；复杂业务规则可借触发器/函数。
- 非空/默认值：`NOT NULL`、`DEFAULT` 提供强类型与安全的缺省策略。
- 排他约束：`EXCLUDE USING gist (...)` 基于GiST的互斥约束，常用于时间/空间排他（与范围、空间类型天然契合）。

## 5. 继承与分区

- 表继承：支持“父-子”表结构的结构化复用，但查询规划上需注意 `ONLY`、`INHERITS` 的可见性与约束聚合。
- 分区表：声明式分区（范围、列表、哈希）；自动分区裁剪提升扫描效率（参见 `1.1.59-表分区与分区裁剪-语义与等价.md`）。
- 全局与本地索引：PostgreSQL为分区表维护分区本地索引；规划需考虑均匀性与热点。

## 6. 索引与访问方法（与数据模型的耦合）

- B-Tree：默认泛用索引；适合等值与有序范围查询。
- GiST：通用平衡树框架；支持范围、空间、全文等相似度或重叠查询。
- GIN：倒排结构；适合文档/数组/JSONB键路径检索与集合包含判定。
- BRIN：块级摘要；适合顺序相关的超大表近似定位。
- 哈希索引：等值查询加速，现代版本已WAL安全。
- 选择与组合：依据数据分布与查询模式选择/组合索引；详见 `02-查询处理/02.02-索引结构与优化.md` 与 `1.1.82-索引选择与代价模型-多目标优化的Pareto最优性.md`。

## 7. JSON/JSONB 数据建模要点

- 模式灵活性：JSONB适合半结构化数据与快速演进的业务域。
- 查询与索引：运算符 `->`、`->>`、`#>`、`@>`、`?`、`?|`、`?&`；GIN 索引支持键存在、路径匹配与包含。
- 校验与约束：结合 `CHECK` 验证关键字段、`jsonschema` 在应用层做模式校验；参见 `1.1.98` 形式化章节。
- 关系/文档混合：将“主事实”建模为关系表、可变属性落地JSONB；关键维度字段冗余列以利于优化器统计与索引选择。

## 8. 范式、依赖与反范式化权衡

- 函数依赖（FD）与范式（1NF/2NF/3NF/BCNF）：减少冗余与更新异常；参见 `1.1.33-关系约束与规范化-函数依赖与范式证明.md`。
- 反范式化：为性能与查询便利引入冗余（物化汇总、派生列）；以触发器、任务或流式管道保证一致性。
- 物化视图与增量维护：参考 `1.1.47-增量物化视图-代数差分与正确性.md` 与 `1.1.60-物化视图选择-查询重写等价与代价界.md`。

## 9. 示例：典型数据建模片段

```sql
-- 9.1 关系+JSONB 混合建模
CREATE TABLE customer (
  id           BIGSERIAL PRIMARY KEY,
  name         TEXT        NOT NULL,
  email        TEXT        UNIQUE,
  profile      JSONB       NOT NULL DEFAULT '{}',
  created_at   TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE INDEX idx_customer_profile_gin ON customer USING gin (profile);

-- 9.2 订单事实与范围/枚举/约束
CREATE TYPE order_status AS ENUM ('pending','paid','shipped','cancelled');
CREATE TABLE orders (
  id           BIGSERIAL PRIMARY KEY,
  customer_id  BIGINT     NOT NULL REFERENCES customer(id) ON DELETE CASCADE,
  amount       NUMERIC(18,2) NOT NULL CHECK (amount >= 0),
  status       order_status  NOT NULL,
  active_during tstzrange    NOT NULL,
  created_at   TIMESTAMPTZ   NOT NULL DEFAULT now()
);
CREATE INDEX idx_orders_active_during_gist ON orders USING gist (active_during);

-- 9.3 分区与裁剪（按月范围）
CREATE TABLE order_items (
  id          BIGSERIAL PRIMARY KEY,
  order_id    BIGINT NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
  sku         TEXT   NOT NULL,
  qty         INTEGER NOT NULL CHECK (qty > 0),
  price       NUMERIC(18,2) NOT NULL CHECK (price >= 0),
  created_at  TIMESTAMPTZ NOT NULL DEFAULT now()
) PARTITION BY RANGE (created_at);

CREATE TABLE order_items_2025_09 PARTITION OF order_items
FOR VALUES FROM ('2025-09-01') TO ('2025-10-01');
CREATE INDEX idx_order_items_2025_09_order_id ON order_items_2025_09(order_id);

-- 9.4 JSONB 关键路径索引（提升常用筛选）
CREATE INDEX idx_customer_profile_pref ON customer USING gin ((profile -> 'preferences'));

-- 9.5 排他约束：同一资源时间区间不可重叠
CREATE TABLE room_booking (
  room_id   BIGINT NOT NULL,
  during    tstzrange NOT NULL,
  user_id   BIGINT NOT NULL,
  EXCLUDE USING gist (room_id WITH =, during WITH &&)
);
```

## 10. 与查询优化/并发/存储的耦合点

- 统计与选择率：数组、JSONB、范围类型的选择率估计对计划选择影响显著（参见 `02.03-统计信息与代价模型.md`、`1.1.49-选择率估计误差-敏感性与上界.md`）。
- 并发与可见性：约束检查与触发器在事务边界/隔离级别下的行为差异（参见 `01.05-并发控制与MVCC机制.md`、`1.1.61-快照隔离异常谱系.md`）。
- 存储布局：TOAST、大列、JSONB二进制结构对I/O与缓存命中率的影响（参见 `01.06-存储管理与数据持久化.md`）。

## 11. 形式化接口（摘要）

- 语义域 \( D \)：关系实例、键依赖、外键依赖、范围/数组/JSONB 结构域。
- 解释函数 \( I: S \to D \)：从模式/约束/查询语法映射到数据语义对象。
- 不变式：主键唯一性、外键闭包、排他约束的互斥性、范围合并的幂等与结合性（参见相应证明章节）。

## 12. 进一步阅读

- `INDEX.md` 与 `README.md` 中的导航与主题索引
- `02-查询处理/` 模块：优化器、索引、统计
- 选读：`1.1.98 JSON`、`1.1.95 图模型`、`1.1.96 时序模型`、`03.06 图数据库功能`
