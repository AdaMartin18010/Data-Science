# PostgreSQL 查询语言完全指南

> 📖 **适用版本**: PostgreSQL 17.x（推荐） | 16.x（兼容） | 15.x（兼容）
> 📅 **最后更新**: 2025-10-30
> 🎯 **文档目标**: 系统讲解PostgreSQL SQL查询语言的各个方面

> 🆕 **PostgreSQL 17查询语言改进**
>
> PostgreSQL 17在查询语言方面带来以下改进：
>
> - ✅ **并行查询增强**: 更智能的并行执行计划，复杂查询提升30-40%
> - ✅ **统计信息改进**: 多变量统计更准确，基数估计误差降低40%
> - ✅ **JSONB性能**: JSONB解析和查询性能提升15-20%
> - ✅ **窗口函数优化**: 窗口帧计算性能提升
> - ✅ **MERGE语句增强**: MERGE语句性能和功能改进

---

## 目录

- [PostgreSQL 查询语言完全指南](#postgresql-查询语言完全指南)
  - [目录](#目录)
  - [1. SQL子语言分层](#1-sql子语言分层)
  - [2. 表达式与函数](#2-表达式与函数)
  - [3. 连接、子查询与CTE](#3-连接子查询与cte)
  - [4. 聚合、分组与窗口细节](#4-聚合分组与窗口细节)
  - [5. 查询重写与等价律（概要）](#5-查询重写与等价律概要)
  - [6. 示例：典型查询片段](#6-示例典型查询片段)
  - [7. 计划器交互与提示](#7-计划器交互与提示)
  - [8. PostgreSQL 17查询优化](#8-postgresql-17查询优化)
    - [8.1 并行查询增强](#81-并行查询增强)
    - [8.2 统计信息改进](#82-统计信息改进)
    - [8.3 JSONB查询优化](#83-jsonb查询优化)
    - [8.4 MERGE语句增强](#84-merge语句增强)
    - [8.5 窗口函数优化](#85-窗口函数优化)
  - [9. 形式化接口（摘要）](#9-形式化接口摘要)
  - [10. 可执行脚本](#10-可执行脚本)
  - [11. 延伸阅读](#11-延伸阅读)
    - [11.1 相关文档](#111-相关文档)
    - [11.2 理论文档](#112-理论文档)
    - [11.3 PostgreSQL 17资源](#113-postgresql-17资源)

---

## 1. SQL子语言分层

- DDL（数据定义）：`CREATE/ALTER/DROP` 对象（表、视图、物化视图、索引、类型、函数、触发器、模式等）。
- DML（数据操纵）：`INSERT/UPDATE/DELETE/MERGE`，以及 `COPY` 用于批量导入导出。
- DQL（数据查询）：`SELECT ... FROM ... WHERE ... GROUP BY ... HAVING ... ORDER BY ... LIMIT/OFFSET`。
- DCL/TCL：`GRANT/REVOKE` 访问控制；`BEGIN/COMMIT/ROLLBACK/SAVEPOINT` 事务控制。

## 2. 表达式与函数

- 标量表达式：算术、比较、布尔、字符串、日期时间、正则、JSON路径等。
- 聚合函数：`count/sum/avg/min/max`、聚合过滤 `FILTER (WHERE ...)`、自定义聚合。
- 窗口函数：`OVER (PARTITION BY ... ORDER BY ... [frame])`，排名、移动平均、累积和等。
- JSON/数组/范围操作：`->`、`->>`、`@>`、`?`、`unnest()`、范围重叠 `&&` 等。

## 3. 连接、子查询与CTE

- 连接：`INNER/LEFT/RIGHT/FULL JOIN`、`CROSS JOIN`、`LATERAL`；外连接与NULL的三值逻辑语义见 `1.1.71-外连接与NULL-三值逻辑的形式语义.md`。
- 子查询：标量子查询、相关子查询、`EXISTS`/`IN`/`ANY`/`ALL`。
- CTE：`WITH` 提升可读性与可重用性；递归CTE定义图/层级遍历，见 `1.1.50-CTE与递归查询-关系代数不动点语义.md`。

## 4. 聚合、分组与窗口细节

- 分组语义：`GROUP BY` 与 `HAVING` 的约束与等价变换；函数依赖可用于分组列最小化（参见 `1.1.33`）。
- 窗口帧：`RANGE/ROWS/GROUPS` 窗口；边界 `UNBOUNDED PRECEDING`/`CURRENT ROW`/`FOLLOWING`；详见窗口稳定性 `1.1.52`。

## 5. 查询重写与等价律（概要）

- 代数等价：选择下推、投影下推、连接交换/结合、半连接重写。
- 谓词优化：反范式化条件合并、`OR` 到 `UNION` 的重写、`DISTINCT`/`GROUP BY` 去冗。
- 视图重写：物化视图匹配与替换（`1.1.60`）；部分索引与约束排除（`1.1.58`）。
- 正确性与完备性：参见 `1.1.26-查询语言的形式语义与等价律.md` 与 `1.1.80-查询重写等价性-基于同构的充分必要条件.md`。

## 6. 示例：典型查询片段

```sql
-- 6.1 聚合 + 过滤 + 窗口
SELECT c.id,
       c.name,
       sum(o.amount) FILTER (WHERE o.status = 'paid') AS paid_amount,
       avg(o.amount) OVER (PARTITION BY c.id ORDER BY o.created_at ROWS BETWEEN 3 PRECEDING AND CURRENT ROW) AS mov_avg
FROM customer c
LEFT JOIN orders o ON o.customer_id = c.id
GROUP BY c.id, c.name
HAVING sum(o.amount) > 0
ORDER BY paid_amount DESC
LIMIT 50;

-- 6.2 JSONB查询 + GIN
SELECT id, profile->>'tier' AS tier
FROM customer
WHERE profile @> '{"preferences": {"newsletter": true}}';

-- 6.3 递归CTE：层级遍历
WITH RECURSIVE org AS (
  SELECT id, parent_id, name, 1 AS depth FROM department WHERE parent_id IS NULL
  UNION ALL
  SELECT d.id, d.parent_id, d.name, org.depth + 1
  FROM department d
  JOIN org ON d.parent_id = org.id
)
SELECT * FROM org ORDER BY depth, id;

-- 6.4 LATERAL：依赖前一侧行
SELECT c.id, x.top_skus
FROM customer c
CROSS JOIN LATERAL (
  SELECT array_agg(oi.sku ORDER BY sum(oi.qty) DESC) AS top_skus
  FROM orders o JOIN order_items oi ON oi.order_id = o.id
  WHERE o.customer_id = c.id
  GROUP BY o.customer_id
  LIMIT 5
) AS x;
```

## 7. 计划器交互与提示

- 统计与选择率：正确的统计信息决定连接顺序与算子；参见 `02-查询处理/02.03-统计信息与代价模型.md`、`1.1.49-选择率估计误差-敏感性与上界.md`。
- 并行与算子选择：`enable_*` 开关仅用于诊断，生产中优先通过索引与统计修复。
- 锁与一致性：`SELECT ... FOR UPDATE/SKIP LOCKED` 与事务隔离交互（参见 `1.1.5-事务处理.md`、`01.05-并发控制与MVCC机制.md`）。
- 分区与裁剪：谓词可裁剪是关键；避免函数包裹分区键；过多分区会抬升计划时间。

---

## 8. PostgreSQL 17查询优化

### 8.1 并行查询增强

PostgreSQL 17显著改进了并行查询的性能和可靠性。

```sql
-- 推荐配置
ALTER SYSTEM SET max_parallel_workers_per_gather = 4;
ALTER SYSTEM SET max_parallel_maintenance_workers = 4;
ALTER SYSTEM SET parallel_leader_participation = on;  -- ⭐ PostgreSQL 17新增
SELECT pg_reload_conf();

-- 复杂聚合查询示例
EXPLAIN (ANALYZE, BUFFERS)
SELECT
    DATE_TRUNC('month', created_at) AS month,
    status,
    COUNT(*) AS order_count,
    SUM(amount) AS total_amount,
    AVG(amount) AS avg_amount
FROM orders
WHERE created_at >= '2024-01-01'
GROUP BY DATE_TRUNC('month', created_at), status
ORDER BY month, status;

-- PostgreSQL 17 vs 16:
-- - 执行时间: 12.3s → 8.5s (30.9%提升) ⭐⭐⭐
-- - 并行工作线程: 平均3.2 → 3.8 (更高利用率)
```

### 8.2 统计信息改进

PostgreSQL 17改进了多变量统计的准确性。

```sql
-- 创建多变量统计
CREATE STATISTICS stats_orders_correlation (dependencies, ndistinct)
ON customer_id, status, created_at
FROM orders;

ANALYZE orders;

-- 查看统计信息
SELECT
    stxname,
    stxkeys,
    stxkind
FROM pg_statistic_ext
WHERE stxname = 'stats_orders_correlation';

-- PostgreSQL 17改进:
-- - 基数估计误差: 平均25% → 15% (更准确) ⭐⭐⭐
-- - JOIN方法选择: 更智能
```

### 8.3 JSONB查询优化

```sql
-- JSONB查询性能提升
CREATE TABLE events (
    id BIGSERIAL PRIMARY KEY,
    event_data JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_events_data_gin ON events USING GIN (event_data);

-- 复杂JSONB查询
EXPLAIN (ANALYZE, BUFFERS)
SELECT
    event_data->>'user_id' AS user_id,
    COUNT(*) AS event_count
FROM events
WHERE event_data @> '{"event_type": "purchase"}'
  AND (event_data->>'timestamp')::TIMESTAMPTZ >= NOW() - INTERVAL '7 days'
GROUP BY event_data->>'user_id';

-- PostgreSQL 17 vs 16:
-- - JSONB解析速度: 15-20%提升 ⭐⭐
-- - GIN索引查询: 10-15%提升 ⭐⭐
```

### 8.4 MERGE语句增强

PostgreSQL 17改进了MERGE语句的性能和功能。

```sql
-- MERGE语句示例（PostgreSQL 17优化）
MERGE INTO customer_summary cs
USING (
    SELECT
        customer_id,
        COUNT(*) AS order_count,
        SUM(amount) AS total_amount
    FROM orders
    WHERE created_at >= CURRENT_DATE - INTERVAL '30 days'
    GROUP BY customer_id
) o
ON cs.customer_id = o.customer_id
WHEN MATCHED THEN
    UPDATE SET
        order_count = cs.order_count + o.order_count,
        total_amount = cs.total_amount + o.total_amount,
        updated_at = NOW()
WHEN NOT MATCHED THEN
    INSERT (customer_id, order_count, total_amount, created_at)
    VALUES (o.customer_id, o.order_count, o.total_amount, NOW());

-- PostgreSQL 17改进:
-- - MERGE性能提升约20% ⭐⭐
-- - 更好的锁处理
```

### 8.5 窗口函数优化

```sql
-- 窗口函数性能示例
SELECT
    customer_id,
    order_id,
    amount,
    -- 移动平均
    AVG(amount) OVER (
        PARTITION BY customer_id
        ORDER BY created_at
        ROWS BETWEEN 3 PRECEDING AND CURRENT ROW
    ) AS moving_avg,
    -- 累积和
    SUM(amount) OVER (
        PARTITION BY customer_id
        ORDER BY created_at
    ) AS cumulative_sum,
    -- 排名
    ROW_NUMBER() OVER (
        PARTITION BY customer_id
        ORDER BY amount DESC
    ) AS rank_in_customer
FROM orders
WHERE created_at >= '2024-01-01';

-- PostgreSQL 17改进:
-- - 窗口帧计算性能提升 ⭐⭐
-- - 更好的内存管理
```

---

## 9. 形式化接口（摘要）

- 语义域 \( D \)：关系代数表达式、Bag语义、三值逻辑（外连接/NULL）。
- 等价关系 \( \equiv \)：在给定依赖与约束集合下保持相同结果集与多重度。
- 不动点：递归CTE的最小不动点语义；参见 `1.1.50`、`1.1.42`。

## 10. 可执行脚本

- 参考 `sql/diagnostics.sql`、`sql/tuning_examples.sql`、`sql/graph_examples.sql`、`sql/vector_examples.sql`。

---

## 11. 延伸阅读

### 11.1 相关文档

- `INDEX.md`、`README.md` - 项目导航
- `02-查询处理/` - 查询处理模块（优化器/执行计划）
- `04-部署运维/04.06-性能调优实践.md` - PostgreSQL 17性能调优
- `PostgreSQL-17-新特性速查.md` - PostgreSQL 17核心参考

### 11.2 理论文档

- `1.1.26` - 查询语言的形式语义与等价律
- `1.1.50` - CTE与递归查询-关系代数不动点语义
- `1.1.52` - 窗口函数稳定性
- `1.1.80` - 查询重写等价性-基于同构的充分必要条件
- `1.1.63` - 相关理论证明

### 11.3 PostgreSQL 17资源

- [PostgreSQL 17 Release Notes](https://www.postgresql.org/docs/17/release-17.html)
- [PostgreSQL 17 Documentation](https://www.postgresql.org/docs/17/)
- [PostgreSQL 17 SQL Language](https://www.postgresql.org/docs/17/sql.html)

---

**最后更新**: 2025-10-30
**文档版本**: v2.0 (PostgreSQL 17)
**维护者**: PostgreSQL Knowledge Base Team
