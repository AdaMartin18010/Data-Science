# 1.1.28 向量检索与Top‑k：数学模型与可近似性证明（纯形式化）

本文件给出向量相似度与Top‑k检索的数学刻画，并讨论近似检索的召回与误差上界。

## 目录

1. 向量空间与相似度
2. Top‑k 的选择算子
3. 归一化与度量等价
4. 近似检索与召回下界
5. 聚类/分桶的误差分析

## 1. 向量空间与相似度

- 定义 1.1：\(\mathcal{V}=\mathbb{R}^n\)；相似度\(\text{sim}:\mathcal{V}\times\mathcal{V}\to \mathbb{R}\)。
- 常用：余弦相似度\(\text{sim}(u,v)=\frac{u\cdot v}{\lVert u\rVert\lVert v\rVert}\)。

## 2. Top‑k 的选择算子

- 定义 2.1：\(\operatorname{Top}_k(q;D)=\operatorname{arg\,top}_k\{\text{sim}(q,x)\mid x\in D\}\)。
- 性质 2.2（稳定性）：若\(\text{sim}\)严格有序且无重值，\(\operatorname{Top}_k\)对微扰在一定阈值内稳定。

## 3. 归一化与度量等价

- 引理 3.1：若\(\lVert u\rVert=\lVert v\rVert=1\)，则最大化\(\text{sim}(u,v)\)等价于最小化\(\lVert u-v\rVert\)。
- 推论 3.2：单位球归一化可将余弦相似转化为欧氏近邻问题。

## 4. 近似检索与召回下界

- 定义 4.1（\(\epsilon\)-近似Top‑k）：返回集合\(A_k\)满足\(\min_{x\in A_k}\text{sim}(q,x)\ge \max_{y\notin A_k}\text{sim}(q,y)-\epsilon\)。
- 定义 4.2（召回率）：\(\text{Recall@}k=\frac{|A_k\cap E_k|}{|E_k|}\)，\(E_k\)为精确Top‑k。
- 定理 4.3（召回下界）：若索引保证\(\epsilon\)-近似且\(\text{sim}\)李普希茨连续，则\(\text{Recall@}k\ge 1-\delta(\epsilon)\)。
  - 纲要：将近似误差转化为边缘样本的置换上界。

## 5. 聚类/分桶的误差分析

- 模型 5.1：分桶半径\(r\)与查询半径\(R\)的重合度决定漏检率上界。
- 定理 5.2：若\(R\ge r+\epsilon\)，则漏检率\(\le \eta(r,\epsilon,n)\)；反之需多桶并查保障召回。

## 6. Top‑k 近似召回界的严格表述

设相似度 \(\text{sim}\) 在单位球上 \(L\)-李普希茨连续，数据集 \(D\subseteq S^{n-1}\)。令精确 Top‑k 为 \(E_k\)，近似返回为 \(A_k\)。

- 定义 6.1（边界间隙）：\(\gamma = \text{sim}(q, x_k) - \text{sim}(q, x_{k+1})\)，其中 \(x_k\) 为精确第 k 名，\(x_{k+1}\) 为第 k+1 名。
- 定理 6.2（误差—召回关系）：若索引保证 \(\epsilon\)-近似，即 \(\min_{x\in A_k}\text{sim}(q,x) \ge \max_{y\notin A_k}\text{sim}(q,y) - \epsilon\)，且 \(\epsilon < \gamma\)，则 \(A_k=E_k\)（召回@k=1）。
  证明：若 \(\epsilon<\gamma\)，任何非真包含会违反下界约束，故集合相等。□

- 定理 6.3（概率性下界）：若对每个候选 \(x\) 的估计相似度 \(\hat{s}(x)\) 满足 \(|\hat{s}(x)-\text{sim}(q,x)| \le \epsilon\) 以概率 \(\ge 1-\delta\)，并对候选独立（或用合取界），则
\[ \Pr[\text{Recall@}k=1] \ge 1 - (|D|-k)\,\delta. \]
  证明纲要：并用界对 k 与其余元素的比较误判概率求和上界。
