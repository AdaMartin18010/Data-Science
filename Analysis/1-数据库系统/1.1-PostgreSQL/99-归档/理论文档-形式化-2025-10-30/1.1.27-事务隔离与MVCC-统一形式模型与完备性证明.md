# 1.1.27 事务隔离与MVCC：统一形式模型与完备性证明（纯形式化）

本文件聚焦事务历史、MVCC可见性、SI/SSI等隔离级别的形式定义、完备性与正确性证明纲要。

## 目录

1. 历史、操作与冲突图
2. MVCC可见性与快照语义
3. SI的性质与写偏差构造
4. SSI的危险结构与打断策略
5. 可串行化的判定与充要条件

## 1. 历史、操作与冲突图

- 定义 1.1（历史）: \(H=\langle op_1,op_2,\dots\rangle\)，其中\(op\in\{r_i(x), w_i(x), c_i, a_i\}\)。
- 定义 1.2（冲突）: 两操作对同一\(x\)且至少一写；\(rw, wr, ww\)三类。
- 定义 1.3（冲突图）: 节点为事务\(T_i\)，若存在\(T_i\to T_j\)之冲突先后，则连边\(i\to j\)。
- 定理 1.4（无环判据）: \(SG(H)\)无环则\(H\)可串行化。

## 2. MVCC可见性与快照语义

- 定义 2.1（版本与区间）: \(V(x)=\{(v, ts_w, ts_d)\mid ts_w<ts_d\}\)。
- 定义 2.2（快照时间）: 事务\(T_i\)取\(s_i\)，可见版本集合为\(\{v\in V(x)\mid ts_w\le s_i<ts_d\}\)。
- 定理 2.3（内部读一致性）: 对任意\(T_i\)，同一\(x\)的读取关于\(s_i\)一致。

## 3. SI的性质与写偏差构造

- 定义 3.1（SI）: 读来自快照；针对同键\(ww\)冲突回滚；允许谓词冲突并发。
- 定理 3.2（SI一致性）: SI下每事务内部满足读一致性；但非全局可串行化。
- 定理 3.3（写偏差存在性）: 存在\(T_1,T_2\)使得谓词依赖分裂于不同键，均判真并提交，导致全局约束违背。
  - 纲要：两护士排班模型：谓词为“至少一人值班”。

## 4. SSI的危险结构与打断策略

- 定义 4.1（危险结构）: 由\(rw\)-依赖链条构成的潜在环，结合\(ww\)边导致周期。
- 定理 4.2（打断充分性）: 若系统确保每个危险结构被至少一次冲突中止打断，则\(SG(H)\)无环。
  - 纲要：反证。若仍有环，则存在未被打断的危险结构，与假设矛盾。

## 5. 可串行化的判定与充要条件

- 定义 5.1（视图等价）: 两历史在每个读操作上读取的版本一致，则视图等价。
- 定理 5.2（充要条件）: 对有限历史，存在与某串行历史视图等价当且仅当\(SG(H)\)无环且无读-写异常。

## 6. SSI 正确性完整证明

本节给出SSI生成历史的冲突图无环性的严格证明。

### 6.1 定义与记号

- 历史 H，事务集合 T；操作 r_i(x), w_i(x), c_i。
- 冲突图 SG(H)：节点为事务；若存在同一项 x 上的冲突且先后发生于 T_i→T_j，则加有向边 i→j。
- 版本可见性与快照时间 s_i 由第2节给出。
- 定义（rw-依赖）：若 T_i 读到由 T_j 写入且对 T_i 可见的版本，则 j→i 为 rw 边。
- 定义（危险结构 dangerous structure）：存在 i→j 的 rw 边且与另一条从 j 起始的依赖链共同可达 k，形成潜在环的充分条件模式（rw、ww、wr 组合）。

直观地，危险结构是形成环路的“未决缺口”。SSI 的核心是在线检测此结构并在提交路径上中止至少一个成员。

### 6.2 引理

- 引理 6.1（环路必含危险结构）：若 SG(H) 含有向环 C，则 C 中必存在一处可被表示为危险结构的片段（含一条 rw 边与其互逆方向的可达性）。
  证明：对环 C 取任一 rw 边 j→i。沿环上与 j→i 同向继续，直至再次可达 i，构成从 j 出发的可达链。由定义得到危险结构。□

- 引理 6.2（中止打断危险结构）：若对每个检测到的危险结构，系统在提交时中止其中至少一个事务，则该危险结构不出现在已提交历史的 SG(H_c) 中。
  证明：被中止事务不存在于 H_c，危险结构的边条件无法同时成立。□

- 引理 6.3（危险结构覆盖性）：若 SG(H_c) 存在环，则至少存在一个尚未被打断的危险结构。
  证明：由引理6.1，环蕴含危险结构；若该结构曾被打断，则其至少含一被中止事务，环不可出现在 H_c，矛盾。□

### 6.3 定理与证明

- 定理 6.4（SSI 正确性——无环性）：若系统确保在提交路径上检测所有危险结构，并对每个危险结构中止至少一个相关事务，则已提交历史 H_c 的冲突图 SG(H_c) 无环，因而 H_c 冲突可串行化。
  证明：反设 SG(H_c) 有环。依引理6.3，存在未被打断的危险结构；与“每个危险结构均被打断”的系统性质矛盾。故 SG(H_c) 无环。由1.4得可串行化。□

- 推论 6.5（隔离级别）：SSI 实现的历史强于 SI，达到冲突可串行化；写偏差被排除。

### 6.4 讨论：完备与健壮

- 检测近似可能导致保守中止，但不影响正确性；只影响活性与吞吐。
- 对读写集合不完全可知的场景，可采用保守拓展（如谓词锁近似）以维持引理6.2成立。
