# 1.1.29 流处理与时间语义：窗口与CEP的形式化（纯形式化）

本文件构建事件时间与处理时间的双时钟模型，给出窗口与CEP模式的形式语义与确定性条件。

## 目录

1. 时间模型：事件时间与处理时间
2. 流与切片：窗口语义
3. CEP模式：有界时间内匹配
4. 确定性与可重复性
5. 时钟漂移与补偿的公理化

## 1. 时间模型：事件时间与处理时间

- 定义 1.1（双时钟）：\(t_e\)为事件时间，\(t_p\)为处理时间；存在映射\(\phi: t_e\mapsto t_p\)表示到达。
- 约束 1.2：乱序上界\(\Delta\)：\(t_p-\phi(t_e)\le \Delta\)。

## 2. 流与切片：窗口语义

- 定义 2.1（事件流）：\(E=\langle (e_i,t_{e,i})\rangle\)。
- 定义 2.2（滚动窗口）：\(W_{\Delta}(\tau)=\{(e_i,t_{e,i})\mid \tau-\Delta < t_{e,i}\le \tau\}\)。
- 性质 2.3：窗口算子对事件时间是单调扩展的（\(\tau\)递增则窗口单调变更）。

## 3. CEP模式：有界时间内匹配

- 定义 3.1（事件正则式）：\(\mathcal{R}\)生成事件类型序列；within约束\(\Theta\)限制持续时长。
- 语义 3.2：\(\mathsf{Match}(\mathcal{R},\Theta;E)\)输出满足顺序与within的切片集合。

## 4. 确定性与可重复性

- 定理 4.1（确定性条件）：在固定事件时间线性序与确定性谓词下，\(\mathsf{Match}\)唯一。
- 定理 4.2（重放可重复）：若重放保持事件时间与到达顺序一致，窗口与匹配结果不变。

## 5. 时钟漂移与补偿的公理化

- 公理 5.1：最大漂移\(\epsilon\)；水位线\(\mathsf{Watermark}(\tau)=\min(t_{e,\text{seen}})-\epsilon\)。
- 命题 5.2：在水位线单调与漂移上界条件下，迟到事件的影响被局部化、且系统终将收敛。

## 6. 窗口/CEP 确定性完整证明

本节在双时钟模型与确定性谓词假设下，给出窗口/CEP匹配结果唯一性的严格证明。

### 6.1 严格定义

- 事件域与全序：设事件集合 E 带有事件时间 \(<_e\) 的全序，且对每一时刻 \(\tau\) 存在前驱界。处理时间仅影响到达顺序，不改变 \(<_e\)。
- 窗口算子：\(W_{\Delta}(\tau)=\{(e,t_e)\in E\mid \tau-\Delta< t_e\le \tau\}\)。
- CEP 正则式语义：给定模式 \(\mathcal{R}\) 与 within 限制 \(\Theta\)，匹配函数 \(\mathsf{Match}_{\mathcal{R},\Theta}(S)\) 将序列 \(S\) 映射为满足约束的切片集合。
- 确定性谓词：谓词族 \(\Phi\) 对任一事件元组给出布尔确定值；无外部状态依赖。

### 6.2 引理

- 引理 6.1（窗口单调）：若 \(\tau_1\le \tau_2\)，则 \(W_{\Delta}(\tau_1)\subseteq W_{\Delta}(\tau_2)\cup B\)，其中 \(B\) 为边界事件集，满足可判别包含（端点决定）。
- 引理 6.2（模式局部性）：对给定 \(\mathcal{R},\Theta\)，匹配仅依赖于 \([\tau-\Theta,\tau]\) 区间内事件的序与谓词值。

### 6.3 定理与证明

- 定理 6.3（唯一性）：在固定的事件时间全序与确定性谓词下，对任一 \(\tau\)，窗口与 CEP 的匹配结果唯一，与处理时间到达顺序无关。
  证明：由引理6.2，匹配只依赖事件时间区间与谓词值；\(<_e\) 与 \(\Phi\) 给定后，归纳于事件个数，增量加入一个事件仅在有限候选处改变布尔结果，因而匹配确定。□

### 6.4 水位线与迟到事件

- 命题 6.4：在水位线 \(\mathsf{Watermark}(\tau)\) 单调且漂移上界成立时，迟到事件对最终匹配的影响被时间上界局部化；系统在有限延迟内收敛。
