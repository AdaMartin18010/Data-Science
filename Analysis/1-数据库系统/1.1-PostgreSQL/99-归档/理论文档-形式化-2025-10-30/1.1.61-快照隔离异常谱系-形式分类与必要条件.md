# 1.1.61-快照隔离异常谱系-形式分类与必要条件

> 目标：系统化刻画 Snapshot Isolation (SI) 下可能出现的异常类别，给出必要条件与反例构造，说明与 PostgreSQL SSI 的关系与工程缓解策略。

## 1. 预备与模型

- SI 定义（简述）：每个事务在开始时获取一个只读快照；写写冲突通过“先提交者获胜”解决；读操作不阻塞写，写可能被冲突拒绝。
- 记号：事务集合 \(\{T_i\}\)，读写集 \(R(T), W(T)\)。`rw` 表示读-写依赖，`ww` 写-写冲突，`wr` 写-读依赖。

## 2. 经典异常家族

- 非可串行化（General Non-Serializability）：存在导致先行图有环的依赖结构，但SI并不总能阻断。
- 写偏斜（Write Skew）：两个事务在相同谓词约束下读对方未提交的旧版本并各自写入不同项，违背全局约束。
- 幻读（Phantom）：在相同谓词下两次查询结果不同，新增/删除满足谓词的元组导致集变化（与谓词锁相关，见 `1.1.48`）。
- 只读事务异常（RO Anomalies）：只读事务在SI下也可能观察到不可串行化的视图（Ports & Grittner 2012）。

## 3. 依赖与必要条件（纲要）

设有事务图 \(G\) 的边：`rw`、`ww`、`wr`。在SI下：

- 必要条件 1（危险结构）：存在两条 `rw` 依赖构成的“危险三角”（rw-antidependency cycles），形成潜在环。
- 必要条件 2（只读参与）：只读事务若位于环的关键位置，亦可形成不可串行化结果（RO anomaly）。
- 必要条件 3（谓词范围）：若约束以谓词形式作用于集合，且未以范围/谓词锁覆盖，则可能构成写偏斜或幻读。

形式片段：若存在事务 \(T_a,T_b,T_c\) 使

\[ T_a \xrightarrow{rw} T_b \xrightarrow{rw} T_c \]

并且存在路径使 \(T_c \leadsto T_a\)（`wr`/`ww`/`rw` 任意组合）闭合，则不可串行化的必要条件成立。

## 4. 写偏斜最小反例

```sql
-- 约束：任一时刻 ICU 值班至少一人
CREATE TABLE shift(doctor text primary key, oncall boolean not null);
INSERT INTO shift VALUES ('A', true), ('B', true);

-- T1: 读 A,B 都为 true -> 更新 A=false
-- T2: 读 A,B 都为 true -> 更新 B=false
-- 若二者并发且均成功提交，约束被破坏
```

- 在SI下，两事务读到旧版本并各自写不同元组，避免了直接 `ww` 冲突。
- 解决：使用显式锁（`SELECT ... FOR UPDATE`）或将约束转化为行级约束/唯一性编码，或使用可串行化级别（SSI）。

## 5. 幻读示意

```sql
-- 谓词：余额 < 0 的账户集合必须为空
-- T1: SELECT COUNT(*) FROM account WHERE balance < 0;  -- = 0
-- T2: INSERT INTO account(id, balance) VALUES (N, -10);
-- T1: SELECT COUNT(*) FROM account WHERE balance < 0;  -- = 1  (幻读)
```

- 在SI下只读视图固定为事务开始时快照；若两次查询跨越事务边界，或在更弱等级中，可能观察到幻读。
- PostgreSQL在可串行化（SSI）级别通过谓词锁与危险结构检测避免导致不可串行化的幻读。

## 6. PostgreSQL 的 SSI 与缓解

- SSI 检测：跟踪 `rw` 反依赖构造危险结构，如检测到潜在环则中止其中一方，打破不可串行化条件。
- 谓词锁：用于保护谓词范围，配合索引范围锁覆盖插入点（见 `1.1.48`）。
- 工程建议：
  - 对写偏斜风险点使用 `FOR UPDATE` 或“归一化为单行约束”的设计。
  - 对集合约束引入物化守卫（如汇总行 + 唯一约束）。
  - 对只读长事务谨慎：必要时升为 SERIALIZABLE，或缩短跨度。

## 7. 检测与测试

- 指标：`serialization_failure`、`predicate locking` 事件、冲突图统计。
- 压测：构造最小反例工作负载，验证在 RC/REPEATABLE READ 与 SERIALIZABLE 下行为差异。

## 8. 交叉引用

- `1.1.27-事务隔离与MVCC-统一形式模型与完备性证明.md`
- `1.1.48-谓词锁与幽灵现象-形式化与消除条件.md`
- `1.1.5-事务处理.md`
