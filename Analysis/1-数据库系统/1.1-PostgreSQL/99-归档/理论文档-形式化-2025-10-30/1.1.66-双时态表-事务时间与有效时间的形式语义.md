# 1.1.66-双时态表-事务时间与有效时间的形式语义

## 摘要

- 目标：为双时态（事务时间 TT 与有效时间 VT）给出统一语义与查询最小实践。

## 问题定义（形式化）

- 元组 r 带区间 [tt_from, tt_to), [vt_from, vt_to)。查询Q在(系统时刻t_sys, 业务时刻 t_bus)上的可见性：
  r 可见 ⇔ tt_from ≤ t_sys < tt_to ∧ vt_from ≤ t_bus < vt_to。

## 最小示例（可运行）

```sql
CREATE TABLE price_bitemporal (
  id bigint,
  price numeric(12,2),
  tt_from timestamptz not null,
  tt_to   timestamptz not null,
  vt_from date not null,
  vt_to   date not null
);

-- 查询业务时刻的有效记录（示例：2025-09-11）
SELECT * FROM price_bitemporal
WHERE vt_from <= date '2025-09-11' AND date '2025-09-11' < vt_to
  AND tt_from <= now() AND now() < tt_to;
```

## 实务要点

- 约束：确保区间不交叠（同id在VT维度）；TT维度由系统写入控制。
- 更新：闭开区间惯例；更新采用“旧记录 tt_to=now() + 新记录插入”。
- 索引：为 vt_from/vt_to 建范围索引；常用查询可用部分索引。

## 交叉引用

- `1.1.71-外连接与NULL-三值逻辑的形式语义.md`
- `1.1.59-表分区与分区裁剪-语义与等价.md`
- `02-查询处理/02.01-查询优化器原理.md`
