# 1.1.25 形式语言与证明：总论（PostgreSQL视角）

本文件专注于知识梳理与模型建构，采用形式化方法对PostgreSQL相关主题进行定义、定理与证明（或证明纲要），不涉及工程实现与代码示例。

## 目录

0. 方法论与符号约定
1. 数据库状态与查询语义的形式化
2. 事务与隔离模型（含MVCC/SI/SSI）
3. 日志与恢复的正确性抽象
4. 查询优化的等价变换与代价模型
5. 向量检索的数学模型（相似度与Top‑k）
6. 流处理与时间模型（窗口与CEP语义）
7. 安全与合规的逻辑框架（访问控制与脱敏）
8. 分布式一致性与可用性权衡
9. 形式化验证建议（TLA+等）
附录：符号表

## 0. 方法论与符号约定

- 语义域：采用集合论、关系代数与时态逻辑；必要处使用概率与优化理论。
- 记号：\(\mathbb{N}\) 自然数，\(\mathbb{R}\) 实数；\(\mathcal{P}(X)\) 为幂集；\(\Sigma\) 为模式；\(R\) 为关系；\(\Gamma\) 为约束集。
- 正确性标准：定义→引理→定理→推论；证明以严谨性为先，必要时给出“证明纲要”。
- 范围与成熟度：本文件内容标注为[Core理论]与[抽象模型]，不讨论实现细节。

## 1. 数据库状态与查询语义的形式化

### 1.1 模式与实例

- 定义 1.1（关系模式）: 一个数据库模式记作 \(\Sigma = \{R_i(A_{i1}:\tau_{i1},\dots,A_{ik}:\tau_{ik})\}_i\)。
- 定义 1.2（数据库实例）: 在给定模式 \(\Sigma\) 上，数据库状态 \(D\) 为各关系实例的笛卡尔积：\(D=\prod_i \mathcal{I}(R_i)\)。

### 1.2 关系代数与（核心）SQL语义

- 定义 1.3（关系代数表达式）: 由选择 \(\sigma\)、投影 \(\pi\)、重命名 \(\rho\)、自然连接 \(\Join\)、差集 \(-\)、并集 \(\cup\) 等构成的表达式 \(e\)。
- 定义 1.4（语义函数）: \(\llbracket e \rrbracket : D \to \mathcal{I}(R)\) 给出表达式在状态 \(D\) 下的结果。
- 定理 1.5（选择下沉的正确性）: 若谓词 \(\phi\) 仅涉及关系 \(R\) 的属性，则 \(\sigma_\phi(R \Join S) \equiv (\sigma_\phi R) \Join S\)。
  证明纲要：利用自然连接定义与集合分配律成立性。
- 定理 1.6（连接结合律）: \((R \Join S) \Join T \equiv R \Join (S \Join T)\)。
  证明纲要：基于等值连接的等价性与解构同构（isomorphism）。

## 2. 事务与隔离模型（含MVCC/SI/SSI）

### 2.1 历史、冲突与可串行化

- 定义 2.1（历史与操作）: 历史 \(H\) 为有序操作序列，操作含 \(r_i(x), w_i(x), c_i, a_i\)。
- 定义 2.2（冲突可串行化）: 若 \(SG(H)\) 冲突图无环，则 \(H\) 与某串行历史等价。
- 定理 2.3（无环蕴含可串行化）: 若 \(SG(H)\) 无环，则 \(H\) 冲突可串行化。
  证明纲要：拓扑排序构造对应的串行顺序。

### 2.2 MVCC 版本模型

- 定义 2.4（版本）: 对每逻辑项 \(x\)，维护版本集合 \(V(x)=\{(v, ts_w, ts_d)\}\)，其中 \(ts_w<ts_d\) 表示写入与删除（或失效）时间戳。
- 定义 2.5（可见性）: 事务 \(T_i\) 的快照时间 \(s_i\)，其读取 \(x\) 时可见版本集为 \(\{v\in V(x)\mid ts_w\le s_i < ts_d\}\)。
- 定理 2.6（快照读一致性）: 在MVCC下，任意事务 \(T_i\) 读取同一项的结果关于其快照时间一致。
  证明纲要：可见性区间唯一覆盖性保证读取确定性。

### 2.3 Snapshot Isolation（SI）与写偏差

- 定义 2.7（SI）: 事务在启动时捕获快照；写-写冲突（同一逻辑项）导致事务回滚；读取来自快照。
- 定理 2.8（SI的读一致性）: 在SI下，任一事务内部读为单调一致（与快照一致）。
- 定理 2.9（写偏差可能性）: 存在谓词相关但不同键的写入，使得 \(T_1,T_2\) 分别判断约束成立并提交，从而违反全局谓词约束（写偏差）。
  证明纲要：构造典型两护士排班问题的反例。

### 2.4 Serializable Snapshot Isolation（SSI）

- 定义 2.10（危险结构）: \(rw\)-依赖与 \(ww\)-依赖的组合产生环的充分条件称为危险结构。
- 定理 2.11（SSI正确性）: 若系统检测并打破所有危险结构，则产生的历史冲突可串行化。
  证明纲要：对冲突图环路进行反证，显示每个潜在环被至少一处打断。

## 3. 日志与恢复的正确性抽象

- 定义 3.1（WAL约束）: 每一持久化数据页的更新，必须在对应日志记录持久化之后发生。
- 定理 3.2（崩溃恢复可达性）: 若WAL约束满足，系统可在崩溃后通过重做与回滚达到一致状态 \(D'\)。
  证明纲要：基于前滚-回滚（REDO/UNDO）与检查点不变式。

## 4. 查询优化的等价变换与代价模型

- 定义 4.1（代价模型）: \(\text{COST}(e,D)=f(\text{card},\text{sel},\text{cpu},\text{io})\) ，其中 \(\text{card}\) 为基数估计，\(\text{sel}\) 为选择率。
- 定理 4.2（等价变换保持语义）: 对于一组RA等价律 \(\mathcal{E}\)，若 \(e_1 \xleftrightarrow{\mathcal{E}} e_2\)，则 \(\forall D, \llbracket e_1 \rrbracket(D)=\llbracket e_2 \rrbracket(D)\)。
  证明纲要：对 \(\mathcal{E}\) 中基本律逐一归纳，保持性由集合代数公理保证。
- 推论 4.3（最优计划存在性）: 在有限计划空间与非负代价下，存在最小代价计划 \(e^*\)。

## 5. 向量检索的数学模型（相似度与Top‑k）

- 定义 5.1（向量空间与相似度）: 设 \(\mathcal{V}=\mathbb{R}^n\)，相似度 \(\text{sim}:\mathcal{V}\times\mathcal{V}\to\mathbb{R}\)。常用：余弦相似度 \(\text{sim}(u,v)=\frac{u\cdot v}{\lVert u\rVert\lVert v\rVert}\)。
- 定义 5.2（Top‑k 近邻）: 对查询向量 \(q\)，Top‑k 结果为 \(\operatorname{arg\,top}_k\{\text{sim}(q,x)\mid x\in D\}\)。
- 定义 5.3（召回率）: 设近似集合 \(A_k\) 与精确集合 \(E_k\)，则 \(\text{Recall@}k=\frac{|A_k\cap E_k|}{|E_k|}\)。
- 引理 5.4（余弦与距离等价）: 在单位球面上，最大化余弦相似度等价于最小化欧氏距离。
  证明纲要：利用 \(\lVert u-v\rVert^2=\lVert u\rVert^2+\lVert v\rVert^2-2u\cdot v\)。
- 命题 5.5（非度量性）: 余弦相似度本身非度量，三角不等式对 \(1-\text{sim}\) 不总成立；对索引正确性需采用近似保证（如概率性召回下界）。

## 6. 流处理与时间模型（窗口与CEP语义）

- 定义 6.1（事件流）: \(E=\langle (e_i, t_i)\rangle_{i\in\mathbb{N}}\)，其中 \(t_i\) 为时间戳，满足单调非降。
- 定义 6.2（窗口算子）: 时间窗口 \(W_{\Delta}(t)=\{(e_i,t_i)\mid t-\Delta < t_i \le t\}\)。滑动窗口为离散时间上的序列 \(\{W_{\Delta}(t_j)\}\)。
- 定义 6.3（CEP模式语义）: 事件正则式 \(\mathcal{R}\) 的匹配为将流切片到满足顺序与约束的子序列集合，"within" 约束为 \(\max t_i-\min t_i\le \Theta\)。
- 定理 6.4（确定性）: 在固定时间线性化与确定性谓词下，窗口与CEP匹配结果唯一。
  证明纲要：由时间线性序与谓词布尔确定性导出匹配唯一性。

## 7. 安全与合规的逻辑框架（访问控制与脱敏）

- 定义 7.1（策略函数）: \(P: U\times A\times R\times C \to \{\text{true},\text{false}\}\)，判定用户-动作-资源-上下文是否允许。
- 定义 7.2（脱敏函数）: \(M: R\times U\times C \to R'\)，在不违反策略的前提下最小化信息泄露。
- 定理 7.3（非干扰性）: 若对于任意未授权用户 \(u\)，存在抽象函数 \(h\) 使得 \(h(M(r,u,c))=h(r)\)，则对 \(u\) 的观察等价于抽象视图，满足非干扰。
  证明纲要：构造观测等价关系并证明不区分性。

## 8. 分布式一致性与可用性权衡

- 定义 8.1（复制语义）: 强一致复制保证线性化；最终一致复制保证在无更新的极限下状态一致。
- 命题 8.2（CAP直觉版）: 在网络分区下，强一致与可用性不可兼得（在给定同步API下）。
- 定理 8.3（线性化可判别性）: 若操作历史满足单调读写与实时顺序保序，则可判定线性化。
  证明纲要：构造顺序并验证一致性序与实时序的兼容性。

## 9. 形式化验证建议（TLA+等）

- 建模纲要：
  1) 状态变量：数据项、版本、锁/依赖、日志LSN、时间；
  2) 动作：开始、读、写、提交、回滚、崩溃、恢复；
  3) 不变式：可见性不变式、WAL先写、冲突图无环（SSI）；
  4) 性质：安全性（永不违反）、活性（终将提交/回收）。
- 建议：针对第2节与第3节分别给出TLA+模块，利用模型检查检验小规模反例与不变式保持性。

---

附录：符号表（节选）

- \(\Sigma\)：模式；\(D\)：数据库状态；\(e\)：代数表达式；\(\llbracket e \rrbracket\)：语义函数
- \(H\)：历史；\(SG(H)\)：冲突图；\(s_i\)：快照时间；\(V(x)\)：版本集合
- \(\text{sim}\)：相似度；\(Top\text{-}k\)：前k个最近邻；\(W_\Delta\)：窗口；\(\mathcal{R}\)：CEP正则模式
- \(P\)：策略函数；\(M\)：脱敏函数；线性化/最终一致：分布式一致性关系
