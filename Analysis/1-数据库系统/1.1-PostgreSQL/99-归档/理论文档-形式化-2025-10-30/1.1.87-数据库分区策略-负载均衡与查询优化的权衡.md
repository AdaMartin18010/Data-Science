# 1.1.87-数据库分区策略-负载均衡与查询优化的权衡

## 摘要

- 目标：在读写负载、查询裁剪、维护成本之间取得平衡，给出可操作的分区策略选择准则与最小实践。

## 问题定义（形式化）

- 给定关系 R 与时间/范围/哈希等候选分区函数集合 {f_k}，定义查询集合 {Q_i} 的裁剪收益 Gain(Q_i, f_k) 与维护成本 Maint(R, f_k)。
- 在资源约束（存储、重建窗口）下，最大化 Σ_i Gain(Q_i, f) − λ · Maint(R, f)，求最优 f 与分区粒度 g。

## 最小示例（可运行）

```sql
-- 1) 创建按月范围分区
CREATE TABLE orders (
  id BIGSERIAL PRIMARY KEY,
  created_at DATE NOT NULL,
  customer_id BIGINT NOT NULL,
  amount NUMERIC(12,2) NOT NULL
) PARTITION BY RANGE (created_at);

CREATE TABLE orders_2025_09 PARTITION OF orders
  FOR VALUES FROM ('2025-09-01') TO ('2025-10-01');

-- 2) 查询自动分区裁剪（仅扫描相关分区）
EXPLAIN SELECT count(*) FROM orders
WHERE created_at >= '2025-09-01' AND created_at < '2025-10-01';

-- 3) 维护示例：掉历史分区，降低存储与索引维护
ALTER TABLE orders DETACH PARTITION orders_2025_09;  -- 或直接 DROP PARTITION
```

## 实务要点

- 选择分区键：首先匹配最高频筛选列（通常为时间），并与归档/冷热分层策略一致。
- 粒度与数量：控制分区数在可管理范围（数十至低百），避免计划器开销过大。
- 索引与约束：仅为热点分区建立重型索引；全局约束通过分区约束与应用保证。

## 交叉引用

- `1.1.59-表分区与分区裁剪-语义与等价.md`
- `1.1.82-索引选择与代价模型-多目标优化的Pareto最优性.md`
- `1.1.16-性能调优与监控.md`
