## 验证闭环

- 快速参考：见[`00-项目导航/验证闭环模板.md`](00-项目导航/验证闭环模板.md)
- 推荐在`sandbox` schema执行以保持幂等与可回滚，通用断言示例：

```bash
psql -h localhost -U postgres -d postgres -v ON_ERROR_STOP=1 \
  -c "\\dt+ sandbox.*" \
  -c "\\df+ sandbox.*" \
  -c "SELECT 'rewrite_equivalence_ok' AS tag;"
```

- 诊断脚本（可选）：

```bash
psql -h localhost -U postgres -d postgres -v ON_ERROR_STOP=1 -f "Analysis/1-数据库系统/1.1-PostgreSQL/sql/diagnostics.sql"
```

---
title: 1.1.80-查询重写等价性-基于同构的充分必要条件
slug: 1.1.80-查询重写等价性-基于同构的充分必要条件
tags: []
pg_version: 16
status: draft
last_review: 2025-09-12
owner: TBD
---

﻿# 1.1.80 查询重写等价性：基于同构的充分必要条件

## 1. 查询图模型

- 将 SPJG（选择-投影-连接-聚合）查询映射为有标注的查询图 \(G_Q=(V,E,\lambda)\)：
  - 顶点：关系/子查询；
  - 边：连接条件（等值/不等/外连接附条件）；
  - 标注：选择谓词、投影属性、分组/聚合。

## 2. 等价性判定（轮廓）

- 充要条件（概要）：存在图同构 \(h: G_{Q_1} \to G_{Q_2}\) 使得：
  1) 连接结构保持（边到边，谓词等价）；
  2) 选择谓词在 \(h\) 下等价；
  3) 投影与重命名一致；
  4) 分组键与聚合算子在等价类内匹配；
  5) Bag 语义下额外要求去重/多重度等价（参见 `1.1.63`）。

- 外连接限制：对 `LEFT/RIGHT/FULL` 需要三值逻辑一致性与可下推性的约束（参见 `1.1.71`）。

## 3. 包含与重写

- 视图包含：\(Q \preceq V\) 若存在映射使 \(Q\) 的结果可由 \(V\) 经选择/投影/重命名获得；
- Backchase：在依赖（FD/PK-FK）下通过Chase/Backchase 构造最小重写；
- 物化视图重写：与 `1.1.60` 结合以评估代价与可行重写。

## 4. 示例

```sql
-- Q1: 三表连接
SELECT a.id, sum(o.amount)
FROM accounts a
JOIN orders o ON o.account_id = a.id
JOIN regions r ON r.id = a.region_id
WHERE r.code = 'APAC'
GROUP BY a.id;

-- Q2: 将地区选择下推至 accounts 并以等价投影重命名
SELECT a.id, sum(o.amount) AS s
FROM (SELECT * FROM accounts WHERE region_id IN (SELECT id FROM regions WHERE code='APAC')) a
JOIN orders o ON o.account_id = a.id
GROUP BY a.id;
```

- 在查询图上：`regions` 过滤等价于在 `accounts` 上的等价选择（依据FK与谓词等价），连接结构与聚合一致，因而等价。

## 5. 工程应用

- 重写器策略：
  - 选择/投影下推、连接交换/结合；
  - 外连接保持性检查；
  - 视图匹配与物化视图命中；
- 验证：`EXPLAIN` 对比计划与结果校验；
- 结合 `1.1.26` 形式语义与 `1.1.63` Bag 语义细节提升鲁棒性。

## 6. 交叉引用

- `1.1.26-查询语言的形式语义与等价律.md`
- `1.1.63-多重集语义-SQL与关系代数的bag形式化.md`
- `1.1.71-外连接与NULL-三值逻辑的形式语义.md`
- `1.1.60-物化视图选择-查询重写等价与代价界.md`
