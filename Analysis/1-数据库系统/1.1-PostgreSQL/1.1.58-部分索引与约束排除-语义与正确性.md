---
title: 1.1.58-部分索引与约束排除-语义与正确性
slug: 1.1.58-部分索引与约束排除-语义与正确性
tags: []
pg_version: 16
status: draft
last_review: 2025-09-12
owner: TBD
---

﻿# 1.1.58 部分索引与约束排除：语义与正确性

## 1. 定义

- 部分索引：在谓词 \(\phi\) 上建立的索引，仅覆盖满足 \(\phi\) 的元组。
- 约束排除（Constraint Exclusion）：利用分区/检查约束与谓词蕴含关系在规划阶段排除不可能产生结果的分区/扫描。

## 2. 语义

- 索引覆盖域：\(I_\phi = \{ t\in R \mid \phi(t)\}\)。当查询谓词 \(\psi\) 满足 \(\psi \Rightarrow \phi\) 时，可使用部分索引 \(I_\phi\)。
- 排除判据：若分区 \(R_i\) 具检查约束 \(\chi_i\) 且 \(\psi \wedge \chi_i\) 不可满足，则可在规划时排除 \(R_i\)。

## 3. 正确性

- 命题：若 \(\psi \Rightarrow \phi\)，则使用仅覆盖 \(I_\phi\) 的索引扫描与全表扫描在结果上等价。
- 证明要点：由蕴含性，任意满足 \(\psi\) 的元组必在 \(I_\phi\) 中；反之索引可能包含额外元组但由执行谓词再过滤保持正确性。

## 4. 示例

```sql
-- 仅活跃订单的部分索引
CREATE INDEX idx_orders_active ON orders (customer_id)
WHERE status = 'active';

-- 查询在谓词蕴含下使用该索引
EXPLAIN SELECT * FROM orders 
WHERE status = 'active' AND customer_id = 123;

-- 分区 + 约束排除
CREATE TABLE events (
  id bigserial,
  ts timestamptz NOT NULL,
  payload jsonb
) PARTITION BY RANGE (ts);

CREATE TABLE events_2025_09 PARTITION OF events
FOR VALUES FROM ('2025-09-01') TO ('2025-10-01');

-- 规划时裁剪
EXPLAIN SELECT * FROM events
WHERE ts >= '2025-09-10' AND ts < '2025-09-11';
```

## 5. 限制与注意

- 谓词稳定性：部分索引谓词需为稳定表达式；
- 统计与选择率：部分索引域与全体分布可能差异大，需单独统计；
- 复杂谓词蕴含：规划器的蕴含判定有限，必要时使用等价重写或表达式列。

## 6. 交叉引用

- `1.1.59-表分区与分区裁剪-语义与等价.md`
- `02-查询处理/02.02-索引结构与优化.md`
