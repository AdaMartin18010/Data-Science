# PostgreSQL 2025特性落地指南与实操

## 1. 场景概述与适配评估

- 目标：在生产环境安全启用 2025 新特性（AI 原生、向量增强、流处理、多模态、云原生）。
- 适配评估：
  - 硬件：CPU AVX2/AVX512，GPU 可选（CUDA/ROCm），NVMe SSD 优先。
  - 系统：Linux Kernel >= 5.15，K8s >= 1.28（云原生方案）。
  - 数据规模：行数 ≥ 10^8 时建议分区+压缩，向量库使用 HNSW/IVF 复合索引。

## 2. 安装与部署

### 2.1 二进制/容器

- 容器镜像：`postgresql:2025`
- 基础命令：

```bash
# Docker（单机 PoC）
docker run -d --name pg2025 -p 5432:5432 \
  -e POSTGRES_PASSWORD=postgres \
  -v $PWD/pgdata:/var/lib/postgresql/data \
  -v $PWD/models:/models \
  postgresql:2025
```

### 2.2 Kubernetes（生产集群）

- 推荐：StatefulSet + ReadOnlyMany 存储（对象存储挂载模型仓库）。
- 关键参数：资源 QoS、亲和性、PodDisruptionBudget、PodAntiAffinity。

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgresql-cluster
spec:
  serviceName: postgresql
  replicas: 3
  selector:
    matchLabels:
      app: postgresql
  template:
    metadata:
      labels:
        app: postgresql
    spec:
      containers:
      - name: postgresql
        image: postgresql:2025
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_DB
          value: "datascience"
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgresql-secret
              key: password
        volumeMounts:
        - name: postgresql-data
          mountPath: /var/lib/postgresql/data
        - name: ai-models
          mountPath: /models
  volumeClaimTemplates:
  - metadata:
      name: postgresql-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 200Gi
```

## 3. 配置与扩展启用

在 `postgresql.conf` 中：

```conf
shared_preload_libraries = 'pg_stat_statements,pgvector,ai_inference,streaming'
max_worker_processes = 64
max_parallel_workers = 32
max_parallel_workers_per_gather = 8
maintenance_work_mem = '2GB'
work_mem = '128MB'
effective_cache_size = '32GB'
```

启用扩展与基线参数：

```sql
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
CREATE EXTENSION IF NOT EXISTS vector;
CREATE EXTENSION IF NOT EXISTS ai_inference; -- AI 原生推理
CREATE EXTENSION IF NOT EXISTS streaming;    -- 原生流处理

-- AI/向量默认策略
SELECT ai_set_option('gpu.enabled', 'auto');
SELECT ai_set_option('model.store', '/models');
SELECT set_config('vector.simd', 'on', false);
```

## 4. 典型场景实操

### 4.1 向量检索（pgvector/HNSW）

```sql
CREATE TABLE items (
  id BIGSERIAL PRIMARY KEY,
  title TEXT,
  embedding VECTOR(768)
);

-- HNSW 索引
CREATE INDEX idx_items_emb_hnsw ON items
USING hnsw (embedding vector_cosine_ops)
WITH (m=16, ef_construction=200, ef_search=100);

-- 查询
WITH q AS (
  SELECT ai_embedding('text_encoder', json_build_object('text', '推荐智能手表')) AS emb
)
SELECT i.id, i.title, (1 - (i.embedding <=> q.emb)) AS score
FROM items i, q
ORDER BY i.embedding <=> q.emb
LIMIT 10;
```

### 4.2 AI 原生推理（SQL 内联）

```sql
-- 模型注册（示例）
CREATE MODEL sentiment_analyzer (
  model_type = 'transformer',
  model_path = '/models/sentiment_v2.pt',
  input_schema = '{"text":"text"}',
  output_schema = '{"sentiment":"float","confidence":"float"}'
);

-- 推理函数
CREATE OR REPLACE FUNCTION predict_sentiment(txt TEXT)
RETURNS TABLE(sentiment FLOAT, confidence FLOAT)
LANGUAGE plpgsql AS $$
BEGIN
  RETURN QUERY SELECT * FROM ai_inference('sentiment_analyzer', json_build_object('text', txt));
END;$$;

-- 使用
SELECT * FROM predict_sentiment('这款产品非常好用');
```

### 4.3 原生流处理与实时看板

```sql
CREATE STREAM user_events (
  user_id BIGINT,
  event_type TEXT,
  event_data JSONB,
  ts TIMESTAMPTZ
) WITH (
  retention = '7 days',
  watermark = 'ts - INTERVAL ''5 minutes'''
);

CREATE MATERIALIZED VIEW m_window AS
SELECT window_start, window_end, event_type,
       COUNT(*) AS cnt, COUNT(DISTINCT user_id) AS uniq
FROM TABLE(
  TUMBLE(TABLE user_events, DESCRIPTOR(ts), INTERVAL '1 minute')
)
GROUP BY window_start, window_end, event_type;
```

### 4.4 多模态统一检索

```sql
CREATE TABLE multimodal_content (
  id BIGSERIAL PRIMARY KEY,
  text_content TEXT,
  text_embedding VECTOR(768),
  image_path TEXT,
  image_embedding VECTOR(512),
  audio_path TEXT,
  audio_embedding VECTOR(256),
  unified_embedding VECTOR(1024)
);

CREATE OR REPLACE FUNCTION search_mm(q TEXT)
RETURNS TABLE(id BIGINT, score FLOAT) LANGUAGE plpgsql AS $$
DECLARE
  q_emb VECTOR(1024);
BEGIN
  q_emb := multimodal_fusion(
    ai_embedding('text_model', json_build_object('text', q)),
    NULL, NULL, NULL
  );
  RETURN QUERY
  SELECT id, (1 - (unified_embedding <=> q_emb)) AS score
  FROM multimodal_content
  ORDER BY unified_embedding <=> q_emb
  LIMIT 20;
END;$$;
```

## 5. 性能基线与调优清单

- 索引：文本/向量/组合索引，定期 `REINDEX CONCURRENTLY`。
- Autovacuum：热点表提高 `vacuum_cost_limit` 与 `autovacuum_vacuum_scale_factor`。
- 并行：扫描/聚合启用并行，观察 `max_parallel_workers_per_gather`。
- I/O：检查 `effective_io_concurrency` 与 `checkpoint_timeout`（≥ 15min）。
- 观测：`pg_stat_statements`、自研视图 `performance_metrics`。

## 6. 安全、合规与多租户

- RLS：多租户场景启用行级安全与策略隔离。
- 审计：记录 AI 推理输入/输出摘要与责任追踪。
- 隐私：差分隐私聚合、最小可用特征策略。

## 7. 兼容性与回退策略

- 蓝绿/金丝雀：对 AI/流处理功能分阶段放量。
- 开关：通过 `ai_set_option('enabled','off')` 与 `set_config('vector.simd','off',false)` 快速降级。
- 数据：向量列保留为原始向量与投影向量双写，便于回退。
- 备份：启用 PITR，重要迁移前做全量快照。

## 8. 参考模板与脚本

- Helm/Kustomize 模板
- psql 启动脚本与初始化 `CREATE EXTENSION` 清单
- 性能采集与基线比对脚本

> 建议先在影子环境跑 24-72 小时流量回放，确认延迟、资源、正确性指标达标后再全量切换。

## 9. 生产检查清单与回退演练

### 9.1 生产前检查清单（Go/No-Go）

- 环境与依赖
  - [ ] OS/Kernel、容器运行时、K8s 版本符合基线
  - [ ] CPU SIMD、GPU 驱动与库版本验证（nvidia-smi/rocminfo）
  - [ ] 存储性能与容量评估（fio/iostat/blkid）
- 数据库配置
  - [ ] shared_preload_libraries、worker 并发、内存参数
  - [ ] autovacuum、checkpoint、IO 并发
  - [ ] 扩展启用（pg_stat_statements/vector/ai_inference/streaming）
- 功能与兼容
  - [ ] 向量索引创建/回退路径验证（HNSW→BTREE/禁用）
  - [ ] AI 推理禁用/降级开关验证（ai_set_option enabled=off）
  - [ ] 流处理 Exactly-Once、重放、幂等验证
- 安全合规
  - [ ] RLS 策略、审计日志、密钥轮换
  - [ ] 隐私与最小特征策略、数据留存
- 观测与SLO
  - [ ] 指标基线与报警阈值（延迟P95/错误率/资源）
  - [ ] 仪表板可用，演练报警触发与恢复
- 备份与回退
  - [ ] PITR 可用，全量/增量快照有效
  - [ ] 架构变更（DDL）具备回退脚本

### 9.2 回退演练脚本（示例）

```bash
#!/usr/bin/env bash
# rollback_ai_vector.sh - AI/向量/流处理快速降级演练
set -euo pipefail

PGURL=${PGURL:-"postgresql://postgres:postgres@localhost:5432/postgres"}

psql "$PGURL" -v ON_ERROR_STOP=1 <<'SQL'
-- 1) 快速关闭AI与SIMD
SELECT ai_set_option('enabled','off');
SELECT set_config('vector.simd','off', false);

-- 2) 将关键查询切换至纯结构化路径（示例占位）
CREATE OR REPLACE VIEW search_fallback AS
SELECT id, title FROM items
WHERE to_tsvector('simple', title) @@ plainto_tsquery('smart watch')
LIMIT 20;

-- 3) 暂停流处理并转物化批处理
ALTER STREAM user_events SET (retention = '0 minutes');
DROP MATERIALIZED VIEW IF EXISTS m_window;
CREATE MATERIALIZED VIEW m_window_batch AS
SELECT date_trunc('minute', ts) as ts_minute, event_type, count(*) cnt
FROM user_events_archive
GROUP BY 1,2;
SQL

echo "降级完成：已切换至传统路径，AI/向量/流处理关闭/批处理化。"
```

> 建议每月执行一次演练，记录耗时、影响面、回退后SLO，并在影子环境回放流量进行对比。
