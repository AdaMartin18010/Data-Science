# 事务管理

## 1. 定义

**中文**: 事务是数据库中的逻辑工作单元，具有ACID特性（原子性、一致性、隔离性、持久性）。

**English**: A transaction is a logical unit of work in a database with ACID properties (Atomicity, Consistency, Isolation, Durability).

## 2. 形式化定义

```latex
\newcommand{\trans}{\mathcal{T}}
\trans = \{\op_1, \op_2, \ldots, \op_n\}

ACID性质：
- Atomicity: \trans 要么完全执行，要么完全不执行
- Consistency: 执行前后数据库状态满足完整性约束
- Isolation: 并发事务间相互隔离
- Durability: 提交后的事务结果永久保存
```

## 3. 核心属性

- **原子性**: 事务是不可分割的工作单元
- **一致性**: 事务执行前后数据库保持一致状态
- **隔离性**: 并发事务间相互隔离
- **持久性**: 提交的事务结果永久保存

## 4. 理论基础

```latex
\begin{theorem}[ACID性质]
设事务 T = \{op_1, op_2, \ldots, op_n\}，则：
1. 原子性：∀T, T要么完全执行，要么完全不执行
2. 一致性：∀T, 执行前后数据库状态满足完整性约束
3. 隔离性：∀T₁,T₂, T₁的执行对T₂不可见
4. 持久性：∀T, 提交后的事务结果永久保存
\end{theorem}
```

## 5. 算法实现

### 5.1 事务控制

```sql
-- 开始事务
BEGIN;

-- 执行操作
INSERT INTO accounts (account_id, balance) VALUES (1001, 1000);
UPDATE accounts SET balance = balance - 100 WHERE account_id = 1001;

-- 提交事务
COMMIT;

-- 或者回滚事务
ROLLBACK;
```

### 5.2 隔离级别

```sql
-- 设置隔离级别
BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;

-- 支持级别：Read Uncommitted, Read Committed, Repeatable Read, Serializable
```

### 5.3 可串行化快照隔离（SSI）要点

- 基于冲突图的危险结构检测，避免不可串行化调度；
- 长事务与热点写放大会增加冲突中止风险；
- 与 `FOR UPDATE SKIP LOCKED`、`NOWAIT` 的交互需谨慎评估。

## 6. 应用实例

### 6.1 银行转账系统

```sql
BEGIN;

-- 检查账户余额
SELECT balance FROM accounts WHERE account_id = 1001 FOR UPDATE;

-- 扣除转出账户余额
UPDATE accounts SET balance = balance - 100 
WHERE account_id = 1001 AND balance >= 100;

-- 增加转入账户余额
UPDATE accounts SET balance = balance + 100 
WHERE account_id = 1002;

COMMIT;
```

### 6.2 库存管理系统

```sql
BEGIN;

-- 扣减库存
UPDATE inventory SET quantity = quantity - 1 
WHERE product_id = 1001 AND quantity > 0;

-- 创建订单
INSERT INTO orders (order_id, product_id, quantity) 
VALUES (nextval('order_seq'), 1001, 1);

COMMIT;
```

## 7. 性能分析

- **提交时间**: O(1) 到 O(n)
- **回滚时间**: O(n)
- **并发度**: 取决于隔离级别
  - RC 并发高；RR/SSI 冲突开销更高；
  - 长事务会阻碍 Autovacuum 可见性、放大膨胀。

## 8. 相关概念

- **上位概念**: 并发控制、数据库一致性
- **下位概念**: 锁机制、WAL、MVCC
  - 锁：行锁/意向锁/元数据锁；等待与死锁；
  - MVCC：快照、可见性、冻结与VACUUM；
  - WAL：提交持久性与恢复、检查点。
- **平行概念**: 分布式事务、长事务

## 9. 参考文献

1. Berenson, H., et al. (1995). A critique of ANSI SQL isolation levels.
2. PostgreSQL Global Development Group. (2024). PostgreSQL 16.2 Documentation.

## 10. Wikidata对齐

- **ID**: Q186929 (database transaction)
- **属性**: database concept, ACID properties
- **链接**: <https://en.wikipedia.org/wiki/Database_transaction>
