## 验证闭环

- 快速参考：见[`00-项目导航/验证闭环模板.md`](00-项目导航/验证闭环模板.md)
- 推荐在`sandbox` schema执行以保持幂等与可回滚，通用断言示例：

```bash
psql -h localhost -U postgres -d postgres -v ON_ERROR_STOP=1 \
  -c "\\dt+ sandbox.*" \
  -c "\\dm+ sandbox.*" \
  -c "SELECT 'mv_choice_ok' AS tag;"
```

- 诊断脚本（可选）：

```bash
psql -h localhost -U postgres -d postgres -v ON_ERROR_STOP=1 -f "Analysis/1-数据库系统/1.1-PostgreSQL/sql/diagnostics.sql"
```

# 1.1.60 物化视图选择：查询重写等价与代价界

## 1. 问题定义

- 给定查询集合 \(\{Q_i\}\) 与候选视图集合 \(\{V_j\}\)，选择视图子集以最小化总成本：
\[ \min_{S\subseteq \{V_j\}} \sum_i C(\text{eval}(Q_i \mid S)) + \sum_{V\in S} C_{maint}(V). \]

## 2. 重写等价判据（概要）

- 语义等价：存在映射使 \(Q\) 可用 \(V\) 的投影/选择/连接/聚合重组得到；
- 同构/包含：基于查询图同构/包含判定（参见 `1.1.80`）；
- 约束辅助：利用函数依赖/键约束减少必要投影与连接（参见 `1.1.33`）。

## 3. 代价界与优化

- 上界：使用视图重写的评估成本不超过原评估 + 维护成本；
- 下界：若重写失败或选择率偏差导致不匹配，收益为0；
- 多目标：权衡查询延迟、维护开销与存储（参见 `1.1.82`）。

## 4. 增量维护（概述）

- 代数差分：\(\Delta V = f(\Delta R_1,\dots,\Delta R_n)\)（参见 `1.1.47`）。
- 触发器/物化刷新：`REFRESH MATERIALIZED VIEW [CONCURRENTLY]`；
- 合成策略：冷热分层，热查询使用物化视图，冷查询回源。

## 5. 示例

```sql
-- 候选物化视图：月度汇总
CREATE MATERIALIZED VIEW mv_orders_month AS
SELECT date_trunc('month', created_at) AS ym,
       customer_id,
       count(*) AS cnt,
       sum(amount) AS amt
FROM orders
GROUP BY 1,2;
CREATE INDEX ON mv_orders_month(ym, customer_id);

-- 重写匹配：
EXPLAIN SELECT ym, customer_id, cnt, amt
FROM mv_orders_month
WHERE ym = date_trunc('month', timestamp '2025-09-01')
  AND customer_id = 123;

-- 增量刷新（示意）
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_orders_month;
```

## 6. 工程建议

- 聚合/连接一致性：保证维度一致，否则难以匹配；
- 指标稳定性：聚合函数稳定且可组合（SUM/COUNT/AVG），尽量避免不可加复合；
- 维护窗口：离峰刷新；高频写场景采用增量物化/实时流水线；
- 监控：命中率、刷新耗时、过期比例。

## 7. 交叉引用

- `1.1.47-增量物化视图-代数差分与正确性.md`
- `1.1.80-查询重写等价性-基于同构的充分必要条件.md`
- `1.1.82-索引选择与代价模型-多目标优化的Pareto最优性.md`

---

## 附录索引（相关专题）

- 可自维护判据：`1.1.74-可自维护物化视图-可维护性判据与构造.md`、`1.1.79-可自维护物化视图-键依赖与传递更新的严格证明.md`
- 查询等价与同构：`1.1.80-查询重写等价性-基于同构的充分必要条件.md`
- 分区与MV协同：`1.1.59-表分区与分区裁剪-语义与等价.md`
