# 1.1.100-数据库流处理模型-流查询语言与窗口操作的形式化

## 摘要

- 目标：形式化流记录、时间语义、窗口与增量处理，并给出数据库内近似实现与外部引擎协同建议。

## 问题定义（形式化）

- 流记录 (ts, key, value)；时间语义分事件时间与处理时间；窗口W：滚动/滑动/会话。

## 最小示例（可运行）

```sql
-- 在数据库内用物化视图近似流聚合（滚动窗口示意）
CREATE MATERIALIZED VIEW mv_qps_minute AS
SELECT date_trunc('minute', ts) AS m, count(*) AS cnt
FROM events GROUP BY 1;

-- 定期刷新近似流结果
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_qps_minute;
```

## 实务要点

- 乱序：Watermark与延迟允许度在外部流引擎处理；数据库保留校正与对账。
- 一致性：端到端一次性语义需幂等写入与去重键。
- 成本：热点高吞吐用外部流引擎；数据库保存汇总/校正与查询。

## 交叉引用

- `1.1.101-数据库事件处理模型-复杂事件处理与模式匹配的形式化.md`
- `1.1.96-数据库时序数据模型-时间序列分析与预测的形式化.md`
- `03-高级特性/03.10-流批一体与增量处理.md`
