# 查询优化

## 1. 定义

**中文**: 查询优化是数据库系统中将用户查询转换为高效执行计划的过程，通过代价模型选择最优执行策略。

**English**: Query optimization is the process that transforms user queries into efficient execution plans by selecting optimal strategies through cost models.

## 2. 形式化定义

```latex
\newcommand{\query}{\mathcal{Q}}
\newcommand{\plan}{\mathcal{P}}
\newcommand{\cost}{\mathcal{C}}

\query \xrightarrow{optimize} \plan

优化目标：\min_{\plan} \cost(\plan)
```

## 3. 核心属性

- **正确性**: 保证查询结果正确
- **最优性**: 选择最低代价的执行计划
- **适应性**: 根据数据分布动态调整

## 4. 理论基础

```latex
\begin{theorem}[查询代价模型]
查询代价由以下因素决定：
1. I/O代价：磁盘读取次数
2. CPU代价：计算复杂度
3. 内存代价：缓冲区使用
\end{theorem}
```

## 5. 算法实现

### 5.1 执行计划分析

```sql
-- 查看查询执行计划
EXPLAIN (ANALYZE, BUFFERS) 
SELECT e.name, d.dept_name, e.salary
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id
WHERE e.salary > 50000;

-- 查看详细统计
EXPLAIN (ANALYZE, BUFFERS, VERBOSE) 
SELECT COUNT(*) FROM employees WHERE salary > 50000;
```

### 5.2 统计信息管理

```sql
-- 更新表统计信息
ANALYZE employees;

-- 查看统计信息
SELECT schemaname, tablename, attname, n_distinct, correlation
FROM pg_stats WHERE tablename = 'employees';
```

### 5.3 优化配置

```sql
-- 优化器参数
-- postgresql.conf
random_page_cost = 1.1              -- 随机页面访问代价
seq_page_cost = 1.0                 -- 顺序页面访问代价
cpu_tuple_cost = 0.01               -- CPU处理元组代价
effective_cache_size = 4GB          -- 有效缓存大小
```

## 6. 应用实例

### 6.1 复杂查询优化

```sql
-- 原始查询
SELECT d.dept_name, COUNT(*), AVG(e.salary)
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id
WHERE e.hire_date >= '2020-01-01'
GROUP BY d.dept_id, d.dept_name
HAVING AVG(e.salary) > 50000;

-- 优化后查询
WITH dept_stats AS (
    SELECT dept_id, COUNT(*), AVG(salary)
    FROM employees 
    WHERE hire_date >= '2020-01-01'
    GROUP BY dept_id
    HAVING AVG(salary) > 50000
)
SELECT d.dept_name, ds.count, ds.avg
FROM dept_stats ds
JOIN departments d ON ds.dept_id = d.dept_id;
```

### 6.2 索引优化

```sql
-- 创建复合索引
CREATE INDEX idx_emp_dept_salary ON employees(dept_id, salary);

-- 创建部分索引
CREATE INDEX idx_emp_high_salary ON employees(salary) 
WHERE salary > 50000;

-- 查看索引使用情况
SELECT indexname, idx_scan, idx_tup_read
FROM pg_stat_user_indexes 
WHERE tablename = 'employees';
```

## 7. 性能分析

- **查询响应时间**: 从秒级优化到毫秒级
- **I/O减少**: 通过索引减少90%以上I/O
- **CPU优化**: 减少不必要的计算

## 8. 相关概念

- **上位概念**: 数据库性能、查询处理
- **下位概念**: 执行计划、代价模型、统计信息
- **平行概念**: 分布式查询优化

## 9. 参考文献

1. Selinger, P. G., et al. (1979). Access path selection in a relational database management system.
2. PostgreSQL Global Development Group. (2024). PostgreSQL 16.2 Documentation.

## 10. Wikidata对齐

- **ID**: Q186929 (query optimization)
- **属性**: database concept, performance optimization
- **链接**: <https://en.wikipedia.org/wiki/Query_optimization>
