# 1.1.98-数据库JSON数据模型-JSON查询与模式验证的形式化

> 目标：形式化JSON/JSONB语义，给出查询与路径操作、索引与选择率估计、模式验证与一致性策略，以及工程示例与交叉引用。

## 1. 语义域与操作语义

- 语义域 \( D_{json} \)：\(\text{Null} \cup \text{Bool} \cup \text{Number} \cup \text{String} \cup \text{Array}(D_{json}) \cup \text{Object}(\text{String} \to D_{json})\)。
- 解释函数 \( I: S \to D_{json} \)：将字面量/路径/更新操作映射到JSON语义对象。
- 等价：以结构等价与值等价区分；`JSON` 保留文本语义，`JSONB` 采用规范化二进制语义（键无序、去重）。

## 2. 查询与路径操作

- 基本运算：`->`（取子对象/数组元素）、`->>`（取文本）、`#>`（路径取值）、`#>>`（路径文本）、存在/包含 `?` `?|` `?&` `@>`、键路径运算。
- 例：`profile -> 'preferences' ->> 'tier'`；`profile @> '{"tags": ["vip"]}'`。
- 路径语义：路径解析为序列 \( (k_1,\dots,k_n) \)，失败返回 `NULL`（两值化建议使用 `IS [NOT] NULL`）。

## 3. 索引与选择率估计

- GIN 索引：`jsonb_ops`（通用键/值/路径倒排）、`jsonb_path_ops`（路径优化）、部分索引配合热点字段过滤。
- 表达式索引：对稳定路径建立 GIN/B-Tree 组合，例如 `((profile->>'tier'))`。
- 选择率：多键路径与数组包含的选择率估计偏差较大，建议：
  - 为高频谓词建立表达式列或冗余列，提升统计质量。
  - 使用 `ANALYZE` 与 `default_statistics_target` 提升直方图分辨率。
  - 结合 `1.1.49-选择率估计误差-敏感性与上界.md` 讨论误差上界与容忍策略。

## 4. 模式验证与一致性

- 轻量校验：`CHECK` 约束（如关键键存在、类型判定），触发器对复杂结构校验。
- JSON Schema：在应用层或存储过程执行 `jsonschema` 校验，写入前/后置检查。
- 版本演进：以 `schema_version` 域记录版本；迁移期间兼容多版本解析，落地最终形态于冗余列。
- 一致性策略：幂等更新与合并（`jsonb_set`、`||`）、冲突解决策略（最后写入/时间戳优先/领域自定义）。

## 5. 示例

```sql
-- 5.1 存储与索引
CREATE TABLE customer (
  id         BIGSERIAL PRIMARY KEY,
  profile    JSONB NOT NULL DEFAULT '{}'
);
CREATE INDEX idx_customer_profile_gin ON customer USING gin (profile jsonb_path_ops);
CREATE INDEX idx_customer_tier ON customer ((profile->>'tier'));

-- 5.2 查询与过滤
SELECT id
FROM customer
WHERE profile @> '{"preferences": {"newsletter": true}}'
  AND (profile->>'tier') IN ('gold','platinum');

-- 5.3 更新与合并
UPDATE customer
SET profile = jsonb_set(profile, '{preferences,newsletter}', 'true', true)
WHERE id = 1;

-- 5.4 CHECK 校验关键字段
ALTER TABLE customer
ADD CONSTRAINT chk_profile_keys
CHECK ((profile ? 'tier') AND (jsonb_typeof(profile->'tier') = 'string'));
```

## 6. 工程指南

- 高频路径冗余列 + 表达式索引；批处理 `VACUUM/ANALYZE` 保持统计新鲜。
- 批量写入期间考虑暂缓次要索引，完成后并发重建。
- 大文档拆分与冷热分层：热字段列化、冷字段聚合在JSONB。

## 7. 交叉引用

- `1.1.2-数据模型.md`（类型系统与JSONB概览）
- `02-查询处理/02.02-索引结构与优化.md`（GIN/表达式索引）
- `1.1.49-选择率估计误差-敏感性与上界.md`
