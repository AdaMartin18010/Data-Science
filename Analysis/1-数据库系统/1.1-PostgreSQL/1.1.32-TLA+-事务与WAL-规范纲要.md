# 1.1.32 TLA+ 规范纲要：事务与WAL（纯形式化）

本文件为形式化验证准备的规范纲要，描述 MVCC 与 WAL 的抽象模型；仅给出建模要素，不含实现细节或代码。

## 目录

1. 状态变量
2. 初始条件
3. 动作与转移
4. 不变式
5. 性质（安全/活性）
6. 建模建议

## 1. 状态变量

- Data[x]: 逻辑项到版本集合的映射；版本含值与 (ts_w, ts_d)。
- Snap[i]: 事务 i 的快照时间与可见集。
- Log: 按 LSN 有序的日志序列；每条含页ID、变更摘要。
- DirtyPages: 脏页集合；FlushedLSN: 已持久化最大 LSN。

## 2. 初始条件

- 所有事务未开始；Log 为空；FlushedLSN = 0；各 Data[x] 仅含初始版本且 ts_d=+∞。

## 3. 动作与转移

- Begin(i): 固定 Snap[i]；
- Read(i,x): 从 Snap[i] 可见集中选择版本；
- Write(i,x): 生成新版本，追加 Log；标记脏页；
- Commit(i): 写入提交记录；（SSI 可在此处进行危险结构检测与中止）；
- Crash/Recover: 按 WAL 语义进行 REDO/UNDO，满足先写日志。

## 4. 不变式

- Inv1（可见性）：Read 仅返回 \(ts_w\le s_i<ts_d\) 的版本；
- Inv2（WAL）：任何持久化数据页，其相应日志项的 LSN \le FlushedLSN；
- Inv3（单调性）：FlushedLSN 单调不减；
- Inv4（SSI）：提交历史的冲突图无环（以规范函数刻画）。

## 5. 性质

- 安全性：Inv1–Inv4 永远成立；
- 活性：在公平调度下，提交终将完成；崩溃后恢复终将收敛到一致状态。

## 6. 建模建议

- 将谓词依赖抽象为约束图，危险结构检测作为守卫；
- 使用层次化精化：先建 SI，再加 SSI 守卫；
- 为 WAL 引入页面抽象与刷盘调度，以验证 Inv2。
