---
title: 1.1.32-TLA+-事务与WAL-规范纲要
slug: 1.1.32-TLA+-事务与WAL-规范纲要
tags: []
pg_version: 16
status: draft
last_review: 2025-09-12
owner: TBD
---

# 1.1.32 TLA+ 规范纲要：事务与WAL（纯形式化）

本文件为形式化验证准备的规范纲要，描述 MVCC 与 WAL 的抽象模型；给出建模要素与最小 TLA+ 片段草稿。

## 目录

1. 状态变量
2. 初始条件
3. 动作与转移
4. 不变式
5. 性质（安全/活性）
6. 最小TLA+片段（草稿）
7. 建模建议

## 1. 状态变量

- Data[x]: 逻辑项到版本集合的映射；版本含值与 (ts_w, ts_d)。
- Snap[i]: 事务 i 的快照时间与可见集。
- Log: 按 LSN 有序的日志序列；每条含页ID、变更摘要。
- DirtyPages: 脏页集合；FlushedLSN: 已持久化最大 LSN。

## 2. 初始条件

- 所有事务未开始；Log 为空；FlushedLSN = 0；各 Data[x] 仅含初始版本且 ts_d=+∞。

## 3. 动作与转移

- Begin(i): 固定 Snap[i]；
- Read(i,x): 从 Snap[i] 可见集中选择版本；
- Write(i,x): 生成新版本，追加 Log；标记脏页；
- Commit(i): 写入提交记录；（SSI 可在此处进行危险结构检测与中止）；
- Flush: 刷写日志与页面，更新 FlushedLSN；
- Crash/Recover: 按 WAL 语义进行 REDO/UNDO，满足先写日志。

## 4. 不变式

- Inv1（可见性）：Read 仅返回 \(ts_w\le s_i<ts_d\) 的版本；
- Inv2（WAL）：任何持久化数据页，其相应日志项的 LSN \le FlushedLSN；
- Inv3（单调性）：FlushedLSN 单调不减；
- Inv4（SSI）：提交历史的冲突图无环（以规范函数刻画）。

## 5. 性质

- 安全性：Always(Inv1 ∧ Inv2 ∧ Inv3 ∧ Inv4)。
- 活性：
  - Fairness1: 若事务持续可提交，最终 Commit 触发；
  - Fairness2: Crash 后 Redo/Undo 过程终止，系统达一致状态（Log 前缀 + 页状态一致）。

## 6. 最小TLA+片段（草稿）

```tla
---- MODULE TxWAL ----
EXTENDS Naturals, Sequences

VARIABLES Data, Snap, Log, FlushedLSN

Init == /\ Data = [x \in X |-> <<[val |-> v0, ts_w |-> 0, ts_d |-> Infinity]>>]
        /\ Snap = [i \in I |-> [ts |-> 0]]
        /\ Log = << >> /\ FlushedLSN = 0

Read(i,x) == \E v \in Data[x]: v.ts_w <= Snap[i].ts /\ Snap[i].ts < v.ts_d
Write(i,x) == \E l \in Nat: 
  Log' = Append(Log, [lsn |-> Len(Log)+1, pid |-> p(x), delta |-> d(i,x)]) /\
  Data' = [Data EXCEPT ![x] = Append(@, [val |-> f(i,x), ts_w |-> Snap[i].ts, ts_d |-> Infinity])]

Flush == FlushedLSN' = Len(Log) /\ UNCHANGED <<Data, Snap, Log>>

InvWAL == \A p \in P: persisted(p) => lastLSN(p) <= FlushedLSN

Next == Read(i,x) \/ Write(i,x) \/ Flush \/ Commit(i) \/ CrashRecover

Spec == Init /\ [][Next]_<<Data,Snap,Log,FlushedLSN>> /\ WF_vars(Flush)

THEOREM Spec => []InvWAL
====
```

（注：为纲要示意，未包含完整定义与域约束。）

## 7. 建模建议

- 将谓词依赖抽象为约束图，危险结构检测作为守卫；
- 使用层次化精化：先建 SI，再加 SSI 守卫；
- 为 WAL 引入页面抽象与刷盘调度，以验证 Inv2；
- 使用 TLC/Apalache 做可达性与死锁检查，分层增加规模。
