## 验证闭环

- 快速参考：见[`00-项目导航/验证闭环模板.md`](00-项目导航/验证闭环模板.md)
- 推荐在`sandbox` schema执行以保持幂等与可回滚，通用断言示例：

```bash
psql -h localhost -U postgres -d postgres -v ON_ERROR_STOP=1 \
  -c "\\dt+ sandbox.*" \
  -c "\\df+ sandbox.*" \
  -c "SELECT 'adaptive_planner_ok' AS tag;"
```

- 诊断脚本（可选）：

```bash
psql -h localhost -U postgres -d postgres -v ON_ERROR_STOP=1 -f "Analysis/1-数据库系统/1.1-PostgreSQL/sql/diagnostics.sql"
```

---
title: 1.1.83-查询优化器自适应-反馈学习与代价模型修正
slug: 1.1.83-查询优化器自适应-反馈学习与代价模型修正
tags: []
pg_version: 16
status: draft
last_review: 2025-09-12
owner: TBD
---

﻿# 1.1.83 查询优化器自适应：反馈学习与代价模型修正

## 1. 目标

- 通过“观测→比较→修正→验证”的闭环，降低基数/选择率误差对计划质量的影响，提升稳健性与长期最优。

## 2. 反馈循环

1) 观测：采集 `EXPLAIN (ANALYZE, BUFFERS)` 的实际行数/耗时/IO；
2) 比较：与估计基数/代价对比，定位阈值翻转处（见 `1.1.49`）；
3) 修正：

   - 统计更新：`ANALYZE`、扩展统计（依赖/多列NDV/相关性）；

   - 代价参数微调：`seq_page_cost`、`random_page_cost`、`cpu_*_cost`；

   - 重写建议：表达式列、部分索引、物化中间结果；

4) 验证：回归测试与AB对照；保留回退通道。

## 3. 基数与代价修正策略

- 扩展统计：

```sql
CREATE STATISTICS st_dep (dependencies, ndistinct, mcv)
ON dept_id, salary FROM employees;
ANALYZE employees;
```

- 代价参数校准（谨慎）：

```sql
SET random_page_cost = 2.0;  -- SSD环境常低于默认4.0
SET seq_page_cost = 1.0;
```

- 针对性重写：

```sql
ALTER TABLE orders ADD COLUMN status_text text GENERATED ALWAYS AS (status::text) STORED;
CREATE INDEX idx_orders_status_text ON orders(status_text);
```

## 4. 在线守护与回退

- 守护：当监测到某查询的计划退化（TP95/TP99升高显著）时触发：

  - 先局部 `ANALYZE`；

  - 失败则切换到稳定计划（限制 `join_collapse_limit`，或临时禁用某算子）；

  - 记录事件并排期结构性修复（索引/重写）。

- 回退：保留历史最佳计划/参数快照，支持一键回滚。

## 5. 指标与触发阈值

- 误差比：`actual_rows / estimated_rows`（>10 或 <0.1 触发）；
- 代价差：计划代价 vs 实际耗时的秩相关；
- 稳定性：一段时间内TP95/TP99回落到阈值内。

## 6. 工程示例

```sql
-- 采样一组关键查询做周期性基线
EXPLAIN (ANALYZE, BUFFERS)
SELECT * FROM orders WHERE customer_id = $1 AND status = 'paid';

-- 记录并比较误差，超阈值则：
ANALYZE orders (customer_id, status);
-- 或尝试调参后复测（仅在预生产环境）
SET random_page_cost = 1.5;
```

## 7. 与统计误差/索引选择的协同

- 结合 `1.1.49` 的鲁棒策略与 `1.1.82` 的Pareto索引集合，形成“稳态可行 + 渐进最优”的策略池。

## 8. 交叉引用

- `02-查询处理/02.03-统计信息与代价模型.md`
- `1.1.49-选择率估计误差-敏感性与上界.md`
- `1.1.82-索引选择与代价模型-多目标优化的Pareto最优性.md`
