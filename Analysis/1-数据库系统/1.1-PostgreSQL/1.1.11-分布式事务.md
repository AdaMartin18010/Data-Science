---
title: 1.1.11-分布式事务
slug: 1.1.11-分布式事务
tags: []
pg_version: 16
status: draft
last_review: 2025-09-12
owner: TBD
---

# 分布式事务

## 1. 定义

**中文**: 分布式事务是在多个数据库节点间协调执行的事务，确保跨节点数据的一致性和ACID特性。

**English**: Distributed transactions coordinate execution across multiple database nodes, ensuring data consistency and ACID properties across nodes.

## 2. 形式化定义

```latex
\newcommand{\disttrans}{\mathcal{DT}}
\newcommand{\node}{\mathcal{N}}
\newcommand{\coordinator}{\mathcal{C}}

\disttrans = \{(coordinator, \node_1, \node_2, \ldots, \node_n)\}

其中：
coordinator: 协调者节点
\node_i: 参与者节点
```

## 3. 核心属性

- **原子性**: 所有节点要么全部提交，要么全部回滚
- **一致性**: 跨节点数据状态一致
- **隔离性**: 并发事务间相互隔离
- **持久性**: 提交后数据永久保存

## 4. 理论基础

```latex
\begin{theorem}[两阶段提交协议]
两阶段提交协议确保分布式事务一致性：
1. 准备阶段：协调者询问所有参与者是否准备提交
2. 提交阶段：根据参与者响应决定提交或回滚
\end{theorem}
```

## 5. 算法实现

### 5.1 两阶段提交

```sql
-- 分布式事务示例
BEGIN;

-- 第一阶段：准备
PREPARE TRANSACTION 'dist_tx_001';

-- 在多个节点上执行
INSERT INTO accounts@node1 (account_id, balance) VALUES (1001, 1000);
UPDATE accounts@node2 SET balance = balance - 100 WHERE account_id = 1002;

-- 第二阶段：提交
COMMIT PREPARED 'dist_tx_001';
```

### 5.2 三阶段提交

```sql
-- 三阶段提交（更安全的变体）
-- 第一阶段：CanCommit
-- 第二阶段：PreCommit  
-- 第三阶段：DoCommit

-- 使用PostgreSQL的分布式扩展
-- 例如：PostgreSQL-XL, Citus等
```

### 5.3 SAGA模式

```sql
-- SAGA模式实现
-- 补偿事务示例

-- 正向操作
CREATE OR REPLACE FUNCTION book_flight(user_id INT, flight_id INT)
RETURNS BOOLEAN AS $$
BEGIN
    INSERT INTO bookings (user_id, flight_id, status) 
    VALUES (user_id, flight_id, 'confirmed');
    RETURN TRUE;
EXCEPTION
    WHEN OTHERS THEN
        RETURN FALSE;
END;
$$ LANGUAGE plpgsql;

-- 补偿操作
CREATE OR REPLACE FUNCTION cancel_flight(user_id INT, flight_id INT)
RETURNS BOOLEAN AS $$
BEGIN
    UPDATE bookings 
    SET status = 'cancelled' 
    WHERE user_id = $1 AND flight_id = $2;
    RETURN TRUE;
EXCEPTION
    WHEN OTHERS THEN
        RETURN FALSE;
END;
$$ LANGUAGE plpgsql;
```

## 6. 应用实例

### 6.1 微服务架构

```sql
-- 订单服务
CREATE TABLE orders (
    order_id SERIAL PRIMARY KEY,
    user_id INTEGER,
    total_amount DECIMAL(10,2),
    status VARCHAR(20) DEFAULT 'pending'
);

-- 库存服务
CREATE TABLE inventory (
    product_id INTEGER PRIMARY KEY,
    quantity INTEGER,
    reserved_quantity INTEGER DEFAULT 0
);

-- 分布式事务：创建订单并扣减库存
BEGIN;

-- 在订单服务中创建订单
INSERT INTO orders (user_id, total_amount) VALUES (1001, 150.00);

-- 在库存服务中扣减库存
UPDATE inventory 
SET quantity = quantity - 1, 
    reserved_quantity = reserved_quantity + 1
WHERE product_id = 2001 AND quantity > 0;

-- 如果任何操作失败，整个事务回滚
COMMIT;
```

### 6.2 跨数据库操作

```sql
-- 使用PostgreSQL FDW进行跨数据库操作
CREATE EXTENSION postgres_fdw;

-- 创建外部服务器
CREATE SERVER remote_server
FOREIGN DATA WRAPPER postgres_fdw
OPTIONS (host 'remote-host', port '5432', dbname 'remote_db');

-- 创建用户映射
CREATE USER MAPPING FOR current_user
SERVER remote_server
OPTIONS (user 'remote_user', password 'remote_password');

-- 创建外部表
CREATE FOREIGN TABLE remote_accounts (
    account_id INTEGER,
    balance DECIMAL(10,2)
) SERVER remote_server OPTIONS (schema_name 'public', table_name 'accounts');

-- 分布式事务
BEGIN;

-- 本地操作
UPDATE accounts SET balance = balance - 100 WHERE account_id = 1001;

-- 远程操作
UPDATE remote_accounts SET balance = balance + 100 WHERE account_id = 1002;

COMMIT;
```

## 7. 性能分析

- **延迟**: 网络延迟 + 处理时间
- **吞吐量**: 受限于最慢的节点
- **一致性**: 强一致性 vs 最终一致性
- **可用性**: 单点故障影响

## 8. 相关概念

- **上位概念**: 分布式系统、事务管理
- **下位概念**: 两阶段提交、SAGA模式
- **平行概念**: 分布式锁、一致性协议

## 9. 参考文献

1. Gray, J., & Lamport, L. (2006). Consensus on transaction commit. ACM TODS, 31(1), 133-160.
2. PostgreSQL Global Development Group. (2024). PostgreSQL 16.2 Documentation.

## 10. Wikidata对齐

- **ID**: Q186929 (distributed transaction)
- **属性**: distributed system, transaction management
- **链接**: <https://en.wikipedia.org/wiki/Distributed_transaction>
