# 1.1.75-锁升级与降级-安全性与死锁影响的形式证明

## 摘要

- 目标：定义锁升级/降级的安全条件，分析对死锁图的影响，并给出可验证的最小实践。

## 问题定义（形式化）

- 锁集合 L，兼容矩阵 C，等待图 G_W。升级操作 u: l→l'（如RowShare→RowExclusive）。安全条件：不破坏可串行化与无死锁推进性。
- 定理草稿：若升级遵循“先申请后释放”并在总序下进行，则不会引入新等待环；反例来自交叉升级。

## 最小示例（可运行）

```sql
-- 观察等待与冲突
SELECT * FROM pg_locks WHERE NOT granted;

-- 避免交叉升级：先获取强锁，后释放弱锁（应用层序列化关键段）
```

## 实务要点

- 批处理升级：合并多个行锁为表级锁前，确保无长事务竞争；设置锁超时。
- 降级策略：在关键段结束后尽快降级/释放，缩短阻塞窗口。
- 监控：基于等待图与等待时间阈值报警，定位交叉升级热点SQL。

## 交叉引用

- `1.1.47-事务隔离理论-完整版.md`
- `1.1.64-死锁与等待图-检测正确性与避免策略.md`
- `1.1.48-谓词锁与幽灵现象-形式化与消除条件.md`
