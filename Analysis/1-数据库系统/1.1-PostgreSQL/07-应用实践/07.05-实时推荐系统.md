# 07.05-实时推荐系统

> 面向 PostgreSQL 的实时推荐：特征存取、向量检索、召回-排序-重排流水线、近库服务与只读副本。

## 概述

实时推荐通常包含多阶段：候选召回（向量/协同）、粗排、精排与重排。PostgreSQL 可承担特征存取、规则过滤、向量召回与在线指标监控。

## 关键概念

- 特征存取：用户/物品特征、上下文与实时反馈
- 向量召回：`pgvector` + HNSW/IVF；结构化/全文 + 向量混合
- 近库推理：Sidecar 服务，主库写、只读副本读
- 在线指标：点击/转化、延迟与召回曲线

## 实践要点

```sql
-- 物品表 + 向量
CREATE EXTENSION IF NOT EXISTS vector;
CREATE TABLE item (
  id bigserial PRIMARY KEY,
  title text,
  tags  text[],
  embedding vector(768),
  created_at timestamptz DEFAULT now()
);
CREATE INDEX idx_item_hnsw ON item USING hnsw (embedding vector_l2_ops) WITH (m=32, ef_construction=200);
CREATE INDEX idx_item_tags_gin ON item USING gin (tags);

-- 结构化 + 向量混合
WITH q AS (SELECT $1::vector AS qv, $2::text[] AS tg)
SELECT id, title
FROM item, q
WHERE tags && q.tg
ORDER BY embedding <-> q.qv
LIMIT 100;
```

流水线：

- 召回：向量 + 结构化/标签过滤，Top-N
- 粗排：规则/轻量模型（近库服务）
- 精排：外部模型服务，回写得分
- 重排：多目标（新鲜度/多样性/相似度）

## 参考

- `03-高级特性/03.05-向量数据库支持.md`
- `runbook/04-向量检索与混合查询-落地指南.md`
