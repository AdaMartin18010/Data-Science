# 1.1.52 窗口聚合语义：稳定性与等价变换

## 1. 定义与记号

- 分区键 G，序键 O，窗口框架 F（ROWS/RANGE/GROUPS + 边界）。
- 结果为对每个元组计算 `f(Ctx(G,O,F))`，`f` 为窗口函数（如 `sum/avg/lag/lead/rank`）。

## 2. 稳定性与确定性

- 定理 2.1：若 O 为全序且无并列，则在固定 F 与 G 下，窗口结果对保持相对顺序的微扰稳定。
- 命题 2.2：存在并列时需扩展 O（例如补上主键）或使用稳定排序以保证确定性。
- 命题 2.3：RANGE 框架在非数值/时间度量上需定义距离语义，否则不稳定；ROWS 框架以物理行计数，确定性由 O 的唯一化保证。

## 3. 等价与可交换条件

- 选择与窗口：若选择谓词 φ 仅依赖 G 外的常量且不改变帧域，则 `σ_φ` 与窗口可交换；若 φ 影响帧（如基于 O 的范围），通常不可交换。
- 投影与窗口：当投影保留 G、O、F 所需属性与 `f` 的输入列，窗口结果不变。
- 连接与窗口：在先窗口后连接与先连接后窗口之间，除非连接不改变分区/排序与帧域，否则不可随意交换。

## 4. SQL 示例

```sql
-- 4.1 移动平均（ROWS 帧）
SELECT dept_id, created_at, amount,
       avg(amount) OVER (
         PARTITION BY dept_id 
         ORDER BY created_at 
         ROWS BETWEEN 3 PRECEDING AND CURRENT ROW
       ) AS mov_avg
FROM orders;

-- 4.2 RANK 与并列确定性（补充唯一键）
SELECT dept_id, emp_id, salary,
       RANK() OVER (PARTITION BY dept_id ORDER BY salary DESC, emp_id ASC) AS rk
FROM employees;

-- 4.3 选择可交换的安全场景（与窗口无交互）
WITH base AS (
  SELECT *,
         sum(amount) OVER (PARTITION BY dept_id ORDER BY created_at
                           ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS csum
  FROM orders
)
SELECT * FROM base WHERE amount > 0;  -- 与窗口无交互，可置于前后均等价
```

## 5. 反例与陷阱

- 将过滤放在窗口之后可能改变帧语义：

```sql
-- 错误：过滤影响帧内的成员，等价关系不成立
SELECT * FROM (
  SELECT dept_id, created_at, amount,
         avg(amount) OVER (PARTITION BY dept_id ORDER BY created_at ROWS BETWEEN 3 PRECEDING AND CURRENT ROW) AS mov
  FROM orders
) t
WHERE amount > 0;  -- 若过滤写在子查询内，会改变窗口输入集合
```

- RANGE vs ROWS：

```sql
-- RANGE 依据值域，受重复值合并影响；ROWS 按物理行计数
SELECT avg(salary) OVER (PARTITION BY dept_id ORDER BY salary RANGE BETWEEN 100 PRECEDING AND CURRENT ROW) FROM employees;
```

## 6. 工程建议

- 为 O 添加唯一列保证确定性；
- 优先使用 ROWS 帧表达窗口大小；RANGE 需谨慎定义距离与重复值处理；
- 将影响帧的过滤与排序放入窗口定义内部（如在子查询中预清理），避免等价误判。

## 7. 交叉引用

- `1.1.26-查询语言的形式语义与等价律.md`
- `1.1.63-多重集语义-SQL与关系代数的bag形式化.md`
- `1.1.71-外连接与NULL-三值逻辑的形式语义.md`
