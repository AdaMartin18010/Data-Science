# 分布式一致性理论

## 1. 概述

- CAP/一致性级别、复制协议、隔离与一致性关系

## 1.1 定义与形式化

### 概念定义

**中文定义**: 分布式一致性描述多个副本在网络/故障条件下对外呈现的读写可观测行为与顺序约束，典型包含线性化、顺序一致、最终一致等强弱不同的保证。

**English Definition**: Distributed consistency characterizes observable read/write behaviors and ordering guarantees among replicas under network/failure conditions, including linearizability, sequential consistency, and eventual consistency.

### 形式化刻画（摘）

```latex
% 线性化（Linearizability）
% 每个操作在其调用与返回之间某一瞬时生效，且与单副本顺序一致
\newcommand{\Ops}{\mathcal{O}}
\newcommand{\hb}{\prec_{hb}}
\newcommand{\lin}{\prec_{lin}}

\textbf{Linearizability}: \exists \text{ total order } \lin \text{ over } \Ops, 
\text{ s.t. } (i)\ hb \subseteq \lin,\ (ii) \lin \text{ respects object spec}.
```

## 2. 合并来源与映射

- 1.1.31-分布式一致性与CAP-形式化刻画与权衡.md
- 1.1.11-分布式事务.md（交叉）

## 3. 协议与模型

- 两阶段/三阶段提交、基于日志复制、共识（Raft/Paxos）

### 3.1 二阶段提交（2PC）

```latex
% 终止性与阻塞性要点
\begin{theorem}[2PC阻塞性]
若协调者在提交决定后崩溃且未持久化广播，参与者可能进入不确定阻塞状态。
\end{theorem}
```

### 3.2 共识与复制

```text
Raft: 领导者选举 → 日志复制 → 提交应用；安全性基于法定多数与日志匹配性质。
Paxos: 提案/接受阶段确保单值选择，与多日志条目组合构成Multi-Paxos。
```

## 4. 关键结论

- 可用性权衡、网络分区下的保证、读写路径

```latex
\begin{theorem}[CAP权衡（直观表述）]
在存在网络分区的系统中，无法同时满足强一致性与可用性。
\end{theorem}
```

## 5. 后续整合任务

- 定义对齐、引理与证明补全、实验脚本

## 6. 实际验证与最小示例

```sql
-- 观察读己之写与线性化读的区别（伪示意）
BEGIN; UPDATE kv SET v = 'x' WHERE k='a'; COMMIT;
-- 线性化读取（若提供强读开关）
SET read_consistency = 'linearizable';
SELECT v FROM kv WHERE k='a';
```

## 7. 参考文献

1. Herlihy & Wing. Linearizability: A Correctness Condition for Concurrent Objects. ACM TOPLAS, 1990.
2. Gilbert & Lynch. Brewer's Conjecture and the Feasibility of Consistent, Available, Partition-Tolerant Web Services. SIGACT, 2002.
3. Ongaro & Ousterhout. In Search of an Understandable Consensus Algorithm (Raft). USENIX ATC, 2014.
