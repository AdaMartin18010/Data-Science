---
title: 1.1.57-ARIES日志恢复-正确性与不变式
slug: 1.1.57-ARIES日志恢复-正确性与不变式
tags: []
pg_version: 16
status: draft
last_review: 2025-09-12
owner: TBD
---

﻿# 1.1.57 ARIES 日志恢复：正确性与不变式

## 1. 基本要素

- WAL（Write-Ahead Logging）：日志先行写入不变式（WAL规则）。
- LSN：日志序列号；每页 `pageLSN` 记录最后重做的日志LSN。
- 检查点：`BEGIN_CKPT/END_CKPT`，记录脏页表与活动事务表摘要。

## 2. 不变式

- I1（WAL）：在持久化任何页修改前，相应日志记录已持久化。
- I2（重做幂等）：若 `log.lsn <= page.pageLSN`，则跳过重做；否则按日志重做并更新 `pageLSN`。
- I3（撤销单调）：按逆序撤销失败/未提交事务的日志，生成补偿日志记录（CLR），CLR 自身可重做而不会重复撤销。

## 3. 恢复三阶段（ARIES）

- 分析（Analysis）：从最近检查点开始重建脏页表（DPT）与事务表（TT）。
- 重做（Redo）：自最小 `recLSN` 起对可能受影响的页执行物理重做（幂等）。
- 撤销（Undo）：对未提交事务按 `lastLSN` 回滚，写入CLR，直至到达起点。

## 4. 正确性提纲

- 安全性：I1 确保重启后不缺失日志；I2 确保多次重做不改变最终状态；I3 确保撤销可恢复并记录可重做的补偿。
- 完备性：分析阶段覆盖了所有脏页与未决事务；重做覆盖所有需要的页；撤销直至所有未提交效果被补偿。

## 5. 示例片段

```text
T1: update A
T2: update B
crash
restart
Analysis: DPT={A,B}, TT={T1,T2}
Redo: 重做影响 A,B 的记录（依据 pageLSN 判定）
Undo: 回滚未提交的 T1/T2，写 CLR
```

## 6. 与PostgreSQL的关联

- PostgreSQL采用WAL与多进程恢复流程，语义接近ARIES：
  - WAL日志（`pg_wal`）与 `full_page_writes`；
  - 恢复：`startup` 进程执行重放；崩溃恢复/基准恢复/流复制回放共用重放代码路径。

## 7. 工程建议

- 合理的检查点与 `max_wal_size` 配置以平衡恢复时间与运行时I/O；
- 保持 `full_page_writes` 默认开启以避免部分写损坏；
- 使用 `pg_waldump`/`pg_walinspect` 分析WAL以诊断恢复路径。
