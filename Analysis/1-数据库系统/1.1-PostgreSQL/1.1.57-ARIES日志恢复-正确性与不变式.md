# 1.1.57 ARIES 日志恢复：正确性与不变式（纯形式化)

## 目录

1. 模型与日志结构
2. 不变式与顺序
3. 正确性定理

## 1. 模型

- 日志项含 LSN、PageID、Before/After、TxnID、CLR（补偿日志）。
- 检查点记录脏页表与事务表快照。

## 2. 不变式

- Inv1（WAL）：数据页落盘前，其对应日志 LSN ≤ FlushedLSN；
- Inv2（单调）：FlushedLSN 单调不减；
- Inv3（幂等REDO）：若页的 PageLSN ≥ 操作 LSN，则跳过该 REDO；
- Inv4（补偿）：UNDO 通过 CLR 记录幂等、可重入。

## 3. 正确性

- 定理 3.1（REDO 正确性）：按 LSN 非降顺序重做至 FlushedLSN，结合 PageLSN 判定，得到崩溃前持久化前缀的一致状态。
- 定理 3.2（UNDO 正确性）：对未完成事务自最近日志逆序 UNDO，依 CLR 保证幂等与可重启，最终删除所有未完成效果。
- 定理 3.3（达成一致）：REDO 后再 UNDO，系统达一致状态且满足 Inv1–Inv4。
