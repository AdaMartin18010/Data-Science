# 1.1.59 表分区与分区裁剪：语义与等价

## 1. 分区模型

- 声明式分区：`R` 以 `PARTITION BY RANGE | LIST | HASH` 划分为子表 \(\{R_i\}\)。
- 约束：每个分区具检查约束 \(\chi_i\) 描述其取值域，且 \(\{\chi_i\}\) 互斥并（理想上）覆盖父表域。

## 2. 裁剪语义

- 判据：查询谓词 \(\psi\) 与分区约束 \(\chi_i\) 若不可满足，则在规划时排除 \(R_i\)。
- 等价：
  \[ \sigma_\psi\Big(\bigcup_i R_i\Big) \equiv \bigcup_{i:\;sat(\psi\wedge\chi_i)} \sigma_\psi(R_i). \]

## 3. 规划器行为

- 静态裁剪：基于常量/可折叠表达式进行分区剪枝；
- 运行时裁剪：参数化查询在执行期根据参数值剪枝（在并行计划中尤为重要）。

## 4. 示例

```sql
CREATE TABLE order_items (
  id bigserial PRIMARY KEY,
  created_at timestamptz NOT NULL,
  sku text NOT NULL
) PARTITION BY RANGE (created_at);

CREATE TABLE order_items_2025_09 PARTITION OF order_items
FOR VALUES FROM ('2025-09-01') TO ('2025-10-01');

EXPLAIN SELECT * FROM order_items
WHERE created_at >= '2025-09-10' AND created_at < '2025-09-11';
```

## 5. 注意事项

- 约束准确性：确保边界不重叠且完整覆盖，否则可能回退扫描父表或遗漏；
- 索引：分区本地索引需在热点分区上完善；
- 统计：分区级统计与父表统计的交互影响计划质量；
- 合并：跨分区聚合/排序可能触发 Append + Merge；适当并行化与增量聚合可降低代价。

## 6. 交叉引用

- `1.1.58-部分索引与约束排除-语义与正确性.md`
- `02-查询处理/02.01-查询优化器原理.md`

---

## 附录索引（相关专题）

- 分区策略与权衡：`1.1.87-数据库分区策略-负载均衡与查询优化的权衡.md`
- 并行与裁剪：`1.1.81-并行查询调度-负载均衡与通信代价的最优化.md`
- 统计与裁剪效果：`1.1.78-统计直方图自适应分箱-一致性与复杂度证明.md`
