# 流处理与CEP

## 1. 概述

- 目标：以 PostgreSQL 生态实现基础流式分析与简化CEP模式匹配（与外部队列/引擎协同）。
- 场景：日志实时统计、告警检测、订单状态流、IoT 事件汇聚。

## 2. 时间与窗口模型

- 时间语义：事件时间（event time）与处理时间（processing time）；
- 水印（watermark）：近似界定迟到数据的阈值；
- 窗口：滚动/滑动/会话窗口与迟到处理策略（补发/丢弃/更正）。

```sql
-- 滚动窗口（按分钟聚合）示意
SELECT date_trunc('minute', ts) AS win,
       count(*) AS cnt
FROM events
WHERE ts >= now() - interval '10 minutes'
GROUP BY 1
ORDER BY 1;
```

## 3. PostgreSQL 实现路径

- 增量物化：基于物化视图 + 定时刷新/触发器，结合 `1.1.47` 增量规则；
- 通知通道：`LISTEN/NOTIFY` 驱动应用层增量处理；
- 外部队列/FDW：Kafka/Redpanda + FDW 导入；
- 流式视图：基于时间分区 + 索引扫描实现近实时滑动窗口。

```sql
-- 近实时滑动窗口聚合（按5分钟）
WITH w AS (
  SELECT date_trunc('minute', ts) AS m, payload
  FROM events
  WHERE ts >= now() - interval '30 minutes'
)
SELECT date_trunc('minute', m) - (EXTRACT(MINUTE FROM m)::int % 5) * interval '1 minute' AS win,
       count(*)
FROM w
GROUP BY 1
ORDER BY 1;
```

## 4. 简化CEP模式（示意）

- 模式：A 事件后 T 内出现 B（同 key）触发告警；

```sql
-- A->B 模式：同用户 1 分钟内
WITH a AS (
  SELECT user_id, ts FROM events WHERE type = 'A'
), b AS (
  SELECT user_id, ts FROM events WHERE type = 'B'
)
SELECT a.user_id, a.ts AS a_ts, b.ts AS b_ts
FROM a JOIN b USING (user_id)
WHERE b.ts >= a.ts AND b.ts < a.ts + interval '1 minute';
```

- 更多复杂序列可借递归CTE/窗口函数表达，或将模式引擎（Flink/Esper）与PG联动。

## 5. 最佳实践

- 分区与索引：时间分区 + `(key, ts)` 索引；
- 迟到策略：保留一段宽松窗口，周期回补再发布（幂等写）；
- 可观测：延迟、吞吐、丢弃/补发比率、刷新耗时；
- 一致性：Exactly-Once 通过幂等写 + 去重键实现。

## 6. 交叉引用

- `1.1.29-流处理与时间语义-窗口与CEP的形式化.md`
- `1.1.47-增量物化视图-代数差分与正确性.md`
- `1.1.100-数据库流处理模型-流查询语言与窗口操作的形式化.md`
