---
title: 03.06-图数据库功能
slug: 03.06-图数据库功能
tags: []
pg_version: 16
status: draft
last_review: 2025-09-12
owner: TBD
---

# 图数据库功能

## 1. 概述

- 图数据建模、图查询、图算法，属性图与路径分析。

## 2. 属性图模型

- 元素：`Vertex(v_id, label, properties)`；`Edge(e_id, src, dst, label, properties)`。
- 语义：属性键值对（JSONB 适合属性承载），标签用于类型与约束分类；边可定向/无向以列模型表示。
- 存储建模：
  - 顶点表：`vertices(id bigint pk, label text, props jsonb)`。
  - 边表：`edges(id bigint pk, src bigint, dst bigint, label text, props jsonb)`，索引 `(src)`, `(dst)`, `(label)`，以及 `GIN(props)`。

## 3. SQL/PGQL 风格查询

- 可在 SQL 中表达图遍历：半连接/递归CTE 表达可达性与路径枚举；
- PGQL/开放Cypher风格可映射到 CTE + 连接计划；

```sql
-- 3.1 直接邻居
SELECT v2.*
FROM vertices v1
JOIN edges e ON e.src = v1.id AND e.label = 'follows'
JOIN vertices v2 ON v2.id = e.dst
WHERE v1.id = $1;

-- 3.2 k步可达（递归CTE）
WITH RECURSIVE reach(id, depth, path) AS (
  SELECT $1, 0, ARRAY[$1]
  UNION ALL
  SELECT e.dst, r.depth + 1, r.path || e.dst
  FROM reach r
  JOIN edges e ON e.src = r.id
  WHERE r.depth < 3 AND NOT e.dst = ANY(r.path)
)
SELECT * FROM reach;

-- 3.3 最短路（无权 BFS 轮廓）
WITH RECURSIVE bfs(node, depth, path) AS (
  SELECT $1, 0, ARRAY[$1]
  UNION ALL
  SELECT e.dst, b.depth + 1, b.path || e.dst
  FROM bfs b
  JOIN edges e ON e.src = b.node
  WHERE NOT e.dst = ANY(b.path)
)
SELECT * FROM bfs WHERE node = $2 ORDER BY depth LIMIT 1;
```

## 4. 图算法与实现

- 无权最短路径：递归CTE / 分批BFS；大图建议在应用层批次推进。
- PageRank/连通分量：以迭代计算表达，或用外部引擎（如Apache AGE扩展、GraphBLAS/外部计算）。
- 索引建议：`(src)`, `(dst)`, 以及热门边标签过滤索引；属性检索使用 `props` 上的表达式/GIN 索引。

### 4.1 Apache AGE（开放Cypher on PostgreSQL）

- 安装与启用：

  ```sql
  CREATE EXTENSION IF NOT EXISTS age;
  LOAD 'age';
  SELECT * FROM create_graph('g');
  ```

- Cypher 示例：

  ```sql
  SELECT * FROM cypher('g', $$
    CREATE (a:User {id:1,name:'A'})-[:FOLLOWS]->(b:User {id:2,name:'B'})
  $$) as (v agtype);

  SELECT * FROM cypher('g', $$
    MATCH (a:User {id:1})-[:FOLLOWS*1..3]->(x)
    RETURN x LIMIT 10
  $$) as (x agtype);
  ```

- 运维要点：版本兼容（PG/AGE）、统计与 ANALYZE、与常规SQL混合查询的代价控制。

### 4.2 PG-Cypher/FDW 混合

- 通过 FDW 对接专用图引擎（Neo4j/TigerGraph）进行跨库查询；在PG做过滤、在图引擎做遍历。

## 5. 与向量/全文/JSON 的混合

- 节点属性向量化：在 `vertices` 侧增加 `embedding vector(n)` 列，结合 pgvector 做“图内语义检索 + 路径约束”。
- 全文结合：对 `props->>'text'` 建立 `to_tsvector` + GIN，先全文召回再走路径。
- JSON 模式：属性采用 JSONB，重要字段冗余列以提升统计与索引质量。

## 6. 约束与一致性

- 唯一约束：`vertices(label,id)`、`edges(id)`；
- 参照完整性：`edges.src`/`edges.dst` 引用 `vertices.id`，`ON DELETE CASCADE | RESTRICT` 视语义选择；
- 业务约束：避免自环/多重边可用排他约束或唯一组合。

## 7. 性能与运维

- 批量导入：关闭次要索引、使用 `COPY`、导入后并发创建索引；
- 分区策略：按标签或范围分区大图；
- 监控：`pg_stat_user_tables`、热点边过滤、递归CTE深度与成本审计。

## 8. 示例建模脚本

```sql
CREATE TABLE vertices (
  id   BIGSERIAL PRIMARY KEY,
  label TEXT NOT NULL,
  props JSONB NOT NULL DEFAULT '{}'
);
CREATE TABLE edges (
  id   BIGSERIAL PRIMARY KEY,
  src  BIGINT NOT NULL REFERENCES vertices(id) ON DELETE CASCADE,
  dst  BIGINT NOT NULL REFERENCES vertices(id) ON DELETE CASCADE,
  label TEXT NOT NULL,
  props JSONB NOT NULL DEFAULT '{}'
);
CREATE INDEX idx_edges_src ON edges(src);
CREATE INDEX idx_edges_dst ON edges(dst);
CREATE INDEX idx_edges_label ON edges(label);
CREATE INDEX idx_vertices_props_gin ON vertices USING GIN (props);
```

## 9. 交叉引用

- `03.05-向量数据库支持.md`
- `1.1.98-数据库JSON数据模型-JSON查询与模式验证的形式化.md`
- `1.1.3-查询语言.md`（递归CTE）
