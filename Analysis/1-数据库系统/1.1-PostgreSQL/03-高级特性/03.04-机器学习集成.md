# 机器学习集成

## 1. 概述

- 内嵌推理、特征存取、训练/推理流水线、在线/离线协同

## 2. 合并来源与映射

- 1.1.6-AI与PostgreSQL集成.md
- 1.1.12-AI集成与智能数据库.md
- 1.1.151-PostgreSQL与AI模型深度集成分析.md
- 1.1.20-PostgreSQL与AI模型深度集成架构.md

## 3. 参考架构

- 模型注册/版本管理、UDF/UDAF、FDW、作业编排与资源隔离

### 3.1 形态一：数据库内推理（UDF/扩展）

- 适用：轻量模型、低延迟、特征在库内即可获取；
- 方式：
  - pl/pythonu 或 C 扩展包装推理；
  - 外部推理服务通过 FDW/HTTP 扩展访问（如 `postgres_fdw`/`http_fdw`）。

### 3.2 形态二：近库服务（Sidecar/Gateway）

- 适用：中大型模型、GPU 资源隔离；
- 数据流：PG 提供特征/过滤 → 服务做推理 → 回写结果/特征缓存。

### 3.3 形态三：离线训练 + 在线特征/推理

- 特征存取层（Feature Store）：维表、时间戳一致性、回放；
- 训练在外部平台（Spark/Ray），PG 作为样本源与标签仓。

## 4. 实践要点

- 安全与审计、可解释性、漂移监测、A/B测试、缓存与加速

### 4.1 特征工程与一致性

- 维度表快照与时间旅行：双时态/有效期列，确保训练/推理一致；
- UDF 实现标准化/归一化函数，保证跨批次一致的变换。

### 4.2 在线推理模式

- 同步模式：事务内调用 UDF/外部服务（注意超时与补偿）；
- 异步模式：事件驱动（NOTIFY/LISTEN、消息队列）+ 任务执行器回写结果。

### 4.3 缓存与加速

- 近似向量检索 + 结构化过滤；
- 结果缓存：按输入特征签名缓存，TTL 与失效策略；
- GPU/加速器：部署于近库节点，避免跨 AZ 浪费带宽。

### 4.4 漂移与质量监控

- 数据分布对比、模型输出统计、业务KPI 关联；
- 回收学习样本闭环：将推理样本/反馈写回训练集。

## 5. 后续整合任务

- 与 05.02-AI模型深度集成 的职责边界与链接映射、示例对齐

## 6. 示例：plpythonu 推理UDF（简化）

```sql
CREATE EXTENSION IF NOT EXISTS plpythonu;

CREATE OR REPLACE FUNCTION infer_score(x double precision[])
RETURNS double precision
AS $$
  import math
  # 这里示意：可在函数内加载轻量模型或调用本地服务
  return sum(x)/max(len(x),1)
$$ LANGUAGE plpythonu IMMUTABLE;

SELECT id, infer_score(features)
FROM samples
ORDER BY 2 DESC
LIMIT 20;
```

## 7. 示例：HTTP 外部推理（伪示例）

```sql
-- 以 http_fdw 为例（若使用特定扩展，依其语法调整）
CREATE EXTENSION IF NOT EXISTS http;
SELECT * FROM http_get('http://inference.svc/predict?x=1,2,3');
```
