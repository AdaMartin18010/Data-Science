---
title: 03.04-机器学习集成
slug: 03.04-机器学习集成
tags: []
pg_version: 16
status: draft
last_review: 2025-09-12
owner: TBD
---

# 机器学习集成

> 📖 **文档说明**
>
> 本文档提供ML集成的**实践模式概述**。如需详细内容，请参考：
>
> - 🚀 [RAG架构实战指南](../05-前沿技术/05.04-RAG架构实战指南.md) - 完整可运行方案
> - 📚 [AI模型深度集成](../05-前沿技术/05.02-AI模型深度集成.md) - 理论架构参考
> - ☁️ [Azure AI扩展实战](../05-前沿技术/05.03-Azure-AI扩展实战.md) - 云原生方案

---

## 1. 概述

PostgreSQL的机器学习集成主要包括：

- **内嵌推理**: 数据库内轻量模型推理
- **特征存取**: Feature Store功能
- **训练/推理流水线**: 端到端ML工作流
- **在线/离线协同**: 训练与服务分离

## 3. 参考架构

- 模型注册/版本管理、UDF/UDAF、FDW、作业编排与资源隔离

### 3.1 形态一：数据库内推理（UDF/扩展）

- 适用：轻量模型、低延迟、特征在库内即可获取；
- 方式：
  - pl/pythonu 或 C 扩展包装推理；
  - 外部推理服务通过 FDW/HTTP 扩展访问（如 `postgres_fdw`/`http_fdw`）。

### 3.2 形态二：近库服务（Sidecar/Gateway）

- 适用：中大型模型、GPU 资源隔离；
- 数据流：PG 提供特征/过滤 → 服务做推理 → 回写结果/特征缓存。

### 3.3 形态三：离线训练 + 在线特征/推理

- 特征存取层（Feature Store）：维表、时间戳一致性、回放；
- 训练在外部平台（Spark/Ray），PG 作为样本源与标签仓。

## 4. 实践要点

- 安全与审计、可解释性、漂移监测、A/B测试、缓存与加速

### 4.1 特征工程与一致性

- 维度表快照与时间旅行：双时态/有效期列，确保训练/推理一致；
- UDF 实现标准化/归一化函数，保证跨批次一致的变换。

### 4.2 在线推理模式

- 同步模式：事务内调用 UDF/外部服务（注意超时与补偿）；
- 异步模式：事件驱动（NOTIFY/LISTEN、消息队列）+ 任务执行器回写结果。

### 4.3 缓存与加速

- 近似向量检索 + 结构化过滤；
- 结果缓存：按输入特征签名缓存，TTL 与失效策略；
- GPU/加速器：部署于近库节点，避免跨 AZ 浪费带宽。

### 4.4 漂移与质量监控

- 数据分布对比、模型输出统计、业务KPI 关联；
- 回收学习样本闭环：将推理样本/反馈写回训练集。

## 5. 实战示例

### 5.1 plpythonu 推理UDF

```sql
-- ✅ [可运行] 需要plpythonu扩展
CREATE EXTENSION IF NOT EXISTS plpythonu;

CREATE OR REPLACE FUNCTION infer_score(x double precision[])
RETURNS double precision
AS $$
  import math
  # 这里示意：可在函数内加载轻量模型或调用本地服务
  # 生产环境建议使用pickle加载预训练模型
  return sum(x)/max(len(x),1)
$$ LANGUAGE plpythonu IMMUTABLE;

-- 使用示例
SELECT id, infer_score(features) as score
FROM samples
ORDER BY score DESC
LIMIT 20;
```

### 5.2 HTTP 外部推理

```sql
-- 🔧 [需扩展] http扩展
CREATE EXTENSION IF NOT EXISTS http;

-- 调用外部推理服务
SELECT * FROM http_get('http://inference.svc/predict?x=1,2,3');
```

---

## 6. 进阶学习

### 完整实战方案

**强烈推荐**: [RAG架构实战指南](../05-前沿技术/05.04-RAG架构实战指南.md)

- ✅ 2878行完整代码
- ✅ LangChain + LlamaIndex集成
- ✅ Docker Compose一键部署
- ✅ 生产级监控方案

### 其他资源

- [向量检索性能调优](../05-前沿技术/05.05-向量检索性能调优指南.md)
- [Azure AI扩展实战](../05-前沿技术/05.03-Azure-AI扩展实战.md)
- [AI模型深度集成](../05-前沿技术/05.02-AI模型深度集成.md) (理论参考)
