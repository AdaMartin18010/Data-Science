# 向量数据库支持

## 1. 概述

- 向量类型、相似度检索、混合查询（向量+结构化/全文）。

## 2. 类型与距离

- 类型：`vector(n)`（pgvector 扩展），`n` 为维度。
- 距离度量：`L2`（欧氏）、`IP`（内积）、`COSINE`（余弦）。
- 相似度与排序：`ORDER BY embedding <-> query_vec`（L2/余弦），`<#>`（内积）。

## 3. 索引与算法

- HNSW：近似NN图检索，召回高、查询快，内存占用较大。
- IVFFlat：倒排粗量化，适合批量查询与大规模数据，需 `ANALYZE` 以良好分桶。
- PQ/IVFPQ：乘积量化压缩，显著节省存储但牺牲精度。

```sql
-- 安装与类型
CREATE EXTENSION IF NOT EXISTS vector;

-- 基础表
CREATE TABLE docs (
  id bigserial PRIMARY KEY,
  text text,
  embedding vector(768)
);

-- 索引：HNSW/IVFFlat/PQ
CREATE INDEX ON docs USING hnsw (embedding vector_l2_ops);
-- 或
CREATE INDEX ON docs USING ivfflat (embedding vector_cosine_ops) WITH (lists = 200);
-- 或
CREATE INDEX ON docs USING ivfflat (embedding vector_ip_ops) WITH (lists = 100);

-- 典型查询
WITH q AS (
  SELECT '[0.1,0.2,...]'::vector AS qv
)
SELECT id, text
FROM docs, q
ORDER BY embedding <-> q.qv
LIMIT 20;
```

## 4. 混合检索（结构化/全文/向量）

- 与结构化过滤：先用结构化谓词裁剪候选，再进行ANN；或以 ANN 返回候选后再做结构化过滤/重排。
- 与全文搜索：`to_tsvector` + GIN 与向量召回的交集/加权融合。

```sql
-- 结构化 + 向量
SELECT id, text
FROM docs
WHERE created_at >= now() - interval '7 day'
ORDER BY embedding <-> '[...]'::vector
LIMIT 50;

-- 全文 + 向量（粗召回 + 精重排）
WITH s AS (
  SELECT id, ts_rank(to_tsvector('simple', text), plainto_tsquery('simple','postgres')) AS tr
  FROM docs
  WHERE to_tsvector('simple', text) @@ plainto_tsquery('simple','postgres')
  ORDER BY tr DESC
  LIMIT 500
), v AS (
  SELECT id, embedding <-> '[...]'::vector AS dist
  FROM docs WHERE id IN (SELECT id FROM s)
  ORDER BY dist ASC LIMIT 100
)
SELECT * FROM v ORDER BY dist ASC;
```

## 5. 存储布局与冷热分层

- 行存 + 大向量：考虑 `TOAST` 与I/O；热字段与向量分表或列化（如外部对象存储/FDW）。
- 冷热分层：热集合保留高精度HNSW，冷集合采用IVFPQ压缩，统一在视图/UNION层聚合。

## 6. 参数与调优

- HNSW：`M`、`ef_construction`（建索引质量）、`ef_search`（查询召回/延迟权衡）。
- IVFFlat：`lists`（分桶数）与 `probes`（查询桶数）；分桶需 `ANALYZE` 充足统计。
- PQ：`m`（子空间数）、`nbits`（码本位数）。
- 维度与归一化：余弦相似度常需单位化；内积需向量中心化/归一化以稳定排序。

## 7. 基准与正确性

- 召回/精度：与暴力真值（Brute-Force）对比；评估 Recall@k、MRR、延迟TP50/TP99。
- 可重复性：固定随机种子、记录版本与参数；离线批量重建评估。

## 8. 交叉引用

- `05-前沿技术/05.02-AI模型深度集成.md`
- `1.1.3-查询语言.md`（ORDER BY 距离算子）
- `1.1.2-数据模型.md`（混合模型与索引）
