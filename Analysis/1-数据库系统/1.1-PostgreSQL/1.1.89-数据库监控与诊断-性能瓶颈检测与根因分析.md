---
title: 1.1.89-数据库监控与诊断-性能瓶颈检测与根因分析
slug: 1.1.89-数据库监控与诊断-性能瓶颈检测与根因分析
tags: []
pg_version: 16
status: draft
last_review: 2025-09-12
owner: TBD
---

﻿# 1.1.89-数据库监控与诊断-性能瓶颈检测与根因分析

## 摘要

- 目标：建立“指标→瓶颈→根因→修复”的闭环，形成最小监控面与诊断剧本。

## 问题定义（形式化）

- 定义监控向量 M = (QPS, p95, CPU%, IO等待, 缓存命中, 活跃连接数, Checkpoint间隔, WAL生成速率, Autovacuum延迟)。
- 给定阈值配置 Θ 与知识规则库 K，构造分类器 f(M, Θ, K) → {CPU瓶颈, IO瓶颈, 锁争用, 统计过期, 膨胀/膨大, 配置不匹配,...}。

## 最小示例（可运行）

```sql
-- 1) 识别Top耗时查询
SELECT query, calls, total_exec_time, mean_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;

-- 2) 当前锁等待图
SELECT * FROM pg_locks pl
JOIN pg_stat_activity psa ON pl.pid = psa.pid
WHERE NOT granted;

-- 3) 缓存命中率与IO
SELECT blks_hit::float/(blks_hit+blks_read+1) AS cache_hit_ratio
FROM pg_stat_database WHERE datname = current_database();
```

## 实务要点

- 最小监控面：pg_stat_statements、pg_stat_io、pg_stat_activity、pg_locks、WAL速率、检查点、Autovacuum。
- 诊断顺序：全局资源→等待/锁→SQL画像→统计信息→存储膨胀→参数校准。
- 修复优先：前10%热点SQL、统计刷新、索引/执行计划修正、连接池与内存参数微调。

## 交叉引用

- `1.1.4-查询优化-增强版.md`
- `1.1.49-选择率估计误差-敏感性与上界.md`
- `1.1.16-性能调优与监控.md`
