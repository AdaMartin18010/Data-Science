# 性能调优-变更闭环（Runbook）

## 1. 目标

- 在生产环境中以最小风险完成参数/SQL/结构优化，形成“监测→诊断→定位→变更→验证→回滚/固化”的闭环。
- 对齐文档：`04-部署运维/04.06-性能调优实践.md`、`04.04-监控与诊断.md`。

## 2. 前置检查

- 业务窗口：确认灰度范围与低峰时段；
- 备份/回滚：配置备份点/快照；准备回滚脚本（参数旧值、DDL 回滚方案）。
- 指标面板：P95/P99、TPS/QPS、命中率、WAL 速率、检查点、锁等待、Autovacuum 滞后。

## 3. 诊断入口

1) 慢查询/吞吐下降/延迟升高告警触发；
2) 执行 `sql/diagnostics.sql` 中 TopN + 等待事件；
3) 对疑似语句 `EXPLAIN (ANALYZE, BUFFERS, VERBOSE)`；
4) 评估策略：索引/统计/SQL/参数/架构。

## 4. 变更票据模板

```text
变更项：<参数/SQL/索引/结构>
对象/范围：<库/表/索引/服务>
旧值→新值：<从> → <到>
预期影响：<延迟/吞吐/资源>
验证窗口：<起止时间/灰度比例>
回滚条件：<P95 恶化>10% / 错误率升 / 锁冲突升>
负责人/审批：<Owner/Reviewer>
```

## 5. 执行步骤

1) 建立审计：记录参数旧值（`SHOW`/`pg_file_settings`）与计划基线；
2) 单变量小步变更；
3) 观察 15–30 分钟稳定窗口；
4) 达标则固化与文档化；不达标则回滚。

## 6. 常用参数建议（摘）

- 连接与并发：`max_connections`、`work_mem`；
- 缓冲：`shared_buffers`、`effective_cache_size`；
- 并行/JIT：`max_parallel_workers_per_gather`、`jit`；
- I/O：`random_page_cost`、`effective_io_concurrency`；
- 检查点/WAL：`checkpoint_timeout`、`max_wal_size`、`checkpoint_completion_target`、`wal_compression`；
- 维护：`autovacuum_*`、`maintenance_work_mem`。

## 7. 验证清单

- 指标对比：调优前/后 P95、TPS/QPS、命中率、WAL、检查点；
- SQL 对比：TopN 是否下降、估算偏差是否缓解；
- 资源：CPU/IO/内存是否在阈值内；
- 业务：错误率/超时是否正常。

## 8. 回滚与复盘

- 立即恢复参数旧值/撤销索引或重写；
- 附加证据：日志、慢SQL、EXPLAIN、面板截图；
- 复盘条目：问题根因、无效尝试、有效手段、可复用脚本。
