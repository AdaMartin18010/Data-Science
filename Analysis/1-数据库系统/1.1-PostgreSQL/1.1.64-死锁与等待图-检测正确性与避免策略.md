# 1.1.64-死锁与等待图-检测正确性与避免策略

## 摘要

- 目标：形式化等待图与死锁检测判据，提供最小诊断SQL与避免策略。

## 问题定义（形式化）

- 等待图 G=(T,E)，若存在有向环则死锁。检测即寻找环；预防策略为全序资源分配或两阶段加锁。

## 最小示例（可运行）

```sql
-- 等待中锁与会话
SELECT * FROM pg_locks pl
JOIN pg_stat_activity psa ON pl.pid = psa.pid
WHERE NOT granted;

-- 终止最老冲突会话（示意）
-- SELECT pg_terminate_backend(<pid>);
```

## 实务要点

- 设计：统一加锁顺序；长事务与大批量更新分批；设置 lock_timeout。
- 监控：告警阈值=等待时长/等待队列长度；定期采样等待图热点关系。
- 复盘：保存冲突SQL与执行计划，溯源索引缺失与统计过期。

## 交叉引用

- `1.1.69-两阶段加锁-可串行化的严格证明.md`
- `1.1.47-事务隔离理论-完整版.md`
- `1.1.75-锁升级与降级-安全性与死锁影响的形式证明.md`
