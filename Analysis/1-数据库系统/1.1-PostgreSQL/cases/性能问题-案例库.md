# 性能问题-案例库

结构：问题 → 证据 → 变更 → 效果 → 防再发

## 案例1：估算偏差导致错误连接顺序

- 证据：`pg_stat_statements` TopN、EXPLAIN 显示 Seq Scan + 高回表；
- 变更：`SET STATISTICS 2000`、扩展统计（dependencies），新增表达式索引；
- 效果：P95 ↓ 45%，CPU 降低 20%；
- 防再发：定期 ANALYZE、新增字段变更纳入统计策略。

## 案例2：锁等待链导致延迟尖刺

- 证据：`pg_locks` 未授予锁、长事务持锁；
- 变更：拆分 DDL、批量写序化、合理索引避免热点扫描；
- 效果：超时率从 2% 降至 0.1%；
- 防再发：锁等待告警、DDL 变更窗口审批。

## 案例3：检查点过于频繁

- 证据：`log_checkpoints`、WAL 暴涨、延迟尖刺；
- 变更：提升 `max_wal_size`、`checkpoint_timeout`、`checkpoint_completion_target`；
- 效果：P95 稳定，磁盘写突刺降低；
- 防再发：阈值告警与容量规划。

## 案例4：分区裁剪不生效

- 证据：计划显示扫描所有分区；谓词非分区键表达式；
- 变更：改写谓词使可裁剪、增加分区键冗余列或生成列；
- 效果：计划时间下降，I/O 显著降低；
- 防再发：分区设计评审与查询规范。

## 案例5：统计信息缺失导致Bitmap堆低效

- 证据：估算偏差、Bitmap Heap Recheck 过多；
- 变更：提升 `default_statistics_target`，针对列设置更高统计；
- 效果：回表减少，P95 下降；
- 防再发：批量导入后 ANALYZE、定期统计维护。

## 案例6：RLS 策略误配影响计划

- 证据：每次访问附带复杂策略过滤，计划变慢；
- 变更：优化策略为可索引谓词，必要时策略分层或绕过只读报表；
- 效果：TP95 明显下降；
- 防再发：RLS 变更评审与计划对比。

## 案例7：外键缺索引导致写放大

- 证据：插入/更新外键行时阻塞与全表扫描；
- 变更：为外键列补充索引；
- 效果：写延迟下降，锁等待减少；
- 防再发：DDL 审计规则强制外键建索引。

## 案例8：顺序键插入热点页导致B-Tree分裂

- 证据：插入热点集中，索引分裂与页抖动；
- 变更：使用 `fillfactor`、反转ID或哈希分布、分区；
- 效果：写抖动下降；
- 防再发：建模阶段评审自增/顺序键策略。
