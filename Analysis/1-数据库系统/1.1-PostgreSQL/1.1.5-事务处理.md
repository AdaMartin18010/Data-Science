---
title: 1.1.5-事务处理
slug: 1.1.5-事务处理
tags: []
pg_version: 16
status: draft
last_review: 2025-09-12
owner: TBD
---

﻿# 1.1.5-事务处理

> PostgreSQL 事务、隔离级别、MVCC、锁管理、死锁检测、2PC/SAGA、SSI可串行化与示例。

## 1. 事务与ACID

- 原子性（Atomicity）：失败回滚，成功提交全有或全无。
- 一致性（Consistency）：事务边界保持不变式，配合约束/触发器。
- 隔离性（Isolation）：并发事务间互不干扰（语义上）。
- 持久性（Durability）：提交写入WAL并持久化。

## 2. 隔离级别与可见性

- Read Uncommitted：在PostgreSQL中等同于 Read Committed。
- Read Committed（默认）：每条语句获取最新提交可见快照。
- Repeatable Read：事务级快照，避免不可重复读，但可能出现幻读处理为SSI检测。
- Serializable：基于 Serializable Snapshot Isolation（SSI）实现，检测并打破危险结构以保证可串行化（参见 `Ports & Grittner 2012`，索引于 `INDEX.md`）。

## 3. MVCC 概念与实现要点

- 元组版本：`xmin/xmax` 版本链；可见性由事务快照裁剪。
- 垃圾回收：`VACUUM` 清理不可见版本，`FREEZE` 冻结老版本避免计数回绕（参见 `1.1.36`）。
- 快照：语句级/事务级；冲突由锁/SSI与谓词锁补充。

## 4. 锁管理（Locking）

- 行级锁：`FOR UPDATE/SHARE`、`SKIP LOCKED`、`NOWAIT`。
- 表级锁：`ACCESS SHARE/EXCLUSIVE` 等多级别；DDL/DML协调。
- 轻量锁与缓冲区锁：内部同步，避免热点与死锁。
- 谓词锁（Predicate Lock）：支持SSI检测幽灵现象，见 `1.1.48`。

## 5. 死锁检测与避免

- 等待图与环检测：后台进程周期扫描；见 `1.1.64-死锁与等待图-检测正确性与避免策略.md`。
- 避免策略：缩短持锁时间、固定锁顺序、细化锁粒度、拆分大事务。
- 冲突处理：`deadlock_timeout`、`lock_timeout` 合理配置；应用层重试。

## 6. 分布式事务：2PC 与 SAGA

- 两阶段提交（2PC）：`PREPARE TRANSACTION` / `COMMIT PREPARED` / `ROLLBACK PREPARED`；阻塞与恢复策略见 `1.1.55`。
- SAGA：长事务分解为子事务与补偿动作；可达性与幂等性条件见 `1.1.56`。

## 7. 可串行化与SSI

- 风险结构：`rw-conflicts` 形成的危险三角，SSI通过谓词锁与冲突图拒绝某事务以破坏环（参见 `1.1.27`、`1.1.48`）。
- 事务开销：更高的内存与锁代价；仅在需要严格可串行化时开启。

## 8. 示例：事务与锁用法

```sql
-- 8.1 基本事务
BEGIN;
  UPDATE orders SET status = 'paid' WHERE id = 1001;
  INSERT INTO payment(order_id, amount) VALUES (1001, 199.00);
COMMIT;

-- 8.2 乐观并发：冲突重试
DO $$
DECLARE
  retries integer := 0;
BEGIN
  LOOP
    BEGIN
      START TRANSACTION ISOLATION LEVEL REPEATABLE READ;
        UPDATE inventory SET qty = qty - 1 WHERE sku = 'A-001' AND qty > 0;
        IF NOT FOUND THEN RAISE EXCEPTION 'out of stock'; END IF;
      COMMIT;
      EXIT;
    EXCEPTION WHEN serialization_failure THEN
      ROLLBACK;
      retries := retries + 1;
      IF retries > 5 THEN RAISE; END IF;
    END;
  END LOOP;
END$$;

-- 8.3 行级锁与跳过已锁
SELECT * FROM jobs
FOR UPDATE SKIP LOCKED
LIMIT 10;

-- 8.4 2PC 轮廓（跨系统）
BEGIN;
  UPDATE orders SET status = 'paid' WHERE id = 1001;
  PREPARE TRANSACTION 'tx_1001';
-- 外部协调者：在各参与者都 PREPARE 之后
COMMIT PREPARED 'tx_1001';
```

## 9. 运营建议

- 观察指标：冲突率、`serialization_failure`、等待锁时间、死锁次数、VACUUM 延迟。
- 参数基线：`max_connections`、`shared_buffers`、`autovacuum_*`、`max_locks_per_transaction`。
- 设计建议：短事务、幂等重试、热点拆分、批量写入、离峰重建索引。

## 10. 交叉引用

- MVCC与垃圾回收：`1.1.36`、`1.1.61`
- 谓词锁与幽灵消除：`1.1.48`
- 两阶段提交正确性：`1.1.55`
- 死锁检测与避免：`1.1.64`
