# 1.1.6-AI与PostgreSQL集成

## 1. 能力地图

- 向量检索：pgvector 扩展，支持 L2/IP/COSINE；
- 全文搜索：`to_tsvector/to_tsquery` 与 GIN；
- 半结构化：JSONB 存储与索引；
- 过程语言：PL/pgSQL、PL/Python 等；
- 流式/增量：物化视图、触发器、FDW 对接外部AI服务。

## 2. 参考架构（文字示意）

- 数据源 → 提取/清洗 → 生成嵌入（外部服务/批处理）→ `PostgreSQL(docs, embeddings)` → 应用层检索重排/推理；
- 混合检索：向量相似度 + 全文/结构化过滤；
- 模型管理：表中存放模型配置/超参与结果回溯。

## 3. 关键表设计与索引

```sql
CREATE EXTENSION IF NOT EXISTS vector;

CREATE TABLE docs (
  id bigserial PRIMARY KEY,
  title text,
  content text,
  content_tsv tsvector GENERATED ALWAYS AS (to_tsvector('simple', coalesce(content,''))) STORED,
  embedding vector(768),
  created_at timestamptz DEFAULT now()
);
CREATE INDEX idx_docs_tsv ON docs USING GIN (content_tsv);
CREATE INDEX idx_docs_embed ON docs USING hnsw (embedding vector_cosine_ops);
```

## 4. 混合检索示例

```sql
WITH q AS (
  SELECT '[...]'::vector AS qv, plainto_tsquery('simple','database postgresql') AS tsq
)
SELECT id, title
FROM docs, q
WHERE content_tsv @@ q.tsq
ORDER BY embedding <-> q.qv
LIMIT 20;
```

## 5. 推理与管道

- 内部：PL/Python 轻量推理（小模型/后处理）；
- 外部：应用层/服务网关调用大模型，回写向量与摘要；
- 质量闭环：定期重嵌入、评估 Recall@k/MRR、误判样本回灌。

## 6. 最佳实践

- 维度与度量：统一嵌入维度与度量，避免排序混乱；
- 数据治理：敏感数据加密与脱敏；
- 监控：索引大小、召回率、延迟TP95/TP99；
- 版本化：嵌入/模型版本列，支持回滚与对比。

## 7. 交叉引用

- `03-高级特性/03.05-向量数据库支持.md`
- `1.1.98-数据库JSON数据模型-JSON查询与模式验证的形式化.md`
- `1.1.3-查询语言.md`
