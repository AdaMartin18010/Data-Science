# SQL语言规范与标准

## 1. 定义与形式化

### 1.1 概念定义

**中文定义**: SQL（Structured Query Language）是一种声明式的关系数据库查询语言，支持数据定义、操作、查询和控制功能，是关系数据库的标准语言。PostgreSQL实现了完整的SQL:2023标准，并提供了丰富的扩展功能。

**English Definition**: SQL (Structured Query Language) is a declarative relational database query language that supports data definition, manipulation, query, and control functions, serving as the standard language for relational databases. PostgreSQL implements the complete SQL:2023 standard and provides rich extension capabilities.

### 1.2 形式化定义

```latex
% 数学符号定义
\newcommand{\sql}{\mathcal{SQL}}
\newcommand{\rel}{\mathcal{R}}
\newcommand{\attr}{\mathcal{A}}
\newcommand{\tuple}{\mathcal{T}}
\newcommand{\query}{\mathcal{Q}}
\newcommand{\result}{\mathcal{Result}}
\newcommand{\db}{\mathcal{D}}
\newcommand{\schema}{\mathcal{S}}

% SQL语言的形式化定义
\sql = (DDL, DML, DQL, DCL, TCL)

其中：
DDL = \{CREATE, ALTER, DROP, TRUNCATE\} \text{ 数据定义语言}
DML = \{INSERT, UPDATE, DELETE, MERGE\} \text{ 数据操作语言}
DQL = \{SELECT\} \text{ 数据查询语言}
DCL = \{GRANT, REVOKE, DENY\} \text{ 数据控制语言}
TCL = \{BEGIN, COMMIT, ROLLBACK, SAVEPOINT\} \text{ 事务控制语言}
```

### 1.3 理论基础

#### 1.3.1 关系代数对应关系

```latex
\begin{theorem}[SQL与关系代数等价性]
SQL语言在表达能力上等价于关系代数，即：
\forall q \in \query, \exists \sigma, \pi, \bowtie, \cup, \cap, - \text{ 使得 }
\result(q) = f(\sigma, \pi, \bowtie, \cup, \cap, -)
\end{theorem}

\begin{proof}
1. SELECT对应投影操作 \pi
2. WHERE对应选择操作 \sigma  
3. JOIN对应连接操作 \bowtie
4. UNION对应并集操作 \cup
5. INTERSECT对应交集操作 \cap
6. EXCEPT对应差集操作 -

因此，SQL的每个操作都可以用关系代数表示，反之亦然。
\end{proof}
```

#### 1.3.2 SQL完备性定理

```latex
\begin{theorem}[SQL完备性]
SQL语言是关系完备的，当且仅当：
1. 支持关系代数的所有基本操作
2. 支持递归查询（WITH RECURSIVE）
3. 支持聚合函数和分组操作
4. 支持子查询和嵌套查询
5. 支持窗口函数和OLAP功能
\end{theorem}

\begin{proof}
基于Codd定理，关系完备性要求：
- 能够表达关系代数的所有操作
- 能够处理递归关系
- 能够进行复杂的数据操作
- 能够支持分析查询

PostgreSQL的SQL实现满足以上所有条件，因此是关系完备的。
\end{proof}
```

## 2. 核心语法规范

### 2.1 数据定义语言（DDL）

#### 2.1.1 表定义

```sql
-- 标准表定义
CREATE TABLE employees (
    emp_id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name VARCHAR(50) NOT NULL,
    email VARCHAR(100) UNIQUE,
    dept_id INTEGER REFERENCES departments(dept_id),
    salary DECIMAL(10,2) CHECK (salary > 0),
    hire_date DATE DEFAULT CURRENT_DATE,
    manager_id INTEGER REFERENCES employees(emp_id),
    CONSTRAINT emp_salary_check CHECK (salary >= 0 AND salary <= 1000000)
);

-- 索引定义
CREATE INDEX idx_emp_dept ON employees(dept_id);
CREATE UNIQUE INDEX idx_emp_email ON employees(email);
CREATE INDEX idx_emp_salary ON employees(salary) WHERE salary > 50000;
```

#### 2.1.2 视图定义

```sql
-- 简单视图
CREATE VIEW emp_summary AS
SELECT 
    dept_id,
    COUNT(*) as emp_count,
    AVG(salary) as avg_salary,
    MAX(salary) as max_salary
FROM employees
GROUP BY dept_id;

-- 可更新视图
CREATE VIEW emp_public AS
SELECT emp_id, name, dept_id
FROM employees
WHERE active = true;

-- 物化视图
CREATE MATERIALIZED VIEW emp_stats AS
SELECT 
    dept_id,
    COUNT(*) as emp_count,
    AVG(salary) as avg_salary
FROM employees
GROUP BY dept_id;
```

### 2.2 数据操作语言（DML）

#### 2.2.1 插入操作

```sql
-- 单行插入
INSERT INTO employees (emp_id, name, dept_id, salary) 
VALUES (1001, '张三', 1, 50000);

-- 多行插入
INSERT INTO employees (emp_id, name, dept_id, salary) VALUES
    (1002, '李四', 1, 55000),
    (1003, '王五', 2, 60000);

-- 使用RETURNING子句（PostgreSQL特性）
INSERT INTO employees (name, dept_id, salary)
VALUES ('新员工', 1, 45000)
RETURNING emp_id, name, salary;

-- 从查询结果插入
INSERT INTO employees (name, dept_id, salary)
SELECT name, dept_id, salary * 1.1
FROM temp_employees
WHERE salary < 50000;
```

#### 2.2.2 更新操作

```sql
-- 简单更新
UPDATE employees 
SET salary = salary * 1.05
WHERE dept_id = 1;

-- 使用子查询更新
UPDATE employees 
SET salary = (
    SELECT AVG(salary) 
    FROM employees e2 
    WHERE e2.dept_id = employees.dept_id
)
WHERE salary < (
    SELECT AVG(salary) 
    FROM employees e3 
    WHERE e3.dept_id = employees.dept_id
);

-- 使用RETURNING子句
UPDATE employees 
SET salary = salary * 1.1
WHERE dept_id = 2
RETURNING emp_id, name, salary;
```

#### 2.2.3 删除操作

```sql
-- 简单删除
DELETE FROM employees 
WHERE emp_id = 1001;

-- 使用子查询删除
DELETE FROM employees 
WHERE dept_id IN (
    SELECT dept_id 
    FROM departments 
    WHERE status = 'inactive'
);

-- 使用RETURNING子句
DELETE FROM employees 
WHERE hire_date < '2020-01-01'
RETURNING emp_id, name, hire_date;
```

### 2.3 数据查询语言（DQL）

#### 2.3.1 基本查询

```sql
-- 基本SELECT
SELECT emp_id, name, salary
FROM employees
WHERE dept_id = 1
ORDER BY salary DESC;

-- 聚合查询
SELECT 
    dept_id,
    COUNT(*) as emp_count,
    AVG(salary) as avg_salary,
    MIN(salary) as min_salary,
    MAX(salary) as max_salary
FROM employees
GROUP BY dept_id
HAVING COUNT(*) > 5
ORDER BY avg_salary DESC;
```

#### 2.3.2 连接查询

```sql
-- 内连接
SELECT e.name, d.dept_name, e.salary
FROM employees e
INNER JOIN departments d ON e.dept_id = d.dept_id;

-- 左外连接
SELECT e.name, d.dept_name, e.salary
FROM employees e
LEFT JOIN departments d ON e.dept_id = d.dept_id;

-- 自连接
SELECT e1.name as employee, e2.name as manager
FROM employees e1
LEFT JOIN employees e2 ON e1.manager_id = e2.emp_id;
```

#### 2.3.3 子查询

```sql
-- 标量子查询
SELECT name, salary,
    (SELECT AVG(salary) FROM employees e2 WHERE e2.dept_id = e1.dept_id) as dept_avg
FROM employees e1;

-- 存在性查询
SELECT name, salary
FROM employees e
WHERE EXISTS (
    SELECT 1 FROM departments d 
    WHERE d.dept_id = e.dept_id AND d.status = 'active'
);

-- IN子查询
SELECT name, salary
FROM employees
WHERE dept_id IN (
    SELECT dept_id FROM departments WHERE budget > 1000000
);
```

### 2.4 高级查询特性

#### 2.4.1 窗口函数

```sql
-- 排名函数
SELECT 
    name, 
    salary,
    ROW_NUMBER() OVER (ORDER BY salary DESC) as salary_rank,
    RANK() OVER (ORDER BY salary DESC) as rank,
    DENSE_RANK() OVER (ORDER BY salary DESC) as dense_rank
FROM employees;

-- 分区窗口函数
SELECT 
    name, 
    dept_id,
    salary,
    AVG(salary) OVER (PARTITION BY dept_id) as dept_avg,
    salary - AVG(salary) OVER (PARTITION BY dept_id) as diff_from_avg
FROM employees;
```

#### 2.4.2 递归查询

```sql
-- 递归CTE
WITH RECURSIVE emp_hierarchy AS (
    -- 基础情况：顶级管理者
    SELECT emp_id, name, manager_id, 1 as level
    FROM employees
    WHERE manager_id IS NULL
    
    UNION ALL
    
    -- 递归情况：下属员工
    SELECT e.emp_id, e.name, e.manager_id, eh.level + 1
    FROM employees e
    INNER JOIN emp_hierarchy eh ON e.manager_id = eh.emp_id
)
SELECT * FROM emp_hierarchy ORDER BY level, name;
```

#### 2.4.3 公共表表达式（CTE）

```sql
-- 简单CTE
WITH high_earners AS (
    SELECT emp_id, name, salary
    FROM employees
    WHERE salary > 80000
),
dept_stats AS (
    SELECT dept_id, COUNT(*) as emp_count
    FROM employees
    GROUP BY dept_id
)
SELECT h.name, h.salary, d.emp_count
FROM high_earners h
JOIN employees e ON h.emp_id = e.emp_id
JOIN dept_stats d ON e.dept_id = d.dept_id;
```

### 2.5 事务控制语言（TCL）

#### 2.5.1 事务管理

```sql
-- 基本事务
BEGIN;
INSERT INTO employees (name, dept_id, salary) VALUES ('新员工', 1, 50000);
UPDATE departments SET emp_count = emp_count + 1 WHERE dept_id = 1;
COMMIT;

-- 保存点
BEGIN;
INSERT INTO employees (name, dept_id, salary) VALUES ('员工1', 1, 50000);
SAVEPOINT sp1;
INSERT INTO employees (name, dept_id, salary) VALUES ('员工2', 1, 60000);
ROLLBACK TO sp1;  -- 回滚到保存点
COMMIT;  -- 只提交第一个插入
```

### 2.6 数据控制语言（DCL）

#### 2.6.1 权限管理

```sql
-- 创建角色
CREATE ROLE hr_manager;
CREATE ROLE data_analyst;

-- 授予权限
GRANT SELECT, INSERT, UPDATE ON employees TO hr_manager;
GRANT SELECT ON employees TO data_analyst;
GRANT USAGE ON SCHEMA public TO hr_manager, data_analyst;

-- 撤销权限
REVOKE UPDATE ON employees FROM hr_manager;

-- 角色继承
GRANT hr_manager TO data_analyst;
```

## 3. PostgreSQL扩展特性

### 3.1 数据类型扩展

```sql
-- JSON数据类型
CREATE TABLE user_profiles (
    user_id INTEGER PRIMARY KEY,
    profile JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 数组类型
CREATE TABLE products (
    product_id INTEGER PRIMARY KEY,
    name VARCHAR(100),
    tags TEXT[],
    prices DECIMAL(10,2)[]
);

-- 范围类型
CREATE TABLE events (
    event_id INTEGER PRIMARY KEY,
    name VARCHAR(100),
    duration TSRANGE,
    price_range NUMRANGE
);
```

### 3.2 函数和操作符

```sql
-- 自定义函数
CREATE OR REPLACE FUNCTION calculate_bonus(emp_salary DECIMAL, performance_score INTEGER)
RETURNS DECIMAL AS $$
BEGIN
    RETURN emp_salary * (performance_score / 100.0) * 0.1;
END;
$$ LANGUAGE plpgsql;

-- 使用函数
SELECT name, salary, calculate_bonus(salary, 85) as bonus
FROM employees;

-- JSON操作符
SELECT profile->>'name' as user_name,
       profile->'address'->>'city' as city
FROM user_profiles
WHERE profile ? 'address';
```

### 3.3 索引类型

```sql
-- GIN索引（用于数组和JSON）
CREATE INDEX idx_profile_gin ON user_profiles USING GIN (profile);
CREATE INDEX idx_tags_gin ON products USING GIN (tags);

-- GiST索引（用于几何和范围类型）
CREATE INDEX idx_duration_gist ON events USING GIST (duration);

-- 部分索引
CREATE INDEX idx_high_salary ON employees (salary) WHERE salary > 100000;

-- 表达式索引
CREATE INDEX idx_name_lower ON employees (LOWER(name));
```

## 4. 性能优化

### 4.1 查询优化

```sql
-- 使用EXPLAIN分析查询计划
EXPLAIN (ANALYZE, BUFFERS) 
SELECT e.name, d.dept_name
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id
WHERE e.salary > 50000;

-- 使用LIMIT优化
SELECT name, salary
FROM employees
ORDER BY salary DESC
LIMIT 10;

-- 避免SELECT *
SELECT emp_id, name, salary  -- 只选择需要的列
FROM employees
WHERE dept_id = 1;
```

### 4.2 索引优化

```sql
-- 复合索引
CREATE INDEX idx_emp_dept_salary ON employees (dept_id, salary);

-- 覆盖索引
CREATE INDEX idx_emp_covering ON employees (dept_id) INCLUDE (name, salary);

-- 索引使用统计
SELECT schemaname, tablename, indexname, idx_scan, idx_tup_read, idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;
```

## 5. 相关概念

### 5.1 上位概念

- **查询语言**: 更广泛的语言类别
- **关系数据库**: 数据模型类型
- **声明式语言**: 编程范式

### 5.2 下位概念

- **DDL**: 数据定义语言
- **DML**: 数据操作语言
- **DQL**: 数据查询语言
- **DCL**: 数据控制语言
- **TCL**: 事务控制语言

### 5.3 平行概念

- **NoSQL查询语言**: 非关系型查询语言
- **关系代数**: 数学基础
- **关系演算**: 逻辑基础

## 6. 参考文献

1. ISO/IEC 9075:2023. Information technology — Database languages — SQL
2. PostgreSQL Global Development Group. (2024). PostgreSQL 16.2 Documentation. <https://www.postgresql.org/docs/16/>
3. Codd, E. F. (1970). A relational model of data for large shared data banks. Communications of the ACM, 13(6), 377-387.
4. Date, C. J. (2003). An Introduction to Database Systems (8th ed.). Addison-Wesley.

## 7. Wikidata对齐

- **Wikidata ID**: Q202218
- **相关属性**:
  - P31: Q202218 (instance of: programming language)
  - P178: Q9366 (developer: PostgreSQL Global Development Group)
  - P348: SQL:2023 (software version)
  - P856: <https://www.postgresql.org/docs/current/sql.html> (official website)
- **外部链接**:
  - <https://www.postgresql.org/docs/current/sql.html>
  - <https://www.iso.org/standard/76583.html>
