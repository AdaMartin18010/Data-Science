# 1.1.56 SAGA 与补偿事务：可达性与幂等性条件

## 1. 模型

- 事务分解：\(T = T_1;T_2;\cdots;T_k\)；每个子事务 \(T_i\) 拥有补偿 \(C_i\)，满足 \(C_i\circ T_i\approx id\) 于业务不变式域内。
- SAGA 执行：前向序列成功则完成；若在 \(T_j\) 失败，按逆序执行 \(C_{j-1},\dots,C_1\) 撤销。

## 2. 可达性与正确性

- 可达状态：前向成功终态或补偿后回到接受状态集合 \(A\)。
- 命题：若对所有 \(i\)，在可见并发条件下 \(C_i\circ T_i\) 幂等且与其它 \(T_m\) 交换满足弱交换条件（对幂等视图），则SAGA在失败后可达 \(A\)。

## 3. 幂等与交换条件

- 幂等：\(f\circ f = f\)。补偿与转发操作需设计为幂等（例如基于业务键去重、乐观版本号）。
- 弱交换：若 \(T_i\) 与并发的 \(T_m\) 作用域相交，需确保在补偿阶段不破坏 \(T_m\) 已提交的不变式（采用版本校验与条件更新）。

## 4. 隔离与一致性界

- 隔离：SAGA 通常在应用层实现，整体不保证DB级可串行化；通过业务幂等、去重表、状态机约束提升“最终一致”。
- 一致性界：允许短暂失配；对关键不变式引入“监护表/唯一约束”与补偿校正。

## 5. 示例

```sql
-- 去重表：防重入
CREATE TABLE saga_dedup (
  saga_id text PRIMARY KEY,
  step integer NOT NULL,
  ts timestamptz DEFAULT now()
);

-- 步骤执行记录
INSERT INTO saga_dedup(saga_id, step) VALUES ('order-123', 1)
ON CONFLICT (saga_id) DO NOTHING;

-- 幂等更新（条件写）
UPDATE inventory SET qty = qty - 1
WHERE sku = 'A-001' AND qty > 0;

-- 补偿：加回库存（幂等）
UPDATE inventory SET qty = qty + 1
WHERE sku = 'A-001' AND EXISTS (
  SELECT 1 FROM saga_dedup WHERE saga_id='order-123' AND step>=1
);
```

## 6. 工程策略

- 幂等键：自然业务键 + 步骤号；
- 去重与重试：记录每步完成标记并允许幂等重放；
- 超时/回滚：长链路通过定时任务触发补偿；
- 观测：为每步打点，监控成功率/补偿率。

## 7. 交叉引用

- `1.1.55-两阶段提交-可恢复性与阻塞特性证明.md`
- `1.1.5-事务处理.md`
