---
title: 1.1.24-PostgreSQL-2025实验与基准
slug: 1.1.24-PostgreSQL-2025实验与基准
tags: []
pg_version: 16
status: draft
last_review: 2025-09-12
owner: TBD
---

# PostgreSQL 2025 实验与基准

## 目录

1. 基础环境
2. 指标与方法学
3. 核心实验
4. 结果记录模板
5. 复现实验脚本

## 1. 基础环境

- PG 17/18（记版本号）
- 扩展：pgvector、pg_ivm、pg_stat_statements
- 硬件：CPU/内存/磁盘/网络说明
- 数据集：规模、维度、分布

## 2. 指标与方法学

- 吞吐量 QPS/TPS，P50/P95/P99 延迟
- I/O：reads/writes/fsync/read_time/write_time（pg_stat_io）
- 计划与执行：总执行时长、Buffer命中、并行度
- 复制：延迟(ms)、滞后LSN、冲突率
- 向量检索：召回率@k、平均相似度、构建耗时、索引大小
- 视图刷新：全量 vs 增量耗时、锁时间

## 3. 核心实验

### 3.1 [Core] pg_stat_io 采样

```sql
SELECT 
  backend_type, object, context,
  reads, writes, extends, fsyncs,
  read_time, write_time
FROM pg_stat_io
ORDER BY reads + writes DESC;
```

### 3.2 [Core] pg_stat_statements 热点SQL

```sql
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
SELECT query, calls, total_exec_time, mean_exec_time, rows
FROM pg_stat_statements
ORDER BY total_exec_time DESC
LIMIT 20;
```

### 3.3 [Ext] pgvector 检索与索引

```sql
CREATE EXTENSION IF NOT EXISTS vector;
CREATE TABLE doc_emb (
  id bigserial PRIMARY KEY,
  embedding vector(1536)
);
-- HNSW
CREATE INDEX ON doc_emb USING hnsw (embedding vector_cosine_ops)
WITH (m=16, ef_construction=64);
-- 查询
PREPARE q AS SELECT id, 1 - (embedding <=> $1) AS sim
FROM doc_emb ORDER BY embedding <=> $1 LIMIT 10;
EXECUTE q(ARRAY[0.1, 0.2, 0.3]);
```

### 3.4 [Ext] pg_ivm 增量刷新

```sql
CREATE EXTENSION IF NOT EXISTS pg_ivm;
CREATE TABLE sales(id bigserial, pid int, qty int, amt numeric, ts timestamptz);
CREATE INCREMENTAL MATERIALIZED VIEW v AS
SELECT pid, sum(qty) s_qty, sum(amt) s_amt FROM sales GROUP BY pid;
INSERT INTO sales(pid, qty, amt) SELECT 1, 5, 100.0;
-- 记录刷新耗时
```

### 3.5 [Core] 逻辑复制延迟

```sql
SELECT now() - pg_last_committed_xact(); -- 如使用插件另行记录
-- 推荐使用复制监控视图/订阅端延迟统计
```

## 4. 结果记录模板

### 4.1 I/O统计表

| backend_type | object | context | reads | writes | read_time(ms) | write_time(ms) |
|---|---|---|---:|---:|---:|---:|

### 4.2 热点SQL

| query | calls | total_exec_time(ms) | mean_exec_time(ms) | rows |
|---|---:|---:|---:|---:|

### 4.3 向量检索

| index | dim | build_time(s) | index_size(MB) | qps | p95(ms) | recall@10 |
|---|---:|---:|---:|---:|---:|---:|

### 4.4 增量刷新

| rows_delta | full_refresh(ms) | incremental(ms) | lock_time(ms) |
|---:|---:|---:|---:|

### 4.5 复制延迟

| publication | subscriber | lag_ms | conflicts |
|---|---|---:|---:|

## 5. 复现实验脚本

- 提供Docker/Compose或K8s清单（后续补充）
- 初始化SQL：表结构、索引、扩展安装
- 基准脚本：生成数据、并发查询、采集指标
