---
title: 1.1.71-外连接与NULL-三值逻辑的形式语义
slug: 1.1.71-外连接与NULL-三值逻辑的形式语义
tags: []
pg_version: 16
status: draft
last_review: 2025-09-12
owner: TBD
---

﻿# 1.1.71-外连接与NULL-三值逻辑的形式语义

> 目标：给出三值逻辑（True/False/Unknown）下外连接（LEFT/RIGHT/FULL OUTER JOIN）的形式语义、等价限制与常见陷阱，并提供示例与重写指南。

## 1. 预备：三值逻辑

- 取值：\( \{\text{T},\text{F},\text{U}\} \)。
- 谓词：比较运算遇到 `NULL` 产生 `U`；`IS NULL/IS NOT NULL` 提供两值化判定。
- 逻辑算子：
  - 非：`NOT U = U`；
  - 与：`T∧U=U`，`F∧U=F`，`U∧U=U`；
  - 或：`T∨U=T`，`F∨U=U`，`U∨U=U`。
- 选择语义：`WHERE` 仅保留 `T`，丢弃 `F` 和 `U`。

## 2. 外连接的语义

- 左外连接：`R ⟕_θ S` 首先执行内连接 `R ⋈_θ S`，对 `R` 中未匹配的元组以 `S` 属性补 `NULL` 后并入。
- 右外连接：对称定义 `R ⟖_θ S`。
- 全外连接：并集 `R ⟗_θ S = (R ⟕_θ S) ∪ (R ⟖_θ S)`。
- 谓词评价：连接条件 `θ` 在三值逻辑下评估；对于补 `NULL` 的一侧，比较通常产生 `U`。

## 3. 等价与重写限制

- 选择下推限制：`WHERE` 条件若引用被补 `NULL` 的一侧字段，可能将 `U` 误丢弃，破坏外连接语义。
- 外连接到内连接的退化：当 `WHERE` 加上 `S.key IS NOT NULL`（或等价保证匹配）时，`LEFT OUTER JOIN` 等价退化为 `INNER JOIN`。
- 连接条件与过滤分离：尽量将“连接判定条件”放在 `ON`，将“结果过滤条件”放在 `WHERE`；否则会隐式改变补 `NULL` 的集合。
- 形式化指引：若 `φ` 仅依赖 `R`，则 `σ_φ(R ⟕_θ S) ≡ (σ_φ(R)) ⟕_θ S`；若 `φ` 依赖 `S`，一般不可下推。

## 4. 示例

```sql
-- 4.1 经典陷阱：WHERE 过滤打破左外连接
SELECT c.id, o.id AS oid
FROM customer c
LEFT JOIN orders o ON o.customer_id = c.id
WHERE o.status = 'paid';  -- 错误：将未匹配行过滤掉

-- 正确写法：将条件放到 ON，保留未匹配行
SELECT c.id, o.id AS oid
FROM customer c
LEFT JOIN orders o
  ON o.customer_id = c.id AND o.status = 'paid';

-- 4.2 退化为内连接
SELECT c.id, o.id AS oid
FROM customer c
LEFT JOIN orders o ON o.customer_id = c.id
WHERE o.id IS NOT NULL;  -- 等价内连接

-- 4.3 UNKNOWN 的影响
SELECT *
FROM R LEFT JOIN S ON R.a = S.b
WHERE S.b <> 10; -- 当 S.b 为 NULL 时比较为 UNKNOWN，被 WHERE 丢弃
```

## 5. 形式化片段

- 定义：设关系实例 \( R(A), S(B) \)，谓词 \( \theta(A,B) \)。
  - \( R ⟕_\theta S = (R ⋈_\theta S) \cup \{ (r,\text{nulls}(S)) \mid r\in R, \neg\exists s\in S: \theta(r,s)=\text{T} \} \)
- 选择下推（充要条件的充分侧）：若谓词 \( \varphi \) 仅含 \( A \) 且与 \( \theta \) 独立，则
  \[ \sigma_\varphi(R ⟕_\theta S) \equiv (\sigma_\varphi(R)) ⟕_\theta S. \]
- 退化条件：若 \( \psi \equiv (\exists s\in S: \theta(r,s)) \) 被WHERE强制为真，则 `LEFT OUTER` 退化为 `INNER`。

## 6. 工程指南

- 将“限定匹配的条件”放在 `ON`；将“仅与输出有关的过滤”放在 `WHERE`。
- 对 `NULL` 敏感的过滤使用 `IS [NOT] NULL` 或 `COALESCE` 显式两值化。
- EXPLAIN 验证重写：观察是否发生 Hash/ Merge Join + Filter 变化。

## 7. 交叉引用

- `1.1.63-多重集语义-SQL与关系代数的bag形式化.md`
- `1.1.26-查询语言的形式语义与等价律.md`
- `1.1.52-窗口聚合语义-稳定性与等价变换.md`
