# 备份与恢复

## 1. 策略总览

- 逻辑备份：`pg_dump/pg_restore`，适合结构迁移与小中规模数据；
- 物理备份：`pg_basebackup` + WAL 归档，适合大规模与PITR；
- 频次与RPO/RTO：全量 + 增量（WAL），按业务SLA制定窗口；多区域/多副本冗余。

## 2. 逻辑备份

```bash
# 单库逻辑备份
pg_dump -h <host> -U <user> -F c -j 4 -d mydb -f mydb_$(date +%F).dump

# 还原
pg_restore -h <host> -U <user> -j 4 -d mydb_restored mydb_2025-09-11.dump
```

## 3. 物理备份与WAL归档

```bash
# 开启归档（postgresql.conf）
archive_mode = on
archive_command = 'test ! -f /arch/%f && cp %p /arch/%f'
wal_level = replica
max_wal_senders = 10

# 基础备份（在线）
pg_basebackup -h <primary> -U repl -D /data/basebackup -X stream -P -R
```

## 4. 时间点恢复（PITR）

```bash
# 停库并准备恢复环境
rm -rf $PGDATA/*
cp -a /data/basebackup/* $PGDATA/

# recovery 配置（PostgreSQL 12+）在 postgresql.conf 中：
restore_command = 'cp /arch/%f %p'
recovery_target_time = '2025-09-11 10:15:00+00'
recovery_target_action = 'promote'

# 启动并回放到目标时间后自动提升
pg_ctl -D $PGDATA start
```

- 验证：对照业务校验点（校验总数/关键记录），比对 `pg_last_wal_replay_lsn()` 演进；
- 复位：完成后清理恢复参数，确保后续正常归档。

## 5. 灾备与演练

- 级联复制/备用库：`primary_conninfo`、`primary_slot_name`；
- 演练SOP：
  1) 选择近一次基线备份 + WAL；
  2) 搭建恢复环境并执行PITR；
  3) 校验一致性与完整性；
  4) 评估RTO/RPO，记录偏差并改进配置。

## 6. 合规与安全

- 加密：传输（TLS）与静态（磁盘/对象存储KMS）；
- 留存策略：分层存储与生命周期管理；
- 审计：备份/恢复操作留痕与报表。

## 7. 常见问题

- 归档堵塞：监控 `archiver` 失败，检查归档目录容量与权限；
- 基线过旧：恢复时间拉长，适当提升全量频次或打开增量基础备份方案；
- 跨版本还原：逻辑备份优先，或使用兼容的升级路径（`pg_upgrade`）。

## 8. 交叉引用

- `01-核心基础/01.06-存储管理与数据持久化.md`
- `1.1.57-ARIES日志恢复-正确性与不变式.md`
