# 性能调优实践

**PostgreSQL版本**: 17.x (推荐) | 16.x, 15.x (兼容)
**难度**: ⭐⭐⭐⭐
**最后更新**: 2025-10-30

> 🆕 **PostgreSQL 17性能优化要点**
>
> PostgreSQL 17带来多项性能改进，调优时应重点关注：
>
> - ✅ **并行查询增强**: 更智能的并行执行计划，建议调整max_parallel_workers
> - ✅ **索引优化**: B-tree去重优化，BRIN性能提升15-20%
> - ✅ **内存管理**: 动态共享内存，可减少预分配内存
> - ✅ **向量操作**: pgvector 0.7+性能提升35-45%

---

## 目录

- [目录](#目录)
- [1. 概述](#1-概述)
- [2. 合并来源与映射](#2-合并来源与映射)
- [3. 基线与变更治理](#3-基线与变更治理)
- [4. 调优流程](#4-调优流程)
- [5. 典型场景](#5-典型场景)
- [6. 工具与方法](#6-工具与方法)
- [7. 参数调优指南（按子系统）](#7-参数调优指南按子系统)
- [8. 查询层优化策略](#8-查询层优化策略)
- [9. 存储与表设计](#9-存储与表设计)
- [10. 典型工作负载基线](#10-典型工作负载基线)
- [11. 验证与回归](#11-验证与回归)
- [12. 后续整合任务](#12-后续整合任务)

---

## 1. 概述

- 面向生产的“监测→诊断→定位→优化→验证→回归防护”闭环。
- 分层拆解：系统资源（CPU/内存/IO/网络）→ 数据库实例（连接/缓冲/检查点/WAL/Autovacuum）→ 对象（表/索引/膨胀）→ 查询与计划（代价/并行/基数）→ 应用（连接池/事务模型）。

## 2. 合并来源与映射

- 1.1.16-性能调优与监控-扩充版.md
- 1.1.16-性能调优与监控.md
- 02-查询处理/02.04-执行计划与性能调优.md（交叉）

## 3. 基线与变更治理

- 建立“基线参数+SLA目标+指标阈值+回滚脚本”的变更四件套。
- 每次调优仅变更少量参数，记录变更票据：参数→旧值→新值→预期影响→验证窗口→回滚条件。
- 预生产压测与生产灰度：以典型工作负载（OLTP/OLAP/混合）重放/回放进行对比。

## 4. 调优流程

- 指标观察→瓶颈归因（CPU/IO/锁/计划）→变更验证
- 步骤化SOP：
  1) 入口指征：P99/吞吐/错误率异常、队列堆积、告警触发；
  2) 快速体检：连接、CPU利用、IO饱和、WAL/检查点、Autovacuum滞后；
  3) TopN：`pg_stat_statements`/活动会话/等待事件；
  4) 计划核查：`EXPLAIN (ANALYZE, BUFFERS, VERBOSE)` 与基数、并行度、I/O命中；
  5) 策略选择：索引/统计/SQL/参数/架构改造；
  6) 小步快跑：单变量变更→对比指标→保留或回滚；
  7) 回归守护：告警门槛、自动回滚开关（必要时）。

## 5. 典型场景

- 索引/统计信息、连接池、并行、存储与检查点
- 示例排查与处置：
  - 估算偏差→扩大统计目标或创建扩展统计：

    ```sql
    ALTER TABLE t ALTER COLUMN c SET STATISTICS 2000;
    CREATE STATISTICS s_t_multi (dependencies) ON c1, c2 FROM t;  -- 相关性
    ANALYZE t;
    ```

  - 索引未命中→谓词可索引化/表达式索引/类型一致：

    ```sql
    CREATE INDEX idx_t_lower_email ON t (lower(email));
    -- 确保查询用 lower(email) = ...
    ```

  - 锁等待→定位持锁长事务与冲突语句，必要时拆分DDL/批量：

    ```sql
    SELECT * FROM pg_locks l JOIN pg_stat_activity a USING(pid) WHERE NOT granted;
    ```

  - 膨胀→评估 `autovacuum`、重建索引/表：

    ```sql
    REINDEX TABLE CONCURRENTLY t;
    VACUUM (VERBOSE, ANALYZE) t;
    ```

## 6. 工具与方法

- EXPLAIN(ANALYZE, BUFFERS)、pg_stat_statements、采样/剖析
- 必备扩展与设置：
  - `pg_stat_statements`：

    ```sql
    CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
    SELECT query, calls, mean_time, rows
    FROM pg_stat_statements ORDER BY total_time DESC LIMIT 20;
    ```

  - `auto_explain`（开发/预生产启用，生产慎用高阈值）：

    ```text
    shared_preload_libraries = 'pg_stat_statements,auto_explain'
    auto_explain.log_min_duration = '200ms'
    auto_explain.log_analyze = on
    auto_explain.log_buffers = on
    auto_explain.log_nested_statements = on
    ```

  - 采样与等待分析：`pg_wait_sampling`、`pg_stat_kcache`、eBPF/bcc 工具（如 `profile`, `offcputime`）。

## 7. 参数调优指南（按子系统）

- 连接与并发：
  - 应用优先连接池：`pgbouncer`（transaction 模式）→ 降低 `max_connections` 压力。
  - `max_connections`：基于内存预算与工作负载并发度；过高会拉低命中率与上下文切换。
  - `work_mem`：按并发排序/哈希操作估算；常见基线 4–64MB，避免全局放大导致内存爆。
- 缓冲与缓存：
  - `shared_buffers`：常见 25% 物理内存起步（Linux+PageCache 情况），超大未必收益更高。
  - `effective_cache_size`：估计 OS PageCache + shared_buffers（如内存 64GB → 48GB）。
- 并行与JIT：
  - `max_parallel_workers_per_gather`：2–4 起步；`max_parallel_workers`≥总并行。
  - `jit`：OLTP 多为关闭或阈值较高；OLAP 大查询收益明显。
- I/O 与存储：
  - `random_page_cost`：SSD 通常 1.1–1.5；`effective_io_concurrency`：NVMe 可 256。
  - 检查点：`checkpoint_timeout` 10–30min、`max_wal_size` 2–20GB、`checkpoint_completion_target` 0.7–0.9。
- WAL 与持久化：
  - `wal_compression`=on（写放大下降，CPU ↑）；`synchronous_commit` 根据一致性需求调节（异步批量写可 off）。
- 维护与自清理：
  - `autovacuum_vacuum_scale_factor` 降低以抑制膨胀（如 0.1→0.02 针对大表），结合 `autovacuum_vacuum_threshold`。
  - `maintenance_work_mem`：索引重建/并行维护时提高（512MB–4GB）。

## 8. 查询层优化策略

- 代价对齐：校准 `default_statistics_target`（100–500）与扩展统计，降低错误选择率。
- 访问路径：覆盖索引、表达式/部分索引、BitmapScan 聚合回表成本。
- 连接策略：小表驱动、合适的连接顺序、避免隐式类型转换导致 Seq Scan。
- 分区与裁剪：时间/范围分区，确保谓词可裁剪；避免过多分区导致计划时间暴涨。
- 并行：确保运算符与函数可并行（immutable/parallel safe）。

## 9. 存储与表设计

- `fillfactor`：写多表降低（80–90）减少页分裂；读多保守提高空间利用。
- TOAST/压缩：9.5+ 自适应；PG15+ LZ4/ZSTD（需编译/设置）可降I/O。
- 冷热分层：热表热索引置高速盘，历史分区迁移冷盘；归档表使用压缩与只读策略。

## 10. 典型工作负载基线

- OLTP：
  - pgbouncer(transaction)、较小 `work_mem`（8–32MB）、`shared_buffers` 20–30%、JIT 关闭、`synchronous_commit=on`（重要交易）。
  - 强化 Autovacuum 与热点索引、低延迟检查点配置。
- OLAP：
  - 并行开启（2–4）、`work_mem` 64–512MB、JIT 打开（阈值 ≥200ms）、`random_page_cost` 低、`effective_io_concurrency` 高。
  - 宽表、列式外部引擎/FDW、分区裁剪与物化中间结果。
- 混合：分离读写池、OLAP 在只读副本跑、主库保守参数。

## 11. 验证与回归

- 基准数据：TPS/QPS、P95/P99、队列长度、命中率、WAL速率、检查点频率、Vacuum滞后、锁等待。
- 对比方法：调优前后 30–60 分钟稳定窗口；业务低峰灰度 5–10% 流量。
- 回滚触发：P95 恶化>10%、错误率升高、锁冲突上升、系统负载异常。

## 12. 后续整合任务

- 统一参数推荐表与案例库
- 建立“参数模板 + 负载画像（OLTP/OLAP/混合/批处理）+ 版本差异（PG13/14/15/16/17）”。
- 累积企业级案例：问题→诊断证据→变更→效果→可复用脚本。
