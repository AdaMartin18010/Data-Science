# 监控与诊断

## 1. 指标体系

- 实例级：连接数、事务提交/回滚、缓冲命中率、WAL写入速率、检查点频率、后台写入/清理队列。
- 表/索引级：`seq_scan/idx_scan`、膨胀与死元组、热点对象、I/O命中。
- 查询级：调用次数、平均/TP95/TP99耗时、返回行数、共享块命中率。

## 2. 常用视图与SQL

```sql
-- 活跃会话
SELECT pid, usename, application_name, wait_event_type, wait_event, state, query
FROM pg_stat_activity WHERE state <> 'idle' ORDER BY query_start;

-- 锁与等待
SELECT locktype, relation::regclass, mode, granted, pid
FROM pg_locks WHERE NOT granted;

-- 表扫描/索引使用
SELECT schemaname, relname, seq_scan, idx_scan, n_tup_ins, n_tup_upd, n_tup_del
FROM pg_stat_user_tables ORDER BY (seq_scan+idx_scan) DESC;

-- I/O 命中
SELECT schemaname, relname,
       heap_blks_read, heap_blks_hit,
       round(100.0*heap_blks_hit/nullif(heap_blks_hit+heap_blks_read,0),2) AS hit_ratio
FROM pg_statio_user_tables ORDER BY hit_ratio ASC NULLS LAST;

-- 慢查询（需 pg_stat_statements）
SELECT query, calls, total_time, mean_time, rows,
       round(100.0*shared_blks_hit/nullif(shared_blks_hit+shared_blks_read,0),2) AS hit_percent
FROM pg_stat_statements ORDER BY mean_time DESC LIMIT 20;
```

## 3. 监控实现（Prometheus + Grafana）

- Exporter 部署：
  - `postgres_exporter` 运行在每台实例旁，使用最小权限监控用户：

    ```sql
    CREATE ROLE metrics WITH LOGIN PASSWORD '***';
    GRANT pg_monitor TO metrics;
    -- 如需 wal/replication 细粒度指标：GRANT pg_read_all_stats TO metrics;
    ```

  - 启动参数示例：

    ```bash
    DATA_SOURCE_NAME="postgresql://metrics:***@127.0.0.1:5432/postgres?sslmode=disable" ./postgres_exporter
    ```

- Prometheus 抓取配置：

  ```yaml
  scrape_configs:
    - job_name: pg
      scrape_interval: 15s
      static_configs:
        - targets: ["db1:9187", "db2:9187", "db3:9187"]
  ```

- Grafana 面板建议：
  - 概览：连接、TPS/QPS、缓冲命中、WAL速率、检查点、Autovacuum、锁等待。
  - 明细：Top 表与索引、Top 查询、复制延迟、磁盘 I/O、CPU 与内存。

## 3. 诊断流程（SOP）

- 性能劣化：
  1) 检查实例压力（连接/CPU/IO）→ 2) 慢查询TopN → 3) EXPLAIN ANALYZE 对比估算/实际基数 → 4) 索引/统计修复 → 5) 复测。
- 锁等待/死锁：
  1) `pg_locks` 与等待链 → 2) 找出持锁长事务 → 3) 评估中止与DDL/事务拆分 → 4) 防再发（索引/顺序/批量策略）。
- 膨胀/垃圾：
  1) 死元组与 `autovacuum` 频次 → 2) 提升 `autovacuum_*` 或离峰 `VACUUM (FULL)`/重建索引 → 3) 长事务排查。

## 4. 仪表盘建议（Prometheus+Grafana）

- 面板：连接/事务、命中率/WAL速率、检查点、Autovacuum、Top表与索引、Top查询、锁等待热力图。
- 告警：连接接近上限、命中率骤降、WAL暴涨、检查点频率异常、Autovacuum滞后、死锁事件。

## 5. 常见问题与对策

- 估算偏差大：提高统计目标、扩展统计、表达式列；
- 索引未命中：谓词不匹配、函数未可索引化、类型隐式转换；
- 写放大与膨胀：批写/合并、合理 `fillfactor`、冷热分层、周期重建。

## 6. 日志与可观测性增强

- 建议的 `postgresql.conf` 日志关键项：

  ```text
  log_line_prefix = '%m [%p] %u@%d %r %a '
  log_min_duration_statement = 500ms        # 生产按流量与存储调节
  log_checkpoints = on
  log_autovacuum_min_duration = 1s
  log_lock_waits = on
  track_io_timing = on
  shared_preload_libraries = 'pg_stat_statements,auto_explain'
  auto_explain.log_min_duration = '200ms'
  auto_explain.log_analyze = on
  auto_explain.log_buffers = on
  ```

- 慢日志采集：
  - Filebeat/Vector → Loki/Elastic，再在 Grafana 建立慢SQL面板与 TopN。
  - 生成 `fingerprint`（正则归一化）便于聚合统计。

## 6. 交叉引用

- `02-查询处理/02.04-执行计划与性能调优.md`
- `01-核心基础/01.06-存储管理与数据持久化.md`
- `1.1.49-选择率估计误差-敏感性与上界.md`
