# ç›‘æ§ä¸è¯Šæ–­

**PostgreSQLç‰ˆæœ¬**: 17.x (æ¨è) | 16.x, 15.x (å…¼å®¹)
**éš¾åº¦**: â­â­â­
**æœ€åæ›´æ–°**: 2025-10-30

> ğŸ†• **PostgreSQL 17ç›‘æ§å¢å¼º**
>
> PostgreSQL 17å¼•å…¥å¤šé¡¹ç›‘æ§æ”¹è¿›ï¼š
>
> - âœ… **æ–°å¢ç³»ç»Ÿè§†å›¾**: å¢å¼ºçš„pg_stat_statementsï¼Œæ–°å¢æ ‡å‡†å·®ç»Ÿè®¡
> - âœ… **æ”¹è¿›çš„è¿›åº¦æŠ¥å‘Š**: pg_stat_progress_*è§†å›¾æ›´è¯¦ç»†
> - âœ… **å…±äº«å†…å­˜ç›‘æ§**: æ–°å¢pg_shmem_allocationsè§†å›¾
> - âœ… **æ›´ç»†ç²’åº¦çš„ç­‰å¾…äº‹ä»¶**: æ›´å‡†ç¡®çš„æ€§èƒ½è¯Šæ–­

---

## ç›®å½•

- [1. æŒ‡æ ‡ä½“ç³»](#1-æŒ‡æ ‡ä½“ç³»)
- [2. PostgreSQL 17æ–°å¢ç›‘æ§ç‰¹æ€§](#2-postgresql-17æ–°å¢ç›‘æ§ç‰¹æ€§)
- [3. å¸¸ç”¨è§†å›¾ä¸SQL](#3-å¸¸ç”¨è§†å›¾ä¸sql)
- [4. ç›‘æ§å®ç°](#4-ç›‘æ§å®ç°)
- [5. è¯Šæ–­æµç¨‹](#5-è¯Šæ–­æµç¨‹)
- [6. ä»ªè¡¨ç›˜å»ºè®®](#6-ä»ªè¡¨ç›˜å»ºè®®)
- [7. å‘Šè­¦é…ç½®](#7-å‘Šè­¦é…ç½®)

---

## 1. æŒ‡æ ‡ä½“ç³»

- å®ä¾‹çº§ï¼šè¿æ¥æ•°ã€äº‹åŠ¡æäº¤/å›æ»šã€ç¼“å†²å‘½ä¸­ç‡ã€WALå†™å…¥é€Ÿç‡ã€æ£€æŸ¥ç‚¹é¢‘ç‡ã€åå°å†™å…¥/æ¸…ç†é˜Ÿåˆ—ã€‚
- è¡¨/ç´¢å¼•çº§ï¼š`seq_scan/idx_scan`ã€è†¨èƒ€ä¸æ­»å…ƒç»„ã€çƒ­ç‚¹å¯¹è±¡ã€I/Oå‘½ä¸­ã€‚
- æŸ¥è¯¢çº§ï¼šè°ƒç”¨æ¬¡æ•°ã€å¹³å‡/TP95/TP99è€—æ—¶ã€è¿”å›è¡Œæ•°ã€å…±äº«å—å‘½ä¸­ç‡ã€‚

## 2. PostgreSQL 17æ–°å¢ç›‘æ§ç‰¹æ€§

### 2.1 å¢å¼ºçš„pg_stat_statements

```sql
-- PostgreSQL 17+: æ–°å¢æ ‡å‡†å·®ç»Ÿè®¡

-- åˆ›å»ºæ‰©å±•ï¼ˆå¦‚æœå°šæœªå®‰è£…ï¼‰
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡ï¼ˆå«æ ‡å‡†å·®ï¼‰
SELECT
    query,
    calls,
    mean_exec_time,
    stddev_exec_time,  -- â­ PostgreSQL 17æ–°å¢
    min_exec_time,
    max_exec_time,
    rows,
    shared_blks_hit,
    shared_blks_read,
    -- è®¡ç®—ç¨³å®šæ€§æŒ‡æ ‡
    CASE
        WHEN mean_exec_time > 0
        THEN round((stddev_exec_time / mean_exec_time * 100)::numeric, 2)
        ELSE 0
    END AS cv_percent  -- å˜å¼‚ç³»æ•°ï¼Œè¡¡é‡æŸ¥è¯¢ç¨³å®šæ€§
FROM pg_stat_statements
WHERE calls > 10
ORDER BY mean_exec_time DESC
LIMIT 20;

-- è¯†åˆ«ä¸ç¨³å®šçš„æŸ¥è¯¢ï¼ˆé«˜å˜å¼‚ç³»æ•°ï¼‰
SELECT
    left(query, 60) AS query_preview,
    calls,
    round(mean_exec_time::numeric, 2) AS mean_ms,
    round(stddev_exec_time::numeric, 2) AS stddev_ms,
    round((stddev_exec_time / mean_exec_time * 100)::numeric, 2) AS cv_percent
FROM pg_stat_statements
WHERE calls > 100
  AND mean_exec_time > 10
  AND stddev_exec_time / mean_exec_time > 0.5  -- å˜å¼‚ç³»æ•°>50%
ORDER BY cv_percent DESC
LIMIT 10;
```

### 2.2 å…±äº«å†…å­˜ç›‘æ§

```sql
-- PostgreSQL 17+: ç›‘æ§åŠ¨æ€å…±äº«å†…å­˜ä½¿ç”¨

SELECT
    name,
    allocated_size,
    free_size,
    used_size,
    dynamic,
    pg_size_pretty(allocated_size) AS allocated,
    pg_size_pretty(free_size) AS free,
    pg_size_pretty(used_size) AS used,
    round((used_size::float / allocated_size * 100)::numeric, 2) AS usage_percent
FROM pg_shmem_allocations
WHERE allocated_size > 0
ORDER BY allocated_size DESC
LIMIT 20;

-- åŠ¨æ€å…±äº«å†…å­˜æ€»è§ˆ
SELECT
    dynamic,
    count(*) AS segment_count,
    pg_size_pretty(sum(allocated_size)) AS total_allocated,
    pg_size_pretty(sum(used_size)) AS total_used,
    round((sum(used_size)::float / sum(allocated_size) * 100)::numeric, 2) AS usage_percent
FROM pg_shmem_allocations
GROUP BY dynamic
ORDER BY dynamic;
```

### 2.3 æ”¹è¿›çš„è¿›åº¦æŠ¥å‘Š

```sql
-- PostgreSQL 17+: å¢å¼ºçš„VACUUMè¿›åº¦ç›‘æ§

SELECT
    pid,
    datname,
    relid::regclass AS table_name,
    phase,
    heap_blks_total,
    heap_blks_scanned,
    heap_blks_vacuumed,
    index_vacuum_count,
    max_dead_tuples,
    num_dead_tuples,
    -- è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
    round((heap_blks_scanned::float / NULLIF(heap_blks_total, 0) * 100)::numeric, 2) AS scan_progress,
    round((heap_blks_vacuumed::float / NULLIF(heap_blks_total, 0) * 100)::numeric, 2) AS vacuum_progress
FROM pg_stat_progress_vacuum
ORDER BY scan_progress DESC;

-- ANALYZEè¿›åº¦ç›‘æ§
SELECT
    pid,
    datname,
    relid::regclass AS table_name,
    phase,
    sample_blks_total,
    sample_blks_scanned,
    round((sample_blks_scanned::float / NULLIF(sample_blks_total, 0) * 100)::numeric, 2) AS progress
FROM pg_stat_progress_analyze
ORDER BY progress DESC;
```

---

## 3. å¸¸ç”¨è§†å›¾ä¸SQL

### 3.1 æ´»è·ƒä¼šè¯ç›‘æ§

```sql
-- æ´»è·ƒä¼šè¯ï¼ˆPostgreSQL 17å¢å¼ºï¼‰
SELECT
    pid,
    usename,
    application_name,
    client_addr,
    backend_start,
    xact_start,
    query_start,
    state_change,
    wait_event_type,
    wait_event,
    state,
    backend_xid,
    backend_xmin,
    left(query, 100) AS query_preview
FROM pg_stat_activity
WHERE state <> 'idle'
ORDER BY
    CASE state
        WHEN 'active' THEN 1
        WHEN 'idle in transaction' THEN 2
        ELSE 3
    END,
    query_start;

-- é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡
SELECT
    pid,
    usename,
    application_name,
    state,
    now() - xact_start AS transaction_duration,
    now() - query_start AS query_duration,
    left(query, 80) AS query_preview
FROM pg_stat_activity
WHERE xact_start IS NOT NULL
  AND state NOT IN ('idle')
ORDER BY xact_start
LIMIT 20;
```

### 3.2 é”ä¸ç­‰å¾…

```sql
-- é”ä¸ç­‰å¾…
SELECT
    locktype,
    relation::regclass,
    mode,
    granted,
    pid,
    page,
    tuple,
    virtualxid,
    transactionid,
    classid,
    objid
FROM pg_locks
WHERE NOT granted
ORDER BY relation, pid;

-- é”ç­‰å¾…è¯¦æƒ…ï¼ˆå…³è”ä¼šè¯ä¿¡æ¯ï¼‰
SELECT
    blocked_locks.pid AS blocked_pid,
    blocked_activity.usename AS blocked_user,
    blocking_locks.pid AS blocking_pid,
    blocking_activity.usename AS blocking_user,
    blocked_activity.query AS blocked_statement,
    blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks
    ON blocking_locks.locktype = blocked_locks.locktype
    AND blocking_locks.database IS NOT DISTINCT FROM blocked_locks.database
    AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
    AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
    AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
    AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
    AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
    AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
    AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
    AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
    AND blocking_locks.pid != blocked_locks.pid
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

### 3.3 è¡¨æ‰«æ/ç´¢å¼•ä½¿ç”¨

```sql
-- è¡¨æ‰«æ/ç´¢å¼•ä½¿ç”¨
SELECT
    schemaname,
    relname,
    seq_scan,
    idx_scan,
    n_tup_ins,
    n_tup_upd,
    n_tup_del,
    n_tup_hot_upd,
    n_live_tup,
    n_dead_tup,
    round((n_dead_tup::float / NULLIF(n_live_tup, 0) * 100)::numeric, 2) AS dead_tuple_percent,
    last_vacuum,
    last_autovacuum,
    last_analyze,
    last_autoanalyze
FROM pg_stat_user_tables
ORDER BY (seq_scan + idx_scan) DESC
LIMIT 20;

-- è¯†åˆ«ç¼ºå°‘ç´¢å¼•çš„è¡¨ï¼ˆé¡ºåºæ‰«æè¿‡å¤šï¼‰
SELECT
    schemaname,
    relname,
    seq_scan,
    idx_scan,
    n_live_tup,
    round((seq_scan::float / NULLIF(seq_scan + idx_scan, 0) * 100)::numeric, 2) AS seq_scan_percent
FROM pg_stat_user_tables
WHERE seq_scan > 100
  AND n_live_tup > 1000
  AND seq_scan > idx_scan
ORDER BY seq_scan DESC
LIMIT 10;
```

### 3.4 I/Oå‘½ä¸­ç‡

```sql
-- I/O å‘½ä¸­ç‡
SELECT
    schemaname,
    relname,
    heap_blks_read,
    heap_blks_hit,
    idx_blks_read,
    idx_blks_hit,
    round(100.0 * heap_blks_hit / NULLIF(heap_blks_hit + heap_blks_read, 0), 2) AS heap_hit_ratio,
    round(100.0 * idx_blks_hit / NULLIF(idx_blks_hit + idx_blks_read, 0), 2) AS idx_hit_ratio
FROM pg_statio_user_tables
WHERE heap_blks_read + heap_blks_hit > 0
ORDER BY heap_hit_ratio ASC NULLS LAST
LIMIT 20;

-- æ•´ä½“ç¼“å­˜å‘½ä¸­ç‡
SELECT
    sum(heap_blks_read) AS heap_read,
    sum(heap_blks_hit) AS heap_hit,
    round(100.0 * sum(heap_blks_hit) / NULLIF(sum(heap_blks_hit) + sum(heap_blks_read), 0), 2) AS cache_hit_ratio
FROM pg_statio_user_tables;
```

### 3.5 æ…¢æŸ¥è¯¢åˆ†æ

```sql
-- æ…¢æŸ¥è¯¢ï¼ˆéœ€ pg_stat_statementsï¼‰
SELECT
    queryid,
    left(query, 80) AS query_preview,
    calls,
    round(total_exec_time::numeric, 2) AS total_time_ms,
    round(mean_exec_time::numeric, 2) AS mean_time_ms,
    round(stddev_exec_time::numeric, 2) AS stddev_ms,  -- PG17+
    round(min_exec_time::numeric, 2) AS min_time_ms,
    round(max_exec_time::numeric, 2) AS max_time_ms,
    rows,
    round(100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0), 2) AS cache_hit_percent
FROM pg_stat_statements
WHERE calls > 10
ORDER BY mean_exec_time DESC
LIMIT 20;
```

## 3. ç›‘æ§å®ç°ï¼ˆPrometheus + Grafanaï¼‰

- Exporter éƒ¨ç½²ï¼š
  - `postgres_exporter` è¿è¡Œåœ¨æ¯å°å®ä¾‹æ—ï¼Œä½¿ç”¨æœ€å°æƒé™ç›‘æ§ç”¨æˆ·ï¼š

    ```sql
    CREATE ROLE metrics WITH LOGIN PASSWORD '***';
    GRANT pg_monitor TO metrics;
    -- å¦‚éœ€ wal/replication ç»†ç²’åº¦æŒ‡æ ‡ï¼šGRANT pg_read_all_stats TO metrics;
    ```

  - å¯åŠ¨å‚æ•°ç¤ºä¾‹ï¼š

    ```bash
    DATA_SOURCE_NAME="postgresql://metrics:***@127.0.0.1:5432/postgres?sslmode=disable" ./postgres_exporter
    ```

- Prometheus æŠ“å–é…ç½®ï¼š

  ```yaml
  scrape_configs:
    - job_name: pg
      scrape_interval: 15s
      static_configs:
        - targets: ["db1:9187", "db2:9187", "db3:9187"]
  ```

- Grafana é¢æ¿å»ºè®®ï¼š
  - æ¦‚è§ˆï¼šè¿æ¥ã€TPS/QPSã€ç¼“å†²å‘½ä¸­ã€WALé€Ÿç‡ã€æ£€æŸ¥ç‚¹ã€Autovacuumã€é”ç­‰å¾…ã€‚
  - æ˜ç»†ï¼šTop è¡¨ä¸ç´¢å¼•ã€Top æŸ¥è¯¢ã€å¤åˆ¶å»¶è¿Ÿã€ç£ç›˜ I/Oã€CPU ä¸å†…å­˜ã€‚

## 3. è¯Šæ–­æµç¨‹ï¼ˆSOPï¼‰

- æ€§èƒ½åŠ£åŒ–ï¼š
  1) æ£€æŸ¥å®ä¾‹å‹åŠ›ï¼ˆè¿æ¥/CPU/IOï¼‰â†’ 2) æ…¢æŸ¥è¯¢TopN â†’ 3) EXPLAIN ANALYZE å¯¹æ¯”ä¼°ç®—/å®é™…åŸºæ•° â†’ 4) ç´¢å¼•/ç»Ÿè®¡ä¿®å¤ â†’ 5) å¤æµ‹ã€‚
- é”ç­‰å¾…/æ­»é”ï¼š
  1) `pg_locks` ä¸ç­‰å¾…é“¾ â†’ 2) æ‰¾å‡ºæŒé”é•¿äº‹åŠ¡ â†’ 3) è¯„ä¼°ä¸­æ­¢ä¸DDL/äº‹åŠ¡æ‹†åˆ† â†’ 4) é˜²å†å‘ï¼ˆç´¢å¼•/é¡ºåº/æ‰¹é‡ç­–ç•¥ï¼‰ã€‚
- è†¨èƒ€/åƒåœ¾ï¼š
  1) æ­»å…ƒç»„ä¸ `autovacuum` é¢‘æ¬¡ â†’ 2) æå‡ `autovacuum_*` æˆ–ç¦»å³° `VACUUM (FULL)`/é‡å»ºç´¢å¼• â†’ 3) é•¿äº‹åŠ¡æ’æŸ¥ã€‚

## 4. ä»ªè¡¨ç›˜å»ºè®®ï¼ˆPrometheus+Grafanaï¼‰

- é¢æ¿ï¼šè¿æ¥/äº‹åŠ¡ã€å‘½ä¸­ç‡/WALé€Ÿç‡ã€æ£€æŸ¥ç‚¹ã€Autovacuumã€Topè¡¨ä¸ç´¢å¼•ã€TopæŸ¥è¯¢ã€é”ç­‰å¾…çƒ­åŠ›å›¾ã€‚
- å‘Šè­¦ï¼šè¿æ¥æ¥è¿‘ä¸Šé™ã€å‘½ä¸­ç‡éª¤é™ã€WALæš´æ¶¨ã€æ£€æŸ¥ç‚¹é¢‘ç‡å¼‚å¸¸ã€Autovacuumæ»åã€æ­»é”äº‹ä»¶ã€‚

## 5. å¸¸è§é—®é¢˜ä¸å¯¹ç­–

- ä¼°ç®—åå·®å¤§ï¼šæé«˜ç»Ÿè®¡ç›®æ ‡ã€æ‰©å±•ç»Ÿè®¡ã€è¡¨è¾¾å¼åˆ—ï¼›
- ç´¢å¼•æœªå‘½ä¸­ï¼šè°“è¯ä¸åŒ¹é…ã€å‡½æ•°æœªå¯ç´¢å¼•åŒ–ã€ç±»å‹éšå¼è½¬æ¢ï¼›
- å†™æ”¾å¤§ä¸è†¨èƒ€ï¼šæ‰¹å†™/åˆå¹¶ã€åˆç† `fillfactor`ã€å†·çƒ­åˆ†å±‚ã€å‘¨æœŸé‡å»ºã€‚

## 6. æ—¥å¿—ä¸å¯è§‚æµ‹æ€§å¢å¼º

- å»ºè®®çš„ `postgresql.conf` æ—¥å¿—å…³é”®é¡¹ï¼š

  ```text
  log_line_prefix = '%m [%p] %u@%d %r %a '
  log_min_duration_statement = 500ms        # ç”Ÿäº§æŒ‰æµé‡ä¸å­˜å‚¨è°ƒèŠ‚
  log_checkpoints = on
  log_autovacuum_min_duration = 1s
  log_lock_waits = on
  track_io_timing = on
  shared_preload_libraries = 'pg_stat_statements,auto_explain'
  auto_explain.log_min_duration = '200ms'
  auto_explain.log_analyze = on
  auto_explain.log_buffers = on
  ```

- æ…¢æ—¥å¿—é‡‡é›†ï¼š
  - Filebeat/Vector â†’ Loki/Elasticï¼Œå†åœ¨ Grafana å»ºç«‹æ…¢SQLé¢æ¿ä¸ TopNã€‚
  - ç”Ÿæˆ `fingerprint`ï¼ˆæ­£åˆ™å½’ä¸€åŒ–ï¼‰ä¾¿äºèšåˆç»Ÿè®¡ã€‚

## 6. äº¤å‰å¼•ç”¨

- `02-æŸ¥è¯¢å¤„ç†/02.04-æ‰§è¡Œè®¡åˆ’ä¸æ€§èƒ½è°ƒä¼˜.md`
- `01-æ ¸å¿ƒåŸºç¡€/01.06-å­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–.md`
- `1.1.49-é€‰æ‹©ç‡ä¼°è®¡è¯¯å·®-æ•æ„Ÿæ€§ä¸ä¸Šç•Œ.md`
