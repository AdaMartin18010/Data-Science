# CI/CD流水线实践案例

## 概述

本文档提供CI/CD流水线的实践应用案例，涵盖Jenkins、GitLab CI、GitHub Actions等主流CI/CD工具的实际应用场景。

## 1. Jenkins流水线实践

### 1.1 基础Jenkins流水线

```python
import jenkins
import time
from typing import Dict, List, Optional

class JenkinsPipelineManager:
    def __init__(self, jenkins_url: str, username: str, password: str):
        self.server = jenkins.Jenkins(jenkins_url, username=username, password=password)
        self.jobs = {}
    
    def create_pipeline_job(self, job_name: str, pipeline_script: str) -> bool:
        """创建流水线任务"""
        try:
            job_config = f"""
            <flow-definition plugin="workflow-job@2.40">
                <description>Pipeline job for {job_name}</description>
                <keepDependencies>false</keepDependencies>
                <properties/>
                <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@2.80">
                    <script>{pipeline_script}</script>
                    <sandbox>true</sandbox>
                </definition>
                <triggers/>
                <disabled>false</disabled>
            </flow-definition>
            """
            
            self.server.create_job(job_name, job_config)
            print(f"流水线任务创建成功: {job_name}")
            return True
        except Exception as e:
            print(f"流水线任务创建失败: {e}")
            return False
    
    def trigger_build(self, job_name: str, parameters: Dict = None) -> Optional[int]:
        """触发构建"""
        try:
            if parameters:
                build_number = self.server.build_job(job_name, parameters=parameters)
            else:
                build_number = self.server.build_job(job_name)
            
            print(f"构建触发成功: {job_name} #{build_number}")
            return build_number
        except Exception as e:
            print(f"构建触发失败: {e}")
            return None
    
    def get_build_info(self, job_name: str, build_number: int) -> Dict:
        """获取构建信息"""
        try:
            build_info = self.server.get_build_info(job_name, build_number)
            return {
                'number': build_info['number'],
                'result': build_info.get('result'),
                'building': build_info['building'],
                'duration': build_info.get('duration'),
                'timestamp': build_info.get('timestamp'),
                'url': build_info['url']
            }
        except Exception as e:
            print(f"获取构建信息失败: {e}")
            return {}
    
    def wait_for_build_completion(self, job_name: str, build_number: int, 
                                 timeout: int = 600) -> bool:
        """等待构建完成"""
        start_time = time.time()
        
        while time.time() - start_time < timeout:
            build_info = self.get_build_info(job_name, build_number)
            
            if not build_info.get('building', False):
                return build_info.get('result') == 'SUCCESS'
            
            time.sleep(10)
        
        return False
    
    def get_build_logs(self, job_name: str, build_number: int) -> str:
        """获取构建日志"""
        try:
            logs = self.server.get_build_console_output(job_name, build_number)
            return logs
        except Exception as e:
            print(f"获取构建日志失败: {e}")
            return ""

# 使用示例
def demonstrate_jenkins_pipeline():
    """演示Jenkins流水线"""
    # 初始化Jenkins管理器（需要实际的Jenkins配置）
    # jenkins_manager = JenkinsPipelineManager(
    #     jenkins_url="http://jenkins.example.com",
    #     username="admin",
    #     password="password"
    # )
    
    # 定义流水线脚本
    pipeline_script = """
    pipeline {
        agent any
        
        stages {
            stage('Checkout') {
                steps {
                    checkout scm
                }
            }
            
            stage('Build') {
                steps {
                    sh 'mvn clean compile'
                }
            }
            
            stage('Test') {
                steps {
                    sh 'mvn test'
                }
            }
            
            stage('Deploy') {
                steps {
                    sh 'mvn deploy'
                }
            }
        }
        
        post {
            always {
                cleanWs()
            }
        }
    }
    """
    
    # 创建流水线任务
    # jenkins_manager.create_pipeline_job("myapp-pipeline", pipeline_script)
    
    # 触发构建
    # build_number = jenkins_manager.trigger_build("myapp-pipeline")
    
    # 等待构建完成
    # if build_number:
    #     success = jenkins_manager.wait_for_build_completion("myapp-pipeline", build_number)
    #     print(f"构建结果: {'成功' if success else '失败'}")
```

### 1.2 多阶段Jenkins流水线

```python
class MultiStageJenkinsPipeline:
    def __init__(self, jenkins_manager):
        self.jenkins_manager = jenkins_manager
    
    def create_multi_stage_pipeline(self, job_name: str) -> bool:
        """创建多阶段流水线"""
        pipeline_script = """
        pipeline {
            agent any
            
            environment {
                DOCKER_IMAGE = 'myapp'
                DOCKER_TAG = 'latest'
            }
            
            stages {
                stage('Code Checkout') {
                    steps {
                        checkout scm
                        echo '代码检出完成'
                    }
                }
                
                stage('Code Quality') {
                    parallel {
                        stage('SonarQube Analysis') {
                            steps {
                                sh 'mvn sonar:sonar'
                            }
                        }
                        stage('Security Scan') {
                            steps {
                                sh 'mvn dependency:check'
                            }
                        }
                    }
                }
                
                stage('Build') {
                    steps {
                        sh 'mvn clean package'
                        archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                    }
                }
                
                stage('Unit Test') {
                    steps {
                        sh 'mvn test'
                    }
                    post {
                        always {
                            publishTestResults testResultsPattern: '**/target/surefire-reports/*.xml'
                        }
                    }
                }
                
                stage('Integration Test') {
                    steps {
                        sh 'mvn verify'
                    }
                }
                
                stage('Build Docker Image') {
                    steps {
                        script {
                            docker.build("${DOCKER_IMAGE}:${DOCKER_TAG}")
                        }
                    }
                }
                
                stage('Push to Registry') {
                    when {
                        branch 'main'
                    }
                    steps {
                        script {
                            docker.withRegistry('https://registry.example.com', 'registry-credentials') {
                                docker.image("${DOCKER_IMAGE}:${DOCKER_TAG}").push()
                            }
                        }
                    }
                }
                
                stage('Deploy to Staging') {
                    when {
                        branch 'main'
                    }
                    steps {
                        sh 'kubectl apply -f k8s/staging/'
                    }
                }
                
                stage('Deploy to Production') {
                    when {
                        branch 'main'
                    }
                    steps {
                        input message: '部署到生产环境？'
                        sh 'kubectl apply -f k8s/production/'
                    }
                }
            }
            
            post {
                always {
                    cleanWs()
                }
                success {
                    echo '流水线执行成功！'
                }
                failure {
                    echo '流水线执行失败！'
                    emailext (
                        subject: "构建失败: ${env.JOB_NAME} [${env.BUILD_NUMBER}]",
                        body: "构建失败，请检查日志: ${env.BUILD_URL}",
                        to: "team@example.com"
                    )
                }
            }
        }
        """
        
        return self.jenkins_manager.create_pipeline_job(job_name, pipeline_script)

# 使用示例
def demonstrate_multi_stage_pipeline():
    """演示多阶段流水线"""
    # jenkins_manager = JenkinsPipelineManager("http://jenkins.example.com", "admin", "password")
    # multi_stage = MultiStageJenkinsPipeline(jenkins_manager)
    
    # 创建多阶段流水线
    # multi_stage.create_multi_stage_pipeline("myapp-multi-stage")
```

## 2. GitLab CI流水线实践

### 2.1 GitLab CI配置文件

```yaml
# .gitlab-ci.yml
stages:
  - code_quality
  - build
  - test
  - security
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# 代码质量检查
code_quality:
  stage: code_quality
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker run --rm -v $(pwd):/code registry.gitlab.com/gitlab-org/ci-cd/codequality:latest /code
  artifacts:
    reports:
      codequality: gl-code-quality-report.json

# 构建阶段
build:
  stage: build
  image: maven:3.8-openjdk-11
  script:
    - mvn clean compile
    - mvn package -DskipTests
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 week

# 单元测试
unit_test:
  stage: test
  image: maven:3.8-openjdk-11
  script:
    - mvn test
  artifacts:
    reports:
      junit: target/surefire-reports/TEST-*.xml
    expire_in: 1 week

# 集成测试
integration_test:
  stage: test
  image: maven:3.8-openjdk-11
  script:
    - mvn verify
  dependencies:
    - build

# 安全扫描
security_scan:
  stage: security
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker run --rm -v $(pwd):/app owasp/zap2docker-stable zap-baseline.py -t http://localhost:8080
  allow_failure: true

# 构建Docker镜像
docker_build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  only:
    - main
    - develop

# 部署到测试环境
deploy_staging:
  stage: deploy
  image: alpine/helm:latest
  script:
    - helm upgrade --install myapp-staging ./helm-chart --set image.tag=$CI_COMMIT_SHA
  environment:
    name: staging
    url: https://staging.example.com
  only:
    - develop

# 部署到生产环境
deploy_production:
  stage: deploy
  image: alpine/helm:latest
  script:
    - helm upgrade --install myapp-production ./helm-chart --set image.tag=$CI_COMMIT_SHA
  environment:
    name: production
    url: https://example.com
  when: manual
  only:
    - main
```

### 2.2 GitLab CI Python客户端

```python
import gitlab
from typing import Dict, List, Optional

class GitLabCIManager:
    def __init__(self, gitlab_url: str, private_token: str):
        self.gl = gitlab.Gitlab(url=gitlab_url, private_token=private_token)
        self.projects = {}
    
    def get_project(self, project_id: str):
        """获取项目"""
        try:
            project = self.gl.projects.get(project_id)
            self.projects[project_id] = project
            return project
        except Exception as e:
            print(f"获取项目失败: {e}")
            return None
    
    def trigger_pipeline(self, project_id: str, ref: str = "main", 
                        variables: Dict = None) -> Optional[int]:
        """触发流水线"""
        try:
            project = self.get_project(project_id)
            if not project:
                return None
            
            pipeline = project.pipelines.create({
                'ref': ref,
                'variables': variables or {}
            })
            
            print(f"流水线触发成功: {pipeline.id}")
            return pipeline.id
        except Exception as e:
            print(f"流水线触发失败: {e}")
            return None
    
    def get_pipeline_status(self, project_id: str, pipeline_id: int) -> Dict:
        """获取流水线状态"""
        try:
            project = self.get_project(project_id)
            if not project:
                return {}
            
            pipeline = project.pipelines.get(pipeline_id)
            return {
                'id': pipeline.id,
                'status': pipeline.status,
                'ref': pipeline.ref,
                'sha': pipeline.sha,
                'created_at': pipeline.created_at,
                'updated_at': pipeline.updated_at,
                'duration': pipeline.duration
            }
        except Exception as e:
            print(f"获取流水线状态失败: {e}")
            return {}
    
    def get_pipeline_jobs(self, project_id: str, pipeline_id: int) -> List[Dict]:
        """获取流水线任务"""
        try:
            project = self.get_project(project_id)
            if not project:
                return []
            
            pipeline = project.pipelines.get(pipeline_id)
            jobs = []
            
            for job in pipeline.jobs.list():
                jobs.append({
                    'id': job.id,
                    'name': job.name,
                    'stage': job.stage,
                    'status': job.status,
                    'created_at': job.created_at,
                    'started_at': job.started_at,
                    'finished_at': job.finished_at
                })
            
            return jobs
        except Exception as e:
            print(f"获取流水线任务失败: {e}")
            return []
    
    def cancel_pipeline(self, project_id: str, pipeline_id: int) -> bool:
        """取消流水线"""
        try:
            project = self.get_project(project_id)
            if not project:
                return False
            
            pipeline = project.pipelines.get(pipeline_id)
            pipeline.cancel()
            print(f"流水线取消成功: {pipeline_id}")
            return True
        except Exception as e:
            print(f"流水线取消失败: {e}")
            return False

# 使用示例
def demonstrate_gitlab_ci():
    """演示GitLab CI"""
    # gitlab_ci = GitLabCIManager(
    #     gitlab_url="https://gitlab.example.com",
    #     private_token="your-token"
    # )
    
    # 触发流水线
    # pipeline_id = gitlab_ci.trigger_pipeline("123", "main")
    
    # 检查状态
    # if pipeline_id:
    #     status = gitlab_ci.get_pipeline_status("123", pipeline_id)
    #     print("流水线状态:", status)
    #     
    #     jobs = gitlab_ci.get_pipeline_jobs("123", pipeline_id)
    #     print("流水线任务:", jobs)
```

## 3. GitHub Actions流水线实践

### 3.1 GitHub Actions工作流配置

```yaml
# .github/workflows/ci-cd.yml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # 代码质量检查
  code-quality:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Run SonarQube
      uses: sonarqube-quality-gate-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        scannerHome: ${{ github.workspace }}/sonar-scanner
    
    - name: Run CodeQL Analysis
      uses: github/codeql-action/init@v2
      with:
        languages: java
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2

  # 构建和测试
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-version: [8, 11, 17]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v3
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin'
    
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Build with Maven
      run: mvn clean compile
    
    - name: Run tests
      run: mvn test
    
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.java-version }}
        path: target/surefire-reports/

  # 安全扫描
  security-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Run OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'My Project'
        path: '.'
        format: 'HTML'
        out: 'reports'
    
    - name: Upload security report
      uses: actions/upload-artifact@v3
      with:
        name: security-report
        path: reports/

  # 构建Docker镜像
  build-image:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Log in to Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}

  # 部署到测试环境
  deploy-staging:
    needs: build-image
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to staging
      run: |
        echo "Deploying to staging environment"
        # 添加实际的部署脚本
    
    - name: Run smoke tests
      run: |
        echo "Running smoke tests"
        # 添加实际的测试脚本

  # 部署到生产环境
  deploy-production:
    needs: build-image
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to production
      run: |
        echo "Deploying to production environment"
        # 添加实际的部署脚本
    
    - name: Run health checks
      run: |
        echo "Running health checks"
        # 添加实际的健康检查脚本
```

### 3.2 GitHub Actions Python客户端

```python
import requests
from typing import Dict, List, Optional
import base64

class GitHubActionsManager:
    def __init__(self, token: str, owner: str, repo: str):
        self.token = token
        self.owner = owner
        self.repo = repo
        self.base_url = "https://api.github.com"
        self.headers = {
            "Authorization": f"token {token}",
            "Accept": "application/vnd.github.v3+json"
        }
    
    def trigger_workflow(self, workflow_id: str, ref: str = "main", 
                        inputs: Dict = None) -> bool:
        """触发工作流"""
        try:
            url = f"{self.base_url}/repos/{self.owner}/{self.repo}/actions/workflows/{workflow_id}/dispatches"
            
            data = {
                "ref": ref
            }
            
            if inputs:
                data["inputs"] = inputs
            
            response = requests.post(url, headers=self.headers, json=data)
            return response.status_code == 204
        except Exception as e:
            print(f"触发工作流失败: {e}")
            return False
    
    def get_workflow_runs(self, workflow_id: str = None) -> List[Dict]:
        """获取工作流运行记录"""
        try:
            if workflow_id:
                url = f"{self.base_url}/repos/{self.owner}/{self.repo}/actions/workflows/{workflow_id}/runs"
            else:
                url = f"{self.base_url}/repos/{self.owner}/{self.repo}/actions/runs"
            
            response = requests.get(url, headers=self.headers)
            
            if response.status_code == 200:
                data = response.json()
                return data.get("workflow_runs", [])
            return []
        except Exception as e:
            print(f"获取工作流运行记录失败: {e}")
            return []
    
    def get_run_status(self, run_id: int) -> Dict:
        """获取运行状态"""
        try:
            url = f"{self.base_url}/repos/{self.owner}/{self.repo}/actions/runs/{run_id}"
            response = requests.get(url, headers=self.headers)
            
            if response.status_code == 200:
                return response.json()
            return {}
        except Exception as e:
            print(f"获取运行状态失败: {e}")
            return {}
    
    def cancel_run(self, run_id: int) -> bool:
        """取消运行"""
        try:
            url = f"{self.base_url}/repos/{self.owner}/{self.repo}/actions/runs/{run_id}/cancel"
            response = requests.post(url, headers=self.headers)
            return response.status_code == 202
        except Exception as e:
            print(f"取消运行失败: {e}")
            return False
    
    def get_run_logs(self, run_id: int) -> str:
        """获取运行日志"""
        try:
            url = f"{self.base_url}/repos/{self.owner}/{self.repo}/actions/runs/{run_id}/logs"
            response = requests.get(url, headers=self.headers)
            
            if response.status_code == 200:
                return response.text
            return ""
        except Exception as e:
            print(f"获取运行日志失败: {e}")
            return ""

# 使用示例
def demonstrate_github_actions():
    """演示GitHub Actions"""
    # github_actions = GitHubActionsManager(
    #     token="your-token",
    #     owner="your-username",
    #     repo="your-repo"
    # )
    
    # 触发工作流
    # success = github_actions.trigger_workflow("ci-cd.yml", "main")
    
    # 获取运行记录
    # runs = github_actions.get_workflow_runs()
    # print("工作流运行记录:", runs)
    
    # 检查特定运行状态
    # if runs:
    #     run_status = github_actions.get_run_status(runs[0]['id'])
    #     print("运行状态:", run_status)
```

## 4. 总结

本文档提供了CI/CD流水线的实践案例，涵盖：

1. **Jenkins流水线**：基础流水线、多阶段流水线
2. **GitLab CI**：配置文件、Python客户端
3. **GitHub Actions**：工作流配置、Python客户端

每个案例都包含：

- 流水线配置
- 自动化脚本
- 错误处理机制
- 实际应用场景

这些实践案例展示了现代CI/CD流水线的核心技术和最佳实践，为构建高效、可靠的持续集成和部署系统提供了参考。
