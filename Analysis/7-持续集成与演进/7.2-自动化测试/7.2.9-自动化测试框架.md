# 7.2.9 自动化测试框架

## 目标

建立分层自动化测试框架：单元测试、集成测试、端到端测试（E2E），纳入CI/CD门禁与质量阈值。

## 分层设计

- 单元测试：Rust `cargo test`、Go `go test -race`
- 集成测试：Docker Compose + PostgreSQL 测试库
- 端到端测试：Playwright/K6 负载

## 示例

```yaml
# .github/workflows/test.yml
name: Test Suite
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with: {go-version: '1.22'}
      - uses: actions-rs/toolchain@v1
        with: {toolchain: stable}
      - name: Go unit
        run: go test ./... -race -coverprofile=coverage.out
      - name: Rust unit
        run: cargo test --all --locked
```

## 覆盖率门禁

- Go: `go tool cover -func=coverage.out | awk '$3 ~ /[0-9]+\.[0-9]+%/ {sum+=$3} END { if (sum/NR < 70) exit 1 }'`
- Rust: 使用 `grcov` 汇总并设置 ≥70%

## 数据库集成测试

```yaml
services:
  postgres:
    image: postgres:15
    env:
      POSTGRES_PASSWORD: test
    ports: ['5432:5432']
```
