# 10.1.5-å†…å­˜å®‰å…¨æ·±åŒ–

## ğŸ“‘ ç›®å½•

- [10.1.5-å†…å­˜å®‰å…¨æ·±åŒ–](#1015-å†…å­˜å®‰å…¨æ·±åŒ–)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
- [æ¦‚è¿°](#æ¦‚è¿°)
- [å†…å­˜å®‰å…¨é—®é¢˜](#å†…å­˜å®‰å…¨é—®é¢˜)
  - [å¸¸è§å†…å­˜é”™è¯¯](#å¸¸è§å†…å­˜é”™è¯¯)
  - [ä¼ ç»Ÿè¯­è¨€çš„é—®é¢˜](#ä¼ ç»Ÿè¯­è¨€çš„é—®é¢˜)
- [Rustå†…å­˜å®‰å…¨æœºåˆ¶](#rustå†…å­˜å®‰å…¨æœºåˆ¶)
  - [æ‰€æœ‰æƒç³»ç»Ÿ](#æ‰€æœ‰æƒç³»ç»Ÿ)
  - [å€Ÿç”¨æ£€æŸ¥å™¨](#å€Ÿç”¨æ£€æŸ¥å™¨)
  - [ç”Ÿå‘½å‘¨æœŸç³»ç»Ÿ](#ç”Ÿå‘½å‘¨æœŸç³»ç»Ÿ)
- [å†…å­˜å®‰å…¨ä¿è¯](#å†…å­˜å®‰å…¨ä¿è¯)
  - [ç¼–è¯‘æ—¶æ£€æŸ¥](#ç¼–è¯‘æ—¶æ£€æŸ¥)
  - [å€Ÿç”¨è§„åˆ™](#å€Ÿç”¨è§„åˆ™)
- [æ™ºèƒ½æŒ‡é’ˆ](#æ™ºèƒ½æŒ‡é’ˆ)
  - [`Box<T>` - å †åˆ†é…](#boxt-å †åˆ†é…)
  - [`Rc<T>` - å¼•ç”¨è®¡æ•°](#rct-å¼•ç”¨è®¡æ•°)
  - [`Arc<T>` - åŸå­å¼•ç”¨è®¡æ•°](#arct-åŸå­å¼•ç”¨è®¡æ•°)
- [å¹¶å‘å®‰å…¨](#å¹¶å‘å®‰å…¨)
  - [`Mutex<T>` - äº’æ–¥é”](#mutext-äº’æ–¥é”)
  - [`RwLock<T>` - è¯»å†™é”](#rwlockt-è¯»å†™é”)
- [å†…å­˜å®‰å…¨æ¨¡å¼](#å†…å­˜å®‰å…¨æ¨¡å¼)
  - [RAIIæ¨¡å¼](#raiiæ¨¡å¼)
  - [å†…éƒ¨å¯å˜æ€§](#å†…éƒ¨å¯å˜æ€§)
- [å†…å­˜å®‰å…¨æœ€ä½³å®è·µ](#å†…å­˜å®‰å…¨æœ€ä½³å®è·µ)
  - [é¿å…unsafeä»£ç ](#é¿å…unsafeä»£ç )
  - [ä½¿ç”¨ç±»å‹ç³»ç»Ÿ](#ä½¿ç”¨ç±»å‹ç³»ç»Ÿ)
  - [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
- [å†…å­˜å®‰å…¨éªŒè¯](#å†…å­˜å®‰å…¨éªŒè¯)
  - [1ç¼–è¯‘æ—¶æ£€æŸ¥](#1ç¼–è¯‘æ—¶æ£€æŸ¥)
  - [è¿è¡Œæ—¶æ£€æŸ¥](#è¿è¡Œæ—¶æ£€æŸ¥)
- [æ€»ç»“](#æ€»ç»“)
---


## æ¦‚è¿°

å†…å­˜å®‰å…¨æ˜¯Rustè¯­è¨€çš„æ ¸å¿ƒç‰¹æ€§ï¼Œé€šè¿‡ç¼–è¯‘æ—¶æ£€æŸ¥ç¡®ä¿ç¨‹åºä¸ä¼šå‡ºç°å†…å­˜é”™è¯¯ã€‚

## å†…å­˜å®‰å…¨é—®é¢˜

### å¸¸è§å†…å­˜é”™è¯¯

1. ç©ºæŒ‡é’ˆè§£å¼•ç”¨
2. æ‚¬å‚æŒ‡é’ˆ
3. ç¼“å†²åŒºæº¢å‡º
4. æ•°æ®ç«äº‰
5. å†…å­˜æ³„æ¼

### ä¼ ç»Ÿè¯­è¨€çš„é—®é¢˜

```c
// Cè¯­è¨€ä¸­çš„å†…å­˜å®‰å…¨é—®é¢˜
int* ptr = malloc(sizeof(int));
*ptr = 42;
free(ptr);
*ptr = 100; // æ‚¬å‚æŒ‡é’ˆ

int arr[5];
arr[10] = 42; // ç¼“å†²åŒºæº¢å‡º
```

## Rustå†…å­˜å®‰å…¨æœºåˆ¶

### æ‰€æœ‰æƒç³»ç»Ÿ

```rust
fn main() {
    let s1 = String::from("hello");
    let s2 = s1; // s1çš„æ‰€æœ‰æƒç§»åŠ¨åˆ°s2

    // println!("{}", s1); // ç¼–è¯‘é”™è¯¯ï¼šs1å·²è¢«ç§»åŠ¨
    println!("{}", s2); // æ­£å¸¸å·¥ä½œ
}
```

### å€Ÿç”¨æ£€æŸ¥å™¨

```rust
fn main() {
    let mut data = vec![1, 2, 3];

    let reference = &data; // ä¸å¯å˜å€Ÿç”¨
    // data.push(4); // ç¼–è¯‘é”™è¯¯ï¼šåŒæ—¶å­˜åœ¨å¯å˜å’Œä¸å¯å˜å€Ÿç”¨

    println!("{:?}", reference);
    data.push(4); // ç°åœ¨å¯ä»¥ä¿®æ”¹
}
```

### ç”Ÿå‘½å‘¨æœŸç³»ç»Ÿ

```rust
fn longest<'a>(x: &'a str, y: &'a str) -> &'a str {
    if x.len() > y.len() { x } else { y }
}

fn main() {
    let string1 = String::from("long string");
    let result;
    {
        let string2 = String::from("xyz");
        result = longest(&string1, &string2);
    }
    // println!("{}", result); // ç¼–è¯‘é”™è¯¯ï¼šç”Ÿå‘½å‘¨æœŸä¸å¤Ÿé•¿
}
```

## å†…å­˜å®‰å…¨ä¿è¯

### ç¼–è¯‘æ—¶æ£€æŸ¥

```rust
fn ownership_example() {
    let s = String::from("hello");
    takes_ownership(s);
    // println!("{}", s); // ç¼–è¯‘é”™è¯¯ï¼šså·²è¢«ç§»åŠ¨
}

fn takes_ownership(some_string: String) {
    println!("{}", some_string);
} // some_stringç¦»å¼€ä½œç”¨åŸŸå¹¶è¢«é‡Šæ”¾
```

### å€Ÿç”¨è§„åˆ™

```rust
fn borrowing_rules() {
    let mut data = vec![1, 2, 3];

    // è§„åˆ™1ï¼šä»»æ„æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨æˆ–å¤šä¸ªä¸å¯å˜å¼•ç”¨
    let ref1 = &data; // ä¸å¯å˜å¼•ç”¨
    let ref2 = &data; // ä¸å¯å˜å¼•ç”¨
    // let ref3 = &mut data; // ç¼–è¯‘é”™è¯¯ï¼šä¸èƒ½åŒæ—¶æœ‰å¯å˜å’Œä¸å¯å˜å¼•ç”¨

    println!("{} {}", ref1[0], ref2[1]);
}
```

## æ™ºèƒ½æŒ‡é’ˆ

### `Box<T>` - å †åˆ†é…

```rust
use std::boxed::Box;

fn box_example() {
    let b = Box::new(5);
    println!("b = {}", b);
} // bç¦»å¼€ä½œç”¨åŸŸæ—¶è‡ªåŠ¨é‡Šæ”¾
```

### `Rc<T>` - å¼•ç”¨è®¡æ•°

```rust
use std::rc::Rc;

fn rc_example() {
    let data = Rc::new(vec![1, 2, 3]);
    let data_clone1 = Rc::clone(&data);
    let data_clone2 = Rc::clone(&data);

    println!("å¼•ç”¨è®¡æ•°: {}", Rc::strong_count(&data));
    println!("æ•°æ®: {:?}", data);
}
```

### `Arc<T>` - åŸå­å¼•ç”¨è®¡æ•°

```rust
use std::sync::Arc;
use std::thread;

fn arc_example() {
    let counter = Arc::new(0);
    let mut handles = vec![];

    for _ in 0..10 {
        let counter = Arc::clone(&counter);
        let handle = thread::spawn(move || {
            println!("çº¿ç¨‹ä¸­çš„è®¡æ•°å™¨: {}", counter);
        });
        handles.push(handle);
    }

    for handle in handles {
        handle.join().unwrap();
    }
}
```

## å¹¶å‘å®‰å…¨

### `Mutex<T>` - äº’æ–¥é”

```rust
use std::sync::{Arc, Mutex};
use std::thread;

fn mutex_example() {
    let counter = Arc::new(Mutex::new(0));
    let mut handles = vec![];

    for _ in 0..10 {
        let counter = Arc::clone(&counter);
        let handle = thread::spawn(move || {
            let mut num = counter.lock().unwrap();
            *num += 1;
        });
        handles.push(handle);
    }

    for handle in handles {
        handle.join().unwrap();
    }

    println!("æœ€ç»ˆè®¡æ•°: {}", *counter.lock().unwrap());
}
```

### `RwLock<T>` - è¯»å†™é”

```rust
use std::sync::{Arc, RwLock};
use std::thread;

fn rwlock_example() {
    let data = Arc::new(RwLock::new(vec![1, 2, 3]));
    let mut handles = vec![];

    // è¯»å–çº¿ç¨‹
    for i in 0..3 {
        let data = Arc::clone(&data);
        let handle = thread::spawn(move || {
            let read_data = data.read().unwrap();
            println!("è¯»å–çº¿ç¨‹ {}: {:?}", i, *read_data);
        });
        handles.push(handle);
    }

    // å†™å…¥çº¿ç¨‹
    let data = Arc::clone(&data);
    let handle = thread::spawn(move || {
        let mut write_data = data.write().unwrap();
        write_data.push(4);
        println!("å†™å…¥çº¿ç¨‹: {:?}", *write_data);
    });
    handles.push(handle);

    for handle in handles {
        handle.join().unwrap();
    }
}
```

## å†…å­˜å®‰å…¨æ¨¡å¼

### RAIIæ¨¡å¼

```rust
struct Resource {
    data: String,
}

impl Resource {
    fn new(data: String) -> Self {
        println!("åˆ›å»ºèµ„æº: {}", data);
        Resource { data }
    }
}

impl Drop for Resource {
    fn drop(&mut self) {
        println!("é‡Šæ”¾èµ„æº: {}", self.data);
    }
}

fn raii_example() {
    let resource = Resource::new("hello".to_string());
    println!("ä½¿ç”¨èµ„æº: {}", resource.data);
} // è‡ªåŠ¨è°ƒç”¨dropæ–¹æ³•
```

### å†…éƒ¨å¯å˜æ€§

```rust
use std::cell::RefCell;

fn interior_mutability() {
    let data = RefCell::new(5);

    {
        let mut borrowed = data.borrow_mut();
        *borrowed += 10;
    }

    println!("æ•°æ®: {}", *data.borrow());
}
```

## å†…å­˜å®‰å…¨æœ€ä½³å®è·µ

### é¿å…unsafeä»£ç 

```rust
// å®‰å…¨çš„ä»£ç 
fn safe_function(data: &[i32]) -> i32 {
    data.iter().sum()
}

// ä¸å®‰å…¨çš„ä»£ç ï¼ˆä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨ï¼‰
unsafe fn unsafe_function(ptr: *const i32) -> i32 {
    *ptr // å¯èƒ½ä¸å®‰å…¨
}
```

### ä½¿ç”¨ç±»å‹ç³»ç»Ÿ

```rust
// ä½¿ç”¨å¼ºç±»å‹é¿å…é”™è¯¯
struct UserId(u32);
struct ProductId(u32);

fn process_user(user_id: UserId) {
    // ç±»å‹å®‰å…¨ï¼Œä¸èƒ½ä¼ å…¥ProductId
}

fn process_product(product_id: ProductId) {
    // ç±»å‹å®‰å…¨ï¼Œä¸èƒ½ä¼ å…¥UserId
}
```

### é”™è¯¯å¤„ç†

```rust
use std::fs::File;
use std::io::{self, Read};

fn read_file_safely(path: &str) -> Result<String, io::Error> {
    let mut file = File::open(path)?;
    let mut contents = String::new();
    file.read_to_string(&mut contents)?;
    Ok(contents)
}

fn main() {
    match read_file_safely("data.txt") {
        Ok(content) => println!("æ–‡ä»¶å†…å®¹: {}", content),
        Err(e) => eprintln!("è¯»å–é”™è¯¯: {}", e),
    }
}
```

## å†…å­˜å®‰å…¨éªŒè¯

### 1ç¼–è¯‘æ—¶æ£€æŸ¥

```rust
// æ‰€æœ‰æƒæ£€æŸ¥
fn ownership_check() {
    let s = String::from("hello");
    let s_ref = &s;
    // s_refçš„ç”Ÿå‘½å‘¨æœŸä¸èƒ½è¶…è¿‡s
    println!("{}", s_ref);
}

// å€Ÿç”¨æ£€æŸ¥
fn borrowing_check() {
    let mut data = vec![1, 2, 3];
    let ref1 = &data;
    let ref2 = &data;
    // å¯ä»¥åŒæ—¶æœ‰å¤šä¸ªä¸å¯å˜å¼•ç”¨
    println!("{} {}", ref1[0], ref2[1]);
}
```

### è¿è¡Œæ—¶æ£€æŸ¥

```rust
use std::cell::RefCell;

fn runtime_check() {
    let data = RefCell::new(vec![1, 2, 3]);

    // è¿è¡Œæ—¶å€Ÿç”¨æ£€æŸ¥
    let ref1 = data.borrow();
    // let ref2 = data.borrow_mut(); // è¿è¡Œæ—¶panicï¼šå·²å­˜åœ¨ä¸å¯å˜å€Ÿç”¨

    println!("{:?}", *ref1);
}
```

## æ€»ç»“

Rustçš„å†…å­˜å®‰å…¨æœºåˆ¶é€šè¿‡ç¼–è¯‘æ—¶æ£€æŸ¥ã€æ‰€æœ‰æƒç³»ç»Ÿã€å€Ÿç”¨æ£€æŸ¥å™¨å’Œç”Ÿå‘½å‘¨æœŸç³»ç»Ÿï¼Œæœ‰æ•ˆé˜²æ­¢äº†å¸¸è§çš„å†…å­˜é”™è¯¯ï¼Œä¸ºç¨‹åºæä¾›äº†å¼ºå¤§çš„å®‰å…¨ä¿éšœã€‚

---

**ç›¸å…³é“¾æ¥ï¼š**

- [10.1.1-æ‰€æœ‰æƒç³»ç»Ÿæ·±åŒ–](10.1.1-æ‰€æœ‰æƒç³»ç»Ÿæ·±åŒ–.md)
- [10.1.2-ç”Ÿå‘½å‘¨æœŸæ·±åŒ–](10.1.2-ç”Ÿå‘½å‘¨æœŸæ·±åŒ–.md)
- [10.1.3-å€Ÿç”¨æ£€æŸ¥æ·±åŒ–](10.1.3-å€Ÿç”¨æ£€æŸ¥æ·±åŒ–.md)
- [10.1.4-é›¶æˆæœ¬æŠ½è±¡æ·±åŒ–](10.1.4-é›¶æˆæœ¬æŠ½è±¡æ·±åŒ–.md)
- [10.1.6-å¹¶å‘ç¼–ç¨‹æ·±åŒ–](10.1.6-å¹¶å‘ç¼–ç¨‹æ·±åŒ–.md)
