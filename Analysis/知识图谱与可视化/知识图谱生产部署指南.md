# çŸ¥è¯†å›¾è°±ç”Ÿäº§éƒ¨ç½²æŒ‡å—

## ğŸ“‘ ç›®å½•

- [çŸ¥è¯†å›¾è°±ç”Ÿäº§éƒ¨ç½²æŒ‡å—](#çŸ¥è¯†å›¾è°±ç”Ÿäº§éƒ¨ç½²æŒ‡å—)
  - [ğŸ“‘ ç›®å½•](#-ç›®å½•)
  - [1. ç”Ÿäº§ç¯å¢ƒæ¶æ„](#1-ç”Ÿäº§ç¯å¢ƒæ¶æ„)
    - [1.1. é«˜å¯ç”¨æ¶æ„è®¾è®¡](#11-é«˜å¯ç”¨æ¶æ„è®¾è®¡)
  - [2. Kuberneteséƒ¨ç½²é…ç½®](#2-kuberneteséƒ¨ç½²é…ç½®)
  - [3. è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬](#3-è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬)
  - [4. ç¯å¢ƒé…ç½®ç®¡ç†](#4-ç¯å¢ƒé…ç½®ç®¡ç†)
  - [5. ç”Ÿäº§ç›‘æ§é…ç½®](#5-ç”Ÿäº§ç›‘æ§é…ç½®)
  - [6. å¤‡ä»½å’Œæ¢å¤ç­–ç•¥](#6-å¤‡ä»½å’Œæ¢å¤ç­–ç•¥)

---


## 1. ç”Ÿäº§ç¯å¢ƒæ¶æ„

### 1.1. é«˜å¯ç”¨æ¶æ„è®¾è®¡

```yaml
# docker-compose.prod.yml
version: '3.8'

services:
# Neo4jé›†ç¾¤
  neo4j-core-1:
    image: neo4j:5.0-enterprise
    hostname: neo4j-core-1
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=neo4j/production_password
      - NEO4J_dbms_mode=CORE
      - NEO4J_causal__clustering_minimum__core__cluster__size__at__formation=3
      - NEO4J_causal__clustering_discovery__advertised__address=neo4j-core-1:5000
      - NEO4J_causal__clustering_transaction__advertised__address=neo4j-core-1:6000
      - NEO4J_causal__clustering_raft__advertised__address=neo4j-core-1:7000
      - NEO4J_dbms_memory_heap_initial__size=2G
      - NEO4J_dbms_memory_heap_max__size=4G
      - NEO4J_dbms_memory_pagecache_size=2G
    volumes:
      - neo4j-core-1-data:/data
      - neo4j-core-1-logs:/logs
    deploy:
      resources:
        limits:
          memory: 6G
          cpus: '2'
    restart: unless-stopped

  neo4j-core-2:
    image: neo4j:5.0-enterprise
    hostname: neo4j-core-2
    ports:
      - "7475:7474"
      - "7688:7687"
    environment:
      - NEO4J_AUTH=neo4j/production_password
      - NEO4J_dbms_mode=CORE
      - NEO4J_causal__clustering_minimum__core__cluster__size__at__formation=3
      - NEO4J_causal__clustering_initial__discovery__members=neo4j-core-1:5000,neo4j-core-2:5000,neo4j-core-3:5000
    volumes:
      - neo4j-core-2-data:/data
      - neo4j-core-2-logs:/logs
    restart: unless-stopped

  neo4j-core-3:
    image: neo4j:5.0-enterprise
    hostname: neo4j-core-3
    ports:
      - "7476:7474"
      - "7689:7687"
    environment:
      - NEO4J_AUTH=neo4j/production_password
      - NEO4J_dbms_mode=CORE
      - NEO4J_causal__clustering_minimum__core__cluster__size__at__formation=3
      - NEO4J_causal__clustering_initial__discovery__members=neo4j-core-1:5000,neo4j-core-2:5000,neo4j-core-3:5000
    volumes:
      - neo4j-core-3-data:/data
      - neo4j-core-3-logs:/logs
    restart: unless-stopped

# PostgreSQLä¸»ä»é›†ç¾¤
  postgres-primary:
    image: postgres:15-alpine
    hostname: postgres-primary
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=kg_metadata
      - POSTGRES_USER=kg_user
      - POSTGRES_PASSWORD=secure_password
      - POSTGRES_REPLICATION_USER=replicator
      - POSTGRES_REPLICATION_PASSWORD=repl_password
    volumes:
      - postgres-primary-data:/var/lib/postgresql/data
      - ./scripts/postgres-primary.conf:/etc/postgresql/postgresql.conf
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    restart: unless-stopped

  postgres-replica:
    image: postgres:15-alpine
    hostname: postgres-replica
    ports:
      - "5433:5432"
    environment:
      - PGUSER=replicator
      - POSTGRES_PASSWORD=repl_password
      - POSTGRES_PRIMARY_HOST=postgres-primary
      - POSTGRES_PRIMARY_PORT=5432
    volumes:
      - postgres-replica-data:/var/lib/postgresql/data
    restart: unless-stopped

# Redisé›†ç¾¤
  redis-master:
    image: redis:7-alpine
    hostname: redis-master
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --requirepass redis_password
    volumes:
      - redis-master-data:/data
    restart: unless-stopped

  redis-replica:
    image: redis:7-alpine
    hostname: redis-replica
    ports:
      - "6380:6379"
    command: redis-server --appendonly yes --requirepass redis_password --replicaof redis-master 6379
    volumes:
      - redis-replica-data:/data
    depends_on:
      - redis-master
    restart: unless-stopped

# Elasticsearché›†ç¾¤
  elasticsearch-1:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.8.0
    hostname: elasticsearch-1
    ports:
      - "9200:9200"
      - "9300:9300"
    environment:
      - node.name=elasticsearch-1
      - cluster.name=kg-cluster
      - discovery.seed_hosts=elasticsearch-2,elasticsearch-3
      - cluster.initial_master_nodes=elasticsearch-1,elasticsearch-2,elasticsearch-3
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms2g -Xmx2g"
      - xpack.security.enabled=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - elasticsearch-1-data:/usr/share/elasticsearch/data
    restart: unless-stopped

# APIæœåŠ¡é›†ç¾¤
  kg-api-1:
    image: kg-system:latest
    hostname: kg-api-1
    ports:
      - "8001:8000"
    environment:
      - NODE_ENV=production
      - NEO4J_URI=bolt://neo4j-core-1:7687
      - POSTGRES_URL=postgresql://kg_user:secure_password@postgres-primary:5432/kg_metadata
      - REDIS_URL=redis://:redis_password@redis-master:6379
      - ELASTICSEARCH_URL=http://elasticsearch-1:9200
    depends_on:
      - neo4j-core-1
      - postgres-primary
      - redis-master
      - elasticsearch-1
    restart: unless-stopped
    deploy:
      replicas: 3

# è´Ÿè½½å‡è¡¡å™¨
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - kg-api-1
    restart: unless-stopped

# ç›‘æ§ç»„ä»¶
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin_password
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
    restart: unless-stopped

volumes:
  neo4j-core-1-data:
  neo4j-core-1-logs:
  neo4j-core-2-data:
  neo4j-core-2-logs:
  neo4j-core-3-data:
  neo4j-core-3-logs:
  postgres-primary-data:
  postgres-replica-data:
  redis-master-data:
  redis-replica-data:
  elasticsearch-1-data:
  prometheus-data:
  grafana-data:
```

## 2. Kuberneteséƒ¨ç½²é…ç½®

```yaml
# k8s/namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: kg-system
  labels:
    name: kg-system

---
# k8s/neo4j-cluster.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: neo4j-core
  namespace: kg-system
spec:
  serviceName: neo4j-core-service
  replicas: 3
  selector:
    matchLabels:
      app: neo4j-core
  template:
    metadata:
      labels:
        app: neo4j-core
    spec:
      containers:
      - name: neo4j
        image: neo4j:5.0-enterprise
        ports:
        - containerPort: 7474
        - containerPort: 7687
        - containerPort: 5000
        - containerPort: 6000
        - containerPort: 7000
        env:
        - name: NEO4J_AUTH
          value: "neo4j/production_password"
        - name: NEO4J_dbms_mode
          value: "CORE"
        - name: NEO4J_causal__clustering_minimum__core__cluster__size__at__formation
          value: "3"
        - name: NEO4J_dbms_memory_heap_initial__size
          value: "2G"
        - name: NEO4J_dbms_memory_heap_max__size
          value: "4G"
        - name: NEO4J_dbms_memory_pagecache_size
          value: "2G"
        resources:
          requests:
            memory: "4Gi"
            cpu: "1"
          limits:
            memory: "6Gi"
            cpu: "2"
        volumeMounts:
        - name: neo4j-data
          mountPath: /data
        - name: neo4j-logs
          mountPath: /logs
  volumeClaimTemplates:
  - metadata:
      name: neo4j-data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 100Gi
  - metadata:
      name: neo4j-logs
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 20Gi

---
apiVersion: v1
kind: Service
metadata:
  name: neo4j-core-service
  namespace: kg-system
spec:
  type: ClusterIP
  ports:
  - port: 7687
    targetPort: 7687
    name: bolt
  - port: 7474
    targetPort: 7474
    name: http
  selector:
    app: neo4j-core

---
# k8s/api-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kg-api
  namespace: kg-system
spec:
  replicas: 3
  selector:
    matchLabels:
      app: kg-api
  template:
    metadata:
      labels:
        app: kg-api
    spec:
      containers:
      - name: kg-api
        image: kg-system:latest
        ports:
        - containerPort: 8000
        env:
        - name: NEO4J_URI
          value: "bolt://neo4j-core-service:7687"
        - name: POSTGRES_URL
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: url
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: redis-secret
              key: url
        resources:
          requests:
            memory: "512Mi"
            cpu: "0.5"
          limits:
            memory: "1Gi"
            cpu: "1"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: kg-api-service
  namespace: kg-system
spec:
  type: ClusterIP
  ports:
  - port: 8000
    targetPort: 8000
  selector:
    app: kg-api

---
# k8s/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: kg-ingress
  namespace: kg-system
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/use-regex: "true"
spec:
  tls:
  - hosts:
    - kg.yourdomain.com
    secretName: kg-tls
  rules:
  - host: kg.yourdomain.com
    http:
      paths:
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: kg-api-service
            port:
              number: 8000
```

## 3. è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash
# deploy.sh - è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

set -e

# é…ç½®å˜é‡
ENVIRONMENT=${1:-production}
NAMESPACE="kg-system"
DOCKER_REGISTRY="your-registry.com"
VERSION=${2:-latest}

echo "å¼€å§‹éƒ¨ç½²çŸ¥è¯†å›¾è°±ç³»ç»Ÿåˆ° $ENVIRONMENT ç¯å¢ƒ..."

# æ£€æŸ¥å¿…éœ€çš„å·¥å…·
check_tools() {
    echo "æ£€æŸ¥éƒ¨ç½²å·¥å…·..."

    command -v kubectl >/dev/null 2>&1 || { echo "kubectl æœªå®‰è£…"; exit 1; }
    command -v helm >/dev/null 2>&1 || { echo "helm æœªå®‰è£…"; exit 1; }
    command -v docker >/dev/null 2>&1 || { echo "docker æœªå®‰è£…"; exit 1; }

    echo "å·¥å…·æ£€æŸ¥å®Œæˆ"
}

# æ„å»ºDockeré•œåƒ
build_images() {
    echo "æ„å»ºDockeré•œåƒ..."

# æ„å»ºAPIæœåŠ¡é•œåƒ
    docker build -t $DOCKER_REGISTRY/kg-api:$VERSION ./api
    docker push $DOCKER_REGISTRY/kg-api:$VERSION

# æ„å»ºå‰ç«¯é•œåƒ
    docker build -t $DOCKER_REGISTRY/kg-frontend:$VERSION ./frontend
    docker push $DOCKER_REGISTRY/kg-frontend:$VERSION

    echo "é•œåƒæ„å»ºå®Œæˆ"
}

# åˆ›å»ºå‘½åç©ºé—´å’Œå¯†é’¥
setup_namespace() {
    echo "è®¾ç½®Kuberneteså‘½åç©ºé—´å’Œå¯†é’¥..."

    kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

# åˆ›å»ºæ•°æ®åº“å¯†é’¥
    kubectl create secret generic postgres-secret \
        --from-literal=url="postgresql://user:password@postgres:5432/kg_db" \
        --namespace=$NAMESPACE \
        --dry-run=client -o yaml | kubectl apply -f -

    kubectl create secret generic redis-secret \
        --from-literal=url="redis://password@redis:6379/0" \
        --namespace=$NAMESPACE \
        --dry-run=client -o yaml | kubectl apply -f -

    echo "å‘½åç©ºé—´è®¾ç½®å®Œæˆ"
}

# éƒ¨ç½²æ•°æ®åº“ç»„ä»¶
deploy_databases() {
    echo "éƒ¨ç½²æ•°æ®åº“ç»„ä»¶..."

# éƒ¨ç½²Neo4jé›†ç¾¤
    helm repo add neo4j https://helm.neo4j.com/neo4j
    helm repo update

    helm upgrade --install neo4j-cluster neo4j/neo4j \
        --namespace=$NAMESPACE \
        --set-string neo4j.edition=enterprise \
        --set-string neo4j.acceptLicenseAgreement=yes \
        --set neo4j.minimumClusterSize=3 \
        --set volumes.data.mode=volume \
        --set volumes.data.volume.size=100Gi \
        --wait

# éƒ¨ç½²PostgreSQL
    helm repo add bitnami https://charts.bitnami.com/bitnami
    helm upgrade --install postgres bitnami/postgresql \
        --namespace=$NAMESPACE \
        --set auth.postgresPassword=secure_password \
        --set primary.persistence.size=50Gi \
        --set readReplicas.replicaCount=1 \
        --wait

# éƒ¨ç½²Redis
    helm upgrade --install redis bitnami/redis \
        --namespace=$NAMESPACE \
        --set auth.password=redis_password \
        --set master.persistence.size=20Gi \
        --set replica.replicaCount=1 \
        --wait

# éƒ¨ç½²Elasticsearch
    helm repo add elastic https://helm.elastic.co
    helm upgrade --install elasticsearch elastic/elasticsearch \
        --namespace=$NAMESPACE \
        --set replicas=3 \
        --set minimumMasterNodes=2 \
        --set volumeClaimTemplate.resources.requests.storage=50Gi \
        --wait

    echo "æ•°æ®åº“ç»„ä»¶éƒ¨ç½²å®Œæˆ"
}

# éƒ¨ç½²åº”ç”¨æœåŠ¡
deploy_services() {
    echo "éƒ¨ç½²åº”ç”¨æœåŠ¡..."

# æ›´æ–°é•œåƒç‰ˆæœ¬
    sed -i "s|image: kg-system:.*|image: $DOCKER_REGISTRY/kg-api:$VERSION|g" k8s/api-deployment.yaml

# åº”ç”¨Kubernetesé…ç½®
    kubectl apply -f k8s/ --namespace=$NAMESPACE

# ç­‰å¾…éƒ¨ç½²å®Œæˆ
    kubectl rollout status deployment/kg-api --namespace=$NAMESPACE --timeout=300s

    echo "åº”ç”¨æœåŠ¡éƒ¨ç½²å®Œæˆ"
}

# éƒ¨ç½²ç›‘æ§ç»„ä»¶
deploy_monitoring() {
    echo "éƒ¨ç½²ç›‘æ§ç»„ä»¶..."

# éƒ¨ç½²Prometheus
    helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
    helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
        --namespace=monitoring \
        --create-namespace \
        --set grafana.adminPassword=admin_password \
        --wait

# éƒ¨ç½²è‡ªå®šä¹‰ç›‘æ§ä»ªè¡¨æ¿
    kubectl apply -f monitoring/dashboards/ --namespace=monitoring

    echo "ç›‘æ§ç»„ä»¶éƒ¨ç½²å®Œæˆ"
}

# é…ç½®å…¥å£å’ŒSSL
setup_ingress() {
    echo "é…ç½®å…¥å£å’ŒSSL..."

# éƒ¨ç½²cert-manager
    helm repo add jetstack https://charts.jetstack.io
    helm upgrade --install cert-manager jetstack/cert-manager \
        --namespace cert-manager \
        --create-namespace \
        --set installCRDs=true \
        --wait

# åº”ç”¨SSLè¯ä¹¦é…ç½®
    kubectl apply -f k8s/certificates.yaml --namespace=$NAMESPACE

# åº”ç”¨Ingressé…ç½®
    kubectl apply -f k8s/ingress.yaml --namespace=$NAMESPACE

    echo "å…¥å£å’ŒSSLé…ç½®å®Œæˆ"
}

# è¿è¡Œå¥åº·æ£€æŸ¥
health_check() {
    echo "è¿è¡Œå¥åº·æ£€æŸ¥..."

# ç­‰å¾…æœåŠ¡å°±ç»ª
    sleep 30

# æ£€æŸ¥APIå¥åº·çŠ¶æ€
    INGRESS_IP=$(kubectl get ingress kg-ingress -n $NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

    if curl -f -s "https://$INGRESS_IP/api/health" > /dev/null; then
        echo "å¥åº·æ£€æŸ¥é€šè¿‡"
    else
        echo "å¥åº·æ£€æŸ¥å¤±è´¥"
        exit 1
    fi
}

# éƒ¨ç½²åæ¸…ç†
cleanup() {
    echo "æ‰§è¡Œéƒ¨ç½²åæ¸…ç†..."

# æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
    docker system prune -f

# æ¸…ç†æ—§çš„éƒ¨ç½²é…ç½®
    kubectl delete pods --field-selector=status.phase=Succeeded --namespace=$NAMESPACE

    echo "æ¸…ç†å®Œæˆ"
}

# ä¸»éƒ¨ç½²æµç¨‹
main() {
    check_tools

    if [ "$ENVIRONMENT" = "production" ]; then
        build_images
    fi

    setup_namespace
    deploy_databases
    deploy_services
    deploy_monitoring
    setup_ingress
    health_check
    cleanup

    echo "çŸ¥è¯†å›¾è°±ç³»ç»Ÿéƒ¨ç½²å®Œæˆï¼"
    echo "è®¿é—®åœ°å€: https://kg.yourdomain.com"
    echo "ç›‘æ§åœ°å€: https://monitoring.yourdomain.com"
}

# é”™è¯¯å¤„ç†
trap 'echo "éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯"; exit 1' ERR

# æ‰§è¡Œä¸»æµç¨‹
main
```

## 4. ç¯å¢ƒé…ç½®ç®¡ç†

```python
# config/environment_manager.py
import os
import json
import yaml
from typing import Dict, Any
from dataclasses import dataclass
from enum import Enum

class Environment(Enum):
    DEVELOPMENT = "development"
    STAGING = "staging"
    PRODUCTION = "production"

@dataclass
class DatabaseConfig:
    host: str
    port: int
    username: str
    password: str
    database: str
    ssl_mode: str = "require"

@dataclass
class RedisConfig:
    host: str
    port: int
    password: str
    database: int = 0

@dataclass
class SecurityConfig:
    jwt_secret: str
    encryption_key: str
    allowed_origins: list
    rate_limit: int

class EnvironmentManager:
    """ç¯å¢ƒé…ç½®ç®¡ç†å™¨"""

    def __init__(self, environment: Environment):
        self.environment = environment
        self.config = self._load_config()

    def _load_config(self) -> Dict[str, Any]:
        """åŠ è½½ç¯å¢ƒé…ç½®"""
        config_file = f"config/{self.environment.value}.yaml"

        with open(config_file, 'r') as f:
            config = yaml.safe_load(f)

# ä»ç¯å¢ƒå˜é‡è¦†ç›–é…ç½®
        config = self._override_from_env(config)

        return config

    def _override_from_env(self, config: Dict[str, Any]) -> Dict[str, Any]:
        """ä»ç¯å¢ƒå˜é‡è¦†ç›–é…ç½®"""
        env_mappings = {
            'NEO4J_URI': 'neo4j.uri',
            'POSTGRES_URL': 'postgres.url',
            'REDIS_URL': 'redis.url',
            'JWT_SECRET': 'security.jwt_secret',
            'ENCRYPTION_KEY': 'security.encryption_key'
        }

        for env_var, config_path in env_mappings.items():
            if env_var in os.environ:
                self._set_nested_config(config, config_path, os.environ[env_var])

        return config

    def _set_nested_config(self, config: Dict[str, Any], path: str, value: str):
        """è®¾ç½®åµŒå¥—é…ç½®å€¼"""
        keys = path.split('.')
        current = config

        for key in keys[:-1]:
            if key not in current:
                current[key] = {}
            current = current[key]

        current[keys[-1]] = value

    def get_database_config(self) -> DatabaseConfig:
        """è·å–æ•°æ®åº“é…ç½®"""
        db_config = self.config['postgres']
        return DatabaseConfig(**db_config)

    def get_redis_config(self) -> RedisConfig:
        """è·å–Redisé…ç½®"""
        redis_config = self.config['redis']
        return RedisConfig(**redis_config)

    def get_security_config(self) -> SecurityConfig:
        """è·å–å®‰å…¨é…ç½®"""
        security_config = self.config['security']
        return SecurityConfig(**security_config)

    def validate_config(self) -> bool:
        """éªŒè¯é…ç½®å®Œæ•´æ€§"""
        required_sections = ['neo4j', 'postgres', 'redis', 'security']

        for section in required_sections:
            if section not in self.config:
                raise ValueError(f"ç¼ºå°‘å¿…éœ€çš„é…ç½®èŠ‚: {section}")

        return True
```

## 5. ç”Ÿäº§ç›‘æ§é…ç½®

```yaml
# monitoring/prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "alert_rules.yml"

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

scrape_configs:
  - job_name: 'kg-api'
    static_configs:
      - targets: ['kg-api-service:8000']
    metrics_path: /metrics
    scrape_interval: 5s

  - job_name: 'neo4j'
    static_configs:
      - targets: ['neo4j-core-service:2004']
    metrics_path: /metrics

  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']

  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']

  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true

---
# monitoring/alert_rules.yml
groups:
  - name: kg-system-alerts
    rules:
      - alert: APIHighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "APIé”™è¯¯ç‡è¿‡é«˜"
          description: "APIåœ¨è¿‡å»5åˆ†é’Ÿå†…é”™è¯¯ç‡è¶…è¿‡10%"

      - alert: DatabaseConnectionHigh
        expr: pg_stat_activity_count > 100
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "æ•°æ®åº“è¿æ¥æ•°è¿‡é«˜"
          description: "PostgreSQLè¿æ¥æ•°è¶…è¿‡100"

      - alert: Neo4jMemoryUsageHigh
        expr: neo4j_memory_used_bytes / neo4j_memory_total_bytes > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Neo4jå†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
          description: "Neo4jå†…å­˜ä½¿ç”¨ç‡è¶…è¿‡90%"

      - alert: RedisMemoryUsageHigh
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Rediså†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
          description: "Rediså†…å­˜ä½¿ç”¨ç‡è¶…è¿‡80%"
```

## 6. å¤‡ä»½å’Œæ¢å¤ç­–ç•¥

```bash
#!/bin/bash
# backup.sh - è‡ªåŠ¨åŒ–å¤‡ä»½è„šæœ¬

BACKUP_DIR="/backup/kg-system"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=30

# Neo4jå¤‡ä»½
backup_neo4j() {
    echo "å¼€å§‹å¤‡ä»½Neo4j..."

    NEO4J_BACKUP_DIR="$BACKUP_DIR/neo4j/$DATE"
    mkdir -p $NEO4J_BACKUP_DIR

# ä½¿ç”¨neo4j-adminå¤‡ä»½
    kubectl exec -n kg-system neo4j-core-0 -- neo4j-admin backup \
        --backup-dir=/tmp/backup \
        --name=graph.db

# å¤åˆ¶å¤‡ä»½æ–‡ä»¶
    kubectl cp kg-system/neo4j-core-0:/tmp/backup $NEO4J_BACKUP_DIR

# å‹ç¼©å¤‡ä»½
    tar -czf "$NEO4J_BACKUP_DIR.tar.gz" -C $NEO4J_BACKUP_DIR .
    rm -rf $NEO4J_BACKUP_DIR

    echo "Neo4jå¤‡ä»½å®Œæˆ: $NEO4J_BACKUP_DIR.tar.gz"
}

# PostgreSQLå¤‡ä»½
backup_postgres() {
    echo "å¼€å§‹å¤‡ä»½PostgreSQL..."

    POSTGRES_BACKUP_DIR="$BACKUP_DIR/postgres"
    mkdir -p $POSTGRES_BACKUP_DIR

# ä½¿ç”¨pg_dumpå¤‡ä»½
    kubectl exec -n kg-system postgres-0 -- pg_dump \
        -h localhost -U kg_user -d kg_metadata \
        --no-password > "$POSTGRES_BACKUP_DIR/kg_metadata_$DATE.sql"

# å‹ç¼©å¤‡ä»½
    gzip "$POSTGRES_BACKUP_DIR/kg_metadata_$DATE.sql"

    echo "PostgreSQLå¤‡ä»½å®Œæˆ: kg_metadata_$DATE.sql.gz"
}

# æ¸…ç†æ—§å¤‡ä»½
cleanup_old_backups() {
    echo "æ¸…ç†è¶…è¿‡${RETENTION_DAYS}å¤©çš„å¤‡ä»½..."

    find $BACKUP_DIR -type f -mtime +$RETENTION_DAYS -delete

    echo "æ—§å¤‡ä»½æ¸…ç†å®Œæˆ"
}

# ä¸»å¤‡ä»½æµç¨‹
main() {
    echo "å¼€å§‹è‡ªåŠ¨å¤‡ä»½ $(date)"

    mkdir -p $BACKUP_DIR

    backup_neo4j
    backup_postgres
    cleanup_old_backups

    echo "å¤‡ä»½å®Œæˆ $(date)"
}

main
```

è¿™ä¸ªç”Ÿäº§éƒ¨ç½²æŒ‡å—æä¾›äº†ï¼š

1. **é«˜å¯ç”¨æ¶æ„** - Neo4jé›†ç¾¤ã€PostgreSQLä¸»ä»ã€Redisé›†ç¾¤
2. **å®¹å™¨åŒ–éƒ¨ç½²** - Docker Composeå’ŒKubernetesé…ç½®
3. **è‡ªåŠ¨åŒ–éƒ¨ç½²** - å®Œæ•´çš„éƒ¨ç½²è„šæœ¬å’Œæµç¨‹
4. **ç¯å¢ƒç®¡ç†** - å¤šç¯å¢ƒé…ç½®ç®¡ç†
5. **ç›‘æ§å‘Šè­¦** - Prometheuså’ŒGrafanaç›‘æ§
6. **å¤‡ä»½æ¢å¤** - è‡ªåŠ¨åŒ–å¤‡ä»½å’Œæ¢å¤ç­–ç•¥

ç³»ç»Ÿç¡®ä¿äº†çŸ¥è¯†å›¾è°±çš„ç”Ÿäº§çº§éƒ¨ç½²å’Œè¿ç»´ã€‚
